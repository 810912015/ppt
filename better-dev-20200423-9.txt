{"l":"https://smallstep.com/blog/diy-single-sign-on-for-ssh/","n":"DIY Single Sign-On for SSH","html":"<noscript><iframe src=\"https://www.googletagmanager.com/ns.html?id=GTM-5P3XBD9&gtm_auth=PjbT2KLFAdrwkFI_-GT-LA&gtm_preview=env-2&gtm_cookies_win=x\" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><section class=\"section headerContainer\"><div class=\"container\"><nav class=\"navbar\" role=\"navigation\" aria-label=\"main navigation\" id=\"navbar\"><div class=\"navbar-brand\"><a class=\"navbar-item\" href=\"https://smallstep.com/\"><img width=\"194\" height=\"50\" src=\"https://smallstep.com/uploads/smallstep_tm_full_rust.svg\" alt=\"Smallstep\"></a><div id=\"navbar-toggle\" role=\"button\" class=\"navbar-burger burger\" aria-label=\"menu\" aria-expanded=\"false\" data-target=\"smallstepNavbar\"><span aria-hidden=\"true\"></span><span aria-hidden=\"true\"></span><span aria-hidden=\"true\"></span></div></div><div id=\"smallstepNavbar\" class=\"navbar-menu\"><div class=\"navbar-end\"><div class=\"navbar-item has-dropdown is-hoverable\"><a class=\"navbar-link is-arrowless\"><span>Documentation</span></a><div class=\"navbar-dropdown\"><a class=\"navbar-item\" href=\"/docs/\">Reference | OSS</a>\n<a class=\"navbar-item\" href=\"/docs/getting-started/\">Getting Started | OSS</a>\n<a class=\"navbar-item\" href=\"/docs/sso-ssh/\">SSO SSH Professional</a>\n<a class=\"navbar-item\" href=\"https://smallstep.com/hello-mtls\">Hello mTLS</a></div></div><div class=\"navbar-item has-dropdown is-hoverable\"><a class=\"navbar-link is-arrowless\"><span>Open Source</span></a><div class=\"navbar-dropdown\"><a class=\"navbar-item\" href=\"/integrations/\">Integrations</a>\n<a class=\"navbar-item\" href=\"/cli/\">step CLI</a>\n<a class=\"navbar-item\" href=\"/certificates/\">step Certificates</a>\n<a class=\"navbar-item\" href=\"/docs/design-document/\">Design Document</a></div></div><div class=\"navbar-item has-dropdown is-hoverable\"><a class=\"navbar-link is-arrowless\"><span>Solutions</span></a><div class=\"navbar-dropdown\"><a class=\"navbar-item\" href=\"/sso-ssh/\">Single Sign-On SSH</a>\n<a class=\"navbar-item\" href=\"/production-identity/\">Production Identity</a>\n<a class=\"navbar-item\" href=\"/cross-connect/\">Cross Connect Cloud</a></div></div><div class=\"navbar-item has-dropdown is-hoverable\"><a class=\"navbar-link is-arrowless\"><span>Company</span></a><div class=\"navbar-dropdown\"><a class=\"navbar-item\" href=\"/about/\">About</a>\n<a class=\"navbar-item\" href=\"/careers/\">Careers</a></div></div><div class=\"navbar-item\"><a href=\"/blog/\" class=\"navbar-link is-arrowless\"><span>Blog</span></a></div><div class=\"navbar-item\"><a href=\"https://smallstep.com/app\" class=\"navbar-link is-arrowless\"><span>Login</span></a></div></div></div></nav></div></section><main role=\"main\" class=\"blog\"><article class=\"page\"><header class=\"hero\"><div class=\"hero-body\"><div class=\"container\"><h1 class=\"title\">DIY Single Sign-On for SSH</h1><div class=\"columns is-vcentered is-gapless\"><div class=\"column is-1 has-text-centered\"><figure class=\"image is-64x64 is-inline-block\"><img src=\"/uploads/Carl-Tashian.jpg\" class=\"is-rounded\" alt=\"Carl Tashian\"></figure></div><div class=\"column is-2 is-uppercase has-text-centered has-text-weight-bold\">Carl Tashian</div><div class=\"column is-1 has-text-centered social\"><figure class=\"image is-24x24 is-inline-block\"><a href=\"https://www.linkedin.com/in/tashian/\" target=\"_blank\" rel=\"nofollow\"><img src=\"/images/icons/linkedin.svg\"></a></figure><figure class=\"image is-24x24 is-inline-block\"><a href=\"https://twitter.com/tashian\" target=\"_blank\" rel=\"nofollow\"><img src=\"/images/icons/twitter.svg\"></a></figure></div><div class=\"column has-text-centered-mobile\"><span><time datetime=\"2020-04-13\">2020-04-13</time></span></div><div class=\"column has-text-centered\"><form name=\"blog-article-subscribe\" class=\"form-right\" method=\"post\"><input type=\"hidden\" name=\"form-name\" value=\"blog-article-subscribe\"><div class=\"is-hidden\"><label class=\"label\">Don’t fill this out if you're human:</label><div class=\"control\"><input class=\"input\" name=\"bot-field\"></div></div><div class=\"field is-grouped is-inline-block-mobile\"><div class=\"control\"><input class=\"input\" name=\"email\" type=\"text\" placeholder=\"Email\" required=\"\"></div><div class=\"control\"><input class=\"button is-danger has-text-weight-bold\" type=\"submit\" value=\"Subscribe\"></div></div></form></div></div></div></div></header><div class=\"container\"><section class=\"single content markdown\"><video playsinline=\"\" autoplay=\"\" muted=\"\" loop=\"\">\n<source src=\"sso_flow.mp4\" type=\"video/mp4\">Your browser does not support the video tag.</video><br><br><br><p><strong>TL;DR</strong> In this post we're going to set up Google single sign-on for SSH. Behind the scenes, we'll use OpenID Connect (OIDC), short-lived SSH certificates, a couple of clever SSH configuration tweaks, and Smallstep's open-source <a href=\"https://smallstep.com/certificates/\"><code>step-ca</code></a> and <a href=\"https://smallstep.com/cli/\"><code>step</code></a> packages. We will set up an SSH Certificate Authority, and use it to bootstrap a new host and a new user in our system. While this approach requires more up-front work than a typical SSH public/private key setup, it comes with a lot of benefits beyond single sign-on. It eliminates the need for gathering and shipping and managing <code>authorized_keys</code> files.</p><hr><h3 id=\"how-not-to-use-ssh\">How not to use SSH</h3><p>For years, I innocently copied and pasted the same rusty old public key into an <code>authorized_keys</code> file on every server I used. And I always forgot to <code>chmod</code> it properly, so it never worked the first time. Someone taught me how to do this in 2004 and I never stopped.</p><p>I only rotated my key once, begrudgingly, in 2015, when OpenSSH deprecated my key type. Years later, who knows what servers are out there with my public key still on them? Old startups I worked for? Freelancing clients? My niece Elsa's crypto mining rig?</p><p>From an organization's standpoint, <code>authorized_keys</code> files just plain suck. In the early days, maybe someone crafts these files by hand like I did, but as the number of hosts and users grows it becomes a dreadful task. And one day you wake up with an ugly morass of public keys scattered across the infrastructure.</p><p>Many organizations will then make a playbook to automate the management of <code>authorized_keys</code> files. No matter how thoughtfully executed, the task of gathering and shipping and maintaining all those keys remains messy.</p><h3 id=\"single-sign-on-with-openid-connect--ssh-certificates\">Single sign on with OpenID Connect + SSH certificates</h3><p>We're going to set up an SSH certificate authority and manage SSH access using short-lived certificates instead of <code>authorized_keys</code> files. And, we will pair it with <a href=\"https://openid.net/connect/\" target=\"_blank\">OpenID Connect</a> (OIDC) for single sign-on support.</p><p>This will take more up-front work than your typical out-of-the-box SSH configuration, but bear with me because once you get it going it's pretty sweet.</p><blockquote><p><strong>What's an SSH certificate?</strong> It's a superior alternative to the public/private SSH key pair. Like public/private keys, certificates are exchanged between the user and host during the SSH handshake. a pared-down cousin of a TLS X.509 certificate. For a deeper dive, see our blog post, If <a href=\"https://smallstep.com/blog/use-ssh-certificates/\">You're Not Using SSH Certificates, You're Doing SSH Wrong</a>.</p><p>Here a decoded SSH certificate:</p><pre><code>-:\n        Type: ecdsa-sha2-nistp256-cert-v01@openssh.com user certificate\n        Public key: ECDSA-CERT SHA256:N7ErGTPjhmruRS/4OiwyRi6Iyr59z0Ur1ifkHIHu4V8\n        Signing CA: ECDSA SHA256:E0GH/kZ/CGUIe8mMzzpujIiEYGC2IHDHafYBnye1WSU\n        Key ID: \"carl@smallstep.com\"\n        Serial: 16253962425132258867\n        Valid: from 2020-03-23T16:01:39 to 2020-03-24T08:01:39\n        Principals:\n                carl\n                carl@smallstep.com\n        Critical Options: (none)\n        Extensions:\n                permit-X11-forwarding\n                permit-agent-forwarding\n                permit-port-forwarding\n                permit-pty\n                permit-user-rc\n</code></pre><p><strong>User certificates</strong> like this one identify users to hosts. <strong>Host certificates</strong> identify hosts to users. The biggest difference is the <code>Principals</code> field.</p><p>By default, during the SSH handshake, SSHD will allow usernames listed in a user certificate's <code>Principals</code> field to sign in. Likewise, SSH expects to find the target hostname in a host certificate's <code>Principals</code> field.</p><p>Certificate can also have extensions that allow privileged SSH features (like agent and port forwarding) or that force configuration directives.</p></blockquote><p>To make magic happen, we're going to set up an ✨SSH Certificate Authority (CA) ✨, specifically <a href=\"https://smallstep.com/certificates/\">Smallstep's <code>step-ca</code></a> server. Our CA will issue SSH certificates to users and hosts when they supply the right credentials.</p><p>Here's a flow chart showing how Alice will get user certificate for herself and sign into a host:</p><img src=\"user_certificate_flow.svg\" width=\"617\" height=\"735\"><p>We'll make this happen with an OpenSSH configuration block that works alongside our <a href=\"https://smallstep.com/cli\"><code>step</code> command line tool</a>.</p><h3 id=\"advantages\">Advantages</h3><ul><li><p><strong>No more public key management</strong>. You will no longer have <code>users * hosts</code> number of <code>authorized_keys</code> files littered across your infrastructure. Users won't even need an <code>.ssh</code> directory on your hosts.</p></li><li><p><strong>Easily establish and revoke access across all hosts</strong>. SSH access expires the same day a user is removed from the OAuth domain. Traditional SSH key pairs don't expire. SSH certificates give us the benefit of <a href=\"https://smallstep.com/blog/passive-revocation/\">passive revocation</a>.</p></li><li><p><strong>Bring your own security policy</strong>. Your Google security policy (including 2FA and security keys) will apply to the OAuth OIDC flow for granting SSH certificates. You can configure how often you want your certificates to expire.</p></li><li><p><strong>Validated host certificates</strong>. We will leverage EC2 <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-identity-documents.html\" target=\"_blank\">Instance Identity Documents (IIDs)</a> so that only hosts in your AWS account will be issued certificates.</p></li><li><p><strong>User certificates are stored in memory</strong>. Key pairs are often stored on disk—and they never expire.</p></li><li><p><strong>No more Trust On First Use (TOFU)</strong>. With host certificates, you'll never see this message again:</p><pre><code>  The authenticity of host 'ec2-3-15-28-130.us-east-2.compute.amazonaws.com (3.15.28.130)' can't be established.\n  ECDSA key fingerprint is SHA256:HYDAjwFL/qEmTuKm903tIk0fbPNk1CSRqH/usavToLw.\n  Are you sure you want to continue connecting (yes/no/[fingerprint])?\n</code></pre></li></ul><h3 id=\"this-post-wont-cover\">This post won't cover</h3><ul><li>Integrating more deeply with an Identity Provider (eg. syncing with a SCIM or LDAP directory)</li><li>Adding <code>sudo</code> support that leverages certificates</li><li>Advanced access control lists (ACLs) for mapping between users and groups of hosts</li><li>Backing up your CA's database</li><li>Automatically provisioning on hosts when a user connects for the first time</li><li>Immediately revoking a user's certificate, <em>before it expires</em></li></ul><h3 id=\"prerequisites\">Prerequisites</h3><ul><li>Your hosts live on EC2</li><li>Your users live together in a GSuite domain</li><li>You have the <code>step</code> toolkit installed locally<ul><li>On macOS, you can run <code>brew install step</code></li><li>On Linux, you can find <a href=\"https://github.com/smallstep/cli/releases\" target=\"_blank\">Debian packages here</a>.</li></ul></li></ul><h3 id=\"but-i-dont-want-to-run-a-certificate-authority\">But I don't want to run a Certificate Authority!</h3><p>Maybe you're thinking, “This is complex and scary.”</p><p>Certificate Authorities got this reputation thanks to the arcane details of X.509 TLS certificates, the sheer number of acronyms in the world of PKI, and the complexity of tools like <code>openssl</code>.</p><p>Also, big CAs like <a href=\"https://letsencrypt.org/\" target=\"_blank\">Let's Encrypt</a> do have a daunting amount of responsibility for keeping the internet secure.</p><p>You're not running Let's Encrypt.</p><p>SSH certificates are simpler than TLS certificates. An SSH CA simply lets us delegate some of the responsibilities around authentication and authorization for a fleet of hosts to a single centralized service.</p><p>Still not convinced? We can manage SSH access for you (and run the CA) for $3/host/month.</p><div class=\"blog-cta m-t-xl m-b-xl\"><div class=\"columns is-centered is-mobile\"><div class=\"column is-half-desktop box p-t-lg p-b-lg\"><div class=\"columns is-mobile is-vcentered\"><div class=\"column has-text-centered\"><figure class=\"image is-48x48 is-inline-block\"><img src=\"/images/cta-left-red-shape.svg\"></figure></div><div class=\"column\"><div class=\"columns is-centered\"><div class=\"column m-t-sm has-text-centered\"><figure class=\"image is-64x64 is-inline-block\"><img src=\"/uploads/smallstep-icon-red.svg\"></figure></div></div></div><div class=\"column has-text-centered\"><figure class=\"image is-48x48 is-inline-block\"><img src=\"/images/cta-right-shapes.svg\"></figure></div></div><div class=\"columns\"><div class=\"column has-text-centered\"><div class=\"is-size-5 has-text-weight-semibold m-b-lg\">Try it free for 30 days</div><div class=\"content has-text-centered m-t-md m-b-sm\"><a href=\"/signup/\" class=\"button is-link has-text-weight-bold is-uppercase\">Get Started Now</a></div></div></div><div class=\"columns\"><div class=\"column has-text-centered\">Say goodbye to your SSH key deploys!</div></div></div></div></div><p>For this project, we'll set up the CA with three <a href=\"https://github.com/smallstep/certificates/blob/master/docs/provisioners.md\" target=\"_blank\">provisioners</a>—three methods for issuing certificates:</p><ul><li>For user certificates, we will have an <strong>OAuth OIDC provisioner</strong>, associated with our Google OAuth app. We're trusting that Google reliably signs people in and only gives out valid, Google-signed OAuth identity tokens to authenticated users. The CA will verify the token using Google's public key.</li><li>For new EC2 hosts, we need an <strong>AWS provisioner</strong>, associated with our AWS account. New hosts will ask for SSH host certificates using this provisioner. We're trusting AWS to provide an Amazon-signed instance identity document that the CA will verify using Amazon's public key.</li><li>Finally, for host certificate renewal we need an <strong>SSHPOP provisioner</strong>. We'll renew our host certificates weekly.</li></ul><p>Shall we get to it?</p><h3 id=\"1-create-a-google-oauth-credential\">1. Create a Google OAuth Credential</h3><p>You'll need <a href=\"https://console.developers.google.com/apis/credentials/oauthclient\" target=\"_blank\">a Google OAuth 2.0 Credential</a> for this project. This takes 2 minutes.</p><ul><li><a href=\"https://console.cloud.google.com/projectcreate\" target=\"_blank\">Create a Google Cloud Console Project</a> if you don't have one<ul><li>Create the project in the GSuite Organization that you will use for single sign on.</li></ul></li><li><a href=\"https://console.developers.google.com/apis/credentials/consent\" target=\"_blank\">Configure the OAuth 2.0 consent screen</a> for an <strong>Internal</strong> project</li><li><a href=\"https://console.developers.google.com/apis/credentials/oauthclient\" target=\"_blank\">Create an OAuth 2.0 credential</a><ul><li>For Application Type, choose <strong>Other</strong></li></ul></li></ul><p>Jot down the <strong>Client ID</strong> and <strong>Client Secret</strong>; you'll need them for the next step!</p><blockquote><p><strong>Note:</strong> Your CA will only issue user certificates for users signing in to the GSuite organization associated with your Google Cloud project.</p></blockquote><h3 id=\"2-launch-your-certificate-authority\">2. Launch your Certificate Authority</h3><p>We're going to install <code>step-ca</code> on an <strong>Ubuntu 18.04 LTS</strong> instance on AWS. A free tier instance (t2.micro/t3.micro) should suffice.</p><p><a href=\"https://gist.github.com/tashian/244fc69ccb7ceec433c7811e91cbf0b7\" target=\"_blank\"><strong>Grab this CA launch script</strong></a> and plug in the variables at the top:</p><ul><li>The OIDC client ID</li><li>OIDC client secret</li><li>Your GSuite domain name</li><li>A name for your CA</li><li>A root key password</li><li>Your email</li></ul><p>Upload it as an <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html\" target=\"_blank\">EC2 User Data script</a> for use in Step 3 (Configure Instance) when you launch your EC2 instance.</p><blockquote><p>For connectivity, your VPC will need an internet gateway attached, and your instance should be in a security group that's available to all of your hosts and users on ports 22 (SSH) and 443 (HTTPS).</p><p>This is a good moment to mention that <code>step-ca</code> only accepts HTTPS connections via mTLS—it's more resistant to attacks than your typical web server.</p></blockquote><p>Connect to your CA instance using your PEM key.</p><p>The output of the User Data script is located in <code>/var/log/cloud-init-output.log</code>. Check it out and make sure everything initialized properly. The <code>step-ca</code> service should be running.</p><p>The CA will have created the following certificates and keys:</p><ul><li><code>/etc/step-ca/certs/root_ca.crt</code> — your CA's root TLS certificate (self-signed).</li><li><code>/etc/step-ca/certs/ssh_host_ca_key.pub</code> — the SSH host CA key lets <em>users</em> verify <em>host</em> certificates.</li><li><code>/etc/step-ca/certs/ssh_user_ca_key.pub</code> — the SSH user CA key lets <em>hosts</em> verify <em>user</em> certificates.</li><li>You'll also have (in <code>/etc/step-ca/secrets</code>) the CA's private signing keys for the above certificates and keys. The password for these keys is saved in <code>/etc/step-ca/password.txt</code>. The CA reads this on startup to decrypt your keys.</li></ul><p>As root, remove the User Data script, which contains your root CA password:</p><pre><code># rm /var/lib/cloud/instances/i-**/user-data.txt**\n</code></pre><p>You'll need two bits of information from your CA:</p><ul><li><p>The public hostname, so we can find it again.</p></li><li><p>The root certificate fingerprint, so we can establish a mutual TLS connection with it.<br>As root, run:</p><pre><code># step certificate fingerprint $(step path)/certs/root_ca.crt\n5bc2b4779ad1562f6ed0809857fbed7925d2432eb25083f41a468532495ca658\n</code></pre></li></ul><p>Jot these down. Your CA is up and running! 🎉</p><h3 id=\"3-bootstrap-a-new-host\">3. Bootstrap a new host</h3><p>Let's bootstrap an Ubuntu instance that will be our first <code>ssh</code> target host.</p><blockquote><p><strong>Note:</strong> Your CA will only issue host certificates for instances that are in its AWS account.</p></blockquote><p>This time around, <a href=\"https://gist.github.com/tashian/fde43668cbf6e3227fb13ef51db650b8\" target=\"_blank\"><strong>grab this host User Data script</strong></a> for launching the new instance—filling in these variables:</p><ul><li>Your CA's URL (<code>https://[CA hostname]</code>)</li><li>Your CA's root certificate fingerprint</li></ul><p>Here's what the User Data script will do:</p><p><img src=\"host_certificate_flow.png\" alt=\"\"></p><p>So, we get a host certificate in exchange for a single-use token that contains the <a href=\"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-identity-documents.html\" target=\"_blank\">Instance Identity Document)</a> and its signature.</p><blockquote><p><strong>About those IIDs…</strong> In case you've never played with IIDs, here's what one looks like:</p><pre><code>$ TOKEN=`curl -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\"` \\\n&amp;&amp; curl -H \"X-aws-ec2-metadata-token: $TOKEN\" –v http://169.254.169.254/latest/dynamic/instance-identity/document\n{\n  \"accountId\" : \"8072125551212\",\n  \"architecture\" : \"x86_64\",\n  \"availabilityZone\" : \"us-east-2c\",\n  \"billingProducts\" : null,\n  \"devpayProductCodes\" : null,\n  \"marketplaceProductCodes\" : null,\n  \"imageId\" : \"ami-0fc20dd1da406780b\",\n  \"instanceId\" : \"i-01bd292377d6d8fec\",\n  \"instanceType\" : \"t2.micro\",\n  \"kernelId\" : null,\n  \"pendingTime\" : \"2020-03-11T23:18:12Z\",\n  \"privateIp\" : \"172.31.46.150\",\n  \"ramdiskId\" : null,\n  \"region\" : \"us-east-2\",\n  \"version\" : \"2017-09-30\"\n}\n</code></pre><p>This bit of JSON is signed by Amazon. Here's the signature:</p><pre><code>$ TOKEN=`curl -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\"` \\\n    &amp;&amp; curl -H \"X-aws-ec2-metadata-token: $TOKEN\" –v http://169.254.169.254/latest/dynamic/instance-identity/signature\nc0p6ygyFNFxyjs/73QGCQN+7khkZBr6H5cP/gefBgAwe80GmSTNlQy68LBSQQYrQczv2aHTXj3xa\nCFkaGE4GPYiAogCkywcnt5VAp3t176GQwVxqfmawTliPMs31dY7ZeZvixN/1uoe8x1pt0EXAMPLE\n</code></pre></blockquote><p>Sign in with your PEM key and make sure everything initialized properly. The output of your user data script is located in <code>/var/log/cloud-init-output.log</code>.</p><h4 id=\"create-a-user-for-yourself-on-the-host\">Create a user for yourself on the host</h4><p>Create a new user on the host. Your username <em>must</em> match the user portion of the email address you'll use to sign in to Google. In my case:</p><pre><code>$ sudo adduser --quiet --disabled-password --gecos '' carl\n</code></pre><p>The host side of our setup is done! 🔑</p><h3 id=\"4-onboard-a-new-user\">4. Onboard a new user</h3><p>Let's get you set up as the first user. On your local machine, run:</p><pre><code>$ CA_URL=https://[YOUR CA].compute.amazonaws.com\n$ CA_FINGERPRINT=[CA FINGERPRINT]\n$ step ca bootstrap \\\n       --ca-url $CA_URL \\\n       --fingerprint $CA_FINGERPRINT\n</code></pre><p>This will install your CA's root certificate on your machine and configure it. It creates two files: <code>~/.step/config/defaults.json</code> (the config file for <code>step</code>), and <code>~/.step/certs/root_ca.crt</code> (your root CA's TLS certificate).</p><p>Next, we can provision a user certificate for ourselves:</p><pre><code>$ step ssh login [your email address] --provisioner \"Google\"\n</code></pre><p>What does this command do?</p><ol><li>It launches your system browser and starts Google's OIDC sign-in flow</li><li>After signing in, the ID token you get back from Google is sent to your CA</li><li>Your CA validates the Google token and issues an SSH certificate associated with your email address</li><li>The certificate is added to your SSH agent. Use <code>step ssh list</code> to see it, or <code>step ssh list --raw | step ssh inspect</code> to parse and examine it.</li></ol><p>Finally, let's configure ssh to use our CA:</p><pre><code>$ step ssh config\n</code></pre><p>Here are the steps taken by <code>step ssh config</code>:</p><ol><li><p>It fetches the CA's host public key—used to verify host certificates—and installs it into your SSH configuration. The entry looks like this (in <code>~/.step/known_hosts</code>):</p><pre><code> @cert-authority * ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBHyWTo9TLDwhyLlHq2ANkjtSGLyJ3xPtfL+7faiV+YA0k4kLUc8cJ5rWFHdUShbwtkOsLhkqeDDXoFnH/C5BG+4=\n</code></pre></li><li><p>It imports this unintrusive config block (in <code>.step/ssh/config</code>) into your ssh configuration:</p><pre><code>Match exec \"step ssh check-host %h\"\n    ForwardAgent yes\n    User carl\n    UserKnownHostsFile \"/Users/carl/.step/ssh/known_hosts\"\n    ProxyCommand step ssh proxycommand %r %h %p --provisioner \"Google\"\n</code></pre><p>The <code>Match exec</code> block is only evaluated if the provided command returns true.</p><p><code>step ssh check-host</code> goes up to your CA and asks if the hostname you're trying to SSH to has been given a certificate. If so, it returns true. We don't want CA-managed hosts to interfere with your sconfig for any other hosts.</p><p>The <code>ProxyCommand</code> directive delivers the Single Sign-on magic. <code>step ssh proxycommand</code> will check for your SSH certificate before attempting to connect. If it's missing or expired, it will run you through the OAuth OIDC flow and request a new certificate from your CA.</p><blockquote><p><strong>Note:</strong> A template on your CA defines this config block. If you want to change anything—for example, you may wish to remove the <code>ForwardAgent</code> directive—you can find the template in <code>/etc/step-ca/templates/ssh</code>.</p></blockquote></li></ol><h3 id=\"try-it-out\">Try it out!</h3><p>We're ready to SSH to the target host you've set up. You can run SSH with <code>-v</code> to watch the handshake. Specifically, you should see something like:</p><pre><code>debug1: Server host certificate: ecdsa-sha2-nistp256-cert-v01@openssh.com SHA256:KUwZbRewusotBbO4Wbrj1EpPexMqKEj0ZUr1Fvf41+g, serial 782\n1790606781444805 ID \"i-0fa7218db55ac0536\" CA ecdsa-sha2-nistp256 SHA256:VIwnVtTJJwdUsjGaPyOS5yT1O/uxyxj0CQJd+Ce/w0M valid from 2020-03-2\n3T16:23:32 to 2020-04-22T16:24:32\ndebug1: Host 'ec2-3-135-235-172.us-east-2.compute.amazonaws.com' is known and matches the ECDSA-CERT host certificate.\ndebug1: Found CA key in /Users/carl/.step/ssh/known_hosts:1\n...\ndebug1: Offering public key: carl@smallstep.com ECDSA-CERT SHA256:mBQXA0znZvd+21hhvViUVEybzrO4x190xZftFXAYCFY agent\ndebug1: Server accepts key: carl@smallstep.com ECDSA-CERT SHA256:mBQXA0znZvd+21hhvViUVEybzrO4x190xZftFXAYCFY agent\n</code></pre><p>Boom! You're in.</p><blockquote><p><strong>Tip:</strong> You can run <code>step ssh hosts</code> to ask the CA for a list of hosts that have been issued certificates.</p></blockquote><h3 id=\"qa\">Q&amp;A</h3><h4 id=\"how-do-i-register-an-existing-host-with-the-ca\">How do I register an existing host with the CA?</h4><p>For Ubuntu 18.04 LTS hosts, the process is identical to bootstrapping a new host—just run your <a href=\"https://gist.github.com/tashian/fde43668cbf6e3227fb13ef51db650b8\" target=\"_blank\">host launch script</a> as root.</p><p>For other platforms, you may need to port the script to suit your situation.</p><p>Once you have all of your existing hosts up and running, you may want to adjust the <code>instanceAge</code> setting on the AWS provisioner on the CA. You'll see it in <code>/etc/step-ca/config/ca.json</code>. By default, an instance of any age can bootstrap itself. If you set it to, say, <code>5m</code>, the CA will only accept IID tokens from instances less than 5 minutes old, as an extra measure of security.</p><blockquote><p><strong>Note:</strong> The Instance Identity token created in the script is a one-time token. You can't re-enroll a host, you can only renew its certificate. Why? Because any user on the host can access the IID at any time, and we don't want any user to be able to get a host certificate from the CA.</p></blockquote><h4 id=\"can-i-use-a-different-oauth-oidc-provider\">Can I use a different OAuth OIDC provider?</h4><p>Sure! In the User Data script for the CA, you'll need to change the OAuth configuration endpoint URL, and change the name of your OIDC provisioner.</p><h4 id=\"can-i-use-gcp-or-azure-instead-of-aws\">Can I use GCP or Azure instead of AWS?</h4><p>Yup! <code>step-ca</code> has provisioners for all three. You'll need to make some adjustments to your CA's configuration and host bootstrapping script. See <code>step-ca</code>'s <a href=\"https://github.com/smallstep/certificates/blob/master/docs/provisioners.md\" target=\"_blank\">provisioner documentation</a> for details.</p><h4 id=\"can-i-use-a-bastion-host-jump-box\">Can I use a bastion host (jump box)?</h4><p>You can. First, get all of your hosts set up with host certificates. Then, you'll need to add the host CA key to <code>known_hosts</code> on your bastion:</p><pre><code>$ CA_URL=https://[YOUR CA].compute.amazonaws.com\n$ CA_FINGERPRINT=[CA FINGERPRINT]\n$ step ca bootstrap \\\n      --ca-url $CA_URL \\\n      --fingerprint $CA_FINGERPRINT\n$ mkdir -p ~/.ssh &amp;&amp; echo \"@cert-authority * $(step ssh config --host --roots)\" &gt; ~/.ssh/known_hosts\n</code></pre><p>From there, just <code>ssh</code> to the bastion, then <code>ssh</code> to the internal hostname.</p><h4 id=\"can-i-change-the-ssh-certificate-duration\">Can I change the SSH certificate duration?</h4><p>Yes. By default they are valid for 16 hours. Under the <code>claims</code> object of the CA configuration (<code>ca.json</code>), for your OIDC provisioner, add the following keys to change the default:</p><pre><code>\"defaultUserSSHCertDuration\": \"720h\",\n\"maxUserSSHCertDuration\": \"720h\"\n</code></pre><h4 id=\"will-i-get-locked-out-of-my-hosts-if-my-ca-goes-down\">Will I get locked out of my hosts if my CA goes down?</h4><p>You will, even though SSH and SSHD don't directly interact with the CA. The CA issues certificates and holds a database of hosts. Your users rely on that database to choose whether to try the certificate authentication path when connecting to a host.</p><p>For safety, don't use SSH certificates to access the CA itself. That's is one place where key pairs are still going to serve you well.</p><h4 id=\"can-i-use-hosts-in-multiple-aws-accounts\">Can I use hosts in multiple AWS accounts?</h4><p>Sure. You'll need to add the account IDs to the CA's config file (<code>/etc/step-ca/config/ca.json</code>), and restart the CA server.</p><h4 id=\"how-might-i-add-sudo-support\">How might I add <code>sudo</code> support?</h4><p>You can do this using agent forwarding and the <a href=\"https://github.com/uber/pam-ussh\" target=\"_blank\"><code>pam_ussh</code></a> <a href=\"https://en.wikipedia.org/wiki/Pluggable_authentication_module\" target=\"_blank\">pluggable authentication module</a>.</p><h4 id=\"what-else-can-i-do-with-my-ca\">What else can I do with my CA?</h4><p>LOTS! Now that you have your very own private CA, you could set it up to issue TLS certificates for <a href=\"https://smallstep.com/hello-mtls\">encrypting all of your internal traffic using mutual TLS</a>. See <a href=\"https://smallstep.com/certificates/\">Step Certificates Documentation</a> to learn more about the CA, provisioners, configuration options, etc.</p><h3 id=\"wrapping-up\">Wrapping up</h3><p>With our basic setup, anyone in your Google organization will be able to get a certificate. They will only be able to access hosts on which they have accounts with usernames that match their Google email username.</p><p>If you want features like fine-grained mappings between users and hosts and automatic user provisioning, or if you simply don't want to manage your own CA server, <a href=\"https://smallstep.com/sso-ssh/\">check out our Smallstep SSH product</a>. It's only $3/month per host in your infrastructure.</p><div class=\"blog-cta m-t-xl m-b-xl\"><div class=\"columns is-centered is-mobile\"><div class=\"column is-half-desktop box p-t-lg p-b-lg\"><div class=\"columns is-mobile is-vcentered\"><div class=\"column has-text-centered\"><figure class=\"image is-48x48 is-inline-block\"><img src=\"/images/cta-left-red-shape.svg\"></figure></div><div class=\"column\"><div class=\"columns is-centered\"><div class=\"column m-t-sm has-text-centered\"><figure class=\"image is-64x64 is-inline-block\"><img src=\"/uploads/smallstep-icon-red.svg\"></figure></div></div></div><div class=\"column has-text-centered\"><figure class=\"image is-48x48 is-inline-block\"><img src=\"/images/cta-right-shapes.svg\"></figure></div></div><div class=\"columns\"><div class=\"column has-text-centered\"><div class=\"is-size-5 has-text-weight-semibold m-b-lg\">How Smallstep SSH Works</div><div class=\"content has-text-centered m-t-md m-b-sm\"><a href=\"/sso-ssh/how-it-works/#howitworks\" class=\"button is-link has-text-weight-bold is-uppercase\">learn more</a></div></div></div><div class=\"columns\"><div class=\"column has-text-centered\">Explore the technical details of our managed offering</div></div></div></div></div></section></div><div class=\"container m-t-lg\"><div class=\"columns\"><div class=\"column is-four-fifths\"><section class=\"single content\"><div class=\"addthis_inline_share_toolbox_kg5o\" data-url=\"https://smallstep.com/blog/diy-single-sign-on-for-ssh/\" data-title=\"DIY Single Sign-On for SSH\" data-description=\"Let's set up Google SSO for SSH! We’ll use OpenID Connect (OIDC), SSH certificates, a clever SSH configuration tweak, and Smallstep’s open source packages.\" style=\"clear: both;\"><div id=\"atstbx\" class=\"at-resp-share-element at-style-responsive at-mobile addthis-smartlayers addthis-animated at4-show\" aria-labelledby=\"at-cdfaa230-9eeb-4142-bd66-133b60e2db69\" role=\"region\"><span id=\"at-cdfaa230-9eeb-4142-bd66-133b60e2db69\" class=\"at4-visually-hidden\">AddThis Sharing Buttons</span><div class=\"at-share-btn-elements\"><a role=\"button\" tabindex=\"0\" class=\"at-icon-wrapper at-share-btn at-svc-hackernews\" style=\"background-color: rgb(255, 102, 0); border-radius: 0px;\"><span class=\"at4-visually-hidden\">Share to Hacker News</span><span class=\"at-icon-wrapper\" style=\"line-height: 32px; height: 32px; width: 32px;\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 32 32\" version=\"1.1\" role=\"img\" aria-labelledby=\"at-svg-hackernews-1\" style=\"fill: rgb(255, 255, 255); width: 32px; height: 32px;\" class=\"at-icon at-icon-hackernews\"><title id=\"at-svg-hackernews-1\">Hacker News</title><g><path d=\"M17.322 18.437V27h-2.725v-8.725L7.5 5h3.238l4.183 8.4s.62 1.24 1.134 2.48c.54-1.186 1.187-2.48 1.187-2.48L21.48 5H24.5l-7.178 13.437z\" fill-rule=\"evenodd\"></path></g></svg></span><span class=\"at-label\" style=\"font-size: 11.4px; line-height: 32px; height: 32px; color: rgb(255, 255, 255);\">Hacker News</span></a><a role=\"button\" tabindex=\"0\" class=\"at-icon-wrapper at-share-btn at-svc-twitter\" style=\"background-color: rgb(29, 161, 242); border-radius: 0px;\"><span class=\"at4-visually-hidden\">Share to Twitter</span><span class=\"at-icon-wrapper\" style=\"line-height: 32px; height: 32px; width: 32px;\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 32 32\" version=\"1.1\" role=\"img\" aria-labelledby=\"at-svg-twitter-2\" style=\"fill: rgb(255, 255, 255); width: 32px; height: 32px;\" class=\"at-icon at-icon-twitter\"><title id=\"at-svg-twitter-2\">Twitter</title><g><path d=\"M27.996 10.116c-.81.36-1.68.602-2.592.71a4.526 4.526 0 0 0 1.984-2.496 9.037 9.037 0 0 1-2.866 1.095 4.513 4.513 0 0 0-7.69 4.116 12.81 12.81 0 0 1-9.3-4.715 4.49 4.49 0 0 0-.612 2.27 4.51 4.51 0 0 0 2.008 3.755 4.495 4.495 0 0 1-2.044-.564v.057a4.515 4.515 0 0 0 3.62 4.425 4.52 4.52 0 0 1-2.04.077 4.517 4.517 0 0 0 4.217 3.134 9.055 9.055 0 0 1-5.604 1.93A9.18 9.18 0 0 1 6 23.85a12.773 12.773 0 0 0 6.918 2.027c8.3 0 12.84-6.876 12.84-12.84 0-.195-.005-.39-.014-.583a9.172 9.172 0 0 0 2.252-2.336\" fill-rule=\"evenodd\"></path></g></svg></span><span class=\"at-label\" style=\"font-size: 11.4px; line-height: 32px; height: 32px; color: rgb(255, 255, 255);\">Twitter</span></a><a role=\"button\" tabindex=\"0\" class=\"at-icon-wrapper at-share-btn at-svc-reddit\" style=\"background-color: rgb(255, 87, 0); border-radius: 0px;\"><span class=\"at4-visually-hidden\">Share to Reddit</span><span class=\"at-icon-wrapper\" style=\"line-height: 32px; height: 32px; width: 32px;\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 32 32\" version=\"1.1\" role=\"img\" aria-labelledby=\"at-svg-reddit-3\" style=\"fill: rgb(255, 255, 255); width: 32px; height: 32px;\" class=\"at-icon at-icon-reddit\"><title id=\"at-svg-reddit-3\">Reddit</title><g><path d=\"M27 15.5a2.452 2.452 0 0 1-1.338 2.21c.098.38.147.777.147 1.19 0 1.283-.437 2.47-1.308 3.563-.872 1.092-2.06 1.955-3.567 2.588-1.506.634-3.143.95-4.91.95-1.768 0-3.403-.316-4.905-.95-1.502-.632-2.69-1.495-3.56-2.587-.872-1.092-1.308-2.28-1.308-3.562 0-.388.045-.777.135-1.166a2.47 2.47 0 0 1-1.006-.912c-.253-.4-.38-.842-.38-1.322 0-.678.237-1.26.712-1.744a2.334 2.334 0 0 1 1.73-.726c.697 0 1.29.26 1.78.782 1.785-1.258 3.893-1.928 6.324-2.01l1.424-6.467a.42.42 0 0 1 .184-.26.4.4 0 0 1 .32-.063l4.53 1.006c.147-.306.368-.553.662-.74a1.78 1.78 0 0 1 .97-.278c.508 0 .94.18 1.302.54.36.36.54.796.54 1.31 0 .512-.18.95-.54 1.315-.36.364-.794.546-1.302.546-.507 0-.94-.18-1.295-.54a1.793 1.793 0 0 1-.533-1.308l-4.1-.92-1.277 5.86c2.455.074 4.58.736 6.37 1.985a2.315 2.315 0 0 1 1.757-.757c.68 0 1.256.242 1.73.726.476.484.713 1.066.713 1.744zm-16.868 2.47c0 .513.178.95.534 1.315.356.365.787.547 1.295.547.508 0 .942-.182 1.302-.547.36-.364.54-.802.54-1.315 0-.513-.18-.95-.54-1.31-.36-.36-.794-.54-1.3-.54-.5 0-.93.183-1.29.547a1.79 1.79 0 0 0-.54 1.303zm9.944 4.406c.09-.09.135-.2.135-.323a.444.444 0 0 0-.44-.447c-.124 0-.23.042-.32.124-.336.348-.83.605-1.486.77a7.99 7.99 0 0 1-1.964.248 7.99 7.99 0 0 1-1.964-.248c-.655-.165-1.15-.422-1.486-.77a.456.456 0 0 0-.32-.124.414.414 0 0 0-.306.124.41.41 0 0 0-.135.317.45.45 0 0 0 .134.33c.352.355.837.636 1.455.843.617.207 1.118.33 1.503.366a11.6 11.6 0 0 0 1.117.056c.36 0 .733-.02 1.117-.056.385-.037.886-.16 1.504-.366.62-.207 1.104-.488 1.456-.844zm-.037-2.544c.507 0 .938-.182 1.294-.547.356-.364.534-.802.534-1.315 0-.505-.18-.94-.54-1.303a1.75 1.75 0 0 0-1.29-.546c-.506 0-.94.18-1.3.54-.36.36-.54.797-.54 1.31s.18.95.54 1.315c.36.365.794.547 1.3.547z\" fill-rule=\"evenodd\"></path></g></svg></span><span class=\"at-label\" style=\"font-size: 11.4px; line-height: 32px; height: 32px; color: rgb(255, 255, 255);\">Reddit</span></a><a role=\"button\" tabindex=\"0\" class=\"at-icon-wrapper at-share-btn at-svc-linkedin\" style=\"background-color: rgb(0, 119, 181); border-radius: 0px;\"><span class=\"at4-visually-hidden\">Share to LinkedIn</span><span class=\"at-icon-wrapper\" style=\"line-height: 32px; height: 32px; width: 32px;\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 32 32\" version=\"1.1\" role=\"img\" aria-labelledby=\"at-svg-linkedin-4\" style=\"fill: rgb(255, 255, 255); width: 32px; height: 32px;\" class=\"at-icon at-icon-linkedin\"><title id=\"at-svg-linkedin-4\">LinkedIn</title><g><path d=\"M26 25.963h-4.185v-6.55c0-1.56-.027-3.57-2.175-3.57-2.18 0-2.51 1.7-2.51 3.46v6.66h-4.182V12.495h4.012v1.84h.058c.558-1.058 1.924-2.174 3.96-2.174 4.24 0 5.022 2.79 5.022 6.417v7.386zM8.23 10.655a2.426 2.426 0 0 1 0-4.855 2.427 2.427 0 0 1 0 4.855zm-2.098 1.84h4.19v13.468h-4.19V12.495z\" fill-rule=\"evenodd\"></path></g></svg></span><span class=\"at-label\" style=\"font-size: 11.4px; line-height: 32px; height: 32px; color: rgb(255, 255, 255);\">LinkedIn</span></a><a role=\"button\" tabindex=\"0\" class=\"at-icon-wrapper at-share-btn at-svc-compact\" style=\"background-color: rgb(255, 101, 80); border-radius: 0px;\"><span class=\"at4-visually-hidden\">Share to More</span><span class=\"at-icon-wrapper\" style=\"line-height: 32px; height: 32px; width: 32px;\"><svg xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" viewBox=\"0 0 32 32\" version=\"1.1\" role=\"img\" aria-labelledby=\"at-svg-addthis-5\" style=\"fill: rgb(255, 255, 255); width: 32px; height: 32px;\" class=\"at-icon at-icon-addthis\"><title id=\"at-svg-addthis-5\">AddThis</title><g><path d=\"M18 14V8h-4v6H8v4h6v6h4v-6h6v-4h-6z\" fill-rule=\"evenodd\"></path></g></svg></span><span class=\"at-label\" style=\"font-size: 11.4px; line-height: 32px; height: 32px; color: rgb(255, 255, 255);\">More</span><span class=\"at4-share-count-container\" style=\"font-size: 11.4px; line-height: 32px; color: rgb(255, 255, 255);\">4</span></a></div></div></div><div class=\"tags\"><a class=\"button is-outlined\" href=\"https://smallstep.com/tags/technical\">Technical</a>\n<a class=\"button is-outlined\" href=\"https://smallstep.com/tags/ssh\">SSH</a>\n<a class=\"button is-outlined\" href=\"https://smallstep.com/tags/openid-connect\">OpenID Connect</a></div></section></div></div></div><section class=\"section\"><div class=\"container\"><div class=\"has-text-left\"><h4 class=\"title is-4\">Further reading</h4><div class=\"tile is-ancestor\"><div class=\"tile is-parent\"><div class=\"tile is-child\"><a href=\"https://smallstep.com/blog/private-acme-server/\"><div class=\"card\"><div class=\"card-image\"><figure class=\"image is-4by3\"><img src=\"https://smallstep.com/uploads/acme-smallstep-unfurl_hu1c517e3b955fd3cc8b4f8a1b86962437_120147_518x388_fill_q90_box_smart1_2.png\" alt=\"Post Featured Image\"></figure></div><div class=\"card-content has-text-left\"><p class=\"is-5 has-text-weight-semibold\">Run your own private CA &amp; ACME server using step-ca</p></div></div></a></div></div><div class=\"tile is-parent\"><div class=\"tile is-child\"><a href=\"https://smallstep.com/blog/embarrassingly-easy-certificates-on-aws-azure-gcp/\"><div class=\"card\"><div class=\"card-image\"><figure class=\"image is-4by3\"><img src=\"https://smallstep.com/uploads/iid-unfurl_huc389c08cc58cc9688007a1f3472375be_396046_518x388_fill_q90_box_smart1_2.png\" alt=\"Post Featured Image\"></figure></div><div class=\"card-content has-text-left\"><p class=\"is-5 has-text-weight-semibold\">Embarrassingly easy private certificate management for VMs on AWS, GCP, and Azure</p></div></div></a></div></div><div class=\"tile is-parent\"><div class=\"tile is-child\"><a href=\"https://smallstep.com/blog/passive-revocation/\"><div class=\"card\"><div class=\"card-image\"><figure class=\"image is-4by3\"><img src=\"https://smallstep.com/uploads/Pass_rev-unfurl_hu54027f0c2e51d870c0b61c31a01bde9d_103534_518x388_fill_q90_box_smart1_2.png\" alt=\"Post Featured Image\"></figure></div><div class=\"card-content has-text-left\"><p class=\"is-5 has-text-weight-semibold\">Good certificates die young: what's passive revocation and how's it implemented?</p></div></div></a></div></div></div></div></div></section></article></main><footer class=\"footer\"><div class=\"container\"><div class=\"content m-t-md\"><div class=\"columns is-vcentered\"><div class=\"column is-3 has-text-centered has-text-left-tablet\"><img width=\"144\" height=\"25\" src=\"https://smallstep.com/uploads/smallstep_tm_full_white.svg\" alt=\"Smallstep\"></div><div class=\"column is-3 has-text-left-tablet\"><form name=\"footer\" method=\"post\"><input type=\"hidden\" name=\"form-name\" value=\"footer\"><div class=\"is-hidden\"><label class=\"label\">Don’t fill this out if you're human:</label><div class=\"control\"><input class=\"input\" name=\"bot-field\"></div></div><div class=\"field is-grouped\"><div class=\"control\"><input class=\"input\" type=\"text\" name=\"email\" placeholder=\"Email\" required=\"\"></div><div class=\"control\"><input class=\"button is-danger has-text-weight-bold is-uppercase\" type=\"submit\" value=\"Subscribe\"></div></div></form></div><div class=\"column has-text-centered\"><a href=\"https://twitter.com/smallsteplabs\" target=\"_blank\"><img class=\"icon twitter\" src=\"https://smallstep.com/images/icons/twitter.svg\" alt=\"Smallstep\"></a>\n<a href=\"https://www.linkedin.com/company/smallstep\" target=\"_blank\"><img class=\"icon linkedin\" src=\"https://smallstep.com/images/icons/linkedin.svg\" alt=\"Smallstep\"></a>\n<a href=\"https://github.com/smallstep\" target=\"_blank\"><img class=\"icon github\" src=\"https://smallstep.com/images/icons/github.svg\" alt=\"Smallstep\"></a></div></div></div><div class=\"footer-links columns is-mobile is-multiline\"><div class=\"column\"><ul><li><strong><a href=\"/blog\">Blog</a></strong></li><li><a href=\"/signup/\">Try For Free</a></li><li><a href=\"/request-demo/\">Register for Demo</a></li></ul></div><div class=\"column\"><ul><strong>Documentation</strong><li><a href=\"/docs/\">Reference | OSS</a></li><li><a href=\"/docs/getting-started/\">Getting Started | OSS</a></li><li><a href=\"/docs/sso-ssh/\">SSO SSH Professional</a></li><li><a href=\"https://smallstep.com/hello-mtls\">Hello mTLS</a></li></ul></div><div class=\"column\"><ul><strong>Open Source</strong><li><a href=\"/integrations/\">Integrations</a></li><li><a href=\"/cli/\">step CLI</a></li><li><a href=\"/certificates/\">step Certificates</a></li><li><a href=\"/docs/design-document/\">Design Document</a></li></ul></div><div class=\"column\"><ul><strong>Solutions</strong><li><a href=\"/sso-ssh/\">Single Sign-On SSH</a></li><li><a href=\"/production-identity/\">Production Identity</a></li><li><a href=\"/cross-connect/\">Cross Connect Cloud</a></li></ul></div><div class=\"column\"><ul><strong>Company</strong><li><a href=\"/about/\">About</a></li><li><a href=\"/careers/\">Careers</a></li></ul></div></div></div><div class=\"container subfooter m-t-md\"><div class=\"content\"><div class=\"columns is-size-7 has-text-grey-lighter has-text-centered has-text-left-tablet\"><div class=\"column is-narrow\">© 2020 Smallstep Labs, Inc. All rights reserved</div><div class=\"column is-narrow\"><a href=\"/privacy-policy/\">Privacy</a></div><div class=\"column is-narrow\"><a href=\"/terms-of-use/\">Terms &amp; Conditions</a></div></div></div></div></footer><script async=\"\" defer=\"\" src=\"https://buttons.github.io/buttons.js\"></script><script type=\"text/javascript\" src=\"//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5d6f4500f714d305\"></script><div id=\"_atssh\" style=\"visibility: hidden; height: 1px; width: 1px; position: absolute; top: -9999px; z-index: 100000;\"><iframe id=\"_atssh902\" title=\"AddThis utility frame\" src=\"https://s7.addthis.com/static/sh.f48a1a04fe8dbf021b4cda1d.html#rand=0.15436061950711988&amp;iit=1587690087722&amp;tmr=load%3D1587690087577%26core%3D1587690087692%26main%3D1587690087711%26ifr%3D1587690087730&amp;cb=0&amp;cdn=0&amp;md=0&amp;kw=&amp;ab=-&amp;dh=smallstep.com&amp;dr=&amp;du=https%3A%2F%2Fsmallstep.com%2Fblog%2Fdiy-single-sign-on-for-ssh%2F&amp;href=https%3A%2F%2Fsmallstep.com%2Fblog%2Fdiy-single-sign-on-for-ssh%2F&amp;dt=DIY%20Single%20Sign-On%20for%20SSH&amp;dbg=0&amp;cap=tc%3D0%26ab%3D0&amp;inst=1&amp;jsl=0&amp;prod=undefined&amp;lng=en&amp;ogt=image%2Curl%2Ctype%3Darticle%2Cdescription%2Ctitle&amp;pc=men&amp;pub=ra-5d6f4500f714d305&amp;ssl=1&amp;sid=5ea23a6722f33788&amp;srf=0.01&amp;ver=300&amp;xck=0&amp;xtr=0&amp;og=title%3DDIY%2520Single%2520Sign-On%2520for%2520SSH%26description%3DLet's%2520set%2520up%2520Google%2520SSO%2520for%2520SSH!%2520We%25E2%2580%2599ll%2520use%2520OpenID%2520Connect%2520(OIDC)%252C%2520SSH%2520certificates%252C%2520a%2520clever%2520SSH%2520configuration%2520tweak%252C%2520and%2520Smallstep%25E2%2580%2599s%2520open%2520source%2520packages.%26type%3Darticle%26url%3Dhttps%253A%252F%252Fsmallstep.com%252Fblog%252Fdiy-single-sign-on-for-ssh%252F%26image%3Dhttps%253A%252F%252Fsmallstep.com%252Fuploads%252Fdiy-sso-ssh-unfurl.jpg&amp;csi=undefined&amp;rev=v8.28.3-wp&amp;ct=1&amp;xld=1&amp;xd=1\" style=\"height: 1px; width: 1px; position: absolute; top: 0px; z-index: 100000; border: 0px; left: 0px;\"></iframe></div><div class=\"clym-widget\" id=\"clym-widget-privacy-frame\" style=\"position: fixed; z-index: 2147483646; left: 0px; bottom: 0px;\"><iframe src=\"https://widget.clym-sdk.net/widget.html?channel=oa69x00Jrdl8qB3NVx0T31HGwlxi0bpY&amp;id=189e46e266914c3b810a6908qb1a6y95&amp;origin=smallstep.com\" name=\"clym-frame-oa69x00Jrdl8qB3NVx0T31HGwlxi0bpY\" frameborder=\"0\" marginheight=\"0\" allowtransparency=\"true\" marginwidth=\"0\" scrolling=\"no\" width=\"363px !important\" height=\"186px !important\" style=\"width:363px !important; height:186px !important; margin:0  !important; display:block !important; background-color:transparent !important; position:absolute !important; max-height:2048px !important; min-height:1px !important; max-width:2048px !important; min-width:1px !important; border-style:none !important; left:0px !important; bottom:0px !important\"></iframe><div id=\"clym-tag-0478932a172e462795c8ddd7wx7iy3fw\"><!-- Reddit Pixel -->\n<script>\n!function(w,d){if(!w.rdt){var p=w.rdt=function(){p.sendEvent?p.sendEvent.apply(p,arguments):p.callQueue.push(arguments)};p.callQueue=[];var t=d.createElement(\"script\");t.src=\"https://www.redditstatic.com/ads/pixel.js\",t.async=!0;var s=d.getElementsByTagName(\"script\")[0];s.parentNode.insertBefore(t,s)}}(window,document);rdt('init','t2_4sz6l4zd');rdt('track', 'PageVisit');\n</script>\n<!-- DO NOT MODIFY -->\n<!-- End Reddit Pixel --></div><div id=\"clym-tag-2357b70206614e44af49d8edzby1tuth\"><script type=\"text/javascript\"><noscript><iframe src=\"https://www.googletagmanager.com/ns.html?id=GTM-5P3XBD9&gtm_auth=PjbT2KLFAdrwkFI_-GT-LA&gtm_preview=env-2&gtm_cookies_win=x\" height=0 width=0 style=display:none;visibility:hidden>\n</iframe></noscript></script></div><div id=\"clym-tag-5546e569a6cc4c8a8eb54bc20frhvyx5\"><script async=\"async\" src=\"//script.crazyegg.com/pages/scripts/0092/1561.js\" type=\"text/javascript\"></script></div><div id=\"clym-tag-6AONNRLFnLpnTd69TmQ1NuKteWb4KJZi\"><script type=\"text/javascript\"> adroll_adv_id = \"TC4YUE4CBRE3BHSQBGOIJW\"; adroll_pix_id = \"TAOIDACOYRHELHMSKHZBVQ\"; (function () { var _onload = function(){ if (document.readyState && !/loaded|complete/.test(document.readyState)){setTimeout(_onload, 10);return} if (!window.__adroll_loaded){__adroll_loaded=true;setTimeout(_onload, 50);return} var scr = document.createElement(\"script\"); var host = ((\"https:\" == document.location.protocol) ? \"https://s.adroll.com\" : \"http://a.adroll.com\"); scr.setAttribute('async', 'true'); scr.type = \"text/javascript\"; scr.src = host + \"/j/roundtrip.js\"; ((document.getElementsByTagName('head') || [null])[0] || document.getElementsByTagName('script')[0].parentNode).appendChild(scr); }; if (window.addEventListener) {window.addEventListener('load', _onload, false);} else {window.attachEvent('onload', _onload)} }()); </script><script src=\"http://a.adroll.com/j/roundtrip.js\" type=\"text/javascript\" async=\"true\"></script></div><div id=\"clym-tag-c81d2eb7892a4d4eac6b2b1cooeb4nhl\"><script async=\"\" src=\"https://106c8727c24d4832aa6fde5c4a35c9c1.js.ubembed.com\"></script></div><div id=\"clym-tag-OiyXmqDizzWl2fkXXO1hqwEc5tUqm0X4\"><script>\n    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){\n    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),\n    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)\n    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');\n\n    ga('create', 'UA-106748112-1', 'auto');\n    ga('send', 'pageview');\n </script></div></div><style id=\"service-icons-0\"></style>","text":"Documentation\nReference | OSS Getting Started | OSS SSO SSH Professional Hello mTLS\nOpen Source\nIntegrations step CLI step Certificates Design Document\nSolutions\nSingle Sign-On SSH Production Identity Cross Connect Cloud\nCompany\nAbout Careers\nBlog\nLogin\nDIY Single Sign-On for SSH\nCarl Tashian\n2020-04-13\nDon’t fill this out if you're human:\nYour browser does not support the video tag.\nTL;DR In this post we're going to set up Google single sign-on for SSH. Behind the scenes, we'll use OpenID Connect (OIDC), short-lived SSH certificates, a couple of clever SSH configuration tweaks, and Smallstep's open-source step-ca and step packages. We will set up an SSH Certificate Authority, and use it to bootstrap a new host and a new user in our system. While this approach requires more up-front work than a typical SSH public/private key setup, it comes with a lot of benefits beyond single sign-on. It eliminates the need for gathering and shipping and managing authorized_keys files.\nHow not to use SSH\nFor years, I innocently copied and pasted the same rusty old public key into an authorized_keys file on every server I used. And I always forgot to chmod it properly, so it never worked the first time. Someone taught me how to do this in 2004 and I never stopped.\nI only rotated my key once, begrudgingly, in 2015, when OpenSSH deprecated my key type. Years later, who knows what servers are out there with my public key still on them? Old startups I worked for? Freelancing clients? My niece Elsa's crypto mining rig?\nFrom an organization's standpoint, authorized_keys files just plain suck. In the early days, maybe someone crafts these files by hand like I did, but as the number of hosts and users grows it becomes a dreadful task. And one day you wake up with an ugly morass of public keys scattered across the infrastructure.\nMany organizations will then make a playbook to automate the management of authorized_keys files. No matter how thoughtfully executed, the task of gathering and shipping and maintaining all those keys remains messy.\nSingle sign on with OpenID Connect + SSH certificates\nWe're going to set up an SSH certificate authority and manage SSH access using short-lived certificates instead of authorized_keys files. And, we will pair it with OpenID Connect (OIDC) for single sign-on support.\nThis will take more up-front work than your typical out-of-the-box SSH configuration, but bear with me because once you get it going it's pretty sweet.\nWhat's an SSH certificate? It's a superior alternative to the public/private SSH key pair. Like public/private keys, certificates are exchanged between the user and host during the SSH handshake. a pared-down cousin of a TLS X.509 certificate. For a deeper dive, see our blog post, If You're Not Using SSH Certificates, You're Doing SSH Wrong.\nHere a decoded SSH certificate:\n<code>-: Type: ecdsa-sha2-nistp256-cert-v01@openssh.com user certificate Public key: ECDSA-CERT SHA256:N7ErGTPjhmruRS/4OiwyRi6Iyr59z0Ur1ifkHIHu4V8 Signing CA: ECDSA SHA256:E0GH/kZ/CGUIe8mMzzpujIiEYGC2IHDHafYBnye1WSU Key ID: \"carl@smallstep.com\" Serial: 16253962425132258867 Valid: from 2020-03-23T16:01:39 to 2020-03-24T08:01:39 Principals: carl carl@smallstep.com Critical Options: (none) Extensions: permit-X11-forwarding permit-agent-forwarding permit-port-forwarding permit-pty permit-user-rc\n</code>\nUser certificates like this one identify users to hosts. Host certificates identify hosts to users. The biggest difference is the Principals field.\nBy default, during the SSH handshake, SSHD will allow usernames listed in a user certificate's Principals field to sign in. Likewise, SSH expects to find the target hostname in a host certificate's Principals field.\nCertificate can also have extensions that allow privileged SSH features (like agent and port forwarding) or that force configuration directives.\nTo make magic happen, we're going to set up an ✨SSH Certificate Authority (CA) ✨, specifically Smallstep's step-ca server. Our CA will issue SSH certificates to users and hosts when they supply the right credentials.\nHere's a flow chart showing how Alice will get user certificate for herself and sign into a host:\nWe'll make this happen with an OpenSSH configuration block that works alongside our step command line tool.\nAdvantages\nNo more public key management. You will no longer have users * hosts number of authorized_keys files littered across your infrastructure. Users won't even need an .ssh directory on your hosts.\nEasily establish and revoke access across all hosts. SSH access expires the same day a user is removed from the OAuth domain. Traditional SSH key pairs don't expire. SSH certificates give us the benefit of passive revocation.\nBring your own security policy. Your Google security policy (including 2FA and security keys) will apply to the OAuth OIDC flow for granting SSH certificates. You can configure how often you want your certificates to expire.\nValidated host certificates. We will leverage EC2 Instance Identity Documents (IIDs) so that only hosts in your AWS account will be issued certificates.\nUser certificates are stored in memory. Key pairs are often stored on disk—and they never expire.\nNo more Trust On First Use (TOFU). With host certificates, you'll never see this message again:\n<code> The authenticity of host 'ec2-3-15-28-130.us-east-2.compute.amazonaws.com (3.15.28.130)' can't be established. ECDSA key fingerprint is SHA256:HYDAjwFL/qEmTuKm903tIk0fbPNk1CSRqH/usavToLw. Are you sure you want to continue connecting (yes/no/[fingerprint])?\n</code>\nThis post won't cover\nIntegrating more deeply with an Identity Provider (eg. syncing with a SCIM or LDAP directory)\nAdding sudo support that leverages certificates\nAdvanced access control lists (ACLs) for mapping between users and groups of hosts\nBacking up your CA's database\nAutomatically provisioning on hosts when a user connects for the first time\nImmediately revoking a user's certificate, before it expires\nPrerequisites\nYour hosts live on EC2\nYour users live together in a GSuite domain\nYou have the step toolkit installed locally\nOn macOS, you can run brew install step\nOn Linux, you can find Debian packages here.\nBut I don't want to run a Certificate Authority!\nMaybe you're thinking, “This is complex and scary.”\nCertificate Authorities got this reputation thanks to the arcane details of X.509 TLS certificates, the sheer number of acronyms in the world of PKI, and the complexity of tools like openssl.\nAlso, big CAs like Let's Encrypt do have a daunting amount of responsibility for keeping the internet secure.\nYou're not running Let's Encrypt.\nSSH certificates are simpler than TLS certificates. An SSH CA simply lets us delegate some of the responsibilities around authentication and authorization for a fleet of hosts to a single centralized service.\nStill not convinced? We can manage SSH access for you (and run the CA) for $3/host/month.\nTry it free for 30 days\nGet Started Now\nSay goodbye to your SSH key deploys!\nFor this project, we'll set up the CA with three provisioners—three methods for issuing certificates:\nFor user certificates, we will have an OAuth OIDC provisioner, associated with our Google OAuth app. We're trusting that Google reliably signs people in and only gives out valid, Google-signed OAuth identity tokens to authenticated users. The CA will verify the token using Google's public key.\nFor new EC2 hosts, we need an AWS provisioner, associated with our AWS account. New hosts will ask for SSH host certificates using this provisioner. We're trusting AWS to provide an Amazon-signed instance identity document that the CA will verify using Amazon's public key.\nFinally, for host certificate renewal we need an SSHPOP provisioner. We'll renew our host certificates weekly.\nShall we get to it?\n1. Create a Google OAuth Credential\nYou'll need a Google OAuth 2.0 Credential for this project. This takes 2 minutes.\nCreate a Google Cloud Console Project if you don't have one\nCreate the project in the GSuite Organization that you will use for single sign on.\nConfigure the OAuth 2.0 consent screen for an Internal project\nCreate an OAuth 2.0 credential\nFor Application Type, choose Other\nJot down the Client ID and Client Secret; you'll need them for the next step!\nNote: Your CA will only issue user certificates for users signing in to the GSuite organization associated with your Google Cloud project.\n2. Launch your Certificate Authority\nWe're going to install step-ca on an Ubuntu 18.04 LTS instance on AWS. A free tier instance (t2.micro/t3.micro) should suffice.\nGrab this CA launch script and plug in the variables at the top:\nThe OIDC client ID\nOIDC client secret\nYour GSuite domain name\nA name for your CA\nA root key password\nYour email\nUpload it as an EC2 User Data script for use in Step 3 (Configure Instance) when you launch your EC2 instance.\nFor connectivity, your VPC will need an internet gateway attached, and your instance should be in a security group that's available to all of your hosts and users on ports 22 (SSH) and 443 (HTTPS).\nThis is a good moment to mention that step-ca only accepts HTTPS connections via mTLS—it's more resistant to attacks than your typical web server.\nConnect to your CA instance using your PEM key.\nThe output of the User Data script is located in /var/log/cloud-init-output.log. Check it out and make sure everything initialized properly. The step-ca service should be running.\nThe CA will have created the following certificates and keys:\n/etc/step-ca/certs/root_ca.crt — your CA's root TLS certificate (self-signed).\n/etc/step-ca/certs/ssh_host_ca_key.pub — the SSH host CA key lets users verify host certificates.\n/etc/step-ca/certs/ssh_user_ca_key.pub — the SSH user CA key lets hosts verify user certificates.\nYou'll also have (in /etc/step-ca/secrets) the CA's private signing keys for the above certificates and keys. The password for these keys is saved in /etc/step-ca/password.txt. The CA reads this on startup to decrypt your keys.\nAs root, remove the User Data script, which contains your root CA password:\n<code># rm /var/lib/cloud/instances/i-**/user-data.txt**\n</code>\nYou'll need two bits of information from your CA:\nThe public hostname, so we can find it again.\nThe root certificate fingerprint, so we can establish a mutual TLS connection with it.\nAs root, run:\n<code># step certificate fingerprint $(step path)/certs/root_ca.crt\n5bc2b4779ad1562f6ed0809857fbed7925d2432eb25083f41a468532495ca658\n</code>\nJot these down. Your CA is up and running! 🎉\n3. Bootstrap a new host\nLet's bootstrap an Ubuntu instance that will be our first ssh target host.\nNote: Your CA will only issue host certificates for instances that are in its AWS account.\nThis time around, grab this host User Data script for launching the new instance—filling in these variables:\nYour CA's URL (https://[CA hostname])\nYour CA's root certificate fingerprint\nHere's what the User Data script will do:\nSo, we get a host certificate in exchange for a single-use token that contains the Instance Identity Document) and its signature.\nAbout those IIDs… In case you've never played with IIDs, here's what one looks like:\n<code>$ TOKEN=`curl -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\"` \\\n&amp;&amp; curl -H \"X-aws-ec2-metadata-token: $TOKEN\" –v http://169.254.169.254/latest/dynamic/instance-identity/document\n{ \"accountId\" : \"8072125551212\", \"architecture\" : \"x86_64\", \"availabilityZone\" : \"us-east-2c\", \"billingProducts\" : null, \"devpayProductCodes\" : null, \"marketplaceProductCodes\" : null, \"imageId\" : \"ami-0fc20dd1da406780b\", \"instanceId\" : \"i-01bd292377d6d8fec\", \"instanceType\" : \"t2.micro\", \"kernelId\" : null, \"pendingTime\" : \"2020-03-11T23:18:12Z\", \"privateIp\" : \"172.31.46.150\", \"ramdiskId\" : null, \"region\" : \"us-east-2\", \"version\" : \"2017-09-30\"\n}\n</code>\nThis bit of JSON is signed by Amazon. Here's the signature:\n<code>$ TOKEN=`curl -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\"` \\ &amp;&amp; curl -H \"X-aws-ec2-metadata-token: $TOKEN\" –v http://169.254.169.254/latest/dynamic/instance-identity/signature\nc0p6ygyFNFxyjs/73QGCQN+7khkZBr6H5cP/gefBgAwe80GmSTNlQy68LBSQQYrQczv2aHTXj3xa\nCFkaGE4GPYiAogCkywcnt5VAp3t176GQwVxqfmawTliPMs31dY7ZeZvixN/1uoe8x1pt0EXAMPLE\n</code>\nSign in with your PEM key and make sure everything initialized properly. The output of your user data script is located in /var/log/cloud-init-output.log.\nCreate a user for yourself on the host\nCreate a new user on the host. Your username must match the user portion of the email address you'll use to sign in to Google. In my case:\n<code>$ sudo adduser --quiet --disabled-password --gecos '' carl\n</code>\nThe host side of our setup is done! 🔑\n4. Onboard a new user\nLet's get you set up as the first user. On your local machine, run:\n<code>$ CA_URL=https://[YOUR CA].compute.amazonaws.com\n$ CA_FINGERPRINT=[CA FINGERPRINT]\n$ step ca bootstrap \\ --ca-url $CA_URL \\ --fingerprint $CA_FINGERPRINT\n</code>\nThis will install your CA's root certificate on your machine and configure it. It creates two files: ~/.step/config/defaults.json (the config file for step), and ~/.step/certs/root_ca.crt (your root CA's TLS certificate).\nNext, we can provision a user certificate for ourselves:\n<code>$ step ssh login [your email address] --provisioner \"Google\"\n</code>\nWhat does this command do?\nIt launches your system browser and starts Google's OIDC sign-in flow\nAfter signing in, the ID token you get back from Google is sent to your CA\nYour CA validates the Google token and issues an SSH certificate associated with your email address\nThe certificate is added to your SSH agent. Use step ssh list to see it, or step ssh list --raw | step ssh inspect to parse and examine it.\nFinally, let's configure ssh to use our CA:\n<code>$ step ssh config\n</code>\nHere are the steps taken by step ssh config:\nIt fetches the CA's host public key—used to verify host certificates—and installs it into your SSH configuration. The entry looks like this (in ~/.step/known_hosts):\n<code> @cert-authority * ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBHyWTo9TLDwhyLlHq2ANkjtSGLyJ3xPtfL+7faiV+YA0k4kLUc8cJ5rWFHdUShbwtkOsLhkqeDDXoFnH/C5BG+4=\n</code>\nIt imports this unintrusive config block (in .step/ssh/config) into your ssh configuration:\n<code>Match exec \"step ssh check-host %h\" ForwardAgent yes User carl UserKnownHostsFile \"/Users/carl/.step/ssh/known_hosts\" ProxyCommand step ssh proxycommand %r %h %p --provisioner \"Google\"\n</code>\nThe Match exec block is only evaluated if the provided command returns true.\nstep ssh check-host goes up to your CA and asks if the hostname you're trying to SSH to has been given a certificate. If so, it returns true. We don't want CA-managed hosts to interfere with your sconfig for any other hosts.\nThe ProxyCommand directive delivers the Single Sign-on magic. step ssh proxycommand will check for your SSH certificate before attempting to connect. If it's missing or expired, it will run you through the OAuth OIDC flow and request a new certificate from your CA.\nNote: A template on your CA defines this config block. If you want to change anything—for example, you may wish to remove the ForwardAgent directive—you can find the template in /etc/step-ca/templates/ssh.\nTry it out!\nWe're ready to SSH to the target host you've set up. You can run SSH with -v to watch the handshake. Specifically, you should see something like:\n<code>debug1: Server host certificate: ecdsa-sha2-nistp256-cert-v01@openssh.com SHA256:KUwZbRewusotBbO4Wbrj1EpPexMqKEj0ZUr1Fvf41+g, serial 782\n1790606781444805 ID \"i-0fa7218db55ac0536\" CA ecdsa-sha2-nistp256 SHA256:VIwnVtTJJwdUsjGaPyOS5yT1O/uxyxj0CQJd+Ce/w0M valid from 2020-03-2\n3T16:23:32 to 2020-04-22T16:24:32\ndebug1: Host 'ec2-3-135-235-172.us-east-2.compute.amazonaws.com' is known and matches the ECDSA-CERT host certificate.\ndebug1: Found CA key in /Users/carl/.step/ssh/known_hosts:1\n...\ndebug1: Offering public key: carl@smallstep.com ECDSA-CERT SHA256:mBQXA0znZvd+21hhvViUVEybzrO4x190xZftFXAYCFY agent\ndebug1: Server accepts key: carl@smallstep.com ECDSA-CERT SHA256:mBQXA0znZvd+21hhvViUVEybzrO4x190xZftFXAYCFY agent\n</code>\nBoom! You're in.\nTip: You can run step ssh hosts to ask the CA for a list of hosts that have been issued certificates.\nQ&amp;AHow do I register an existing host with the CA?\nFor Ubuntu 18.04 LTS hosts, the process is identical to bootstrapping a new host—just run your host launch script as root.\nFor other platforms, you may need to port the script to suit your situation.\nOnce you have all of your existing hosts up and running, you may want to adjust the instanceAge setting on the AWS provisioner on the CA. You'll see it in /etc/step-ca/config/ca.json. By default, an instance of any age can bootstrap itself. If you set it to, say, 5m, the CA will only accept IID tokens from instances less than 5 minutes old, as an extra measure of security.\nNote: The Instance Identity token created in the script is a one-time token. You can't re-enroll a host, you can only renew its certificate. Why? Because any user on the host can access the IID at any time, and we don't want any user to be able to get a host certificate from the CA.\nCan I use a different OAuth OIDC provider?\nSure! In the User Data script for the CA, you'll need to change the OAuth configuration endpoint URL, and change the name of your OIDC provisioner.\nCan I use GCP or Azure instead of AWS?\nYup! step-ca has provisioners for all three. You'll need to make some adjustments to your CA's configuration and host bootstrapping script. See step-ca's provisioner documentation for details.\nCan I use a bastion host (jump box)?\nYou can. First, get all of your hosts set up with host certificates. Then, you'll need to add the host CA key to known_hosts on your bastion:\n<code>$ CA_URL=https://[YOUR CA].compute.amazonaws.com\n$ CA_FINGERPRINT=[CA FINGERPRINT]\n$ step ca bootstrap \\ --ca-url $CA_URL \\ --fingerprint $CA_FINGERPRINT\n$ mkdir -p ~/.ssh &amp;&amp; echo \"@cert-authority * $(step ssh config --host --roots)\" &gt; ~/.ssh/known_hosts\n</code>\nFrom there, just ssh to the bastion, then ssh to the internal hostname.\nCan I change the SSH certificate duration?\nYes. By default they are valid for 16 hours. Under the claims object of the CA configuration (ca.json), for your OIDC provisioner, add the following keys to change the default:\n<code>\"defaultUserSSHCertDuration\": \"720h\",\n\"maxUserSSHCertDuration\": \"720h\"\n</code>Will I get locked out of my hosts if my CA goes down?\nYou will, even though SSH and SSHD don't directly interact with the CA. The CA issues certificates and holds a database of hosts. Your users rely on that database to choose whether to try the certificate authentication path when connecting to a host.\nFor safety, don't use SSH certificates to access the CA itself. That's is one place where key pairs are still going to serve you well.\nCan I use hosts in multiple AWS accounts?\nSure. You'll need to add the account IDs to the CA's config file (/etc/step-ca/config/ca.json), and restart the CA server.\nHow might I add sudo support?\nYou can do this using agent forwarding and the pam_ussh pluggable authentication module.\nWhat else can I do with my CA?\nLOTS! Now that you have your very own private CA, you could set it up to issue TLS certificates for encrypting all of your internal traffic using mutual TLS. See Step Certificates Documentation to learn more about the CA, provisioners, configuration options, etc.\nWrapping up\nWith our basic setup, anyone in your Google organization will be able to get a certificate. They will only be able to access hosts on which they have accounts with usernames that match their Google email username.\nIf you want features like fine-grained mappings between users and hosts and automatic user provisioning, or if you simply don't want to manage your own CA server, check out our Smallstep SSH product. It's only $3/month per host in your infrastructure.\nHow Smallstep SSH Works\nlearn more\nExplore the technical details of our managed offering\nAddThis Sharing Buttons\nShare to Hacker NewsHacker NewsHacker NewsShare to TwitterTwitterTwitterShare to RedditRedditRedditShare to LinkedInLinkedInLinkedInShare to MoreAddThisMore4\nTechnical SSH OpenID Connect\nFurther reading\nRun your own private CA &amp; ACME server using step-ca\nEmbarrassingly easy private certificate management for VMs on AWS, GCP, and Azure\nGood certificates die young: what's passive revocation and how's it implemented?\nDon’t fill this out if you're human:\nBlog\nTry For Free\nRegister for Demo\nDocumentation\nReference | OSS\nGetting Started | OSS\nSSO SSH Professional\nHello mTLS\nOpen Source\nIntegrations\nstep CLI\nstep Certificates\nDesign Document\nSolutions\nSingle Sign-On SSH\nProduction Identity\nCross Connect Cloud\nCompany\nAbout\nCareers\n© 2020 Smallstep Labs, Inc. All rights reserved\nPrivacy\nTerms &amp; Conditions","cname":"SSH的DIY单一登录","ctext":"文献资料\n参考| OSS入门| OSS SSO SSH Professional Hello mTLS\n开源的\n集成步骤CLI步骤证书设计文档\n解决方案\n单一登录SSH生产身份交叉连接云\n公司\n关于职业\n博客\n登录\nSSH的DIY单一登录\n卡尔·塔希安\n2020-04-13\n如果您是人类，请不要填写此信息：\n您的浏览器不支持视频标签。\nTL; DR在本文中，我们将为SSH设置Google单一登录。 在幕后，我们将使用OpenID Connect（OIDC），短期SSH证书，一些巧妙的SSH配置调整以及Smallstep的开源step-ca和step软件包。 我们将建立SSH证书颁发机构，并使用它来引导系统中的新主机和新用户。 尽管此方法比典型的SSH公共/专用密钥设置需要更多的前期工作，但除单点登录外，它还具有许多优点。 它消除了收集，运送和管理authorized_keys文件的需要。\n如何不使用SSH\n多年以来，我一直无辜地将相同的生锈旧公钥复制并粘贴到我使用的每台服务器上的authorized_keys文件中。 而且我总是忘记对其进行适当的chmod修改，因此它第一次无法使用。 2004年有人教我如何做到这一点，但我从未停止过。\n令人遗憾的是，在2015年OpenSSH弃用了我的密钥类型时，我只旋转了一次密钥。 几年后，谁知道我的公钥仍在其中的哪些服务器？ 我为之工作的旧创业公司？ 自由客户？ 我侄女艾尔莎（Elsa）的加密货币挖矿设备吗？\n从组织的角度来看，authorized_keys文件简直糟透了。 在早期，也许有人像我一样手工制作这些文件，但是随着主机和用户数量的增长，这变成了一项艰巨的任务。 有一天，您醒来时看到一堆丑陋的公共密钥，散落在整个基础架构中。\n然后，许多组织将制作一部剧本来自动管理authorized_keys文件。 无论执行得多么周到，收集，运输和维护所有这些密钥的任务仍然很混乱。\n使用OpenID Connect + SSH证书进行单点登录\n我们将建立一个SSH证书颁发机构，并使用短期证书而不是authorized_keys文件来管理SSH访问。 并且，我们将其与OpenID Connect（OIDC）配对以提供单点登录支持。\n与典型的现成SSH配置相比，这将需要更多的前期工作，但请忍受，因为一旦完成，它就非常好用。\n什么是SSH证书？ 它是公共/私有SSH密钥对的替代方案。 像公用/专用密钥一样，在SSH握手期间，证书在用户和主机之间交换。 TLS X.509证书的简化表亲。 要进行更深入的了解，请参阅我们的博客文章“如果您不使用SSH证书，则说明SSH错误”。\n这是解码的SSH证书：\n<code>-: Type: ecdsa-sha2-nistp256-cert-v01@openssh.com user certificate Public key: ECDSA-CERT SHA256:N7ErGTPjhmruRS/4OiwyRi6Iyr59z0Ur1ifkHIHu4V8 Signing CA: ECDSA SHA256:E0GH/kZ/CGUIe8mMzzpujIiEYGC2IHDHafYBnye1WSU Key ID: \"carl@smallstep.com\" Serial: 16253962425132258867 Valid: from 2020-03-23T16:01:39 to 2020-03-24T08:01:39 Principals: carl carl@smallstep.com Critical Options: (none) Extensions: permit-X11-forwarding permit-agent-forwarding permit-port-forwarding permit-pty permit-user-rc\n</code>\n像这样的用户证书可以识别主机的用户。 主机证书向用户标识主机。 最大的不同是“委托人”字段。\n默认情况下，在SSH握手期间，SSHD将允许用户证书的“委托人”字段中列出的用户名登录。同样，SSH希望在主机证书的“委托人”字段中找到目标主机名。\n证书还可以具有允许特权SSH功能（例如代理和端口转发）或强制执行配置指令的扩展。\n为使魔术发生，我们将建立一个“ SSH证书颁发机构（SSH）”，特别是Smallstep的step-ca服务器。 当用户和主机提供正确的凭据时，我们的CA将向用户和主机颁发SSH证书。\n这是显示爱丽丝如何获得自己的用户证书并登录到主机的流程图：\n我们将通过与步骤命令行工具一起使用的OpenSSH配置块来实现这一目标。\n好处\n不再需要公共密钥管理。 您将不再拥有*在整个基础架构中乱七八糟的用户*托管数量的authenticated_keys文件。 用户甚至在主机上都不需要.ssh目录。\n轻松建立和撤消所有主机之间的访问。 SSH访问在用户从OAuth域中删除的同一天到期。 传统的SSH密钥对不会过期。 SSH证书使我们受益于被动吊销。\n带上您自己的安全策略。 您的Google安全策略（包括2FA和安全密钥）将应用于OAuth OIDC流，以授予SSH证书。 您可以配置希望证书过期的频率。\n验证的主机证书。 我们将利用EC2实例身份文档（IID），以便仅向您AWS账户中的主机颁发证书。\n用户证书存储在内存中。 密钥对通常存储在磁盘上，并且永不过期。\n不再信任首次使用（TOFU）。 使用主机证书，您将永远不会再看到此消息：\n<code> The authenticity of host 'ec2-3-15-28-130.us-east-2.compute.amazonaws.com (3.15.28.130)' can't be established. ECDSA key fingerprint is SHA256:HYDAjwFL/qEmTuKm903tIk0fbPNk1CSRqH/usavToLw. Are you sure you want to continue connecting (yes/no/[fingerprint])?\n</code>\n这篇文章不会涵盖\n与身份提供者更深入地集成（例如，与SCIM或LDAP目录同步）\n添加利用证书的sudo支持\n用于在用户和主机组之间进行映射的高级访问控制列表（ACL）\n备份CA的数据库\n用户首次连接时自动在主机上进行配置\n在证书过期之前立即吊销用户的证书\n先决条件\n您的主机住在EC2上\n您的用户一起生活在GSuite域中\n您已经在本地安装了步骤工具包\n在macOS上，您可以运行brew install步骤\n在Linux上，您可以在这里找到Debian软件包。\n但是我不想运行证书颁发机构！\n也许您在想：“这很复杂而且令人恐惧。”\n由于X.509 TLS证书的神秘细节，PKI世界中缩写词的数量庞大以及openssl等工具的复杂性，证书颁发机构获得了这一声誉。\n而且，像“让我们加密”这样的大型CA确实承担着确保互联网安全的艰巨任务。\n您没有运行“让我们加密”。\nSSH证书比TLS证书简单。 SSH CA只是让我们将围绕主机群的身份验证和授权的某些职责委派给单个集中式服务。\n还是不服气？ 我们可以为您管理SSH访问（并运行CA），每月每主机$ 3。\n免费试用30天\n现在就开始\n告别您的SSH密钥部署！\n对于此项目，我们将使用三个配置者来设置CA，这是三种用于颁发证书的方法：\n对于用户证书，我们将有一个与我们的Google OAuth应用关联的OAuth OIDC供应商。 我们相信Google能够可靠地登录用户，并且只会向经过身份验证的用户提供有效的，由Google签名的OAuth身份令牌。 CA将使用Google的公钥验证令牌。\n对于新的EC2主机，我们需要一个与我们的AWS账户相关联的AWS供应商。 新主机将使用此配置程序请求SSH主机证书。 我们信任AWS提供的Amazon签名实例身份文档，CA将使用Amazon的公钥对其进行验证。\n最后，对于主机证书续订，我们需要SSHPOP设置程序。 我们将每周续订主机证书。\n我们去吧？\n1.创建一个Google OAuth凭证\n您需要此项目的Google OAuth 2.0凭据。 这需要2分钟。\n如果您没有，请创建一个Google Cloud Console项目\n在GSuite组织中创建用于单点登录的项目。\n为内部项目配置OAuth 2.0同意屏幕\n创建OAuth 2.0凭据\n对于应用程序类型，选择其他\n记下客户端ID和客户端密钥； 您将需要它们进行下一步！\n注意：您的CA仅会为登录与您的Google Cloud项目关联的GSuite组织的用户颁发用户证书。\n2.启动您的证书颁发机构\n我们将在AWS的Ubuntu 18.04 LTS实例上安装step-ca。 一个免费实例（t2.micro / t3.micro）就足够了。\n抓住此CA启动脚本，并在顶部插入变量：\nOIDC客户端ID\nOIDC客户端机密\n您的GSuite域名\n您的CA的名称\n根密钥密码\n你的邮件\n启动EC2实例时，将其上载为EC2用户数据脚本，以在步骤3（配置实例）中使用。\n为了进行连接，您的VPC将需要连接一个Internet网关，并且您的实例应位于一个安全组中，该安全组可用于端口22（SSH）和443（HTTPS）上的所有主机和用户。\n值得一提的是step-ca仅通过mTLS接受HTTPS连接-比典型的Web服务器更能抵抗攻击。\n使用PEM密钥连接到您的CA实例。\n用户数据脚本的输出位于/var/log/cloud-init-output.log中。 检查一下，确保一切都正确初始化。 step-ca服务应该正在运行。\nCA将创建以下证书和密钥：\n/etc/step-ca/certs/root_ca.crt-您的CA的根TLS证书（自签名）。\n/etc/step-ca/certs/ssh_host_ca_key.pub-SSH主机CA密钥使用户可以验证主机证书。\n/etc/step-ca/certs/ssh_user_ca_key.pub-SSH用户CA密钥使主机可以验证用户证书。\n您还将拥有（在/ etc / step-ca / secrets中）上述证书和密钥的CA专用签名密钥。 这些密钥的密码保存在/etc/step-ca/password.txt中。 CA在启动时会读取此信息以解密您的密钥。\n以root用户身份删除User Data脚本，其中包含您的根CA密码：\n<code># rm /var/lib/cloud/instances/i-**/user-data.txt**\n</code>\n您需要来自CA的两点信息：\n公共主机名，因此我们可以再次找到它。\n根证书指纹，因此我们可以与其建立双向TLS连接。\n以超级用户身份运行：\n<code># step certificate fingerprint $(step path)/certs/root_ca.crt\n5bc2b4779ad1562f6ed0809857fbed7925d2432eb25083f41a468532495ca658\n</code>\n把这些记下来。 您的CA已启动并正在运行！ 🎉\n3.引导新主机\n让我们引导一个将成为我们的第一个ssh目标主机的Ubuntu实例。\n注意：您的CA仅会为其AWS账户中的实例颁发主机证书。\n这次，获取此主机User Data脚本以启动新实例-填写以下变量：\n您的CA的URL（https：// [CA主机名]）\n您的CA的根证书指纹\n用户数据脚本将执行以下操作：\n因此，我们获得了主机证书，以换取包含实例标识文档及其签名的一次性令牌。\n关于这些KID ...如果您从未玩过KID，则如下所示：\n<code>$ TOKEN=`curl -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\"` \\\n&amp;&amp; curl -H \"X-aws-ec2-metadata-token: $TOKEN\" –v http://169.254.169.254/latest/dynamic/instance-identity/document\n{ \"accountId\" : \"8072125551212\", \"architecture\" : \"x86_64\", \"availabilityZone\" : \"us-east-2c\", \"billingProducts\" : null, \"devpayProductCodes\" : null, \"marketplaceProductCodes\" : null, \"imageId\" : \"ami-0fc20dd1da406780b\", \"instanceId\" : \"i-01bd292377d6d8fec\", \"instanceType\" : \"t2.micro\", \"kernelId\" : null, \"pendingTime\" : \"2020-03-11T23:18:12Z\", \"privateIp\" : \"172.31.46.150\", \"ramdiskId\" : null, \"region\" : \"us-east-2\", \"version\" : \"2017-09-30\"\n}\n</code>\nJSON的这一部分由Amazon签名。 这是签名：\n<code>$ TOKEN=`curl -X PUT \"http://169.254.169.254/latest/api/token\" -H \"X-aws-ec2-metadata-token-ttl-seconds: 21600\"` \\ &amp;&amp; curl -H \"X-aws-ec2-metadata-token: $TOKEN\" –v http://169.254.169.254/latest/dynamic/instance-identity/signature\nc0p6ygyFNFxyjs/73QGCQN+7khkZBr6H5cP/gefBgAwe80GmSTNlQy68LBSQQYrQczv2aHTXj3xa\nCFkaGE4GPYiAogCkywcnt5VAp3t176GQwVxqfmawTliPMs31dY7ZeZvixN/1uoe8x1pt0EXAMPLE\n</code>\n使用您的PEM密钥登录，并确保一切均已正确初始化。 用户数据脚本的输出位于/var/log/cloud-init-output.log中。\n在主机上为自己创建一个用户\n在主机上创建一个新用户。 您的用户名必须与您用于登录Google的电子邮件地址的用户部分匹配。 就我而言：\n<code>$ sudo adduser --quiet --disabled-password --gecos '' carl\n</code>\n我们安装程序的主机已完成！ 🔑\n4.新增用户\n让我们将您设置为第一个用户。 在本地计算机上，运行：\n<code>$ CA_URL=https://[YOUR CA].compute.amazonaws.com\n$ CA_FINGERPRINT=[CA FINGERPRINT]\n$ step ca bootstrap \\ --ca-url $CA_URL \\ --fingerprint $CA_FINGERPRINT\n</code>\n这将在计算机上安装CA的根证书并对其进行配置。 它创建两个文件：〜/ .step / config / defaults.json（用于step的配置文件）和〜/ .step / certs / root_ca.crt（您的根CA的TLS证书）。\n接下来，我们可以为自己设置用户证书：\n<code>$ step ssh login [your email address] --provisioner \"Google\"\n</code>\n该命令的作用是什么？\n它会启动您的系统浏览器并启动Google的OIDC登录流程\n登录后，您从Google获得的ID令牌将发送到您的CA\n您的CA会验证Google令牌并颁发与您的电子邮件地址关联的SSH证书\n证书已添加到您的SSH代理中。 使用step ssh list进行查看，或使用step ssh list --raw | 步骤ssh inspect进行分析和检查。\n最后，让我们配置ssh以使用我们的CA：\n<code>$ step ssh config\n</code>\n这是步骤ssh config采取的步骤：\n它获取CA的主机公共密钥（用于验证主机证书），并将其安装到SSH配置中。 该条目如下所示（在〜/ .step / known_hosts中）：\n<code> @cert-authority * ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBHyWTo9TLDwhyLlHq2ANkjtSGLyJ3xPtfL+7faiV+YA0k4kLUc8cJ5rWFHdUShbwtkOsLhkqeDDXoFnH/C5BG+4=\n</code>\n它将这个非侵入式配置块（在.step / ssh / config中）导入到您的ssh配置中：\n<code>Match exec \"step ssh check-host %h\" ForwardAgent yes User carl UserKnownHostsFile \"/Users/carl/.step/ssh/known_hosts\" ProxyCommand step ssh proxycommand %r %h %p --provisioner \"Google\"\n</code>\n仅在提供的命令返回true时，才对Match exec块进行评估。\n步骤ssh check-host进入您的CA，并询问您尝试SSH的主机名是否已获得证书。 如果是这样，则返回true。 我们不希望CA托管的主机干扰其他任何主机的sconfig。\nProxyCommand指令提供了单点登录魔术。 步骤ssh proxycommand将在尝试连接之前检查您的SSH证书。 如果丢失或过期，它将通过OAuth OIDC流程引导您，并向您的CA请求新证书。\n注意：CA上的模板定义了此配置块。 如果要更改任何内容（例如，您可能希望删除ForwardAgent指令），可以在/ etc / step-ca / templates / ssh中找到模板。\n试试看！\n我们已经准备好通过SSH连接到您设置的目标主机。 您可以使用-v运行SSH来观察握手。 具体来说，您应该看到类似以下内容：\n<code>debug1: Server host certificate: ecdsa-sha2-nistp256-cert-v01@openssh.com SHA256:KUwZbRewusotBbO4Wbrj1EpPexMqKEj0ZUr1Fvf41+g, serial 782\n1790606781444805 ID \"i-0fa7218db55ac0536\" CA ecdsa-sha2-nistp256 SHA256:VIwnVtTJJwdUsjGaPyOS5yT1O/uxyxj0CQJd+Ce/w0M valid from 2020-03-2\n3T16:23:32 to 2020-04-22T16:24:32\ndebug1: Host 'ec2-3-135-235-172.us-east-2.compute.amazonaws.com' is known and matches the ECDSA-CERT host certificate.\ndebug1: Found CA key in /Users/carl/.step/ssh/known_hosts:1\n...\ndebug1: Offering public key: carl@smallstep.com ECDSA-CERT SHA256:mBQXA0znZvd+21hhvViUVEybzrO4x190xZftFXAYCFY agent\ndebug1: Server accepts key: carl@smallstep.com ECDSA-CERT SHA256:mBQXA0znZvd+21hhvViUVEybzrO4x190xZftFXAYCFY agent\n</code>\n繁荣！ 你在。\n提示：您可以运行ssh步骤主机，以向CA询问已颁发证书的主机的列表。\n提示：您可以运行ssh步骤主机，以向CA询问已颁发证书的主机的列表。...\n对于Ubuntu 18.04 LTS主机，此过程与引导新主机相同–只需以root用户身份运行主机启动脚本即可。\n对于其他平台，您可能需要移植脚本以适合您的情况。\n一旦所有现有主机启动并运行，您可能想要调整CA上AWS设置程序上的instanceAge设置。 您将在/etc/step-ca/config/ca.json中看到它。 默认情况下，任何年龄的实例都可以自行引导。 如果将其设置为5m，则CA将仅接受来自时间不足5分钟的实例中的IID令牌，作为一种额外的安全措施。\n注意：在脚本中创建的实例身份令牌是一次性令牌。 您无法重新注册主机，只能更新其证书。 为什么？ 因为主机上的任何用户都可以随时访问IID，所以我们不希望任何用户都能从CA获得主机证书。\n我可以使用其他OAuth OIDC提供程序吗？\n当然！ 在CA的用户数据脚本中，您需要更改OAuth配置端点URL，并更改OIDC供应商的名称。\n我可以使用GCP或Azure代替AWS吗？\n对！ step-ca拥有这三个供应者。 您需要对CA的配置和主机引导脚本进行一些调整。 有关详细信息，请参见step-ca的预配器文档。\n我可以使用堡垒主机（跳箱）吗？\n您可以。 首先，为所有主机设置主机证书。 然后，您需要将主机CA密钥添加到堡垒上的known_hosts：\n<code>$ CA_URL=https://[YOUR CA].compute.amazonaws.com\n$ CA_FINGERPRINT=[CA FINGERPRINT]\n$ step ca bootstrap \\ --ca-url $CA_URL \\ --fingerprint $CA_FINGERPRINT\n$ mkdir -p ~/.ssh &amp;&amp; echo \"@cert-authority * $(step ssh config --host --roots)\" &gt; ~/.ssh/known_hosts\n</code>\n从那里，仅ssh到堡垒，然后ssh到内部主机名。\n我可以更改SSH证书的持续时间吗？\n是。 默认情况下，它们的有效期为16个小时。 在CA配置（ca.json）的Claims对象下，为您的OIDC设置者添加以下密钥以更改默认值：\n<code>\"defaultUserSSHCertDuration\": \"720h\",\n\"maxUserSSHCertDuration\": \"720h\"\n</code>Will I get locked out of my hosts if my CA goes down?\n即使SSH和SSHD不直接与CA交互，您也可以。 CA颁发证书并保存主机数据库。 您的用户依靠该数据库来选择在连接到主机时是否尝试证书认证路径。\n为了安全起见，请勿使用SSH证书访问CA本身。 那是密钥对仍然可以很好地为您服务的地方。\n我可以在多个AWS账户中使用主机吗？\n当然。 您需要将帐户ID添加到CA的配置文件（/etc/step-ca/config/ca.json），然后重新启动CA服务器。\n我如何添加sudo支持？\n您可以使用代理转发和pam_ussh可插入身份验证模块来执行此操作。\n我的CA还可以做什么？\n很多！ 现在，您已经拥有了自己的专用CA，可以将其设置为颁发TLS证书，以使用相互TLS加密所有内部流量。 请参阅步骤证书文档以了解有关CA，供应商，配置选项等的更多信息。\n包起来\n通过我们的基本设置，您Google组织中的任何人都可以获取证书。 他们将只能访问其帐户名与Google电子邮件用户名相匹配的主机。\n如果您需要诸如用户与主机之间的细粒度映射以及自动用户配置之类的功能，或者您只是不想管理自己的CA服务器，请查看我们的Smallstep SSH产品。 基础架构中每个主机每月只需$ 3。\nSmallstep SSH如何工作\n学到更多\n探索我们托管产品的技术细节\nAddThis共享按钮\n分享到Hacker NewsHacker NewsHacker News分享给TwitterTwitterTwitter分享给RedditRedditReddit分享给LinkedInLinkedInLinkedIn分享给MoreAddThisMore4\nSSH OpenID技术连接\n进一步阅读\n进一步阅读...\n轻松，轻松地为AWS，GCP和Azure上的VM进行私人证书管理\n好的证书会早逝：什么是被动撤销，它是如何实现的？\n如果您是人类，请不要填写此信息：\n博客\n免费试用\n注册演示\n文献资料\n参考|美国\n入门指南 开源软件\nSSO SSH专业\n你好mTLS\n开源的\n整合方式\n步骤CLI\n步骤证书\n设计文件\n解决方案\n单一登录SSH\n生产身份\n交叉连接云\n公司\n关于\n招贤纳士\n©2020 Smallstep Labs，Inc.保留所有权利\n隐私\n隐私...\n"}

{"l":"https://robertheaton.com/2020/04/06/systems-design-for-advanced-beginners/","n":"Systems design for advanced beginners","html":"\n    <header>\n  <div class=\"container\" style=\"margin-top: -25px\">\n    <h1 style=\"position: relative; top: 10px;\">\n      <a href=\"/\">Robert Heaton</a>\n    </h1>\n    <br>\n\n    <p class=\"tagline\" aria-hidden=\"true\">\n      Software Engineer / One-track lover / Down a two-way lane\n    </p>\n\n    <nav role=\"navigation\" style=\"margin-top: -5px\">\n      <ul>\n        <li><a href=\"/about\">About</a></li>\n        <li><a href=\"/archive\">Archive</a></li>\n        <li><a href=\"https://twitter.com/RobJHeaton\">Twitter</a></li>\n        <li><a style=\"color: #f92672;\" href=\"https://advancedbeginners.substack.com\">NEW: Programming Feedback for Advanced Beginners</a></li>\n      </ul>\n    </nav>\n  </div>\n</header>\n\n    <div class=\"container site\">\n      <section class=\"post blogpost\">\n        <h1 class=\"subject\"><a href=\"/2020/04/06/systems-design-for-advanced-beginners/\">Systems design for advanced beginners</a></h1>\n        <div class=\"date muted\">06 Apr 2020</div>\n        <blockquote>\n  <p>This post is part of my <a href=\"https://advancedbeginners.substack.com/\">Programming for Advanced Beginners series</a>. <a href=\"https://advancedbeginners.substack.com/\">Subscribe now</a> to receive specific, actionable ways to make your code cleaner, every other week, entirely free.</p>\n</blockquote>\n\n<p>You’ve started <a href=\"https://robertheaton.com/2018/07/09/how-tinder-keeps-your-location-a-bit-private/\">yet another</a> <a href=\"https://robertheaton.com/2017/10/09/tracking-friends-and-strangers-using-whatsapp/\">company</a> with your good friend, Steve Steveington. It’s an online marketplace where people can buy and sell things and where no one asks too many questions. It’s basically a rip-off of Craigslist, but with Steve’s name instead of Craig’s.</p>\n\n<p><img src=\"/images/systems-cover.png\"></p>\n\n<p>You’re going to be responsible for building the entire Steveslist technical platform, including all of its websites, mobile apps, databases, and other infrastructure. You’re excited, but also very nervous. You figure that you can probably cobble together a small website, since you’ve done that a few times before as part of your previous <a href=\"https://robertheaton.com/2018/07/09/how-tinder-keeps-your-location-a-bit-private/\">entertaining</a>-<a href=\"https://robertheaton.com/2017/10/09/tracking-friends-and-strangers-using-whatsapp/\">if</a>-<a href=\"https://robertheaton.com/2014/12/08/fun-with-your-friends-facebook-and-tinder-session-tokens/\">morally</a>-<a href=\"https://robertheaton.com/2016/10/22/a-tale-of-love-betrayal-social-engineering-and-whatsapp/\">questionable</a> <a href=\"https://robertheaton.com/2019/01/15/a-brief-history-of-wi-fi-privacy-vulnerabilities/\">escapades</a> with the Stevester. But you have no idea how to even start building out all of the other infrastructure and tools that you assume lie behind large, successful online platforms.</p>\n\n<p>You are in desperate need of a detailed yet concise overview of how real companies do this. How do they store their data? How do their different applications talk to each other? How do they scale their systems to work for millions of users? How do they keep them secure? How do they make sure nothing goes wrong? What are APIs, webhooks and client libraries, when you really get down to it?</p>\n\n<hr>\n\n<p>You send a quick WhatsApp to your other good friend, Kate Kateberry, to see if she can help. You’ve <a href=\"https://robertheaton.com/2019/01/15/a-brief-history-of-wi-fi-privacy-vulnerabilities/\">worked together very effectively in the past</a>, and she has decades of experience creating these types of systems at Silicon Valley’s biggest and most controversial companies.</p>\n\n<p>She instantly accepts your job offer. You had actually only been ringing for some rough guidance and a good gossip, but you nonetheless instantly accept her acceptance. No point looking a gift horse in the mouth, even when you don’t have any money to pay her. Kate proposes that her first day be 5 weeks ago in order to help her smooth over some accounting irregularities. She can come into the office sometime next week. You feel encouraged and threatened by her eagerness.</p>\n\n<hr>\n\n<p>Kate bounces into your offices in the 19th Century Literature section of the San Francisco Public Library. “OK let’s do this!” she shouts quietly. “What have we got so far? How are all our systems set up? What’s the plan?” You lean back in your chair and close your laptop, which was not turned on because you have left your charger at home. You steeple your fingers in a manner that you hope can be described as “thoughtful”.</p>\n\n<p>“Let me flip that question around, Kate. What do <em>you</em> think the plan should be?”</p>\n\n<p>Kate takes a deep breath and paints an extremely detailed vision of the Steveslist platform five years into the future and the infrastructure that will power it.</p>\n\n<hr>\n\n<p>Before we start (says Kate), I want to make it clear that I’m not saying that any of this is necessarily the “right” way to set up our infrastructure. If someone you trust more than me says something different then you should probably do what they say. There are many tools out there, each with different strengths and weaknesses, and many ways to build a technology company. The real, honest reasons that we will make many of our technological choices will be “we chose X because Sara knows a lot about X” and “we chose Y on the spur of the moment when it didn’t seem like a big decision and we never found the time to re-evaluate.”</p>\n\n<p>Nonetheless, let’s fast-forward five years into the future. Now Steveslist has two main consumer-facing products:</p>\n\n<ul>\n  <li>The Steveslist web app</li>\n  <li>The Steveslist smartphone apps</li>\n</ul>\n\n<p>These are the main ways in which users directly interact with the Steveslist platform. In addition, we also provide an API that allows programmers to build power-tools on top of the Steveslist platform that, for example, create listings for hundreds of items programmatically. To support this, we offer:</p>\n\n<ul>\n  <li>A Steveslist API</li>\n  <li>Steveslist API <em>client libraries</em> that make it easy for programmers to write code that talks to our API</li>\n</ul>\n\n<p>Here, I’ll draw a diagram on the whiteboard:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>+-----------+   +--------------+   +-----------------+\n|Web Browser|   |Smartphone App|   |Client Libraries/|\n+-----+-----+   +------+-------+   |Other API code   |\n      |                |           +-------+---------+\n      |                v                   |\n      |          +-----+------+            |\n      +---------&gt;+ Steveslist +&lt;-----------+\n                 |  Servers   |\n                 +------------+\n</code></pre></div></div>\n\n<p>Finally, we have many, many services running in the background that provide the data and power to these external-facing applications:</p>\n\n<ul>\n  <li>Webhooks - to notify users when something happens to their account, such as “order placed”</li>\n  <li>User password authentication - to securely log users in</li>\n  <li>SQL database - the main Steveslist data store. Needs to be highly scalable and reliable</li>\n  <li>Free-text searching system - to power the search box where people can look for broad search terms like “TVs” or “motorbikes”</li>\n  <li>Internal tools - to help us administer the Steveslist platform, and to take actions like issuing sternly-worded warnings to malicious users</li>\n  <li>Cron jobs - to run regular tasks that do anything from generating invoices, to billing customers, to sending as much of our users’ data as possible to third-party ad networks</li>\n  <li>“Pubsub” system - to allow us to take asynchronous actions on different trigger events (such as “when a new user signs up, send them a welcome email”)</li>\n  <li>Big data analytics system - to allow us to run enormous queries over the entirety of Steveslist’s data</li>\n  <li>And many more that we’ll talk about another day</li>\n</ul>\n\n<p>Let’s go through each of these systems in turn. <a href=\"https://robertheaton.com/about/\">Let me know</a> if anything isn’t clear, if you have any questions, or if you think I’ve got something wrong.</p>\n\n<h2 id=\"before-we-start---what-is-a-server-really\">Before we start - what is a server really?</h2>\n\n<p>Before we start, let’s define some important terms. In fact, let’s just define one. We’re going to talk a lot about “servers” today. But what is a server, when you really get down to it?</p>\n\n<p>For our purposes, a server is a computer that runs on a network and listens for communications from other computers. When it receives some data from another computer it performs some sort of action in response and - usually - sends back some data of its own. For example, a web server listens on a network for HTTP requests and sends back webpages and information in response. A database server listens for database queries and reads and writes data to the database that it is running.</p>\n\n<p>This brief description skips out entire degrees and careers of detail, and there are of course far more precise and accurate ways to define the word “server”. But this should get us through until dinnertime. What did you say? What’s a “network” really? A good question for another day.</p>\n\n<p>Now we’re ready to talk about the Steveslist platform.</p>\n\n<h2 id=\"steveslist-web-app\">Steveslist web app</h2>\n\n<p>This is the main Steveslist product. It’s just a normal web app, very similar to any website that you’ve built before, except much bigger. It’s a modern “single-page app” (SPA). The “single” in “single-page app” refers to the fact that the user’s browser almost never has to fully reload the page as the user clicks around our site. Instead, when the browser makes its first <em>HTTP request</em> to our servers, we send it back a basic, skeleton HTML page and a big pile of <em>JavaScript</em> code. This JavaScript code executes inside the browser, and updates the view of the page in response to the user’s actions. When the JavaScript wants to send or retrieve data from Steveslist, it sends an Asynchronous JavaScript XML Request (almost always called AJAX for short) in the background to a URL. When our server responds, the JavaScript uses the response to update the browser view accordingly.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>+----------+1.User's browser visits steveslist.com. +----------+\n|          |  It sends an HTTP request to the       |          |\n|          |  Steveslist servers                    |          |\n|          +---------------------------------------&gt;|          |\n|User's Web|                                        |Steveslist|\n| Browser  |2.Steveslist server responds with a     | Servers  |\n|          |  skeleton HTML page that instructs the |          |\n|          |  browser to request additional         |          |\n|          |  JavaScript files.                     |          |\n|          |&lt;---------------------------------------+          |\n|          |                                        |          |\n|          |3.User's browser requests and receives  |          |\n|          |  these JavaScript files from the       |          |\n|          |  Steveslist server.                    |          |\n|          +---------------------------------------&gt;|          |\n|          |&lt;---------------------------------------+          |\n|          |                                        |          |\n|          |4.User's browser executes the JavaScript|          |\n|          |  code. The code sends more requests for|          |\n|          |  the user's data to the Stevelist      |          |\n|          |  server, and updates the browser UI to |          |\n|          |  display it.                           |          |\n|          +---------------------------------------&gt;|          |\n|          |&lt;---------------------------------------+          |\n+----------+                                        +----------+\n</code></pre></div></div>\n\n<p><code class=\"language-plaintext highlighter-rouge\">robertheaton.com</code> is not a single-page app. Whenever you click on a link, the browser has to reload the entire page. <code class=\"language-plaintext highlighter-rouge\">twitter.com</code> <em>is</em> a single-page app. Whenever you click on a link, the browser dynamically updates a small portion of tthe page without forcing a full refresh.</p>\n\n<p>SPAs are a lot of work to build and maintain, but they sure look good.</p>\n\n<h2 id=\"steveslist-smartphone-apps\">Steveslist smartphone apps</h2>\n\n<p>We provide Steveslist smartphone apps for both iOS and Android. They are conceptually very similar to our single-page web app. Both our smartphone and web apps make HTTP requests to our servers. Then our servers receive these requests, do some work and return an HTTP response. Finally, both our smartphone and web apps update their display in order to communicate with the user.</p>\n\n<p>Since our smartphone apps are performing the same operations as the web app (for example, create listing, send message, etc), they can usually even send their requests to the exact same URLs as the web app. The only extra work that we have to do is to develop the frontends of the apps themselves. Some frameworks even make it possible to write mobile apps using JavaScript, allowing you to reuse code and logic across platforms.</p>\n\n<h2 id=\"steveslist-api\">Steveslist API</h2>\n\n<p>We allow users and third-parties to write code that programmatically interacts with our platform. In the same way that people can use the Twitter API to write code that reads; likes; and creates Tweets, we allow them to use the Steveslist API to search; buy; and list items.</p>\n\n<p>Programmers use our API by writing code that makes HTTP requests to our <em>API endpoints</em>. For example, in order to retrieve a list of all their listings, the programmer sends an HTTP <code class=\"language-plaintext highlighter-rouge\">GET</code> request to <code class=\"language-plaintext highlighter-rouge\">api.steveslist.com/v1/listings</code>. We respond with the data they requested, formatted as <em>JSON</em>. JSON stands for JavaScript Object Notation, but JSON is not specific to JavaScript and can easily be interpreted by any programming language. A JSON response to a request to retrieve all of a user’s listings might look something like this:</p>\n\n<div class=\"language-javascript highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"p\">{</span>\n  <span class=\"dl\">\"</span><span class=\"s2\">listings</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"p\">{</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">id</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">2178123867</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">name</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">Stolen TV</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">country</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">US</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">city</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">San Francisco</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">price_amount</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">1000</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">price_currency</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">usd</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"err\">#</span> <span class=\"nx\">etc</span><span class=\"p\">...</span>\n    <span class=\"p\">},</span>\n    <span class=\"p\">{</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">id</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">182312679</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">name</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">Stolen Bicycle</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">country</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">US</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">city</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">San Francisco</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">price_amount</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">2000</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">price_currency</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">usd</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"err\">#</span> <span class=\"nx\">etc</span><span class=\"p\">...</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>This structured response format is very easy for a program to parse, which means that the code that made the request can trivially interpret and use the data from our API.</p>\n\n<p>Users identify or <em>authenticate</em> themselves to our API using an API key. This is, roughly speaking, the API equivalent of a password. It is a long, random string that we generate and display on a user’s “Settings” page. Users include their API key as an <em>HTTP header</em> with every HTTP request that they (or their code) makes to the API. When we receive an API request we check to see whether the attached API key corresponds to a Steveslist user. If it does then we perform the request on behalf of that user.</p>\n\n<p>If a programmer wants to, they can manually build HTTP requests to our API themselves, using their language’s standard HTTP library. For example, in Python they might write:</p>\n\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">import</span> <span class=\"nn\">requests</span>\n\n<span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"s\">'https://api.steveslist.com/v1/listings/'</span>\n<span class=\"n\">listing_params</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"s\">\"name\"</span><span class=\"p\">:</span> <span class=\"s\">\"Stolen TV\"</span><span class=\"p\">,</span>\n  <span class=\"s\">\"country\"</span><span class=\"p\">:</span> <span class=\"s\">\"US\"</span><span class=\"p\">,</span>\n  <span class=\"s\">\"city\"</span><span class=\"p\">:</span> <span class=\"s\">\"San Francisco\"</span><span class=\"p\">,</span>\n  <span class=\"s\">\"price_amount\"</span><span class=\"p\">:</span> <span class=\"mi\">1000</span><span class=\"p\">,</span>\n  <span class=\"s\">\"price_currency\"</span><span class=\"p\">:</span> <span class=\"s\">\"usd\"</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n<span class=\"n\">api_key</span> <span class=\"o\">=</span> <span class=\"s\">\"YOUR_API_KEY_GOES_HERE\"</span>\n\n<span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">post</span><span class=\"p\">(</span>\n  <span class=\"n\">url</span><span class=\"p\">,</span>\n  <span class=\"n\">data</span><span class=\"o\">=</span><span class=\"n\">listing_params</span><span class=\"p\">,</span>\n  <span class=\"n\">headers</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s\">\"X-Steveslist-API-Key\"</span><span class=\"p\">:</span> <span class=\"n\">api_key</span><span class=\"p\">},</span>\n<span class=\"p\">)</span>\n</code></pre></div></div>\n\n<p>However, we make life easier for programmers by providing <em>client libraries</em>.</p>\n\n<h2 id=\"steveslist-client-libraries\">Steveslist client libraries</h2>\n\n<p>A client library is a library that “wraps” the functionality of the Steveslist API. This means that anyone using the client library doesn’t need to know anything about the fine details of the Steveslist API. Instead, they can just write:</p>\n\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">import</span> <span class=\"nn\">steveslist</span>\n\n<span class=\"n\">listing</span> <span class=\"o\">=</span> <span class=\"n\">steveslist</span><span class=\"o\">.</span><span class=\"n\">Listing</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span>\n  <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s\">\"Stolen TV\"</span><span class=\"p\">,</span>\n  <span class=\"n\">country</span><span class=\"o\">=</span><span class=\"s\">\"US\"</span><span class=\"p\">,</span>\n  <span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s\">\"San Francisco\"</span><span class=\"p\">,</span>\n  <span class=\"n\">price_amount</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"p\">,</span>\n  <span class=\"n\">price_currency</span><span class=\"o\">=</span><span class=\"s\">\"usd\"</span><span class=\"p\">,</span>\n  <span class=\"n\">api_key</span><span class=\"o\">=</span><span class=\"s\">\"YOUR_API_KEY_GOES_HERE\"</span>\n<span class=\"p\">)</span>\n</code></pre></div></div>\n\n<p>Our libraries turn the parameters that they are given into appropriately formatted HTTP requests, which they send to the Steveslist API as normal. We’ve written client libraries for every major programming language that we could think of, and they are by far the most common way that people interact with our API.</p>\n\n<h2 id=\"webhooks\">Webhooks</h2>\n\n<p>We’ve seen how Steveslist users can use our API to programmatically interact with their account. In addition, many users also want <em>us</em> to proactively tell <em>them</em> whenever something happens to their Steveslist profile. For example, suppose that someone wanted to fully automate the process of selling items on Steveslist. Whenever a customer pays for an item using our new, mostly-secure StevePay system, they want to send the customer a thank you email and automatically instruct their warehouse to ship a stolen TV to the order address. Our seller could constantly and repeatedly query the Steveslist API asking “Any new sales? Any new sales?” However, this would be very inefficient, and would put a lot of unnecessary load on our servers.</p>\n\n<p>Instead, we provide an industry standard system called <em>webhooks</em>. A webhook is an HTTP request that we send to our users whenever something interesting happens to their account. It contains all the data describing the event that just happened - for example, the item ID, the price, the buyer ID, buyer address, and so on. Webhooks allow users to automatically perform response actions, such as the aforementioned email and auto-shipping.</p>\n\n<p>To use webhooks, the user tells us the URL to which they would like us to send their webhooks (for example, <code class=\"language-plaintext highlighter-rouge\">steveslistwebhooks.robertheaton.com</code>. They set up a web server at that URL that will receive and action these webhook notifications.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>1.Buyer purchases an      3.The seller's server receives the webhook,\n  item as normal.           and uses the information in it to\n                            automatically process the order.\n+---------------+           +-----------------+\n|Buyer's Browser|           |Seller's Webhook-+\n+------+--------+           |Receiving Server |\n       |                    +------+----------+\n       |                           ^\n       |                           | \n       |                           |   \n       |    +-----------+          |\n       +---&gt;+ Steveslist+----------+\n            |   Server  |\n            +-----------+\n       2.Once the transaction has been completed,\n         Steveslist looks up the seller's\n         webhook URL (if set). We then send\n         an HTTP request to this URL,\n         containing the details of the purchase.\n</code></pre></div></div>\n\n<p>The user deploys code on their web server that performs the appropriate response actions whenever it receives a webhook from us. We don’t only send webhooks when an item is purchased - we also send them when a user receives a message; when one of their items is removed by an admin; or when a buyer makes a complaint. This enables Steveslist sellers to automate not just the listing of items, but also the selling and shipping of them too.</p>\n\n<h3 id=\"webhook-complications\">Webhook complications</h3>\n\n<p>Webhooks come with two main complications - security and reliability. First, let’s talk security. The endpoint to which the seller instructs us to send their webhooks is accessible to anyone on the internet. Anyone who knows the URL can send it fake webhooks, and if our seller isn’t careful this could allow an attacker to trick them into, for example, sending the attacker free stuff. A seller’s webhook URL should be difficult to find, since the seller won’t publicize its existence, but obscurity is not the same as security.</p>\n\n<p>To allow our sellers to verify that a webhook really was sent by Steveslist, we <em>cryptographically sign</em> our webhook contents.</p>\n\n<h4 id=\"cryptographic-signing\">Cryptographic signing</h4>\n\n<p>Cryptographic signing is a deep and subtle topic. Here’s a condensed version of how we use it to secure our webhooks.</p>\n\n<p>When a seller enables webhooks for their account, we generate a random “shared secret key”. We tell the seller to copy this key over to their webhook-receiving server and keep it secure, so that its value is known only by us and the seller. Whenever we send a webhook, we take this shared secret, combine it with the contents of the webhook by using a <em>cryptographic hash function</em> called <em>HMAC</em>, and get back a long, random-seeming, but entirely deterministic “signature” for the webhook.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Webhook contents   +----------+\n(eg. {\"id\": 123...})          |\n                              v\n                          +---+----------+\n                          |HMAC Algorithm|-----&gt;Webhook signature\n                          +---+----------+\n                              ^\nShared secret key             |\n(eg. 123mhu23jy8xdwgmd...)+---+\n</code></pre></div></div>\n\n<p>We include this signature in our webhook body, for example:</p>\n\n<div class=\"language-javascript highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"p\">{</span>\n  <span class=\"dl\">\"</span><span class=\"s2\">action</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">item_sold</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n  <span class=\"dl\">\"</span><span class=\"s2\">price</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">100</span><span class=\"p\">,</span>\n  <span class=\"c1\">// ...more params...</span>\n  <span class=\"dl\">\"</span><span class=\"s2\">signature</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">234gj98d49j834978gf39t78ndn98g7dq3ng897308y7</span><span class=\"dl\">\"</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>When the seller’s webhook-receiving server receives a webhook, it takes the shared secret and webhook contents and calculates what it expects the signature to be in exactly the same way that we did. It compares the result to the signature attached to the webhook; if they match then it accepts and processes the webhook. Since the signature can only be generated using the shared secret known only by us and the seller, the webhook-receiving server can be confident that the webhook was sent by us. If the signatures don’t match, however, the server rejects the webhook.</p>\n\n<p>Note that all of the signature verification code must be written and maintained by the sellers. We can provide them with encouragement and examples, but we can’t force them to verify signatures correctly, or even at all. For some real-world examples, look at how <a href=\"https://stripe.com/docs/webhooks/signatures\">Stripe</a> and <a href=\"https://developer.github.com/webhooks/securing/\">GitHub</a> sign their webhooks.</p>\n\n<h3 id=\"reliability\">Reliability</h3>\n\n<p>We also need to consider what happens when our webhooks go wrong and what guarantees we want to make to our users about them. If we try to send a webhook but can’t connect to the user’s server, what should we do? What if we successfully connect to their server and send the webhook, but their server sends back an error? What if we send the webhook but the server hangs for twenty seconds before disconnecting without telling us what happened?</p>\n\n<p>There are tradeoffs involved here that require clear communication and a surprising amount of infrastructure to manage. We at Steveslist choose to guarantee that we will deliver webhooks “at least once”. This means that if a webhook fails to send then we will keep trying (a large but not infinite number of times) until it does. If we’re not sure whether a webhook succeeded or failed, we will keep trying until we are sure that an attempt has succeeded. This might occasionally result in us sending the same webhook twice, but it’s the seller’s responsibility to have their code handle this gracefully instead of sending the same customer five stolen TVs instead of the one that they ordered.</p>\n\n<hr>\n\n<p>“What do you think so far?” asks Kate. “Is this roughly what you’ve been thinking?” You make a non-committal face and take a big bite of a nearby sandwich in order to preclude any further discussion. Kate continues:</p>\n\n<hr>\n\n<p>Let’s talk about the backend systems that will power some of our most important features.</p>\n\n<h2 id=\"user-authentication-via-a-password\">User authentication via a password</h2>\n\n<p>Most users sign into the Steveslist website and smartphone apps using a username and password. There are other ways of signing into the website, like <em>OAuth</em> - we’ll cover them another time.</p>\n\n<p>We will have to store our users’ passwords very securely. Not only is a user’s password the thing they use to sign in (or <em>authenticate</em>) to Stevelist, but for many users they’re probably the same password that they use to sign in to many other services too, despite all the warnings that this is a bad idea. They only have so many children with so many birthdays, after all.</p>\n\n<p>Rupert Herpton has written <a href=\"https://robertheaton.com/2019/08/12/programming-projects-for-advanced-beginners-user-logins/\">the seminal tutorial</a> on how to secure passwords, which I’m sure you’ve read already. Just in case you need a refresher, the crux of the matter is that we mustn’t ever store passwords in their original, <em>plaintext</em> form, anywhere. We mustn’t store them in plaintext in a database, in a log file, or in any other part of our system. Instead, before storing a password, we must first <em>hash</em> it using a <em>hash function</em> such as <em>bcrypt</em>.</p>\n\n<p>A hash function is a “one-way” function that takes an input and deterministically converts it into a new, seemingly-random string. Calculating a hash value from an input is computationally very easy, but reversing the transformation and recovering the original input from its hash value takes so much time and computing power that it is, practically-speaking, impossible.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>+---------+     Easy    +----------+\n|         |------------&gt;|          |\n|Plaintext|             |Hash value|\n|         |&lt;------------|          |\n+---------+ Essentially +----------+\n            Impossible\n</code></pre></div></div>\n\n<p>Since we only store the hash values of our users’ passwords, if a hacker somehow stole our password database (heaven forbid) (touch wood) then they would only be able to see the passwords’ hash values. They wouldn’t be able to easily turn these hash values back into <em>plaintext</em> passwords, meaning that they wouldn’t be able to use them to login to Steveslist, and they won’t be able to take advantage of all the people who re-use passwords across different services.</p>\n\n<p>Since we only store password hash values, when we want to check whether a login password that a user has given us is correct we first calculate its hash value, and compare the result to the hash value in our password database.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>                 +--------------+\n                 |User's Browser|\n                 +-----------+--+\n1.User attempts to  |        ^\nlog in:             |        |  3. Server logs the user in\n                    |        |  if password matches, and\n   username: steve  |        |  returns an error if it does not.\n   password: 12345  v        |  \n                 +--+--------+--+\n                 |  Steveslist  |\n                 |    Server    |\n                 +--------------+\n                        |\n2.Server computes       |     |username|password_hash|\nthe hash of the         |     +----------------------+\npassword and compares   +----&gt;+steve   |23jy7213y7jO |\nit to the value in the        |kate    |21897213hh21 |\ndatabase.                     |...     |...          |\n</code></pre></div></div>\n\n<p>As previously mentioned, we also have to be careful not to log passwords in any of our debug output. This can be an easy mistake to make - if you log all of the parameters of every HTTP request, just in case you need it, you will certainly be logging user passwords. Facebook logged passwords in plaintext for many years, and whilst it didn’t seem to affect their stock price I’m sure it made them feel pretty silly for a day or two.</p>\n\n<hr>\n\n<p>Kate pauses for breath. You pretend to take notes on your out-of-battery laptop.</p>\n\n<hr>\n\n<p>Let’s talk about infrastructure.</p>\n\n<h2 id=\"database-servers\">Database servers</h2>\n\n<p>Steveslist’s primary data store runs a common flavor of SQL database called <em>MySQL</em>. I won’t talk much about SQL here - the specifics of how it works aren’t too important, and you can find them on Google if you’re interested. Since we are so successful, we have a huge and growing amount of data to manage. We’ve started to become acutely aware that databases aren’t magic. They run on computers, just like any other program. As the volume of data in a database grows, the computer’s hard drive and memory starts to fill up. At the start of the company the easiest way to deal with this problem was to run our database on a single computer (or <em>machine</em>) with an enormous hard drive. But this could only stave off the problem for so long. Eventually our database contained more data than could be stored on any reasonable hard drive, and the database started to get slower and slower as we forced it to search through more and more records.</p>\n\n<p>We had to take an entirely new approach, and reconfigure our database to store its data on multiple computers. We did this using <em>sharding</em>.</p>\n\n<h3 id=\"sharding\">Sharding</h3>\n\n<p>Sharding a database means splitting its data into chunks (or “shards”) and storing each chunk on a separate machine. All of the machines that make up a database are together known as a <em>database cluster</em>. How you split data between machine in your cluster depends on your application and the types of operations you will be performing. For Steveslist we chose to split out our data by user. This means that all of the data for a given user is stored on the same machine. This includes their profile information, their listings, their messages, and so on. Data that doesn’t have a corresponding user (like “Deals of the Day”) can be sharded using a <em>shard key</em> other than user, or not sharded at all if the dataset is sufficiently small.</p>\n\n<p>This means that we need an extra “routing” layer in front of our database, which knows which database machine is able to service which queries. We could either make our <em>application servers</em> (the servers that execute our code) responsible for knowing the mapping of user IDs to database shards, or have a centralized “router” that all servers send their requests to, and which is responsible for working out the appropriate machine to forward the request on to. Both approaches have their advantages. Making application servers responsible for maintaining the mapping reduces the number of hops that a request has to make, speeding them up. But having a centralized router makes updating the shard mapping much easier, since you only have to update it in one place.</p>\n\n<p>If application servers are responsible for knowing the shard layout, we have a system that looks like this:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>            +          +          +\n            |          |          |\n            | Requests from users |\n            |          |          |\n            v          v          v\n     +------+----------+--------------------+\n     |            Application               |\n     |               Server                 |\n     |                                      |\n     |Database sharding config:             |\n     |* DB Server 1: IDs between 1-10000    |\n     |* DB Server 2: IDs between 10000-20000|\n     |* DB Server 3: IDs between 20000-30000|\n     +-+----------------+-----------------+-+\n       |                |                 |\n       |ID:501          |ID:15362         |ID:22361\n       |                |                 |\n       v                v                 v\n+-----------+     +-----------+     +-----------+\n|DB Server 1|     |DB Server 2|     |DB Server 3|\n+-----------+     +-----------+     +-----------+\n</code></pre></div></div>\n\n<p>If we have a centralized database router, we have a system that looks like this:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>            +          +          +\n            |          |          |\n            | Requests from users |\n            |          |          |\n            v          v          v\n     +------+----------+--------------------+\n     |            Application               |\n     |               Server                 |\n     |                                      |\n     |Database sharding config:             |\n     |* ??? Application Server has no idea  |\n     +------------+-----------+-------------+\n                  |           |\n      Application server sends all database\n      queries to the database router, which\n      forwards them to the correct shard.\n                  |           |\n                  v           v\n   +--------------+-----------+-------------+\n   |            Database router             |\n   |                                        |\n   |Database sharding config:               |\n   |* DB Server 1: IDs between 1-10000      |\n   |* DB Server 2: IDs between 10000-20000  |\n   |* DB Server 3: IDs between 20000-30000  |\n   +---+----------------+---------------+---+\n       |                |               |\n       |ID:501          |ID:15362       |ID:22361\n       |                |               |\n       v                v               v\n+-----------+    +-----------+   +-----------+\n|DB Server 1|    |DB Server 2|   |DB Server 3|\n+-----------+    +-----------+   +-----------+\n</code></pre></div></div>\n\n<p>How do we decide which database to assign each user to? However we want. We could start by saying that users with odd-numbered IDs are assigned to shard machine 1, and those with even-numbered ones are assigned to shard machine 2. We could hope that this random assignment results in balancing our data relatively evenly between our shards.</p>\n\n<p>However, it’s possible that we might have a small number of power users who create much, much more data than others. Maybe they create so much data that we want to allocate them a shard of their own. This is completely fine - we have complete control over how users are assigned to shards. Random assignments are usually easiest, but are by no means the only option. We can choose to assign users to shards randomly - except for user 367823, who is assigned to shard 15, which no other user is assigned to.</p>\n\n<p>If a shard gets too big and starts to fill up its machine’s hard-drive, we can split it up into multiple, smaller shards. How do we migrate the data to these new shards without having to turn off our platform for a while? Probably using a sequential process like:</p>\n\n<ol>\n  <li>“Double-write” new data to both the old and new shards. Continue reading data from the old shard</li>\n  <li>Copy over all existing data from the old shard to the new shard. Continue double-writing to old and new shards</li>\n  <li>Convince ourselves that the old and new shards contain the same data. We could do this by comparing snapshots of the databases, and/or by reading every query from both databases, comparing them, and alerting if the data is different</li>\n  <li>Once we’re confident that the new and old shards contain the same data, we switch to reading from the new shards. We continue double-writing in case we need to switch back</li>\n  <li>Once we’re confident that this step has been successful, stop double-writing and delete the old shard</li>\n</ol>\n\n<p>Rupert Herpton has written <a href=\"https://robertheaton.com/2015/08/31/migrating-bajillions-of-database-records-at-stripe/\">a great article about a broadly-similar type of migration</a> that goes into much more detail. In short, the process of migrating data between database shards is detailed and finicky, but also entirely doable and logical. Some types of database can even automatically take care of sharding for you.</p>\n\n<h3 id=\"replication\">Replication</h3>\n\n<p>We will take great care to make sure that our data doesn’t get accidentally deleted and our database servers don’t randomly stop working. But accidents happen, and sometimes computers do randomly stop working. To mitigate the fallout of a database-related disaster, we <em>replicate</em> our data across multiple machines in (close to) realtime.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>       Client writes new\n       data to DB Server A\n                |\n                v\n          +-----+-----+\n          |DB Server A|\n          ++---------++\n           |         | DB Server A quickly replicates\n           v         v the new data to DB Servers B and C\n+----------++      +-+---------+\n|DB Server B|      |DB Server C|\n+-----------+      +-----------+\n</code></pre></div></div>\n\n<p>Realtime replication has two main benefits. First, it means that if one of our database servers explodes, catches fire, or otherwise stops working, we have multiple almost-perfect copies of it that can seamlessly pick up the slack. In a straightforward, vanilla failure, users of our services may never know that anything has gone wrong. The second benefit of replication is that we can distribute queries for the same data across multiple database servers. If lots of users are asking to read data from the same database, we can split their queries up across all of our copies, meaning that we can handle more queries in parallel.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  Clients can query the same data\n  from any of DB Servers A,B,or C\n    |  |    |   |   |    |  |\n    |  |    v   v   v    |  |\n    |  |  +-+---+---+-+  |  |\n    |  |  |DB Server A|  |  |\n    |  |  +-----------+  |  |\n    |  |                 |  |\n    v  v                 v  v\n+---+-------+      +-----+-+---+\n|DB Server B|      |DB Server C|\n+-----------+      +-----------+\n</code></pre></div></div>\n\n<p>Note that database replication is not the same concept as making database backups. Replication happens in (close to) realtime, and is designed to deal on-the-fly with isolated problems in your live (or <em>production</em>) systems. Database backups are performed on a schedule (for example, once a day), and the copies of the data are stored separately, away from production systems. Backups are designed as a final safeguard against widespread, catastrophic data loss, as might happen if all your data centers burned down.</p>\n\n<p>Pretend that you work in the call centre of a big bank, where people are constantly calling you up in order to send money transfers and ask about their current balance. Replication is the equivalent of hurriedly writing down transfer details into multiple books, as you receive them, just in case you lose one of the books. Making backups is the equivalent of photocopying those books once a day and storing the copies in your filing cabinet.</p>\n\n<h3 id=\"replication-1\">Replication</h3>\n\n<p>The process of replication is conceptually quite straightforward. Whenever new data is written to our database, we copy it to multiple machines. This means that if/when a machine fails we can continue querying its siblings, with no user-facing impact. It also means that we can spread our queries out across multiple copies of the same data, resulting in faster query response times.</p>\n\n<p>However, the details of how we do this are important, subtle, and situation-dependent. There’s no right way to do replication - as is so often the case, the exact approach that you take depends on the specific requirements and constraints of your system.</p>\n\n<p>Replication is complicated by two inconvenient facts about the real world. First, database operations randomly fail sometimes. When we attempt to replicate our data from one server to another, things <em>will</em> occasionally go wrong, causing our machines to become out of sync, at least for a period. Second, even in periods of smooth operation, replication is not instantaneous. When new data is written to our database cluster, some servers in the cluster will always know about the update sooner than others. When choosing a replication strategy we must be aware of these limitations and how they impact our particular application. For example, maybe it’s OK to risk the number of “likes” on a post being slightly out of sync and out of date, but not the amount of money in a user’s bank account.</p>\n\n<p>One of the biggest decisions we must make when choosing a replication strategy is whether we want our replication to be <em>synchronous</em> or <em>asynchronous</em>.</p>\n\n<h3 id=\"asynchronous-vs-synchronous-replication\">Asynchronous vs synchronous replication</h3>\n\n<p>Replication can be handled either synchronously or asynchronously. These words come up in a lot of different places in systems design, but they always fundamentally mean the same thing. If an action is performed “synchronously” then this means that it is performed while something waits for it. If you wanted to send a letter synchronously then you would got to the Post Office, give your letter to a postal worker, sit and wait in the corner of the Post Office for a few days, and only go home when the postal worker confirmed that your letter had arrived safely.</p>\n\n<p>By contrast, if an action is performed “asynchronously” then this means that the initiator of the action doesn’t wait around for it to be finished. Instead, they just continue with the rest of their work while the action is worked on in the background. The real Postal Service is asynchronous; you give your letter to a postal worker, then leave and continue with your life while the Postal Service delivers your letter. Asynchronous actions can send back notifications of the outcome of the action if they want (“Your letter has arrived and was signed for” or “Mr. Heaton, your dry-cleaning is ready”), but they don’t have to.</p>\n\n<p>How do these principles apply to database replication? In synchronous replication a client writes its new data to a database server and then waits. This server doesn’t tell the client whether their write has been completed successfully until it has finished fully replicating the client’s data across all of its sibling servers. Then, and only then, does the client continue executing the rest of its code.</p>\n\n<p>In asynchronous replication the client writes its data to the first database server, as before. But this time the first server tells the client that the write was successful as soon as it has written the data to its own data store. It kicks off the replication process in the background, and doesn’t wait for it to complete, or even start, before it tells the client that the write was successful. This means that the asynchronous operation appears much faster than the synchronous one, because the client doesn’t have to wait for all the replication to complete before it can continue on with the rest of its work. However, if the background replication fails then the client will believe that it has successfully written its data to the database when it actually has not. This could cause problems, the imagination of which is left as an exercise for the reader.</p>\n\n<p>The synchronous approach is slower but “safer” than an asynchronous approach. The database never claims to have successfully received and stored any data until it has finished every single step of doing so. Because the client waits for full confirmation before proceeding, it is guaranteed to never encounter a situation where the client believes that it has written some data to the database, but the database has secretly partially dropped the data on the floor.</p>\n\n<p>Which approach is better? It depends. Do you care more about speed or correctness? Is it OK to occasionally have inconsistent data if it significantly speeds up the system’s operation? Or will even a single mistake cause airplanes to start falling out of the sky?</p>\n\n<p>Database replication systems face other interesting problems too. Many of these problems are “logical” rather than “technical”, and don’t require a detailed understanding of the complex software and networking protocols underlying the system. To help picture some of them, imagine that you’re back in the call centre from a few paragraphs ago. You work with many other colleagues. Together you play the role of database servers. People call you up to transfer money and ask about their current balance. You and your colleagues write information about new transfers down on paper, and replicate it between yourselves by calling each other up.</p>\n\n<p>The problems faced by our database cluster are identical to those faced by our call-centre. What happens if two people call in and try to update the same piece of data at the same time by talking to two different employees? Maybe we solve that by having a “leader” employee who is the only one authorized to serve calls from people trying to create transfers. All the other employees are only allowed to answer queries about current balances. OK, so what happens if the leader has a stroke and dies after they’ve received some new data, but before they’ve told everyone else about it? What if a “follower” employee has a temporary seizure for a few seconds and misses some data updates from the leader? What if we’re never entirely sure which of our employees are dead or alive?</p>\n\n<p>This is not an approximate metaphor that breaks down if you look too hard or start asking awkward questions. Understand this weird call-centre and you understand database replication. <a href=\"https://www.brianstorti.com/replication/\">Read this blog post</a> and you <em>really</em> understand replication.</p>\n\n<h3 id=\"backups\">Backups</h3>\n\n<p>In addition to realtime replication, we also store regular backups of our entire database in order to protect against catastrophic disaster. We copy all of the data in our database, store it somewhere safe, and mark it as something like “database backup, 2020-05-11:01:00”.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>+----------+  \n| Database +----------------&gt; database backup, 2020-05-11:01:00\n+----------+                  database backup, 2020-05-10:01:00\n                              database backup, 2020-05-09:01:00\n</code></pre></div></div>\n\n<p>If our entire database - or some fraction of it - somehow gets wiped out, we grab the most recent backup available and load it into new database machines.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>+----------+\n|   New    |\n| Database +&lt;---------------- database backup, 2020-05-11:01:00\n+----------+                  database backup, 2020-05-10:01:00\n                              database backup, 2020-05-09:01:00\n</code></pre></div></div>\n\n<p>Such a calamity could be caused by a cyberattack, a disaster in our data centre, a database migration gone horribly wrong, or any number of unlikely but potentially company-destroying reasons. Unlike realtime replication, restoring a database from a backup is a slow process that our users will definitely notice. Our entire system will likely be offline until the restoration is complete. We will have lost all database updates that occurred after the last backup but before the disaster. And there will no doubt be a large number of knock-on effects as users and systems try to access data that used to be there but is now lost forever. Nonetheless, these are all much less terrible than the complete, irrevocable loss of all our company’s data and with it, our company.</p>\n\n<p>That’s a whole lot of detail about our primary SQL database. Let’s talk about some other ways in which we store and query data.</p>\n\n<h2 id=\"free-text-searching\">Free-text searching</h2>\n\n<p>A standard SQL database is very good at answering well-defined and specific queries. For example:</p>\n\n<ul>\n  <li>Give me all the item listings created by user #145122 in the last 90 days</li>\n  <li>Give me the listing details for item #237326921</li>\n  <li>Give me the count of new listings per day created in San Francisco with the label “Electronics”</li>\n</ul>\n\n<p>You can retrieve this kind of data using SQL queries that look something like this:</p>\n\n<div class=\"language-sql highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span>\n  <span class=\"n\">user_id</span> <span class=\"o\">=</span> <span class=\"mi\">145122</span> <span class=\"k\">AND</span>\n  <span class=\"n\">created</span> <span class=\"o\">&gt;</span> <span class=\"n\">currentDate</span><span class=\"p\">()</span> <span class=\"o\">-</span> <span class=\"mi\">90</span>\n</code></pre></div></div>\n\n<p>or</p>\n\n<div class=\"language-sql highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">SELECT</span>\n  <span class=\"n\">DATE_TRUNC</span><span class=\"p\">(</span><span class=\"s1\">'day'</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">created</span><span class=\"p\">)</span> <span class=\"k\">AS</span> <span class=\"k\">day</span><span class=\"p\">,</span>\n  <span class=\"k\">COUNT</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span> <span class=\"k\">AS</span> <span class=\"n\">i</span>\n<span class=\"k\">INNER</span> <span class=\"k\">JOIN</span> <span class=\"n\">labels</span> <span class=\"k\">as</span> <span class=\"n\">l</span>\n  <span class=\"k\">ON</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">id</span> <span class=\"o\">=</span> <span class=\"n\">l</span><span class=\"p\">.</span><span class=\"n\">item_id</span>\n<span class=\"k\">WHERE</span>\n  <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">city</span> <span class=\"o\">=</span> <span class=\"s1\">'San Francisco'</span> <span class=\"k\">AND</span>\n  <span class=\"n\">l</span><span class=\"p\">.</span><span class=\"nb\">text</span> <span class=\"o\">=</span> <span class=\"s1\">'electronics'</span>\n<span class=\"k\">GROUP</span> <span class=\"k\">BY</span> <span class=\"mi\">1</span>\n<span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"mi\">1</span> <span class=\"k\">DESC</span>\n</code></pre></div></div>\n\n<p>You’ll notice that these queries contain a lot of very “precise” operators, like equals- and greater-than-signs. But how would you write a SQL query that could return a list of items that match a Google-style “full-text” search, like “second-hand TV”?</p>\n\n<p><img src=\"/images/systems-design-search.png\"></p>\n\n<p>This would be difficult. You could try the SQL <code class=\"language-plaintext highlighter-rouge\">LIKE</code> operator, which allows you to find records containing a pattern, such as a sub-string. For example, the following query finds all items with a description containing the sub-string <code class=\"language-plaintext highlighter-rouge\">second-hand TV</code>:</p>\n\n<div class=\"language-sql highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second-hand TV%'</span>\n</code></pre></div></div>\n\n<p>However, this query will only match the very specific sub-string that it was given. It won’t match “TV that is second-hand” or “2nd-hand TV”, or “sceond-hnad TV”. Given enough perseverance you could theoretically construct a giant SQL-query that covered as many of these permutations as you had patience for:</p>\n\n<div class=\"language-sql highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span>\n  <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second%hand%TV'</span> <span class=\"k\">OR</span>\n  <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second%TV%hand'</span> <span class=\"k\">OR</span>\n  <span class=\"c1\">-- …and so on and so on for another bajillion ORs…</span>\n</code></pre></div></div>\n\n<p>However, the resulting query would be slow and cumbersome, and would still miss many important edge-cases that you hadn’t thought of. And even if you did get back a useful list of search results, you’d still have a lot of work left to do in order to decide how to order them. The ordering you want isn’t something strict like “most-recent first” or “alphabetically by title”. Instead it’s some much woolier notion of “best” or “most-relevant” first.</p>\n\n<p>All of this means that SQL databases are generally not very good at full-text searches. Fortunately, other types of database are, including one called <em>Elasticsearch</em>. Elasticsearch is often described as a <em>document-oriented database</em>. We don’t need to go into the details of how exactly it works, but the important part for us is that, unlike SQL databases, Elasticsearch is very good at taking queries like “second-hand TV” and returning a list, ordered by “relevance,” of the fuzzy matches that users have come to expect from their search engines.</p>\n\n<p>“Sounds like Elasticsearch is just better than SQL,” you might say. “Should we throw away our SQL databases and put everything in Elasticsearch instead?” Not so fast. Elasticsearch, and other databases like it, have their strengths, but they also have their weaknesses. They’re typically somewhat less reliable than SQL databases, and are somewhat more likely to accidentally lose data at large scale. They’re also often much slower to write new data to.</p>\n\n<p>As we’ve already noted, there’s rarely a single, universally “best” tool for any type of job. There’s certainly no such thing as “the best” database. Instead, different databases have different strengths and weaknesses, and different solutions are appropriate for different tasks. At Steveslist, we care so much about making sure that we use the right tool for the right job that we store our data in both a SQL database <em>and</em> a document-oriented database like Elasticsearch.</p>\n\n<p>We use our SQL database as our primary data store. It is our authoritative “source-of-truth”, and we write all our new data to it before we write it anywhere else. We do all our simple, precise reads from it, especially when accuracy and up-to-date-ness are our principal requirements. If we want to show a user a list of all their open listings, we read it from our SQL database. If we want to validate a users password, we read that from our SQL database too. This plays to the strengths of SQL databases.</p>\n\n<p>However, in the background we also copy data from our SQL database into an Elasticsearch database, and send any full-text search queries made via our search box to Elasticsearch. This means that we benefit from the strengths of Elasticsearch, and are not impacted too much by its weaknesses. We copy over batches of records every few minutes, hours, or days, depending on the requirements of the specific dataset. Alternatively, we could watch the logs of our SQL database for new or updated records, and create or update the corresponding Elasticsearch records in near-realtime.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>                   |      |                   |\nNew data is always |      |Queries for        |Full-text search \nwritten to the SQL |      |specific data go   |queries go to\nDB first           |      |to the SQL DB too  |Elasticsearch\n                   V      V                   V\n               +--------------+       +---------------+\n               | SQL Database +------&gt;+ Elasticsearch |\n               +--------------+       +---------------+\n                       New data is copied over from\n                       the SQL DB to Elasticsearch\n</code></pre></div></div>\n\n<p>When scouting Steveslist’s competition, I noticed that when you create a new Craigslist listing it says “your listing will be visible in search within the next 15 minutes”. I’ll bet pesos to pizza that this is because their primary datastore is a SQL database, but their search box is powered by an Elasticsearch-like engine. Their pipeline for replicating data from SQL to search probably takes around 15 minutes, which they’ve decided (very reasonably) is an acceptable delay for their particular use-case.</p>\n\n<p>We’ve said that Elasticsearch is somewhat less reliable than most SQL databases. If Elasticsearch accidentally loses a few of our records then they won’t appear in search results. This would be a shame that would make our product a bit worse, and we try our hardest to avoid it happening. However, it wouldn’t be a disaster in the same way that losing data from our primary data store would be. We only copy data over to Elasticsearch once it has been written to and safely captured by our source-of-truth SQL database, which is what really matters.</p>\n\n<hr>\n\n<p>It’s 6pm, and the library is closing. A librarian tries to ask you to leave. Kate shoos him away with a barrage of crumpled-up balls of paper.</p>\n\n<hr>\n\n<h2 id=\"internal-tools\">Internal tools</h2>\n\n<p>Managing the Steveslist platform requires bespoke internal tools. We need to perform a wide range of administrative tasks, like deleting listings that are too illegal (even for us), issuing refunds, viewing a user’s personal details in order to help with support requests, and so on. Many of these tools will be used by people who work on other teams at Steveslist, like finance, compliance, legal, sales, and support. Since the tasks they need to perform are so specific to the way that Steveslist works, we can’t do them using third-party tools, and have to build our own instead.</p>\n\n<p>In the early days, we baked this functionality into the main Stevelist product and only exposed it to users who had the <code class=\"language-plaintext highlighter-rouge\">is_steveslist_employee = True</code> database flag set. This was an OK approach for a small company, but was also fragile and easy to mess up. It was scary to think that we were exposing all of our superuser powers through the same servers that run our main product. It made the potential consequences of a security flaw in our application much worse, and created new types of mistake for us to make, such as forgetting to disable the <code class=\"language-plaintext highlighter-rouge\">is_steveslist_employee</code> flag for an acrimoniously fired employee.</p>\n\n<p>Once Steveslist reached a certain level of maturity, we built ourselves an entirely separate admin platform, with separate, hardened authentication and authorization. The service runs on entirely separate servers, and requires a <em>VPN</em> and a <em>TLS client certificate</em> to access (which we’ll talk about another day). This separated out our internal- and external-facing products, and drastically reduced the chance of a boneheaded error exposing our admin tools to the world. We’re frequently building new internal tools - one for user administration, one for server management, one for fraud detection, and so on. These services all talk to the same database as our user-facing products, so they all have access to the same data. They just run on different servers that are completely inaccessible to the outside world.</p>\n\n<h2 id=\"cron-jobs\">Cron jobs</h2>\n\n<p>There are lots of tasks that we’ll want our system to perform at fixed times and intervals. For example:</p>\n\n<ul>\n  <li>Emailing ourselves weekly usage reports</li>\n  <li>Sending marketing emails to users</li>\n  <li>Charging the credit cards users who have a subscription plan with us</li>\n  <li>Copying data from our SQL database to Elasticsearch</li>\n</ul>\n\n<p>The most common tool used for running scheduled jobs is called <em>cron</em>, a tool that is built into Unix operating systems. It’s so common that people will often call any kind of scheduled job a “cron job”, even when it’s not actually being run by cron.</p>\n\n<p>You can set up a cron job on your own computer by running:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>crontab -e\n</code></pre></div></div>\n\n<p>Then typing into the prompt:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>*/5 * * * * $YOUR_COMMAND\n</code></pre></div></div>\n\n<p>This will cause your computer to execute <code class=\"language-plaintext highlighter-rouge\">$YOUR_COMMAND</code> every 5 minutes.</p>\n\n<p>Steveslist currently has a very simple and slightly fragile cron setup. We have a single “scheduled jobs server”. We use <code class=\"language-plaintext highlighter-rouge\">crontab</code> on this server (as above) to tell it the commands that we want it to run, and the schedule that we want it to run them on. This setup isn’t scaling very well - if the scheduled jobs server explodes or even hiccups then we don’t always know which jobs it did and didn’t run, and have to scramble to bring up a replacement server. And even though the server is very beefy and powerful, eventually we’re going to want to run more jobs than it can handle at once. We’re considering either splitting up our cron jobs into multiple servers, or setting up a new system using a modern tool like <em>Kubernetes</em>.</p>\n\n<h2 id=\"pubsub\">Pubsub</h2>\n\n<p>Actions have consequences. This is both the subject line of the sinister emails that we send to people who write mean things about us on the internet, and the reason we have a <em>pubsub</em> system.</p>\n\n<p>When a new user signs up, we want to send them an email welcoming them to Steveslist and reminding them about the action-consequence relationship I just described. When a new listing is added for a stolen TV in San Francisco, we want to notify users who have set up search alerts for TVs in the Bay Area. When a card is declined for a subscription, we want to email the responsible user to politely threaten them. When a new listing is added, we want to perform some extremely cursory anti-fraud checks. When an item is purchased, we want to sent a webhook to its seller. And so on.</p>\n\n<p>Technically, all of these actions could be performed synchronously (rememberer that word?) by the server executing the initiating action. However, this is often a bad idea, for two reasons. First, the response action (such as emailing all the users who are subscribed for notifications about new stolen TVs) may be very slow. Performing the response action synchronously means that if the initiating action was performed by a user then they will have to wait for all the response actions to finish too. This might not be the end of the world if the response action is small and quick, like sending a single email. But if it’s larger - like searching for and notifying all users who might be interested in a new item - then, well, it still won’t be the end of the world, but it will be a bad user experience.</p>\n\n<p>To mitigate this problem we have built a “publish-subscribe” or “pubsub” system. When a trigger action is performed, the code that performs it “publishes an event” describing the action, such as <code class=\"language-plaintext highlighter-rouge\">NewListingCreated</code> or <code class=\"language-plaintext highlighter-rouge\">SubscriptionCardDeclined</code>. The words “event” and “publish” are quite loosely defined in this context, and don’t have a rigorous technical definition. An event is just some sort of record of something that happened, and to publish an event just means that you somehow make a note that something happened. The details of how you do so depend entirely on the pubsub system in question. In a simple system events might be stored in tables in a SQL database, and code would publish events by writing new records to a table.</p>\n\n<p>If a programmer at Steveslist wants a response action to be performed whenever a new event of a particular type is published, they can write a <em>consumer</em>. This is a piece of code that “subscribes” to a type of event, and which is executed whenever a new event of that type is published. It uses the details of the event (for example, the user whose subscription payment failed) to asynchronously execute whatever actions the programmer wants (for example, sending the user a menacing email).</p>\n\n<p>Pubsub systems are often managed by a central <em>message broker</em>. Systems publish events to the broker, and the broker is then responsible for getting the events to any subscribed consumers. This can be achieved using either a <em>push</em> or a <em>pull</em> mechanism. Consumers can pull messages from the broker by polling it and repeatedly asking “any new events? any new events?” or they can wait and listen and the broker can push notifications of new events out to them, for example by sending them an HTTP request.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>1. New user signs|\nup to Steveslist |\n                 v\n       +-----------------+               +------------------------+\n       |Steveslist Server|           +--&gt;+SendWelcomeEmailConsumer|\n       +---------+-------+           |   +------------------------+\n                 |                   v\n2. Server reports|     +-------------++  4. Consumers send welcome\na NewUserSignup  +----&gt;+Pub/Sub Broker|  emails, check for spam,\nevent to the           +-------------++  etc.\nPub/Sub system                       ^\n              3. Pub/Sub broker      |   +------------------------+\n              notifies consumers     +--&gt;+NewUserSpamCheckConsumer|\n              that have subscribed to    +------------------------+\n              NewUserSignup events.\n</code></pre></div></div>\n\n<p>Pubsub systems have many benefits:</p>\n\n<ul>\n  <li>Non-critical actions are performed asynchronously, keeping the user experience snappy</li>\n  <li>Our code is kept clean and well-separated. The code that publishes an event doesn’t have to care about what the events’ subscribers do in response</li>\n  <li>If a subscriber’s action fails for some reason (for example, the email-sending system has a hiccup), the pubsub system can note this failure and retry again later</li>\n</ul>\n\n<p>Next, let’s talk big data.</p>\n\n<h2 id=\"big-data-and-analytics\">Big data and analytics</h2>\n\n<p>In order to understand and optimize our business, we need to be able to calculate complex statistics across the entire Steveslist platform. How many listings are created every day, segmented by country and city? How many users who signed up each month have created a listing within 90 days of signing up?</p>\n\n<p>To do this, we need to write database queries that aggregate over the entirety of our data. We don’t want to run these queries against our production SQL database, because they could put an enormous amount of load on it. We don’t want a huge query issued by an internal analyst to be able to bring our production database to a grinding halt, but we do want to provide this analyst with a tool that is well-suited to their needs. To complicate matters further, database engines that are quick at small queries (like returning all the listings belonging to a single user) are typically unacceptably slow (or indeed incapable) of answering giant queries (like calculating the total dollars spent on listings in each category, per day, for the last 90 days).</p>\n\n<p>Despite this, for the first year or so after Steveslist was founded, we took a risk and simply ran our analytics queries against the main production database. This was a gamble, but it just about worked. We didn’t have much data anyway, and we had more important things to focus on, like attracting the customers who would create the big data that would one day mean that we had to find a more scalable solution.</p>\n\n<p>Eventually we did bring down the production database with an overly-ambitious query, and decided that the time had come to invest in a data warehouse. A data warehouse is a data store that is well-suited to large, system-wide queries. Our warehouse is powered by a database engine called <em>Hive</em>, but we could also have chosen Presto, Impala, Redshift, or any number of competing alternatives. Hive accepts queries written in SQL, but is much better at executing these queries against giant datasets than our MySQL database is.</p>\n\n<p>We replicate our data from our production SQL database to Hive, once a day, overnight. Steveslist analysts and programmers can query the same dataset using whichever database engine best suits their needs. They can use the production SQL database for small, precise, source-of-truth queries from production systems; Elasticsearch for full-text search queries; or the data warehouse for huge queries that aggregate over vast volumes of data.</p>\n\n<hr>\n\n<p>It’s dark outside and you’re hungry. Is that pretty much it? you ask.</p>\n\n<p>“Oh god no,” Kate replies, “we could keep going forever. But this is a pretty good start. It’s helpful to have a broad understanding of a wide range of topics, but no one needs to know the details about everything. I find that once you know some basics you can keep picking up more basics and even a couple of details as you go along.”</p>\n\n<p>You ask if Kate could perhaps continue to elaborate on her five-year vision for Steveslist tomorrow.</p>\n\n<p>“Absolutely,” says Kate. We’ll talk about more of what goes on inside a real, large online platform, including:”</p>\n\n<h3 id=\"security\">Security</h3>\n\n<ul>\n  <li>HTTPS and other forms of encryption</li>\n  <li>Two-factor authentication</li>\n  <li>SAML</li>\n  <li>Secret key management</li>\n</ul>\n\n<h3 id=\"server-management\">Server management</h3>\n\n<ul>\n  <li>Deploying new code</li>\n  <li>AWS and competitors</li>\n  <li>Terraform</li>\n  <li>Load balancers</li>\n  <li>Containers</li>\n  <li>Alerting when code breaks</li>\n</ul>\n\n<h3 id=\"big-data\">Big data</h3>\n\n<ul>\n  <li>Map-reduce and other big data jobs</li>\n  <li>Machine learning</li>\n  <li>User tracking</li>\n</ul>\n\n<p>“See you tomorrow at 7am?”</p>\n\n\n        \n        <hr>\n        <div style=\"\">\n          <a href=\"https://twitter.com/robjheaton\">\n            Follow me on Twitter\n          </a>\n          or\n          <a href=\"https://robertheaton.com/feed.xml\">\n            RSS\n          </a>\n        </div>\n\n        <section style=\" padding-top: 60px;\">\n  <form action=\"https://ifoundthishelped.us4.list-manage.com/subscribe/post?u=84f18d8141e4ba155f81fb4eb&amp;id=264b2ba598\" method=\"post\" id=\"mc-embedded-subscribe-form\" name=\"mc-embedded-subscribe-form\" class=\"validate\" target=\"_blank\" novalidate=\"\">\n    <label for=\"mce-EMAIL\">\n      <h3 style=\"font-size: 1.5em; margin-top:-10px; margin-bottom:-6px;\">Get new essays sent to you</h3>\n    </label>\n    <p id=\"mce-email-describe\">\n      Subscribe to my new work on programming, security, and a few other\n      topics. Published a few times a month.\n    </p>\n\n    <input type=\"email\" value=\"\" name=\"EMAIL\" class=\"required email\" id=\"mce-EMAIL\" placeholder=\"Your email address\" style=\"width:200px;font-size: 1.1em; padding-left:4px; line-height:1.7em\">\n    <input type=\"submit\" value=\"Subscribe\" name=\"subscribe\" id=\"mc-embedded-subscribe\" class=\"button as-link green\" style=\"position:relative; top: -1px; border-radius: 3px;\n    border: 1px solid #97d69c;\n    cursor: pointer;\n    height: 37px;background-color: #3eb542;\n    color: white;\n    font-size:1.1em\">\n\n    <div id=\"mce-responses\" class=\"clear\" style=\"margin-top:15px\">\n      <div class=\"response\" id=\"mce-error-response\" style=\"display:none\"></div>\n      <div class=\"response\" id=\"mce-success-response\" style=\"display:none\"></div>\n    </div>  \n    <p><span style=\"color: #f92672;\">NEW:</span> Also subscribe to my new series, <a href=\"https://advancedbeginners.substack.com\">Programming Feedback for Advanced Beginners</a></p>\n\n  </form>\n  <div style=\"clear:both\"></div>\n</section>\n\n        \n  <h3 style=\"font-size: 1.5em;padding-top:30px;\">More on Programming Projects for Advanced Beginners</h3>\n  <ul>\n    \n      \n        \n          \n          <li>\n            <a href=\"/2020/04/19/pfab13-when-code-is-too-clever-to-be-clean/\">PFAB #13: When code is too clever to be clean</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n      \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2020/03/07/pfab11-separating-logic-and-data/\">PFAB #11: Separating logic and data</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2020/02/23/pfab10-first-class-functions-dependency-injection/\">PFAB #10: First-class functions and dependency injection</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2020/02/08/pfab9-batch-vs-stream-processing/\">PFAB #9: Batch vs Stream processing</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2020/01/26/pfab8-input-validation/\">PFAB #8: Input validation - tradeoffs between convenience and surprise</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2020/01/04/pfab7-how-to-write-a-library/\">PFAB#7: How to write a library</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/12/28/pfab6-real-world-debugging-practice/\">PFAB#6: Real-world debugging practice</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/12/21/ppab5-how-to-make-your-programs-shorter/\">PFAB#5: How to make your programs shorter</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/12/14/pfab4-exception-handling-dealing-with-failure/\">PFAB#4: Exception handling and coping with failure</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/12/07/pfab3-analyze-commute/\">PFAB#3: How to rigorously analyze your journey to work</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/11/30/pfab2-how-to-structure-your-programs/\">PFAB#2: How to structure your programs</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/11/11/pfab1/\">PFAB#1: Define your boundaries</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/11/08/programming-feedback-for-advanced-beginners-0/\">Programming Feedback for Advanced Beginners #0</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/11/08/i-will-give-you-feedback-on-your-code/\">I will give you feedback on your code</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/08/12/programming-projects-for-advanced-beginners-user-logins/\">Programming Projects for Advanced Beginners #6: User Logins</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/08/11/real-world-programming-projects-for-advanced-beginners/\">Real-World Programming Projects for Advanced Beginners</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/07/27/programming-videos-for-advanced-beginners-battleships/\">Programming Videos for Advanced Beginners #1: Battleships</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/04/14/open-source-for-advanced-beginners-1-bashplotlib/\">Open Source for Advanced Beginners #1: bashplotlib</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/04/13/open-source-for-advanced-beginners/\">Open Source for Advanced Beginners</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/03/25/what-beginners-mind-is-really-like/\">What beginner's mind is really like</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2018/12/08/programming-projects-for-advanced-beginners/\">Programming Projects for Advanced Beginners</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2018/12/02/programming-project-5-snake/\">Programming Projects for Advanced Beginners #5: Snake</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2018/11/03/programming-project-4-photomosaics/\">Programming Projects for Advanced Beginners #4: Photomosaics</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2018/10/09/programming-projects-for-advanced-beginners-3-b/\">Programming Projects for Advanced Beginners #3b: Tic-Tac-Toe AI</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2018/10/09/programming-projects-for-advanced-beginners-3-a/\">Programming Projects for Advanced Beginners #3a: Tic-Tac-Toe AI</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2018/07/20/project-2-game-of-life/\">Programming Projects for Advanced Beginners #2: Game of Life</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2018/06/12/programming-projects-for-advanced-beginners-ascii-art/\">Programming Projects for Advanced Beginners #1: ASCII art</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n    \n      \n    \n      \n    \n      \n    \n      \n    \n      \n    \n  </ul>\n\n\n        <section class=\"navigation\" style=\"padding-top:13; margin:0\">\n  \n    <div class=\"pull-left\">\n      <a href=\"/2020/03/18/yourself-happier-iphone-worse/\" id=\"next\">\n        <span>◀ How to make yourself happier by making your iPhone worse</span>\n      </a>\n    </div>\n  \n  \n    <div class=\"pull-right\">\n      <a href=\"/2020/04/13/hundreds-of-companies-assert-usage-rights-over-all-ideas/\" id=\"prev\">\n        <span>Hundreds of companies assert usage rights over all ideas sent through their services ▶</span>\n      </a>\n    </div>\n  \n</section>\n\n        <br>\n      </section>\n    </div>\n    <footer>\n  <div class=\"stuff\" style=\"text-align: center; padding:5px;\">\n    <a href=\"/\">Home</a> /\n    <a href=\"/archive\">Archive</a> /\n    <a href=\"/feed.xml\">RSS</a> /\n    <a href=\"https://twitter.com/robjheaton\">Twitter</a> /\n    <a href=\"/office-hours\">Office hours</a> /\n    <a href=\"/tipoffs\">Tipoffs</a> /\n    <a href=\"https://soundcloud.com/rob24242/\">SoundCloud</a> /\n  </div>\n</footer>\n\n  \n\n","text":"Robert Heaton\nSoftware Engineer / One-track lover / Down a two-way lane\nAbout\nArchive\nTwitter\nNEW: Programming Feedback for Advanced Beginners\nSystems design for advanced beginners\n06 Apr 2020\nThis post is part of my Programming for Advanced Beginners series. Subscribe now to receive specific, actionable ways to make your code cleaner, every other week, entirely free.\nYou’ve started yet another company with your good friend, Steve Steveington. It’s an online marketplace where people can buy and sell things and where no one asks too many questions. It’s basically a rip-off of Craigslist, but with Steve’s name instead of Craig’s.\nYou’re going to be responsible for building the entire Steveslist technical platform, including all of its websites, mobile apps, databases, and other infrastructure. You’re excited, but also very nervous. You figure that you can probably cobble together a small website, since you’ve done that a few times before as part of your previous entertaining-if-morally-questionable escapades with the Stevester. But you have no idea how to even start building out all of the other infrastructure and tools that you assume lie behind large, successful online platforms.\nYou are in desperate need of a detailed yet concise overview of how real companies do this. How do they store their data? How do their different applications talk to each other? How do they scale their systems to work for millions of users? How do they keep them secure? How do they make sure nothing goes wrong? What are APIs, webhooks and client libraries, when you really get down to it?\nYou send a quick WhatsApp to your other good friend, Kate Kateberry, to see if she can help. You’ve worked together very effectively in the past, and she has decades of experience creating these types of systems at Silicon Valley’s biggest and most controversial companies.\nShe instantly accepts your job offer. You had actually only been ringing for some rough guidance and a good gossip, but you nonetheless instantly accept her acceptance. No point looking a gift horse in the mouth, even when you don’t have any money to pay her. Kate proposes that her first day be 5 weeks ago in order to help her smooth over some accounting irregularities. She can come into the office sometime next week. You feel encouraged and threatened by her eagerness.\nKate bounces into your offices in the 19th Century Literature section of the San Francisco Public Library. “OK let’s do this!” she shouts quietly. “What have we got so far? How are all our systems set up? What’s the plan?” You lean back in your chair and close your laptop, which was not turned on because you have left your charger at home. You steeple your fingers in a manner that you hope can be described as “thoughtful”.\n“Let me flip that question around, Kate. What do you think the plan should be?”\nKate takes a deep breath and paints an extremely detailed vision of the Steveslist platform five years into the future and the infrastructure that will power it.\nBefore we start (says Kate), I want to make it clear that I’m not saying that any of this is necessarily the “right” way to set up our infrastructure. If someone you trust more than me says something different then you should probably do what they say. There are many tools out there, each with different strengths and weaknesses, and many ways to build a technology company. The real, honest reasons that we will make many of our technological choices will be “we chose X because Sara knows a lot about X” and “we chose Y on the spur of the moment when it didn’t seem like a big decision and we never found the time to re-evaluate.”\nNonetheless, let’s fast-forward five years into the future. Now Steveslist has two main consumer-facing products:\nThe Steveslist web app\nThe Steveslist smartphone apps\nThese are the main ways in which users directly interact with the Steveslist platform. In addition, we also provide an API that allows programmers to build power-tools on top of the Steveslist platform that, for example, create listings for hundreds of items programmatically. To support this, we offer:\nA Steveslist API\nSteveslist API client libraries that make it easy for programmers to write code that talks to our API\nHere, I’ll draw a diagram on the whiteboard:\n<code>+-----------+ +--------------+ +-----------------+\n|Web Browser| |Smartphone App| |Client Libraries/|\n+-----+-----+ +------+-------+ |Other API code | | | +-------+---------+ | v | | +-----+------+ | +---------&gt;+ Steveslist +&lt;-----------+ | Servers | +------------+\n</code>\nFinally, we have many, many services running in the background that provide the data and power to these external-facing applications:\nWebhooks - to notify users when something happens to their account, such as “order placed”\nUser password authentication - to securely log users in\nSQL database - the main Steveslist data store. Needs to be highly scalable and reliable\nFree-text searching system - to power the search box where people can look for broad search terms like “TVs” or “motorbikes”\nInternal tools - to help us administer the Steveslist platform, and to take actions like issuing sternly-worded warnings to malicious users\nCron jobs - to run regular tasks that do anything from generating invoices, to billing customers, to sending as much of our users’ data as possible to third-party ad networks\n“Pubsub” system - to allow us to take asynchronous actions on different trigger events (such as “when a new user signs up, send them a welcome email”)\nBig data analytics system - to allow us to run enormous queries over the entirety of Steveslist’s data\nAnd many more that we’ll talk about another day\nLet’s go through each of these systems in turn. Let me know if anything isn’t clear, if you have any questions, or if you think I’ve got something wrong.\nBefore we start - what is a server really?\nBefore we start, let’s define some important terms. In fact, let’s just define one. We’re going to talk a lot about “servers” today. But what is a server, when you really get down to it?\nFor our purposes, a server is a computer that runs on a network and listens for communications from other computers. When it receives some data from another computer it performs some sort of action in response and - usually - sends back some data of its own. For example, a web server listens on a network for HTTP requests and sends back webpages and information in response. A database server listens for database queries and reads and writes data to the database that it is running.\nThis brief description skips out entire degrees and careers of detail, and there are of course far more precise and accurate ways to define the word “server”. But this should get us through until dinnertime. What did you say? What’s a “network” really? A good question for another day.\nNow we’re ready to talk about the Steveslist platform.\nSteveslist web app\nThis is the main Steveslist product. It’s just a normal web app, very similar to any website that you’ve built before, except much bigger. It’s a modern “single-page app” (SPA). The “single” in “single-page app” refers to the fact that the user’s browser almost never has to fully reload the page as the user clicks around our site. Instead, when the browser makes its first HTTP request to our servers, we send it back a basic, skeleton HTML page and a big pile of JavaScript code. This JavaScript code executes inside the browser, and updates the view of the page in response to the user’s actions. When the JavaScript wants to send or retrieve data from Steveslist, it sends an Asynchronous JavaScript XML Request (almost always called AJAX for short) in the background to a URL. When our server responds, the JavaScript uses the response to update the browser view accordingly.\n<code>+----------+1.User's browser visits steveslist.com. +----------+\n| | It sends an HTTP request to the | |\n| | Steveslist servers | |\n| +---------------------------------------&gt;| |\n|User's Web| |Steveslist|\n| Browser |2.Steveslist server responds with a | Servers |\n| | skeleton HTML page that instructs the | |\n| | browser to request additional | |\n| | JavaScript files. | |\n| |&lt;---------------------------------------+ |\n| | | |\n| |3.User's browser requests and receives | |\n| | these JavaScript files from the | |\n| | Steveslist server. | |\n| +---------------------------------------&gt;| |\n| |&lt;---------------------------------------+ |\n| | | |\n| |4.User's browser executes the JavaScript| |\n| | code. The code sends more requests for| |\n| | the user's data to the Stevelist | |\n| | server, and updates the browser UI to | |\n| | display it. | |\n| +---------------------------------------&gt;| |\n| |&lt;---------------------------------------+ |\n+----------+ +----------+\n</code>\nrobertheaton.com is not a single-page app. Whenever you click on a link, the browser has to reload the entire page. twitter.com is a single-page app. Whenever you click on a link, the browser dynamically updates a small portion of tthe page without forcing a full refresh.\nSPAs are a lot of work to build and maintain, but they sure look good.\nSteveslist smartphone apps\nWe provide Steveslist smartphone apps for both iOS and Android. They are conceptually very similar to our single-page web app. Both our smartphone and web apps make HTTP requests to our servers. Then our servers receive these requests, do some work and return an HTTP response. Finally, both our smartphone and web apps update their display in order to communicate with the user.\nSince our smartphone apps are performing the same operations as the web app (for example, create listing, send message, etc), they can usually even send their requests to the exact same URLs as the web app. The only extra work that we have to do is to develop the frontends of the apps themselves. Some frameworks even make it possible to write mobile apps using JavaScript, allowing you to reuse code and logic across platforms.\nSteveslist API\nWe allow users and third-parties to write code that programmatically interacts with our platform. In the same way that people can use the Twitter API to write code that reads; likes; and creates Tweets, we allow them to use the Steveslist API to search; buy; and list items.\nProgrammers use our API by writing code that makes HTTP requests to our API endpoints. For example, in order to retrieve a list of all their listings, the programmer sends an HTTP GET request to api.steveslist.com/v1/listings. We respond with the data they requested, formatted as JSON. JSON stands for JavaScript Object Notation, but JSON is not specific to JavaScript and can easily be interpreted by any programming language. A JSON response to a request to retrieve all of a user’s listings might look something like this:\n<code><span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">listings</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"p\">[</span> <span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">id</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">2178123867</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">name</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">Stolen TV</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">country</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">US</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">city</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">San Francisco</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_amount</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">1000</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_currency</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">usd</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"err\">#</span> <span class=\"nx\">etc</span><span class=\"p\">...</span> <span class=\"p\">},</span> <span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">id</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">182312679</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">name</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">Stolen Bicycle</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">country</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">US</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">city</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">San Francisco</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_amount</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">2000</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_currency</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">usd</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"err\">#</span> <span class=\"nx\">etc</span><span class=\"p\">...</span> <span class=\"p\">}</span> <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code>\nThis structured response format is very easy for a program to parse, which means that the code that made the request can trivially interpret and use the data from our API.\nUsers identify or authenticate themselves to our API using an API key. This is, roughly speaking, the API equivalent of a password. It is a long, random string that we generate and display on a user’s “Settings” page. Users include their API key as an HTTP header with every HTTP request that they (or their code) makes to the API. When we receive an API request we check to see whether the attached API key corresponds to a Steveslist user. If it does then we perform the request on behalf of that user.\nIf a programmer wants to, they can manually build HTTP requests to our API themselves, using their language’s standard HTTP library. For example, in Python they might write:\n<code><span class=\"kn\">import</span> <span class=\"nn\">requests</span> <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"s\">'https://api.steveslist.com/v1/listings/'</span>\n<span class=\"n\">listing_params</span> <span class=\"o\">=</span> <span class=\"p\">{</span> <span class=\"s\">\"name\"</span><span class=\"p\">:</span> <span class=\"s\">\"Stolen TV\"</span><span class=\"p\">,</span> <span class=\"s\">\"country\"</span><span class=\"p\">:</span> <span class=\"s\">\"US\"</span><span class=\"p\">,</span> <span class=\"s\">\"city\"</span><span class=\"p\">:</span> <span class=\"s\">\"San Francisco\"</span><span class=\"p\">,</span> <span class=\"s\">\"price_amount\"</span><span class=\"p\">:</span> <span class=\"mi\">1000</span><span class=\"p\">,</span> <span class=\"s\">\"price_currency\"</span><span class=\"p\">:</span> <span class=\"s\">\"usd\"</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n<span class=\"n\">api_key</span> <span class=\"o\">=</span> <span class=\"s\">\"YOUR_API_KEY_GOES_HERE\"</span> <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">post</span><span class=\"p\">(</span> <span class=\"n\">url</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">=</span><span class=\"n\">listing_params</span><span class=\"p\">,</span> <span class=\"n\">headers</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s\">\"X-Steveslist-API-Key\"</span><span class=\"p\">:</span> <span class=\"n\">api_key</span><span class=\"p\">},</span>\n<span class=\"p\">)</span>\n</code>\nHowever, we make life easier for programmers by providing client libraries.\nSteveslist client libraries\nA client library is a library that “wraps” the functionality of the Steveslist API. This means that anyone using the client library doesn’t need to know anything about the fine details of the Steveslist API. Instead, they can just write:\n<code><span class=\"kn\">import</span> <span class=\"nn\">steveslist</span> <span class=\"n\">listing</span> <span class=\"o\">=</span> <span class=\"n\">steveslist</span><span class=\"o\">.</span><span class=\"n\">Listing</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s\">\"Stolen TV\"</span><span class=\"p\">,</span> <span class=\"n\">country</span><span class=\"o\">=</span><span class=\"s\">\"US\"</span><span class=\"p\">,</span> <span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s\">\"San Francisco\"</span><span class=\"p\">,</span> <span class=\"n\">price_amount</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"p\">,</span> <span class=\"n\">price_currency</span><span class=\"o\">=</span><span class=\"s\">\"usd\"</span><span class=\"p\">,</span> <span class=\"n\">api_key</span><span class=\"o\">=</span><span class=\"s\">\"YOUR_API_KEY_GOES_HERE\"</span>\n<span class=\"p\">)</span>\n</code>\nOur libraries turn the parameters that they are given into appropriately formatted HTTP requests, which they send to the Steveslist API as normal. We’ve written client libraries for every major programming language that we could think of, and they are by far the most common way that people interact with our API.\nWebhooks\nWe’ve seen how Steveslist users can use our API to programmatically interact with their account. In addition, many users also want us to proactively tell them whenever something happens to their Steveslist profile. For example, suppose that someone wanted to fully automate the process of selling items on Steveslist. Whenever a customer pays for an item using our new, mostly-secure StevePay system, they want to send the customer a thank you email and automatically instruct their warehouse to ship a stolen TV to the order address. Our seller could constantly and repeatedly query the Steveslist API asking “Any new sales? Any new sales?” However, this would be very inefficient, and would put a lot of unnecessary load on our servers.\nInstead, we provide an industry standard system called webhooks. A webhook is an HTTP request that we send to our users whenever something interesting happens to their account. It contains all the data describing the event that just happened - for example, the item ID, the price, the buyer ID, buyer address, and so on. Webhooks allow users to automatically perform response actions, such as the aforementioned email and auto-shipping.\nTo use webhooks, the user tells us the URL to which they would like us to send their webhooks (for example, steveslistwebhooks.robertheaton.com. They set up a web server at that URL that will receive and action these webhook notifications.\n<code>1.Buyer purchases an 3.The seller's server receives the webhook, item as normal. and uses the information in it to automatically process the order.\n+---------------+ +-----------------+\n|Buyer's Browser| |Seller's Webhook-+\n+------+--------+ |Receiving Server | | +------+----------+ | ^ | | | | | +-----------+ | +---&gt;+ Steveslist+----------+ | Server | +-----------+ 2.Once the transaction has been completed, Steveslist looks up the seller's webhook URL (if set). We then send an HTTP request to this URL, containing the details of the purchase.\n</code>\nThe user deploys code on their web server that performs the appropriate response actions whenever it receives a webhook from us. We don’t only send webhooks when an item is purchased - we also send them when a user receives a message; when one of their items is removed by an admin; or when a buyer makes a complaint. This enables Steveslist sellers to automate not just the listing of items, but also the selling and shipping of them too.\nWebhook complications\nWebhooks come with two main complications - security and reliability. First, let’s talk security. The endpoint to which the seller instructs us to send their webhooks is accessible to anyone on the internet. Anyone who knows the URL can send it fake webhooks, and if our seller isn’t careful this could allow an attacker to trick them into, for example, sending the attacker free stuff. A seller’s webhook URL should be difficult to find, since the seller won’t publicize its existence, but obscurity is not the same as security.\nTo allow our sellers to verify that a webhook really was sent by Steveslist, we cryptographically sign our webhook contents.\nCryptographic signing\nCryptographic signing is a deep and subtle topic. Here’s a condensed version of how we use it to secure our webhooks.\nWhen a seller enables webhooks for their account, we generate a random “shared secret key”. We tell the seller to copy this key over to their webhook-receiving server and keep it secure, so that its value is known only by us and the seller. Whenever we send a webhook, we take this shared secret, combine it with the contents of the webhook by using a cryptographic hash function called HMAC, and get back a long, random-seeming, but entirely deterministic “signature” for the webhook.\n<code>Webhook contents +----------+\n(eg. {\"id\": 123...}) | v +---+----------+ |HMAC Algorithm|-----&gt;Webhook signature +---+----------+ ^\nShared secret key |\n(eg. 123mhu23jy8xdwgmd...)+---+\n</code>\nWe include this signature in our webhook body, for example:\n<code><span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">action</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">item_sold</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">100</span><span class=\"p\">,</span> <span class=\"c1\">// ...more params...</span> <span class=\"dl\">\"</span><span class=\"s2\">signature</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">234gj98d49j834978gf39t78ndn98g7dq3ng897308y7</span><span class=\"dl\">\"</span>\n<span class=\"p\">}</span>\n</code>\nWhen the seller’s webhook-receiving server receives a webhook, it takes the shared secret and webhook contents and calculates what it expects the signature to be in exactly the same way that we did. It compares the result to the signature attached to the webhook; if they match then it accepts and processes the webhook. Since the signature can only be generated using the shared secret known only by us and the seller, the webhook-receiving server can be confident that the webhook was sent by us. If the signatures don’t match, however, the server rejects the webhook.\nNote that all of the signature verification code must be written and maintained by the sellers. We can provide them with encouragement and examples, but we can’t force them to verify signatures correctly, or even at all. For some real-world examples, look at how Stripe and GitHub sign their webhooks.\nReliability\nWe also need to consider what happens when our webhooks go wrong and what guarantees we want to make to our users about them. If we try to send a webhook but can’t connect to the user’s server, what should we do? What if we successfully connect to their server and send the webhook, but their server sends back an error? What if we send the webhook but the server hangs for twenty seconds before disconnecting without telling us what happened?\nThere are tradeoffs involved here that require clear communication and a surprising amount of infrastructure to manage. We at Steveslist choose to guarantee that we will deliver webhooks “at least once”. This means that if a webhook fails to send then we will keep trying (a large but not infinite number of times) until it does. If we’re not sure whether a webhook succeeded or failed, we will keep trying until we are sure that an attempt has succeeded. This might occasionally result in us sending the same webhook twice, but it’s the seller’s responsibility to have their code handle this gracefully instead of sending the same customer five stolen TVs instead of the one that they ordered.\n“What do you think so far?” asks Kate. “Is this roughly what you’ve been thinking?” You make a non-committal face and take a big bite of a nearby sandwich in order to preclude any further discussion. Kate continues:\nLet’s talk about the backend systems that will power some of our most important features.\nUser authentication via a password\nMost users sign into the Steveslist website and smartphone apps using a username and password. There are other ways of signing into the website, like OAuth - we’ll cover them another time.\nWe will have to store our users’ passwords very securely. Not only is a user’s password the thing they use to sign in (or authenticate) to Stevelist, but for many users they’re probably the same password that they use to sign in to many other services too, despite all the warnings that this is a bad idea. They only have so many children with so many birthdays, after all.\nRupert Herpton has written the seminal tutorial on how to secure passwords, which I’m sure you’ve read already. Just in case you need a refresher, the crux of the matter is that we mustn’t ever store passwords in their original, plaintext form, anywhere. We mustn’t store them in plaintext in a database, in a log file, or in any other part of our system. Instead, before storing a password, we must first hash it using a hash function such as bcrypt.\nA hash function is a “one-way” function that takes an input and deterministically converts it into a new, seemingly-random string. Calculating a hash value from an input is computationally very easy, but reversing the transformation and recovering the original input from its hash value takes so much time and computing power that it is, practically-speaking, impossible.\n<code>+---------+ Easy +----------+\n| |------------&gt;| |\n|Plaintext| |Hash value|\n| |&lt;------------| |\n+---------+ Essentially +----------+ Impossible\n</code>\nSince we only store the hash values of our users’ passwords, if a hacker somehow stole our password database (heaven forbid) (touch wood) then they would only be able to see the passwords’ hash values. They wouldn’t be able to easily turn these hash values back into plaintext passwords, meaning that they wouldn’t be able to use them to login to Steveslist, and they won’t be able to take advantage of all the people who re-use passwords across different services.\nSince we only store password hash values, when we want to check whether a login password that a user has given us is correct we first calculate its hash value, and compare the result to the hash value in our password database.\n<code> +--------------+ |User's Browser| +-----------+--+\n1.User attempts to | ^\nlog in: | | 3. Server logs the user in | | if password matches, and username: steve | | returns an error if it does not. password: 12345 v | +--+--------+--+ | Steveslist | | Server | +--------------+ |\n2.Server computes | |username|password_hash|\nthe hash of the | +----------------------+\npassword and compares +----&gt;+steve |23jy7213y7jO |\nit to the value in the |kate |21897213hh21 |\ndatabase. |... |... |\n</code>\nAs previously mentioned, we also have to be careful not to log passwords in any of our debug output. This can be an easy mistake to make - if you log all of the parameters of every HTTP request, just in case you need it, you will certainly be logging user passwords. Facebook logged passwords in plaintext for many years, and whilst it didn’t seem to affect their stock price I’m sure it made them feel pretty silly for a day or two.\nKate pauses for breath. You pretend to take notes on your out-of-battery laptop.\nLet’s talk about infrastructure.\nDatabase servers\nSteveslist’s primary data store runs a common flavor of SQL database called MySQL. I won’t talk much about SQL here - the specifics of how it works aren’t too important, and you can find them on Google if you’re interested. Since we are so successful, we have a huge and growing amount of data to manage. We’ve started to become acutely aware that databases aren’t magic. They run on computers, just like any other program. As the volume of data in a database grows, the computer’s hard drive and memory starts to fill up. At the start of the company the easiest way to deal with this problem was to run our database on a single computer (or machine) with an enormous hard drive. But this could only stave off the problem for so long. Eventually our database contained more data than could be stored on any reasonable hard drive, and the database started to get slower and slower as we forced it to search through more and more records.\nWe had to take an entirely new approach, and reconfigure our database to store its data on multiple computers. We did this using sharding.\nSharding\nSharding a database means splitting its data into chunks (or “shards”) and storing each chunk on a separate machine. All of the machines that make up a database are together known as a database cluster. How you split data between machine in your cluster depends on your application and the types of operations you will be performing. For Steveslist we chose to split out our data by user. This means that all of the data for a given user is stored on the same machine. This includes their profile information, their listings, their messages, and so on. Data that doesn’t have a corresponding user (like “Deals of the Day”) can be sharded using a shard key other than user, or not sharded at all if the dataset is sufficiently small.\nThis means that we need an extra “routing” layer in front of our database, which knows which database machine is able to service which queries. We could either make our application servers (the servers that execute our code) responsible for knowing the mapping of user IDs to database shards, or have a centralized “router” that all servers send their requests to, and which is responsible for working out the appropriate machine to forward the request on to. Both approaches have their advantages. Making application servers responsible for maintaining the mapping reduces the number of hops that a request has to make, speeding them up. But having a centralized router makes updating the shard mapping much easier, since you only have to update it in one place.\nIf application servers are responsible for knowing the shard layout, we have a system that looks like this:\n<code> + + + | | | | Requests from users | | | | v v v +------+----------+--------------------+ | Application | | Server | | | |Database sharding config: | |* DB Server 1: IDs between 1-10000 | |* DB Server 2: IDs between 10000-20000| |* DB Server 3: IDs between 20000-30000| +-+----------------+-----------------+-+ | | | |ID:501 |ID:15362 |ID:22361 | | | v v v\n+-----------+ +-----------+ +-----------+\n|DB Server 1| |DB Server 2| |DB Server 3|\n+-----------+ +-----------+ +-----------+\n</code>\nIf we have a centralized database router, we have a system that looks like this:\n<code> + + + | | | | Requests from users | | | | v v v +------+----------+--------------------+ | Application | | Server | | | |Database sharding config: | |* ??? Application Server has no idea | +------------+-----------+-------------+ | | Application server sends all database queries to the database router, which forwards them to the correct shard. | | v v +--------------+-----------+-------------+ | Database router | | | |Database sharding config: | |* DB Server 1: IDs between 1-10000 | |* DB Server 2: IDs between 10000-20000 | |* DB Server 3: IDs between 20000-30000 | +---+----------------+---------------+---+ | | | |ID:501 |ID:15362 |ID:22361 | | | v v v\n+-----------+ +-----------+ +-----------+\n|DB Server 1| |DB Server 2| |DB Server 3|\n+-----------+ +-----------+ +-----------+\n</code>\nHow do we decide which database to assign each user to? However we want. We could start by saying that users with odd-numbered IDs are assigned to shard machine 1, and those with even-numbered ones are assigned to shard machine 2. We could hope that this random assignment results in balancing our data relatively evenly between our shards.\nHowever, it’s possible that we might have a small number of power users who create much, much more data than others. Maybe they create so much data that we want to allocate them a shard of their own. This is completely fine - we have complete control over how users are assigned to shards. Random assignments are usually easiest, but are by no means the only option. We can choose to assign users to shards randomly - except for user 367823, who is assigned to shard 15, which no other user is assigned to.\nIf a shard gets too big and starts to fill up its machine’s hard-drive, we can split it up into multiple, smaller shards. How do we migrate the data to these new shards without having to turn off our platform for a while? Probably using a sequential process like:\n“Double-write” new data to both the old and new shards. Continue reading data from the old shard\nCopy over all existing data from the old shard to the new shard. Continue double-writing to old and new shards\nConvince ourselves that the old and new shards contain the same data. We could do this by comparing snapshots of the databases, and/or by reading every query from both databases, comparing them, and alerting if the data is different\nOnce we’re confident that the new and old shards contain the same data, we switch to reading from the new shards. We continue double-writing in case we need to switch back\nOnce we’re confident that this step has been successful, stop double-writing and delete the old shard\nRupert Herpton has written a great article about a broadly-similar type of migration that goes into much more detail. In short, the process of migrating data between database shards is detailed and finicky, but also entirely doable and logical. Some types of database can even automatically take care of sharding for you.\nReplication\nWe will take great care to make sure that our data doesn’t get accidentally deleted and our database servers don’t randomly stop working. But accidents happen, and sometimes computers do randomly stop working. To mitigate the fallout of a database-related disaster, we replicate our data across multiple machines in (close to) realtime.\n<code> Client writes new data to DB Server A | v +-----+-----+ |DB Server A| ++---------++ | | DB Server A quickly replicates v v the new data to DB Servers B and C\n+----------++ +-+---------+\n|DB Server B| |DB Server C|\n+-----------+ +-----------+\n</code>\nRealtime replication has two main benefits. First, it means that if one of our database servers explodes, catches fire, or otherwise stops working, we have multiple almost-perfect copies of it that can seamlessly pick up the slack. In a straightforward, vanilla failure, users of our services may never know that anything has gone wrong. The second benefit of replication is that we can distribute queries for the same data across multiple database servers. If lots of users are asking to read data from the same database, we can split their queries up across all of our copies, meaning that we can handle more queries in parallel.\n<code> Clients can query the same data from any of DB Servers A,B,or C | | | | | | | | | v v v | | | | +-+---+---+-+ | | | | |DB Server A| | | | | +-----------+ | | | | | | v v v v\n+---+-------+ +-----+-+---+\n|DB Server B| |DB Server C|\n+-----------+ +-----------+\n</code>\nNote that database replication is not the same concept as making database backups. Replication happens in (close to) realtime, and is designed to deal on-the-fly with isolated problems in your live (or production) systems. Database backups are performed on a schedule (for example, once a day), and the copies of the data are stored separately, away from production systems. Backups are designed as a final safeguard against widespread, catastrophic data loss, as might happen if all your data centers burned down.\nPretend that you work in the call centre of a big bank, where people are constantly calling you up in order to send money transfers and ask about their current balance. Replication is the equivalent of hurriedly writing down transfer details into multiple books, as you receive them, just in case you lose one of the books. Making backups is the equivalent of photocopying those books once a day and storing the copies in your filing cabinet.\nReplication\nThe process of replication is conceptually quite straightforward. Whenever new data is written to our database, we copy it to multiple machines. This means that if/when a machine fails we can continue querying its siblings, with no user-facing impact. It also means that we can spread our queries out across multiple copies of the same data, resulting in faster query response times.\nHowever, the details of how we do this are important, subtle, and situation-dependent. There’s no right way to do replication - as is so often the case, the exact approach that you take depends on the specific requirements and constraints of your system.\nReplication is complicated by two inconvenient facts about the real world. First, database operations randomly fail sometimes. When we attempt to replicate our data from one server to another, things will occasionally go wrong, causing our machines to become out of sync, at least for a period. Second, even in periods of smooth operation, replication is not instantaneous. When new data is written to our database cluster, some servers in the cluster will always know about the update sooner than others. When choosing a replication strategy we must be aware of these limitations and how they impact our particular application. For example, maybe it’s OK to risk the number of “likes” on a post being slightly out of sync and out of date, but not the amount of money in a user’s bank account.\nOne of the biggest decisions we must make when choosing a replication strategy is whether we want our replication to be synchronous or asynchronous.\nAsynchronous vs synchronous replication\nReplication can be handled either synchronously or asynchronously. These words come up in a lot of different places in systems design, but they always fundamentally mean the same thing. If an action is performed “synchronously” then this means that it is performed while something waits for it. If you wanted to send a letter synchronously then you would got to the Post Office, give your letter to a postal worker, sit and wait in the corner of the Post Office for a few days, and only go home when the postal worker confirmed that your letter had arrived safely.\nBy contrast, if an action is performed “asynchronously” then this means that the initiator of the action doesn’t wait around for it to be finished. Instead, they just continue with the rest of their work while the action is worked on in the background. The real Postal Service is asynchronous; you give your letter to a postal worker, then leave and continue with your life while the Postal Service delivers your letter. Asynchronous actions can send back notifications of the outcome of the action if they want (“Your letter has arrived and was signed for” or “Mr. Heaton, your dry-cleaning is ready”), but they don’t have to.\nHow do these principles apply to database replication? In synchronous replication a client writes its new data to a database server and then waits. This server doesn’t tell the client whether their write has been completed successfully until it has finished fully replicating the client’s data across all of its sibling servers. Then, and only then, does the client continue executing the rest of its code.\nIn asynchronous replication the client writes its data to the first database server, as before. But this time the first server tells the client that the write was successful as soon as it has written the data to its own data store. It kicks off the replication process in the background, and doesn’t wait for it to complete, or even start, before it tells the client that the write was successful. This means that the asynchronous operation appears much faster than the synchronous one, because the client doesn’t have to wait for all the replication to complete before it can continue on with the rest of its work. However, if the background replication fails then the client will believe that it has successfully written its data to the database when it actually has not. This could cause problems, the imagination of which is left as an exercise for the reader.\nThe synchronous approach is slower but “safer” than an asynchronous approach. The database never claims to have successfully received and stored any data until it has finished every single step of doing so. Because the client waits for full confirmation before proceeding, it is guaranteed to never encounter a situation where the client believes that it has written some data to the database, but the database has secretly partially dropped the data on the floor.\nWhich approach is better? It depends. Do you care more about speed or correctness? Is it OK to occasionally have inconsistent data if it significantly speeds up the system’s operation? Or will even a single mistake cause airplanes to start falling out of the sky?\nDatabase replication systems face other interesting problems too. Many of these problems are “logical” rather than “technical”, and don’t require a detailed understanding of the complex software and networking protocols underlying the system. To help picture some of them, imagine that you’re back in the call centre from a few paragraphs ago. You work with many other colleagues. Together you play the role of database servers. People call you up to transfer money and ask about their current balance. You and your colleagues write information about new transfers down on paper, and replicate it between yourselves by calling each other up.\nThe problems faced by our database cluster are identical to those faced by our call-centre. What happens if two people call in and try to update the same piece of data at the same time by talking to two different employees? Maybe we solve that by having a “leader” employee who is the only one authorized to serve calls from people trying to create transfers. All the other employees are only allowed to answer queries about current balances. OK, so what happens if the leader has a stroke and dies after they’ve received some new data, but before they’ve told everyone else about it? What if a “follower” employee has a temporary seizure for a few seconds and misses some data updates from the leader? What if we’re never entirely sure which of our employees are dead or alive?\nThis is not an approximate metaphor that breaks down if you look too hard or start asking awkward questions. Understand this weird call-centre and you understand database replication. Read this blog post and you really understand replication.\nBackups\nIn addition to realtime replication, we also store regular backups of our entire database in order to protect against catastrophic disaster. We copy all of the data in our database, store it somewhere safe, and mark it as something like “database backup, 2020-05-11:01:00”.\n<code>+----------+ | Database +----------------&gt; database backup, 2020-05-11:01:00\n+----------+ database backup, 2020-05-10:01:00 database backup, 2020-05-09:01:00\n</code>\nIf our entire database - or some fraction of it - somehow gets wiped out, we grab the most recent backup available and load it into new database machines.\n<code>+----------+\n| New |\n| Database +&lt;---------------- database backup, 2020-05-11:01:00\n+----------+ database backup, 2020-05-10:01:00 database backup, 2020-05-09:01:00\n</code>\nSuch a calamity could be caused by a cyberattack, a disaster in our data centre, a database migration gone horribly wrong, or any number of unlikely but potentially company-destroying reasons. Unlike realtime replication, restoring a database from a backup is a slow process that our users will definitely notice. Our entire system will likely be offline until the restoration is complete. We will have lost all database updates that occurred after the last backup but before the disaster. And there will no doubt be a large number of knock-on effects as users and systems try to access data that used to be there but is now lost forever. Nonetheless, these are all much less terrible than the complete, irrevocable loss of all our company’s data and with it, our company.\nThat’s a whole lot of detail about our primary SQL database. Let’s talk about some other ways in which we store and query data.\nFree-text searching\nA standard SQL database is very good at answering well-defined and specific queries. For example:\nGive me all the item listings created by user #145122 in the last 90 days\nGive me the listing details for item #237326921\nGive me the count of new listings per day created in San Francisco with the label “Electronics”\nYou can retrieve this kind of data using SQL queries that look something like this:\n<code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">user_id</span> <span class=\"o\">=</span> <span class=\"mi\">145122</span> <span class=\"k\">AND</span> <span class=\"n\">created</span> <span class=\"o\">&gt;</span> <span class=\"n\">currentDate</span><span class=\"p\">()</span> <span class=\"o\">-</span> <span class=\"mi\">90</span>\n</code>\nor\n<code><span class=\"k\">SELECT</span> <span class=\"n\">DATE_TRUNC</span><span class=\"p\">(</span><span class=\"s1\">'day'</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">created</span><span class=\"p\">)</span> <span class=\"k\">AS</span> <span class=\"k\">day</span><span class=\"p\">,</span> <span class=\"k\">COUNT</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span> <span class=\"k\">AS</span> <span class=\"n\">i</span>\n<span class=\"k\">INNER</span> <span class=\"k\">JOIN</span> <span class=\"n\">labels</span> <span class=\"k\">as</span> <span class=\"n\">l</span> <span class=\"k\">ON</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">id</span> <span class=\"o\">=</span> <span class=\"n\">l</span><span class=\"p\">.</span><span class=\"n\">item_id</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">city</span> <span class=\"o\">=</span> <span class=\"s1\">'San Francisco'</span> <span class=\"k\">AND</span> <span class=\"n\">l</span><span class=\"p\">.</span><span class=\"nb\">text</span> <span class=\"o\">=</span> <span class=\"s1\">'electronics'</span>\n<span class=\"k\">GROUP</span> <span class=\"k\">BY</span> <span class=\"mi\">1</span>\n<span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"mi\">1</span> <span class=\"k\">DESC</span>\n</code>\nYou’ll notice that these queries contain a lot of very “precise” operators, like equals- and greater-than-signs. But how would you write a SQL query that could return a list of items that match a Google-style “full-text” search, like “second-hand TV”?\nThis would be difficult. You could try the SQL LIKE operator, which allows you to find records containing a pattern, such as a sub-string. For example, the following query finds all items with a description containing the sub-string second-hand TV:\n<code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second-hand TV%'</span>\n</code>\nHowever, this query will only match the very specific sub-string that it was given. It won’t match “TV that is second-hand” or “2nd-hand TV”, or “sceond-hnad TV”. Given enough perseverance you could theoretically construct a giant SQL-query that covered as many of these permutations as you had patience for:\n<code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second%hand%TV'</span> <span class=\"k\">OR</span> <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second%TV%hand'</span> <span class=\"k\">OR</span> <span class=\"c1\">-- …and so on and so on for another bajillion ORs…</span>\n</code>\nHowever, the resulting query would be slow and cumbersome, and would still miss many important edge-cases that you hadn’t thought of. And even if you did get back a useful list of search results, you’d still have a lot of work left to do in order to decide how to order them. The ordering you want isn’t something strict like “most-recent first” or “alphabetically by title”. Instead it’s some much woolier notion of “best” or “most-relevant” first.\nAll of this means that SQL databases are generally not very good at full-text searches. Fortunately, other types of database are, including one called Elasticsearch. Elasticsearch is often described as a document-oriented database. We don’t need to go into the details of how exactly it works, but the important part for us is that, unlike SQL databases, Elasticsearch is very good at taking queries like “second-hand TV” and returning a list, ordered by “relevance,” of the fuzzy matches that users have come to expect from their search engines.\n“Sounds like Elasticsearch is just better than SQL,” you might say. “Should we throw away our SQL databases and put everything in Elasticsearch instead?” Not so fast. Elasticsearch, and other databases like it, have their strengths, but they also have their weaknesses. They’re typically somewhat less reliable than SQL databases, and are somewhat more likely to accidentally lose data at large scale. They’re also often much slower to write new data to.\nAs we’ve already noted, there’s rarely a single, universally “best” tool for any type of job. There’s certainly no such thing as “the best” database. Instead, different databases have different strengths and weaknesses, and different solutions are appropriate for different tasks. At Steveslist, we care so much about making sure that we use the right tool for the right job that we store our data in both a SQL database and a document-oriented database like Elasticsearch.\nWe use our SQL database as our primary data store. It is our authoritative “source-of-truth”, and we write all our new data to it before we write it anywhere else. We do all our simple, precise reads from it, especially when accuracy and up-to-date-ness are our principal requirements. If we want to show a user a list of all their open listings, we read it from our SQL database. If we want to validate a users password, we read that from our SQL database too. This plays to the strengths of SQL databases.\nHowever, in the background we also copy data from our SQL database into an Elasticsearch database, and send any full-text search queries made via our search box to Elasticsearch. This means that we benefit from the strengths of Elasticsearch, and are not impacted too much by its weaknesses. We copy over batches of records every few minutes, hours, or days, depending on the requirements of the specific dataset. Alternatively, we could watch the logs of our SQL database for new or updated records, and create or update the corresponding Elasticsearch records in near-realtime.\n<code> | | |\nNew data is always | |Queries for |Full-text search written to the SQL | |specific data go |queries go to\nDB first | |to the SQL DB too |Elasticsearch V V V +--------------+ +---------------+ | SQL Database +------&gt;+ Elasticsearch | +--------------+ +---------------+ New data is copied over from the SQL DB to Elasticsearch\n</code>\nWhen scouting Steveslist’s competition, I noticed that when you create a new Craigslist listing it says “your listing will be visible in search within the next 15 minutes”. I’ll bet pesos to pizza that this is because their primary datastore is a SQL database, but their search box is powered by an Elasticsearch-like engine. Their pipeline for replicating data from SQL to search probably takes around 15 minutes, which they’ve decided (very reasonably) is an acceptable delay for their particular use-case.\nWe’ve said that Elasticsearch is somewhat less reliable than most SQL databases. If Elasticsearch accidentally loses a few of our records then they won’t appear in search results. This would be a shame that would make our product a bit worse, and we try our hardest to avoid it happening. However, it wouldn’t be a disaster in the same way that losing data from our primary data store would be. We only copy data over to Elasticsearch once it has been written to and safely captured by our source-of-truth SQL database, which is what really matters.\nIt’s 6pm, and the library is closing. A librarian tries to ask you to leave. Kate shoos him away with a barrage of crumpled-up balls of paper.\nInternal tools\nManaging the Steveslist platform requires bespoke internal tools. We need to perform a wide range of administrative tasks, like deleting listings that are too illegal (even for us), issuing refunds, viewing a user’s personal details in order to help with support requests, and so on. Many of these tools will be used by people who work on other teams at Steveslist, like finance, compliance, legal, sales, and support. Since the tasks they need to perform are so specific to the way that Steveslist works, we can’t do them using third-party tools, and have to build our own instead.\nIn the early days, we baked this functionality into the main Stevelist product and only exposed it to users who had the is_steveslist_employee = True database flag set. This was an OK approach for a small company, but was also fragile and easy to mess up. It was scary to think that we were exposing all of our superuser powers through the same servers that run our main product. It made the potential consequences of a security flaw in our application much worse, and created new types of mistake for us to make, such as forgetting to disable the is_steveslist_employee flag for an acrimoniously fired employee.\nOnce Steveslist reached a certain level of maturity, we built ourselves an entirely separate admin platform, with separate, hardened authentication and authorization. The service runs on entirely separate servers, and requires a VPN and a TLS client certificate to access (which we’ll talk about another day). This separated out our internal- and external-facing products, and drastically reduced the chance of a boneheaded error exposing our admin tools to the world. We’re frequently building new internal tools - one for user administration, one for server management, one for fraud detection, and so on. These services all talk to the same database as our user-facing products, so they all have access to the same data. They just run on different servers that are completely inaccessible to the outside world.\nCron jobs\nThere are lots of tasks that we’ll want our system to perform at fixed times and intervals. For example:\nEmailing ourselves weekly usage reports\nSending marketing emails to users\nCharging the credit cards users who have a subscription plan with us\nCopying data from our SQL database to Elasticsearch\nThe most common tool used for running scheduled jobs is called cron, a tool that is built into Unix operating systems. It’s so common that people will often call any kind of scheduled job a “cron job”, even when it’s not actually being run by cron.\nYou can set up a cron job on your own computer by running:\n<code>crontab -e\n</code>\nThen typing into the prompt:\n<code>*/5 * * * * $YOUR_COMMAND\n</code>\nThis will cause your computer to execute $YOUR_COMMAND every 5 minutes.\nSteveslist currently has a very simple and slightly fragile cron setup. We have a single “scheduled jobs server”. We use crontab on this server (as above) to tell it the commands that we want it to run, and the schedule that we want it to run them on. This setup isn’t scaling very well - if the scheduled jobs server explodes or even hiccups then we don’t always know which jobs it did and didn’t run, and have to scramble to bring up a replacement server. And even though the server is very beefy and powerful, eventually we’re going to want to run more jobs than it can handle at once. We’re considering either splitting up our cron jobs into multiple servers, or setting up a new system using a modern tool like Kubernetes.\nPubsub\nActions have consequences. This is both the subject line of the sinister emails that we send to people who write mean things about us on the internet, and the reason we have a pubsub system.\nWhen a new user signs up, we want to send them an email welcoming them to Steveslist and reminding them about the action-consequence relationship I just described. When a new listing is added for a stolen TV in San Francisco, we want to notify users who have set up search alerts for TVs in the Bay Area. When a card is declined for a subscription, we want to email the responsible user to politely threaten them. When a new listing is added, we want to perform some extremely cursory anti-fraud checks. When an item is purchased, we want to sent a webhook to its seller. And so on.\nTechnically, all of these actions could be performed synchronously (rememberer that word?) by the server executing the initiating action. However, this is often a bad idea, for two reasons. First, the response action (such as emailing all the users who are subscribed for notifications about new stolen TVs) may be very slow. Performing the response action synchronously means that if the initiating action was performed by a user then they will have to wait for all the response actions to finish too. This might not be the end of the world if the response action is small and quick, like sending a single email. But if it’s larger - like searching for and notifying all users who might be interested in a new item - then, well, it still won’t be the end of the world, but it will be a bad user experience.\nTo mitigate this problem we have built a “publish-subscribe” or “pubsub” system. When a trigger action is performed, the code that performs it “publishes an event” describing the action, such as NewListingCreated or SubscriptionCardDeclined. The words “event” and “publish” are quite loosely defined in this context, and don’t have a rigorous technical definition. An event is just some sort of record of something that happened, and to publish an event just means that you somehow make a note that something happened. The details of how you do so depend entirely on the pubsub system in question. In a simple system events might be stored in tables in a SQL database, and code would publish events by writing new records to a table.\nIf a programmer at Steveslist wants a response action to be performed whenever a new event of a particular type is published, they can write a consumer. This is a piece of code that “subscribes” to a type of event, and which is executed whenever a new event of that type is published. It uses the details of the event (for example, the user whose subscription payment failed) to asynchronously execute whatever actions the programmer wants (for example, sending the user a menacing email).\nPubsub systems are often managed by a central message broker. Systems publish events to the broker, and the broker is then responsible for getting the events to any subscribed consumers. This can be achieved using either a push or a pull mechanism. Consumers can pull messages from the broker by polling it and repeatedly asking “any new events? any new events?” or they can wait and listen and the broker can push notifications of new events out to them, for example by sending them an HTTP request.\n<code>1. New user signs|\nup to Steveslist | v +-----------------+ +------------------------+ |Steveslist Server| +--&gt;+SendWelcomeEmailConsumer| +---------+-------+ | +------------------------+ | v\n2. Server reports| +-------------++ 4. Consumers send welcome\na NewUserSignup +----&gt;+Pub/Sub Broker| emails, check for spam,\nevent to the +-------------++ etc.\nPub/Sub system ^ 3. Pub/Sub broker | +------------------------+ notifies consumers +--&gt;+NewUserSpamCheckConsumer| that have subscribed to +------------------------+ NewUserSignup events.\n</code>\nPubsub systems have many benefits:\nNon-critical actions are performed asynchronously, keeping the user experience snappy\nOur code is kept clean and well-separated. The code that publishes an event doesn’t have to care about what the events’ subscribers do in response\nIf a subscriber’s action fails for some reason (for example, the email-sending system has a hiccup), the pubsub system can note this failure and retry again later\nNext, let’s talk big data.\nBig data and analytics\nIn order to understand and optimize our business, we need to be able to calculate complex statistics across the entire Steveslist platform. How many listings are created every day, segmented by country and city? How many users who signed up each month have created a listing within 90 days of signing up?\nTo do this, we need to write database queries that aggregate over the entirety of our data. We don’t want to run these queries against our production SQL database, because they could put an enormous amount of load on it. We don’t want a huge query issued by an internal analyst to be able to bring our production database to a grinding halt, but we do want to provide this analyst with a tool that is well-suited to their needs. To complicate matters further, database engines that are quick at small queries (like returning all the listings belonging to a single user) are typically unacceptably slow (or indeed incapable) of answering giant queries (like calculating the total dollars spent on listings in each category, per day, for the last 90 days).\nDespite this, for the first year or so after Steveslist was founded, we took a risk and simply ran our analytics queries against the main production database. This was a gamble, but it just about worked. We didn’t have much data anyway, and we had more important things to focus on, like attracting the customers who would create the big data that would one day mean that we had to find a more scalable solution.\nEventually we did bring down the production database with an overly-ambitious query, and decided that the time had come to invest in a data warehouse. A data warehouse is a data store that is well-suited to large, system-wide queries. Our warehouse is powered by a database engine called Hive, but we could also have chosen Presto, Impala, Redshift, or any number of competing alternatives. Hive accepts queries written in SQL, but is much better at executing these queries against giant datasets than our MySQL database is.\nWe replicate our data from our production SQL database to Hive, once a day, overnight. Steveslist analysts and programmers can query the same dataset using whichever database engine best suits their needs. They can use the production SQL database for small, precise, source-of-truth queries from production systems; Elasticsearch for full-text search queries; or the data warehouse for huge queries that aggregate over vast volumes of data.\nIt’s dark outside and you’re hungry. Is that pretty much it? you ask.\n“Oh god no,” Kate replies, “we could keep going forever. But this is a pretty good start. It’s helpful to have a broad understanding of a wide range of topics, but no one needs to know the details about everything. I find that once you know some basics you can keep picking up more basics and even a couple of details as you go along.”\nYou ask if Kate could perhaps continue to elaborate on her five-year vision for Steveslist tomorrow.\n“Absolutely,” says Kate. We’ll talk about more of what goes on inside a real, large online platform, including:”\nSecurity\nHTTPS and other forms of encryption\nTwo-factor authentication\nSAML\nSecret key management\nServer management\nDeploying new code\nAWS and competitors\nTerraform\nLoad balancers\nContainers\nAlerting when code breaks\nBig data\nMap-reduce and other big data jobs\nMachine learning\nUser tracking\n“See you tomorrow at 7am?”\nFollow me on Twitter or RSS\nGet new essays sent to you\nSubscribe to my new work on programming, security, and a few other topics. Published a few times a month.\nNEW: Also subscribe to my new series, Programming Feedback for Advanced Beginners\nMore on Programming Projects for Advanced Beginners\nPFAB #13: When code is too clever to be clean\nPFAB #11: Separating logic and data\nPFAB #10: First-class functions and dependency injection\nPFAB #9: Batch vs Stream processing\nPFAB #8: Input validation - tradeoffs between convenience and surprise\nPFAB#7: How to write a library\nPFAB#6: Real-world debugging practice\nPFAB#5: How to make your programs shorter\nPFAB#4: Exception handling and coping with failure\nPFAB#3: How to rigorously analyze your journey to work\nPFAB#2: How to structure your programs\nPFAB#1: Define your boundaries\nProgramming Feedback for Advanced Beginners #0\nI will give you feedback on your code\nProgramming Projects for Advanced Beginners #6: User Logins\nReal-World Programming Projects for Advanced Beginners\nProgramming Videos for Advanced Beginners #1: Battleships\nOpen Source for Advanced Beginners #1: bashplotlib\nOpen Source for Advanced Beginners\nWhat beginner's mind is really like\nProgramming Projects for Advanced Beginners\nProgramming Projects for Advanced Beginners #5: Snake\nProgramming Projects for Advanced Beginners #4: Photomosaics\nProgramming Projects for Advanced Beginners #3b: Tic-Tac-Toe AI\nProgramming Projects for Advanced Beginners #3a: Tic-Tac-Toe AI\nProgramming Projects for Advanced Beginners #2: Game of Life\nProgramming Projects for Advanced Beginners #1: ASCII art\n◀ How to make yourself happier by making your iPhone worse\nHundreds of companies assert usage rights over all ideas sent through their services ▶\nHome / Archive / RSS / Twitter / Office hours / Tipoffs / SoundCloud /","cname":"面向高级初学者的系统设计","ctext":"罗伯特·希顿\n软件工程师/单轨爱好者/双向走\n关于\n封存\n推特\n新：面向高级初学者的编程反馈\n面向高级初学者的系统设计\n2020年4月6日\n这篇文章是我的《高级编程入门》系列的一部分。 立即订阅，即可获得每隔一周免费的特定，可行的方式来使代码更整洁。\n您已经与好朋友史蒂夫·史蒂文顿（Steve Steveington）开了另一家公司。 这是一个在线市场，人们可以买卖东西，没有人问太多问题。 它基本上是Craigslist的翻版，但使用Steve的名字而不是Craig的名字。\n您将负责构建整个Steveslist技术平台，包括其所有网站，移动应用程序，数据库和其他基础结构。 您很兴奋，但也很紧张。 您认为您可能可以将一个小型网站拼凑在一起，因为您之前已经做过几次，这是您以前与Stevester进行的在道德上令人质疑的娱乐活动的一部分。 但是，您甚至不知道如何开始构建您认为位于大型成功在线平台后面的所有其他基础架构和工具。\n您迫切需要真实公司如何进行详细而简洁的概述。 他们如何存储数据？ 他们的不同应用程序如何相互通信？ 他们如何扩展他们的系统以服务于数百万用户？ 他们如何确保它们的安全？ 他们如何确保没有问题？ 当您真正了解它们时，什么是API，webhooks和客户端库？\n您将快速的WhatsApp发送给您的另一个好朋友Kate Kateberry，以查看她是否可以提供帮助。 您过去的合作非常有效，她在硅谷最大，最具争议的公司中创建此类系统已有数十年的经验。\n她立即接受您的工作机会。 实际上，您只是想得到一些粗略的指导和好的八卦，但是您却立即接受了她的接受。 即使没有钱付给她，也毫无意义。 凯特建议她的第一天是5周前，以帮助她解决一些会计违规问题。 她下周某个时候可以来办公室。 她的急切使您感到鼓舞和威胁。\n凯特（Kate）在旧金山公共图书馆的19世纪文学专区进入您的办公室。 “好的，我们做吧！” 她安静地大喊。 “到目前为止，我们得到了什么？ 我们所有的系统如何设置？ 有什么计划？” 您向后靠在椅子上，合上笔记本电脑，由于您将充电器留在家里，笔记本电脑没有打开。 您以希望被描述为“周到”的方式竖起手指。\n“让我把这个问题转过来，凯特。 您认为该计划应该是什么？”\n凯特深吸一口气，对未来五年Steveslist平台以及为其提供动力的基础架构描绘了极为详尽的愿景。\n在开始之前（凯特说），我想明确地说，我并不是说所有这一切都必然是建立基础架构的“正确”方法。 如果您比我更信任一个人说了些不同的话，那么您可能应该按照他们说的去做。 有很多工具，每种工具都有各自的优点和缺点，并且有很多建立技术公司的方式。 我们会做出许多技术选择的真实原因是：“我们选择X是因为Sara对X的了解很多”，“我们选择了Y的那一刻似乎并不是一个重大决定， 我们从来没有时间重新评估。”\n尽管如此，让我们将未来的五年向前迈进。 现在Steveslist有两种主要的面向消费者的产品：\nSteveslist Web应用程序\nSteveslist智能手机应用程序\n这些是用户直接与Steveslist平台进行交互的主要方式。 此外，我们还提供了一个API，允许程序员在Steveslist平台上构建强大的工具，例如，以编程方式为数百个项目创建清单。 为此，我们提供：\nSteveslist API\nSteveslist API客户端库，使程序员可以轻松编写与我们的API对话的代码\n在这里，我将在白板上绘制一个图：\n<code>+-----------+ +--------------+ +-----------------+\n|Web Browser| |Smartphone App| |Client Libraries/|\n+-----+-----+ +------+-------+ |Other API code | | | +-------+---------+ | v | | +-----+------+ | +---------&gt;+ Steveslist +&lt;-----------+ | Servers | +------------+\n</code>\n最后，我们在后台运行着许多服务，这些服务为这些面向外部的应用程序提供数据和功能：\nWebhooks-通知用户帐户发生问题时，例如“下订单”\n用户密码验证-安全登录用户\nSQL数据库-主要的Steveslist数据存储。 需要高度可扩展性和可靠性\n自由文本搜索系统-为搜索框提供动力，使人们可以在其中搜索“电视”或“摩托车”等广泛的搜索词\n内部工具-帮助我们管理Steveslist平台，并采取诸如向恶意用户发出严厉警告的措施\nCron作业-执行常规任务，执行所有工作，从生成发票，向客户开账单到将我们尽可能多的用户数据发送到第三方广告网络\n“ Pubsub”系统-允许我们对不同的触发事件采取异步操作（例如“当新用户注册后，向他们发送欢迎电子邮件”）\n大数据分析系统-使我们能够对Steveslist的整个数据进行大量查询\n还有很多我们会谈论的另一天\n让我们依次浏览每个系统。 如果有任何不清楚的地方，如果您有任何疑问，或者您认为我有什么问题，请告诉我。\n在开始之前-真正的服务器是什么？\n在开始之前，我们先定义一些重要的术语。 实际上，我们只定义一个。 今天，我们将讨论很多有关“服务器”的内容。 但是，什么才是真正的服务器呢？\n就我们的目的而言，服务器是一台在网络上运行并侦听来自其他计算机的通信的计算机。 当它从另一台计算机接收到一些数据时，它会执行某种响应，并且通常会发回自己的一些数据。 例如，Web服务器在网络上侦听HTTP请求，并作为响应发送回网页和信息。 数据库服务器侦听数据库查询，并将数据读写到正在运行的数据库中。\n此简短描述省略了整个学位和详细职业的介绍，并且当然还有定义“服务器”一词的更加精确的方法。 但这应该可以使我们度过晚餐。 你说什么？ 真正的“网络”是什么？ 改天问一个好问题。\n现在，我们准备讨论Steveslist平台。\nSteveslist Web应用程序\n这是Steveslist的主要产品。 这只是一个普通的网络应用，除了规模更大之外，与您之前建立的任何网站都非常相似。 这是现代的“单页应用”（SPA）。 “单页应用程序”中的“单页”是指这样的事实，即用户点击浏览我们的网站时，用户的浏览器几乎无需完全重新加载页面。 相反，当浏览器向我们的服务器发出第一个HTTP请求时，我们将其发送回基本的基本HTML页面和大量JavaScript代码。 该JavaScript代码在浏览器内部执行，并响应用户的操作更新页面视图。 当JavaScript要发送来自Steveslist的数据或从Steveslist检索数据时，它将在后台向URL发送一个异步JavaScript XML请求（简称为AJAX）。 当我们的服务器响应时，JavaScript使用响应来相应地更新浏览器视图。\n<code>+----------+1.User's browser visits steveslist.com. +----------+\n| | It sends an HTTP request to the | |\n| | Steveslist servers | |\n| +---------------------------------------&gt;| |\n|User's Web| |Steveslist|\n| Browser |2.Steveslist server responds with a | Servers |\n| | skeleton HTML page that instructs the | |\n| | browser to request additional | |\n| | JavaScript files. | |\n| |&lt;---------------------------------------+ |\n| | | |\n| |3.User's browser requests and receives | |\n| | these JavaScript files from the | |\n| | Steveslist server. | |\n| +---------------------------------------&gt;| |\n| |&lt;---------------------------------------+ |\n| | | |\n| |4.User's browser executes the JavaScript| |\n| | code. The code sends more requests for| |\n| | the user's data to the Stevelist | |\n| | server, and updates the browser UI to | |\n| | display it. | |\n| +---------------------------------------&gt;| |\n| |&lt;---------------------------------------+ |\n+----------+ +----------+\n</code>\n这个不是一个页面应用程序。 每当您单击链接时，浏览器都必须重新加载整个页面。 twitter.com是单页应用程序。 每当您单击链接时，浏览器都会动态更新页面的一小部分，而不会强制进行完全刷新。\nSPA需要大量的工作来构建和维护，但是看起来确实不错。\nSteveslist智能手机应用\n我们提供适用于iOS和Android的Steveslist智能手机应用程序。 从概念上讲，它们与我们的单页Web应用程序非常相似。 我们的智能手机和Web应用都向我们的服务器发出HTTP请求。 然后我们的服务器接收这些请求，执行一些工作并返回HTTP响应。 最后，我们的智能手机和网络应用程序都会更新其显示，以便与用户进行交流。\n由于我们的智能手机应用程序执行与Web应用程序相同的操作（例如，创建列表，发送消息等），因此它们通常甚至可以将请求发送到与Web应用程序完全相同的URL。 我们要做的唯一的额外工作就是开发应用程序本身的前端。 某些框架甚至可以使用JavaScript编写移动应用程序，从而使您可以跨平台重用代码和逻辑。\nSteveslist API\n我们允许用户和第三方编写以编程方式与我们的平台进行交互的代码。 人们可以使用Twitter API编写读取代码的方式； 喜欢 并创建推文，我们允许他们使用Steveslist API进行搜索； 购买; 并列出项目。\n程序员通过编写向我们的API端点发出HTTP请求的代码来使用我们的API。 例如，为了检索所有列表的列表，程序员将HTTP GET请求发送到api.steveslist.com/v1/listings。 我们以他们要求的数据作为响应，格式为JSON。 JSON代表JavaScript Object Notation，但是JSON并非特定于JavaScript，并且可以轻松地由任何编程语言解释。 检索用户所有列表的请求的JSON响应如下所示：\n<code><span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">listings</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"p\">[</span> <span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">id</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">2178123867</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">name</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">Stolen TV</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">country</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">US</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">city</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">San Francisco</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_amount</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">1000</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_currency</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">usd</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"err\">#</span> <span class=\"nx\">etc</span><span class=\"p\">...</span> <span class=\"p\">},</span> <span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">id</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">182312679</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">name</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">Stolen Bicycle</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">country</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">US</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">city</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">San Francisco</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_amount</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">2000</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_currency</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">usd</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"err\">#</span> <span class=\"nx\">etc</span><span class=\"p\">...</span> <span class=\"p\">}</span> <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code>\n对于程序而言，这种结构化的响应格式非常容易解析，这意味着发出请求的代码可以轻松地解释和使用我们API中的数据。\n用户使用API密钥识别或验证我们的API。 粗略地说，这相当于密码的API。 这是一个很长的随机字符串，我们生成并显示在用户的“设置”页面上。 用户将他们的API密钥作为HTTP标头包含在他们（或其代码）对API提出的每个HTTP请求中。 收到API请求后，我们将检查以查看附加的API密钥是否对应于Steveslist用户。 如果有，那么我们代表该用户执行请求。\n如果程序员愿意，他们可以使用其语言的标准HTTP库手动向我们的API手动构建HTTP请求。 例如，在Python中，他们可能会写：\n<code><span class=\"kn\">import</span> <span class=\"nn\">requests</span> <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"s\">'https://api.steveslist.com/v1/listings/'</span>\n<span class=\"n\">listing_params</span> <span class=\"o\">=</span> <span class=\"p\">{</span> <span class=\"s\">\"name\"</span><span class=\"p\">:</span> <span class=\"s\">\"Stolen TV\"</span><span class=\"p\">,</span> <span class=\"s\">\"country\"</span><span class=\"p\">:</span> <span class=\"s\">\"US\"</span><span class=\"p\">,</span> <span class=\"s\">\"city\"</span><span class=\"p\">:</span> <span class=\"s\">\"San Francisco\"</span><span class=\"p\">,</span> <span class=\"s\">\"price_amount\"</span><span class=\"p\">:</span> <span class=\"mi\">1000</span><span class=\"p\">,</span> <span class=\"s\">\"price_currency\"</span><span class=\"p\">:</span> <span class=\"s\">\"usd\"</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n<span class=\"n\">api_key</span> <span class=\"o\">=</span> <span class=\"s\">\"YOUR_API_KEY_GOES_HERE\"</span> <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">post</span><span class=\"p\">(</span> <span class=\"n\">url</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">=</span><span class=\"n\">listing_params</span><span class=\"p\">,</span> <span class=\"n\">headers</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s\">\"X-Steveslist-API-Key\"</span><span class=\"p\">:</span> <span class=\"n\">api_key</span><span class=\"p\">},</span>\n<span class=\"p\">)</span>\n</code>\n但是，通过提供客户端库，我们使程序员的生活更轻松。\nSteveslist客户端库\n客户端库是一个“包装” Steveslist API功能的库。 这意味着使用客户端库的任何人都无需了解Steveslist API的详细信息。 相反，他们可以只写：\n<code><span class=\"kn\">import</span> <span class=\"nn\">steveslist</span> <span class=\"n\">listing</span> <span class=\"o\">=</span> <span class=\"n\">steveslist</span><span class=\"o\">.</span><span class=\"n\">Listing</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s\">\"Stolen TV\"</span><span class=\"p\">,</span> <span class=\"n\">country</span><span class=\"o\">=</span><span class=\"s\">\"US\"</span><span class=\"p\">,</span> <span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s\">\"San Francisco\"</span><span class=\"p\">,</span> <span class=\"n\">price_amount</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"p\">,</span> <span class=\"n\">price_currency</span><span class=\"o\">=</span><span class=\"s\">\"usd\"</span><span class=\"p\">,</span> <span class=\"n\">api_key</span><span class=\"o\">=</span><span class=\"s\">\"YOUR_API_KEY_GOES_HERE\"</span>\n<span class=\"p\">)</span>\n</code>\n我们的库将给定的参数转换为格式正确的HTTP请求，然后将它们正常发送到Steveslist API。 我们已经为我们能想到的每种主要编程语言编写了客户端库，这是迄今为止人们与我们的API交互的最常见方式。\n网络挂钩\n我们已经了解了Steveslist用户如何使用我们的API与他们的帐户进行编程交互。 另外，许多用户还希望我们在他们的Steveslist个人资料发生问题时主动告诉他们。 例如，假设某人想要完全自动化在Steveslist上销售商品的过程。 每当客户使用我们新的，最安全的StevePay系统为商品付款时，他们都想向客户发送一封感谢信，并自动指示其仓库将被盗的电视机运送到订购地址。 我们的卖方可以不断重复查询Steveslist API，询问“是否有新交易？ 有新的销售吗？” 但是，这将非常低效，并且会给我们的服务器带来很多不必要的负载。\n相反，我们提供了一个称为webhooks的行业标准系统。 Webhook是一个HTTP请求，只要他们的帐户发生问题，我们就会将其发送给用户。 它包含描述刚刚发生的事件的所有数据-例如，商品ID，价格，买家ID，买家地址等。 Webhooks允许用户自动执行响应操作，例如上述电子邮件和自动运送。\n要使用Webhook，用户会告诉我们他们希望我们向其发送Webhook的URL（例如，steveslistwebhooks.robertheaton.com。他们在该URL上设置了Web服务器，该Web服务器将接收并处理这些Webhook通知。\n<code>1.Buyer purchases an 3.The seller's server receives the webhook, item as normal. and uses the information in it to automatically process the order.\n+---------------+ +-----------------+\n|Buyer's Browser| |Seller's Webhook-+\n+------+--------+ |Receiving Server | | +------+----------+ | ^ | | | | | +-----------+ | +---&gt;+ Steveslist+----------+ | Server | +-----------+ 2.Once the transaction has been completed, Steveslist looks up the seller's webhook URL (if set). We then send an HTTP request to this URL, containing the details of the purchase.\n</code>\n用户在收到来自我们的webhook时，会将代码部署在其Web服务器上，以执行适当的响应操作。 我们不仅在购买商品时发送网络钩子，还在用户收到消息时发送它们。 当管理员删除其中一项时； 或买家提出投诉时。 这使Steveslist卖家不仅可以自动化商品清单，还可以实现商品的销售和运输自动化。\nWebhook并发症\nWebhook具有两个主要的复杂性-安全性和可靠性。 首先，我们来谈谈安全性。 互联网上的任何人都可以访问卖方指示我们向其发送网络挂钩的端点。 知道该URL的任何人都可以向其发送假冒的Webhook，并且如果我们的卖方不小心，这可能会使攻击者诱骗他们，例如向其发送免费的东西。 卖方的Webhook URL应该很难找到，因为卖方不会公开其存在，但模糊性与安全性并不相同。\n为了让我们的卖家验证Steveslist确实发送了一个Webhook，我们对Webhook的内容进行了加密签名。\n加密签名\n密码签名是一个深刻而微妙的话题。 这是我们使用它来保护网络钩子的简明版本。\n当卖家为其帐户启用网络挂钩时，我们会生成一个随机的“共享密钥”。 我们告诉卖方将密钥复制到他们的Webhook接收服务器上并保持其安全性，以使密钥的价值只有我们和卖方才能知道。 每当我们发送一个Webhook时，我们都会使用这个共享的秘密，通过使用称为HMAC的加密散列函数将其与Webhook的内容结合起来，并为该Webhook获取一个长的，随机的，但完全确定的“签名”。\n<code>Webhook contents +----------+\n(eg. {\"id\": 123...}) | v +---+----------+ |HMAC Algorithm|-----&gt;Webhook signature +---+----------+ ^\nShared secret key |\n(eg. 123mhu23jy8xdwgmd...)+---+\n</code>\n我们将此签名包含在我们的webhook正文中，例如：\n<code><span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">action</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">item_sold</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">100</span><span class=\"p\">,</span> <span class=\"c1\">// ...more params...</span> <span class=\"dl\">\"</span><span class=\"s2\">signature</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">234gj98d49j834978gf39t78ndn98g7dq3ng897308y7</span><span class=\"dl\">\"</span>\n<span class=\"p\">}</span>\n</code>\n当卖方的Webhook接收服务器收到Webhook时，它将获取共享的机密和Webhook内容，并以与我们完全相同的方式计算期望签名的内容。 它将结果与连接到网络挂钩的签名进行比较； 如果它们匹配，则它接受并处理Webhook。 由于只能使用我们和卖方仅知道的共享机密来生成签名，因此Webhook接收服务器可以确信Webhook是由我们发送的。 但是，如果签名不匹配，则服务器拒绝该Webhook。\n请注意，所有签名验证代码都必须由卖方编写和维护。 我们可以向他们提供鼓励和示例，但我们不能强迫他们正确甚至根本无法验证签名。 对于一些实际示例，请查看Stripe和GitHub如何签署他们的Webhooks。\n可靠性\n我们还需要考虑当我们的网络钩子出现错误时会发生什么，以及我们想为我们的用户提供哪些保证。 如果我们尝试发送Webhook但无法连接到用户的服务器，该怎么办？ 如果我们成功连接到他们的服务器并发送了Webhook，但是他们的服务器发回了错误，该怎么办？ 如果我们发送了Webhook，但是服务器挂起了二十秒钟，然后断开连接却没有告诉我们发生了什么，该怎么办？\n这里涉及到权衡，需要清晰的沟通和数量惊人的基础架构来管理。 我们在Steveslist的选择是保证我们将“至少一次”交付webhooks。 这意味着，如果一个Webhook发送失败，那么我们将继续尝试（很多次但不是无限次），直到发送成功为止。 如果不确定网络挂钩是成功还是失败，我们将继续尝试直到确定成功为止。 这有时可能会导致我们两次发送相同的Webhook，但是卖方有责任让其代码优雅地处理此问题，而不是向同一位客户发送五台被盗的电视，而不是向他们订购的一台。\n“到目前为止你怎么看？” 凯特问。 “这大概就是您一直在想的吗？” 您面无表情，大吃一口附近的三明治，以免进行任何进一步的讨论。 凯特继续：\n让我们谈谈将支持我们一些最重要功能的后端系统。\n通过密码进行用户验证\n大多数用户使用用户名和密码登录Steveslist网站和智能手机应用程序。 还有其他登录网站的方式，例如OAuth-我们将再次介绍它们。\n我们将必须非常安全地存储用户的密码。 用户密码不仅是登录（或验证）Stevelist所使用的密码，而且对于许多用户而言，尽管也有所有警告，它们可能也与登录其他许多服务时使用的密码相同。 一个坏主意。 毕竟，他们只有这么多的孩子有这么多的生日。\nRupert Herpton已撰写了有关如何保护密码的开创性教程，我相信您已经阅读了。 万一您需要复习一下，问题的关键是我们永远不能在任何地方以原始明文形式存储密码。 我们不得将它们以纯文本格式存储在数据库，日志文件或系统的任何其他部分中。 相反，在存储密码之前，我们必须首先使用哈希函数（例如bcrypt）对其进行哈希处理。\n哈希函数是一种“单向”函数，它接受输入并将其确定性地转换为新的看似随机的字符串。 从输入中计算哈希值在计算上非常容易，但是要反转转换并从其哈希值中恢复原始输入会花费大量时间和计算能力，实际上这是不可能的。\n<code>+---------+ Easy +----------+\n| |------------&gt;| |\n|Plaintext| |Hash value|\n| |&lt;------------| |\n+---------+ Essentially +----------+ Impossible\n</code>\n由于我们仅存储用户密码的哈希值，因此，如果黑客以某种方式偷走了我们的密码数据库（禁止上天堂）（触摸木头），那么他们将只能看到密码的哈希值。 他们将无法轻松地将这些哈希值重新转换为纯文本密码，这意味着他们将无法使用它们来登录Steveslist，并且他们将无法利用所有 在不同的服务之间使用密码。\n由于我们仅存储密码哈希值，因此当我们要检查用户提供给我们的登录密码是否正确时，我们首先计算其哈希值，然后将结果与密码数据库中的哈希值进行比较。\n<code> +--------------+ |User's Browser| +-----------+--+\n1.User attempts to | ^\nlog in: | | 3. Server logs the user in | | if password matches, and username: steve | | returns an error if it does not. password: 12345 v | +--+--------+--+ | Steveslist | | Server | +--------------+ |\n2.Server computes | |username|password_hash|\nthe hash of the | +----------------------+\npassword and compares +----&gt;+steve |23jy7213y7jO |\nit to the value in the |kate |21897213hh21 |\ndatabase. |... |... |\n</code>\n如前所述，我们还必须注意不要在任何调试输出中记录密码。 这很容易犯错误-如果您记录了每个HTTP请求的所有参数，以防万一您需要它，那么您肯定会记录用户密码。 Facebook以明文形式登录密码已有很多年了，尽管它似乎并没有影响其股价，但我敢肯定，这使他们在一两天内感到很傻。\n凯特屏住呼吸。 您假装在电池没电的笔记本电脑上记笔记。\n让我们谈谈基础架构。\n数据库服务器\nSteveslist的主要数据存储运行一种常见的SQL数据库，称为MySQL。 我在这里不会过多地谈论SQL-它的工作方式的细节并不重要，如果您有兴趣，可以在Google上找到它们。 由于我们是如此成功，因此我们需要管理大量且不断增长的数据。 我们已经开始敏锐地意识到数据库不是万能的。 就像任何其他程序一样，它们在计算机上运行。 随着数据库中数据量的增长，计算机的硬盘驱动器和内存开始装满。 在公司成立之初，解决此问题的最简单方法是在具有巨大硬盘的单台计算机（或计算机）上运行数据库。 但这只能避免这么长时间的问题。 最终，我们的数据库包含的数据量超出了任何合理的硬盘驱动器所能存储的数据量，并且由于我们迫使它搜索越来越多的记录，数据库开始变得越来越慢。\n我们必须采用全新的方法，然后重新配置数据库以将其数据存储在多台计算机上。 我们使用分片进行了此操作。\n分片\n对数据库进行分片意味着将其数据分成多个块（或“分片”），并将每个块存储在单独的计算机上。 组成数据库的所有机器统称为数据库集群。 如何在群集中的计算机之间拆分数据取决于您的应用程序和将要执行的操作类型。 对于Steveslist，我们选择了按用户划分数据。 这意味着给定用户的所有数据都存储在同一台计算机上。 这包括他们的个人资料信息，他们的清单，他们的消息等等。 可以使用用户以外的分片键来分片没有相应用户的数据（例如“每日交易”），如果数据集足够小，则可以完全不分片。\n这意味着我们在数据库的前面需要一个额外的“路由”层，该层知道哪个数据库机器能够为哪些查询提供服务。 我们可以让我们的应用程序服务器（执行代码的服务器）负责了解用户ID到数据库分片的映射，也可以让所有服务器向其发送请求的集中化“路由器”，并负责制定 适当的机器将请求转发到。 两种方法都有其优势。 让应用服务器负责维护映射可以减少请求必须执行的跃点数，从而加快响应速度。 但是拥有集中式路由器会使碎片映射的更新变得容易得多，因为您只需要在一个地方进行更新即可。\n如果应用服务器负责了解分片布局，那么我们的系统如下所示：\n<code> + + + | | | | Requests from users | | | | v v v +------+----------+--------------------+ | Application | | Server | | | |Database sharding config: | |* DB Server 1: IDs between 1-10000 | |* DB Server 2: IDs between 10000-20000| |* DB Server 3: IDs between 20000-30000| +-+----------------+-----------------+-+ | | | |ID:501 |ID:15362 |ID:22361 | | | v v v\n+-----------+ +-----------+ +-----------+\n|DB Server 1| |DB Server 2| |DB Server 3|\n+-----------+ +-----------+ +-----------+\n</code>\n如果我们有一个集中式数据库路由器，那么我们的系统如下所示：\n<code> + + + | | | | Requests from users | | | | v v v +------+----------+--------------------+ | Application | | Server | | | |Database sharding config: | |* ??? Application Server has no idea | +------------+-----------+-------------+ | | Application server sends all database queries to the database router, which forwards them to the correct shard. | | v v +--------------+-----------+-------------+ | Database router | | | |Database sharding config: | |* DB Server 1: IDs between 1-10000 | |* DB Server 2: IDs between 10000-20000 | |* DB Server 3: IDs between 20000-30000 | +---+----------------+---------------+---+ | | | |ID:501 |ID:15362 |ID:22361 | | | v v v\n+-----------+ +-----------+ +-----------+\n|DB Server 1| |DB Server 2| |DB Server 3|\n+-----------+ +-----------+ +-----------+\n</code>\n我们如何确定将每个用户分配给哪个数据库？ 但是我们想要。 我们可以先说，将具有奇数ID的用户分配给分片机1，将具有偶数ID的用户分配给分片机2。我们希望这种随机分配能够使我们的分片之间的数据相对均衡 。\n但是，我们可能会拥有少量的高级用户，他们创建的数据可能比其他用户多得多。 也许它们创建了太多数据，我们想为其分配一个自己的碎片。 完全可以-我们可以完全控制如何将用户分配给分片。 随机分配通常是最简单的，但绝不是唯一的选择。 我们可以选择将用户随机分配给分片-除了分配给分片15的用户367823（没有其他用户分配给用户）。\n如果碎片太大，并开始填满机器的硬盘，我们可以将其拆分为多个较小的碎片。 我们如何将数据迁移到这些新的分片上而又不必关闭平台一段时间？ 可能使用类似的顺序过程：\n将新数据“双重写入”新旧碎片。 继续从旧分片读取数据\n将所有现有数据从旧分片复制到新分片。 继续对新旧碎片进行双重写入\n说服自己，新旧碎片包含相同的数据。 我们可以通过比较数据库快照和/或通过从两个数据库中读取每个查询，进行比较并在数据不同时发出警报来做到这一点。\n一旦我们确信新旧分片包含相同的数据，便切换到从新旧分片读取。 如果需要退回，我们会继续进行重复书写\n一旦我们确信此步骤已成功完成，请停止重复写入并删除旧的分片\n鲁珀特·赫普顿（Rupert Herpton）撰写了一篇很棒的文章，内容涉及广泛相似的迁移类型，并且更加详尽。 简而言之，在数据库分片之间迁移数据的过程既详细又挑剔，但也完全可行且合乎逻辑。 某些类型的数据库甚至可以自动为您处理分片。\n复写\n我们将非常注意确保不会意外删除我们的数据，并且我们的数据库服务器不会随机停止工作。 但是发生意外，有时计算机确实会随机停止工作。 为了减轻与数据库相关的灾难的影响，我们在多台计算机上实时（接近）复制了数据。\n<code> Client writes new data to DB Server A | v +-----+-----+ |DB Server A| ++---------++ | | DB Server A quickly replicates v v the new data to DB Servers B and C\n+----------++ +-+---------+\n|DB Server B| |DB Server C|\n+-----------+ +-----------+\n</code>\n实时复制有两个主要好处。 首先，这意味着，如果我们的一台数据库服务器爆炸，着火或以其他方式停止工作，我们将拥有多个几乎完美的副本，这些副本可以无缝地解决这一问题。 在直接的，原始的失败中，我们服务的用户可能永远不会知道任何问题。 复制的第二个好处是我们可以在多个数据库服务器之间分发对相同数据的查询。 如果很多用户要求从同一数据库中读取数据，我们可以将他们的查询分散到所有副本中，这意味着我们可以并行处理更多查询。\n<code> Clients can query the same data from any of DB Servers A,B,or C | | | | | | | | | v v v | | | | +-+---+---+-+ | | | | |DB Server A| | | | | +-----------+ | | | | | | v v v v\n+---+-------+ +-----+-+---+\n|DB Server B| |DB Server C|\n+-----------+ +-----------+\n</code>\n请注意，数据库复制与进行数据库备份的概念不同。 复制是（接近）实时发生的，旨在实时处理实时（或生产）系统中的孤立问题。 数据库备份按计划执行（例如，每天一次），并且数据副本独立存储在生产系统之外。 备份被设计为防止大规模灾难性数据丢失的最终保护措施，如果所有数据中心都被烧毁，可能会发生这种情况。\n假设您在一家大银行的呼叫中心工作，那里的人们经常打电话给您，以进行汇款并询问其当前余额。 复制等同于在收到转移详细信息时将它们详细记录到多本书中，以防万一您丢失其中一本书。 进行备份相当于每天复印一次这些书，然后将副本存储在文件柜中。\n复写\n复制的过程从概念上讲非常简单。 每当将新数据写入我们的数据库时，我们都会将其复制到多台计算机上。 这意味着，如果/当机器出现故障时，我们可以继续查询其兄弟服务器，而不会影响用户。 这也意味着我们可以将查询分布在同一数据的多个副本中，从而缩短查询响应时间。\n但是，我们如何做到这一点的细节是重要的，微妙的并且取决于情况。 没有正确的复制方法-通常情况下，您采用的确切方法取决于系统的特定要求和约束。\n关于现实世界的两个不便事实使复制变得复杂。 首先，数据库操作有时会随机失败。 当我们尝试将数据从一台服务器复制到另一台服务器时，有时会出错，导致我们的计算机至少在一段时间内不同步。 其次，即使在运行平稳的时期，复制也不是瞬时的。 当将新数据写入我们的数据库集群时，集群中的某些服务器将总是比其他服务器更早知道更新。 在选择复制策略时，我们必须意识到这些限制以及它们如何影响我们的特定应用程序。 例如，冒个帖子的“点赞”数量略微不同步且过时的风险，但不能冒险用户的银行帐户中的金额，这也许是可以的。\n选择复制策略时，我们必须做出的最大决定之一就是我们要复制是同步复制还是异步复制。\n异步与同步复制\n复制可以同步或异步进行。 这些词在系统设计中出现在很多不同的地方，但是从根本上讲它们始终是同一件事。 如果某个动作是“同步”执行的，则意味着该动作是在某人等待的同时执行的。 如果您想同步发送一封信，那么您将到达邮局，将信交给邮递员，坐在邮局的角落等几天，直到邮递员确认后才回家 您的信已经安全到达。\n相反，如果某个动作是“异步”执行的，那么这意味着该动作的发起者不会等待它完成。 相反，他们只是在后台进行操作时继续进行其余工作。 真正的邮政服务是异步的； 您将您的信给邮政工作人员，然后离开并继续生活，而邮政局则将您的信寄给您。 异步操作可以根据需要（例如，“您的信已到达并已签名”或“希顿先生，您的干洗店已准备就绪”）回传操作结果通知，但不必这样做。\n这些原则如何应用于数据库复制？ 在同步复制中，客户端将其新数据写入数据库服务器，然后等待。 该服务器在完成跨所有同级服务器完全复制客户端数据之前，不会告诉客户端其写入是否已成功完成。 然后，直到那时，客户端才继续执行其其余代码。\n与以前一样，在异步复制中，客户端将其数据写入第一台数据库服务器。 但是这一次，第一台服务器告诉客户端，只要将数据写入其自己的数据存储中，写入就成功了。 它会在后台启动复制过程，并且无需等待复制过程完成甚至开始，就可以告诉客户端写入成功。 这意味着异步操作看起来比同步操作快得多，因为客户端不必等待所有复制完成即可继续进行其余的工作。 但是，如果后台复制失败，则客户端将认为它实际上已经成功地将其数据成功写入数据库。 这可能会引起问题，读者可以将其想象力留给练习。\n同步方法比异步方法慢但“安全”。 在完成每一步之前，数据库永远不会声称已经成功接收并存储了任何数据。 因为客户端在继续之前等待完整的确认，所以可以确保永远不会遇到客户端认为已向数据库写入了一些数据，但是数据库已秘密地将数据部分丢到地板上的情况。\n哪种方法更好？ 这取决于。 您是否更在乎速度或正确性？ 如果可以显着加快系统运行速度，偶尔出现不一致的数据是否可以？ 还是会因为一个错误而导致飞机开始坠落？\n数据库复制系统也面临其他有趣的问题。 其中许多问题是“逻辑的”而不是“技术的”，不需要对系统底层的复杂软件和网络协议有详细的了解。 为了帮助您了解其中的一些情况，假设您几段前就回到了呼叫中心。 您与许多其他同事一起工作。 你们一起扮演数据库服务器的角色。 人们打电话给您转账并询问他们目前的余额。 您和您的同事将有关新转移的信息记录在纸上，并通过相互调用在彼此之间进行复制。\n我们的数据库集群面临的问题与我们的呼叫中心面临的问题相同。 如果两个人打进电话，并试图通过与两位不同的员工交谈来更新同一数据，会发生什么情况？ 也许我们可以通过拥有一名“领导”员工来解决此问题，该员工是唯一有权为尝试创建转接的人员提供服务的人员。 所有其他员工仅允许回答有关当前余额的查询。 好的，如果领导者在收到一些新数据之后却在告诉其他所有人之前中风而死，该怎么办？ 如果“跟随者”员工暂时癫痫发作几秒钟而错过领导者的一些数据更新怎么办？ 如果我们无法完全确定哪些员工已死或活着怎么办？\n这不是一个近似的隐喻，如果您看起来太刻苦或开始问一些尴尬的问题，它就不会分解。 了解这个奇怪的呼叫中心，您就会了解数据库复制。 阅读此博客文章，您将真正理解复制。\n后备\n除了实时复制外，我们还存储整个数据库的定期备份，以防止灾难性灾难。 我们将所有数据复制到数据库中，将其存储在安全的地方，并将其标记为“ database backup，2020-05-11：01：00”。\n<code>+----------+ | Database +----------------&gt; database backup, 2020-05-11:01:00\n+----------+ database backup, 2020-05-10:01:00 database backup, 2020-05-09:01:00\n</code>\n如果整个数据库（或其中的一部分）以某种方式被清除，我们将获取最新的可用备份并将其加载到新的数据库计算机中。\n<code>+----------+\n| New |\n| Database +&lt;---------------- database backup, 2020-05-11:01:00\n+----------+ database backup, 2020-05-10:01:00 database backup, 2020-05-09:01:00\n</code>\n这种灾难可能是由于网络攻击，我们数据中心的灾难，数据库迁移发生了严重错误或许多不大可能但可能破坏公司的原因引起的。 与实时复制不同，从备份还原数据库是一个缓慢的过程，我们的用户一定会注意到。 在还原完成之前，我们的整个系统可能都处于脱机状态。 我们将丢失在上一次备份之后但在灾难发生之前发生的所有数据库更新。 毫无疑问，随着用户和系统尝试访问曾经存在但现在永久丢失的数据，将产生大量连锁反应。 尽管如此，这些损失远不及我们公司所有数据以及公司的全部，不可挽回的损失可怕。\n关于我们的主要SQL数据库，有很多细节。 让我们讨论一下存储和查询数据的其他方式。\n自由文本搜索\n标准的SQL数据库非常擅长回答定义明确的特定查询。 例如：\n给我所有用户＃145122在过去90天内创建的所有物品清单\n请给我列出该物品的清单详细信息＃237326921\n请给我每天在旧金山创建的带有“电子”标签的新列表的数量\n您可以使用如下所示的SQL查询来检索此类数据：\n<code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">user_id</span> <span class=\"o\">=</span> <span class=\"mi\">145122</span> <span class=\"k\">AND</span> <span class=\"n\">created</span> <span class=\"o\">&gt;</span> <span class=\"n\">currentDate</span><span class=\"p\">()</span> <span class=\"o\">-</span> <span class=\"mi\">90</span>\n</code>\n要么\n<code><span class=\"k\">SELECT</span> <span class=\"n\">DATE_TRUNC</span><span class=\"p\">(</span><span class=\"s1\">'day'</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">created</span><span class=\"p\">)</span> <span class=\"k\">AS</span> <span class=\"k\">day</span><span class=\"p\">,</span> <span class=\"k\">COUNT</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span> <span class=\"k\">AS</span> <span class=\"n\">i</span>\n<span class=\"k\">INNER</span> <span class=\"k\">JOIN</span> <span class=\"n\">labels</span> <span class=\"k\">as</span> <span class=\"n\">l</span> <span class=\"k\">ON</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">id</span> <span class=\"o\">=</span> <span class=\"n\">l</span><span class=\"p\">.</span><span class=\"n\">item_id</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">city</span> <span class=\"o\">=</span> <span class=\"s1\">'San Francisco'</span> <span class=\"k\">AND</span> <span class=\"n\">l</span><span class=\"p\">.</span><span class=\"nb\">text</span> <span class=\"o\">=</span> <span class=\"s1\">'electronics'</span>\n<span class=\"k\">GROUP</span> <span class=\"k\">BY</span> <span class=\"mi\">1</span>\n<span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"mi\">1</span> <span class=\"k\">DESC</span>\n</code>\n您会注意到，这些查询包含许多非常“精确”的运算符，例如等号和大于号。 但是，您将如何编写一个SQL查询以返回与Google样式的“全文”搜索（例如“二手电视”）匹配的项目列表？\n这将是困难的。 您可以尝试使用SQL LIKE运算符，该运算符允许您查找包含模式（例如子字符串）的记录。 例如，以下查询查找所有描述，其中包含子字符串二手电视的所有项目：\n<code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second-hand TV%'</span>\n</code>\n但是，此查询将仅匹配给定的非常具体的子字符串。 它与“二手电视”或“二手电视”或“二手电视”不匹配。 只要有足够的毅力，理论上您就可以构造一个庞大的SQL查询，该查询可以满足您对以下所有排列的需求：\n<code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second%hand%TV'</span> <span class=\"k\">OR</span> <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second%TV%hand'</span> <span class=\"k\">OR</span> <span class=\"c1\">-- …and so on and so on for another bajillion ORs…</span>\n</code>\n但是，结果查询会很慢且麻烦，并且仍然会遗漏许多您未曾想到的重要情况。 即使您确实获得了有用的搜索结果列表，仍然需要做很多工作来决定如何订购它们。 您想要的顺序并不严格，例如“最新的优先”或“按字母顺序排列的标题”。 取而代之的是“最好”或“最相关”的概念。\n所有这些都意味着SQL数据库通常不太擅长全文搜索。 幸运的是，还有其他类型的数据库，包括一种名为Elasticsearch的数据库。 Elasticsearch通常被描述为面向文档的数据库。 我们不需要详细介绍其工作原理，但是对我们而言重要的是，与SQL数据库不同，Elasticsearch非常擅长接收“二手电视”之类的查询并返回由 用户已经从搜索引擎中获得的模糊匹配的“相关性”。\n您可能会说：“ Elasticsearch之类的声音比SQL还要好。” “我们应该扔掉我们的SQL数据库，而是将所有内容放到Elasticsearch中吗？” 没那么快。 Elasticsearch和其他类似的数据库都有其优势，但也有其劣势。 它们通常不如SQL数据库可靠，并且更有可能意外丢失大规模数据。 它们写入新数据的速度通常也慢得多。\n正如我们已经指出的，针对任何类型的工作，很少有一个通用的“最佳”工具。 当然，没有“最好的”数据库。 相反，不同的数据库具有不同的优点和缺点，并且不同的解决方案适用于不同的任务。 在Steveslist，我们非常关心确保使用正确的工具完成正确的工作，以将数据存储在SQL数据库和面向文档的数据库（例如Elasticsearch）中。\n我们使用SQL数据库作为主要数据存储。 这是我们权威的“事实来源”，我们将所有新数据写入其中，然后再将其写入其他任何地方。 我们会从中读取所有简单，精确的内容，尤其是当准确性和最新性是我们的主要要求时。 如果要向用户显示所有未完成清单的列表，请从SQL数据库中读取它。 如果我们想验证用户密码，我们也会从SQL数据库中读取该密码。 这发挥了SQL数据库的优势。\n但是，在后台，我们还将数据从SQL数据库复制到Elasticsearch数据库，并将通过搜索框进行的所有全文搜索查询发送到Elasticsearch。 这意味着我们将从Elasticsearch的优势中受益，而不受其劣势的太大影响。 我们每隔几分钟，几小时或几天就复制一批记录，具体取决于特定数据集的要求。 或者，我们可以查看SQL数据库的日志中是否有新记录或更新记录，并以近实时方式创建或更新相应的Elasticsearch记录。\n<code> | | |\nNew data is always | |Queries for |Full-text search written to the SQL | |specific data go |queries go to\nDB first | |to the SQL DB too |Elasticsearch V V V +--------------+ +---------------+ | SQL Database +------&gt;+ Elasticsearch | +--------------+ +---------------+ New data is copied over from the SQL DB to Elasticsearch\n</code>\n在搜寻Steveslist的竞争对手时，我注意到当您创建新的Craigslist列表时，它会显示“您的列表将在接下来的15分钟内显示在搜索结果中”。 我会打赌比索，因为这是因为他们的主要数据存储区是一个SQL数据库，但是他们的搜索框由类似Elasticsearch的引擎提供动力。 他们用于从SQL复制数据以进行搜索的管道可能需要大约15分钟的时间，他们认为（非常合理）对于他们的特定用例来说，这是可以接受的延迟。\n我们已经说过，Elasticsearch的可靠性要比大多数SQL数据库差一些。 如果Elasticsearch意外丢失了我们的一些记录，那么它们将不会出现在搜索结果中。 这将使我们的产品变得更糟，这是一种耻辱，我们将尽最大努力避免这种情况的发生。 但是，这不会像从我们的主数据存储中丢失数据那样造成灾难。 我们仅将数据复制到Elasticsearch中之后，再将其复制到Elasticsearch SQL数据库中并由其安全捕获，这才是真正重要的。\n现在是下午6点，图书馆即将关闭。 图书管理员试图让您离开。 凯特用一大堆弄皱的纸球把他赶走了。\n内部工具\n管理Steveslist平台需要定制的内部工具。 我们需要执行广泛的管理任务，例如删除过于违法的列表（甚至对我们而言），发行退款，查看用户的个人详细信息以帮助支持请求等等。 Steveslist的其他团队的工作人员将使用其中许多工具，例如财务，合规性，法律，销售和支持。 由于他们需要执行的任务非常适合Steveslist的工作方式，因此我们无法使用第三方工具来完成这些任务，而必须自己构建。\n在早期，我们将此功能烘焙到主要的Stevelist产品中，并且仅向设置了is_steveslist_employee = True数据库标记的用户公开。 对于小公司来说，这是不错的方法，但它也很脆弱，很容易搞砸。 令人恐惧的是，我们通过运行主产品的同一台服务器来公开我们所有的超级用户能力。 这使我们应用程序中的安全漏洞的潜在后果更加严重，并给我们造成了新的错误类型，例如忘记为一个被开除工作的雇员禁用is_steveslist_employee标志。\n一旦Steveslist达到一定的成熟度，我们便为自己构建了一个完全独立的管理平台，并具有独立的强化身份验证和授权。 该服务在完全独立的服务器上运行，并且需要VPN和TLS客户端证书才能访问（我们将在另一天讨论）。 这将我们面向内部和面向外部的产品分开了，并大大减少了使我们的管理工具暴露给世人的严重错误的机会。 我们经常在构建新的内部工具-一种用于用户管理，一种用于服务器管理，一种用于欺诈检测等。 这些服务都与面向用户的产品使用同一数据库通信，因此它们都可以访问相同的数据。 它们只是在完全无法被外界访问的不同服务器上运行。\nCron职位\n我们希望系统在固定的时间和间隔执行很多任务。 例如：\n通过电子邮件发送每周使用情况报告\n向用户发送营销电子邮件\n向与我们有订阅计划的信用卡用户收费\n将数据从我们的SQL数据库复制到Elasticsearch\n用于运行计划作业的最常用工具称为cron，该工具内置于Unix操作系统中。 这种情况如此普遍，以至于人们经常将任何类型的计划工作称为“计划工作”，即使实际上并非由计划工作来执行。\n您可以通过运行以下命令在自己的计算机上设置cron作业：\n<code>crontab -e\n</code>\n然后输入提示：\n<code>*/5 * * * * $YOUR_COMMAND\n</code>\n这将使您的计算机每5分钟执行一次$ YOUR_COMMAND。\nSteveslist当前具有非常简单且稍微脆弱的cron设置。 我们只有一个“预定的作业服务器”。 我们在该服务器上（如上）使用crontab来告诉它要运行的命令以及要对其运行的时间表。 此设置的扩展性不是很好-如果排定的作业服务器爆炸甚至打h，那么我们并不总是知道它执行了哪些作业或没有执行哪些作业，因此不得不争先恐后地启动替换服务器。 即使服务器非常强大，但最终我们还是希望运行更多的工作，而不是一次性处理。 我们正在考虑将cron作业拆分为多个服务器，或者使用Kubernetes等现代工具来建立新系统。\nPubsub\n行动有后果。 这既是我们发送给在互联网上写关于我们卑鄙的人的邪恶电子邮件的主题，也是我们拥有pubsub系统的原因。\n当新用户注册时，我们希望向他们发送一封电子邮件，欢迎他们进入Steveslist，并提醒他们有关我刚才描述的动作与结果的关系。 当为旧金山的失窃电视添加新清单时，我们要通知已为湾区中的电视设置搜索警报的用户。 如果拒绝订阅卡，我们想通过电子邮件向负责的用户发送电子邮件，以礼貌地威胁他们。 添加新列表后，我们要执行一些非常粗略的反欺诈检查。 购买商品后，我们希望向其卖家发送网络挂钩。 等等。\n从技术上讲，所有这些动作都可以由服务器执行启动动作来同步执行（还记得那个词吗？）。 但是，由于两个原因，这通常是一个坏主意。 首先，响应操作（例如，向所有订阅了有关新的被盗电视的通知的用户发送电子邮件）可能非常缓慢。 同步执行响应动作意味着，如果发起动作是由用户执行的，那么他们将不得不等待所有响应动作也完成。 如果响应动作小而又快，例如发送一封电子邮件，这可能不是世界末日。 但是，如果范围更大（例如搜索并通知所有可能对新商品感兴趣的用户），那么，它仍然不会是世界末日，但会带来糟糕的用户体验。\n为了减轻这个问题，我们建立了一个“发布-订阅”或“ pubsub”系统。 执行触发操作时，执行该操作的代码“发布事件”来描述该操作，例如NewListingCreated或SubscriptionCardDeclined。 在这种情况下，“事件”和“发布”这两个词的定义很松散，并且没有严格的技术定义。 事件只是某种事件发生的某种记录，发布事件只是意味着您以某种方式记下了某件事的发生。 具体操作方式完全取决于所讨论的pubsub系统。 在简单的系统中，事件可能存储在SQL数据库的表中，并且代码将通过向表中写入新记录来发布事件。\n如果Steveslist的程序员希望每当发布特定类型的新事件时都执行响应操作，则可以编写使用者。 这是一段代码“订阅”到某种事件的代码，并且在发布该类型的新事件时都会执行该代码。 它使用事件的详细信息（例如，订阅付款失败的用户）异步执行程序员希望执行的任何操作（例如，向用户发送威胁性电子邮件）。\nPubsub系统通常由中央消息代理管理。 系统将事件发布给代理，然后代理负责将事件发送给任何订阅的使用者。 这可以使用推或拉机构来实现。 消费者可以通过轮询并反复询问“是否有新事件来从经纪人那里获取消息”。 有新事件吗？” 或者他们可以等待并收听，并且代理可以将新事件的通知发送给他们，例如通过向其发送HTTP请求。\n<code>1. New user signs|\nup to Steveslist | v +-----------------+ +------------------------+ |Steveslist Server| +--&gt;+SendWelcomeEmailConsumer| +---------+-------+ | +------------------------+ | v\n2. Server reports| +-------------++ 4. Consumers send welcome\na NewUserSignup +----&gt;+Pub/Sub Broker| emails, check for spam,\nevent to the +-------------++ etc.\nPub/Sub system ^ 3. Pub/Sub broker | +------------------------+ notifies consumers +--&gt;+NewUserSpamCheckConsumer| that have subscribed to +------------------------+ NewUserSignup events.\n</code>\nPubsub系统具有许多优点：\n非关键操作是异步执行的，从而使用户体验保持活泼\n我们的代码保持整洁并分开。 发布事件的代码不必关心事件的订阅者会如何响应\n如果订阅者的操作由于某种原因而失败（例如，电子邮件发送系统出现打cup），则pubsub系统可以记录该失败，然后稍后重试\n接下来，让我们谈谈大数据。\n大数据与分析\n为了理解和优化我们的业务，我们需要能够在整个Steveslist平台上计算复杂的统计信息。 每天创建多少个列表，按国家和城市划分？ 每个月注册的用户中有90个在注册后90天内创建了一个列表？\n为此，我们需要编写汇总整个数据的数据库查询。 我们不希望对生产SQL数据库运行这些查询，因为它们可能会给数据库带来巨大的负担。 我们不希望内部分析师发出庞大的查询来使我们的生产数据库陷入停顿，但我们确实希望为这位分析师提供一种非常适合他们需求的工具。 更复杂的是，处理小型查询的数据库引擎（例如返回属于单个用户的所有列表）通常在回答大型查询（例如计算在每个类别的列表上花费的总费用）时会令人无法接受地缓慢（或实际上无能） ，过去90天内）。\n尽管如此，在Steveslist成立后的第一年左右，我们还是冒险了，只是对主要生产数据库运行了分析查询。 这是一场赌博，但这几乎奏效了。 无论如何，我们没有太多的数据，我们还有很多重要的事情要关注，例如吸引那些会创建大数据的客户，这有一天意味着我们必须找到一种更具可扩展性的解决方案。\n最终，我们确实通过一个过于雄心勃勃的查询关闭了生产数据库，并决定该花时间投资数据仓库了。 数据仓库是非常适合大型系统范围查询的数据存储。 我们的仓库由称为Hive的数据库引擎提供动力，但我们也可以选择Presto，Impala，Redshift或任何其他竞争性替代品。 Hive接受用SQL编写的查询，但是与我们的MySQL数据库相比，它对巨型数据集执行这些查询要好得多。\n我们每天一次，隔夜将数据从生产SQL数据库复制到Hive。 Steveslist分析人员和程序员可以使用最适合他们需求的数据库引擎来查询同一数据集。 他们可以将生产SQL数据库用于来自生产系统的小型，精确，真实的查询。 Elasticsearch用于全文搜索查询； 或用于大型查询的数据仓库，这些查询聚集在大量数据上。\n外面很黑，你饿了。 那差不多吗？ 你问。\n凯特回答：“哦，天哪，我们可以永远继续前进。 但这是一个很好的开始。 对广泛的主题有广泛的了解是有帮助的，但是没有人需要了解所有细节。 我发现，一旦您了解了一些基础知识，就可以继续学习更多基础知识，甚至还有一些细节。”\n您问凯特（Kate）明天是否可能继续阐述她对Steveslist的五年愿景。\n“绝对。”凯特说。 我们将讨论在一个真正的大型在线平台内发生的更多事情，包括：”\n安全\nHTTPS和其他形式的加密\n两因素验证\nSAML\n密钥管理\n服务器管理\n部署新代码\nAWS和竞争对手\n地貌\n负载均衡器\n货柜\n在代码中断时发出警报\n大数据\n地图缩减和其他大数据作业\n机器学习\n用户跟踪\n“明天早上7点见？”\n在Twitter或RSS上关注我\n获取发送给您的新文章\n订阅我有关编程，安全性和其他一些主题的新工作。 一个月发表几次。\n新：还订阅我的新系列，《面向高级初学者的编程反馈》\n有关面向高级初学者的编程项目的更多信息\nPFAB＃13：当代码太聪明以至于无法清理时\nPFAB＃11：分离逻辑和数据\nPFAB＃10：一流的功能和依赖注入\nPFAB＃9：批处理与流处理\nPFAB＃8：输入验证-便利与惊喜之间的权衡\nPFAB＃7：如何编写库\nPFAB＃6：实际调试实践\nPFAB＃5：如何使程序更短\nPFAB＃4：异常处理和应对失败\nPFAB＃3：如何严格分析您的工作旅程\nPFAB＃2：如何构建程序\nPFAB＃1：定义边界\n面向高级初学者的编程反馈＃0\n我会就您的代码给您反馈\n面向高级初学者的编程项目＃6：用户登录\n面向高级初学者的真实编程项目\n高级初学者＃1的编程视频：战舰\n面向高级初学者的开源软件＃1：bashplotlib\n面向高级初学者的开源\n初学者的想法真的像\n面向高级初学者的编程项目\n面向高级初学者的编程项目＃5：Snake\n面向高级初学者的编程项目＃4：Photomosaics\n面向高级初学者＃3b的编程项目：井字游戏AI\n面向高级初学者＃3a的编程项目：井字游戏AI\n高级初学者＃2的编程项目：生活游戏\n高级初学者＃1的编程项目：ASCII艺术\n如何通过使iPhone变差使自己更快乐\n数百家公司对通过其服务发送的所有创意主张使用权▶\n主页/存档/ RSS / Twitter /办公时间/ Tipoffs / SoundCloud /\n"}

{"l":"https://robertheaton.com/2020/04/06/systems-design-for-advanced-beginners/","n":"Systems design for advanced beginners","html":"\n    <header>\n  <div class=\"container\" style=\"margin-top: -25px\">\n    <h1 style=\"position: relative; top: 10px;\">\n      <a href=\"/\">Robert Heaton</a>\n    </h1>\n    <br>\n\n    <p class=\"tagline\" aria-hidden=\"true\">\n      Software Engineer / One-track lover / Down a two-way lane\n    </p>\n\n    <nav role=\"navigation\" style=\"margin-top: -5px\">\n      <ul>\n        <li><a href=\"/about\">About</a></li>\n        <li><a href=\"/archive\">Archive</a></li>\n        <li><a href=\"https://twitter.com/RobJHeaton\">Twitter</a></li>\n        <li><a style=\"color: #f92672;\" href=\"https://advancedbeginners.substack.com\">NEW: Programming Feedback for Advanced Beginners</a></li>\n      </ul>\n    </nav>\n  </div>\n</header>\n\n    <div class=\"container site\">\n      <section class=\"post blogpost\">\n        <h1 class=\"subject\"><a href=\"/2020/04/06/systems-design-for-advanced-beginners/\">Systems design for advanced beginners</a></h1>\n        <div class=\"date muted\">06 Apr 2020</div>\n        <blockquote>\n  <p>This post is part of my <a href=\"https://advancedbeginners.substack.com/\">Programming for Advanced Beginners series</a>. <a href=\"https://advancedbeginners.substack.com/\">Subscribe now</a> to receive specific, actionable ways to make your code cleaner, every other week, entirely free.</p>\n</blockquote>\n\n<p>You’ve started <a href=\"https://robertheaton.com/2018/07/09/how-tinder-keeps-your-location-a-bit-private/\">yet another</a> <a href=\"https://robertheaton.com/2017/10/09/tracking-friends-and-strangers-using-whatsapp/\">company</a> with your good friend, Steve Steveington. It’s an online marketplace where people can buy and sell things and where no one asks too many questions. It’s basically a rip-off of Craigslist, but with Steve’s name instead of Craig’s.</p>\n\n<p><img src=\"/images/systems-cover.png\"></p>\n\n<p>You’re going to be responsible for building the entire Steveslist technical platform, including all of its websites, mobile apps, databases, and other infrastructure. You’re excited, but also very nervous. You figure that you can probably cobble together a small website, since you’ve done that a few times before as part of your previous <a href=\"https://robertheaton.com/2018/07/09/how-tinder-keeps-your-location-a-bit-private/\">entertaining</a>-<a href=\"https://robertheaton.com/2017/10/09/tracking-friends-and-strangers-using-whatsapp/\">if</a>-<a href=\"https://robertheaton.com/2014/12/08/fun-with-your-friends-facebook-and-tinder-session-tokens/\">morally</a>-<a href=\"https://robertheaton.com/2016/10/22/a-tale-of-love-betrayal-social-engineering-and-whatsapp/\">questionable</a> <a href=\"https://robertheaton.com/2019/01/15/a-brief-history-of-wi-fi-privacy-vulnerabilities/\">escapades</a> with the Stevester. But you have no idea how to even start building out all of the other infrastructure and tools that you assume lie behind large, successful online platforms.</p>\n\n<p>You are in desperate need of a detailed yet concise overview of how real companies do this. How do they store their data? How do their different applications talk to each other? How do they scale their systems to work for millions of users? How do they keep them secure? How do they make sure nothing goes wrong? What are APIs, webhooks and client libraries, when you really get down to it?</p>\n\n<hr>\n\n<p>You send a quick WhatsApp to your other good friend, Kate Kateberry, to see if she can help. You’ve <a href=\"https://robertheaton.com/2019/01/15/a-brief-history-of-wi-fi-privacy-vulnerabilities/\">worked together very effectively in the past</a>, and she has decades of experience creating these types of systems at Silicon Valley’s biggest and most controversial companies.</p>\n\n<p>She instantly accepts your job offer. You had actually only been ringing for some rough guidance and a good gossip, but you nonetheless instantly accept her acceptance. No point looking a gift horse in the mouth, even when you don’t have any money to pay her. Kate proposes that her first day be 5 weeks ago in order to help her smooth over some accounting irregularities. She can come into the office sometime next week. You feel encouraged and threatened by her eagerness.</p>\n\n<hr>\n\n<p>Kate bounces into your offices in the 19th Century Literature section of the San Francisco Public Library. “OK let’s do this!” she shouts quietly. “What have we got so far? How are all our systems set up? What’s the plan?” You lean back in your chair and close your laptop, which was not turned on because you have left your charger at home. You steeple your fingers in a manner that you hope can be described as “thoughtful”.</p>\n\n<p>“Let me flip that question around, Kate. What do <em>you</em> think the plan should be?”</p>\n\n<p>Kate takes a deep breath and paints an extremely detailed vision of the Steveslist platform five years into the future and the infrastructure that will power it.</p>\n\n<hr>\n\n<p>Before we start (says Kate), I want to make it clear that I’m not saying that any of this is necessarily the “right” way to set up our infrastructure. If someone you trust more than me says something different then you should probably do what they say. There are many tools out there, each with different strengths and weaknesses, and many ways to build a technology company. The real, honest reasons that we will make many of our technological choices will be “we chose X because Sara knows a lot about X” and “we chose Y on the spur of the moment when it didn’t seem like a big decision and we never found the time to re-evaluate.”</p>\n\n<p>Nonetheless, let’s fast-forward five years into the future. Now Steveslist has two main consumer-facing products:</p>\n\n<ul>\n  <li>The Steveslist web app</li>\n  <li>The Steveslist smartphone apps</li>\n</ul>\n\n<p>These are the main ways in which users directly interact with the Steveslist platform. In addition, we also provide an API that allows programmers to build power-tools on top of the Steveslist platform that, for example, create listings for hundreds of items programmatically. To support this, we offer:</p>\n\n<ul>\n  <li>A Steveslist API</li>\n  <li>Steveslist API <em>client libraries</em> that make it easy for programmers to write code that talks to our API</li>\n</ul>\n\n<p>Here, I’ll draw a diagram on the whiteboard:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>+-----------+   +--------------+   +-----------------+\n|Web Browser|   |Smartphone App|   |Client Libraries/|\n+-----+-----+   +------+-------+   |Other API code   |\n      |                |           +-------+---------+\n      |                v                   |\n      |          +-----+------+            |\n      +---------&gt;+ Steveslist +&lt;-----------+\n                 |  Servers   |\n                 +------------+\n</code></pre></div></div>\n\n<p>Finally, we have many, many services running in the background that provide the data and power to these external-facing applications:</p>\n\n<ul>\n  <li>Webhooks - to notify users when something happens to their account, such as “order placed”</li>\n  <li>User password authentication - to securely log users in</li>\n  <li>SQL database - the main Steveslist data store. Needs to be highly scalable and reliable</li>\n  <li>Free-text searching system - to power the search box where people can look for broad search terms like “TVs” or “motorbikes”</li>\n  <li>Internal tools - to help us administer the Steveslist platform, and to take actions like issuing sternly-worded warnings to malicious users</li>\n  <li>Cron jobs - to run regular tasks that do anything from generating invoices, to billing customers, to sending as much of our users’ data as possible to third-party ad networks</li>\n  <li>“Pubsub” system - to allow us to take asynchronous actions on different trigger events (such as “when a new user signs up, send them a welcome email”)</li>\n  <li>Big data analytics system - to allow us to run enormous queries over the entirety of Steveslist’s data</li>\n  <li>And many more that we’ll talk about another day</li>\n</ul>\n\n<p>Let’s go through each of these systems in turn. <a href=\"https://robertheaton.com/about/\">Let me know</a> if anything isn’t clear, if you have any questions, or if you think I’ve got something wrong.</p>\n\n<h2 id=\"before-we-start---what-is-a-server-really\">Before we start - what is a server really?</h2>\n\n<p>Before we start, let’s define some important terms. In fact, let’s just define one. We’re going to talk a lot about “servers” today. But what is a server, when you really get down to it?</p>\n\n<p>For our purposes, a server is a computer that runs on a network and listens for communications from other computers. When it receives some data from another computer it performs some sort of action in response and - usually - sends back some data of its own. For example, a web server listens on a network for HTTP requests and sends back webpages and information in response. A database server listens for database queries and reads and writes data to the database that it is running.</p>\n\n<p>This brief description skips out entire degrees and careers of detail, and there are of course far more precise and accurate ways to define the word “server”. But this should get us through until dinnertime. What did you say? What’s a “network” really? A good question for another day.</p>\n\n<p>Now we’re ready to talk about the Steveslist platform.</p>\n\n<h2 id=\"steveslist-web-app\">Steveslist web app</h2>\n\n<p>This is the main Steveslist product. It’s just a normal web app, very similar to any website that you’ve built before, except much bigger. It’s a modern “single-page app” (SPA). The “single” in “single-page app” refers to the fact that the user’s browser almost never has to fully reload the page as the user clicks around our site. Instead, when the browser makes its first <em>HTTP request</em> to our servers, we send it back a basic, skeleton HTML page and a big pile of <em>JavaScript</em> code. This JavaScript code executes inside the browser, and updates the view of the page in response to the user’s actions. When the JavaScript wants to send or retrieve data from Steveslist, it sends an Asynchronous JavaScript XML Request (almost always called AJAX for short) in the background to a URL. When our server responds, the JavaScript uses the response to update the browser view accordingly.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>+----------+1.User's browser visits steveslist.com. +----------+\n|          |  It sends an HTTP request to the       |          |\n|          |  Steveslist servers                    |          |\n|          +---------------------------------------&gt;|          |\n|User's Web|                                        |Steveslist|\n| Browser  |2.Steveslist server responds with a     | Servers  |\n|          |  skeleton HTML page that instructs the |          |\n|          |  browser to request additional         |          |\n|          |  JavaScript files.                     |          |\n|          |&lt;---------------------------------------+          |\n|          |                                        |          |\n|          |3.User's browser requests and receives  |          |\n|          |  these JavaScript files from the       |          |\n|          |  Steveslist server.                    |          |\n|          +---------------------------------------&gt;|          |\n|          |&lt;---------------------------------------+          |\n|          |                                        |          |\n|          |4.User's browser executes the JavaScript|          |\n|          |  code. The code sends more requests for|          |\n|          |  the user's data to the Stevelist      |          |\n|          |  server, and updates the browser UI to |          |\n|          |  display it.                           |          |\n|          +---------------------------------------&gt;|          |\n|          |&lt;---------------------------------------+          |\n+----------+                                        +----------+\n</code></pre></div></div>\n\n<p><code class=\"language-plaintext highlighter-rouge\">robertheaton.com</code> is not a single-page app. Whenever you click on a link, the browser has to reload the entire page. <code class=\"language-plaintext highlighter-rouge\">twitter.com</code> <em>is</em> a single-page app. Whenever you click on a link, the browser dynamically updates a small portion of tthe page without forcing a full refresh.</p>\n\n<p>SPAs are a lot of work to build and maintain, but they sure look good.</p>\n\n<h2 id=\"steveslist-smartphone-apps\">Steveslist smartphone apps</h2>\n\n<p>We provide Steveslist smartphone apps for both iOS and Android. They are conceptually very similar to our single-page web app. Both our smartphone and web apps make HTTP requests to our servers. Then our servers receive these requests, do some work and return an HTTP response. Finally, both our smartphone and web apps update their display in order to communicate with the user.</p>\n\n<p>Since our smartphone apps are performing the same operations as the web app (for example, create listing, send message, etc), they can usually even send their requests to the exact same URLs as the web app. The only extra work that we have to do is to develop the frontends of the apps themselves. Some frameworks even make it possible to write mobile apps using JavaScript, allowing you to reuse code and logic across platforms.</p>\n\n<h2 id=\"steveslist-api\">Steveslist API</h2>\n\n<p>We allow users and third-parties to write code that programmatically interacts with our platform. In the same way that people can use the Twitter API to write code that reads; likes; and creates Tweets, we allow them to use the Steveslist API to search; buy; and list items.</p>\n\n<p>Programmers use our API by writing code that makes HTTP requests to our <em>API endpoints</em>. For example, in order to retrieve a list of all their listings, the programmer sends an HTTP <code class=\"language-plaintext highlighter-rouge\">GET</code> request to <code class=\"language-plaintext highlighter-rouge\">api.steveslist.com/v1/listings</code>. We respond with the data they requested, formatted as <em>JSON</em>. JSON stands for JavaScript Object Notation, but JSON is not specific to JavaScript and can easily be interpreted by any programming language. A JSON response to a request to retrieve all of a user’s listings might look something like this:</p>\n\n<div class=\"language-javascript highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"p\">{</span>\n  <span class=\"dl\">\"</span><span class=\"s2\">listings</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"p\">[</span>\n    <span class=\"p\">{</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">id</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">2178123867</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">name</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">Stolen TV</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">country</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">US</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">city</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">San Francisco</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">price_amount</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">1000</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">price_currency</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">usd</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"err\">#</span> <span class=\"nx\">etc</span><span class=\"p\">...</span>\n    <span class=\"p\">},</span>\n    <span class=\"p\">{</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">id</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">182312679</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">name</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">Stolen Bicycle</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">country</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">US</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">city</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">San Francisco</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">price_amount</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">2000</span><span class=\"p\">,</span>\n      <span class=\"dl\">\"</span><span class=\"s2\">price_currency</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">usd</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n      <span class=\"err\">#</span> <span class=\"nx\">etc</span><span class=\"p\">...</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>This structured response format is very easy for a program to parse, which means that the code that made the request can trivially interpret and use the data from our API.</p>\n\n<p>Users identify or <em>authenticate</em> themselves to our API using an API key. This is, roughly speaking, the API equivalent of a password. It is a long, random string that we generate and display on a user’s “Settings” page. Users include their API key as an <em>HTTP header</em> with every HTTP request that they (or their code) makes to the API. When we receive an API request we check to see whether the attached API key corresponds to a Steveslist user. If it does then we perform the request on behalf of that user.</p>\n\n<p>If a programmer wants to, they can manually build HTTP requests to our API themselves, using their language’s standard HTTP library. For example, in Python they might write:</p>\n\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">import</span> <span class=\"nn\">requests</span>\n\n<span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"s\">'https://api.steveslist.com/v1/listings/'</span>\n<span class=\"n\">listing_params</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"s\">\"name\"</span><span class=\"p\">:</span> <span class=\"s\">\"Stolen TV\"</span><span class=\"p\">,</span>\n  <span class=\"s\">\"country\"</span><span class=\"p\">:</span> <span class=\"s\">\"US\"</span><span class=\"p\">,</span>\n  <span class=\"s\">\"city\"</span><span class=\"p\">:</span> <span class=\"s\">\"San Francisco\"</span><span class=\"p\">,</span>\n  <span class=\"s\">\"price_amount\"</span><span class=\"p\">:</span> <span class=\"mi\">1000</span><span class=\"p\">,</span>\n  <span class=\"s\">\"price_currency\"</span><span class=\"p\">:</span> <span class=\"s\">\"usd\"</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n<span class=\"n\">api_key</span> <span class=\"o\">=</span> <span class=\"s\">\"YOUR_API_KEY_GOES_HERE\"</span>\n\n<span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">post</span><span class=\"p\">(</span>\n  <span class=\"n\">url</span><span class=\"p\">,</span>\n  <span class=\"n\">data</span><span class=\"o\">=</span><span class=\"n\">listing_params</span><span class=\"p\">,</span>\n  <span class=\"n\">headers</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s\">\"X-Steveslist-API-Key\"</span><span class=\"p\">:</span> <span class=\"n\">api_key</span><span class=\"p\">},</span>\n<span class=\"p\">)</span>\n</code></pre></div></div>\n\n<p>However, we make life easier for programmers by providing <em>client libraries</em>.</p>\n\n<h2 id=\"steveslist-client-libraries\">Steveslist client libraries</h2>\n\n<p>A client library is a library that “wraps” the functionality of the Steveslist API. This means that anyone using the client library doesn’t need to know anything about the fine details of the Steveslist API. Instead, they can just write:</p>\n\n<div class=\"language-python highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"kn\">import</span> <span class=\"nn\">steveslist</span>\n\n<span class=\"n\">listing</span> <span class=\"o\">=</span> <span class=\"n\">steveslist</span><span class=\"o\">.</span><span class=\"n\">Listing</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span>\n  <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s\">\"Stolen TV\"</span><span class=\"p\">,</span>\n  <span class=\"n\">country</span><span class=\"o\">=</span><span class=\"s\">\"US\"</span><span class=\"p\">,</span>\n  <span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s\">\"San Francisco\"</span><span class=\"p\">,</span>\n  <span class=\"n\">price_amount</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"p\">,</span>\n  <span class=\"n\">price_currency</span><span class=\"o\">=</span><span class=\"s\">\"usd\"</span><span class=\"p\">,</span>\n  <span class=\"n\">api_key</span><span class=\"o\">=</span><span class=\"s\">\"YOUR_API_KEY_GOES_HERE\"</span>\n<span class=\"p\">)</span>\n</code></pre></div></div>\n\n<p>Our libraries turn the parameters that they are given into appropriately formatted HTTP requests, which they send to the Steveslist API as normal. We’ve written client libraries for every major programming language that we could think of, and they are by far the most common way that people interact with our API.</p>\n\n<h2 id=\"webhooks\">Webhooks</h2>\n\n<p>We’ve seen how Steveslist users can use our API to programmatically interact with their account. In addition, many users also want <em>us</em> to proactively tell <em>them</em> whenever something happens to their Steveslist profile. For example, suppose that someone wanted to fully automate the process of selling items on Steveslist. Whenever a customer pays for an item using our new, mostly-secure StevePay system, they want to send the customer a thank you email and automatically instruct their warehouse to ship a stolen TV to the order address. Our seller could constantly and repeatedly query the Steveslist API asking “Any new sales? Any new sales?” However, this would be very inefficient, and would put a lot of unnecessary load on our servers.</p>\n\n<p>Instead, we provide an industry standard system called <em>webhooks</em>. A webhook is an HTTP request that we send to our users whenever something interesting happens to their account. It contains all the data describing the event that just happened - for example, the item ID, the price, the buyer ID, buyer address, and so on. Webhooks allow users to automatically perform response actions, such as the aforementioned email and auto-shipping.</p>\n\n<p>To use webhooks, the user tells us the URL to which they would like us to send their webhooks (for example, <code class=\"language-plaintext highlighter-rouge\">steveslistwebhooks.robertheaton.com</code>. They set up a web server at that URL that will receive and action these webhook notifications.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>1.Buyer purchases an      3.The seller's server receives the webhook,\n  item as normal.           and uses the information in it to\n                            automatically process the order.\n+---------------+           +-----------------+\n|Buyer's Browser|           |Seller's Webhook-+\n+------+--------+           |Receiving Server |\n       |                    +------+----------+\n       |                           ^\n       |                           | \n       |                           |   \n       |    +-----------+          |\n       +---&gt;+ Steveslist+----------+\n            |   Server  |\n            +-----------+\n       2.Once the transaction has been completed,\n         Steveslist looks up the seller's\n         webhook URL (if set). We then send\n         an HTTP request to this URL,\n         containing the details of the purchase.\n</code></pre></div></div>\n\n<p>The user deploys code on their web server that performs the appropriate response actions whenever it receives a webhook from us. We don’t only send webhooks when an item is purchased - we also send them when a user receives a message; when one of their items is removed by an admin; or when a buyer makes a complaint. This enables Steveslist sellers to automate not just the listing of items, but also the selling and shipping of them too.</p>\n\n<h3 id=\"webhook-complications\">Webhook complications</h3>\n\n<p>Webhooks come with two main complications - security and reliability. First, let’s talk security. The endpoint to which the seller instructs us to send their webhooks is accessible to anyone on the internet. Anyone who knows the URL can send it fake webhooks, and if our seller isn’t careful this could allow an attacker to trick them into, for example, sending the attacker free stuff. A seller’s webhook URL should be difficult to find, since the seller won’t publicize its existence, but obscurity is not the same as security.</p>\n\n<p>To allow our sellers to verify that a webhook really was sent by Steveslist, we <em>cryptographically sign</em> our webhook contents.</p>\n\n<h4 id=\"cryptographic-signing\">Cryptographic signing</h4>\n\n<p>Cryptographic signing is a deep and subtle topic. Here’s a condensed version of how we use it to secure our webhooks.</p>\n\n<p>When a seller enables webhooks for their account, we generate a random “shared secret key”. We tell the seller to copy this key over to their webhook-receiving server and keep it secure, so that its value is known only by us and the seller. Whenever we send a webhook, we take this shared secret, combine it with the contents of the webhook by using a <em>cryptographic hash function</em> called <em>HMAC</em>, and get back a long, random-seeming, but entirely deterministic “signature” for the webhook.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>Webhook contents   +----------+\n(eg. {\"id\": 123...})          |\n                              v\n                          +---+----------+\n                          |HMAC Algorithm|-----&gt;Webhook signature\n                          +---+----------+\n                              ^\nShared secret key             |\n(eg. 123mhu23jy8xdwgmd...)+---+\n</code></pre></div></div>\n\n<p>We include this signature in our webhook body, for example:</p>\n\n<div class=\"language-javascript highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"p\">{</span>\n  <span class=\"dl\">\"</span><span class=\"s2\">action</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">item_sold</span><span class=\"dl\">\"</span><span class=\"p\">,</span>\n  <span class=\"dl\">\"</span><span class=\"s2\">price</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">100</span><span class=\"p\">,</span>\n  <span class=\"c1\">// ...more params...</span>\n  <span class=\"dl\">\"</span><span class=\"s2\">signature</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">234gj98d49j834978gf39t78ndn98g7dq3ng897308y7</span><span class=\"dl\">\"</span>\n<span class=\"p\">}</span>\n</code></pre></div></div>\n\n<p>When the seller’s webhook-receiving server receives a webhook, it takes the shared secret and webhook contents and calculates what it expects the signature to be in exactly the same way that we did. It compares the result to the signature attached to the webhook; if they match then it accepts and processes the webhook. Since the signature can only be generated using the shared secret known only by us and the seller, the webhook-receiving server can be confident that the webhook was sent by us. If the signatures don’t match, however, the server rejects the webhook.</p>\n\n<p>Note that all of the signature verification code must be written and maintained by the sellers. We can provide them with encouragement and examples, but we can’t force them to verify signatures correctly, or even at all. For some real-world examples, look at how <a href=\"https://stripe.com/docs/webhooks/signatures\">Stripe</a> and <a href=\"https://developer.github.com/webhooks/securing/\">GitHub</a> sign their webhooks.</p>\n\n<h3 id=\"reliability\">Reliability</h3>\n\n<p>We also need to consider what happens when our webhooks go wrong and what guarantees we want to make to our users about them. If we try to send a webhook but can’t connect to the user’s server, what should we do? What if we successfully connect to their server and send the webhook, but their server sends back an error? What if we send the webhook but the server hangs for twenty seconds before disconnecting without telling us what happened?</p>\n\n<p>There are tradeoffs involved here that require clear communication and a surprising amount of infrastructure to manage. We at Steveslist choose to guarantee that we will deliver webhooks “at least once”. This means that if a webhook fails to send then we will keep trying (a large but not infinite number of times) until it does. If we’re not sure whether a webhook succeeded or failed, we will keep trying until we are sure that an attempt has succeeded. This might occasionally result in us sending the same webhook twice, but it’s the seller’s responsibility to have their code handle this gracefully instead of sending the same customer five stolen TVs instead of the one that they ordered.</p>\n\n<hr>\n\n<p>“What do you think so far?” asks Kate. “Is this roughly what you’ve been thinking?” You make a non-committal face and take a big bite of a nearby sandwich in order to preclude any further discussion. Kate continues:</p>\n\n<hr>\n\n<p>Let’s talk about the backend systems that will power some of our most important features.</p>\n\n<h2 id=\"user-authentication-via-a-password\">User authentication via a password</h2>\n\n<p>Most users sign into the Steveslist website and smartphone apps using a username and password. There are other ways of signing into the website, like <em>OAuth</em> - we’ll cover them another time.</p>\n\n<p>We will have to store our users’ passwords very securely. Not only is a user’s password the thing they use to sign in (or <em>authenticate</em>) to Stevelist, but for many users they’re probably the same password that they use to sign in to many other services too, despite all the warnings that this is a bad idea. They only have so many children with so many birthdays, after all.</p>\n\n<p>Rupert Herpton has written <a href=\"https://robertheaton.com/2019/08/12/programming-projects-for-advanced-beginners-user-logins/\">the seminal tutorial</a> on how to secure passwords, which I’m sure you’ve read already. Just in case you need a refresher, the crux of the matter is that we mustn’t ever store passwords in their original, <em>plaintext</em> form, anywhere. We mustn’t store them in plaintext in a database, in a log file, or in any other part of our system. Instead, before storing a password, we must first <em>hash</em> it using a <em>hash function</em> such as <em>bcrypt</em>.</p>\n\n<p>A hash function is a “one-way” function that takes an input and deterministically converts it into a new, seemingly-random string. Calculating a hash value from an input is computationally very easy, but reversing the transformation and recovering the original input from its hash value takes so much time and computing power that it is, practically-speaking, impossible.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>+---------+     Easy    +----------+\n|         |------------&gt;|          |\n|Plaintext|             |Hash value|\n|         |&lt;------------|          |\n+---------+ Essentially +----------+\n            Impossible\n</code></pre></div></div>\n\n<p>Since we only store the hash values of our users’ passwords, if a hacker somehow stole our password database (heaven forbid) (touch wood) then they would only be able to see the passwords’ hash values. They wouldn’t be able to easily turn these hash values back into <em>plaintext</em> passwords, meaning that they wouldn’t be able to use them to login to Steveslist, and they won’t be able to take advantage of all the people who re-use passwords across different services.</p>\n\n<p>Since we only store password hash values, when we want to check whether a login password that a user has given us is correct we first calculate its hash value, and compare the result to the hash value in our password database.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>                 +--------------+\n                 |User's Browser|\n                 +-----------+--+\n1.User attempts to  |        ^\nlog in:             |        |  3. Server logs the user in\n                    |        |  if password matches, and\n   username: steve  |        |  returns an error if it does not.\n   password: 12345  v        |  \n                 +--+--------+--+\n                 |  Steveslist  |\n                 |    Server    |\n                 +--------------+\n                        |\n2.Server computes       |     |username|password_hash|\nthe hash of the         |     +----------------------+\npassword and compares   +----&gt;+steve   |23jy7213y7jO |\nit to the value in the        |kate    |21897213hh21 |\ndatabase.                     |...     |...          |\n</code></pre></div></div>\n\n<p>As previously mentioned, we also have to be careful not to log passwords in any of our debug output. This can be an easy mistake to make - if you log all of the parameters of every HTTP request, just in case you need it, you will certainly be logging user passwords. Facebook logged passwords in plaintext for many years, and whilst it didn’t seem to affect their stock price I’m sure it made them feel pretty silly for a day or two.</p>\n\n<hr>\n\n<p>Kate pauses for breath. You pretend to take notes on your out-of-battery laptop.</p>\n\n<hr>\n\n<p>Let’s talk about infrastructure.</p>\n\n<h2 id=\"database-servers\">Database servers</h2>\n\n<p>Steveslist’s primary data store runs a common flavor of SQL database called <em>MySQL</em>. I won’t talk much about SQL here - the specifics of how it works aren’t too important, and you can find them on Google if you’re interested. Since we are so successful, we have a huge and growing amount of data to manage. We’ve started to become acutely aware that databases aren’t magic. They run on computers, just like any other program. As the volume of data in a database grows, the computer’s hard drive and memory starts to fill up. At the start of the company the easiest way to deal with this problem was to run our database on a single computer (or <em>machine</em>) with an enormous hard drive. But this could only stave off the problem for so long. Eventually our database contained more data than could be stored on any reasonable hard drive, and the database started to get slower and slower as we forced it to search through more and more records.</p>\n\n<p>We had to take an entirely new approach, and reconfigure our database to store its data on multiple computers. We did this using <em>sharding</em>.</p>\n\n<h3 id=\"sharding\">Sharding</h3>\n\n<p>Sharding a database means splitting its data into chunks (or “shards”) and storing each chunk on a separate machine. All of the machines that make up a database are together known as a <em>database cluster</em>. How you split data between machine in your cluster depends on your application and the types of operations you will be performing. For Steveslist we chose to split out our data by user. This means that all of the data for a given user is stored on the same machine. This includes their profile information, their listings, their messages, and so on. Data that doesn’t have a corresponding user (like “Deals of the Day”) can be sharded using a <em>shard key</em> other than user, or not sharded at all if the dataset is sufficiently small.</p>\n\n<p>This means that we need an extra “routing” layer in front of our database, which knows which database machine is able to service which queries. We could either make our <em>application servers</em> (the servers that execute our code) responsible for knowing the mapping of user IDs to database shards, or have a centralized “router” that all servers send their requests to, and which is responsible for working out the appropriate machine to forward the request on to. Both approaches have their advantages. Making application servers responsible for maintaining the mapping reduces the number of hops that a request has to make, speeding them up. But having a centralized router makes updating the shard mapping much easier, since you only have to update it in one place.</p>\n\n<p>If application servers are responsible for knowing the shard layout, we have a system that looks like this:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>            +          +          +\n            |          |          |\n            | Requests from users |\n            |          |          |\n            v          v          v\n     +------+----------+--------------------+\n     |            Application               |\n     |               Server                 |\n     |                                      |\n     |Database sharding config:             |\n     |* DB Server 1: IDs between 1-10000    |\n     |* DB Server 2: IDs between 10000-20000|\n     |* DB Server 3: IDs between 20000-30000|\n     +-+----------------+-----------------+-+\n       |                |                 |\n       |ID:501          |ID:15362         |ID:22361\n       |                |                 |\n       v                v                 v\n+-----------+     +-----------+     +-----------+\n|DB Server 1|     |DB Server 2|     |DB Server 3|\n+-----------+     +-----------+     +-----------+\n</code></pre></div></div>\n\n<p>If we have a centralized database router, we have a system that looks like this:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>            +          +          +\n            |          |          |\n            | Requests from users |\n            |          |          |\n            v          v          v\n     +------+----------+--------------------+\n     |            Application               |\n     |               Server                 |\n     |                                      |\n     |Database sharding config:             |\n     |* ??? Application Server has no idea  |\n     +------------+-----------+-------------+\n                  |           |\n      Application server sends all database\n      queries to the database router, which\n      forwards them to the correct shard.\n                  |           |\n                  v           v\n   +--------------+-----------+-------------+\n   |            Database router             |\n   |                                        |\n   |Database sharding config:               |\n   |* DB Server 1: IDs between 1-10000      |\n   |* DB Server 2: IDs between 10000-20000  |\n   |* DB Server 3: IDs between 20000-30000  |\n   +---+----------------+---------------+---+\n       |                |               |\n       |ID:501          |ID:15362       |ID:22361\n       |                |               |\n       v                v               v\n+-----------+    +-----------+   +-----------+\n|DB Server 1|    |DB Server 2|   |DB Server 3|\n+-----------+    +-----------+   +-----------+\n</code></pre></div></div>\n\n<p>How do we decide which database to assign each user to? However we want. We could start by saying that users with odd-numbered IDs are assigned to shard machine 1, and those with even-numbered ones are assigned to shard machine 2. We could hope that this random assignment results in balancing our data relatively evenly between our shards.</p>\n\n<p>However, it’s possible that we might have a small number of power users who create much, much more data than others. Maybe they create so much data that we want to allocate them a shard of their own. This is completely fine - we have complete control over how users are assigned to shards. Random assignments are usually easiest, but are by no means the only option. We can choose to assign users to shards randomly - except for user 367823, who is assigned to shard 15, which no other user is assigned to.</p>\n\n<p>If a shard gets too big and starts to fill up its machine’s hard-drive, we can split it up into multiple, smaller shards. How do we migrate the data to these new shards without having to turn off our platform for a while? Probably using a sequential process like:</p>\n\n<ol>\n  <li>“Double-write” new data to both the old and new shards. Continue reading data from the old shard</li>\n  <li>Copy over all existing data from the old shard to the new shard. Continue double-writing to old and new shards</li>\n  <li>Convince ourselves that the old and new shards contain the same data. We could do this by comparing snapshots of the databases, and/or by reading every query from both databases, comparing them, and alerting if the data is different</li>\n  <li>Once we’re confident that the new and old shards contain the same data, we switch to reading from the new shards. We continue double-writing in case we need to switch back</li>\n  <li>Once we’re confident that this step has been successful, stop double-writing and delete the old shard</li>\n</ol>\n\n<p>Rupert Herpton has written <a href=\"https://robertheaton.com/2015/08/31/migrating-bajillions-of-database-records-at-stripe/\">a great article about a broadly-similar type of migration</a> that goes into much more detail. In short, the process of migrating data between database shards is detailed and finicky, but also entirely doable and logical. Some types of database can even automatically take care of sharding for you.</p>\n\n<h3 id=\"replication\">Replication</h3>\n\n<p>We will take great care to make sure that our data doesn’t get accidentally deleted and our database servers don’t randomly stop working. But accidents happen, and sometimes computers do randomly stop working. To mitigate the fallout of a database-related disaster, we <em>replicate</em> our data across multiple machines in (close to) realtime.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>       Client writes new\n       data to DB Server A\n                |\n                v\n          +-----+-----+\n          |DB Server A|\n          ++---------++\n           |         | DB Server A quickly replicates\n           v         v the new data to DB Servers B and C\n+----------++      +-+---------+\n|DB Server B|      |DB Server C|\n+-----------+      +-----------+\n</code></pre></div></div>\n\n<p>Realtime replication has two main benefits. First, it means that if one of our database servers explodes, catches fire, or otherwise stops working, we have multiple almost-perfect copies of it that can seamlessly pick up the slack. In a straightforward, vanilla failure, users of our services may never know that anything has gone wrong. The second benefit of replication is that we can distribute queries for the same data across multiple database servers. If lots of users are asking to read data from the same database, we can split their queries up across all of our copies, meaning that we can handle more queries in parallel.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>  Clients can query the same data\n  from any of DB Servers A,B,or C\n    |  |    |   |   |    |  |\n    |  |    v   v   v    |  |\n    |  |  +-+---+---+-+  |  |\n    |  |  |DB Server A|  |  |\n    |  |  +-----------+  |  |\n    |  |                 |  |\n    v  v                 v  v\n+---+-------+      +-----+-+---+\n|DB Server B|      |DB Server C|\n+-----------+      +-----------+\n</code></pre></div></div>\n\n<p>Note that database replication is not the same concept as making database backups. Replication happens in (close to) realtime, and is designed to deal on-the-fly with isolated problems in your live (or <em>production</em>) systems. Database backups are performed on a schedule (for example, once a day), and the copies of the data are stored separately, away from production systems. Backups are designed as a final safeguard against widespread, catastrophic data loss, as might happen if all your data centers burned down.</p>\n\n<p>Pretend that you work in the call centre of a big bank, where people are constantly calling you up in order to send money transfers and ask about their current balance. Replication is the equivalent of hurriedly writing down transfer details into multiple books, as you receive them, just in case you lose one of the books. Making backups is the equivalent of photocopying those books once a day and storing the copies in your filing cabinet.</p>\n\n<h3 id=\"replication-1\">Replication</h3>\n\n<p>The process of replication is conceptually quite straightforward. Whenever new data is written to our database, we copy it to multiple machines. This means that if/when a machine fails we can continue querying its siblings, with no user-facing impact. It also means that we can spread our queries out across multiple copies of the same data, resulting in faster query response times.</p>\n\n<p>However, the details of how we do this are important, subtle, and situation-dependent. There’s no right way to do replication - as is so often the case, the exact approach that you take depends on the specific requirements and constraints of your system.</p>\n\n<p>Replication is complicated by two inconvenient facts about the real world. First, database operations randomly fail sometimes. When we attempt to replicate our data from one server to another, things <em>will</em> occasionally go wrong, causing our machines to become out of sync, at least for a period. Second, even in periods of smooth operation, replication is not instantaneous. When new data is written to our database cluster, some servers in the cluster will always know about the update sooner than others. When choosing a replication strategy we must be aware of these limitations and how they impact our particular application. For example, maybe it’s OK to risk the number of “likes” on a post being slightly out of sync and out of date, but not the amount of money in a user’s bank account.</p>\n\n<p>One of the biggest decisions we must make when choosing a replication strategy is whether we want our replication to be <em>synchronous</em> or <em>asynchronous</em>.</p>\n\n<h3 id=\"asynchronous-vs-synchronous-replication\">Asynchronous vs synchronous replication</h3>\n\n<p>Replication can be handled either synchronously or asynchronously. These words come up in a lot of different places in systems design, but they always fundamentally mean the same thing. If an action is performed “synchronously” then this means that it is performed while something waits for it. If you wanted to send a letter synchronously then you would got to the Post Office, give your letter to a postal worker, sit and wait in the corner of the Post Office for a few days, and only go home when the postal worker confirmed that your letter had arrived safely.</p>\n\n<p>By contrast, if an action is performed “asynchronously” then this means that the initiator of the action doesn’t wait around for it to be finished. Instead, they just continue with the rest of their work while the action is worked on in the background. The real Postal Service is asynchronous; you give your letter to a postal worker, then leave and continue with your life while the Postal Service delivers your letter. Asynchronous actions can send back notifications of the outcome of the action if they want (“Your letter has arrived and was signed for” or “Mr. Heaton, your dry-cleaning is ready”), but they don’t have to.</p>\n\n<p>How do these principles apply to database replication? In synchronous replication a client writes its new data to a database server and then waits. This server doesn’t tell the client whether their write has been completed successfully until it has finished fully replicating the client’s data across all of its sibling servers. Then, and only then, does the client continue executing the rest of its code.</p>\n\n<p>In asynchronous replication the client writes its data to the first database server, as before. But this time the first server tells the client that the write was successful as soon as it has written the data to its own data store. It kicks off the replication process in the background, and doesn’t wait for it to complete, or even start, before it tells the client that the write was successful. This means that the asynchronous operation appears much faster than the synchronous one, because the client doesn’t have to wait for all the replication to complete before it can continue on with the rest of its work. However, if the background replication fails then the client will believe that it has successfully written its data to the database when it actually has not. This could cause problems, the imagination of which is left as an exercise for the reader.</p>\n\n<p>The synchronous approach is slower but “safer” than an asynchronous approach. The database never claims to have successfully received and stored any data until it has finished every single step of doing so. Because the client waits for full confirmation before proceeding, it is guaranteed to never encounter a situation where the client believes that it has written some data to the database, but the database has secretly partially dropped the data on the floor.</p>\n\n<p>Which approach is better? It depends. Do you care more about speed or correctness? Is it OK to occasionally have inconsistent data if it significantly speeds up the system’s operation? Or will even a single mistake cause airplanes to start falling out of the sky?</p>\n\n<p>Database replication systems face other interesting problems too. Many of these problems are “logical” rather than “technical”, and don’t require a detailed understanding of the complex software and networking protocols underlying the system. To help picture some of them, imagine that you’re back in the call centre from a few paragraphs ago. You work with many other colleagues. Together you play the role of database servers. People call you up to transfer money and ask about their current balance. You and your colleagues write information about new transfers down on paper, and replicate it between yourselves by calling each other up.</p>\n\n<p>The problems faced by our database cluster are identical to those faced by our call-centre. What happens if two people call in and try to update the same piece of data at the same time by talking to two different employees? Maybe we solve that by having a “leader” employee who is the only one authorized to serve calls from people trying to create transfers. All the other employees are only allowed to answer queries about current balances. OK, so what happens if the leader has a stroke and dies after they’ve received some new data, but before they’ve told everyone else about it? What if a “follower” employee has a temporary seizure for a few seconds and misses some data updates from the leader? What if we’re never entirely sure which of our employees are dead or alive?</p>\n\n<p>This is not an approximate metaphor that breaks down if you look too hard or start asking awkward questions. Understand this weird call-centre and you understand database replication. <a href=\"https://www.brianstorti.com/replication/\">Read this blog post</a> and you <em>really</em> understand replication.</p>\n\n<h3 id=\"backups\">Backups</h3>\n\n<p>In addition to realtime replication, we also store regular backups of our entire database in order to protect against catastrophic disaster. We copy all of the data in our database, store it somewhere safe, and mark it as something like “database backup, 2020-05-11:01:00”.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>+----------+  \n| Database +----------------&gt; database backup, 2020-05-11:01:00\n+----------+                  database backup, 2020-05-10:01:00\n                              database backup, 2020-05-09:01:00\n</code></pre></div></div>\n\n<p>If our entire database - or some fraction of it - somehow gets wiped out, we grab the most recent backup available and load it into new database machines.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>+----------+\n|   New    |\n| Database +&lt;---------------- database backup, 2020-05-11:01:00\n+----------+                  database backup, 2020-05-10:01:00\n                              database backup, 2020-05-09:01:00\n</code></pre></div></div>\n\n<p>Such a calamity could be caused by a cyberattack, a disaster in our data centre, a database migration gone horribly wrong, or any number of unlikely but potentially company-destroying reasons. Unlike realtime replication, restoring a database from a backup is a slow process that our users will definitely notice. Our entire system will likely be offline until the restoration is complete. We will have lost all database updates that occurred after the last backup but before the disaster. And there will no doubt be a large number of knock-on effects as users and systems try to access data that used to be there but is now lost forever. Nonetheless, these are all much less terrible than the complete, irrevocable loss of all our company’s data and with it, our company.</p>\n\n<p>That’s a whole lot of detail about our primary SQL database. Let’s talk about some other ways in which we store and query data.</p>\n\n<h2 id=\"free-text-searching\">Free-text searching</h2>\n\n<p>A standard SQL database is very good at answering well-defined and specific queries. For example:</p>\n\n<ul>\n  <li>Give me all the item listings created by user #145122 in the last 90 days</li>\n  <li>Give me the listing details for item #237326921</li>\n  <li>Give me the count of new listings per day created in San Francisco with the label “Electronics”</li>\n</ul>\n\n<p>You can retrieve this kind of data using SQL queries that look something like this:</p>\n\n<div class=\"language-sql highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span>\n  <span class=\"n\">user_id</span> <span class=\"o\">=</span> <span class=\"mi\">145122</span> <span class=\"k\">AND</span>\n  <span class=\"n\">created</span> <span class=\"o\">&gt;</span> <span class=\"n\">currentDate</span><span class=\"p\">()</span> <span class=\"o\">-</span> <span class=\"mi\">90</span>\n</code></pre></div></div>\n\n<p>or</p>\n\n<div class=\"language-sql highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">SELECT</span>\n  <span class=\"n\">DATE_TRUNC</span><span class=\"p\">(</span><span class=\"s1\">'day'</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">created</span><span class=\"p\">)</span> <span class=\"k\">AS</span> <span class=\"k\">day</span><span class=\"p\">,</span>\n  <span class=\"k\">COUNT</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span> <span class=\"k\">AS</span> <span class=\"n\">i</span>\n<span class=\"k\">INNER</span> <span class=\"k\">JOIN</span> <span class=\"n\">labels</span> <span class=\"k\">as</span> <span class=\"n\">l</span>\n  <span class=\"k\">ON</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">id</span> <span class=\"o\">=</span> <span class=\"n\">l</span><span class=\"p\">.</span><span class=\"n\">item_id</span>\n<span class=\"k\">WHERE</span>\n  <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">city</span> <span class=\"o\">=</span> <span class=\"s1\">'San Francisco'</span> <span class=\"k\">AND</span>\n  <span class=\"n\">l</span><span class=\"p\">.</span><span class=\"nb\">text</span> <span class=\"o\">=</span> <span class=\"s1\">'electronics'</span>\n<span class=\"k\">GROUP</span> <span class=\"k\">BY</span> <span class=\"mi\">1</span>\n<span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"mi\">1</span> <span class=\"k\">DESC</span>\n</code></pre></div></div>\n\n<p>You’ll notice that these queries contain a lot of very “precise” operators, like equals- and greater-than-signs. But how would you write a SQL query that could return a list of items that match a Google-style “full-text” search, like “second-hand TV”?</p>\n\n<p><img src=\"/images/systems-design-search.png\"></p>\n\n<p>This would be difficult. You could try the SQL <code class=\"language-plaintext highlighter-rouge\">LIKE</code> operator, which allows you to find records containing a pattern, such as a sub-string. For example, the following query finds all items with a description containing the sub-string <code class=\"language-plaintext highlighter-rouge\">second-hand TV</code>:</p>\n\n<div class=\"language-sql highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second-hand TV%'</span>\n</code></pre></div></div>\n\n<p>However, this query will only match the very specific sub-string that it was given. It won’t match “TV that is second-hand” or “2nd-hand TV”, or “sceond-hnad TV”. Given enough perseverance you could theoretically construct a giant SQL-query that covered as many of these permutations as you had patience for:</p>\n\n<div class=\"language-sql highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span>\n  <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second%hand%TV'</span> <span class=\"k\">OR</span>\n  <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second%TV%hand'</span> <span class=\"k\">OR</span>\n  <span class=\"c1\">-- …and so on and so on for another bajillion ORs…</span>\n</code></pre></div></div>\n\n<p>However, the resulting query would be slow and cumbersome, and would still miss many important edge-cases that you hadn’t thought of. And even if you did get back a useful list of search results, you’d still have a lot of work left to do in order to decide how to order them. The ordering you want isn’t something strict like “most-recent first” or “alphabetically by title”. Instead it’s some much woolier notion of “best” or “most-relevant” first.</p>\n\n<p>All of this means that SQL databases are generally not very good at full-text searches. Fortunately, other types of database are, including one called <em>Elasticsearch</em>. Elasticsearch is often described as a <em>document-oriented database</em>. We don’t need to go into the details of how exactly it works, but the important part for us is that, unlike SQL databases, Elasticsearch is very good at taking queries like “second-hand TV” and returning a list, ordered by “relevance,” of the fuzzy matches that users have come to expect from their search engines.</p>\n\n<p>“Sounds like Elasticsearch is just better than SQL,” you might say. “Should we throw away our SQL databases and put everything in Elasticsearch instead?” Not so fast. Elasticsearch, and other databases like it, have their strengths, but they also have their weaknesses. They’re typically somewhat less reliable than SQL databases, and are somewhat more likely to accidentally lose data at large scale. They’re also often much slower to write new data to.</p>\n\n<p>As we’ve already noted, there’s rarely a single, universally “best” tool for any type of job. There’s certainly no such thing as “the best” database. Instead, different databases have different strengths and weaknesses, and different solutions are appropriate for different tasks. At Steveslist, we care so much about making sure that we use the right tool for the right job that we store our data in both a SQL database <em>and</em> a document-oriented database like Elasticsearch.</p>\n\n<p>We use our SQL database as our primary data store. It is our authoritative “source-of-truth”, and we write all our new data to it before we write it anywhere else. We do all our simple, precise reads from it, especially when accuracy and up-to-date-ness are our principal requirements. If we want to show a user a list of all their open listings, we read it from our SQL database. If we want to validate a users password, we read that from our SQL database too. This plays to the strengths of SQL databases.</p>\n\n<p>However, in the background we also copy data from our SQL database into an Elasticsearch database, and send any full-text search queries made via our search box to Elasticsearch. This means that we benefit from the strengths of Elasticsearch, and are not impacted too much by its weaknesses. We copy over batches of records every few minutes, hours, or days, depending on the requirements of the specific dataset. Alternatively, we could watch the logs of our SQL database for new or updated records, and create or update the corresponding Elasticsearch records in near-realtime.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>                   |      |                   |\nNew data is always |      |Queries for        |Full-text search \nwritten to the SQL |      |specific data go   |queries go to\nDB first           |      |to the SQL DB too  |Elasticsearch\n                   V      V                   V\n               +--------------+       +---------------+\n               | SQL Database +------&gt;+ Elasticsearch |\n               +--------------+       +---------------+\n                       New data is copied over from\n                       the SQL DB to Elasticsearch\n</code></pre></div></div>\n\n<p>When scouting Steveslist’s competition, I noticed that when you create a new Craigslist listing it says “your listing will be visible in search within the next 15 minutes”. I’ll bet pesos to pizza that this is because their primary datastore is a SQL database, but their search box is powered by an Elasticsearch-like engine. Their pipeline for replicating data from SQL to search probably takes around 15 minutes, which they’ve decided (very reasonably) is an acceptable delay for their particular use-case.</p>\n\n<p>We’ve said that Elasticsearch is somewhat less reliable than most SQL databases. If Elasticsearch accidentally loses a few of our records then they won’t appear in search results. This would be a shame that would make our product a bit worse, and we try our hardest to avoid it happening. However, it wouldn’t be a disaster in the same way that losing data from our primary data store would be. We only copy data over to Elasticsearch once it has been written to and safely captured by our source-of-truth SQL database, which is what really matters.</p>\n\n<hr>\n\n<p>It’s 6pm, and the library is closing. A librarian tries to ask you to leave. Kate shoos him away with a barrage of crumpled-up balls of paper.</p>\n\n<hr>\n\n<h2 id=\"internal-tools\">Internal tools</h2>\n\n<p>Managing the Steveslist platform requires bespoke internal tools. We need to perform a wide range of administrative tasks, like deleting listings that are too illegal (even for us), issuing refunds, viewing a user’s personal details in order to help with support requests, and so on. Many of these tools will be used by people who work on other teams at Steveslist, like finance, compliance, legal, sales, and support. Since the tasks they need to perform are so specific to the way that Steveslist works, we can’t do them using third-party tools, and have to build our own instead.</p>\n\n<p>In the early days, we baked this functionality into the main Stevelist product and only exposed it to users who had the <code class=\"language-plaintext highlighter-rouge\">is_steveslist_employee = True</code> database flag set. This was an OK approach for a small company, but was also fragile and easy to mess up. It was scary to think that we were exposing all of our superuser powers through the same servers that run our main product. It made the potential consequences of a security flaw in our application much worse, and created new types of mistake for us to make, such as forgetting to disable the <code class=\"language-plaintext highlighter-rouge\">is_steveslist_employee</code> flag for an acrimoniously fired employee.</p>\n\n<p>Once Steveslist reached a certain level of maturity, we built ourselves an entirely separate admin platform, with separate, hardened authentication and authorization. The service runs on entirely separate servers, and requires a <em>VPN</em> and a <em>TLS client certificate</em> to access (which we’ll talk about another day). This separated out our internal- and external-facing products, and drastically reduced the chance of a boneheaded error exposing our admin tools to the world. We’re frequently building new internal tools - one for user administration, one for server management, one for fraud detection, and so on. These services all talk to the same database as our user-facing products, so they all have access to the same data. They just run on different servers that are completely inaccessible to the outside world.</p>\n\n<h2 id=\"cron-jobs\">Cron jobs</h2>\n\n<p>There are lots of tasks that we’ll want our system to perform at fixed times and intervals. For example:</p>\n\n<ul>\n  <li>Emailing ourselves weekly usage reports</li>\n  <li>Sending marketing emails to users</li>\n  <li>Charging the credit cards users who have a subscription plan with us</li>\n  <li>Copying data from our SQL database to Elasticsearch</li>\n</ul>\n\n<p>The most common tool used for running scheduled jobs is called <em>cron</em>, a tool that is built into Unix operating systems. It’s so common that people will often call any kind of scheduled job a “cron job”, even when it’s not actually being run by cron.</p>\n\n<p>You can set up a cron job on your own computer by running:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>crontab -e\n</code></pre></div></div>\n\n<p>Then typing into the prompt:</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>*/5 * * * * $YOUR_COMMAND\n</code></pre></div></div>\n\n<p>This will cause your computer to execute <code class=\"language-plaintext highlighter-rouge\">$YOUR_COMMAND</code> every 5 minutes.</p>\n\n<p>Steveslist currently has a very simple and slightly fragile cron setup. We have a single “scheduled jobs server”. We use <code class=\"language-plaintext highlighter-rouge\">crontab</code> on this server (as above) to tell it the commands that we want it to run, and the schedule that we want it to run them on. This setup isn’t scaling very well - if the scheduled jobs server explodes or even hiccups then we don’t always know which jobs it did and didn’t run, and have to scramble to bring up a replacement server. And even though the server is very beefy and powerful, eventually we’re going to want to run more jobs than it can handle at once. We’re considering either splitting up our cron jobs into multiple servers, or setting up a new system using a modern tool like <em>Kubernetes</em>.</p>\n\n<h2 id=\"pubsub\">Pubsub</h2>\n\n<p>Actions have consequences. This is both the subject line of the sinister emails that we send to people who write mean things about us on the internet, and the reason we have a <em>pubsub</em> system.</p>\n\n<p>When a new user signs up, we want to send them an email welcoming them to Steveslist and reminding them about the action-consequence relationship I just described. When a new listing is added for a stolen TV in San Francisco, we want to notify users who have set up search alerts for TVs in the Bay Area. When a card is declined for a subscription, we want to email the responsible user to politely threaten them. When a new listing is added, we want to perform some extremely cursory anti-fraud checks. When an item is purchased, we want to sent a webhook to its seller. And so on.</p>\n\n<p>Technically, all of these actions could be performed synchronously (rememberer that word?) by the server executing the initiating action. However, this is often a bad idea, for two reasons. First, the response action (such as emailing all the users who are subscribed for notifications about new stolen TVs) may be very slow. Performing the response action synchronously means that if the initiating action was performed by a user then they will have to wait for all the response actions to finish too. This might not be the end of the world if the response action is small and quick, like sending a single email. But if it’s larger - like searching for and notifying all users who might be interested in a new item - then, well, it still won’t be the end of the world, but it will be a bad user experience.</p>\n\n<p>To mitigate this problem we have built a “publish-subscribe” or “pubsub” system. When a trigger action is performed, the code that performs it “publishes an event” describing the action, such as <code class=\"language-plaintext highlighter-rouge\">NewListingCreated</code> or <code class=\"language-plaintext highlighter-rouge\">SubscriptionCardDeclined</code>. The words “event” and “publish” are quite loosely defined in this context, and don’t have a rigorous technical definition. An event is just some sort of record of something that happened, and to publish an event just means that you somehow make a note that something happened. The details of how you do so depend entirely on the pubsub system in question. In a simple system events might be stored in tables in a SQL database, and code would publish events by writing new records to a table.</p>\n\n<p>If a programmer at Steveslist wants a response action to be performed whenever a new event of a particular type is published, they can write a <em>consumer</em>. This is a piece of code that “subscribes” to a type of event, and which is executed whenever a new event of that type is published. It uses the details of the event (for example, the user whose subscription payment failed) to asynchronously execute whatever actions the programmer wants (for example, sending the user a menacing email).</p>\n\n<p>Pubsub systems are often managed by a central <em>message broker</em>. Systems publish events to the broker, and the broker is then responsible for getting the events to any subscribed consumers. This can be achieved using either a <em>push</em> or a <em>pull</em> mechanism. Consumers can pull messages from the broker by polling it and repeatedly asking “any new events? any new events?” or they can wait and listen and the broker can push notifications of new events out to them, for example by sending them an HTTP request.</p>\n\n<div class=\"language-plaintext highlighter-rouge\"><div class=\"highlight\"><pre class=\"highlight\"><code>1. New user signs|\nup to Steveslist |\n                 v\n       +-----------------+               +------------------------+\n       |Steveslist Server|           +--&gt;+SendWelcomeEmailConsumer|\n       +---------+-------+           |   +------------------------+\n                 |                   v\n2. Server reports|     +-------------++  4. Consumers send welcome\na NewUserSignup  +----&gt;+Pub/Sub Broker|  emails, check for spam,\nevent to the           +-------------++  etc.\nPub/Sub system                       ^\n              3. Pub/Sub broker      |   +------------------------+\n              notifies consumers     +--&gt;+NewUserSpamCheckConsumer|\n              that have subscribed to    +------------------------+\n              NewUserSignup events.\n</code></pre></div></div>\n\n<p>Pubsub systems have many benefits:</p>\n\n<ul>\n  <li>Non-critical actions are performed asynchronously, keeping the user experience snappy</li>\n  <li>Our code is kept clean and well-separated. The code that publishes an event doesn’t have to care about what the events’ subscribers do in response</li>\n  <li>If a subscriber’s action fails for some reason (for example, the email-sending system has a hiccup), the pubsub system can note this failure and retry again later</li>\n</ul>\n\n<p>Next, let’s talk big data.</p>\n\n<h2 id=\"big-data-and-analytics\">Big data and analytics</h2>\n\n<p>In order to understand and optimize our business, we need to be able to calculate complex statistics across the entire Steveslist platform. How many listings are created every day, segmented by country and city? How many users who signed up each month have created a listing within 90 days of signing up?</p>\n\n<p>To do this, we need to write database queries that aggregate over the entirety of our data. We don’t want to run these queries against our production SQL database, because they could put an enormous amount of load on it. We don’t want a huge query issued by an internal analyst to be able to bring our production database to a grinding halt, but we do want to provide this analyst with a tool that is well-suited to their needs. To complicate matters further, database engines that are quick at small queries (like returning all the listings belonging to a single user) are typically unacceptably slow (or indeed incapable) of answering giant queries (like calculating the total dollars spent on listings in each category, per day, for the last 90 days).</p>\n\n<p>Despite this, for the first year or so after Steveslist was founded, we took a risk and simply ran our analytics queries against the main production database. This was a gamble, but it just about worked. We didn’t have much data anyway, and we had more important things to focus on, like attracting the customers who would create the big data that would one day mean that we had to find a more scalable solution.</p>\n\n<p>Eventually we did bring down the production database with an overly-ambitious query, and decided that the time had come to invest in a data warehouse. A data warehouse is a data store that is well-suited to large, system-wide queries. Our warehouse is powered by a database engine called <em>Hive</em>, but we could also have chosen Presto, Impala, Redshift, or any number of competing alternatives. Hive accepts queries written in SQL, but is much better at executing these queries against giant datasets than our MySQL database is.</p>\n\n<p>We replicate our data from our production SQL database to Hive, once a day, overnight. Steveslist analysts and programmers can query the same dataset using whichever database engine best suits their needs. They can use the production SQL database for small, precise, source-of-truth queries from production systems; Elasticsearch for full-text search queries; or the data warehouse for huge queries that aggregate over vast volumes of data.</p>\n\n<hr>\n\n<p>It’s dark outside and you’re hungry. Is that pretty much it? you ask.</p>\n\n<p>“Oh god no,” Kate replies, “we could keep going forever. But this is a pretty good start. It’s helpful to have a broad understanding of a wide range of topics, but no one needs to know the details about everything. I find that once you know some basics you can keep picking up more basics and even a couple of details as you go along.”</p>\n\n<p>You ask if Kate could perhaps continue to elaborate on her five-year vision for Steveslist tomorrow.</p>\n\n<p>“Absolutely,” says Kate. We’ll talk about more of what goes on inside a real, large online platform, including:”</p>\n\n<h3 id=\"security\">Security</h3>\n\n<ul>\n  <li>HTTPS and other forms of encryption</li>\n  <li>Two-factor authentication</li>\n  <li>SAML</li>\n  <li>Secret key management</li>\n</ul>\n\n<h3 id=\"server-management\">Server management</h3>\n\n<ul>\n  <li>Deploying new code</li>\n  <li>AWS and competitors</li>\n  <li>Terraform</li>\n  <li>Load balancers</li>\n  <li>Containers</li>\n  <li>Alerting when code breaks</li>\n</ul>\n\n<h3 id=\"big-data\">Big data</h3>\n\n<ul>\n  <li>Map-reduce and other big data jobs</li>\n  <li>Machine learning</li>\n  <li>User tracking</li>\n</ul>\n\n<p>“See you tomorrow at 7am?”</p>\n\n\n        \n        <hr>\n        <div style=\"\">\n          <a href=\"https://twitter.com/robjheaton\">\n            Follow me on Twitter\n          </a>\n          or\n          <a href=\"https://robertheaton.com/feed.xml\">\n            RSS\n          </a>\n        </div>\n\n        <section style=\" padding-top: 60px;\">\n  <form action=\"https://ifoundthishelped.us4.list-manage.com/subscribe/post?u=84f18d8141e4ba155f81fb4eb&amp;id=264b2ba598\" method=\"post\" id=\"mc-embedded-subscribe-form\" name=\"mc-embedded-subscribe-form\" class=\"validate\" target=\"_blank\" novalidate=\"\">\n    <label for=\"mce-EMAIL\">\n      <h3 style=\"font-size: 1.5em; margin-top:-10px; margin-bottom:-6px;\">Get new essays sent to you</h3>\n    </label>\n    <p id=\"mce-email-describe\">\n      Subscribe to my new work on programming, security, and a few other\n      topics. Published a few times a month.\n    </p>\n\n    <input type=\"email\" value=\"\" name=\"EMAIL\" class=\"required email\" id=\"mce-EMAIL\" placeholder=\"Your email address\" style=\"width:200px;font-size: 1.1em; padding-left:4px; line-height:1.7em\">\n    <input type=\"submit\" value=\"Subscribe\" name=\"subscribe\" id=\"mc-embedded-subscribe\" class=\"button as-link green\" style=\"position:relative; top: -1px; border-radius: 3px;\n    border: 1px solid #97d69c;\n    cursor: pointer;\n    height: 37px;background-color: #3eb542;\n    color: white;\n    font-size:1.1em\">\n\n    <div id=\"mce-responses\" class=\"clear\" style=\"margin-top:15px\">\n      <div class=\"response\" id=\"mce-error-response\" style=\"display:none\"></div>\n      <div class=\"response\" id=\"mce-success-response\" style=\"display:none\"></div>\n    </div>  \n    <p><span style=\"color: #f92672;\">NEW:</span> Also subscribe to my new series, <a href=\"https://advancedbeginners.substack.com\">Programming Feedback for Advanced Beginners</a></p>\n\n  </form>\n  <div style=\"clear:both\"></div>\n</section>\n\n        \n  <h3 style=\"font-size: 1.5em;padding-top:30px;\">More on Programming Projects for Advanced Beginners</h3>\n  <ul>\n    \n      \n        \n          \n          <li>\n            <a href=\"/2020/04/19/pfab13-when-code-is-too-clever-to-be-clean/\">PFAB #13: When code is too clever to be clean</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n      \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2020/03/07/pfab11-separating-logic-and-data/\">PFAB #11: Separating logic and data</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2020/02/23/pfab10-first-class-functions-dependency-injection/\">PFAB #10: First-class functions and dependency injection</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2020/02/08/pfab9-batch-vs-stream-processing/\">PFAB #9: Batch vs Stream processing</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2020/01/26/pfab8-input-validation/\">PFAB #8: Input validation - tradeoffs between convenience and surprise</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2020/01/04/pfab7-how-to-write-a-library/\">PFAB#7: How to write a library</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/12/28/pfab6-real-world-debugging-practice/\">PFAB#6: Real-world debugging practice</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/12/21/ppab5-how-to-make-your-programs-shorter/\">PFAB#5: How to make your programs shorter</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/12/14/pfab4-exception-handling-dealing-with-failure/\">PFAB#4: Exception handling and coping with failure</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/12/07/pfab3-analyze-commute/\">PFAB#3: How to rigorously analyze your journey to work</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/11/30/pfab2-how-to-structure-your-programs/\">PFAB#2: How to structure your programs</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/11/11/pfab1/\">PFAB#1: Define your boundaries</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/11/08/programming-feedback-for-advanced-beginners-0/\">Programming Feedback for Advanced Beginners #0</a>\n          </li>\n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/11/08/i-will-give-you-feedback-on-your-code/\">I will give you feedback on your code</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/08/12/programming-projects-for-advanced-beginners-user-logins/\">Programming Projects for Advanced Beginners #6: User Logins</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/08/11/real-world-programming-projects-for-advanced-beginners/\">Real-World Programming Projects for Advanced Beginners</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/07/27/programming-videos-for-advanced-beginners-battleships/\">Programming Videos for Advanced Beginners #1: Battleships</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/04/14/open-source-for-advanced-beginners-1-bashplotlib/\">Open Source for Advanced Beginners #1: bashplotlib</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/04/13/open-source-for-advanced-beginners/\">Open Source for Advanced Beginners</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2019/03/25/what-beginners-mind-is-really-like/\">What beginner's mind is really like</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2018/12/08/programming-projects-for-advanced-beginners/\">Programming Projects for Advanced Beginners</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2018/12/02/programming-project-5-snake/\">Programming Projects for Advanced Beginners #5: Snake</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2018/11/03/programming-project-4-photomosaics/\">Programming Projects for Advanced Beginners #4: Photomosaics</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2018/10/09/programming-projects-for-advanced-beginners-3-b/\">Programming Projects for Advanced Beginners #3b: Tic-Tac-Toe AI</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2018/10/09/programming-projects-for-advanced-beginners-3-a/\">Programming Projects for Advanced Beginners #3a: Tic-Tac-Toe AI</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2018/07/20/project-2-game-of-life/\">Programming Projects for Advanced Beginners #2: Game of Life</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n          <li>\n            <a href=\"/2018/06/12/programming-projects-for-advanced-beginners-ascii-art/\">Programming Projects for Advanced Beginners #1: ASCII art</a>\n          </li>\n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n    \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n        \n          \n        \n      \n    \n      \n    \n      \n    \n      \n    \n      \n    \n      \n    \n      \n    \n      \n    \n  </ul>\n\n\n        <section class=\"navigation\" style=\"padding-top:13; margin:0\">\n  \n    <div class=\"pull-left\">\n      <a href=\"/2020/03/18/yourself-happier-iphone-worse/\" id=\"next\">\n        <span>◀ How to make yourself happier by making your iPhone worse</span>\n      </a>\n    </div>\n  \n  \n    <div class=\"pull-right\">\n      <a href=\"/2020/04/13/hundreds-of-companies-assert-usage-rights-over-all-ideas/\" id=\"prev\">\n        <span>Hundreds of companies assert usage rights over all ideas sent through their services ▶</span>\n      </a>\n    </div>\n  \n</section>\n\n        <br>\n      </section>\n    </div>\n    <footer>\n  <div class=\"stuff\" style=\"text-align: center; padding:5px;\">\n    <a href=\"/\">Home</a> /\n    <a href=\"/archive\">Archive</a> /\n    <a href=\"/feed.xml\">RSS</a> /\n    <a href=\"https://twitter.com/robjheaton\">Twitter</a> /\n    <a href=\"/office-hours\">Office hours</a> /\n    <a href=\"/tipoffs\">Tipoffs</a> /\n    <a href=\"https://soundcloud.com/rob24242/\">SoundCloud</a> /\n  </div>\n</footer>\n\n  \n\n","text":"Robert Heaton\nSoftware Engineer / One-track lover / Down a two-way lane\nAbout\nArchive\nTwitter\nNEW: Programming Feedback for Advanced Beginners\nSystems design for advanced beginners\n06 Apr 2020\nThis post is part of my Programming for Advanced Beginners series. Subscribe now to receive specific, actionable ways to make your code cleaner, every other week, entirely free.\nYou’ve started yet another company with your good friend, Steve Steveington. It’s an online marketplace where people can buy and sell things and where no one asks too many questions. It’s basically a rip-off of Craigslist, but with Steve’s name instead of Craig’s.\nYou’re going to be responsible for building the entire Steveslist technical platform, including all of its websites, mobile apps, databases, and other infrastructure. You’re excited, but also very nervous. You figure that you can probably cobble together a small website, since you’ve done that a few times before as part of your previous entertaining-if-morally-questionable escapades with the Stevester. But you have no idea how to even start building out all of the other infrastructure and tools that you assume lie behind large, successful online platforms.\nYou are in desperate need of a detailed yet concise overview of how real companies do this. How do they store their data? How do their different applications talk to each other? How do they scale their systems to work for millions of users? How do they keep them secure? How do they make sure nothing goes wrong? What are APIs, webhooks and client libraries, when you really get down to it?\nYou send a quick WhatsApp to your other good friend, Kate Kateberry, to see if she can help. You’ve worked together very effectively in the past, and she has decades of experience creating these types of systems at Silicon Valley’s biggest and most controversial companies.\nShe instantly accepts your job offer. You had actually only been ringing for some rough guidance and a good gossip, but you nonetheless instantly accept her acceptance. No point looking a gift horse in the mouth, even when you don’t have any money to pay her. Kate proposes that her first day be 5 weeks ago in order to help her smooth over some accounting irregularities. She can come into the office sometime next week. You feel encouraged and threatened by her eagerness.\nKate bounces into your offices in the 19th Century Literature section of the San Francisco Public Library. “OK let’s do this!” she shouts quietly. “What have we got so far? How are all our systems set up? What’s the plan?” You lean back in your chair and close your laptop, which was not turned on because you have left your charger at home. You steeple your fingers in a manner that you hope can be described as “thoughtful”.\n“Let me flip that question around, Kate. What do you think the plan should be?”\nKate takes a deep breath and paints an extremely detailed vision of the Steveslist platform five years into the future and the infrastructure that will power it.\nBefore we start (says Kate), I want to make it clear that I’m not saying that any of this is necessarily the “right” way to set up our infrastructure. If someone you trust more than me says something different then you should probably do what they say. There are many tools out there, each with different strengths and weaknesses, and many ways to build a technology company. The real, honest reasons that we will make many of our technological choices will be “we chose X because Sara knows a lot about X” and “we chose Y on the spur of the moment when it didn’t seem like a big decision and we never found the time to re-evaluate.”\nNonetheless, let’s fast-forward five years into the future. Now Steveslist has two main consumer-facing products:\nThe Steveslist web app\nThe Steveslist smartphone apps\nThese are the main ways in which users directly interact with the Steveslist platform. In addition, we also provide an API that allows programmers to build power-tools on top of the Steveslist platform that, for example, create listings for hundreds of items programmatically. To support this, we offer:\nA Steveslist API\nSteveslist API client libraries that make it easy for programmers to write code that talks to our API\nHere, I’ll draw a diagram on the whiteboard:\n<code>+-----------+ +--------------+ +-----------------+\n|Web Browser| |Smartphone App| |Client Libraries/|\n+-----+-----+ +------+-------+ |Other API code | | | +-------+---------+ | v | | +-----+------+ | +---------&gt;+ Steveslist +&lt;-----------+ | Servers | +------------+\n</code>\nFinally, we have many, many services running in the background that provide the data and power to these external-facing applications:\nWebhooks - to notify users when something happens to their account, such as “order placed”\nUser password authentication - to securely log users in\nSQL database - the main Steveslist data store. Needs to be highly scalable and reliable\nFree-text searching system - to power the search box where people can look for broad search terms like “TVs” or “motorbikes”\nInternal tools - to help us administer the Steveslist platform, and to take actions like issuing sternly-worded warnings to malicious users\nCron jobs - to run regular tasks that do anything from generating invoices, to billing customers, to sending as much of our users’ data as possible to third-party ad networks\n“Pubsub” system - to allow us to take asynchronous actions on different trigger events (such as “when a new user signs up, send them a welcome email”)\nBig data analytics system - to allow us to run enormous queries over the entirety of Steveslist’s data\nAnd many more that we’ll talk about another day\nLet’s go through each of these systems in turn. Let me know if anything isn’t clear, if you have any questions, or if you think I’ve got something wrong.\nBefore we start - what is a server really?\nBefore we start, let’s define some important terms. In fact, let’s just define one. We’re going to talk a lot about “servers” today. But what is a server, when you really get down to it?\nFor our purposes, a server is a computer that runs on a network and listens for communications from other computers. When it receives some data from another computer it performs some sort of action in response and - usually - sends back some data of its own. For example, a web server listens on a network for HTTP requests and sends back webpages and information in response. A database server listens for database queries and reads and writes data to the database that it is running.\nThis brief description skips out entire degrees and careers of detail, and there are of course far more precise and accurate ways to define the word “server”. But this should get us through until dinnertime. What did you say? What’s a “network” really? A good question for another day.\nNow we’re ready to talk about the Steveslist platform.\nSteveslist web app\nThis is the main Steveslist product. It’s just a normal web app, very similar to any website that you’ve built before, except much bigger. It’s a modern “single-page app” (SPA). The “single” in “single-page app” refers to the fact that the user’s browser almost never has to fully reload the page as the user clicks around our site. Instead, when the browser makes its first HTTP request to our servers, we send it back a basic, skeleton HTML page and a big pile of JavaScript code. This JavaScript code executes inside the browser, and updates the view of the page in response to the user’s actions. When the JavaScript wants to send or retrieve data from Steveslist, it sends an Asynchronous JavaScript XML Request (almost always called AJAX for short) in the background to a URL. When our server responds, the JavaScript uses the response to update the browser view accordingly.\n<code>+----------+1.User's browser visits steveslist.com. +----------+\n| | It sends an HTTP request to the | |\n| | Steveslist servers | |\n| +---------------------------------------&gt;| |\n|User's Web| |Steveslist|\n| Browser |2.Steveslist server responds with a | Servers |\n| | skeleton HTML page that instructs the | |\n| | browser to request additional | |\n| | JavaScript files. | |\n| |&lt;---------------------------------------+ |\n| | | |\n| |3.User's browser requests and receives | |\n| | these JavaScript files from the | |\n| | Steveslist server. | |\n| +---------------------------------------&gt;| |\n| |&lt;---------------------------------------+ |\n| | | |\n| |4.User's browser executes the JavaScript| |\n| | code. The code sends more requests for| |\n| | the user's data to the Stevelist | |\n| | server, and updates the browser UI to | |\n| | display it. | |\n| +---------------------------------------&gt;| |\n| |&lt;---------------------------------------+ |\n+----------+ +----------+\n</code>\nrobertheaton.com is not a single-page app. Whenever you click on a link, the browser has to reload the entire page. twitter.com is a single-page app. Whenever you click on a link, the browser dynamically updates a small portion of tthe page without forcing a full refresh.\nSPAs are a lot of work to build and maintain, but they sure look good.\nSteveslist smartphone apps\nWe provide Steveslist smartphone apps for both iOS and Android. They are conceptually very similar to our single-page web app. Both our smartphone and web apps make HTTP requests to our servers. Then our servers receive these requests, do some work and return an HTTP response. Finally, both our smartphone and web apps update their display in order to communicate with the user.\nSince our smartphone apps are performing the same operations as the web app (for example, create listing, send message, etc), they can usually even send their requests to the exact same URLs as the web app. The only extra work that we have to do is to develop the frontends of the apps themselves. Some frameworks even make it possible to write mobile apps using JavaScript, allowing you to reuse code and logic across platforms.\nSteveslist API\nWe allow users and third-parties to write code that programmatically interacts with our platform. In the same way that people can use the Twitter API to write code that reads; likes; and creates Tweets, we allow them to use the Steveslist API to search; buy; and list items.\nProgrammers use our API by writing code that makes HTTP requests to our API endpoints. For example, in order to retrieve a list of all their listings, the programmer sends an HTTP GET request to api.steveslist.com/v1/listings. We respond with the data they requested, formatted as JSON. JSON stands for JavaScript Object Notation, but JSON is not specific to JavaScript and can easily be interpreted by any programming language. A JSON response to a request to retrieve all of a user’s listings might look something like this:\n<code><span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">listings</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"p\">[</span> <span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">id</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">2178123867</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">name</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">Stolen TV</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">country</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">US</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">city</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">San Francisco</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_amount</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">1000</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_currency</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">usd</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"err\">#</span> <span class=\"nx\">etc</span><span class=\"p\">...</span> <span class=\"p\">},</span> <span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">id</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">182312679</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">name</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">Stolen Bicycle</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">country</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">US</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">city</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">San Francisco</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_amount</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">2000</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_currency</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">usd</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"err\">#</span> <span class=\"nx\">etc</span><span class=\"p\">...</span> <span class=\"p\">}</span> <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code>\nThis structured response format is very easy for a program to parse, which means that the code that made the request can trivially interpret and use the data from our API.\nUsers identify or authenticate themselves to our API using an API key. This is, roughly speaking, the API equivalent of a password. It is a long, random string that we generate and display on a user’s “Settings” page. Users include their API key as an HTTP header with every HTTP request that they (or their code) makes to the API. When we receive an API request we check to see whether the attached API key corresponds to a Steveslist user. If it does then we perform the request on behalf of that user.\nIf a programmer wants to, they can manually build HTTP requests to our API themselves, using their language’s standard HTTP library. For example, in Python they might write:\n<code><span class=\"kn\">import</span> <span class=\"nn\">requests</span> <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"s\">'https://api.steveslist.com/v1/listings/'</span>\n<span class=\"n\">listing_params</span> <span class=\"o\">=</span> <span class=\"p\">{</span> <span class=\"s\">\"name\"</span><span class=\"p\">:</span> <span class=\"s\">\"Stolen TV\"</span><span class=\"p\">,</span> <span class=\"s\">\"country\"</span><span class=\"p\">:</span> <span class=\"s\">\"US\"</span><span class=\"p\">,</span> <span class=\"s\">\"city\"</span><span class=\"p\">:</span> <span class=\"s\">\"San Francisco\"</span><span class=\"p\">,</span> <span class=\"s\">\"price_amount\"</span><span class=\"p\">:</span> <span class=\"mi\">1000</span><span class=\"p\">,</span> <span class=\"s\">\"price_currency\"</span><span class=\"p\">:</span> <span class=\"s\">\"usd\"</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n<span class=\"n\">api_key</span> <span class=\"o\">=</span> <span class=\"s\">\"YOUR_API_KEY_GOES_HERE\"</span> <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">post</span><span class=\"p\">(</span> <span class=\"n\">url</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">=</span><span class=\"n\">listing_params</span><span class=\"p\">,</span> <span class=\"n\">headers</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s\">\"X-Steveslist-API-Key\"</span><span class=\"p\">:</span> <span class=\"n\">api_key</span><span class=\"p\">},</span>\n<span class=\"p\">)</span>\n</code>\nHowever, we make life easier for programmers by providing client libraries.\nSteveslist client libraries\nA client library is a library that “wraps” the functionality of the Steveslist API. This means that anyone using the client library doesn’t need to know anything about the fine details of the Steveslist API. Instead, they can just write:\n<code><span class=\"kn\">import</span> <span class=\"nn\">steveslist</span> <span class=\"n\">listing</span> <span class=\"o\">=</span> <span class=\"n\">steveslist</span><span class=\"o\">.</span><span class=\"n\">Listing</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s\">\"Stolen TV\"</span><span class=\"p\">,</span> <span class=\"n\">country</span><span class=\"o\">=</span><span class=\"s\">\"US\"</span><span class=\"p\">,</span> <span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s\">\"San Francisco\"</span><span class=\"p\">,</span> <span class=\"n\">price_amount</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"p\">,</span> <span class=\"n\">price_currency</span><span class=\"o\">=</span><span class=\"s\">\"usd\"</span><span class=\"p\">,</span> <span class=\"n\">api_key</span><span class=\"o\">=</span><span class=\"s\">\"YOUR_API_KEY_GOES_HERE\"</span>\n<span class=\"p\">)</span>\n</code>\nOur libraries turn the parameters that they are given into appropriately formatted HTTP requests, which they send to the Steveslist API as normal. We’ve written client libraries for every major programming language that we could think of, and they are by far the most common way that people interact with our API.\nWebhooks\nWe’ve seen how Steveslist users can use our API to programmatically interact with their account. In addition, many users also want us to proactively tell them whenever something happens to their Steveslist profile. For example, suppose that someone wanted to fully automate the process of selling items on Steveslist. Whenever a customer pays for an item using our new, mostly-secure StevePay system, they want to send the customer a thank you email and automatically instruct their warehouse to ship a stolen TV to the order address. Our seller could constantly and repeatedly query the Steveslist API asking “Any new sales? Any new sales?” However, this would be very inefficient, and would put a lot of unnecessary load on our servers.\nInstead, we provide an industry standard system called webhooks. A webhook is an HTTP request that we send to our users whenever something interesting happens to their account. It contains all the data describing the event that just happened - for example, the item ID, the price, the buyer ID, buyer address, and so on. Webhooks allow users to automatically perform response actions, such as the aforementioned email and auto-shipping.\nTo use webhooks, the user tells us the URL to which they would like us to send their webhooks (for example, steveslistwebhooks.robertheaton.com. They set up a web server at that URL that will receive and action these webhook notifications.\n<code>1.Buyer purchases an 3.The seller's server receives the webhook, item as normal. and uses the information in it to automatically process the order.\n+---------------+ +-----------------+\n|Buyer's Browser| |Seller's Webhook-+\n+------+--------+ |Receiving Server | | +------+----------+ | ^ | | | | | +-----------+ | +---&gt;+ Steveslist+----------+ | Server | +-----------+ 2.Once the transaction has been completed, Steveslist looks up the seller's webhook URL (if set). We then send an HTTP request to this URL, containing the details of the purchase.\n</code>\nThe user deploys code on their web server that performs the appropriate response actions whenever it receives a webhook from us. We don’t only send webhooks when an item is purchased - we also send them when a user receives a message; when one of their items is removed by an admin; or when a buyer makes a complaint. This enables Steveslist sellers to automate not just the listing of items, but also the selling and shipping of them too.\nWebhook complications\nWebhooks come with two main complications - security and reliability. First, let’s talk security. The endpoint to which the seller instructs us to send their webhooks is accessible to anyone on the internet. Anyone who knows the URL can send it fake webhooks, and if our seller isn’t careful this could allow an attacker to trick them into, for example, sending the attacker free stuff. A seller’s webhook URL should be difficult to find, since the seller won’t publicize its existence, but obscurity is not the same as security.\nTo allow our sellers to verify that a webhook really was sent by Steveslist, we cryptographically sign our webhook contents.\nCryptographic signing\nCryptographic signing is a deep and subtle topic. Here’s a condensed version of how we use it to secure our webhooks.\nWhen a seller enables webhooks for their account, we generate a random “shared secret key”. We tell the seller to copy this key over to their webhook-receiving server and keep it secure, so that its value is known only by us and the seller. Whenever we send a webhook, we take this shared secret, combine it with the contents of the webhook by using a cryptographic hash function called HMAC, and get back a long, random-seeming, but entirely deterministic “signature” for the webhook.\n<code>Webhook contents +----------+\n(eg. {\"id\": 123...}) | v +---+----------+ |HMAC Algorithm|-----&gt;Webhook signature +---+----------+ ^\nShared secret key |\n(eg. 123mhu23jy8xdwgmd...)+---+\n</code>\nWe include this signature in our webhook body, for example:\n<code><span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">action</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">item_sold</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">100</span><span class=\"p\">,</span> <span class=\"c1\">// ...more params...</span> <span class=\"dl\">\"</span><span class=\"s2\">signature</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">234gj98d49j834978gf39t78ndn98g7dq3ng897308y7</span><span class=\"dl\">\"</span>\n<span class=\"p\">}</span>\n</code>\nWhen the seller’s webhook-receiving server receives a webhook, it takes the shared secret and webhook contents and calculates what it expects the signature to be in exactly the same way that we did. It compares the result to the signature attached to the webhook; if they match then it accepts and processes the webhook. Since the signature can only be generated using the shared secret known only by us and the seller, the webhook-receiving server can be confident that the webhook was sent by us. If the signatures don’t match, however, the server rejects the webhook.\nNote that all of the signature verification code must be written and maintained by the sellers. We can provide them with encouragement and examples, but we can’t force them to verify signatures correctly, or even at all. For some real-world examples, look at how Stripe and GitHub sign their webhooks.\nReliability\nWe also need to consider what happens when our webhooks go wrong and what guarantees we want to make to our users about them. If we try to send a webhook but can’t connect to the user’s server, what should we do? What if we successfully connect to their server and send the webhook, but their server sends back an error? What if we send the webhook but the server hangs for twenty seconds before disconnecting without telling us what happened?\nThere are tradeoffs involved here that require clear communication and a surprising amount of infrastructure to manage. We at Steveslist choose to guarantee that we will deliver webhooks “at least once”. This means that if a webhook fails to send then we will keep trying (a large but not infinite number of times) until it does. If we’re not sure whether a webhook succeeded or failed, we will keep trying until we are sure that an attempt has succeeded. This might occasionally result in us sending the same webhook twice, but it’s the seller’s responsibility to have their code handle this gracefully instead of sending the same customer five stolen TVs instead of the one that they ordered.\n“What do you think so far?” asks Kate. “Is this roughly what you’ve been thinking?” You make a non-committal face and take a big bite of a nearby sandwich in order to preclude any further discussion. Kate continues:\nLet’s talk about the backend systems that will power some of our most important features.\nUser authentication via a password\nMost users sign into the Steveslist website and smartphone apps using a username and password. There are other ways of signing into the website, like OAuth - we’ll cover them another time.\nWe will have to store our users’ passwords very securely. Not only is a user’s password the thing they use to sign in (or authenticate) to Stevelist, but for many users they’re probably the same password that they use to sign in to many other services too, despite all the warnings that this is a bad idea. They only have so many children with so many birthdays, after all.\nRupert Herpton has written the seminal tutorial on how to secure passwords, which I’m sure you’ve read already. Just in case you need a refresher, the crux of the matter is that we mustn’t ever store passwords in their original, plaintext form, anywhere. We mustn’t store them in plaintext in a database, in a log file, or in any other part of our system. Instead, before storing a password, we must first hash it using a hash function such as bcrypt.\nA hash function is a “one-way” function that takes an input and deterministically converts it into a new, seemingly-random string. Calculating a hash value from an input is computationally very easy, but reversing the transformation and recovering the original input from its hash value takes so much time and computing power that it is, practically-speaking, impossible.\n<code>+---------+ Easy +----------+\n| |------------&gt;| |\n|Plaintext| |Hash value|\n| |&lt;------------| |\n+---------+ Essentially +----------+ Impossible\n</code>\nSince we only store the hash values of our users’ passwords, if a hacker somehow stole our password database (heaven forbid) (touch wood) then they would only be able to see the passwords’ hash values. They wouldn’t be able to easily turn these hash values back into plaintext passwords, meaning that they wouldn’t be able to use them to login to Steveslist, and they won’t be able to take advantage of all the people who re-use passwords across different services.\nSince we only store password hash values, when we want to check whether a login password that a user has given us is correct we first calculate its hash value, and compare the result to the hash value in our password database.\n<code> +--------------+ |User's Browser| +-----------+--+\n1.User attempts to | ^\nlog in: | | 3. Server logs the user in | | if password matches, and username: steve | | returns an error if it does not. password: 12345 v | +--+--------+--+ | Steveslist | | Server | +--------------+ |\n2.Server computes | |username|password_hash|\nthe hash of the | +----------------------+\npassword and compares +----&gt;+steve |23jy7213y7jO |\nit to the value in the |kate |21897213hh21 |\ndatabase. |... |... |\n</code>\nAs previously mentioned, we also have to be careful not to log passwords in any of our debug output. This can be an easy mistake to make - if you log all of the parameters of every HTTP request, just in case you need it, you will certainly be logging user passwords. Facebook logged passwords in plaintext for many years, and whilst it didn’t seem to affect their stock price I’m sure it made them feel pretty silly for a day or two.\nKate pauses for breath. You pretend to take notes on your out-of-battery laptop.\nLet’s talk about infrastructure.\nDatabase servers\nSteveslist’s primary data store runs a common flavor of SQL database called MySQL. I won’t talk much about SQL here - the specifics of how it works aren’t too important, and you can find them on Google if you’re interested. Since we are so successful, we have a huge and growing amount of data to manage. We’ve started to become acutely aware that databases aren’t magic. They run on computers, just like any other program. As the volume of data in a database grows, the computer’s hard drive and memory starts to fill up. At the start of the company the easiest way to deal with this problem was to run our database on a single computer (or machine) with an enormous hard drive. But this could only stave off the problem for so long. Eventually our database contained more data than could be stored on any reasonable hard drive, and the database started to get slower and slower as we forced it to search through more and more records.\nWe had to take an entirely new approach, and reconfigure our database to store its data on multiple computers. We did this using sharding.\nSharding\nSharding a database means splitting its data into chunks (or “shards”) and storing each chunk on a separate machine. All of the machines that make up a database are together known as a database cluster. How you split data between machine in your cluster depends on your application and the types of operations you will be performing. For Steveslist we chose to split out our data by user. This means that all of the data for a given user is stored on the same machine. This includes their profile information, their listings, their messages, and so on. Data that doesn’t have a corresponding user (like “Deals of the Day”) can be sharded using a shard key other than user, or not sharded at all if the dataset is sufficiently small.\nThis means that we need an extra “routing” layer in front of our database, which knows which database machine is able to service which queries. We could either make our application servers (the servers that execute our code) responsible for knowing the mapping of user IDs to database shards, or have a centralized “router” that all servers send their requests to, and which is responsible for working out the appropriate machine to forward the request on to. Both approaches have their advantages. Making application servers responsible for maintaining the mapping reduces the number of hops that a request has to make, speeding them up. But having a centralized router makes updating the shard mapping much easier, since you only have to update it in one place.\nIf application servers are responsible for knowing the shard layout, we have a system that looks like this:\n<code> + + + | | | | Requests from users | | | | v v v +------+----------+--------------------+ | Application | | Server | | | |Database sharding config: | |* DB Server 1: IDs between 1-10000 | |* DB Server 2: IDs between 10000-20000| |* DB Server 3: IDs between 20000-30000| +-+----------------+-----------------+-+ | | | |ID:501 |ID:15362 |ID:22361 | | | v v v\n+-----------+ +-----------+ +-----------+\n|DB Server 1| |DB Server 2| |DB Server 3|\n+-----------+ +-----------+ +-----------+\n</code>\nIf we have a centralized database router, we have a system that looks like this:\n<code> + + + | | | | Requests from users | | | | v v v +------+----------+--------------------+ | Application | | Server | | | |Database sharding config: | |* ??? Application Server has no idea | +------------+-----------+-------------+ | | Application server sends all database queries to the database router, which forwards them to the correct shard. | | v v +--------------+-----------+-------------+ | Database router | | | |Database sharding config: | |* DB Server 1: IDs between 1-10000 | |* DB Server 2: IDs between 10000-20000 | |* DB Server 3: IDs between 20000-30000 | +---+----------------+---------------+---+ | | | |ID:501 |ID:15362 |ID:22361 | | | v v v\n+-----------+ +-----------+ +-----------+\n|DB Server 1| |DB Server 2| |DB Server 3|\n+-----------+ +-----------+ +-----------+\n</code>\nHow do we decide which database to assign each user to? However we want. We could start by saying that users with odd-numbered IDs are assigned to shard machine 1, and those with even-numbered ones are assigned to shard machine 2. We could hope that this random assignment results in balancing our data relatively evenly between our shards.\nHowever, it’s possible that we might have a small number of power users who create much, much more data than others. Maybe they create so much data that we want to allocate them a shard of their own. This is completely fine - we have complete control over how users are assigned to shards. Random assignments are usually easiest, but are by no means the only option. We can choose to assign users to shards randomly - except for user 367823, who is assigned to shard 15, which no other user is assigned to.\nIf a shard gets too big and starts to fill up its machine’s hard-drive, we can split it up into multiple, smaller shards. How do we migrate the data to these new shards without having to turn off our platform for a while? Probably using a sequential process like:\n“Double-write” new data to both the old and new shards. Continue reading data from the old shard\nCopy over all existing data from the old shard to the new shard. Continue double-writing to old and new shards\nConvince ourselves that the old and new shards contain the same data. We could do this by comparing snapshots of the databases, and/or by reading every query from both databases, comparing them, and alerting if the data is different\nOnce we’re confident that the new and old shards contain the same data, we switch to reading from the new shards. We continue double-writing in case we need to switch back\nOnce we’re confident that this step has been successful, stop double-writing and delete the old shard\nRupert Herpton has written a great article about a broadly-similar type of migration that goes into much more detail. In short, the process of migrating data between database shards is detailed and finicky, but also entirely doable and logical. Some types of database can even automatically take care of sharding for you.\nReplication\nWe will take great care to make sure that our data doesn’t get accidentally deleted and our database servers don’t randomly stop working. But accidents happen, and sometimes computers do randomly stop working. To mitigate the fallout of a database-related disaster, we replicate our data across multiple machines in (close to) realtime.\n<code> Client writes new data to DB Server A | v +-----+-----+ |DB Server A| ++---------++ | | DB Server A quickly replicates v v the new data to DB Servers B and C\n+----------++ +-+---------+\n|DB Server B| |DB Server C|\n+-----------+ +-----------+\n</code>\nRealtime replication has two main benefits. First, it means that if one of our database servers explodes, catches fire, or otherwise stops working, we have multiple almost-perfect copies of it that can seamlessly pick up the slack. In a straightforward, vanilla failure, users of our services may never know that anything has gone wrong. The second benefit of replication is that we can distribute queries for the same data across multiple database servers. If lots of users are asking to read data from the same database, we can split their queries up across all of our copies, meaning that we can handle more queries in parallel.\n<code> Clients can query the same data from any of DB Servers A,B,or C | | | | | | | | | v v v | | | | +-+---+---+-+ | | | | |DB Server A| | | | | +-----------+ | | | | | | v v v v\n+---+-------+ +-----+-+---+\n|DB Server B| |DB Server C|\n+-----------+ +-----------+\n</code>\nNote that database replication is not the same concept as making database backups. Replication happens in (close to) realtime, and is designed to deal on-the-fly with isolated problems in your live (or production) systems. Database backups are performed on a schedule (for example, once a day), and the copies of the data are stored separately, away from production systems. Backups are designed as a final safeguard against widespread, catastrophic data loss, as might happen if all your data centers burned down.\nPretend that you work in the call centre of a big bank, where people are constantly calling you up in order to send money transfers and ask about their current balance. Replication is the equivalent of hurriedly writing down transfer details into multiple books, as you receive them, just in case you lose one of the books. Making backups is the equivalent of photocopying those books once a day and storing the copies in your filing cabinet.\nReplication\nThe process of replication is conceptually quite straightforward. Whenever new data is written to our database, we copy it to multiple machines. This means that if/when a machine fails we can continue querying its siblings, with no user-facing impact. It also means that we can spread our queries out across multiple copies of the same data, resulting in faster query response times.\nHowever, the details of how we do this are important, subtle, and situation-dependent. There’s no right way to do replication - as is so often the case, the exact approach that you take depends on the specific requirements and constraints of your system.\nReplication is complicated by two inconvenient facts about the real world. First, database operations randomly fail sometimes. When we attempt to replicate our data from one server to another, things will occasionally go wrong, causing our machines to become out of sync, at least for a period. Second, even in periods of smooth operation, replication is not instantaneous. When new data is written to our database cluster, some servers in the cluster will always know about the update sooner than others. When choosing a replication strategy we must be aware of these limitations and how they impact our particular application. For example, maybe it’s OK to risk the number of “likes” on a post being slightly out of sync and out of date, but not the amount of money in a user’s bank account.\nOne of the biggest decisions we must make when choosing a replication strategy is whether we want our replication to be synchronous or asynchronous.\nAsynchronous vs synchronous replication\nReplication can be handled either synchronously or asynchronously. These words come up in a lot of different places in systems design, but they always fundamentally mean the same thing. If an action is performed “synchronously” then this means that it is performed while something waits for it. If you wanted to send a letter synchronously then you would got to the Post Office, give your letter to a postal worker, sit and wait in the corner of the Post Office for a few days, and only go home when the postal worker confirmed that your letter had arrived safely.\nBy contrast, if an action is performed “asynchronously” then this means that the initiator of the action doesn’t wait around for it to be finished. Instead, they just continue with the rest of their work while the action is worked on in the background. The real Postal Service is asynchronous; you give your letter to a postal worker, then leave and continue with your life while the Postal Service delivers your letter. Asynchronous actions can send back notifications of the outcome of the action if they want (“Your letter has arrived and was signed for” or “Mr. Heaton, your dry-cleaning is ready”), but they don’t have to.\nHow do these principles apply to database replication? In synchronous replication a client writes its new data to a database server and then waits. This server doesn’t tell the client whether their write has been completed successfully until it has finished fully replicating the client’s data across all of its sibling servers. Then, and only then, does the client continue executing the rest of its code.\nIn asynchronous replication the client writes its data to the first database server, as before. But this time the first server tells the client that the write was successful as soon as it has written the data to its own data store. It kicks off the replication process in the background, and doesn’t wait for it to complete, or even start, before it tells the client that the write was successful. This means that the asynchronous operation appears much faster than the synchronous one, because the client doesn’t have to wait for all the replication to complete before it can continue on with the rest of its work. However, if the background replication fails then the client will believe that it has successfully written its data to the database when it actually has not. This could cause problems, the imagination of which is left as an exercise for the reader.\nThe synchronous approach is slower but “safer” than an asynchronous approach. The database never claims to have successfully received and stored any data until it has finished every single step of doing so. Because the client waits for full confirmation before proceeding, it is guaranteed to never encounter a situation where the client believes that it has written some data to the database, but the database has secretly partially dropped the data on the floor.\nWhich approach is better? It depends. Do you care more about speed or correctness? Is it OK to occasionally have inconsistent data if it significantly speeds up the system’s operation? Or will even a single mistake cause airplanes to start falling out of the sky?\nDatabase replication systems face other interesting problems too. Many of these problems are “logical” rather than “technical”, and don’t require a detailed understanding of the complex software and networking protocols underlying the system. To help picture some of them, imagine that you’re back in the call centre from a few paragraphs ago. You work with many other colleagues. Together you play the role of database servers. People call you up to transfer money and ask about their current balance. You and your colleagues write information about new transfers down on paper, and replicate it between yourselves by calling each other up.\nThe problems faced by our database cluster are identical to those faced by our call-centre. What happens if two people call in and try to update the same piece of data at the same time by talking to two different employees? Maybe we solve that by having a “leader” employee who is the only one authorized to serve calls from people trying to create transfers. All the other employees are only allowed to answer queries about current balances. OK, so what happens if the leader has a stroke and dies after they’ve received some new data, but before they’ve told everyone else about it? What if a “follower” employee has a temporary seizure for a few seconds and misses some data updates from the leader? What if we’re never entirely sure which of our employees are dead or alive?\nThis is not an approximate metaphor that breaks down if you look too hard or start asking awkward questions. Understand this weird call-centre and you understand database replication. Read this blog post and you really understand replication.\nBackups\nIn addition to realtime replication, we also store regular backups of our entire database in order to protect against catastrophic disaster. We copy all of the data in our database, store it somewhere safe, and mark it as something like “database backup, 2020-05-11:01:00”.\n<code>+----------+ | Database +----------------&gt; database backup, 2020-05-11:01:00\n+----------+ database backup, 2020-05-10:01:00 database backup, 2020-05-09:01:00\n</code>\nIf our entire database - or some fraction of it - somehow gets wiped out, we grab the most recent backup available and load it into new database machines.\n<code>+----------+\n| New |\n| Database +&lt;---------------- database backup, 2020-05-11:01:00\n+----------+ database backup, 2020-05-10:01:00 database backup, 2020-05-09:01:00\n</code>\nSuch a calamity could be caused by a cyberattack, a disaster in our data centre, a database migration gone horribly wrong, or any number of unlikely but potentially company-destroying reasons. Unlike realtime replication, restoring a database from a backup is a slow process that our users will definitely notice. Our entire system will likely be offline until the restoration is complete. We will have lost all database updates that occurred after the last backup but before the disaster. And there will no doubt be a large number of knock-on effects as users and systems try to access data that used to be there but is now lost forever. Nonetheless, these are all much less terrible than the complete, irrevocable loss of all our company’s data and with it, our company.\nThat’s a whole lot of detail about our primary SQL database. Let’s talk about some other ways in which we store and query data.\nFree-text searching\nA standard SQL database is very good at answering well-defined and specific queries. For example:\nGive me all the item listings created by user #145122 in the last 90 days\nGive me the listing details for item #237326921\nGive me the count of new listings per day created in San Francisco with the label “Electronics”\nYou can retrieve this kind of data using SQL queries that look something like this:\n<code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">user_id</span> <span class=\"o\">=</span> <span class=\"mi\">145122</span> <span class=\"k\">AND</span> <span class=\"n\">created</span> <span class=\"o\">&gt;</span> <span class=\"n\">currentDate</span><span class=\"p\">()</span> <span class=\"o\">-</span> <span class=\"mi\">90</span>\n</code>\nor\n<code><span class=\"k\">SELECT</span> <span class=\"n\">DATE_TRUNC</span><span class=\"p\">(</span><span class=\"s1\">'day'</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">created</span><span class=\"p\">)</span> <span class=\"k\">AS</span> <span class=\"k\">day</span><span class=\"p\">,</span> <span class=\"k\">COUNT</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span> <span class=\"k\">AS</span> <span class=\"n\">i</span>\n<span class=\"k\">INNER</span> <span class=\"k\">JOIN</span> <span class=\"n\">labels</span> <span class=\"k\">as</span> <span class=\"n\">l</span> <span class=\"k\">ON</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">id</span> <span class=\"o\">=</span> <span class=\"n\">l</span><span class=\"p\">.</span><span class=\"n\">item_id</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">city</span> <span class=\"o\">=</span> <span class=\"s1\">'San Francisco'</span> <span class=\"k\">AND</span> <span class=\"n\">l</span><span class=\"p\">.</span><span class=\"nb\">text</span> <span class=\"o\">=</span> <span class=\"s1\">'electronics'</span>\n<span class=\"k\">GROUP</span> <span class=\"k\">BY</span> <span class=\"mi\">1</span>\n<span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"mi\">1</span> <span class=\"k\">DESC</span>\n</code>\nYou’ll notice that these queries contain a lot of very “precise” operators, like equals- and greater-than-signs. But how would you write a SQL query that could return a list of items that match a Google-style “full-text” search, like “second-hand TV”?\nThis would be difficult. You could try the SQL LIKE operator, which allows you to find records containing a pattern, such as a sub-string. For example, the following query finds all items with a description containing the sub-string second-hand TV:\n<code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second-hand TV%'</span>\n</code>\nHowever, this query will only match the very specific sub-string that it was given. It won’t match “TV that is second-hand” or “2nd-hand TV”, or “sceond-hnad TV”. Given enough perseverance you could theoretically construct a giant SQL-query that covered as many of these permutations as you had patience for:\n<code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second%hand%TV'</span> <span class=\"k\">OR</span> <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second%TV%hand'</span> <span class=\"k\">OR</span> <span class=\"c1\">-- …and so on and so on for another bajillion ORs…</span>\n</code>\nHowever, the resulting query would be slow and cumbersome, and would still miss many important edge-cases that you hadn’t thought of. And even if you did get back a useful list of search results, you’d still have a lot of work left to do in order to decide how to order them. The ordering you want isn’t something strict like “most-recent first” or “alphabetically by title”. Instead it’s some much woolier notion of “best” or “most-relevant” first.\nAll of this means that SQL databases are generally not very good at full-text searches. Fortunately, other types of database are, including one called Elasticsearch. Elasticsearch is often described as a document-oriented database. We don’t need to go into the details of how exactly it works, but the important part for us is that, unlike SQL databases, Elasticsearch is very good at taking queries like “second-hand TV” and returning a list, ordered by “relevance,” of the fuzzy matches that users have come to expect from their search engines.\n“Sounds like Elasticsearch is just better than SQL,” you might say. “Should we throw away our SQL databases and put everything in Elasticsearch instead?” Not so fast. Elasticsearch, and other databases like it, have their strengths, but they also have their weaknesses. They’re typically somewhat less reliable than SQL databases, and are somewhat more likely to accidentally lose data at large scale. They’re also often much slower to write new data to.\nAs we’ve already noted, there’s rarely a single, universally “best” tool for any type of job. There’s certainly no such thing as “the best” database. Instead, different databases have different strengths and weaknesses, and different solutions are appropriate for different tasks. At Steveslist, we care so much about making sure that we use the right tool for the right job that we store our data in both a SQL database and a document-oriented database like Elasticsearch.\nWe use our SQL database as our primary data store. It is our authoritative “source-of-truth”, and we write all our new data to it before we write it anywhere else. We do all our simple, precise reads from it, especially when accuracy and up-to-date-ness are our principal requirements. If we want to show a user a list of all their open listings, we read it from our SQL database. If we want to validate a users password, we read that from our SQL database too. This plays to the strengths of SQL databases.\nHowever, in the background we also copy data from our SQL database into an Elasticsearch database, and send any full-text search queries made via our search box to Elasticsearch. This means that we benefit from the strengths of Elasticsearch, and are not impacted too much by its weaknesses. We copy over batches of records every few minutes, hours, or days, depending on the requirements of the specific dataset. Alternatively, we could watch the logs of our SQL database for new or updated records, and create or update the corresponding Elasticsearch records in near-realtime.\n<code> | | |\nNew data is always | |Queries for |Full-text search written to the SQL | |specific data go |queries go to\nDB first | |to the SQL DB too |Elasticsearch V V V +--------------+ +---------------+ | SQL Database +------&gt;+ Elasticsearch | +--------------+ +---------------+ New data is copied over from the SQL DB to Elasticsearch\n</code>\nWhen scouting Steveslist’s competition, I noticed that when you create a new Craigslist listing it says “your listing will be visible in search within the next 15 minutes”. I’ll bet pesos to pizza that this is because their primary datastore is a SQL database, but their search box is powered by an Elasticsearch-like engine. Their pipeline for replicating data from SQL to search probably takes around 15 minutes, which they’ve decided (very reasonably) is an acceptable delay for their particular use-case.\nWe’ve said that Elasticsearch is somewhat less reliable than most SQL databases. If Elasticsearch accidentally loses a few of our records then they won’t appear in search results. This would be a shame that would make our product a bit worse, and we try our hardest to avoid it happening. However, it wouldn’t be a disaster in the same way that losing data from our primary data store would be. We only copy data over to Elasticsearch once it has been written to and safely captured by our source-of-truth SQL database, which is what really matters.\nIt’s 6pm, and the library is closing. A librarian tries to ask you to leave. Kate shoos him away with a barrage of crumpled-up balls of paper.\nInternal tools\nManaging the Steveslist platform requires bespoke internal tools. We need to perform a wide range of administrative tasks, like deleting listings that are too illegal (even for us), issuing refunds, viewing a user’s personal details in order to help with support requests, and so on. Many of these tools will be used by people who work on other teams at Steveslist, like finance, compliance, legal, sales, and support. Since the tasks they need to perform are so specific to the way that Steveslist works, we can’t do them using third-party tools, and have to build our own instead.\nIn the early days, we baked this functionality into the main Stevelist product and only exposed it to users who had the is_steveslist_employee = True database flag set. This was an OK approach for a small company, but was also fragile and easy to mess up. It was scary to think that we were exposing all of our superuser powers through the same servers that run our main product. It made the potential consequences of a security flaw in our application much worse, and created new types of mistake for us to make, such as forgetting to disable the is_steveslist_employee flag for an acrimoniously fired employee.\nOnce Steveslist reached a certain level of maturity, we built ourselves an entirely separate admin platform, with separate, hardened authentication and authorization. The service runs on entirely separate servers, and requires a VPN and a TLS client certificate to access (which we’ll talk about another day). This separated out our internal- and external-facing products, and drastically reduced the chance of a boneheaded error exposing our admin tools to the world. We’re frequently building new internal tools - one for user administration, one for server management, one for fraud detection, and so on. These services all talk to the same database as our user-facing products, so they all have access to the same data. They just run on different servers that are completely inaccessible to the outside world.\nCron jobs\nThere are lots of tasks that we’ll want our system to perform at fixed times and intervals. For example:\nEmailing ourselves weekly usage reports\nSending marketing emails to users\nCharging the credit cards users who have a subscription plan with us\nCopying data from our SQL database to Elasticsearch\nThe most common tool used for running scheduled jobs is called cron, a tool that is built into Unix operating systems. It’s so common that people will often call any kind of scheduled job a “cron job”, even when it’s not actually being run by cron.\nYou can set up a cron job on your own computer by running:\n<code>crontab -e\n</code>\nThen typing into the prompt:\n<code>*/5 * * * * $YOUR_COMMAND\n</code>\nThis will cause your computer to execute $YOUR_COMMAND every 5 minutes.\nSteveslist currently has a very simple and slightly fragile cron setup. We have a single “scheduled jobs server”. We use crontab on this server (as above) to tell it the commands that we want it to run, and the schedule that we want it to run them on. This setup isn’t scaling very well - if the scheduled jobs server explodes or even hiccups then we don’t always know which jobs it did and didn’t run, and have to scramble to bring up a replacement server. And even though the server is very beefy and powerful, eventually we’re going to want to run more jobs than it can handle at once. We’re considering either splitting up our cron jobs into multiple servers, or setting up a new system using a modern tool like Kubernetes.\nPubsub\nActions have consequences. This is both the subject line of the sinister emails that we send to people who write mean things about us on the internet, and the reason we have a pubsub system.\nWhen a new user signs up, we want to send them an email welcoming them to Steveslist and reminding them about the action-consequence relationship I just described. When a new listing is added for a stolen TV in San Francisco, we want to notify users who have set up search alerts for TVs in the Bay Area. When a card is declined for a subscription, we want to email the responsible user to politely threaten them. When a new listing is added, we want to perform some extremely cursory anti-fraud checks. When an item is purchased, we want to sent a webhook to its seller. And so on.\nTechnically, all of these actions could be performed synchronously (rememberer that word?) by the server executing the initiating action. However, this is often a bad idea, for two reasons. First, the response action (such as emailing all the users who are subscribed for notifications about new stolen TVs) may be very slow. Performing the response action synchronously means that if the initiating action was performed by a user then they will have to wait for all the response actions to finish too. This might not be the end of the world if the response action is small and quick, like sending a single email. But if it’s larger - like searching for and notifying all users who might be interested in a new item - then, well, it still won’t be the end of the world, but it will be a bad user experience.\nTo mitigate this problem we have built a “publish-subscribe” or “pubsub” system. When a trigger action is performed, the code that performs it “publishes an event” describing the action, such as NewListingCreated or SubscriptionCardDeclined. The words “event” and “publish” are quite loosely defined in this context, and don’t have a rigorous technical definition. An event is just some sort of record of something that happened, and to publish an event just means that you somehow make a note that something happened. The details of how you do so depend entirely on the pubsub system in question. In a simple system events might be stored in tables in a SQL database, and code would publish events by writing new records to a table.\nIf a programmer at Steveslist wants a response action to be performed whenever a new event of a particular type is published, they can write a consumer. This is a piece of code that “subscribes” to a type of event, and which is executed whenever a new event of that type is published. It uses the details of the event (for example, the user whose subscription payment failed) to asynchronously execute whatever actions the programmer wants (for example, sending the user a menacing email).\nPubsub systems are often managed by a central message broker. Systems publish events to the broker, and the broker is then responsible for getting the events to any subscribed consumers. This can be achieved using either a push or a pull mechanism. Consumers can pull messages from the broker by polling it and repeatedly asking “any new events? any new events?” or they can wait and listen and the broker can push notifications of new events out to them, for example by sending them an HTTP request.\n<code>1. New user signs|\nup to Steveslist | v +-----------------+ +------------------------+ |Steveslist Server| +--&gt;+SendWelcomeEmailConsumer| +---------+-------+ | +------------------------+ | v\n2. Server reports| +-------------++ 4. Consumers send welcome\na NewUserSignup +----&gt;+Pub/Sub Broker| emails, check for spam,\nevent to the +-------------++ etc.\nPub/Sub system ^ 3. Pub/Sub broker | +------------------------+ notifies consumers +--&gt;+NewUserSpamCheckConsumer| that have subscribed to +------------------------+ NewUserSignup events.\n</code>\nPubsub systems have many benefits:\nNon-critical actions are performed asynchronously, keeping the user experience snappy\nOur code is kept clean and well-separated. The code that publishes an event doesn’t have to care about what the events’ subscribers do in response\nIf a subscriber’s action fails for some reason (for example, the email-sending system has a hiccup), the pubsub system can note this failure and retry again later\nNext, let’s talk big data.\nBig data and analytics\nIn order to understand and optimize our business, we need to be able to calculate complex statistics across the entire Steveslist platform. How many listings are created every day, segmented by country and city? How many users who signed up each month have created a listing within 90 days of signing up?\nTo do this, we need to write database queries that aggregate over the entirety of our data. We don’t want to run these queries against our production SQL database, because they could put an enormous amount of load on it. We don’t want a huge query issued by an internal analyst to be able to bring our production database to a grinding halt, but we do want to provide this analyst with a tool that is well-suited to their needs. To complicate matters further, database engines that are quick at small queries (like returning all the listings belonging to a single user) are typically unacceptably slow (or indeed incapable) of answering giant queries (like calculating the total dollars spent on listings in each category, per day, for the last 90 days).\nDespite this, for the first year or so after Steveslist was founded, we took a risk and simply ran our analytics queries against the main production database. This was a gamble, but it just about worked. We didn’t have much data anyway, and we had more important things to focus on, like attracting the customers who would create the big data that would one day mean that we had to find a more scalable solution.\nEventually we did bring down the production database with an overly-ambitious query, and decided that the time had come to invest in a data warehouse. A data warehouse is a data store that is well-suited to large, system-wide queries. Our warehouse is powered by a database engine called Hive, but we could also have chosen Presto, Impala, Redshift, or any number of competing alternatives. Hive accepts queries written in SQL, but is much better at executing these queries against giant datasets than our MySQL database is.\nWe replicate our data from our production SQL database to Hive, once a day, overnight. Steveslist analysts and programmers can query the same dataset using whichever database engine best suits their needs. They can use the production SQL database for small, precise, source-of-truth queries from production systems; Elasticsearch for full-text search queries; or the data warehouse for huge queries that aggregate over vast volumes of data.\nIt’s dark outside and you’re hungry. Is that pretty much it? you ask.\n“Oh god no,” Kate replies, “we could keep going forever. But this is a pretty good start. It’s helpful to have a broad understanding of a wide range of topics, but no one needs to know the details about everything. I find that once you know some basics you can keep picking up more basics and even a couple of details as you go along.”\nYou ask if Kate could perhaps continue to elaborate on her five-year vision for Steveslist tomorrow.\n“Absolutely,” says Kate. We’ll talk about more of what goes on inside a real, large online platform, including:”\nSecurity\nHTTPS and other forms of encryption\nTwo-factor authentication\nSAML\nSecret key management\nServer management\nDeploying new code\nAWS and competitors\nTerraform\nLoad balancers\nContainers\nAlerting when code breaks\nBig data\nMap-reduce and other big data jobs\nMachine learning\nUser tracking\n“See you tomorrow at 7am?”\nFollow me on Twitter or RSS\nGet new essays sent to you\nSubscribe to my new work on programming, security, and a few other topics. Published a few times a month.\nNEW: Also subscribe to my new series, Programming Feedback for Advanced Beginners\nMore on Programming Projects for Advanced Beginners\nPFAB #13: When code is too clever to be clean\nPFAB #11: Separating logic and data\nPFAB #10: First-class functions and dependency injection\nPFAB #9: Batch vs Stream processing\nPFAB #8: Input validation - tradeoffs between convenience and surprise\nPFAB#7: How to write a library\nPFAB#6: Real-world debugging practice\nPFAB#5: How to make your programs shorter\nPFAB#4: Exception handling and coping with failure\nPFAB#3: How to rigorously analyze your journey to work\nPFAB#2: How to structure your programs\nPFAB#1: Define your boundaries\nProgramming Feedback for Advanced Beginners #0\nI will give you feedback on your code\nProgramming Projects for Advanced Beginners #6: User Logins\nReal-World Programming Projects for Advanced Beginners\nProgramming Videos for Advanced Beginners #1: Battleships\nOpen Source for Advanced Beginners #1: bashplotlib\nOpen Source for Advanced Beginners\nWhat beginner's mind is really like\nProgramming Projects for Advanced Beginners\nProgramming Projects for Advanced Beginners #5: Snake\nProgramming Projects for Advanced Beginners #4: Photomosaics\nProgramming Projects for Advanced Beginners #3b: Tic-Tac-Toe AI\nProgramming Projects for Advanced Beginners #3a: Tic-Tac-Toe AI\nProgramming Projects for Advanced Beginners #2: Game of Life\nProgramming Projects for Advanced Beginners #1: ASCII art\n◀ How to make yourself happier by making your iPhone worse\nHundreds of companies assert usage rights over all ideas sent through their services ▶\nHome / Archive / RSS / Twitter / Office hours / Tipoffs / SoundCloud /","cname":"面向高级初学者的系统设计","ctext":"罗伯特·希顿\n软件工程师/单轨爱好者/双向走\n关于\n封存\n推特\n新：面向高级初学者的编程反馈\n面向高级初学者的系统设计\n2020年4月6日\n这篇文章是我的《高级编程入门》系列的一部分。 立即订阅，即可获得每隔一周免费的特定，可行的方式来使代码更整洁。\n您已经与好朋友史蒂夫·史蒂文顿（Steve Steveington）开了另一家公司。 这是一个在线市场，人们可以买卖东西，没有人问太多问题。 它基本上是Craigslist的翻版，但使用Steve的名字而不是Craig的名字。\n您将负责构建整个Steveslist技术平台，包括其所有网站，移动应用程序，数据库和其他基础结构。 您很兴奋，但也很紧张。 您认为您可能可以将一个小型网站拼凑在一起，因为您之前已经做过几次，这是您以前与Stevester进行的在道德上令人质疑的娱乐活动的一部分。 但是，您甚至不知道如何开始构建您认为位于大型成功在线平台后面的所有其他基础架构和工具。\n您迫切需要真实公司如何进行详细而简洁的概述。 他们如何存储数据？ 他们的不同应用程序如何相互通信？ 他们如何扩展他们的系统以服务于数百万用户？ 他们如何确保它们的安全？ 他们如何确保没有问题？ 当您真正了解它们时，什么是API，webhooks和客户端库？\n您将快速的WhatsApp发送给您的另一个好朋友Kate Kateberry，以查看她是否可以提供帮助。 您过去的合作非常有效，她在硅谷最大，最具争议的公司中创建此类系统已有数十年的经验。\n她立即接受您的工作机会。 实际上，您只是想得到一些粗略的指导和好的八卦，但是您却立即接受了她的接受。 即使没有钱付给她，也毫无意义。 凯特建议她的第一天是5周前，以帮助她解决一些会计违规问题。 她下周某个时候可以来办公室。 她的急切使您感到鼓舞和威胁。\n凯特（Kate）在旧金山公共图书馆的19世纪文学专区进入您的办公室。 “好的，我们做吧！” 她安静地大喊。 “到目前为止，我们得到了什么？ 我们所有的系统如何设置？ 有什么计划？” 您向后靠在椅子上，合上笔记本电脑，由于您将充电器留在家里，笔记本电脑没有打开。 您以希望被描述为“周到”的方式竖起手指。\n“让我把这个问题转过来，凯特。 您认为该计划应该是什么？”\n凯特深吸一口气，对未来五年Steveslist平台以及为其提供动力的基础架构描绘了极为详尽的愿景。\n在开始之前（凯特说），我想明确地说，我并不是说所有这一切都必然是建立基础架构的“正确”方法。 如果您比我更信任一个人说了些不同的话，那么您可能应该按照他们说的去做。 有很多工具，每种工具都有各自的优点和缺点，并且有很多建立技术公司的方式。 我们会做出许多技术选择的真实原因是：“我们选择X是因为Sara对X的了解很多”，“我们选择了Y的那一刻似乎并不是一个重大决定， 我们从来没有时间重新评估。”\n尽管如此，让我们将未来的五年向前迈进。 现在Steveslist有两种主要的面向消费者的产品：\nSteveslist Web应用程序\nSteveslist智能手机应用程序\n这些是用户直接与Steveslist平台进行交互的主要方式。 此外，我们还提供了一个API，允许程序员在Steveslist平台上构建强大的工具，例如，以编程方式为数百个项目创建清单。 为此，我们提供：\nSteveslist API\nSteveslist API客户端库，使程序员可以轻松编写与我们的API对话的代码\n在这里，我将在白板上绘制一个图：\n<code>+-----------+ +--------------+ +-----------------+\n|Web Browser| |Smartphone App| |Client Libraries/|\n+-----+-----+ +------+-------+ |Other API code | | | +-------+---------+ | v | | +-----+------+ | +---------&gt;+ Steveslist +&lt;-----------+ | Servers | +------------+\n</code>\n最后，我们在后台运行着许多服务，这些服务为这些面向外部的应用程序提供数据和功能：\nWebhooks-通知用户帐户发生问题时，例如“下订单”\n用户密码验证-安全登录用户\nSQL数据库-主要的Steveslist数据存储。 需要高度可扩展性和可靠性\n自由文本搜索系统-为搜索框提供动力，使人们可以在其中搜索“电视”或“摩托车”等广泛的搜索词\n内部工具-帮助我们管理Steveslist平台，并采取诸如向恶意用户发出严厉警告的措施\nCron作业-执行常规任务，执行所有工作，从生成发票，向客户开账单到将我们尽可能多的用户数据发送到第三方广告网络\n“ Pubsub”系统-允许我们对不同的触发事件采取异步操作（例如“当新用户注册后，向他们发送欢迎电子邮件”）\n大数据分析系统-使我们能够对Steveslist的整个数据进行大量查询\n还有很多我们会谈论的另一天\n让我们依次浏览每个系统。 如果有任何不清楚的地方，如果您有任何疑问，或者您认为我有什么问题，请告诉我。\n在开始之前-真正的服务器是什么？\n在开始之前，我们先定义一些重要的术语。 实际上，我们只定义一个。 今天，我们将讨论很多有关“服务器”的内容。 但是，什么才是真正的服务器呢？\n就我们的目的而言，服务器是一台在网络上运行并侦听来自其他计算机的通信的计算机。 当它从另一台计算机接收到一些数据时，它会执行某种响应，并且通常会发回自己的一些数据。 例如，Web服务器在网络上侦听HTTP请求，并作为响应发送回网页和信息。 数据库服务器侦听数据库查询，并将数据读写到正在运行的数据库中。\n此简短描述省略了整个学位和详细职业的介绍，并且当然还有定义“服务器”一词的更加精确的方法。 但这应该可以使我们度过晚餐。 你说什么？ 真正的“网络”是什么？ 改天问一个好问题。\n现在，我们准备讨论Steveslist平台。\nSteveslist Web应用程序\n这是Steveslist的主要产品。 这只是一个普通的网络应用，除了规模更大之外，与您之前建立的任何网站都非常相似。 这是现代的“单页应用”（SPA）。 “单页应用程序”中的“单页”是指这样的事实，即用户点击浏览我们的网站时，用户的浏览器几乎无需完全重新加载页面。 相反，当浏览器向我们的服务器发出第一个HTTP请求时，我们将其发送回基本的基本HTML页面和大量JavaScript代码。 该JavaScript代码在浏览器内部执行，并响应用户的操作更新页面视图。 当JavaScript要发送来自Steveslist的数据或从Steveslist检索数据时，它将在后台向URL发送一个异步JavaScript XML请求（简称为AJAX）。 当我们的服务器响应时，JavaScript使用响应来相应地更新浏览器视图。\n<code>+----------+1.User's browser visits steveslist.com. +----------+\n| | It sends an HTTP request to the | |\n| | Steveslist servers | |\n| +---------------------------------------&gt;| |\n|User's Web| |Steveslist|\n| Browser |2.Steveslist server responds with a | Servers |\n| | skeleton HTML page that instructs the | |\n| | browser to request additional | |\n| | JavaScript files. | |\n| |&lt;---------------------------------------+ |\n| | | |\n| |3.User's browser requests and receives | |\n| | these JavaScript files from the | |\n| | Steveslist server. | |\n| +---------------------------------------&gt;| |\n| |&lt;---------------------------------------+ |\n| | | |\n| |4.User's browser executes the JavaScript| |\n| | code. The code sends more requests for| |\n| | the user's data to the Stevelist | |\n| | server, and updates the browser UI to | |\n| | display it. | |\n| +---------------------------------------&gt;| |\n| |&lt;---------------------------------------+ |\n+----------+ +----------+\n</code>\n这个不是一个页面应用程序。 每当您单击链接时，浏览器都必须重新加载整个页面。 twitter.com是单页应用程序。 每当您单击链接时，浏览器都会动态更新页面的一小部分，而不会强制进行完全刷新。\nSPA需要大量的工作来构建和维护，但是看起来确实不错。\nSteveslist智能手机应用\n我们提供适用于iOS和Android的Steveslist智能手机应用程序。 从概念上讲，它们与我们的单页Web应用程序非常相似。 我们的智能手机和Web应用都向我们的服务器发出HTTP请求。 然后我们的服务器接收这些请求，执行一些工作并返回HTTP响应。 最后，我们的智能手机和网络应用程序都会更新其显示，以便与用户进行交流。\n由于我们的智能手机应用程序执行与Web应用程序相同的操作（例如，创建列表，发送消息等），因此它们通常甚至可以将请求发送到与Web应用程序完全相同的URL。 我们要做的唯一的额外工作就是开发应用程序本身的前端。 某些框架甚至可以使用JavaScript编写移动应用程序，从而使您可以跨平台重用代码和逻辑。\nSteveslist API\n我们允许用户和第三方编写以编程方式与我们的平台进行交互的代码。 人们可以使用Twitter API编写读取代码的方式； 喜欢 并创建推文，我们允许他们使用Steveslist API进行搜索； 购买; 并列出项目。\n程序员通过编写向我们的API端点发出HTTP请求的代码来使用我们的API。 例如，为了检索所有列表的列表，程序员将HTTP GET请求发送到api.steveslist.com/v1/listings。 我们以他们要求的数据作为响应，格式为JSON。 JSON代表JavaScript Object Notation，但是JSON并非特定于JavaScript，并且可以轻松地由任何编程语言解释。 检索用户所有列表的请求的JSON响应如下所示：\n<code><span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">listings</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"p\">[</span> <span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">id</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">2178123867</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">name</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">Stolen TV</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">country</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">US</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">city</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">San Francisco</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_amount</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">1000</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_currency</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">usd</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"err\">#</span> <span class=\"nx\">etc</span><span class=\"p\">...</span> <span class=\"p\">},</span> <span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">id</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">182312679</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">name</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">Stolen Bicycle</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">country</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">US</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">city</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">San Francisco</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_amount</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">2000</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price_currency</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">usd</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"err\">#</span> <span class=\"nx\">etc</span><span class=\"p\">...</span> <span class=\"p\">}</span> <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code>\n对于程序而言，这种结构化的响应格式非常容易解析，这意味着发出请求的代码可以轻松地解释和使用我们API中的数据。\n用户使用API密钥识别或验证我们的API。 粗略地说，这相当于密码的API。 这是一个很长的随机字符串，我们生成并显示在用户的“设置”页面上。 用户将他们的API密钥作为HTTP标头包含在他们（或其代码）对API提出的每个HTTP请求中。 收到API请求后，我们将检查以查看附加的API密钥是否对应于Steveslist用户。 如果有，那么我们代表该用户执行请求。\n如果程序员愿意，他们可以使用其语言的标准HTTP库手动向我们的API手动构建HTTP请求。 例如，在Python中，他们可能会写：\n<code><span class=\"kn\">import</span> <span class=\"nn\">requests</span> <span class=\"n\">url</span> <span class=\"o\">=</span> <span class=\"s\">'https://api.steveslist.com/v1/listings/'</span>\n<span class=\"n\">listing_params</span> <span class=\"o\">=</span> <span class=\"p\">{</span> <span class=\"s\">\"name\"</span><span class=\"p\">:</span> <span class=\"s\">\"Stolen TV\"</span><span class=\"p\">,</span> <span class=\"s\">\"country\"</span><span class=\"p\">:</span> <span class=\"s\">\"US\"</span><span class=\"p\">,</span> <span class=\"s\">\"city\"</span><span class=\"p\">:</span> <span class=\"s\">\"San Francisco\"</span><span class=\"p\">,</span> <span class=\"s\">\"price_amount\"</span><span class=\"p\">:</span> <span class=\"mi\">1000</span><span class=\"p\">,</span> <span class=\"s\">\"price_currency\"</span><span class=\"p\">:</span> <span class=\"s\">\"usd\"</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n<span class=\"n\">api_key</span> <span class=\"o\">=</span> <span class=\"s\">\"YOUR_API_KEY_GOES_HERE\"</span> <span class=\"n\">response</span> <span class=\"o\">=</span> <span class=\"n\">requests</span><span class=\"o\">.</span><span class=\"n\">post</span><span class=\"p\">(</span> <span class=\"n\">url</span><span class=\"p\">,</span> <span class=\"n\">data</span><span class=\"o\">=</span><span class=\"n\">listing_params</span><span class=\"p\">,</span> <span class=\"n\">headers</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"s\">\"X-Steveslist-API-Key\"</span><span class=\"p\">:</span> <span class=\"n\">api_key</span><span class=\"p\">},</span>\n<span class=\"p\">)</span>\n</code>\n但是，通过提供客户端库，我们使程序员的生活更轻松。\nSteveslist客户端库\n客户端库是一个“包装” Steveslist API功能的库。 这意味着使用客户端库的任何人都无需了解Steveslist API的详细信息。 相反，他们可以只写：\n<code><span class=\"kn\">import</span> <span class=\"nn\">steveslist</span> <span class=\"n\">listing</span> <span class=\"o\">=</span> <span class=\"n\">steveslist</span><span class=\"o\">.</span><span class=\"n\">Listing</span><span class=\"o\">.</span><span class=\"n\">create</span><span class=\"p\">(</span> <span class=\"n\">name</span><span class=\"o\">=</span><span class=\"s\">\"Stolen TV\"</span><span class=\"p\">,</span> <span class=\"n\">country</span><span class=\"o\">=</span><span class=\"s\">\"US\"</span><span class=\"p\">,</span> <span class=\"n\">city</span><span class=\"o\">=</span><span class=\"s\">\"San Francisco\"</span><span class=\"p\">,</span> <span class=\"n\">price_amount</span><span class=\"o\">=</span><span class=\"mi\">1000</span><span class=\"p\">,</span> <span class=\"n\">price_currency</span><span class=\"o\">=</span><span class=\"s\">\"usd\"</span><span class=\"p\">,</span> <span class=\"n\">api_key</span><span class=\"o\">=</span><span class=\"s\">\"YOUR_API_KEY_GOES_HERE\"</span>\n<span class=\"p\">)</span>\n</code>\n我们的库将给定的参数转换为格式正确的HTTP请求，然后将它们正常发送到Steveslist API。 我们已经为我们能想到的每种主要编程语言编写了客户端库，这是迄今为止人们与我们的API交互的最常见方式。\n网络挂钩\n我们已经了解了Steveslist用户如何使用我们的API与他们的帐户进行编程交互。 另外，许多用户还希望我们在他们的Steveslist个人资料发生问题时主动告诉他们。 例如，假设某人想要完全自动化在Steveslist上销售商品的过程。 每当客户使用我们新的，最安全的StevePay系统为商品付款时，他们都想向客户发送一封感谢信，并自动指示其仓库将被盗的电视机运送到订购地址。 我们的卖方可以不断重复查询Steveslist API，询问“是否有新交易？ 有新的销售吗？” 但是，这将非常低效，并且会给我们的服务器带来很多不必要的负载。\n相反，我们提供了一个称为webhooks的行业标准系统。 Webhook是一个HTTP请求，只要他们的帐户发生问题，我们就会将其发送给用户。 它包含描述刚刚发生的事件的所有数据-例如，商品ID，价格，买家ID，买家地址等。 Webhooks允许用户自动执行响应操作，例如上述电子邮件和自动运送。\n要使用Webhook，用户会告诉我们他们希望我们向其发送Webhook的URL（例如，steveslistwebhooks.robertheaton.com。他们在该URL上设置了Web服务器，该Web服务器将接收并处理这些Webhook通知。\n<code>1.Buyer purchases an 3.The seller's server receives the webhook, item as normal. and uses the information in it to automatically process the order.\n+---------------+ +-----------------+\n|Buyer's Browser| |Seller's Webhook-+\n+------+--------+ |Receiving Server | | +------+----------+ | ^ | | | | | +-----------+ | +---&gt;+ Steveslist+----------+ | Server | +-----------+ 2.Once the transaction has been completed, Steveslist looks up the seller's webhook URL (if set). We then send an HTTP request to this URL, containing the details of the purchase.\n</code>\n用户在收到来自我们的webhook时，会将代码部署在其Web服务器上，以执行适当的响应操作。 我们不仅在购买商品时发送网络钩子，还在用户收到消息时发送它们。 当管理员删除其中一项时； 或买家提出投诉时。 这使Steveslist卖家不仅可以自动化商品清单，还可以实现商品的销售和运输自动化。\nWebhook并发症\nWebhook具有两个主要的复杂性-安全性和可靠性。 首先，我们来谈谈安全性。 互联网上的任何人都可以访问卖方指示我们向其发送网络挂钩的端点。 知道该URL的任何人都可以向其发送假冒的Webhook，并且如果我们的卖方不小心，这可能会使攻击者诱骗他们，例如向其发送免费的东西。 卖方的Webhook URL应该很难找到，因为卖方不会公开其存在，但模糊性与安全性并不相同。\n为了让我们的卖家验证Steveslist确实发送了一个Webhook，我们对Webhook的内容进行了加密签名。\n加密签名\n密码签名是一个深刻而微妙的话题。 这是我们使用它来保护网络钩子的简明版本。\n当卖家为其帐户启用网络挂钩时，我们会生成一个随机的“共享密钥”。 我们告诉卖方将密钥复制到他们的Webhook接收服务器上并保持其安全性，以使密钥的价值只有我们和卖方才能知道。 每当我们发送一个Webhook时，我们都会使用这个共享的秘密，通过使用称为HMAC的加密散列函数将其与Webhook的内容结合起来，并为该Webhook获取一个长的，随机的，但完全确定的“签名”。\n<code>Webhook contents +----------+\n(eg. {\"id\": 123...}) | v +---+----------+ |HMAC Algorithm|-----&gt;Webhook signature +---+----------+ ^\nShared secret key |\n(eg. 123mhu23jy8xdwgmd...)+---+\n</code>\n我们将此签名包含在我们的webhook正文中，例如：\n<code><span class=\"p\">{</span> <span class=\"dl\">\"</span><span class=\"s2\">action</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">item_sold</span><span class=\"dl\">\"</span><span class=\"p\">,</span> <span class=\"dl\">\"</span><span class=\"s2\">price</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"mi\">100</span><span class=\"p\">,</span> <span class=\"c1\">// ...more params...</span> <span class=\"dl\">\"</span><span class=\"s2\">signature</span><span class=\"dl\">\"</span><span class=\"p\">:</span> <span class=\"dl\">\"</span><span class=\"s2\">234gj98d49j834978gf39t78ndn98g7dq3ng897308y7</span><span class=\"dl\">\"</span>\n<span class=\"p\">}</span>\n</code>\n当卖方的Webhook接收服务器收到Webhook时，它将获取共享的机密和Webhook内容，并以与我们完全相同的方式计算期望签名的内容。 它将结果与连接到网络挂钩的签名进行比较； 如果它们匹配，则它接受并处理Webhook。 由于只能使用我们和卖方仅知道的共享机密来生成签名，因此Webhook接收服务器可以确信Webhook是由我们发送的。 但是，如果签名不匹配，则服务器拒绝该Webhook。\n请注意，所有签名验证代码都必须由卖方编写和维护。 我们可以向他们提供鼓励和示例，但我们不能强迫他们正确甚至根本无法验证签名。 对于一些实际示例，请查看Stripe和GitHub如何签署他们的Webhooks。\n可靠性\n我们还需要考虑当我们的网络钩子出现错误时会发生什么，以及我们想为我们的用户提供哪些保证。 如果我们尝试发送Webhook但无法连接到用户的服务器，该怎么办？ 如果我们成功连接到他们的服务器并发送了Webhook，但是他们的服务器发回了错误，该怎么办？ 如果我们发送了Webhook，但是服务器挂起了二十秒钟，然后断开连接却没有告诉我们发生了什么，该怎么办？\n这里涉及到权衡，需要清晰的沟通和数量惊人的基础架构来管理。 我们在Steveslist的选择是保证我们将“至少一次”交付webhooks。 这意味着，如果一个Webhook发送失败，那么我们将继续尝试（很多次但不是无限次），直到发送成功为止。 如果不确定网络挂钩是成功还是失败，我们将继续尝试直到确定成功为止。 这有时可能会导致我们两次发送相同的Webhook，但是卖方有责任让其代码优雅地处理此问题，而不是向同一位客户发送五台被盗的电视，而不是向他们订购的一台。\n“到目前为止你怎么看？” 凯特问。 “这大概就是您一直在想的吗？” 您面无表情，大吃一口附近的三明治，以免进行任何进一步的讨论。 凯特继续：\n让我们谈谈将支持我们一些最重要功能的后端系统。\n通过密码进行用户验证\n大多数用户使用用户名和密码登录Steveslist网站和智能手机应用程序。 还有其他登录网站的方式，例如OAuth-我们将再次介绍它们。\n我们将必须非常安全地存储用户的密码。 用户密码不仅是登录（或验证）Stevelist所使用的密码，而且对于许多用户而言，尽管也有所有警告，它们可能也与登录其他许多服务时使用的密码相同。 一个坏主意。 毕竟，他们只有这么多的孩子有这么多的生日。\nRupert Herpton已撰写了有关如何保护密码的开创性教程，我相信您已经阅读了。 万一您需要复习一下，问题的关键是我们永远不能在任何地方以原始明文形式存储密码。 我们不得将它们以纯文本格式存储在数据库，日志文件或系统的任何其他部分中。 相反，在存储密码之前，我们必须首先使用哈希函数（例如bcrypt）对其进行哈希处理。\n哈希函数是一种“单向”函数，它接受输入并将其确定性地转换为新的看似随机的字符串。 从输入中计算哈希值在计算上非常容易，但是要反转转换并从其哈希值中恢复原始输入会花费大量时间和计算能力，实际上这是不可能的。\n<code>+---------+ Easy +----------+\n| |------------&gt;| |\n|Plaintext| |Hash value|\n| |&lt;------------| |\n+---------+ Essentially +----------+ Impossible\n</code>\n由于我们仅存储用户密码的哈希值，因此，如果黑客以某种方式偷走了我们的密码数据库（禁止上天堂）（触摸木头），那么他们将只能看到密码的哈希值。 他们将无法轻松地将这些哈希值重新转换为纯文本密码，这意味着他们将无法使用它们来登录Steveslist，并且他们将无法利用所有 在不同的服务之间使用密码。\n由于我们仅存储密码哈希值，因此当我们要检查用户提供给我们的登录密码是否正确时，我们首先计算其哈希值，然后将结果与密码数据库中的哈希值进行比较。\n<code> +--------------+ |User's Browser| +-----------+--+\n1.User attempts to | ^\nlog in: | | 3. Server logs the user in | | if password matches, and username: steve | | returns an error if it does not. password: 12345 v | +--+--------+--+ | Steveslist | | Server | +--------------+ |\n2.Server computes | |username|password_hash|\nthe hash of the | +----------------------+\npassword and compares +----&gt;+steve |23jy7213y7jO |\nit to the value in the |kate |21897213hh21 |\ndatabase. |... |... |\n</code>\n如前所述，我们还必须注意不要在任何调试输出中记录密码。 这很容易犯错误-如果您记录了每个HTTP请求的所有参数，以防万一您需要它，那么您肯定会记录用户密码。 Facebook以明文形式登录密码已有很多年了，尽管它似乎并没有影响其股价，但我敢肯定，这使他们在一两天内感到很傻。\n凯特屏住呼吸。 您假装在电池没电的笔记本电脑上记笔记。\n让我们谈谈基础架构。\n数据库服务器\nSteveslist的主要数据存储运行一种常见的SQL数据库，称为MySQL。 我在这里不会过多地谈论SQL-它的工作方式的细节并不重要，如果您有兴趣，可以在Google上找到它们。 由于我们是如此成功，因此我们需要管理大量且不断增长的数据。 我们已经开始敏锐地意识到数据库不是万能的。 就像任何其他程序一样，它们在计算机上运行。 随着数据库中数据量的增长，计算机的硬盘驱动器和内存开始装满。 在公司成立之初，解决此问题的最简单方法是在具有巨大硬盘的单台计算机（或计算机）上运行数据库。 但这只能避免这么长时间的问题。 最终，我们的数据库包含的数据量超出了任何合理的硬盘驱动器所能存储的数据量，并且由于我们迫使它搜索越来越多的记录，数据库开始变得越来越慢。\n我们必须采用全新的方法，然后重新配置数据库以将其数据存储在多台计算机上。 我们使用分片进行了此操作。\n分片\n对数据库进行分片意味着将其数据分成多个块（或“分片”），并将每个块存储在单独的计算机上。 组成数据库的所有机器统称为数据库集群。 如何在群集中的计算机之间拆分数据取决于您的应用程序和将要执行的操作类型。 对于Steveslist，我们选择了按用户划分数据。 这意味着给定用户的所有数据都存储在同一台计算机上。 这包括他们的个人资料信息，他们的清单，他们的消息等等。 可以使用用户以外的分片键来分片没有相应用户的数据（例如“每日交易”），如果数据集足够小，则可以完全不分片。\n这意味着我们在数据库的前面需要一个额外的“路由”层，该层知道哪个数据库机器能够为哪些查询提供服务。 我们可以让我们的应用程序服务器（执行代码的服务器）负责了解用户ID到数据库分片的映射，也可以让所有服务器向其发送请求的集中化“路由器”，并负责制定 适当的机器将请求转发到。 两种方法都有其优势。 让应用服务器负责维护映射可以减少请求必须执行的跃点数，从而加快响应速度。 但是拥有集中式路由器会使碎片映射的更新变得容易得多，因为您只需要在一个地方进行更新即可。\n如果应用服务器负责了解分片布局，那么我们的系统如下所示：\n<code> + + + | | | | Requests from users | | | | v v v +------+----------+--------------------+ | Application | | Server | | | |Database sharding config: | |* DB Server 1: IDs between 1-10000 | |* DB Server 2: IDs between 10000-20000| |* DB Server 3: IDs between 20000-30000| +-+----------------+-----------------+-+ | | | |ID:501 |ID:15362 |ID:22361 | | | v v v\n+-----------+ +-----------+ +-----------+\n|DB Server 1| |DB Server 2| |DB Server 3|\n+-----------+ +-----------+ +-----------+\n</code>\n如果我们有一个集中式数据库路由器，那么我们的系统如下所示：\n<code> + + + | | | | Requests from users | | | | v v v +------+----------+--------------------+ | Application | | Server | | | |Database sharding config: | |* ??? Application Server has no idea | +------------+-----------+-------------+ | | Application server sends all database queries to the database router, which forwards them to the correct shard. | | v v +--------------+-----------+-------------+ | Database router | | | |Database sharding config: | |* DB Server 1: IDs between 1-10000 | |* DB Server 2: IDs between 10000-20000 | |* DB Server 3: IDs between 20000-30000 | +---+----------------+---------------+---+ | | | |ID:501 |ID:15362 |ID:22361 | | | v v v\n+-----------+ +-----------+ +-----------+\n|DB Server 1| |DB Server 2| |DB Server 3|\n+-----------+ +-----------+ +-----------+\n</code>\n我们如何确定将每个用户分配给哪个数据库？ 但是我们想要。 我们可以先说，将具有奇数ID的用户分配给分片机1，将具有偶数ID的用户分配给分片机2。我们希望这种随机分配能够使我们的分片之间的数据相对均衡 。\n但是，我们可能会拥有少量的高级用户，他们创建的数据可能比其他用户多得多。 也许它们创建了太多数据，我们想为其分配一个自己的碎片。 完全可以-我们可以完全控制如何将用户分配给分片。 随机分配通常是最简单的，但绝不是唯一的选择。 我们可以选择将用户随机分配给分片-除了分配给分片15的用户367823（没有其他用户分配给用户）。\n如果碎片太大，并开始填满机器的硬盘，我们可以将其拆分为多个较小的碎片。 我们如何将数据迁移到这些新的分片上而又不必关闭平台一段时间？ 可能使用类似的顺序过程：\n将新数据“双重写入”新旧碎片。 继续从旧分片读取数据\n将所有现有数据从旧分片复制到新分片。 继续对新旧碎片进行双重写入\n说服自己，新旧碎片包含相同的数据。 我们可以通过比较数据库快照和/或通过从两个数据库中读取每个查询，进行比较并在数据不同时发出警报来做到这一点。\n一旦我们确信新旧分片包含相同的数据，便切换到从新旧分片读取。 如果需要退回，我们会继续进行重复书写\n一旦我们确信此步骤已成功完成，请停止重复写入并删除旧的分片\n鲁珀特·赫普顿（Rupert Herpton）撰写了一篇很棒的文章，内容涉及广泛相似的迁移类型，并且更加详尽。 简而言之，在数据库分片之间迁移数据的过程既详细又挑剔，但也完全可行且合乎逻辑。 某些类型的数据库甚至可以自动为您处理分片。\n复写\n我们将非常注意确保不会意外删除我们的数据，并且我们的数据库服务器不会随机停止工作。 但是发生意外，有时计算机确实会随机停止工作。 为了减轻与数据库相关的灾难的影响，我们在多台计算机上实时（接近）复制了数据。\n<code> Client writes new data to DB Server A | v +-----+-----+ |DB Server A| ++---------++ | | DB Server A quickly replicates v v the new data to DB Servers B and C\n+----------++ +-+---------+\n|DB Server B| |DB Server C|\n+-----------+ +-----------+\n</code>\n实时复制有两个主要好处。 首先，这意味着，如果我们的一台数据库服务器爆炸，着火或以其他方式停止工作，我们将拥有多个几乎完美的副本，这些副本可以无缝地解决这一问题。 在直接的，原始的失败中，我们服务的用户可能永远不会知道任何问题。 复制的第二个好处是我们可以在多个数据库服务器之间分发对相同数据的查询。 如果很多用户要求从同一数据库中读取数据，我们可以将他们的查询分散到所有副本中，这意味着我们可以并行处理更多查询。\n<code> Clients can query the same data from any of DB Servers A,B,or C | | | | | | | | | v v v | | | | +-+---+---+-+ | | | | |DB Server A| | | | | +-----------+ | | | | | | v v v v\n+---+-------+ +-----+-+---+\n|DB Server B| |DB Server C|\n+-----------+ +-----------+\n</code>\n请注意，数据库复制与进行数据库备份的概念不同。 复制是（接近）实时发生的，旨在实时处理实时（或生产）系统中的孤立问题。 数据库备份按计划执行（例如，每天一次），并且数据副本独立存储在生产系统之外。 备份被设计为防止大规模灾难性数据丢失的最终保护措施，如果所有数据中心都被烧毁，可能会发生这种情况。\n假设您在一家大银行的呼叫中心工作，那里的人们经常打电话给您，以进行汇款并询问其当前余额。 复制等同于在收到转移详细信息时将它们详细记录到多本书中，以防万一您丢失其中一本书。 进行备份相当于每天复印一次这些书，然后将副本存储在文件柜中。\n复写\n复制的过程从概念上讲非常简单。 每当将新数据写入我们的数据库时，我们都会将其复制到多台计算机上。 这意味着，如果/当机器出现故障时，我们可以继续查询其兄弟服务器，而不会影响用户。 这也意味着我们可以将查询分布在同一数据的多个副本中，从而缩短查询响应时间。\n但是，我们如何做到这一点的细节是重要的，微妙的并且取决于情况。 没有正确的复制方法-通常情况下，您采用的确切方法取决于系统的特定要求和约束。\n关于现实世界的两个不便事实使复制变得复杂。 首先，数据库操作有时会随机失败。 当我们尝试将数据从一台服务器复制到另一台服务器时，有时会出错，导致我们的计算机至少在一段时间内不同步。 其次，即使在运行平稳的时期，复制也不是瞬时的。 当将新数据写入我们的数据库集群时，集群中的某些服务器将总是比其他服务器更早知道更新。 在选择复制策略时，我们必须意识到这些限制以及它们如何影响我们的特定应用程序。 例如，冒个帖子的“点赞”数量略微不同步且过时的风险，但不能冒险用户的银行帐户中的金额，这也许是可以的。\n选择复制策略时，我们必须做出的最大决定之一就是我们要复制是同步复制还是异步复制。\n异步与同步复制\n复制可以同步或异步进行。 这些词在系统设计中出现在很多不同的地方，但是从根本上讲它们始终是同一件事。 如果某个动作是“同步”执行的，则意味着该动作是在某人等待的同时执行的。 如果您想同步发送一封信，那么您将到达邮局，将信交给邮递员，坐在邮局的角落等几天，直到邮递员确认后才回家 您的信已经安全到达。\n相反，如果某个动作是“异步”执行的，那么这意味着该动作的发起者不会等待它完成。 相反，他们只是在后台进行操作时继续进行其余工作。 真正的邮政服务是异步的； 您将您的信给邮政工作人员，然后离开并继续生活，而邮政局则将您的信寄给您。 异步操作可以根据需要（例如，“您的信已到达并已签名”或“希顿先生，您的干洗店已准备就绪”）回传操作结果通知，但不必这样做。\n这些原则如何应用于数据库复制？ 在同步复制中，客户端将其新数据写入数据库服务器，然后等待。 该服务器在完成跨所有同级服务器完全复制客户端数据之前，不会告诉客户端其写入是否已成功完成。 然后，直到那时，客户端才继续执行其其余代码。\n与以前一样，在异步复制中，客户端将其数据写入第一台数据库服务器。 但是这一次，第一台服务器告诉客户端，只要将数据写入其自己的数据存储中，写入就成功了。 它会在后台启动复制过程，并且无需等待复制过程完成甚至开始，就可以告诉客户端写入成功。 这意味着异步操作看起来比同步操作快得多，因为客户端不必等待所有复制完成即可继续进行其余的工作。 但是，如果后台复制失败，则客户端将认为它实际上已经成功地将其数据成功写入数据库。 这可能会引起问题，读者可以将其想象力留给练习。\n同步方法比异步方法慢但“安全”。 在完成每一步之前，数据库永远不会声称已经成功接收并存储了任何数据。 因为客户端在继续之前等待完整的确认，所以可以确保永远不会遇到客户端认为已向数据库写入了一些数据，但是数据库已秘密地将数据部分丢到地板上的情况。\n哪种方法更好？ 这取决于。 您是否更在乎速度或正确性？ 如果可以显着加快系统运行速度，偶尔出现不一致的数据是否可以？ 还是会因为一个错误而导致飞机开始坠落？\n数据库复制系统也面临其他有趣的问题。 其中许多问题是“逻辑的”而不是“技术的”，不需要对系统底层的复杂软件和网络协议有详细的了解。 为了帮助您了解其中的一些情况，假设您几段前就回到了呼叫中心。 您与许多其他同事一起工作。 你们一起扮演数据库服务器的角色。 人们打电话给您转账并询问他们目前的余额。 您和您的同事将有关新转移的信息记录在纸上，并通过相互调用在彼此之间进行复制。\n我们的数据库集群面临的问题与我们的呼叫中心面临的问题相同。 如果两个人打进电话，并试图通过与两位不同的员工交谈来更新同一数据，会发生什么情况？ 也许我们可以通过拥有一名“领导”员工来解决此问题，该员工是唯一有权为尝试创建转接的人员提供服务的人员。 所有其他员工仅允许回答有关当前余额的查询。 好的，如果领导者在收到一些新数据之后却在告诉其他所有人之前中风而死，该怎么办？ 如果“跟随者”员工暂时癫痫发作几秒钟而错过领导者的一些数据更新怎么办？ 如果我们无法完全确定哪些员工已死或活着怎么办？\n这不是一个近似的隐喻，如果您看起来太刻苦或开始问一些尴尬的问题，它就不会分解。 了解这个奇怪的呼叫中心，您就会了解数据库复制。 阅读此博客文章，您将真正理解复制。\n后备\n除了实时复制外，我们还存储整个数据库的定期备份，以防止灾难性灾难。 我们将所有数据复制到数据库中，将其存储在安全的地方，并将其标记为“ database backup，2020-05-11：01：00”。\n<code>+----------+ | Database +----------------&gt; database backup, 2020-05-11:01:00\n+----------+ database backup, 2020-05-10:01:00 database backup, 2020-05-09:01:00\n</code>\n如果整个数据库（或其中的一部分）以某种方式被清除，我们将获取最新的可用备份并将其加载到新的数据库计算机中。\n<code>+----------+\n| New |\n| Database +&lt;---------------- database backup, 2020-05-11:01:00\n+----------+ database backup, 2020-05-10:01:00 database backup, 2020-05-09:01:00\n</code>\n这种灾难可能是由于网络攻击，我们数据中心的灾难，数据库迁移发生了严重错误或许多不大可能但可能破坏公司的原因引起的。 与实时复制不同，从备份还原数据库是一个缓慢的过程，我们的用户一定会注意到。 在还原完成之前，我们的整个系统可能都处于脱机状态。 我们将丢失在上一次备份之后但在灾难发生之前发生的所有数据库更新。 毫无疑问，随着用户和系统尝试访问曾经存在但现在永久丢失的数据，将产生大量连锁反应。 尽管如此，这些损失远不及我们公司所有数据以及公司的全部，不可挽回的损失可怕。\n关于我们的主要SQL数据库，有很多细节。 让我们讨论一下存储和查询数据的其他方式。\n自由文本搜索\n标准的SQL数据库非常擅长回答定义明确的特定查询。 例如：\n给我所有用户＃145122在过去90天内创建的所有物品清单\n请给我列出该物品的清单详细信息＃237326921\n请给我每天在旧金山创建的带有“电子”标签的新列表的数量\n您可以使用如下所示的SQL查询来检索此类数据：\n<code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">user_id</span> <span class=\"o\">=</span> <span class=\"mi\">145122</span> <span class=\"k\">AND</span> <span class=\"n\">created</span> <span class=\"o\">&gt;</span> <span class=\"n\">currentDate</span><span class=\"p\">()</span> <span class=\"o\">-</span> <span class=\"mi\">90</span>\n</code>\n要么\n<code><span class=\"k\">SELECT</span> <span class=\"n\">DATE_TRUNC</span><span class=\"p\">(</span><span class=\"s1\">'day'</span><span class=\"p\">,</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">created</span><span class=\"p\">)</span> <span class=\"k\">AS</span> <span class=\"k\">day</span><span class=\"p\">,</span> <span class=\"k\">COUNT</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"p\">)</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span> <span class=\"k\">AS</span> <span class=\"n\">i</span>\n<span class=\"k\">INNER</span> <span class=\"k\">JOIN</span> <span class=\"n\">labels</span> <span class=\"k\">as</span> <span class=\"n\">l</span> <span class=\"k\">ON</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">id</span> <span class=\"o\">=</span> <span class=\"n\">l</span><span class=\"p\">.</span><span class=\"n\">item_id</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">i</span><span class=\"p\">.</span><span class=\"n\">city</span> <span class=\"o\">=</span> <span class=\"s1\">'San Francisco'</span> <span class=\"k\">AND</span> <span class=\"n\">l</span><span class=\"p\">.</span><span class=\"nb\">text</span> <span class=\"o\">=</span> <span class=\"s1\">'electronics'</span>\n<span class=\"k\">GROUP</span> <span class=\"k\">BY</span> <span class=\"mi\">1</span>\n<span class=\"k\">ORDER</span> <span class=\"k\">BY</span> <span class=\"mi\">1</span> <span class=\"k\">DESC</span>\n</code>\n您会注意到，这些查询包含许多非常“精确”的运算符，例如等号和大于号。 但是，您将如何编写一个SQL查询以返回与Google样式的“全文”搜索（例如“二手电视”）匹配的项目列表？\n这将是困难的。 您可以尝试使用SQL LIKE运算符，该运算符允许您查找包含模式（例如子字符串）的记录。 例如，以下查询查找所有描述，其中包含子字符串二手电视的所有项目：\n<code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second-hand TV%'</span>\n</code>\n但是，此查询将仅匹配给定的非常具体的子字符串。 它与“二手电视”或“二手电视”或“二手电视”不匹配。 只要有足够的毅力，理论上您就可以构造一个庞大的SQL查询，该查询可以满足您对以下所有排列的需求：\n<code><span class=\"k\">SELECT</span> <span class=\"o\">*</span>\n<span class=\"k\">FROM</span> <span class=\"n\">items</span>\n<span class=\"k\">WHERE</span> <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second%hand%TV'</span> <span class=\"k\">OR</span> <span class=\"n\">description</span> <span class=\"k\">LIKE</span> <span class=\"s1\">'%second%TV%hand'</span> <span class=\"k\">OR</span> <span class=\"c1\">-- …and so on and so on for another bajillion ORs…</span>\n</code>\n但是，结果查询会很慢且麻烦，并且仍然会遗漏许多您未曾想到的重要情况。 即使您确实获得了有用的搜索结果列表，仍然需要做很多工作来决定如何订购它们。 您想要的顺序并不严格，例如“最新的优先”或“按字母顺序排列的标题”。 取而代之的是“最好”或“最相关”的概念。\n所有这些都意味着SQL数据库通常不太擅长全文搜索。 幸运的是，还有其他类型的数据库，包括一种名为Elasticsearch的数据库。 Elasticsearch通常被描述为面向文档的数据库。 我们不需要详细介绍其工作原理，但是对我们而言重要的是，与SQL数据库不同，Elasticsearch非常擅长接收“二手电视”之类的查询并返回由 用户已经从搜索引擎中获得的模糊匹配的“相关性”。\n您可能会说：“ Elasticsearch之类的声音比SQL还要好。” “我们应该扔掉我们的SQL数据库，而是将所有内容放到Elasticsearch中吗？” 没那么快。 Elasticsearch和其他类似的数据库都有其优势，但也有其劣势。 它们通常不如SQL数据库可靠，并且更有可能意外丢失大规模数据。 它们写入新数据的速度通常也慢得多。\n正如我们已经指出的，针对任何类型的工作，很少有一个通用的“最佳”工具。 当然，没有“最好的”数据库。 相反，不同的数据库具有不同的优点和缺点，并且不同的解决方案适用于不同的任务。 在Steveslist，我们非常关心确保使用正确的工具完成正确的工作，以将数据存储在SQL数据库和面向文档的数据库（例如Elasticsearch）中。\n我们使用SQL数据库作为主要数据存储。 这是我们权威的“事实来源”，我们将所有新数据写入其中，然后再将其写入其他任何地方。 我们会从中读取所有简单，精确的内容，尤其是当准确性和最新性是我们的主要要求时。 如果要向用户显示所有未完成清单的列表，请从SQL数据库中读取它。 如果我们想验证用户密码，我们也会从SQL数据库中读取该密码。 这发挥了SQL数据库的优势。\n但是，在后台，我们还将数据从SQL数据库复制到Elasticsearch数据库，并将通过搜索框进行的所有全文搜索查询发送到Elasticsearch。 这意味着我们将从Elasticsearch的优势中受益，而不受其劣势的太大影响。 我们每隔几分钟，几小时或几天就复制一批记录，具体取决于特定数据集的要求。 或者，我们可以查看SQL数据库的日志中是否有新记录或更新记录，并以近实时方式创建或更新相应的Elasticsearch记录。\n<code> | | |\nNew data is always | |Queries for |Full-text search written to the SQL | |specific data go |queries go to\nDB first | |to the SQL DB too |Elasticsearch V V V +--------------+ +---------------+ | SQL Database +------&gt;+ Elasticsearch | +--------------+ +---------------+ New data is copied over from the SQL DB to Elasticsearch\n</code>\n在搜寻Steveslist的竞争对手时，我注意到当您创建新的Craigslist列表时，它会显示“您的列表将在接下来的15分钟内显示在搜索结果中”。 我会打赌比索，因为这是因为他们的主要数据存储区是一个SQL数据库，但是他们的搜索框由类似Elasticsearch的引擎提供动力。 他们用于从SQL复制数据以进行搜索的管道可能需要大约15分钟的时间，他们认为（非常合理）对于他们的特定用例来说，这是可以接受的延迟。\n我们已经说过，Elasticsearch的可靠性要比大多数SQL数据库差一些。 如果Elasticsearch意外丢失了我们的一些记录，那么它们将不会出现在搜索结果中。 这将使我们的产品变得更糟，这是一种耻辱，我们将尽最大努力避免这种情况的发生。 但是，这不会像从我们的主数据存储中丢失数据那样造成灾难。 我们仅将数据复制到Elasticsearch中之后，再将其复制到Elasticsearch SQL数据库中并由其安全捕获，这才是真正重要的。\n现在是下午6点，图书馆即将关闭。 图书管理员试图让您离开。 凯特用一大堆弄皱的纸球把他赶走了。\n内部工具\n管理Steveslist平台需要定制的内部工具。 我们需要执行广泛的管理任务，例如删除过于违法的列表（甚至对我们而言），发行退款，查看用户的个人详细信息以帮助支持请求等等。 Steveslist的其他团队的工作人员将使用其中许多工具，例如财务，合规性，法律，销售和支持。 由于他们需要执行的任务非常适合Steveslist的工作方式，因此我们无法使用第三方工具来完成这些任务，而必须自己构建。\n在早期，我们将此功能烘焙到主要的Stevelist产品中，并且仅向设置了is_steveslist_employee = True数据库标记的用户公开。 对于小公司来说，这是不错的方法，但它也很脆弱，很容易搞砸。 令人恐惧的是，我们通过运行主产品的同一台服务器来公开我们所有的超级用户能力。 这使我们应用程序中的安全漏洞的潜在后果更加严重，并给我们造成了新的错误类型，例如忘记为一个被开除工作的雇员禁用is_steveslist_employee标志。\n一旦Steveslist达到一定的成熟度，我们便为自己构建了一个完全独立的管理平台，并具有独立的强化身份验证和授权。 该服务在完全独立的服务器上运行，并且需要VPN和TLS客户端证书才能访问（我们将在另一天讨论）。 这将我们面向内部和面向外部的产品分开了，并大大减少了使我们的管理工具暴露给世人的严重错误的机会。 我们经常在构建新的内部工具-一种用于用户管理，一种用于服务器管理，一种用于欺诈检测等。 这些服务都与面向用户的产品使用同一数据库通信，因此它们都可以访问相同的数据。 它们只是在完全无法被外界访问的不同服务器上运行。\nCron职位\n我们希望系统在固定的时间和间隔执行很多任务。 例如：\n通过电子邮件发送每周使用情况报告\n向用户发送营销电子邮件\n向与我们有订阅计划的信用卡用户收费\n将数据从我们的SQL数据库复制到Elasticsearch\n用于运行计划作业的最常用工具称为cron，该工具内置于Unix操作系统中。 这种情况如此普遍，以至于人们经常将任何类型的计划工作称为“计划工作”，即使实际上并非由计划工作来执行。\n您可以通过运行以下命令在自己的计算机上设置cron作业：\n<code>crontab -e\n</code>\n然后输入提示：\n<code>*/5 * * * * $YOUR_COMMAND\n</code>\n这将使您的计算机每5分钟执行一次$ YOUR_COMMAND。\nSteveslist当前具有非常简单且稍微脆弱的cron设置。 我们只有一个“预定的作业服务器”。 我们在该服务器上（如上）使用crontab来告诉它要运行的命令以及要对其运行的时间表。 此设置的扩展性不是很好-如果排定的作业服务器爆炸甚至打h，那么我们并不总是知道它执行了哪些作业或没有执行哪些作业，因此不得不争先恐后地启动替换服务器。 即使服务器非常强大，但最终我们还是希望运行更多的工作，而不是一次性处理。 我们正在考虑将cron作业拆分为多个服务器，或者使用Kubernetes等现代工具来建立新系统。\nPubsub\n行动有后果。 这既是我们发送给在互联网上写关于我们卑鄙的人的邪恶电子邮件的主题，也是我们拥有pubsub系统的原因。\n当新用户注册时，我们希望向他们发送一封电子邮件，欢迎他们进入Steveslist，并提醒他们有关我刚才描述的动作与结果的关系。 当为旧金山的失窃电视添加新清单时，我们要通知已为湾区中的电视设置搜索警报的用户。 如果拒绝订阅卡，我们想通过电子邮件向负责的用户发送电子邮件，以礼貌地威胁他们。 添加新列表后，我们要执行一些非常粗略的反欺诈检查。 购买商品后，我们希望向其卖家发送网络挂钩。 等等。\n从技术上讲，所有这些动作都可以由服务器执行启动动作来同步执行（还记得那个词吗？）。 但是，由于两个原因，这通常是一个坏主意。 首先，响应操作（例如，向所有订阅了有关新的被盗电视的通知的用户发送电子邮件）可能非常缓慢。 同步执行响应动作意味着，如果发起动作是由用户执行的，那么他们将不得不等待所有响应动作也完成。 如果响应动作小而又快，例如发送一封电子邮件，这可能不是世界末日。 但是，如果范围更大（例如搜索并通知所有可能对新商品感兴趣的用户），那么，它仍然不会是世界末日，但会带来糟糕的用户体验。\n为了减轻这个问题，我们建立了一个“发布-订阅”或“ pubsub”系统。 执行触发操作时，执行该操作的代码“发布事件”来描述该操作，例如NewListingCreated或SubscriptionCardDeclined。 在这种情况下，“事件”和“发布”这两个词的定义很松散，并且没有严格的技术定义。 事件只是某种事件发生的某种记录，发布事件只是意味着您以某种方式记下了某件事的发生。 具体操作方式完全取决于所讨论的pubsub系统。 在简单的系统中，事件可能存储在SQL数据库的表中，并且代码将通过向表中写入新记录来发布事件。\n如果Steveslist的程序员希望每当发布特定类型的新事件时都执行响应操作，则可以编写使用者。 这是一段代码“订阅”到某种事件的代码，并且在发布该类型的新事件时都会执行该代码。 它使用事件的详细信息（例如，订阅付款失败的用户）异步执行程序员希望执行的任何操作（例如，向用户发送威胁性电子邮件）。\nPubsub系统通常由中央消息代理管理。 系统将事件发布给代理，然后代理负责将事件发送给任何订阅的使用者。 这可以使用推或拉机构来实现。 消费者可以通过轮询并反复询问“是否有新事件来从经纪人那里获取消息”。 有新事件吗？” 或者他们可以等待并收听，并且代理可以将新事件的通知发送给他们，例如通过向其发送HTTP请求。\n<code>1. New user signs|\nup to Steveslist | v +-----------------+ +------------------------+ |Steveslist Server| +--&gt;+SendWelcomeEmailConsumer| +---------+-------+ | +------------------------+ | v\n2. Server reports| +-------------++ 4. Consumers send welcome\na NewUserSignup +----&gt;+Pub/Sub Broker| emails, check for spam,\nevent to the +-------------++ etc.\nPub/Sub system ^ 3. Pub/Sub broker | +------------------------+ notifies consumers +--&gt;+NewUserSpamCheckConsumer| that have subscribed to +------------------------+ NewUserSignup events.\n</code>\nPubsub系统具有许多优点：\n非关键操作是异步执行的，从而使用户体验保持活泼\n我们的代码保持整洁并分开。 发布事件的代码不必关心事件的订阅者会如何响应\n如果订阅者的操作由于某种原因而失败（例如，电子邮件发送系统出现打cup），则pubsub系统可以记录该失败，然后稍后重试\n接下来，让我们谈谈大数据。\n大数据与分析\n为了理解和优化我们的业务，我们需要能够在整个Steveslist平台上计算复杂的统计信息。 每天创建多少个列表，按国家和城市划分？ 每个月注册的用户中有90个在注册后90天内创建了一个列表？\n为此，我们需要编写汇总整个数据的数据库查询。 我们不希望对生产SQL数据库运行这些查询，因为它们可能会给数据库带来巨大的负担。 我们不希望内部分析师发出庞大的查询来使我们的生产数据库陷入停顿，但我们确实希望为这位分析师提供一种非常适合他们需求的工具。 更复杂的是，处理小型查询的数据库引擎（例如返回属于单个用户的所有列表）通常在回答大型查询（例如计算在每个类别的列表上花费的总费用）时会令人无法接受地缓慢（或实际上无能） ，过去90天内）。\n尽管如此，在Steveslist成立后的第一年左右，我们还是冒险了，只是对主要生产数据库运行了分析查询。 这是一场赌博，但这几乎奏效了。 无论如何，我们没有太多的数据，我们还有很多重要的事情要关注，例如吸引那些会创建大数据的客户，这有一天意味着我们必须找到一种更具可扩展性的解决方案。\n最终，我们确实通过一个过于雄心勃勃的查询关闭了生产数据库，并决定该花时间投资数据仓库了。 数据仓库是非常适合大型系统范围查询的数据存储。 我们的仓库由称为Hive的数据库引擎提供动力，但我们也可以选择Presto，Impala，Redshift或任何其他竞争性替代品。 Hive接受用SQL编写的查询，但是与我们的MySQL数据库相比，它对巨型数据集执行这些查询要好得多。\n我们每天一次，隔夜将数据从生产SQL数据库复制到Hive。 Steveslist分析人员和程序员可以使用最适合他们需求的数据库引擎来查询同一数据集。 他们可以将生产SQL数据库用于来自生产系统的小型，精确，真实的查询。 Elasticsearch用于全文搜索查询； 或用于大型查询的数据仓库，这些查询聚集在大量数据上。\n外面很黑，你饿了。 那差不多吗？ 你问。\n凯特回答：“哦，天哪，我们可以永远继续前进。 但这是一个很好的开始。 对广泛的主题有广泛的了解是有帮助的，但是没有人需要了解所有细节。 我发现，一旦您了解了一些基础知识，就可以继续学习更多基础知识，甚至还有一些细节。”\n您问凯特（Kate）明天是否可能继续阐述她对Steveslist的五年愿景。\n“绝对。”凯特说。 我们将讨论在一个真正的大型在线平台内发生的更多事情，包括：”\n安全\nHTTPS和其他形式的加密\n两因素验证\nSAML\n密钥管理\n服务器管理\n部署新代码\nAWS和竞争对手\n地貌\n负载均衡器\n货柜\n在代码中断时发出警报\n大数据\n地图缩减和其他大数据作业\n机器学习\n用户跟踪\n“明天早上7点见？”\n在Twitter或RSS上关注我\n获取发送给您的新文章\n订阅我有关编程，安全性和其他一些主题的新工作。 一个月发表几次。\n新：还订阅我的新系列，《面向高级初学者的编程反馈》\n有关面向高级初学者的编程项目的更多信息\nPFAB＃13：当代码太聪明以至于无法清理时\nPFAB＃11：分离逻辑和数据\nPFAB＃10：一流的功能和依赖注入\nPFAB＃9：批处理与流处理\nPFAB＃8：输入验证-便利与惊喜之间的权衡\nPFAB＃7：如何编写库\nPFAB＃6：实际调试实践\nPFAB＃5：如何使程序更短\nPFAB＃4：异常处理和应对失败\nPFAB＃3：如何严格分析您的工作旅程\nPFAB＃2：如何构建程序\nPFAB＃1：定义边界\n面向高级初学者的编程反馈＃0\n我会就您的代码给您反馈\n面向高级初学者的编程项目＃6：用户登录\n面向高级初学者的真实编程项目\n高级初学者＃1的编程视频：战舰\n面向高级初学者的开源软件＃1：bashplotlib\n面向高级初学者的开源\n初学者的想法真的像\n面向高级初学者的编程项目\n面向高级初学者的编程项目＃5：Snake\n面向高级初学者的编程项目＃4：Photomosaics\n面向高级初学者＃3b的编程项目：井字游戏AI\n面向高级初学者＃3a的编程项目：井字游戏AI\n高级初学者＃2的编程项目：生活游戏\n高级初学者＃1的编程项目：ASCII艺术\n如何通过使iPhone变差使自己更快乐\n数百家公司对通过其服务发送的所有创意主张使用权▶\n主页/存档/ RSS / Twitter /办公时间/ Tipoffs / SoundCloud /\n"}

{"l":"https://tomassetti.me/parsing-sql/","n":"Parsing sql","html":"<div id=\"wrap_all\"><header id=\"header\" class=\"all_colors header_color light_bg_color av_header_top av_logo_left av_main_nav_header av_menu_right av_slim av_header_sticky av_header_shrinking_disabled av_header_stretch_disabled av_mobile_menu_tablet av_header_searchicon av_header_unstick_top av_minimal_header av_bottom_nav_disabled av_header_border_disabled\" role=\"banner\" itemscope=\"itemscope\" itemtype=\"https://schema.org/WPHeader\" style=\"margin-top: 0px;\"><div id=\"header_meta\" class=\"container_wrap container_wrap_meta av_icon_active_left av_extra_header_active av_secondary_right av_entry_id_6033\"><div class=\"container\"><ul class=\"noLightbox social_bookmarks icon_count_4\"><li class=\"social_bookmarks_twitter av-social-link-twitter social_icon_1\"><a target=\"_blank\" aria-label=\"Link to Twitter\" href=\"https://twitter.com/ftomasse\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\" title=\"Twitter\"><span class=\"avia_hidden_link_text\">Twitter</span></a></li><li class=\"social_bookmarks_linkedin av-social-link-linkedin social_icon_2\"><a target=\"_blank\" aria-label=\"Link to Linkedin\" href=\"https://ie.linkedin.com/in/federicotomassetti\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\" title=\"Linkedin\"><span class=\"avia_hidden_link_text\">Linkedin</span></a></li><li class=\"social_bookmarks_mail av-social-link-mail social_icon_3\"><a aria-label=\"Link to Mail\" href=\"mailto:federico@tomassetti.me\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\" title=\"Mail\"><span class=\"avia_hidden_link_text\">Mail</span></a></li><li class=\"social_bookmarks_rss av-social-link-rss social_icon_4\"><a aria-label=\"Link to Rss this site\" href=\"https://tomassetti.me/feed/\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\" title=\"Rss\"><span class=\"avia_hidden_link_text\">Rss</span></a></li></ul></div></div><div id=\"header_main\" class=\"container_wrap container_wrap_logo\"><div class=\"container av-logo-container\" style=\"\"><div class=\"inner-container\"><span class=\"logo\"><a href=\"https://tomassetti.me/\"><img height=\"100\" width=\"300\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/07/federico-tomassetti-software-architect-300.png\" alt=\"Federico Tomassetti - Software Architect\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/07/federico-tomassetti-software-architect-300.png\" class=\"lazyloaded\" data-was-processed=\"true\"><noscript><img height='100' width='300' src='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/07/federico-tomassetti-software-architect-300.png' alt='Federico Tomassetti - Software Architect' /></noscript></a></span><nav class=\"main_menu\" data-selectname=\"Select a page\" role=\"navigation\" itemscope=\"itemscope\" itemtype=\"https://schema.org/SiteNavigationElement\"><div class=\"avia-menu av-main-nav-wrap\"><ul id=\"avia-menu\" class=\"menu av-main-nav\"><li id=\"menu-item-4159\" class=\"menu-item menu-item-type-custom menu-item-object-custom menu-item-top-level menu-item-top-level-1\"><a href=\"https://strumenta.com/services/\" itemprop=\"url\" style=\"\"><span class=\"avia-bullet\"></span><span class=\"avia-menu-text\">Services</span><span class=\"avia-menu-fx\"><span class=\"avia-arrow-wrap\"><span class=\"avia-arrow\"></span></span></span></a></li><li id=\"menu-item-4164\" class=\"menu-item menu-item-type-custom menu-item-object-custom menu-item-top-level menu-item-top-level-2\"><a href=\"https://strumenta.com/products\" itemprop=\"url\" style=\"\"><span class=\"avia-bullet\"></span><span class=\"avia-menu-text\">Products</span><span class=\"avia-menu-fx\"><span class=\"avia-arrow-wrap\"><span class=\"avia-arrow\"></span></span></span></a></li><li id=\"menu-item-3277\" class=\"menu-item menu-item-type-post_type menu-item-object-page menu-item-top-level menu-item-top-level-3\"><a href=\"https://tomassetti.me/learning-build-languages/\" itemprop=\"url\" style=\"\"><span class=\"avia-bullet\"></span><span class=\"avia-menu-text\">Learning to build languages</span><span class=\"avia-menu-fx\"><span class=\"avia-arrow-wrap\"><span class=\"avia-arrow\"></span></span></span></a></li><li id=\"menu-item-3276\" class=\"menu-item menu-item-type-post_type menu-item-object-page menu-item-top-level menu-item-top-level-4\"><a href=\"https://tomassetti.me/learning-process-code/\" itemprop=\"url\" style=\"\"><span class=\"avia-bullet\"></span><span class=\"avia-menu-text\">Learning to process code</span><span class=\"avia-menu-fx\"><span class=\"avia-arrow-wrap\"><span class=\"avia-arrow\"></span></span></span></a></li><li id=\"menu-item-3996\" class=\"menu-item menu-item-type-post_type menu-item-object-page menu-item-top-level menu-item-top-level-5\"><a href=\"https://tomassetti.me/antlr-course/\" itemprop=\"url\" style=\"\"><span class=\"avia-bullet\"></span><span class=\"avia-menu-text\">Using ANTLR Like a Professional</span><span class=\"avia-menu-fx\"><span class=\"avia-arrow-wrap\"><span class=\"avia-arrow\"></span></span></span></a></li><li id=\"menu-item-3278\" class=\"menu-item menu-item-type-post_type menu-item-object-page menu-item-top-level menu-item-top-level-6\"><a href=\"https://tomassetti.me/newsletter/\" itemprop=\"url\" style=\"\"><span class=\"avia-bullet\"></span><span class=\"avia-menu-text\">Newsletter</span><span class=\"avia-menu-fx\"><span class=\"avia-arrow-wrap\"><span class=\"avia-arrow\"></span></span></span></a></li><li id=\"menu-item-2572\" class=\"menu-item menu-item-type-post_type menu-item-object-page menu-item-top-level menu-item-top-level-7\"><a href=\"https://tomassetti.me/about-me/\" itemprop=\"url\" style=\"\"><span class=\"avia-bullet\"></span><span class=\"avia-menu-text\">About me</span><span class=\"avia-menu-fx\"><span class=\"avia-arrow-wrap\"><span class=\"avia-arrow\"></span></span></span></a></li><li id=\"menu-item-5959\" class=\"menu-item menu-item-type-custom menu-item-object-custom menu-item-top-level menu-item-top-level-8\"><a href=\"https://strumenta.com/contact-us/\" itemprop=\"url\" style=\"\"><span class=\"avia-bullet\"></span><span class=\"avia-menu-text\">Let’s Talk</span><span class=\"avia-menu-fx\"><span class=\"avia-arrow-wrap\"><span class=\"avia-arrow\"></span></span></span></a></li><li id=\"menu-item-search\" class=\"noMobile menu-item menu-item-search-dropdown menu-item-avia-special\"> <a href=\"?s=\" rel=\"nofollow\" data-avia-search-tooltip=\" <form action=&quot;https://tomassetti.me/&quot; id=&quot;searchform&quot; method=&quot;get&quot; class=&quot;&quot;> <div> <input type=&quot;submit&quot; value=&quot;&quot; id=&quot;searchsubmit&quot; class=&quot;button avia-font-entypo-fontello&quot; /> <input type=&quot;text&quot; id=&quot;s&quot; name=&quot;s&quot; value=&quot;&quot; placeholder='Search' /> </div> </form>\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\" style=\"\"><span class=\"avia_hidden_link_text\">Search</span></a></li><li class=\"av-burger-menu-main menu-item-avia-special \"> <a href=\"#\" style=\"\"> <span class=\"av-hamburger av-hamburger--spin av-js-hamburger\"> <span class=\"av-hamburger-box\"> <span class=\"av-hamburger-inner\"></span> <strong>Menu</strong> </span> </span> </a></li></ul></div></nav></div></div></div><div class=\"header_bg\"></div></header><div id=\"main\" class=\"all_colors\" data-scroll-offset=\"88\"><div class=\"stretch_full container_wrap alternate_color light_bg_color title_container\"><div class=\"container\"><strong class=\"main-title entry-title \"><a href=\"https://tomassetti.me/blog/\" rel=\"bookmark\" title=\"Permanent Link: Blog\" itemprop=\"headline\">Blog</a></strong></div></div><div class=\"container_wrap container_wrap_first main_color sidebar_right\"><div class=\"container template-blog template-single-blog \"><main class=\"content units av-content-small alpha av-blog-meta-comments-disabled\" role=\"main\" itemscope=\"itemscope\" itemtype=\"https://schema.org/Blog\"><article class=\"post-entry post-entry-type-standard post-entry-6033 post-loop-1 post-parity-odd post-entry-last single-small with-slider post-6033 post type-post status-publish format-standard has-post-thumbnail hentry category-antlr category-static-analysis category-parsing tag-c tag-kotlin tag-sql tag-tools\" itemscope=\"itemscope\" itemtype=\"https://schema.org/BlogPosting\" itemprop=\"blogPost\"><div class=\"entry-content-wrapper clearfix standard-content\"><header class=\"entry-content-header\"><h1 class=\"post-title entry-title \" itemprop=\"headline\"> <a href=\"https://tomassetti.me/parsing-sql/\" rel=\"bookmark\" title=\"Permanent Link: Parsing SQL\">Parsing SQL <span class=\"post-format-icon minor-meta\"></span> </a></h1><span class=\"post-meta-infos\"><time class=\"date-container minor-meta updated\">April 15, 2020</time><span class=\"text-sep text-sep-date\">/</span><span class=\"blog-categories minor-meta\">in <a href=\"https://tomassetti.me/category/language-engineering/antlr/\" rel=\"tag\">ANTLR</a>, <a href=\"https://tomassetti.me/category/static-analysis/\" rel=\"tag\">Code processing</a>, <a href=\"https://tomassetti.me/category/language-engineering/parsing/\" rel=\"tag\">Parsing</a> </span><span class=\"text-sep text-sep-cat\">/</span><span class=\"blog-author minor-meta\">by <span class=\"entry-author-link\"><span class=\"vcard author\"><span class=\"fn\"><a href=\"https://tomassetti.me/author/gtomassetti/\" title=\"Posts by Gabriele Tomassetti\" rel=\"author\">Gabriele Tomassetti</a></span></span></span></span></span></header><div class=\"entry-content\" itemprop=\"text\"><div class=\"ttr_start\"></div><p><em><img class=\"aligncenter size-full wp-image-6066 lazyloaded\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL.jpg\" alt=\"\" width=\"1024\" height=\"512\" data-lazy-srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL.jpg 1024w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL-300x150.jpg 300w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL-768x384.jpg 768w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL-705x353.jpg 705w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL-450x225.jpg 450w\" data-lazy-sizes=\"(max-width: 1024px) 100vw, 1024px\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL.jpg\" sizes=\"(max-width: 1024px) 100vw, 1024px\" srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL.jpg 1024w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL-300x150.jpg 300w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL-768x384.jpg 768w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL-705x353.jpg 705w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL-450x225.jpg 450w\" data-was-processed=\"true\"><noscript><img class=\"aligncenter size-full wp-image-6066\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL.jpg\" alt=\"\" width=\"1024\" height=\"512\" srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL.jpg 1024w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL-300x150.jpg 300w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL-768x384.jpg 768w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL-705x353.jpg 705w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Parsing-SQL-450x225.jpg 450w\" sizes=\"(max-width: 1024px) 100vw, 1024px\" /></noscript>You can find the code presented in this article in the <a href=\"https://github.com/unosviluppatore/parsing-sql\">companion repository</a></em></p><p>SQL is a language to handle data in a relational database. If you worked with data you have probably worked with SQL.</p><p>It is in the same league of HTML: maybe you never learned it formally but you kinda know how to use it. That is great because <strong>if you know SQL, you know how to handle data</strong>. However, it has limitations and when you hit them your only course of action might be to work with a traditional programming language. This does not necessarily mean migrating away from SQL. You might need to move from one SQL dialect to another one or to analyze the SQL code you use. And to do that, you need to parse SQL, and that is what this article is about.</p><p>What are the limits of SQL? After a while you learn of a couple of issues:</p><ul><li><strong>there is not one SQL</strong>, but many variations of it. The SQLs implemented in SQLite, MySQL, PostgreSQL, etc. are all a bit different</li><li><strong>you cannot do everything related to data in SQL</strong>. In some cases, you need a traditional programming language to work with the data</li></ul><p>These issues became real problems when you need to make big changes. For instance, if you need to change the database used by a large application. It can also be a problem when you need to make transformations that SQL and your database cannot handle them. In that case, you have some transformations done in SQL (and run on the database) and some other in your source code. So you spend a lot of time working on glue code and around the limitations of SQL.</p><p>SQL can also be a constraint, simply for what it lacks: unit testing integrated with your source code and all the other tools that you can use with Java, C#, etc. SQL is an old language and not designed for large scale programming, it is not a language that developers will love. Even worse, they will not be very productive with it. And what happens if your application requires you to verify that something gets executed in a certain way, or to offer some guarantees? It can be a business need or a regulatory requirement. Then you need to parse SQL or to find a way to move from SQL world to your programming language world.</p><p>That is what this article is about: parsing SQL. We are going to see <strong>ready-to-use libraries and tools to parse SQL</strong>, and an example project in which <strong>we will build our own SQL parser</strong>.</p><div class=\"wp-block-group\"><div class=\"wp-block-group__inner-container\"><h2>What is SQL</h2><p><strong>SQL (Structured Query Language) is a domain-specific language designed to handle data in relational database</strong>. It is a declarative language, so you describe what you want to achieve (e.g., <em>get me a row of data with id=5</em>) and not how to achieve it (e.g. <em>loop through the rows until id=5</em>). It has a formal mathematical foundation in relational algebra and calculus. The language is an ISO/IEC standard that is periodically updated, the latest version is <a href=\"https://en.wikipedia.org/wiki/SQL:2016\">SQL2016</a>. This means that there is a very formal and clear description of the language if you need it.</p><p>SQL is designed to handle many aspects of the life cycle of working with data: yes, you can query data, but you can also create the format of data (i.e., the schema of a table) and regulate access control to the data.</p><h3>SQL Procedural Extensions</h3><p>Actual SQL implementation comes with procedural extensions that implement some form of procedural programming. These are even more varied from database engine to database engine. They were added to perform complex elaborations on the data directly on the database, so they can be as powerful as traditional programming languages. And this can also be an additional headache if you try to parse SQL. See, for instance, this is a PL/SQL (the procedural SQL from Oracle databases) example from Wikipedia.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"sql\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">DECLARE\n    var NUMBER;\nBEGIN\n     /*N.B. for loop variables in pl/sql are new declarations, with scope only inside the loop */\n     FOR var IN 0 .. 10 LOOP\n          DBMS_OUTPUT.PUT_LINE(var);\n     END LOOP;\n\n     IF (var IS NULL) THEN\n          DBMS_OUTPUT.PUT_LINE('var is null');\n     ELSE\n          DBMS_OUTPUT.PUT_LINE('var is not null');\n     END IF;\nEND;</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"kw1\">DECLARE</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">    var NUMBER;</span></li><li class=\" odd\"><span class=\"\"></span><span class=\"kw1\">BEGIN</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">     </span><span class=\"co2\">/*N.B. for loop variables in pl/sql are new declarations, with scope only inside the loop */</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">     </span><span class=\"kw1\">FOR</span><span class=\"\"> var </span><span class=\"kw3\">IN</span><span class=\"\"> </span><span class=\"nu0\">0</span><span class=\"\"> .. </span><span class=\"nu0\">10</span><span class=\"\"> LOOP</span></li><li class=\" even\"><span class=\"\">          DBMS_OUTPUT.PUT_LINE(var);</span></li><li class=\" odd\"><span class=\"\">     </span><span class=\"kw1\">END</span><span class=\"\"> LOOP;</span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">     </span><span class=\"kw3\">IF</span><span class=\"\"> (var </span><span class=\"kw1\">IS</span><span class=\"\"> </span><span class=\"kw3\">NULL</span><span class=\"\">) </span><span class=\"kw1\">THEN</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">          DBMS_OUTPUT.PUT_LINE(</span><span class=\"st0\">'var is null'</span><span class=\"\">);</span></li><li class=\" odd\"><span class=\"\">     </span><span class=\"kw1\">ELSE</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">          DBMS_OUTPUT.PUT_LINE(</span><span class=\"st0\">'var is not null'</span><span class=\"\">);</span></li><li class=\" odd\"><span class=\"\">     </span><span class=\"kw1\">END</span><span class=\"\"> </span><span class=\"kw3\">IF</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\"></span><span class=\"kw1\">END</span><span class=\"\">;</span></li></ol><pre style=\"display: none;\">DECLARE\n    var NUMBER;\nBEGIN\n     /*N.B. for loop variables in pl/sql are new declarations, with scope only inside the loop */\n     FOR var IN 0 .. 10 LOOP\n          DBMS_OUTPUT.PUT_LINE(var);\n     END LOOP;\n\n     IF (var IS NULL) THEN\n          DBMS_OUTPUT.PUT_LINE('var is null');\n     ELSE\n          DBMS_OUTPUT.PUT_LINE('var is not null');\n     END IF;\nEND;</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div></div></div><div class=\"wp-block-group\"><div class=\"wp-block-group__inner-container\"><h2>Resources</h2><p>As we have seen handling SQL can be a daunting task, so let’s see a few resources to help you. They range from grammars to kick start your parsing efforts, to ready-to-use tools.</p><h3>Knowledge</h3><h4>Official Sources</h4><p>The latest official SQL standard is formally known as ISO/IEC 9075 SQL:2016. You can find every information you need about it in the official sources either the <a href=\"https://www.iso.org/standard/63555.html\">ISO</a> or <a href=\"https://webstore.iec.ch/publication/59678\">IEC</a> websites. However, keep in mind that there are several documents describing the standard and you have to pay for each of them. This means, depending on the exchange rate, the total cost could be more than 2,000 USD.</p><h4>Official References from Database Documentation</h4><p>Other than the official SQL standard, you can look up the official documentation of the database producers, which contains a reference for their SQL implementation. Here is a list of the few major ones:</p><ul><li><a href=\"https://www.oracle.com/database/technologies/appdev/plsql.html\">Oracle PL/SQL Documentation</a></li><li><a href=\"https://dev.mysql.com/doc/refman/8.0/en/sql-statements.html\">MySQL 8 SQL Reference</a></li><li><a href=\"https://docs.microsoft.com/it-it/sql/t-sql/language-reference?view=sql-server-ver15\">Microsoft Transact-SQL Reference</a></li><li><a href=\"https://www.postgresql.org/docs/12/sql.html\">PostgreSQL 12 SQL Language</a></li><li><a href=\"https://www.ibm.com/support/knowledgecenter/SSEPGG_11.5.0/com.ibm.db2.luw.sql.ref.doc/doc/c0004100.html\">IBM DB2 SQL</a></li><li><a href=\"https://www.sqlite.org/lang.html\">SQL as understood by SQLite</a></li></ul><h4>Grammars</h4><p>There are a few (usually partial) grammars available in different formats. They can be a good starting point for getting where you need.</p><ul><li><a href=\"https://github.com/ronsavage/SQL\">BNF Grammars for SQL-92, SQL-99 and SQL-2003 </a></li><li>Partial <a href=\"https://github.com/cmedved/Teradata-SQL-Parser\">Teradata SQL grammar for ANTLR4</a></li><li>The ANTLR v4 Grammars repository contains grammars for <a href=\"https://github.com/antlr/grammars-v4/tree/master/sql\">MySQL, PL/SQL, T-SQL and SQLite</a>. In our <a href=\"https://tomassetti.me/antlr-course/\">ANTLR Course</a> we analyze the SQLite grammar to explain its structure and how you can parse a declarative language like SQL.</li></ul><h3>Libraries</h3><p>There are many libraries to parse SQL in different languages. Some support different databases and different programming languages. Here it is a list of the most used ones. Unless otherwise noted, the libraries are released under an opensource license.</p><h4>Multi-lingual and/or multi-databases</h4><ul><li><strong><a href=\"http://www.sqlparser.com/index.php\">General SQL Parser</a></strong> is a commercial library that supports many databases (DB2, Greenplum, Hana, Hive, Impala, Informix, MySQL, Netezza, Oracle, PostgreSQL, Redshift SQL Server, Sybase, and Teradata) and languages (<strong>C#, VB.NET, Java, C/C++, Delphi, VB</strong>). It can validate SQL syntax, format SQL and work with the parse tree</li><li><em><a href=\"https://github.com/JSQLParser/JSqlParser\">JSqlParser</a> parses an SQL statement and translates it into a hierarchy of <strong>Java</strong> classes</em>. It is opensource, with a double LGPL and Apache license, and supports many databases: Oracle, SqlServer, MySQL, PostgreSQL, etc.</li></ul><h4>MySQL parsers</h4><ul><li><a href=\"https://github.com/pingcap/parser\">Pingcap parser</a> is a MySQL parser in <strong>Go</strong>.</li><li><a href=\"https://github.com/xwb1989/sqlparser\">xwb1989/sqlparser</a> is a MySQL parser for <strong>Go</strong>. This parser has been extracted from <a href=\"https://github.com/vitessio/vitess\">Vitess</a>, a database clustering system for horizontal scaling of MySQL.</li><li><a href=\"https://github.com/greenlion/PHP-SQL-Parser\">PHP SQL Parser</a> is a (mainly) MySQL (non-validating) parser written in <strong>PHP</strong>. It can parse other SQL dialects with some modifications. It fully supports parsing the <a href=\"https://github.com/greenlion/PHP-SQL-Parser#full-support-for-the-mysql-dialect-for-the-following-statement-types\">most used SQL statements</a>, but it just returns some information on other statements.</li><li>The <a href=\"https://github.com/phpmyadmin/sql-parser\">SQL Parser of <strong>phpmyadmin</strong></a> is <em>a validating SQL lexer and parser with a focus on MySQL dialect</em>. Given its use in PHPMyAdmin, it is certainly well tested.</li><li><strong><a href=\"https://github.com/JavaScriptor/js-sql-parser\">js-sql-parser</a></strong> is SQL (only select) parser for JavaScript that parses the MySQL 5.7 version of SQL into an AST.</li></ul><h4>SQLite Parsers</h4><ul><li><a href=\"https://github.com/codeschool/sqlite-parser\">sqlite-parser</a> is a parser for SQLite v3 written in <strong>JavaScript</strong> that generates ASTs.</li></ul><h4>SQL Parsers</h4><ul><li><a href=\"https://github.com/forward/sql-parser\">sql-parser</a> is a parser for SQL written in pure <strong>JavaScript</strong>. It is not maintained anymore and it only supports some SELECT queries, but it is probably better than starting from scratch if you need to use JavaScript.</li><li><a href=\"https://github.com/hyrise/sql-parser\">hyrise/sql-parser</a> is a SQL parser for <strong>C++</strong>. It parses the given SQL query into C++ objects. It is developed together with Hyrise, an in-memory database, but it can be used on its own.</li><li><a href=\"https://github.com/andialbrecht/sqlparse\">andialbrecht/<em>sqlparse</em></a><em> is a non-validating SQL parser for <strong>Python</strong>. It provides support for parsing, splitting and formatting SQL statements. </em></li><li><em><a href=\"https://github.com/K2InformaticsGmbH/sqlparse\">K2InformaticsGmbH/sqlparse</a> is a production-ready SQL parser written in pure Erlang</em>. It targets the Oracle PL/SQL dialect.</li><li><strong><a href=\"https://github.com/andygrove/sqlparser-rs\">sqlparser-rs</a></strong> is SQL parser written in <strong>Rust</strong>. It supports the SQL-92, plus some addition for MS-SQL, PostgreSQL, and SQL:2011. The developers say: <em>if you are assessing whether this project will be suitable for your needs, you’ll likely need to experimentally verify whether it supports the subset of SQL that you need</em>.</li><li><strong><a href=\"https://github.com/mozilla/moz-sql-parser\">moz-sql-parser</a></strong> is a peculiar SQL parser in <strong>Python</strong> written by Mozilla. <em>The primary objective of this library is to convert some subset of SQL-92 queries to JSON-izable parse trees</em>.</li><li><a href=\"https://github.com/uber/queryparser\">queryparser</a> is a parser written in <strong>Haskell</strong> for <em>parsing and analysis of <strong>Vertica, Hive, and Presto SQL</strong></em>.</li></ul><h3>Tools</h3><h4>From SQL to a Programming Language or another SQL</h4><ul><li><a href=\"http://www.io64.com/plsql-to-java-migration/\">IO64</a> offers a tool to convert PL/SQL to Java. We have also seen this tool in our previous article <a href=\"https://tomassetti.me/convert-pl-sql-code-to-java/\">Convert PL/SQL code to Java</a></li><li><a href=\"https://www.ispirer.com/\">Ispirer</a> is a company that provides a tool to perform database migration from different SQL dialects to another SQL dialect or a programming language: Ispirer MnMTK. We have seen it in our previous article <a href=\"https://tomassetti.me/convert-pl-sql-code-to-java/\">Convert PL/SQL code to Java</a></li><li><a href=\"http://SQLines SQL Converter\">SQLines SQL Converter</a> is an open-source tool to convert a SQL dialect to a different SQL dialect. It is written in C++ and implements its own SQL parser.</li></ul></div></div><h2>How Hard Could it be to Parse a Declarative Language?</h2><p>Declarative languages tend to have simpler structures than your average programming language. For instance, you do not see many nested lambdas used inside declarative languages. A program in a declarative language is usually a long list of simple statements. <strong>The issue is that any single statement can be fairly complicated in some cases</strong>. And that is what happens in SQL.</p><p>Furthermore, there are actually several versions of SQL. This is true both in the sense that each database can implement it differently, and that there are <a href=\"https://en.wikipedia.org/wiki/ISO/IEC_9075\">many versions of the SQL standard</a>&nbsp;because the language is evolving.</p><p>As an example, you are certainly familiar with a SELECT statement. In its basic format, like <code>SELECT name FROM customers WHERE id = 1</code> it is quite easy to parse. However, the complete statement can be fairly complex. This image represents the SELECT statement as implemented in SQLite.</p><figure class=\"wp-block-image size-large\"><img class=\"wp-image-6048\" src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%200%200'%3E%3C/svg%3E\" alt=\"\" data-lazy-srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/SQLite_select.png 623w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/SQLite_select-212x300.png 212w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/SQLite_select-499x705.png 499w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/SQLite_select-450x636.png 450w\" data-lazy-sizes=\"(max-width: 623px) 100vw, 623px\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/SQLite_select.png\"><noscript><img class=\"wp-image-6048\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/SQLite_select.png\" alt=\"\" srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/SQLite_select.png 623w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/SQLite_select-212x300.png 212w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/SQLite_select-499x705.png 499w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/SQLite_select-450x636.png 450w\" sizes=\"(max-width: 623px) 100vw, 623px\" /></noscript></figure><p>So, to implement support for parsing the general case will certainly take some time.</p><h2>Try to Parse for Your Application</h2><p><strong>The reality is that to implement support for parsing the whole SQL requires a lot of effort</strong>, probably as much as parsing any average programming language. Even more, if you need to parse many different SQL dialects. Then, if you need to parse SQL and cannot rely on a ready-to-use library, you should start with an analysis of your needs. You should try to understand first exactly what you need to parse and then try to parse in light of your application. This means both to parse just what you need and to structure the grammar in a way that makes your life easier.</p><p>For instance, if you just need to translate a series of SQL files just once, it may be acceptable to just ignore 40 complex statements. Maybe translating them manually would take less time than creating a large grammar to do it automatically. This does not work if you either have a lot of code or you need to do the translation repeatedly, not just once.</p><p>In this tutorial we are going to use this pragmatic approach: we are going to create a SQL grammar from scratch to parse just what we need and to ignore the rest.</p><h2>Writing a (Very Partial) Grammar</h2><p>In our example, we will parse a simple SQL file (an exported database) to generate classes that could represent that database. We are going to ignore everything else, even any exported data present in the file. That’s it. The advantage of dealing with SQL files is that we do not need to interact with a database. In fact, the database might not even exist anymore.</p><h3>Designing a Partial Grammar</h3><p>To do that we are going to start with a grammar. We are going to write a very simple one, but there are a couple of things to keep in mind:</p><ul><li>SQL is not case-sensitive, while ANTLR grammars by default are</li><li>Our input (the SQL files) will contain some data that we do not care about. We still need to parse the file successfully while ignoring the extraneous input</li></ul><p>These are notable issues that are specific to SQL and to our approach; they would not probably appear with other languages or if we wanted to create a complete grammar.</p><p>Before starting, just to give you an idea of what we have to deal with, this is a sample SQL file.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"sql\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">--\n-- Table structure for table actor\n--\n--DROP TABLE actor;\n\nCREATE TABLE actor (\n  actor_id numeric NOT NULL ,\n  first_name VARCHAR(45) NOT NULL,\n  last_name VARCHAR(45) NOT NULL,\n  last_update TIMESTAMP NOT NULL,\n  PRIMARY KEY  (actor_id)\n  )\n  ;\n\nCREATE  INDEX idx_actor_last_name ON actor(last_name)\n;\n \nCREATE TRIGGER actor_trigger_ai AFTER INSERT ON actor\n BEGIN\n  UPDATE actor SET last_update = DATETIME('NOW')  WHERE rowid = new.rowid;\n END\n;</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"\">--</span></li><li class=\" even\"><span class=\"\">--</span><span class=\"co1\"> Table structure for table actor</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">--</span></li><li class=\" even\"><span class=\"\">--</span><span class=\"kw1\">DROP</span><span class=\"\"> </span><span class=\"kw1\">TABLE</span><span class=\"\"> actor;</span></li><li class=\" odd\"><span class=\"\"></span></li><li class=\" even\"><span class=\"\"></span><span class=\"kw1\">CREATE</span><span class=\"\"> </span><span class=\"kw1\">TABLE</span><span class=\"\"> actor (</span></li><li class=\" odd\"><span class=\"\">  actor_id </span><span class=\"kw1\">numeric</span><span class=\"\"> </span><span class=\"kw3\">NOT</span><span class=\"\"> </span><span class=\"kw3\">NULL</span><span class=\"\"> ,</span></li><li class=\" even\"><span class=\"\">  first_name </span><span class=\"kw1\">VARCHAR</span><span class=\"\">(</span><span class=\"nu0\">45</span><span class=\"\">) </span><span class=\"kw3\">NOT</span><span class=\"\"> </span><span class=\"kw3\">NULL</span><span class=\"\">,</span></li><li class=\" odd\"><span class=\"\">  last_name </span><span class=\"kw1\">VARCHAR</span><span class=\"\">(</span><span class=\"nu0\">45</span><span class=\"\">) </span><span class=\"kw3\">NOT</span><span class=\"\"> </span><span class=\"kw3\">NULL</span><span class=\"\">,</span></li><li class=\" even\"><span class=\"\">  last_update </span><span class=\"kw1\">TIMESTAMP</span><span class=\"\"> </span><span class=\"kw3\">NOT</span><span class=\"\"> </span><span class=\"kw3\">NULL</span><span class=\"\">,</span></li><li class=\" odd\"><span class=\"\">  </span><span class=\"kw1\">PRIMARY</span><span class=\"\"> </span><span class=\"kw1\">KEY</span><span class=\"\">  (actor_id)</span></li><li class=\" even\"><span class=\"\">  )</span></li><li class=\" odd\"><span class=\"\">  ;</span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\"></span><span class=\"kw1\">CREATE</span><span class=\"\">  </span><span class=\"kw1\">INDEX</span><span class=\"\"> idx_actor_last_name </span><span class=\"kw1\">ON</span><span class=\"\"> actor(last_name)</span></li><li class=\" even\"><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\"> </span></li><li class=\" even\"><span class=\"\"></span><span class=\"kw1\">CREATE</span><span class=\"\"> </span><span class=\"kw1\">TRIGGER</span><span class=\"\"> actor_trigger_ai </span><span class=\"kw1\">AFTER</span><span class=\"\"> </span><span class=\"kw1\">INSERT</span><span class=\"\"> </span><span class=\"kw1\">ON</span><span class=\"\"> actor</span></li><li class=\" odd\"><span class=\"\"> </span><span class=\"kw1\">BEGIN</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">  </span><span class=\"kw1\">UPDATE</span><span class=\"\"> actor </span><span class=\"kw1\">SET</span><span class=\"\"> last_update = DATETIME(</span><span class=\"st0\">'NOW'</span><span class=\"\">)  </span><span class=\"kw1\">WHERE</span><span class=\"\"> rowid = new.rowid;</span></li><li class=\" odd\"><span class=\"\"> </span><span class=\"kw1\">END</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">;</span></li></ol><pre style=\"display: none;\">--\n-- Table structure for table actor\n--\n--DROP TABLE actor;\n\nCREATE TABLE actor (\n  actor_id numeric NOT NULL ,\n  first_name VARCHAR(45) NOT NULL,\n  last_name VARCHAR(45) NOT NULL,\n  last_update TIMESTAMP NOT NULL,\n  PRIMARY KEY  (actor_id)\n  )\n  ;\n\nCREATE  INDEX idx_actor_last_name ON actor(last_name)\n;\n \nCREATE TRIGGER actor_trigger_ai AFTER INSERT ON actor\n BEGIN\n  UPDATE actor SET last_update = DATETIME('NOW')  WHERE rowid = new.rowid;\n END\n;</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>As you can see at a first glance, we need to parse CREATE TABLE statements and ignore the other ones. We also need to ignore some parts of the CREATE TABLE statements, because they do not contain any information we care about for our task.</p><h3>How to Ignore Stuff</h3><p><strong>The key to design a partial grammar is understanding how to ignore everything except for what we care about</strong>. This is not trivial because we have two conflicting needs: to ignore or drop most information and to keep all the necessary context to parse what we need. The more we ignore, the hardest is to parse what we need. This is tricky particularly for lexing since the lexer has less information available to make a decision.</p><p>For instance, we cannot just say ignore anything until we find a <code>CREATE</code> token. That is because the lexer would still find tokens for the elements in row definition, like the ones for naming the columns (e.g. <code>last_name</code>) in INSERT statements or CREATE INDEX. One possible way to deal with this would be lexical modes. These are a way to include multiple sets of lexer rules and switch between them. See our <a href=\"https://tomassetti.me/antlr-mega-tutorial/#lexical-modes\">ANTLR Mega Tutorial</a>, if you need to know more.</p><p>Essentially we would treat SQL as if it were a markup language: bits of structured information in a sea of free text that we could ignore. This could work in our case because SQL has a regular structure and we are just interested in CREATE TABLE statements. For regular structure, we mean that a SQL file is just a list of statements, each of them ends with a semicolon. So, we could just make a <code>CREATE TABLE</code> token to start the special lexical mode and use the <code>semicolon</code> to end the special lexical mode. However, it is not flexible, so it would be risky in case we need to use our grammar for something else.</p><h4>The Cognizant Way of Ignoring Stuff</h4><p>Our preferred approach is more flexible, and can also be used for regular programming languages.</p><p>On the lexer side, we just put as the last lexer rule this ANY rule.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"generic\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">ANY             : . -&gt; skip;</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"\">ANY             : . -&gt; skip;</span></li></ol><pre style=\"display: none;\">ANY             : . -&gt; skip;</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>We skip every character, that was not already recognized by some previous token.</p><p>On the parser side, these would be our main rules.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"generic\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">statements          : (statement | ignore)+ EOF\n                    ;\n\nstatement           : createStmt\n                    ;\n\nignore              : .*? SEMICOLON\n                    | COMMENT\n                    ;</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"\">statements          : </span><span class=\"br0\">(</span><span class=\"\">statement | ignore</span><span class=\"br0\">)</span><span class=\"\">+ EOF</span></li><li class=\" even\"><span class=\"\">                    ;</span></li><li class=\" odd\"><span class=\"\"></span></li><li class=\" even\"><span class=\"\">statement           : createStmt</span></li><li class=\" odd\"><span class=\"\">                    ;</span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">ignore              : .*? SEMICOLON</span></li><li class=\" even\"><span class=\"\">                    | COMMENT</span></li><li class=\" odd\"><span class=\"\">                    ;</span></li></ol><pre style=\"display: none;\">statements          : (statement | ignore)+ EOF\n                    ;\n\nstatement           : createStmt\n                    ;\n\nignore              : .*? SEMICOLON\n                    | COMMENT\n                    ;</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>The main rule is <code>statements</code>, which captures both the stuff we care about and the stuff to ignore. This approach allows us to start using our grammar while we build it. For this example, we only need to parse CREATE TABLE statements, but you could slowly add support for parsing more statements with this structure.</p><p>We need the <code>ignore</code> rule to maintain an understanding of the structure of the SQL file. <strong>Without this rule, we would not be able to recognize and parse the statements we are interested in</strong>. The negative side-effect is that it will clutter our parse tree with <em>ignore</em> nodes. For instance, this is a graphical representation of a sample parse tree made with <code>grun</code>, the ANTLR testing utility.</p><figure class=\"wp-block-image size-large\"><img class=\"wp-image-6052\" src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%200%200'%3E%3C/svg%3E\" alt=\"Sample parse tree with a partial SQL grammar\" data-lazy-srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-1030x772.png 1030w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-300x225.png 300w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-768x576.png 768w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-1536x1151.png 1536w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-1500x1124.png 1500w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-705x528.png 705w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-450x337.png 450w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-205x155.png 205w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar.png 1628w\" data-lazy-sizes=\"(max-width: 1030px) 100vw, 1030px\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-1030x772.png\"><noscript><img class=\"wp-image-6052\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-1030x772.png\" alt=\"Sample parse tree with a partial SQL grammar\" srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-1030x772.png 1030w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-300x225.png 300w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-768x576.png 768w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-1536x1151.png 1536w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-1500x1124.png 1500w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-705x528.png 705w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-450x337.png 450w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar-205x155.png 205w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/sample_parse_tree_sql_partial_grammar.png 1628w\" sizes=\"(max-width: 1030px) 100vw, 1030px\" /></noscript></figure><h3>Parsing Create Statements</h3><p>We use a similar approach to parsing the CREATE TABLE statements.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"generic\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">createStmt          : CREATE TABLE (IF NOT EXISTS)? tableName=name\n                        LPAREN element (COMMA element)* RPAREN?\n                        SEMICOLON\n                    ;\n\nelement             : definition\n                    | ignorable\n                    ;\n\nignorable           : (PRIMARY? KEY | CONSTRAINT | SPECIAL_FEATURES | FULLTEXT) .*? (COMMA|RPAREN)                    \n                    ;\n\ndefinition          : name type defaultValue? nullability? attributes*;</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"\">createStmt          : CREATE </span><span class=\"kw1\">TABLE</span><span class=\"\"> </span><span class=\"br0\">(</span><span class=\"\">IF NOT EXISTS</span><span class=\"br0\">)</span><span class=\"\">? tableName=name</span></li><li class=\" even\"><span class=\"\">                        LPAREN </span><span class=\"kw1\">element</span><span class=\"\"> </span><span class=\"br0\">(</span><span class=\"\">COMMA element</span><span class=\"br0\">)</span><span class=\"\">* RPAREN?</span></li><li class=\" odd\"><span class=\"\">                        SEMICOLON</span></li><li class=\" even\"><span class=\"\">                    ;</span></li><li class=\" odd\"><span class=\"\"></span></li><li class=\" even\"><span class=\"\">element             : definition</span></li><li class=\" odd\"><span class=\"\">                    | ignorable</span></li><li class=\" even\"><span class=\"\">                    ;</span></li><li class=\" odd\"><span class=\"\"></span></li><li class=\" even\"><span class=\"\">ignorable           : </span><span class=\"br0\">(</span><span class=\"\">PRIMARY? KEY | CONSTRAINT | SPECIAL_FEATURES | FULLTEXT</span><span class=\"br0\">)</span><span class=\"\"> .*? </span><span class=\"br0\">(</span><span class=\"\">COMMA|RPAREN</span><span class=\"br0\">)</span><span class=\"\">                    </span></li><li class=\" odd\"><span class=\"\">                    ;</span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">definition          : name type defaultValue? nullability? attributes*;</span></li></ol><pre style=\"display: none;\">createStmt          : CREATE TABLE (IF NOT EXISTS)? tableName=name\n                        LPAREN element (COMMA element)* RPAREN?\n                        SEMICOLON\n                    ;\n\nelement             : definition\n                    | ignorable\n                    ;\n\nignorable           : (PRIMARY? KEY | CONSTRAINT | SPECIAL_FEATURES | FULLTEXT) .*? (COMMA|RPAREN)                    \n                    ;\n\ndefinition          : name type defaultValue? nullability? attributes*;</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>The statement includes both definitions of columns, that we need, and settings for the table, that we could ignore. So, our <code>element</code> rule can accept both the definition for a row and the information about primary keys, constraints, etc. Later, in our code, we will simply ignore both the nodes <code>ignore</code> and <code>ignorable</code>.</p><p>The rules themselves are fairly easy to understand and should be obvious for everybody that has seen SQL. There is only a dirty trick that needs to be explained. You can see that the closing parenthesis (<code>RPAREN</code>) that should be at the end of the list of column definitions is optional. Technically this is not correct, it should always be there. However, we use this to fix an issue regarding the <code>ignorable</code> rule.</p><h4>Getting Around the Need to Actually Parse Settings</h4><p>The issue is that the <code>ignorable</code> rule is only a partial implementation of the parsing of these settings that you will find in a SQL file. In fact, this is the bare minimum necessary to parse correctly a bunch of sample SQL files we encountered. It is not a good design, but this is a very realistic implementation. Look at this example and see if you can spot our problem.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"generic\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">CREATE TABLE city (\n  city_id int NOT NULL,\n  city VARCHAR(50) NOT NULL,\n  country_id SMALLINT NOT NULL,\n  last_update TIMESTAMP NOT NULL,\n  PRIMARY KEY  (city_id),\n  CONSTRAINT fk_city_country FOREIGN KEY (country_id) REFERENCES country (country_id) ON DELETE NO ACTION ON UPDATE CASCADE\n);</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"\">CREATE TABLE </span><span class=\"kw1\">city</span><span class=\"\"> </span><span class=\"br0\">(</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">  city_id int NOT NULL,</span></li><li class=\" odd\"><span class=\"\">  city </span><span class=\"kw1\">VARCHAR</span><span class=\"br0\">(</span><span class=\"nu0\">50</span><span class=\"br0\">)</span><span class=\"\"> NOT NULL,</span></li><li class=\" even\"><span class=\"\">  country_id SMALLINT NOT NULL,</span></li><li class=\" odd\"><span class=\"\">  last_update TIMESTAMP NOT NULL,</span></li><li class=\" even\"><span class=\"\">  PRIMARY </span><span class=\"kw1\">KEY</span><span class=\"\">  </span><span class=\"br0\">(</span><span class=\"\">city_id</span><span class=\"br0\">)</span><span class=\"\">,</span></li><li class=\" odd\"><span class=\"\">  CONSTRAINT fk_city_country FOREIGN </span><span class=\"kw1\">KEY</span><span class=\"\"> </span><span class=\"br0\">(</span><span class=\"\">country_id</span><span class=\"br0\">)</span><span class=\"\"> REFERENCES </span><span class=\"kw1\">country</span><span class=\"\"> </span><span class=\"br0\">(</span><span class=\"\">country_id</span><span class=\"br0\">)</span><span class=\"\"> ON DELETE NO ACTION ON UPDATE CASCADE</span></li><li class=\" even\"><span class=\"\"></span><span class=\"br0\">)</span><span class=\"\">;</span></li></ol><pre style=\"display: none;\">CREATE TABLE city (\n  city_id int NOT NULL,\n  city VARCHAR(50) NOT NULL,\n  country_id SMALLINT NOT NULL,\n  last_update TIMESTAMP NOT NULL,\n  PRIMARY KEY  (city_id),\n  CONSTRAINT fk_city_country FOREIGN KEY (country_id) REFERENCES country (country_id) ON DELETE NO ACTION ON UPDATE CASCADE\n);</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p><strong>This partial implementation has the issue that it does not parse well enough to understand when it found the end of a setting</strong>. So, it uses as a clue the comma (i.e., the start of a new setting) or the final closing parenthesis (i.e., the end of the list of elements) for the final setting.</p><p>Now, how safe is it to use this dirty trick? In this case, it is safe because SQL files are not written by humans, they are exported with tools. This means that there will not be missing parenthesis that will mess up the recognition of subsequent statements. So, we actually can be sure that every CREATE TABLE will end with a closing parenthesis and a semicolon. This may vary with different languages, different sources of SQL statements or different databases.</p><p>When you need to only partially implement a grammar these sorts of tricks can be quite helpful to speed up development and get your task done quicker. You have to be careful and aware of the risks, but they can be useful.</p><h3>The Rest of the Grammar</h3><p>The rest of the grammar is also fairly simple to understand. We just mention a couple of things.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"generic\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">name                : QUOTE? NAME QUOTE? ;</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"\">name                : QUOTE? NAME QUOTE? ;</span></li></ol><pre style=\"display: none;\">name                : QUOTE? NAME QUOTE? ;</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>The rule <code>name</code> is a parser rule instead of a lexer rule. That is because some tools wrap the name of the column with quotation marks (these are also used as apostrophes in some languages) like <code>`</code> or <code>'</code>. With this definition, later in our code, we can easily extract the real name of the column without any check for quotation marks.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"generic\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">type                : (INTEGER | INT) UNSIGNED?                                                     #integerType\n                    | (TINYINT | SMALLINT) UNSIGNED?                                                #smallIntegerType\n                    | TEXT                                                                          #textType\n                    | BLOB (SUBTYPE type)?                                                          #blobType\n                    | (VARCHAR|CHARVAR) LPAREN NUMBER RPAREN                                        #varcharType\n                    | CHAR LPAREN NUMBER RPAREN                                                     #charType\n                    | YEAR                                                                          #yearType\n                    | DATETIME                                                                      #datetimeType\n                    | TIMESTAMP TIMEZONE?                                                           #timestampType\n                    | (NUMERIC | DECIMAL) (LPAREN precision=NUMBER (COMMA scale=NUMBER)? RPAREN)?   #decimalType\n                    ;</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"\">type                : </span><span class=\"br0\">(</span><span class=\"\">INTEGER | INT</span><span class=\"br0\">)</span><span class=\"\"> UNSIGNED?                                                     </span><span class=\"co1\">#integerType</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                    | </span><span class=\"br0\">(</span><span class=\"\">TINYINT | SMALLINT</span><span class=\"br0\">)</span><span class=\"\"> UNSIGNED?                                                </span><span class=\"co1\">#smallIntegerType</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">                    | TEXT                                                                          </span><span class=\"co1\">#textType</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                    | </span><span class=\"kw1\">BLOB</span><span class=\"\"> </span><span class=\"br0\">(</span><span class=\"\">SUBTYPE type</span><span class=\"br0\">)</span><span class=\"\">?                                                          </span><span class=\"co1\">#blobType</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">                    | </span><span class=\"br0\">(</span><span class=\"\">VARCHAR|CHARVAR</span><span class=\"br0\">)</span><span class=\"\"> LPAREN NUMBER RPAREN                                        </span><span class=\"co1\">#varcharType</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                    | CHAR LPAREN NUMBER RPAREN                                                     </span><span class=\"co1\">#charType</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">                    | YEAR                                                                          </span><span class=\"co1\">#yearType</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                    | DATETIME                                                                      </span><span class=\"co1\">#datetimeType</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">                    | TIMESTAMP TIMEZONE?                                                           </span><span class=\"co1\">#timestampType</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                    | </span><span class=\"br0\">(</span><span class=\"\">NUMERIC | DECIMAL</span><span class=\"br0\">)</span><span class=\"\"> </span><span class=\"br0\">(</span><span class=\"\">LPAREN precision=</span><span class=\"kw1\">NUMBER</span><span class=\"\"> </span><span class=\"br0\">(</span><span class=\"\">COMMA scale=NUMBER</span><span class=\"br0\">)</span><span class=\"\">? RPAREN</span><span class=\"br0\">)</span><span class=\"\">?   </span><span class=\"co1\">#decimalType</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">                    ;</span></li></ol><pre style=\"display: none;\">type                : (INTEGER | INT) UNSIGNED?                                                     #integerType\n                    | (TINYINT | SMALLINT) UNSIGNED?                                                #smallIntegerType\n                    | TEXT                                                                          #textType\n                    | BLOB (SUBTYPE type)?                                                          #blobType\n                    | (VARCHAR|CHARVAR) LPAREN NUMBER RPAREN                                        #varcharType\n                    | CHAR LPAREN NUMBER RPAREN                                                     #charType\n                    | YEAR                                                                          #yearType\n                    | DATETIME                                                                      #datetimeType\n                    | TIMESTAMP TIMEZONE?                                                           #timestampType\n                    | (NUMERIC | DECIMAL) (LPAREN precision=NUMBER (COMMA scale=NUMBER)? RPAREN)?   #decimalType\n                    ;</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>The rule to parse the type of the column includes rule labels. We designed this way to simplify our job, later in the code where we use the parser. This is also the reason because the VARCHAR rule is separated from the CHAR rule. Structurally the rules are obviously identical, but they mean something different. <strong>Remember: you should parse for your application, to make the parse effective for your needs.</strong></p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"generic\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">fragment A      : [aA];\nfragment B      : [bB];\nfragment C      : [cC];\nfragment D      : [dD];\nfragment E      : [eE];\n// etc.</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"\">fragment A      : </span><span class=\"br0\">[</span><span class=\"\">aA</span><span class=\"br0\">]</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">fragment B      : </span><span class=\"br0\">[</span><span class=\"\">bB</span><span class=\"br0\">]</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">fragment C      : </span><span class=\"br0\">[</span><span class=\"\">cC</span><span class=\"br0\">]</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">fragment D      : </span><span class=\"br0\">[</span><span class=\"\">dD</span><span class=\"br0\">]</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">fragment E      : </span><span class=\"br0\">[</span><span class=\"\">eE</span><span class=\"br0\">]</span><span class=\"\">;</span><span class=\"co1\"></span></li><li class=\" even\"><span class=\"co1\">// etc.</span></li></ol><pre style=\"display: none;\">fragment A      : [aA];\nfragment B      : [bB];\nfragment C      : [cC];\nfragment D      : [dD];\nfragment E      : [eE];\n// etc.</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>Since SQL is case-insensitive we use fragments for letters everywhere we need, to ensure that we parse everything correctly.</p><p>You can see the rest of the grammar on the companion repository.</p><h2>CREATING THE C# PROJECT</h2><p>We can finally see some code. We are going to create a C# project from the command line since we are using VS Code as our editor. These are the instructions to create the project and to add the ANTLR library.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">// create a new directory somewhere\n// to create a new C# project\ndotnet new console -lang C#\n// to install the standard ANTLR 4 Runtime\ndotnet add package Antlr4.Runtime.Standard</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"\">// create a new directory somewhere</span></li><li class=\" even\"><span class=\"\">// to create a new C# project</span></li><li class=\" odd\"><span class=\"\">dotnet new console -lang C#</span></li><li class=\" even\"><span class=\"\">// to install the standard ANTLR 4 Runtime</span></li><li class=\" odd\"><span class=\"\">dotnet add package Antlr4.Runtime.Standard</span></li></ol><pre style=\"display: none;\">// create a new directory somewhere\n// to create a new C# project\ndotnet new console -lang C#\n// to install the standard ANTLR 4 Runtime\ndotnet add package Antlr4.Runtime.Standard</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>These are the instructions to generate the parser and to run the program.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"shell\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">// to generate the parser\nantlr4 SQL.g4 -Dlanguage=CSharp -o generated\\ -encoding UTF-8\n// to run the program\ndotnet run</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"\">// to generate the parser</span></li><li class=\" even\"><span class=\"\">antlr4 SQL.g4 -Dlanguage=CSharp -o generated\\ -encoding UTF-8</span></li><li class=\" odd\"><span class=\"\">// to run the program</span></li><li class=\" even\"><span class=\"\">dotnet run</span></li></ol><pre style=\"display: none;\">// to generate the parser\nantlr4 SQL.g4 -Dlanguage=CSharp -o generated\\ -encoding UTF-8\n// to run the program\ndotnet run</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>Even our main source code file is fairly standard.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"csharp\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">static void Main(string[] args)\n{\n    // standard ANTLR code\n    // we get the input\n    ICharStream chars = CharStreams.fromPath(args[0]);\n    // we set up the lexer\n    SQLLexer lexer = new SQLLexer(chars);            \n    // we use the lexer\n    CommonTokenStream stream = new CommonTokenStream(lexer);\n    // we set up the parser\n    SQLParser parser = new SQLParser(stream);\n\n    // we find the root node of our parse tree             \n    var tree = parser.statements();                                    \n    \n    // we create our visitor\n    CreateVisitor createVisitor = new CreateVisitor();   \n    List&lt;ClassDescriptor&gt; classes = createVisitor.VisitStatements(tree);\n\n    // we choose our code generator...\n    ICodeGenerator generator;\n\n    // ...depending on the command line argument\n    if(args.Count() &gt; 1 &amp;&amp; args[1] == \"kotlin\")\n        generator = new KotlinCodeGenerator();\n    else\n        generator = new CSharpCodeGenerator();\n    \n    Console.WriteLine(generator.ToSourceCode(\"SQLDataTypes\", classes));\n}</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"kw3\">static</span><span class=\"\"> </span><span class=\"kw1\">void</span><span class=\"\"> </span><span class=\"me0\">Main</span><span class=\"br0\">(</span><span class=\"kw2\">string</span><span class=\"br0\">[</span><span class=\"br0\">]</span><span class=\"\"> args</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\"></span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">   </span><span class=\"co1\"> // standard ANTLR code</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">   </span><span class=\"co1\"> // we get the input</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    ICharStream chars = CharStreams.</span><span class=\"me0\">fromPath</span><span class=\"br0\">(</span><span class=\"\">args</span><span class=\"br0\">[</span><span class=\"nu0\">0</span><span class=\"br0\">]</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">   </span><span class=\"co1\"> // we set up the lexer</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    SQLLexer lexer = </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">SQLLexer</span><span class=\"br0\">(</span><span class=\"\">chars</span><span class=\"br0\">)</span><span class=\"\">;            </span></li><li class=\" even\"><span class=\"\">   </span><span class=\"co1\"> // we use the lexer</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    CommonTokenStream stream = </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">CommonTokenStream</span><span class=\"br0\">(</span><span class=\"\">lexer</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">   </span><span class=\"co1\"> // we set up the parser</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    SQLParser parser = </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">SQLParser</span><span class=\"br0\">(</span><span class=\"\">stream</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">   </span><span class=\"co1\"> // we find the root node of our parse tree             </span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">    var tree = parser.</span><span class=\"me0\">statements</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;                                    </span></li><li class=\" odd\"><span class=\"\">    </span></li><li class=\" even\"><span class=\"\">   </span><span class=\"co1\"> // we create our visitor</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    CreateVisitor createVisitor = </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">CreateVisitor</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;   </span></li><li class=\" even\"><span class=\"\">    List&lt;ClassDescriptor&gt; classes = createVisitor.</span><span class=\"me0\">VisitStatements</span><span class=\"br0\">(</span><span class=\"\">tree</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\"></span></li><li class=\" even\"><span class=\"\">   </span><span class=\"co1\"> // we choose our code generator...</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    ICodeGenerator generator;</span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">   </span><span class=\"co1\"> // ...depending on the command line argument</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">    </span><span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"\">args.</span><span class=\"me0\">Count</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\"> &gt; </span><span class=\"nu0\">1</span><span class=\"\"> &amp;&amp; args</span><span class=\"br0\">[</span><span class=\"nu0\">1</span><span class=\"br0\">]</span><span class=\"\"> == </span><span class=\"st1\">\"kotlin\"</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">        generator = </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">KotlinCodeGenerator</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">    </span><span class=\"kw1\">else</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">        generator = </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">CSharpCodeGenerator</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">    </span></li><li class=\" odd\"><span class=\"\">    Console.</span><span class=\"me0\">WriteLine</span><span class=\"br0\">(</span><span class=\"\">generator.</span><span class=\"me0\">ToSourceCode</span><span class=\"br0\">(</span><span class=\"st1\">\"SQLDataTypes\"</span><span class=\"\">, classes</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\"></span><span class=\"br0\">}</span></li></ol><pre style=\"display: none;\">static void Main(string[] args)\n{\n    // standard ANTLR code\n    // we get the input\n    ICharStream chars = CharStreams.fromPath(args[0]);\n    // we set up the lexer\n    SQLLexer lexer = new SQLLexer(chars);            \n    // we use the lexer\n    CommonTokenStream stream = new CommonTokenStream(lexer);\n    // we set up the parser\n    SQLParser parser = new SQLParser(stream);\n\n    // we find the root node of our parse tree             \n    var tree = parser.statements();                                    \n    \n    // we create our visitor\n    CreateVisitor createVisitor = new CreateVisitor();   \n    List&lt;ClassDescriptor&gt; classes = createVisitor.VisitStatements(tree);\n\n    // we choose our code generator...\n    ICodeGenerator generator;\n\n    // ...depending on the command line argument\n    if(args.Count() &gt; 1 &amp;&amp; args[1] == \"kotlin\")\n        generator = new KotlinCodeGenerator();\n    else\n        generator = new CSharpCodeGenerator();\n    \n    Console.WriteLine(generator.ToSourceCode(\"SQLDataTypes\", classes));\n}</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>The comments are self-explanatory. After our standard code to setup ANTLR and parse the input, we employ our <code>CreateVisitor</code>. We use the visitor to visit the create table statements and to generate an internal representation of them. Then we use this representation to generate a source code file in our chosen language. In our example we choose to generate either in Kotlin or C#, to show how easy it can be to work with our SQL data once you parse it.</p><p>This is the simple overall structure; we can now move on the individual parts.</p><h2>Visiting the Statements</h2><p>Let’s start by looking at the general organization of our visitor.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"csharp\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">public class CreateVisitor\n{\n    public  List&lt;ClassDescriptor&gt; VisitStatements(StatementsContext context)    \n    {\n        List&lt;ClassDescriptor&gt; tables = new List&lt;ClassDescriptor&gt;();\n        \n        foreach(var statement in context.statement())\n        {\n            tables.Add(VisitStmt(statement));\n        }\n\n        return tables;\n    }\n\n    public ClassDescriptor VisitStmt(StatementContext context)\n    {                      \n        return VisitCreateStmt(context.createStmt());\n    }\n\n    public ClassDescriptor VisitCreateStmt(CreateStmtContext context)\n    {\n        ClassDescriptor table = new ClassDescriptor();\n\n        table.Name = context.tableName.NAME().GetText();\n        table.Fields = new List&lt;FieldDescriptor&gt;();\n\n        foreach (var el in context.element())\n        {\n            if(el.definition() != null)\n            {\n                table.Fields.Add(VisitDefinition(el.definition()));\n            }                 \n        }        \n\n        return table;\n    }\n\t\n    [..]</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"kw1\">public</span><span class=\"\"> </span><span class=\"kw3\">class</span><span class=\"\"> CreateVisitor</span></li><li class=\" even\"><span class=\"\"></span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    </span><span class=\"kw1\">public</span><span class=\"\">  List&lt;ClassDescriptor&gt; </span><span class=\"me0\">VisitStatements</span><span class=\"br0\">(</span><span class=\"\">StatementsContext context</span><span class=\"br0\">)</span><span class=\"\">    </span></li><li class=\" even\"><span class=\"\">    </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">        List&lt;ClassDescriptor&gt; tables = </span><span class=\"kw1\">new</span><span class=\"\"> List&lt;ClassDescriptor&gt;</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">        </span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"kw1\">foreach</span><span class=\"br0\">(</span><span class=\"\">var statement </span><span class=\"kw3\">in</span><span class=\"\"> context.</span><span class=\"me0\">statement</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">            tables.</span><span class=\"me0\">Add</span><span class=\"br0\">(</span><span class=\"me0\">VisitStmt</span><span class=\"br0\">(</span><span class=\"\">statement</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">        </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        </span><span class=\"kw1\">return</span><span class=\"\"> tables;</span></li><li class=\" odd\"><span class=\"\">    </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    </span><span class=\"kw1\">public</span><span class=\"\"> ClassDescriptor </span><span class=\"me0\">VisitStmt</span><span class=\"br0\">(</span><span class=\"\">StatementContext context</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">    </span><span class=\"br0\">{</span><span class=\"\">                      </span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"kw1\">return</span><span class=\"\"> </span><span class=\"me0\">VisitCreateStmt</span><span class=\"br0\">(</span><span class=\"\">context.</span><span class=\"me0\">createStmt</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">    </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\"></span></li><li class=\" even\"><span class=\"\">    </span><span class=\"kw1\">public</span><span class=\"\"> ClassDescriptor </span><span class=\"me0\">VisitCreateStmt</span><span class=\"br0\">(</span><span class=\"\">CreateStmtContext context</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        ClassDescriptor table = </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">ClassDescriptor</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        table.Name = context.tableName.</span><span class=\"me0\">NAME</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">.</span><span class=\"me0\">GetText</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">        table.Fields = </span><span class=\"kw1\">new</span><span class=\"\"> List&lt;FieldDescriptor&gt;</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"kw1\">foreach</span><span class=\"\"> </span><span class=\"br0\">(</span><span class=\"\">var el </span><span class=\"kw3\">in</span><span class=\"\"> context.</span><span class=\"me0\">element</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">            </span><span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"\">el.</span><span class=\"me0\">definition</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\"> != </span><span class=\"kw1\">null</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">            </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">                table.Fields.</span><span class=\"me0\">Add</span><span class=\"br0\">(</span><span class=\"me0\">VisitDefinition</span><span class=\"br0\">(</span><span class=\"\">el.</span><span class=\"me0\">definition</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">            </span><span class=\"br0\">}</span><span class=\"\">                 </span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"br0\">}</span><span class=\"\">        </span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"kw1\">return</span><span class=\"\"> table;</span></li><li class=\" even\"><span class=\"\">    </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">  </span></li><li class=\" even\"><span class=\"\">    </span><span class=\"br0\">[</span><span class=\"\">..</span><span class=\"br0\">]</span></li></ol><pre style=\"display: none;\">public class CreateVisitor\n{\n    public  List&lt;ClassDescriptor&gt; VisitStatements(StatementsContext context)    \n    {\n        List&lt;ClassDescriptor&gt; tables = new List&lt;ClassDescriptor&gt;();\n        \n        foreach(var statement in context.statement())\n        {\n            tables.Add(VisitStmt(statement));\n        }\n\n        return tables;\n    }\n\n    public ClassDescriptor VisitStmt(StatementContext context)\n    {                      \n        return VisitCreateStmt(context.createStmt());\n    }\n\n    public ClassDescriptor VisitCreateStmt(CreateStmtContext context)\n    {\n        ClassDescriptor table = new ClassDescriptor();\n\n        table.Name = context.tableName.NAME().GetText();\n        table.Fields = new List&lt;FieldDescriptor&gt;();\n\n        foreach (var el in context.element())\n        {\n            if(el.definition() != null)\n            {\n                table.Fields.Add(VisitDefinition(el.definition()));\n            }                 \n        }        \n\n        return table;\n    }\n\t\n    [..]</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>The first thing we notice is that we do not need to use the standard base visitor that can be created for us by ANTLR. Our visitor uses just our code. We do not need to use the base visitor, because of the structure of a SQL file and because we know exactly what we need to visit. We can completely ignore everything that is not a create statement because every statement in our SQL files is a top-level element. It is not like statements in your average programming language, that can be nested inside a code block, function definitions, etc. Also, the structure of create statements is simple, so we can visit everything ourselves.</p><p>In short, all we need to do is:</p><ul><li>to visit the <code>statements</code> node</li><li>then to visit each <code>statement</code> node (we ignore the <code>ignore</code> nodes) and to select the <code>createStmt</code> node</li><li>visiting the <code>createStmt</code> nodes, we pick only the <code>definition</code> nodes (we ignore the <code>ignorable</code> nodes) to get all the columns definition</li></ul><h2>Translating Types from SQL to Your Language</h2><p>Inside the <code>VisitDefinition</code> method we deal with the only real complication of this visitor: handling types.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"csharp\" data-enlighter-theme=\"\" data-enlighter-highlight=\"37,38\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">        public FieldDescriptor VisitDefinition(DefinitionContext context)\n\t{\n\t\tstring name = context.name().NAME().GetText();\n\t\tTypeDescriptor type;\n\t\t\n\t\tswitch(context.type().GetType().Name)\n\t\t{\n\t\t\tcase \"IntegerTypeContext\":\n\t\t\t\ttype = VisitIntegerType(context.type() as IntegerTypeContext);\n\t\t\t\tbreak;\n\t\t\tcase \"SmallIntegerTypeContext\":\n\t\t\t\ttype = VisitSmallIntegerType(context.type() as SmallIntegerTypeContext);\n\t\t\t\tbreak;\n\t\t\tcase \"VarcharTypeContext\":\n\t\t\t\ttype = VisitVarcharType(context.type() as VarcharTypeContext);\n\t\t\t\tbreak;\n\t\t\tcase \"TimestampTypeContext\":\n\t\t\t\ttype = VisitTimestampType(context.type() as TimestampTypeContext);\n\t\t\t\tbreak;\n\t\t\tcase \"TextTypeContext\":\n\t\t\t\ttype = VisitTextType(context.type() as TextTypeContext);\n\t\t\t\tbreak;               \n\t\t\tcase \"DecimalTypeContext\":\n\t\t\t\ttype = VisitDecimalType(context.type() as DecimalTypeContext);\n\t\t\t\tbreak;  \n\t\t\tcase \"CharTypeContext\":\n\t\t\t\ttype = VisitCharType(context.type() as CharTypeContext);\n\t\t\t\tbreak; \n\t\t\tcase \"BlobTypeContext\":\n\t\t\t\ttype = VisitBlobType(context.type() as BlobTypeContext);\n\t\t\t\tbreak; \n\t\t\tdefault:\n\t\t\t\ttype = null;\n\t\t\t\tbreak;\n\t\t}\n\t\t\n\t\tif(context.nullability() != null &amp;&amp; context.nullability().NOT() != null)\n\t\t\ttype.Nullability = false;\n\t\n\t\treturn new FieldDescriptor(name, type);\n\t}</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"\">        </span><span class=\"kw1\">public</span><span class=\"\"> FieldDescriptor </span><span class=\"me0\">VisitDefinition</span><span class=\"br0\">(</span><span class=\"\">DefinitionContext context</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">  </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    </span><span class=\"kw2\">string</span><span class=\"\"> name = context.</span><span class=\"me0\">name</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">.</span><span class=\"me0\">NAME</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">.</span><span class=\"me0\">GetText</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">    TypeDescriptor type;</span></li><li class=\" odd\"><span class=\"\">    </span></li><li class=\" even\"><span class=\"\">    </span><span class=\"kw1\">switch</span><span class=\"br0\">(</span><span class=\"\">context.</span><span class=\"me0\">type</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">.</span><span class=\"me0\">GetType</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">.Name</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">      </span><span class=\"kw1\">case</span><span class=\"\"> </span><span class=\"st1\">\"IntegerTypeContext\"</span><span class=\"\">:</span></li><li class=\" odd\"><span class=\"\">        type = </span><span class=\"me0\">VisitIntegerType</span><span class=\"br0\">(</span><span class=\"\">context.</span><span class=\"me0\">type</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\"> </span><span class=\"kw1\">as</span><span class=\"\"> IntegerTypeContext</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">        </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">      </span><span class=\"kw1\">case</span><span class=\"\"> </span><span class=\"st1\">\"SmallIntegerTypeContext\"</span><span class=\"\">:</span></li><li class=\" even\"><span class=\"\">        type = </span><span class=\"me0\">VisitSmallIntegerType</span><span class=\"br0\">(</span><span class=\"\">context.</span><span class=\"me0\">type</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\"> </span><span class=\"kw1\">as</span><span class=\"\"> SmallIntegerTypeContext</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">      </span><span class=\"kw1\">case</span><span class=\"\"> </span><span class=\"st1\">\"VarcharTypeContext\"</span><span class=\"\">:</span></li><li class=\" odd\"><span class=\"\">        type = </span><span class=\"me0\">VisitVarcharType</span><span class=\"br0\">(</span><span class=\"\">context.</span><span class=\"me0\">type</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\"> </span><span class=\"kw1\">as</span><span class=\"\"> VarcharTypeContext</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">        </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">      </span><span class=\"kw1\">case</span><span class=\"\"> </span><span class=\"st1\">\"TimestampTypeContext\"</span><span class=\"\">:</span></li><li class=\" even\"><span class=\"\">        type = </span><span class=\"me0\">VisitTimestampType</span><span class=\"br0\">(</span><span class=\"\">context.</span><span class=\"me0\">type</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\"> </span><span class=\"kw1\">as</span><span class=\"\"> TimestampTypeContext</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">      </span><span class=\"kw1\">case</span><span class=\"\"> </span><span class=\"st1\">\"TextTypeContext\"</span><span class=\"\">:</span></li><li class=\" odd\"><span class=\"\">        type = </span><span class=\"me0\">VisitTextType</span><span class=\"br0\">(</span><span class=\"\">context.</span><span class=\"me0\">type</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\"> </span><span class=\"kw1\">as</span><span class=\"\"> TextTypeContext</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">        </span><span class=\"kw1\">break</span><span class=\"\">;               </span></li><li class=\" odd\"><span class=\"\">      </span><span class=\"kw1\">case</span><span class=\"\"> </span><span class=\"st1\">\"DecimalTypeContext\"</span><span class=\"\">:</span></li><li class=\" even\"><span class=\"\">        type = </span><span class=\"me0\">VisitDecimalType</span><span class=\"br0\">(</span><span class=\"\">context.</span><span class=\"me0\">type</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\"> </span><span class=\"kw1\">as</span><span class=\"\"> DecimalTypeContext</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"kw1\">break</span><span class=\"\">;  </span></li><li class=\" even\"><span class=\"\">      </span><span class=\"kw1\">case</span><span class=\"\"> </span><span class=\"st1\">\"CharTypeContext\"</span><span class=\"\">:</span></li><li class=\" odd\"><span class=\"\">        type = </span><span class=\"me0\">VisitCharType</span><span class=\"br0\">(</span><span class=\"\">context.</span><span class=\"me0\">type</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\"> </span><span class=\"kw1\">as</span><span class=\"\"> CharTypeContext</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">        </span><span class=\"kw1\">break</span><span class=\"\">; </span></li><li class=\" odd\"><span class=\"\">      </span><span class=\"kw1\">case</span><span class=\"\"> </span><span class=\"st1\">\"BlobTypeContext\"</span><span class=\"\">:</span></li><li class=\" even\"><span class=\"\">        type = </span><span class=\"me0\">VisitBlobType</span><span class=\"br0\">(</span><span class=\"\">context.</span><span class=\"me0\">type</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\"> </span><span class=\"kw1\">as</span><span class=\"\"> BlobTypeContext</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"kw1\">break</span><span class=\"\">; </span></li><li class=\" even\"><span class=\"\">      </span><span class=\"kw1\">default</span><span class=\"\">:</span></li><li class=\" odd\"><span class=\"\">        type = </span><span class=\"kw1\">null</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">        </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">    </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">    </span></li><li class=\"specialline odd\"><span class=\"\">    </span><span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"\">context.</span><span class=\"me0\">nullability</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\"> != </span><span class=\"kw1\">null</span><span class=\"\"> &amp;&amp; context.</span><span class=\"me0\">nullability</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">.</span><span class=\"me0\">NOT</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\"> != </span><span class=\"kw1\">null</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\"specialline even\"><span class=\"\">      type.Nullability = </span><span class=\"kw1\">false</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">  </span></li><li class=\" even\"><span class=\"\">    </span><span class=\"kw1\">return</span><span class=\"\"> </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">FieldDescriptor</span><span class=\"br0\">(</span><span class=\"\">name, type</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">  </span><span class=\"br0\">}</span></li></ol><pre style=\"display: none;\">        public FieldDescriptor VisitDefinition(DefinitionContext context)\n\t{\n\t\tstring name = context.name().NAME().GetText();\n\t\tTypeDescriptor type;\n\t\t\n\t\tswitch(context.type().GetType().Name)\n\t\t{\n\t\t\tcase \"IntegerTypeContext\":\n\t\t\t\ttype = VisitIntegerType(context.type() as IntegerTypeContext);\n\t\t\t\tbreak;\n\t\t\tcase \"SmallIntegerTypeContext\":\n\t\t\t\ttype = VisitSmallIntegerType(context.type() as SmallIntegerTypeContext);\n\t\t\t\tbreak;\n\t\t\tcase \"VarcharTypeContext\":\n\t\t\t\ttype = VisitVarcharType(context.type() as VarcharTypeContext);\n\t\t\t\tbreak;\n\t\t\tcase \"TimestampTypeContext\":\n\t\t\t\ttype = VisitTimestampType(context.type() as TimestampTypeContext);\n\t\t\t\tbreak;\n\t\t\tcase \"TextTypeContext\":\n\t\t\t\ttype = VisitTextType(context.type() as TextTypeContext);\n\t\t\t\tbreak;               \n\t\t\tcase \"DecimalTypeContext\":\n\t\t\t\ttype = VisitDecimalType(context.type() as DecimalTypeContext);\n\t\t\t\tbreak;  \n\t\t\tcase \"CharTypeContext\":\n\t\t\t\ttype = VisitCharType(context.type() as CharTypeContext);\n\t\t\t\tbreak; \n\t\t\tcase \"BlobTypeContext\":\n\t\t\t\ttype = VisitBlobType(context.type() as BlobTypeContext);\n\t\t\t\tbreak; \n\t\t\tdefault:\n\t\t\t\ttype = null;\n\t\t\t\tbreak;\n\t\t}\n\t\t\n\t\tif(context.nullability() != null &amp;&amp; context.nullability().NOT() != null)\n\t\t\ttype.Nullability = false;\n\t\n\t\treturn new FieldDescriptor(name, type);\n\t}</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>The issue is that we need to identify each type and then translate it in a way that is compatible with a programming language. In fact, SQL data types and programming language data types can be different. For example, SQL has types for variable and fixed size char array, this is less relevant in programming languages.</p><p>We already have done the work to easily identify each type by creating a label for each option of the <code>type</code> grammar rule. Now, we just need to use a different method to visit each node correctly.</p><p>Before seeing the examples of <code>VisitIntegerType</code> and <code>VisitSmallIntegerType</code>, let’s notice a couple of things. First, we deal with nullability of types only once, on lines 37-38. Second, we are only dealing with some types, the ones used in our example SQL files.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"csharp\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">        private TypeDescriptor VisitSmallIntegerType(SmallIntegerTypeContext context)\n        {\n           if(context.UNSIGNED() != null)\n                return new IntegerTypeDescriptor(2, true);\n            else\n                return new IntegerTypeDescriptor(2);\n        }\n\n        private TypeDescriptor VisitIntegerType(IntegerTypeContext context)\n        {\n            if(context.UNSIGNED() != null)\n                return new IntegerTypeDescriptor(4, true);\n            else\n                return new IntegerTypeDescriptor(4);\n        }</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"\">        </span><span class=\"kw1\">private</span><span class=\"\"> TypeDescriptor </span><span class=\"me0\">VisitSmallIntegerType</span><span class=\"br0\">(</span><span class=\"\">SmallIntegerTypeContext context</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">           </span><span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"\">context.</span><span class=\"me0\">UNSIGNED</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\"> != </span><span class=\"kw1\">null</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                </span><span class=\"kw1\">return</span><span class=\"\"> </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">IntegerTypeDescriptor</span><span class=\"br0\">(</span><span class=\"nu0\">2</span><span class=\"\">, </span><span class=\"kw1\">true</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">            </span><span class=\"kw1\">else</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                </span><span class=\"kw1\">return</span><span class=\"\"> </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">IntegerTypeDescriptor</span><span class=\"br0\">(</span><span class=\"nu0\">2</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"kw1\">private</span><span class=\"\"> TypeDescriptor </span><span class=\"me0\">VisitIntegerType</span><span class=\"br0\">(</span><span class=\"\">IntegerTypeContext context</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">            </span><span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"\">context.</span><span class=\"me0\">UNSIGNED</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\"> != </span><span class=\"kw1\">null</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                </span><span class=\"kw1\">return</span><span class=\"\"> </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">IntegerTypeDescriptor</span><span class=\"br0\">(</span><span class=\"nu0\">4</span><span class=\"\">, </span><span class=\"kw1\">true</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">            </span><span class=\"kw1\">else</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                </span><span class=\"kw1\">return</span><span class=\"\"> </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">IntegerTypeDescriptor</span><span class=\"br0\">(</span><span class=\"nu0\">4</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"br0\">}</span></li></ol><pre style=\"display: none;\">        private TypeDescriptor VisitSmallIntegerType(SmallIntegerTypeContext context)\n        {\n           if(context.UNSIGNED() != null)\n                return new IntegerTypeDescriptor(2, true);\n            else\n                return new IntegerTypeDescriptor(2);\n        }\n\n        private TypeDescriptor VisitIntegerType(IntegerTypeContext context)\n        {\n            if(context.UNSIGNED() != null)\n                return new IntegerTypeDescriptor(4, true);\n            else\n                return new IntegerTypeDescriptor(4);\n        }</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>These two methods are representative of the little effort we have to do. Each method returns a <code>TypeDescriptor</code> specific for each type.</p><p>The methods are simple, but different because each type is different. In the case of integer types we need to check whether the type is unsigned or not. We use only one <code>IntegerTypeDescriptor</code> for all integer types. This is simply because they can be described in the same way: from our point of view, the only difference between integer types is the number of bytes they need.</p><p>The <code>TypeDescriptor</code> classes themselves are also fairly trivial. They just are a series of classes that contain specific information for each type.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"csharp\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">public enum BaseType\n{\n    Integer,\n    Floating,    \n    Decimal,           \n    Text,\n    Binary,\n    ArrayCharacters,        \n    Year,\n    DateTime\n}\n\npublic class TypeDescriptor\n{\n    public BaseType Type { get; protected set; }\n    public bool Nullability { get; set; } = true;\n}\n\npublic class IntegerTypeDescriptor : TypeDescriptor\n{\n    public int Bytes { get; private set; }\n    public bool Unsigned { get; private set;  }\n\n    public IntegerTypeDescriptor(int bytes, bool unsigned = false)\n    {\n        Type = BaseType.Integer;\n        Bytes = bytes;\n        Unsigned = unsigned;\n    }\n}</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"kw1\">public</span><span class=\"\"> </span><span class=\"kw2\">enum</span><span class=\"\"> BaseType</span></li><li class=\" even\"><span class=\"\"></span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    Integer,</span></li><li class=\" even\"><span class=\"\">    Floating,    </span></li><li class=\" odd\"><span class=\"\">    Decimal,           </span></li><li class=\" even\"><span class=\"\">    Text,</span></li><li class=\" odd\"><span class=\"\">    Binary,</span></li><li class=\" even\"><span class=\"\">    ArrayCharacters,        </span></li><li class=\" odd\"><span class=\"\">    Year,</span></li><li class=\" even\"><span class=\"\">    DateTime</span></li><li class=\" odd\"><span class=\"\"></span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\"></span><span class=\"kw1\">public</span><span class=\"\"> </span><span class=\"kw3\">class</span><span class=\"\"> TypeDescriptor</span></li><li class=\" even\"><span class=\"\"></span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    </span><span class=\"kw1\">public</span><span class=\"\"> BaseType Type </span><span class=\"br0\">{</span><span class=\"\"> get; </span><span class=\"kw1\">protected</span><span class=\"\"> set; </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">    </span><span class=\"kw1\">public</span><span class=\"\"> </span><span class=\"kw2\">bool</span><span class=\"\"> Nullability </span><span class=\"br0\">{</span><span class=\"\"> get; set; </span><span class=\"br0\">}</span><span class=\"\"> = </span><span class=\"kw1\">true</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\"></span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\"></span><span class=\"kw1\">public</span><span class=\"\"> </span><span class=\"kw3\">class</span><span class=\"\"> IntegerTypeDescriptor : TypeDescriptor</span></li><li class=\" even\"><span class=\"\"></span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    </span><span class=\"kw1\">public</span><span class=\"\"> </span><span class=\"kw2\">int</span><span class=\"\"> Bytes </span><span class=\"br0\">{</span><span class=\"\"> get; </span><span class=\"kw1\">private</span><span class=\"\"> set; </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">    </span><span class=\"kw1\">public</span><span class=\"\"> </span><span class=\"kw2\">bool</span><span class=\"\"> Unsigned </span><span class=\"br0\">{</span><span class=\"\"> get; </span><span class=\"kw1\">private</span><span class=\"\"> set;  </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\"></span></li><li class=\" even\"><span class=\"\">    </span><span class=\"kw1\">public</span><span class=\"\"> </span><span class=\"me0\">IntegerTypeDescriptor</span><span class=\"br0\">(</span><span class=\"kw2\">int</span><span class=\"\"> bytes, </span><span class=\"kw2\">bool</span><span class=\"\"> unsigned = </span><span class=\"kw1\">false</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        Type = BaseType.Integer;</span></li><li class=\" odd\"><span class=\"\">        Bytes = bytes;</span></li><li class=\" even\"><span class=\"\">        Unsigned = unsigned;</span></li><li class=\" odd\"><span class=\"\">    </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\"></span><span class=\"br0\">}</span></li></ol><pre style=\"display: none;\">public enum BaseType\n{\n    Integer,\n    Floating,    \n    Decimal,           \n    Text,\n    Binary,\n    ArrayCharacters,        \n    Year,\n    DateTime\n}\n\npublic class TypeDescriptor\n{\n    public BaseType Type { get; protected set; }\n    public bool Nullability { get; set; } = true;\n}\n\npublic class IntegerTypeDescriptor : TypeDescriptor\n{\n    public int Bytes { get; private set; }\n    public bool Unsigned { get; private set;  }\n\n    public IntegerTypeDescriptor(int bytes, bool unsigned = false)\n    {\n        Type = BaseType.Integer;\n        Bytes = bytes;\n        Unsigned = unsigned;\n    }\n}</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>You can see the rest on the companion repository.</p><h2>Generating Code</h2><p>We have a custom representation of our original SQL code: a description of all the tables suited for our needs. Now we can generate the corresponding source code. We are going to generate the code in multiple languages: C# and Kotlin. We do this to show how easy it is to do anything once we get the information out of SQL and because there are different limitations in the two languages.</p><h3>Generating Code in C#</h3><p>Let’s start with seeing C#. We have only one public method: <code>ToSourceCode</code>, which accepts a namespace and a series of classes/tables definition.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"csharp\" data-enlighter-theme=\"\" data-enlighter-highlight=\"23-24, 32-33\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">public class CSharpCodeGenerator : ICodeGenerator\n{\n    public string ToSourceCode(string idNamespace, List&lt;ClassDescriptor&gt; classes)\n    {\n        StringBuilder sourceCode = new StringBuilder();\n\n        // opening namespace\n        sourceCode.AppendLine($\"namespace {idNamespace}\");\n        sourceCode.AppendLine(\"{\");\n        \n        foreach(var c in classes)\n        {\n            sourceCode.AppendLine($\"\\tpublic class {c.Name}\");\n            sourceCode.AppendLine(\"\\t{\");\n            \n            foreach(var f in c.Fields)\n            {\n                switch(f.Type.Type)\n                {\n                    case BaseType.Integer:\n                        sourceCode.AppendLine($\"\\t\\tpublic {GenerateInt(f.Type as IntegerTypeDescriptor)} {f.Name} {{ get; set; }}\");\n                        break;\n                    case BaseType.Text:\n                        sourceCode.AppendLine($\"\\t\\tpublic string {f.Name} {{ get; set; }}\");\n                        break;\n                    case BaseType.ArrayCharacters:\n                        sourceCode.AppendLine($\"\\t\\tpublic {GenerateCharArray(f.Name, f.Type as CharArrayTypeDescriptor)}\");\n                        break;\n                    case BaseType.DateTime:\n                        sourceCode.AppendLine($\"\\t\\tpublic DateTime {f.Name} {{ get; set; }}\");\n                        break;                            \n                    case BaseType.Decimal:                        \n                        sourceCode.AppendLine($\"\\t\\tpublic decimal {f.Name} {{ get; set; }}\");\n                        break;\n                    case BaseType.Binary:\n                        sourceCode.AppendLine($\"\\t\\tpublic bytes[] {f.Name} {{ get; set; }}\");\n                        break;\n                }\n            }\n            \n            sourceCode.AppendLine(\"\\t}\");\n            sourceCode.AppendLine();\n        }\n\n        // closing namespace            \n        sourceCode.AppendLine(\"}\");\n\n        return sourceCode.ToString();\n    }\n\n    [..]</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"kw1\">public</span><span class=\"\"> </span><span class=\"kw3\">class</span><span class=\"\"> CSharpCodeGenerator : ICodeGenerator</span></li><li class=\" even\"><span class=\"\"></span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    </span><span class=\"kw1\">public</span><span class=\"\"> </span><span class=\"kw2\">string</span><span class=\"\"> </span><span class=\"me0\">ToSourceCode</span><span class=\"br0\">(</span><span class=\"kw2\">string</span><span class=\"\"> idNamespace, List&lt;ClassDescriptor&gt; classes</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">    </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">        StringBuilder sourceCode = </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">StringBuilder</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">       </span><span class=\"co1\"> // opening namespace</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"namespace {idNamespace}\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">        sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"st1\">\"{\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">        </span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"kw1\">foreach</span><span class=\"br0\">(</span><span class=\"\">var c </span><span class=\"kw3\">in</span><span class=\"\"> classes</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">            sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"\\tpublic class {c.Name}\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">            sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"st1\">\"\\t{\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">            </span></li><li class=\" even\"><span class=\"\">            </span><span class=\"kw1\">foreach</span><span class=\"br0\">(</span><span class=\"\">var f </span><span class=\"kw3\">in</span><span class=\"\"> c.Fields</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">            </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                </span><span class=\"kw1\">switch</span><span class=\"br0\">(</span><span class=\"\">f.Type.Type</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">                </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                    </span><span class=\"kw1\">case</span><span class=\"\"> BaseType.Integer:</span></li><li class=\" odd\"><span class=\"\">                        sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"\\t\\tpublic {GenerateInt(f.Type as IntegerTypeDescriptor)} {f.Name} {{ get; set; }}\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                        </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\"specialline odd\"><span class=\"\">                    </span><span class=\"kw1\">case</span><span class=\"\"> BaseType.Text:</span></li><li class=\"specialline even\"><span class=\"\">                        sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"\\t\\tpublic string {f.Name} {{ get; set; }}\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                        </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                    </span><span class=\"kw1\">case</span><span class=\"\"> BaseType.ArrayCharacters:</span></li><li class=\" odd\"><span class=\"\">                        sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"\\t\\tpublic {GenerateCharArray(f.Name, f.Type as CharArrayTypeDescriptor)}\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                        </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                    </span><span class=\"kw1\">case</span><span class=\"\"> BaseType.DateTime:</span></li><li class=\" even\"><span class=\"\">                        sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"\\t\\tpublic DateTime {f.Name} {{ get; set; }}\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                        </span><span class=\"kw1\">break</span><span class=\"\">;                            </span></li><li class=\"specialline even\"><span class=\"\">                    </span><span class=\"kw1\">case</span><span class=\"\"> BaseType.Decimal:                        </span></li><li class=\"specialline odd\"><span class=\"\">                        sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"\\t\\tpublic decimal {f.Name} {{ get; set; }}\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                        </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                    </span><span class=\"kw1\">case</span><span class=\"\"> BaseType.Binary:</span></li><li class=\" even\"><span class=\"\">                        sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"\\t\\tpublic bytes[] {f.Name} {{ get; set; }}\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                        </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">            </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">            </span></li><li class=\" odd\"><span class=\"\">            sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"st1\">\"\\t}\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">            sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">       </span><span class=\"co1\"> // closing namespace            </span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"st1\">\"}\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        </span><span class=\"kw1\">return</span><span class=\"\"> sourceCode.</span><span class=\"me0\">ToString</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">    </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">    </span><span class=\"br0\">[</span><span class=\"\">..</span><span class=\"br0\">]</span></li></ol><pre style=\"display: none;\">public class CSharpCodeGenerator : ICodeGenerator\n{\n    public string ToSourceCode(string idNamespace, List&lt;ClassDescriptor&gt; classes)\n    {\n        StringBuilder sourceCode = new StringBuilder();\n\n        // opening namespace\n        sourceCode.AppendLine($\"namespace {idNamespace}\");\n        sourceCode.AppendLine(\"{\");\n        \n        foreach(var c in classes)\n        {\n            sourceCode.AppendLine($\"\\tpublic class {c.Name}\");\n            sourceCode.AppendLine(\"\\t{\");\n            \n            foreach(var f in c.Fields)\n            {\n                switch(f.Type.Type)\n                {\n                    case BaseType.Integer:\n                        sourceCode.AppendLine($\"\\t\\tpublic {GenerateInt(f.Type as IntegerTypeDescriptor)} {f.Name} {{ get; set; }}\");\n                        break;\n                    case BaseType.Text:\n                        sourceCode.AppendLine($\"\\t\\tpublic string {f.Name} {{ get; set; }}\");\n                        break;\n                    case BaseType.ArrayCharacters:\n                        sourceCode.AppendLine($\"\\t\\tpublic {GenerateCharArray(f.Name, f.Type as CharArrayTypeDescriptor)}\");\n                        break;\n                    case BaseType.DateTime:\n                        sourceCode.AppendLine($\"\\t\\tpublic DateTime {f.Name} {{ get; set; }}\");\n                        break;                            \n                    case BaseType.Decimal:                        \n                        sourceCode.AppendLine($\"\\t\\tpublic decimal {f.Name} {{ get; set; }}\");\n                        break;\n                    case BaseType.Binary:\n                        sourceCode.AppendLine($\"\\t\\tpublic bytes[] {f.Name} {{ get; set; }}\");\n                        break;\n                }\n            }\n            \n            sourceCode.AppendLine(\"\\t}\");\n            sourceCode.AppendLine();\n        }\n\n        // closing namespace            \n        sourceCode.AppendLine(\"}\");\n\n        return sourceCode.ToString();\n    }\n\n    [..]</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>This method takes care of generating the whole new source code file. It handles the enclosing namespace (necessary for C# files) and the whole class.</p><p>We transform columns into properties. These are the obvious choice because it is easy to anticipate that we would need to transform any data coming from SQL in a different format to handle it in our programming language. For example, dates would be different. We would also need to enforce fixed-size arrays in some way. That is because programming languages usually do not have a well-defined way to handle an input too large or too small. Instead databases can automatically do things like padding an input that is too short with spaces.</p><p>There are generally three cases:</p><ul><li>the type has a perfect correspondence (e.g. lines 23-24 <code>TEXT</code> becomes a <code>String</code>). So we just write the property directly.</li><li>the type has only a partial, but unambiguous, correspondence (e.g. lines 32-33 DECIMAL becomes <code>Decimal</code>, but the SQL and C# type behave differently). For example, a SQL decimal allows us to specify a precision, to set just how many digits it can hold. In C# you cannot do that. Normally we would need to take care of this difference, in our example, we just ignore the issue</li><li>the type has multiple correspondences (e.g., lines 20-21 <code>INT</code>, <code>SMALLINT</code> become <code>int</code>, <code>short</code>), so we handle them with a method</li></ul><p>For the third case, we are going to see the integer example.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"csharp\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">        private string GenerateInt(IntegerTypeDescriptor descriptor)\n        {\n            StringBuilder intType = new StringBuilder();\n\n            // we ignore nullability, because it is not well supported for all C# types\n            if(descriptor.Unsigned == true)\n                intType.Append(\"u\");\n\n            switch(descriptor.Bytes)\n            {\n                case 2:\n                    intType.Append(\"short\");\n                    break;\n                case 4:\n                    intType.Append(\"int\");\n                    break;\n                case 8:\n                    intType.Append(\"long\");\n                    break;\n            }\n           \n            return intType.ToString();\n        }</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"\">        </span><span class=\"kw1\">private</span><span class=\"\"> </span><span class=\"kw2\">string</span><span class=\"\"> </span><span class=\"me0\">GenerateInt</span><span class=\"br0\">(</span><span class=\"\">IntegerTypeDescriptor descriptor</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">            StringBuilder intType = </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">StringBuilder</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">           </span><span class=\"co1\"> // we ignore nullability, because it is not well supported for all C# types</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">            </span><span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"\">descriptor.Unsigned == </span><span class=\"kw1\">true</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">                intType.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"st1\">\"u\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">            </span><span class=\"kw1\">switch</span><span class=\"br0\">(</span><span class=\"\">descriptor.Bytes</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">            </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">                </span><span class=\"kw1\">case</span><span class=\"\"> </span><span class=\"nu0\">2</span><span class=\"\">:</span></li><li class=\" even\"><span class=\"\">                    intType.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"st1\">\"short\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                    </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                </span><span class=\"kw1\">case</span><span class=\"\"> </span><span class=\"nu0\">4</span><span class=\"\">:</span></li><li class=\" odd\"><span class=\"\">                    intType.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"st1\">\"int\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                    </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                </span><span class=\"kw1\">case</span><span class=\"\"> </span><span class=\"nu0\">8</span><span class=\"\">:</span></li><li class=\" even\"><span class=\"\">                    intType.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"st1\">\"long\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                    </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">            </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">           </span></li><li class=\" even\"><span class=\"\">            </span><span class=\"kw1\">return</span><span class=\"\"> intType.</span><span class=\"me0\">ToString</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"br0\">}</span></li></ol><pre style=\"display: none;\">        private string GenerateInt(IntegerTypeDescriptor descriptor)\n        {\n            StringBuilder intType = new StringBuilder();\n\n            // we ignore nullability, because it is not well supported for all C# types\n            if(descriptor.Unsigned == true)\n                intType.Append(\"u\");\n\n            switch(descriptor.Bytes)\n            {\n                case 2:\n                    intType.Append(\"short\");\n                    break;\n                case 4:\n                    intType.Append(\"int\");\n                    break;\n                case 8:\n                    intType.Append(\"long\");\n                    break;\n            }\n           \n            return intType.ToString();\n        }</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>We can find a perfect correspondence between each integer type in SQL and C#. Since integer types are all represented internally the same way, it all depends on the number of bytes used for each of them. Depending on how many bytes are stored in our instance of <code>IntegerTypeDescriptor</code>, we generate the proper C# type.</p><p>The only issue is with C# itself: it does not have perfect support for nullability. Until <a href=\"https://docs.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-8#nullable-reference-types\">C# 8.0</a> reference types could be nullable by default, so it would be fairly inconsistent to work with nullable types both in our code and any third-party code.</p><p>On the other hand, we can easily deal with unsigned integers, we just need to prepend a <code>u</code>, to use unsigned types.</p><h3>Generating Code in Kotlin</h3><p>Generating the code for Kotlin is very similar.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"csharp\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">public class KotlinCodeGenerator : ICodeGenerator\n{\n        public string ToSourceCode(string idNamespace, List&lt;ClassDescriptor&gt; classes)\n        {\n            StringBuilder sourceCode = new StringBuilder();\n\n            // declaring package\n            if(!String.IsNullOrEmpty(idNamespace))\n                sourceCode.AppendLine($\"package {idNamespace}\");   \n\n            // adding imports\n            sourceCode.AppendLine();\n            sourceCode.AppendLine(\"import java.time.LocalDateTime\");\n            sourceCode.AppendLine(\"import java.math.BigDecimal\");            \n            sourceCode.AppendLine();\n            \n            foreach(var c in classes)\n            {\n                sourceCode.Append($\"data class {c.Name}(\");\n                \n                foreach(var f in c.Fields)\n                {\n                    switch(f.Type.Type)\n                    {\n                        case BaseType.Integer:\n                            sourceCode.Append($\"var {f.Name}: {GenerateInt(f.Type as IntegerTypeDescriptor)}\");\n                            break;\n                        case BaseType.Text:\n                            sourceCode.Append($\"var {f.Name}: String\");\n                            break;\n                        case BaseType.ArrayCharacters:\n                            sourceCode.Append($\"var {f.Name}: {GenerateCharArray(f.Type as CharArrayTypeDescriptor)}\");\n                            break;\n                        case BaseType.DateTime:\n                            sourceCode.Append($\"var {f.Name}: LocalDateTime\");\n                            break;                            \n                        case BaseType.Decimal:                        \n                            sourceCode.Append($\"var {f.Name}: BigDecimal\");\n                            break;\n                        case BaseType.Binary:\n                            sourceCode.Append($\"var {f.Name}: ByteArray\");\n                            break;\n                    }                    \n                    \n                    if(f != c.Fields.Last())\n                        sourceCode.Append(\", \");\n                }\n                \n                sourceCode.AppendLine(\")\");\n                sourceCode.AppendLine(\"\");\n            }\n\n            return sourceCode.ToString();\n        }</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"kw1\">public</span><span class=\"\"> </span><span class=\"kw3\">class</span><span class=\"\"> KotlinCodeGenerator : ICodeGenerator</span></li><li class=\" even\"><span class=\"\"></span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"kw1\">public</span><span class=\"\"> </span><span class=\"kw2\">string</span><span class=\"\"> </span><span class=\"me0\">ToSourceCode</span><span class=\"br0\">(</span><span class=\"kw2\">string</span><span class=\"\"> idNamespace, List&lt;ClassDescriptor&gt; classes</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">            StringBuilder sourceCode = </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">StringBuilder</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">           </span><span class=\"co1\"> // declaring package</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">            </span><span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"\">!String.</span><span class=\"me0\">IsNullOrEmpty</span><span class=\"br0\">(</span><span class=\"\">idNamespace</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">                sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"package {idNamespace}\"</span><span class=\"br0\">)</span><span class=\"\">;   </span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">           </span><span class=\"co1\"> // adding imports</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">            sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">            sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"st1\">\"import java.time.LocalDateTime\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">            sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"st1\">\"import java.math.BigDecimal\"</span><span class=\"br0\">)</span><span class=\"\">;            </span></li><li class=\" odd\"><span class=\"\">            sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">            </span></li><li class=\" odd\"><span class=\"\">            </span><span class=\"kw1\">foreach</span><span class=\"br0\">(</span><span class=\"\">var c </span><span class=\"kw3\">in</span><span class=\"\"> classes</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">            </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">                sourceCode.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"data class {c.Name}(\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                </span></li><li class=\" odd\"><span class=\"\">                </span><span class=\"kw1\">foreach</span><span class=\"br0\">(</span><span class=\"\">var f </span><span class=\"kw3\">in</span><span class=\"\"> c.Fields</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">                    </span><span class=\"kw1\">switch</span><span class=\"br0\">(</span><span class=\"\">f.Type.Type</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                    </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">                        </span><span class=\"kw1\">case</span><span class=\"\"> BaseType.Integer:</span></li><li class=\" even\"><span class=\"\">                            sourceCode.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"var {f.Name}: {GenerateInt(f.Type as IntegerTypeDescriptor)}\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                            </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                        </span><span class=\"kw1\">case</span><span class=\"\"> BaseType.Text:</span></li><li class=\" odd\"><span class=\"\">                            sourceCode.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"var {f.Name}: String\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                            </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                        </span><span class=\"kw1\">case</span><span class=\"\"> BaseType.ArrayCharacters:</span></li><li class=\" even\"><span class=\"\">                            sourceCode.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"var {f.Name}: {GenerateCharArray(f.Type as CharArrayTypeDescriptor)}\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                            </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                        </span><span class=\"kw1\">case</span><span class=\"\"> BaseType.DateTime:</span></li><li class=\" odd\"><span class=\"\">                            sourceCode.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"var {f.Name}: LocalDateTime\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                            </span><span class=\"kw1\">break</span><span class=\"\">;                            </span></li><li class=\" odd\"><span class=\"\">                        </span><span class=\"kw1\">case</span><span class=\"\"> BaseType.Decimal:                        </span></li><li class=\" even\"><span class=\"\">                            sourceCode.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"var {f.Name}: BigDecimal\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                            </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                        </span><span class=\"kw1\">case</span><span class=\"\"> BaseType.Binary:</span></li><li class=\" odd\"><span class=\"\">                            sourceCode.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"\">$</span><span class=\"st1\">\"var {f.Name}: ByteArray\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                            </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                    </span><span class=\"br0\">}</span><span class=\"\">                    </span></li><li class=\" even\"><span class=\"\">                    </span></li><li class=\" odd\"><span class=\"\">                    </span><span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"\">f != c.Fields.</span><span class=\"me0\">Last</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                        sourceCode.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"st1\">\", \"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                </span></li><li class=\" odd\"><span class=\"\">                sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"st1\">\")\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                sourceCode.</span><span class=\"me0\">AppendLine</span><span class=\"br0\">(</span><span class=\"st1\">\"\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">            </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">            </span><span class=\"kw1\">return</span><span class=\"\"> sourceCode.</span><span class=\"me0\">ToString</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">        </span><span class=\"br0\">}</span></li></ol><pre style=\"display: none;\">public class KotlinCodeGenerator : ICodeGenerator\n{\n        public string ToSourceCode(string idNamespace, List&lt;ClassDescriptor&gt; classes)\n        {\n            StringBuilder sourceCode = new StringBuilder();\n\n            // declaring package\n            if(!String.IsNullOrEmpty(idNamespace))\n                sourceCode.AppendLine($\"package {idNamespace}\");   \n\n            // adding imports\n            sourceCode.AppendLine();\n            sourceCode.AppendLine(\"import java.time.LocalDateTime\");\n            sourceCode.AppendLine(\"import java.math.BigDecimal\");            \n            sourceCode.AppendLine();\n            \n            foreach(var c in classes)\n            {\n                sourceCode.Append($\"data class {c.Name}(\");\n                \n                foreach(var f in c.Fields)\n                {\n                    switch(f.Type.Type)\n                    {\n                        case BaseType.Integer:\n                            sourceCode.Append($\"var {f.Name}: {GenerateInt(f.Type as IntegerTypeDescriptor)}\");\n                            break;\n                        case BaseType.Text:\n                            sourceCode.Append($\"var {f.Name}: String\");\n                            break;\n                        case BaseType.ArrayCharacters:\n                            sourceCode.Append($\"var {f.Name}: {GenerateCharArray(f.Type as CharArrayTypeDescriptor)}\");\n                            break;\n                        case BaseType.DateTime:\n                            sourceCode.Append($\"var {f.Name}: LocalDateTime\");\n                            break;                            \n                        case BaseType.Decimal:                        \n                            sourceCode.Append($\"var {f.Name}: BigDecimal\");\n                            break;\n                        case BaseType.Binary:\n                            sourceCode.Append($\"var {f.Name}: ByteArray\");\n                            break;\n                    }                    \n                    \n                    if(f != c.Fields.Last())\n                        sourceCode.Append(\", \");\n                }\n                \n                sourceCode.AppendLine(\")\");\n                sourceCode.AppendLine(\"\");\n            }\n\n            return sourceCode.ToString();\n        }</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>There are no structural differences. The only variations depend on the differences between the languages themselves. For instance, the equivalent of a namespace, i.e., packages are not required in Kotlin. We can also use the special <a href=\"https://superkotlin.com/kotlin-mega-tutorial/#data-classes\">data classes</a> in Kotlin to quickly define a class with its properties directly in the default constructor.</p><p>On the other hand, we need to import some Java packages, because Kotlin does not directly have classes for DateTime types. Since Kotlin can run in different environments (i.e. JVM with Java support, JavaScript, native with C++ support), we should probably find a way to support all of these environments. In a normal situation, we would probably create a runtime in pure Kotlin with these custom types (i.e., KotlinDateTime) and then add support for each platform in separate files. This way we could just generate one Kotlin file for all environments. This would be overkill for this example, so we just consider Kotlin run in Java.</p><pre class=\"EnlighterJSRAW\" data-enlighter-language=\"csharp\" data-enlighter-theme=\"\" data-enlighter-highlight=\"\" data-enlighter-linenumbers=\"\" data-enlighter-lineoffset=\"\" data-enlighter-title=\"\" data-enlighter-group=\"\" style=\"display: none;\">\tprivate string GenerateInt(IntegerTypeDescriptor descriptor)\n        {\n            StringBuilder intType = new StringBuilder();            \n\n            switch(descriptor.Bytes)\n            {\n                case 2:\n                    intType.Append(\"Short\");\n                    break;\n                case 4:\n                    intType.Append(\"Int\");\n                    break;\n                case 8:\n                    intType.Append(\"Long\");\n                    break;\n            }\n\n            // we ignore unsigned, because it is not well supported in C#\n            if(descriptor.Nullability == true)\n                intType.Append(\"?\");\n           \n            return intType.ToString();\n        }</pre><div class=\"EnlighterJSWrapper enlighterEnlighterJSWrapper\"><ol class=\"hoverEnabled enlighterEnlighterJS EnlighterJS\"><li class=\" odd\"><span class=\"\">  </span><span class=\"kw1\">private</span><span class=\"\"> </span><span class=\"kw2\">string</span><span class=\"\"> </span><span class=\"me0\">GenerateInt</span><span class=\"br0\">(</span><span class=\"\">IntegerTypeDescriptor descriptor</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">        </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">            StringBuilder intType = </span><span class=\"kw1\">new</span><span class=\"\"> </span><span class=\"me0\">StringBuilder</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;            </span></li><li class=\" even\"><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">            </span><span class=\"kw1\">switch</span><span class=\"br0\">(</span><span class=\"\">descriptor.Bytes</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">            </span><span class=\"br0\">{</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">                </span><span class=\"kw1\">case</span><span class=\"\"> </span><span class=\"nu0\">2</span><span class=\"\">:</span></li><li class=\" even\"><span class=\"\">                    intType.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"st1\">\"Short\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                    </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                </span><span class=\"kw1\">case</span><span class=\"\"> </span><span class=\"nu0\">4</span><span class=\"\">:</span></li><li class=\" odd\"><span class=\"\">                    intType.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"st1\">\"Int\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">                    </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                </span><span class=\"kw1\">case</span><span class=\"\"> </span><span class=\"nu0\">8</span><span class=\"\">:</span></li><li class=\" even\"><span class=\"\">                    intType.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"st1\">\"Long\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">                    </span><span class=\"kw1\">break</span><span class=\"\">;</span></li><li class=\" even\"><span class=\"\">            </span><span class=\"br0\">}</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\"></span></li><li class=\" even\"><span class=\"\">           </span><span class=\"co1\"> // we ignore unsigned, because it is not well supported in C#</span><span class=\"\"></span></li><li class=\" odd\"><span class=\"\">            </span><span class=\"kw1\">if</span><span class=\"br0\">(</span><span class=\"\">descriptor.Nullability == </span><span class=\"kw1\">true</span><span class=\"br0\">)</span><span class=\"\"></span></li><li class=\" even\"><span class=\"\">                intType.</span><span class=\"me0\">Append</span><span class=\"br0\">(</span><span class=\"st1\">\"?\"</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">           </span></li><li class=\" even\"><span class=\"\">            </span><span class=\"kw1\">return</span><span class=\"\"> intType.</span><span class=\"me0\">ToString</span><span class=\"br0\">(</span><span class=\"br0\">)</span><span class=\"\">;</span></li><li class=\" odd\"><span class=\"\">        </span><span class=\"br0\">}</span></li></ol><pre style=\"display: none;\">\tprivate string GenerateInt(IntegerTypeDescriptor descriptor)\n        {\n            StringBuilder intType = new StringBuilder();            \n\n            switch(descriptor.Bytes)\n            {\n                case 2:\n                    intType.Append(\"Short\");\n                    break;\n                case 4:\n                    intType.Append(\"Int\");\n                    break;\n                case 8:\n                    intType.Append(\"Long\");\n                    break;\n            }\n\n            // we ignore unsigned, because it is not well supported in C#\n            if(descriptor.Nullability == true)\n                intType.Append(\"?\");\n           \n            return intType.ToString();\n        }</pre><div class=\"EnlighterJSToolbar\"><a class=\"EnlighterJSInfoButton\" title=\"EnlighterJS Syntax Highlighter\"></a><a class=\"EnlighterJSRawButton\" title=\"Toggle RAW Code\"></a><a class=\"EnlighterJSWindowButton\" title=\"Open Code in new Window\"></a><span class=\"clear\"></span></div></div><p>We can also see that the methods to generate integral types are very similar in both C# and Kotlin. The difference is that with Kotlin nullability has always been supported, while support for unsigned integer is still experimental for the current version.</p><h2>Summary</h2><p>In this article, we have seen how to parse SQL. In general, our advice is to:</p><ol><li>Consider if you can use existing tools or libraries to process SQL code. Some of them even support multiple SQL-dialects or multiple programming languages. If you can use any of them for your needs they should be your first option</li><li>If you want to build a solution in-house you may consider starting from the few ANTLR grammars available for the major SQL databases. They can really help you get started in parsing SQL</li><li>If you are stuck with a less common SQL database you might be in trouble. Parsing SQL from scratch it is going to be hard work: the language has a fairly simple structure, but it is large, it has many variations and in some cases even procedural extensions. In this article, we have seen a few tricks to start parsing even with a partial grammar. This can be a good way if you need to parse only small parts of the language</li></ol><p>If none of these options work for you, and you need some commercial option supporting you in building a solution for your needs, we at <a href=\"https://strumenta.com/\">Strumenta</a> may be able to help.</p> <script src=\"https://cdn.convertkit.com/assets/CKJS4.js?v=21\" defer=\"\"></script> <div class=\"ck_form_container ck_inline\" data-ck-version=\"6\"><div class=\"ck_form ck_vertical_subscription_form\"><div class=\"ck_form_content\"><h3 class=\"ck_form_title\">Download the guide with 68 resources on Creating Programming Languages</h3><div class=\"ck_description\"> <span class=\"ck_image\"> <img src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%200%200'%3E%3C/svg%3E\" alt=\"68resources\" data-lazy-src=\"https://convertkit.s3.amazonaws.com/subscription_forms/images/005/010/568/standard/68resources.jpg?1492612538\"><noscript><img src=\"https://convertkit.s3.amazonaws.com/subscription_forms/images/005/010/568/standard/68resources.jpg?1492612538\" alt=\"68resources\" /></noscript> </span><p>Receive the guide to your inbox to read it on all your devices when you have time</p></div></div><div class=\"ck_form_fields\"><div id=\"ck_success_msg\" style=\"display:none;\"><p>Success! Now check your email to confirm your subscription.</p></div><form id=\"ck_subscribe_form\" class=\"ck_subscribe_form\" action=\"https://forms.convertkit.com/landing_pages/198735/subscribe\" data-remote=\"true\"> <input type=\"hidden\" value=\"{&quot;form_style&quot;:&quot;full&quot;,&quot;embed_style&quot;:&quot;inline&quot;,&quot;embed_trigger&quot;:&quot;scroll_percentage&quot;,&quot;scroll_percentage&quot;:&quot;70&quot;,&quot;delay_seconds&quot;:&quot;10&quot;,&quot;display_position&quot;:&quot;br&quot;,&quot;display_devices&quot;:&quot;all&quot;,&quot;days_no_show&quot;:&quot;15&quot;,&quot;converted_behavior&quot;:&quot;show&quot;}\" id=\"ck_form_options\"> <input type=\"hidden\" name=\"id\" value=\"198735\" id=\"landing_page_id\"> <input type=\"hidden\" name=\"ck_form_recaptcha\" value=\"\" id=\"ck_form_recaptcha\"><div class=\"ck_errorArea\"><div id=\"ck_error_msg\" style=\"display:none\"><p>There was an error submitting your subscription. Please try again.</p></div></div><div class=\"ck_control_group ck_first_name_field_group\"> <label class=\"ck_label\" for=\"ck_firstNameField\">First Name</label> <input type=\"text\" name=\"first_name\" class=\"ck_first_name\" id=\"ck_firstNameField\"></div><div class=\"ck_control_group ck_email_field_group\"> <label class=\"ck_label\" for=\"ck_emailField\">Email Address</label> <input type=\"email\" name=\"email\" class=\"ck_email_address\" id=\"ck_emailField\" required=\"\"></div><div class=\"ck_control_group ck_captcha2_h_field_group ck-captcha2-h\" style=\"position: absolute !important;left: -999em !important;\"> <label class=\"ck_label\" for=\"ck_captcha2_h\">We use this field to detect spam bots. If you fill this in, you will be marked as a spammer.</label> <input type=\"text\" name=\"captcha2_h\" class=\"ck-captcha2-h\" id=\"ck_captcha2_h\"></div> <label class=\"ck_checkbox\" style=\"\"> <input class=\"optIn ck_course_opted\" name=\"course_opted\" type=\"checkbox\" id=\"optIn\" checked=\"\"> <span class=\"ck_opt_in_prompt\"><p>I'd like to receive the free email course.</p></span> </label> <button class=\"subscribe_button ck_subscribe_button btn fields\" id=\"ck_subscribe_button\"> Send it to me! </button> <span class=\"ck_guarantee\"> <a class=\"ck_powered_by\" href=\"https://convertkit.com?utm_source=dynamic&amp;utm_medium=referral&amp;utm_campaign=poweredby&amp;utm_content=form\">Powered by ConvertKit</a> </span></form></div></div></div><style type=\"text/css\">.ck_form{background:#fff url(data:image/gif;base64,R0lGODlhAQADAIABAMzMzP///yH/C1hNUCBEYXRhWE1QPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS41LWMwMTQgNzkuMTUxNDgxLCAyMDEzLzAzLzEzLTEyOjA5OjE1ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdFJlZj0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlUmVmIyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MUQ5NjM5RjgxQUVEMTFFNEJBQTdGNTQwMjc5MTZDOTciIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MUQ5NjM5RjkxQUVEMTFFNEJBQTdGNTQwMjc5MTZDOTciPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDoxRDk2MzlGNjFBRUQxMUU0QkFBN0Y1NDAyNzkxNkM5NyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDoxRDk2MzlGNzFBRUQxMUU0QkFBN0Y1NDAyNzkxNkM5NyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PgH//v38+/r5+Pf29fTz8vHw7+7t7Ovq6ejn5uXk4+Lh4N/e3dzb2tnY19bV1NPS0dDPzs3My8rJyMfGxcTDwsHAv769vLu6ubi3trW0s7KxsK+urayrqqmop6alpKOioaCfnp2cm5qZmJeWlZSTkpGQj46NjIuKiYiHhoWEg4KBgH9+fXx7enl4d3Z1dHNycXBvbm1sa2ppaGdmZWRjYmFgX15dXFtaWVhXVlVUU1JRUE9OTUxLSklIR0ZFRENCQUA/Pj08Ozo5ODc2NTQzMjEwLy4tLCsqKSgnJiUkIyIhIB8eHRwbGhkYFxYVFBMSERAPDg0MCwoJCAcGBQQDAgEAACH5BAEAAAEALAAAAAABAAMAAAICRFIAOw==) repeat-y center top;font-family:\"Helvetica Neue\",Helvetica,Arial,Verdana,sans-serif;line-height:1.5em;overflow:hidden;color:#666;font-size:16px;border-top:solid 20px #3071b0;border-top-color:#3071b0;border-bottom:solid 10px #3d3d3d;border-bottom-color:#1d446a;-webkit-box-shadow:0 0 5px rgba(0,0,0,.3);-moz-box-shadow:0 0 5px rgba(0,0,0,.3);box-shadow:0 0 5px rgba(0,0,0,.3);clear:both;margin:20px 0}.ck_form,.ck_form *{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}#ck_subscribe_form{clear:both}.ck_form_content,.ck_form_fields{width:50%;float:left;padding:5%}.ck_form_content{border-bottom:none}.ck_form.ck_vertical{background:#fff}.ck_vertical .ck_form_content,.ck_vertical .ck_form_fields{padding:10%;width:100%;float:none}.ck_vertical .ck_form_content{border-bottom:1px dotted #aaa;overflow:hidden}@media all and (max-width:499px){.ck_form{background:#fff}.ck_form_content,.ck_form_fields{padding:10%;width:100%;float:none}.ck_form_content{border-bottom:1px dotted #aaa}}.ck_form_content h3{margin:0 0 15px;font-size:24px;padding:0}.ck_form_content p{font-size:14px}.ck_image{float:left;margin-right:5px}.ck_errorArea{display:none}#ck_success_msg{padding:10px 10px 0;border:solid 1px #ddd;background:#eee}.ck_label{font-size:14px;font-weight:700}.ck_form input[type=\"text\"],.ck_form input[type=\"email\"]{font-size:14px;padding:10px 8px;width:100%;border:1px solid #d6d6d6;-moz-border-radius:4px;-webkit-border-radius:4px;border-radius:4px;background-color:#f8f7f7;margin-bottom:5px;height:auto}.ck_form input[type=\"text\"]:focus,.ck_form input[type=\"email\"]:focus{outline:none;border-color:#aaa}.ck_checkbox{padding:10px 0 10px 20px;display:block;clear:both}.ck_checkbox input.optIn{margin-left:-20px;margin-top:0}.ck_form .ck_opt_in_prompt{margin-left:4px}.ck_form .ck_opt_in_prompt p{display:inline}.ck_form .ck_subscribe_button{width:100%;color:#fff;margin:10px 0 0;padding:10px 0;font-size:18px;background:#0d6db8;-moz-border-radius:4px;-webkit-border-radius:4px;border-radius:4px;cursor:pointer;border:none;text-shadow:none}.ck_form .ck_guarantee{color:#626262;font-size:12px;text-align:center;padding:5px 0;display:block}.ck_form .ck_powered_by{display:block;color:#aaa}.ck_form .ck_powered_by:hover{display:block;color:#444}.ck_converted_content{display:none;padding:5%;background:#fff}.ck_form_v6 #ck_success_msg{padding:0 10px}@media all and (max-width:403px){.ck_form_v6.ck_modal .ck_close_link{top:30px}}@media all and (min-width:404px) and (max-width:499px){.ck_form_v6.ck_modal .ck_close_link{top:57px}}.ck_powered_by{display:none!important}.ck_form_container.ck_inline{margin-left:20px}.ck_image img{margin-right:10px}.ck_form.ck_vertical_subscription_form.ck_horizontal{margin-left:20px}</style><div class=\"ttr_end\"></div><span id=\"tve_leads_end_content\" style=\"display: block; visibility: hidden; border: 1px solid transparent;\"></span></div><footer class=\"entry-footer\"><span class=\"blog-tags minor-meta\"><strong>Tags:</strong><span> <a href=\"https://tomassetti.me/tag/c/\" rel=\"tag\">C#</a>, <a href=\"https://tomassetti.me/tag/kotlin/\" rel=\"tag\">Kotlin</a>, <a href=\"https://tomassetti.me/tag/sql/\" rel=\"tag\">SQL</a>, <a href=\"https://tomassetti.me/tag/tools/\" rel=\"tag\">tools</a></span></span></footer><div class=\"post_delimiter\"></div></div><div class=\"post_author_timeline\"></div><span class=\"hidden\"> <span class=\"av-structured-data\" itemprop=\"image\" itemscope=\"itemscope\" itemtype=\"https://schema.org/ImageObject\"> <span itemprop=\"url\">https://tomassetti.me/wp-content/uploads/2020/04/Parsing-SQL.jpg</span> <span itemprop=\"height\">512</span> <span itemprop=\"width\">1024</span> </span><span class=\"av-structured-data\" itemprop=\"publisher\" itemtype=\"https://schema.org/Organization\" itemscope=\"itemscope\"> <span itemprop=\"name\">Gabriele Tomassetti</span> <span itemprop=\"logo\" itemscope=\"\" itemtype=\"https://schema.org/ImageObject\"> <span itemprop=\"url\">https://tomassetti.me/wp-content/uploads/2017/07/federico-tomassetti-software-architect-300.png</span> </span> </span><span class=\"av-structured-data\" itemprop=\"author\" itemscope=\"itemscope\" itemtype=\"https://schema.org/Person\"><span itemprop=\"name\">Gabriele Tomassetti</span></span><span class=\"av-structured-data\" itemprop=\"datePublished\" datetime=\"2020-04-15T10:58:48+02:00\">2020-04-15 10:58:48</span><span class=\"av-structured-data\" itemprop=\"dateModified\" itemtype=\"https://schema.org/dateModified\">2020-04-15 10:58:48</span><span class=\"av-structured-data\" itemprop=\"mainEntityOfPage\" itemtype=\"https://schema.org/mainEntityOfPage\"><span itemprop=\"name\">Parsing SQL</span></span></span></article><div class=\"small\"></div><div class=\"related_posts\"><h5 class=\"related_title\">You might also like</h5><div class=\"related_entries_container \"><div class=\"av_one_eighth no_margin alpha relThumb relThumb1 relThumbOdd post-format-standard related_column\"> <a href=\"https://tomassetti.me/pyleri-tutorial/\" class=\"relThumWrap noLightbox\"> <span class=\"related_image_wrap\" data-avia-related-tooltip=\"Pyleri Tutorial: Parsing with Ease\"><img width=\"180\" height=\"180\" src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20180%20180'%3E%3C/svg%3E\" class=\"attachment-square size-square wp-post-image\" alt=\"Pyleri: Parsing with Ease\" data-lazy-srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2019/06/Pyleri_-Parsing-with-Ease-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2019/06/Pyleri_-Parsing-with-Ease-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2019/06/Pyleri_-Parsing-with-Ease-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2019/06/Pyleri_-Parsing-with-Ease-120x120.jpg 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2019/06/Pyleri_-Parsing-with-Ease-450x450.jpg 450w\" data-lazy-sizes=\"(max-width: 180px) 100vw, 180px\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2019/06/Pyleri_-Parsing-with-Ease-180x180.jpg\"><noscript><img width=\"180\" height=\"180\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2019/06/Pyleri_-Parsing-with-Ease-180x180.jpg\" class=\"attachment-square size-square wp-post-image\" alt=\"Pyleri: Parsing with Ease\" srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2019/06/Pyleri_-Parsing-with-Ease-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2019/06/Pyleri_-Parsing-with-Ease-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2019/06/Pyleri_-Parsing-with-Ease-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2019/06/Pyleri_-Parsing-with-Ease-120x120.jpg 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2019/06/Pyleri_-Parsing-with-Ease-450x450.jpg 450w\" sizes=\"(max-width: 180px) 100vw, 180px\" /></noscript> <span class=\"related-format-icon \"><span class=\"related-format-icon-inner\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\"></span></span> </span> </a></div><div class=\"av_one_eighth no_margin relThumb relThumb2 relThumbEven post-format-standard related_column\"> <a href=\"https://tomassetti.me/guide-natural-language-processing/\" class=\"relThumWrap noLightbox\"> <span class=\"related_image_wrap\" data-avia-related-tooltip=\"Analyze and Understand Text: Guide to Natural Language Processing\"><img width=\"180\" height=\"180\" src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20180%20180'%3E%3C/svg%3E\" class=\"attachment-square size-square wp-post-image\" alt=\"Guide to Natural Language Processing\" data-lazy-srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/11/Guide-to-Natural-Languages-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/11/Guide-to-Natural-Languages-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/11/Guide-to-Natural-Languages-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/11/Guide-to-Natural-Languages-120x120.jpg 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/11/Guide-to-Natural-Languages-450x450.jpg 450w\" data-lazy-sizes=\"(max-width: 180px) 100vw, 180px\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/11/Guide-to-Natural-Languages-180x180.jpg\"><noscript><img width=\"180\" height=\"180\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/11/Guide-to-Natural-Languages-180x180.jpg\" class=\"attachment-square size-square wp-post-image\" alt=\"Guide to Natural Language Processing\" srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/11/Guide-to-Natural-Languages-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/11/Guide-to-Natural-Languages-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/11/Guide-to-Natural-Languages-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/11/Guide-to-Natural-Languages-120x120.jpg 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/11/Guide-to-Natural-Languages-450x450.jpg 450w\" sizes=\"(max-width: 180px) 100vw, 180px\" /></noscript> <span class=\"related-format-icon \"><span class=\"related-format-icon-inner\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\"></span></span> </span> </a></div><div class=\"av_one_eighth no_margin relThumb relThumb3 relThumbOdd post-format-standard related_column\"> <a href=\"https://tomassetti.me/autocompletion-editor-antlr/\" class=\"relThumWrap noLightbox\"> <span class=\"related_image_wrap\" data-avia-related-tooltip=\"Building autocompletion for an editor based on ANTLR\"><img width=\"180\" height=\"180\" src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20180%20180'%3E%3C/svg%3E\" class=\"attachment-square size-square wp-post-image\" alt=\"Building autocompletion for an editor based on ANTLR\" data-lazy-srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/08/Building-autocompletion-for-an-editor-based-on-ANTLR-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/08/Building-autocompletion-for-an-editor-based-on-ANTLR-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/08/Building-autocompletion-for-an-editor-based-on-ANTLR-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/08/Building-autocompletion-for-an-editor-based-on-ANTLR-120x120.jpg 120w\" data-lazy-sizes=\"(max-width: 180px) 100vw, 180px\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/08/Building-autocompletion-for-an-editor-based-on-ANTLR-180x180.jpg\"><noscript><img width=\"180\" height=\"180\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/08/Building-autocompletion-for-an-editor-based-on-ANTLR-180x180.jpg\" class=\"attachment-square size-square wp-post-image\" alt=\"Building autocompletion for an editor based on ANTLR\" srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/08/Building-autocompletion-for-an-editor-based-on-ANTLR-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/08/Building-autocompletion-for-an-editor-based-on-ANTLR-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/08/Building-autocompletion-for-an-editor-based-on-ANTLR-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/08/Building-autocompletion-for-an-editor-based-on-ANTLR-120x120.jpg 120w\" sizes=\"(max-width: 180px) 100vw, 180px\" /></noscript> <span class=\"related-format-icon \"><span class=\"related-format-icon-inner\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\"></span></span> </span> </a></div><div class=\"av_one_eighth no_margin relThumb relThumb4 relThumbEven post-format-standard related_column\"> <a href=\"https://tomassetti.me/why-you-should-not-use-flex-yacc-and-bison/\" class=\"relThumWrap noLightbox\"> <span class=\"related_image_wrap\" data-avia-related-tooltip=\"Why you should not use (f)lex, yacc and bison\"><img width=\"180\" height=\"180\" src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20180%20180'%3E%3C/svg%3E\" class=\"attachment-square size-square wp-post-image\" alt=\"\" data-lazy-srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-120x120.jpg 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-450x450.jpg 450w\" data-lazy-sizes=\"(max-width: 180px) 100vw, 180px\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-180x180.jpg\"><noscript><img width=\"180\" height=\"180\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-180x180.jpg\" class=\"attachment-square size-square wp-post-image\" alt=\"\" srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-120x120.jpg 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-450x450.jpg 450w\" sizes=\"(max-width: 180px) 100vw, 180px\" /></noscript> <span class=\"related-format-icon \"><span class=\"related-format-icon-inner\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\"></span></span> </span> </a></div><div class=\"av_one_eighth no_margin relThumb relThumb5 relThumbOdd post-format-standard related_column\"> <a href=\"https://tomassetti.me/parsing-html/\" class=\"relThumWrap noLightbox\"> <span class=\"related_image_wrap\" data-avia-related-tooltip=\"Parsing HTML: A Guide to Select the Right Library\"><img width=\"180\" height=\"180\" src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20180%20180'%3E%3C/svg%3E\" class=\"attachment-square size-square wp-post-image\" alt=\"Parsing HTML: A Guide To Select The Right Library\" data-lazy-srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/Parsing-HTML_-A-Guide-To-Select-The-Right-Library-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/Parsing-HTML_-A-Guide-To-Select-The-Right-Library-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/Parsing-HTML_-A-Guide-To-Select-The-Right-Library-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/Parsing-HTML_-A-Guide-To-Select-The-Right-Library-120x120.jpg 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/Parsing-HTML_-A-Guide-To-Select-The-Right-Library-450x450.jpg 450w\" data-lazy-sizes=\"(max-width: 180px) 100vw, 180px\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/Parsing-HTML_-A-Guide-To-Select-The-Right-Library-180x180.jpg\"><noscript><img width=\"180\" height=\"180\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/Parsing-HTML_-A-Guide-To-Select-The-Right-Library-180x180.jpg\" class=\"attachment-square size-square wp-post-image\" alt=\"Parsing HTML: A Guide To Select The Right Library\" srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/Parsing-HTML_-A-Guide-To-Select-The-Right-Library-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/Parsing-HTML_-A-Guide-To-Select-The-Right-Library-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/Parsing-HTML_-A-Guide-To-Select-The-Right-Library-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/Parsing-HTML_-A-Guide-To-Select-The-Right-Library-120x120.jpg 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/Parsing-HTML_-A-Guide-To-Select-The-Right-Library-450x450.jpg 450w\" sizes=\"(max-width: 180px) 100vw, 180px\" /></noscript> <span class=\"related-format-icon \"><span class=\"related-format-icon-inner\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\"></span></span> </span> </a></div><div class=\"av_one_eighth no_margin relThumb relThumb6 relThumbEven post-format-standard related_column\"> <a href=\"https://tomassetti.me/building-models-of-java-code-from-class-and-jar-files/\" class=\"relThumWrap noLightbox\"> <span class=\"related_image_wrap\" data-avia-related-tooltip=\"Building Models of Java Code from Source and JAR Files\"><img width=\"180\" height=\"180\" src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20180%20180'%3E%3C/svg%3E\" class=\"attachment-square size-square wp-post-image\" alt=\"Building models of Java code from source and JAR files\" data-lazy-srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2015/05/building_models-180x180.png 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2015/05/building_models-80x80.png 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2015/05/building_models-36x36.png 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2015/05/building_models-120x120.png 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2015/05/building_models-450x450.png 450w\" data-lazy-sizes=\"(max-width: 180px) 100vw, 180px\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2015/05/building_models-180x180.png\"><noscript><img width=\"180\" height=\"180\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2015/05/building_models-180x180.png\" class=\"attachment-square size-square wp-post-image\" alt=\"Building models of Java code from source and JAR files\" srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2015/05/building_models-180x180.png 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2015/05/building_models-80x80.png 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2015/05/building_models-36x36.png 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2015/05/building_models-120x120.png 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2015/05/building_models-450x450.png 450w\" sizes=\"(max-width: 180px) 100vw, 180px\" /></noscript> <span class=\"related-format-icon \"><span class=\"related-format-icon-inner\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\"></span></span> </span> </a></div><div class=\"av_one_eighth no_margin relThumb relThumb7 relThumbOdd post-format-standard related_column\"> <a href=\"https://tomassetti.me/antlr-and-jetbrains-mps-parsing-files-and-display-the-ast-usign-the-tree-notation/\" class=\"relThumWrap noLightbox\"> <span class=\"related_image_wrap\" data-avia-related-tooltip=\"ANTLR and Jetbrains MPS: Parsing files and display the AST using the tree notation\"><img width=\"180\" height=\"180\" src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20180%20180'%3E%3C/svg%3E\" class=\"attachment-square size-square wp-post-image\" alt=\"\" data-lazy-srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/05/ANTLR-and-Jetbrains-MPS-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/05/ANTLR-and-Jetbrains-MPS-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/05/ANTLR-and-Jetbrains-MPS-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/05/ANTLR-and-Jetbrains-MPS-120x120.jpg 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/05/ANTLR-and-Jetbrains-MPS-450x450.jpg 450w\" data-lazy-sizes=\"(max-width: 180px) 100vw, 180px\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/05/ANTLR-and-Jetbrains-MPS-180x180.jpg\"><noscript><img width=\"180\" height=\"180\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/05/ANTLR-and-Jetbrains-MPS-180x180.jpg\" class=\"attachment-square size-square wp-post-image\" alt=\"\" srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/05/ANTLR-and-Jetbrains-MPS-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/05/ANTLR-and-Jetbrains-MPS-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/05/ANTLR-and-Jetbrains-MPS-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/05/ANTLR-and-Jetbrains-MPS-120x120.jpg 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2016/05/ANTLR-and-Jetbrains-MPS-450x450.jpg 450w\" sizes=\"(max-width: 180px) 100vw, 180px\" /></noscript> <span class=\"related-format-icon \"><span class=\"related-format-icon-inner\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\"></span></span> </span> </a></div><div class=\"av_one_eighth no_margin omega relThumb relThumb8 relThumbEven post-format-standard related_column\"> <a href=\"https://tomassetti.me/guide-parsing-algorithms-terminology/\" class=\"relThumWrap noLightbox\"> <span class=\"related_image_wrap\" data-avia-related-tooltip=\"A Guide to Parsing: Algorithms and Terminology\"><img width=\"180\" height=\"180\" src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20180%20180'%3E%3C/svg%3E\" class=\"attachment-square size-square wp-post-image\" alt=\"A Guide To Parsing: Algorithms And Terminology\" data-lazy-srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/A-Guide-To-Parsing_-Algorithms-And-Terminology-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/A-Guide-To-Parsing_-Algorithms-And-Terminology-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/A-Guide-To-Parsing_-Algorithms-And-Terminology-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/A-Guide-To-Parsing_-Algorithms-And-Terminology-120x120.jpg 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/A-Guide-To-Parsing_-Algorithms-And-Terminology-450x450.jpg 450w\" data-lazy-sizes=\"(max-width: 180px) 100vw, 180px\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/A-Guide-To-Parsing_-Algorithms-And-Terminology-180x180.jpg\"><noscript><img width=\"180\" height=\"180\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/A-Guide-To-Parsing_-Algorithms-And-Terminology-180x180.jpg\" class=\"attachment-square size-square wp-post-image\" alt=\"A Guide To Parsing: Algorithms And Terminology\" srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/A-Guide-To-Parsing_-Algorithms-And-Terminology-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/A-Guide-To-Parsing_-Algorithms-And-Terminology-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/A-Guide-To-Parsing_-Algorithms-And-Terminology-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/A-Guide-To-Parsing_-Algorithms-And-Terminology-120x120.jpg 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/09/A-Guide-To-Parsing_-Algorithms-And-Terminology-450x450.jpg 450w\" sizes=\"(max-width: 180px) 100vw, 180px\" /></noscript> <span class=\"related-format-icon \"><span class=\"related-format-icon-inner\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\"></span></span> </span> </a></div></div></div><div class=\"template-page content alpha units\" style=\"background-color: #F8F8F8;\"><div class=\"post-entry post-entry-type-page post-entry-2592\" style=\"margin-left: 2em; margin-right: 1em;\"><div class=\"entry-content-wrapper clearfix\"><div style=\"padding-bottom:10px; \" class=\"av-special-heading av-special-heading-h2 blockquote modern-quote modern-centered avia-builder-el-7 el_before_av_one_third avia-builder-el-first \"><h2 class=\"av-special-heading-tag \" itemprop=\"headline\" style=\"margin-bottom: 1em;\">Do You Need a Parser?</h2><div class=\"av-subheading av-subheading_below\" style=\"font-size:18px; text-align: justify; margin-bottom: 1em;\"><p>We can design parsers for new languages, or rewrite parsers for existing languages built in house.</p><p> On top of parsers we can then help building interpreters, compilers, code generators, documentation generators, or translators (code converters) to other languages.</p></div><div class=\"special-heading-border\"><div class=\"special-heading-inner-border\"></div></div></div><div class=\"flex_column av_one_third flex_column_div av-zero-column-padding first avia-builder-el-8 el_after_av_heading el_before_av_one_third \" style=\"border-radius:0px; \"></div><div class=\"flex_column av_one_third flex_column_div av-zero-column-padding avia-builder-el-9 el_after_av_one_third el_before_av_one_third \" style=\"border-radius:0px; \"><div class=\"avia-button-wrap avia-button-center avia-builder-el-10 avia-builder-el-no-sibling \"><a href=\"https://tomassetti.me/contact-me-about-a-project/\" class=\"avia-button avia-button-fullwidth avia-icon_select-no avia-color-theme-color \" style=\"color:#ffffff; \"><span class=\"avia_iconbox_title\">Let’s Talk!</span><span class=\"avia_button_background avia-button avia-button-fullwidth avia-color-black\"></span></a></div></div><div class=\"flex_column av_one_third flex_column_div av-zero-column-padding avia-builder-el-11 el_after_av_one_third avia-builder-el-last \" style=\"border-radius:0px; \"></div><p></p> <span id=\"tve_leads_end_content\" style=\"display: block; visibility: hidden; border: 1px solid transparent;\"></span></div></div></div><div class=\"comment-entry post-entry\"></div></main><aside class=\"sidebar sidebar_right alpha units\" role=\"complementary\" itemscope=\"itemscope\" itemtype=\"https://schema.org/WPSideBar\"><div class=\"inner_sidebar extralight-border\"><section id=\"custom_html-4\" class=\"widget_text widget clearfix widget_custom_html\"><h3 class=\"widgettitle\">Course: Using ANTLR Like A Professional</h3><div class=\"textwidget custom-html-widget\"><a href=\"https://tomassetti.me/antlr-course\" target=\"_blank\" rel=\"noopener noreferrer\" style=\"position: relative; overflow: hidden;\"><img src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2018/04/ANTLR-Course-Widget-Square.png\" alt=\"ANTLR Course Image\" width=\"256px\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2018/04/ANTLR-Course-Widget-Square.png\" class=\"lazyloaded\" data-was-processed=\"true\"><noscript><img src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2018/04/ANTLR-Course-Widget-Square.png\" alt=\"ANTLR Course Image\" width=\"256px\"></noscript><span class=\"image-overlay overlay-type-extern\"><span class=\"image-overlay-inside\"></span></span></a><p style=\"font-size: 10pt;\"><a href=\"https://tomassetti.me/antlr-course\" style=\" text-decoration: underline; color: #ea9030; \">A complete video course on parsing and ANTLR</a>, that will teach you how to build parser for everything from programming languages to data formats. <br> Taught from professionals that build parsers for a living.</p></div><span class=\"seperator extralight-border\"></span></section><section id=\"text-4\" class=\"widget clearfix widget_text\"><h3 class=\"widgettitle\">Book: How to create pragmatic, lightweight languages</h3><div class=\"textwidget\"><p><a href=\"https://tomassetti.me/create-languages\" target=\"_blank\" rel=\"noopener noreferrer\" style=\"position: relative; overflow: hidden;\"><img src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%200%200'%3E%3C/svg%3E\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2018/03/low-resolution.png\"><noscript><img src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2018/03/low-resolution.png\"/></noscript><span class=\"image-overlay overlay-type-extern\"><span class=\"image-overlay-inside\"></span></span></a></p><p style=\" font-size: 10pt; \">This <a href=\"https://tomassetti.me/create-languages\" style=\" text-decoration: underline; color: #ea9030; \">book on Building Languages</a> is about building in a simple manner productive languages with parsers, compilers, interpreters, editors and more.</p></div> <span class=\"seperator extralight-border\"></span></section><section id=\"text-6\" class=\"widget clearfix widget_text\"><h3 class=\"widgettitle\">Book: JavaParser Visited</h3><div class=\"textwidget\"><a href=\"https://leanpub.com/javaparservisited\" target=\"_blank\" rel=\"noopener noreferrer\" style=\"position: relative; overflow: hidden;\"><img src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%200%200'%3E%3C/svg%3E\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/01/javaparser-book.jpg\"><noscript><img src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2017/01/javaparser-book.jpg\"/></noscript><span class=\"image-overlay overlay-type-extern\"><span class=\"image-overlay-inside\"></span></span></a><p style=\" font-size: 10pt; \">This <a href=\"https://leanpub.com/javaparservisited\" style=\" text-decoration: underline; color: #ea9030; \">book on JavaParser</a> will teach you how to analyze, transform, and generate Java code</p></div> <span class=\"seperator extralight-border\"></span></section><section id=\"custom_html-2\" class=\"widget_text widget clearfix widget_custom_html\"><h3 class=\"widgettitle\">Strumenta – Consulting</h3><div class=\"textwidget custom-html-widget\">If you need help designing and developing DSLs, languages, parsers, compilers, interpreters, and editors you can check the <a href=\"https://strumenta.com/services\" style=\"text-decoration: underline;\">services page</a> of the Consulting studio we founded: <a href=\"https://strumenta.com\">Strumenta</a>. <a href=\"https://strumenta.com\" style=\"position: relative; overflow: hidden;\"><img style=\"display: block;margin: 10px 30px 0;width:70%\" src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%200%200'%3E%3C/svg%3E\" alt=\"Strumenta Logo\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2018/03/SRUMENTA-ESTESO-320x132.png\"><noscript><img style=\"display: block;margin: 10px 30px 0;width:70%\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2018/03/SRUMENTA-ESTESO-320x132.png\" alt=\"Strumenta Logo\"></noscript><span class=\"image-overlay overlay-type-extern\"><span class=\"image-overlay-inside\"></span></span></a></div><span class=\"seperator extralight-border\"></span></section><section id=\"categories-7\" class=\"widget clearfix widget_categories\"><h3 class=\"widgettitle\">Blog Categories</h3><ul><li class=\"cat-item cat-item-57\"><a href=\"https://tomassetti.me/category/language-engineering/antlr/\" title=\"Tutorials, news and informations on the parser generator ANTLR\">ANTLR</a> (17)</li><li class=\"cat-item cat-item-173\"><a href=\"https://tomassetti.me/category/application-modernization/\">Application modernization</a> (2)</li><li class=\"cat-item cat-item-30\"><a href=\"https://tomassetti.me/category/static-analysis/\" title=\"Articles about extracting data from code, analyze it and programmatically transform it. In other words we talk about static analysis, automated refactoring, and code generation.\">Code processing</a> (24)</li><li class=\"cat-item cat-item-68\"><a href=\"https://tomassetti.me/category/consulting/\" title=\"My experience about consulting and freelancing\">Consulting</a> (14)</li><li class=\"cat-item cat-item-166\"><a href=\"https://tomassetti.me/category/language-engineering/create-a-programming-language/\">Create a programming language</a> (1)</li><li class=\"cat-item cat-item-38\"><a href=\"https://tomassetti.me/category/language-engineering/domain-specific-languages/\" title=\"News, guides, tutorials and the bigger picture of creating domain specific languages\">Domain specific languages</a> (16)</li><li class=\"cat-item cat-item-172\"><a href=\"https://tomassetti.me/category/language-engineering/editors/\">Editors</a> (1)</li><li class=\"cat-item cat-item-54\"><a href=\"https://tomassetti.me/category/language-engineering/jetbrains-mps/\" title=\"Informations and tutorials on the language workbench Jetbrains MPS\">Jetbrains MPS</a> (11)</li><li class=\"cat-item cat-item-52\"><a href=\"https://tomassetti.me/category/language-engineering/language-design/\" title=\"Strategies, tips and tutorials on designing programming languages\">Language design</a> (13)</li><li class=\"cat-item cat-item-60\"><a href=\"https://tomassetti.me/category/language-engineering/\" title=\"The science, tools, strategies, patterns and tools behind the creation and processing of languages\">Language Engineering</a> (33)</li><li class=\"cat-item cat-item-1\"><a href=\"https://tomassetti.me/category/miscellany/\" title=\"Reviews, ideas, tip, opinions, etc. on all aspects of software development\">Miscellany</a> (5)</li><li class=\"cat-item cat-item-5\"><a href=\"https://tomassetti.me/category/language-engineering/mdd/\" title=\"Articles on creating software working on domains models\">Model driven development</a> (4)</li><li class=\"cat-item cat-item-171\"><a href=\"https://tomassetti.me/category/natural-language-processing/\">Natural Language Processing</a> (1)</li><li class=\"cat-item cat-item-70\"><a href=\"https://tomassetti.me/category/random-stuff/\" title=\"Everything that is not related to software development: ideas on natural languages, countries I have lived in, my life, stuff that make me curious. All sort of interesting things.\">Non software development</a> (4)</li><li class=\"cat-item cat-item-23\"><a href=\"https://tomassetti.me/category/open-source/\" title=\"Ideas and tips on how to make open source project successful and my open source projects\">Open-source</a> (8)</li><li class=\"cat-item cat-item-39\"><a href=\"https://tomassetti.me/category/language-engineering/parsing/\" title=\"Tutorials and issues on all aspects of creating software to analyse code\">Parsing</a> (22)</li><li class=\"cat-item cat-item-17\"><a href=\"https://tomassetti.me/category/research/\" title=\"Research Papers, conferences and challenges at the forefront of Language Engineering\">Research</a> (4)</li><li class=\"cat-item cat-item-4\"><a href=\"https://tomassetti.me/category/development/\" title=\"Everything related to software development that every developer could find useful\">Software Development</a> (16)</li><li class=\"cat-item cat-item-35\"><a href=\"https://tomassetti.me/category/software-engineering/\" title=\"Methods and processes of Software Engineering: how to create beautiful software\">Software Engineering</a> (13)</li><li class=\"cat-item cat-item-44\"><a href=\"https://tomassetti.me/category/turin-programming-language/\" title=\"The creation of the Turin Programmin Language: examples, problems, solutions and strategies.\">Turin Programming Language</a> (4)</li><li class=\"cat-item cat-item-63\"><a href=\"https://tomassetti.me/category/language-engineering/whole-platform/\" title=\"Informations and opinions about the Whole Platform\">Whole Platform</a> (2)</li><li class=\"cat-item cat-item-56\"><a href=\"https://tomassetti.me/category/language-engineering/xtext/\" title=\"News and tips on Xtext\">Xtext</a> (3)</li></ul> <span class=\"seperator extralight-border\"></span></section></div></aside></div></div><div class=\"container_wrap footer_color\" id=\"footer\"><div class=\"container\"><div class=\"flex_column av_one_fourth first el_before_av_one_fourth\"><section id=\"nav_menu-3\" class=\"widget clearfix widget_nav_menu\"><h3 class=\"widgettitle\">Menu</h3><div class=\"menu-tomassetti_footer-container\"><ul id=\"menu-tomassetti_footer\" class=\"menu\"><li id=\"menu-item-2582\" class=\"menu-item menu-item-type-post_type menu-item-object-page menu-item-2582\"><a href=\"https://tomassetti.me/about-me/\">About me</a></li><li id=\"menu-item-2579\" class=\"menu-item menu-item-type-post_type menu-item-object-page menu-item-2579\"><a href=\"https://tomassetti.me/how-i-work/\">How I work</a></li><li id=\"menu-item-5981\" class=\"menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-5981\"><a href=\"https://strumenta.com/services/\">Language Engineering Services</a><ul class=\"sub-menu\"><li id=\"menu-item-5092\" class=\"menu-item menu-item-type-custom menu-item-object-custom menu-item-5092\"><a href=\"https://strumenta.com/antlr-consulting/\">ANTLR Consulting</a></li><li id=\"menu-item-5984\" class=\"menu-item menu-item-type-custom menu-item-object-custom menu-item-5984\"><a href=\"https://strumenta.com/jetbrains-mps-consulting/\">Jetbrains MPS Consulting</a></li></ul></li><li id=\"menu-item-5961\" class=\"menu-item menu-item-type-custom menu-item-object-custom menu-item-5961\"><a href=\"https://strumenta.com/contact-us/\">Contact</a></li><li id=\"menu-item-2585\" class=\"menu-item menu-item-type-custom menu-item-object-custom menu-item-2585\"><a href=\"https://ie.linkedin.com/in/federicotomassetti\">LinkedIn</a></li></ul></div><span class=\"seperator extralight-border\"></span></section></div><div class=\"flex_column av_one_fourth el_after_av_one_fourth el_before_av_one_fourth \"><section id=\"categories-5\" class=\"widget clearfix widget_categories\"><h3 class=\"widgettitle\">Blog Categories</h3><ul><li class=\"cat-item cat-item-57\"><a href=\"https://tomassetti.me/category/language-engineering/antlr/\" title=\"Tutorials, news and informations on the parser generator ANTLR\">ANTLR</a> (17)</li><li class=\"cat-item cat-item-173\"><a href=\"https://tomassetti.me/category/application-modernization/\">Application modernization</a> (2)</li><li class=\"cat-item cat-item-30\"><a href=\"https://tomassetti.me/category/static-analysis/\" title=\"Articles about extracting data from code, analyze it and programmatically transform it. In other words we talk about static analysis, automated refactoring, and code generation.\">Code processing</a> (24)</li><li class=\"cat-item cat-item-68\"><a href=\"https://tomassetti.me/category/consulting/\" title=\"My experience about consulting and freelancing\">Consulting</a> (14)</li><li class=\"cat-item cat-item-166\"><a href=\"https://tomassetti.me/category/language-engineering/create-a-programming-language/\">Create a programming language</a> (1)</li><li class=\"cat-item cat-item-38\"><a href=\"https://tomassetti.me/category/language-engineering/domain-specific-languages/\" title=\"News, guides, tutorials and the bigger picture of creating domain specific languages\">Domain specific languages</a> (16)</li><li class=\"cat-item cat-item-172\"><a href=\"https://tomassetti.me/category/language-engineering/editors/\">Editors</a> (1)</li><li class=\"cat-item cat-item-54\"><a href=\"https://tomassetti.me/category/language-engineering/jetbrains-mps/\" title=\"Informations and tutorials on the language workbench Jetbrains MPS\">Jetbrains MPS</a> (11)</li><li class=\"cat-item cat-item-52\"><a href=\"https://tomassetti.me/category/language-engineering/language-design/\" title=\"Strategies, tips and tutorials on designing programming languages\">Language design</a> (13)</li><li class=\"cat-item cat-item-60\"><a href=\"https://tomassetti.me/category/language-engineering/\" title=\"The science, tools, strategies, patterns and tools behind the creation and processing of languages\">Language Engineering</a> (33)</li><li class=\"cat-item cat-item-1\"><a href=\"https://tomassetti.me/category/miscellany/\" title=\"Reviews, ideas, tip, opinions, etc. on all aspects of software development\">Miscellany</a> (5)</li><li class=\"cat-item cat-item-5\"><a href=\"https://tomassetti.me/category/language-engineering/mdd/\" title=\"Articles on creating software working on domains models\">Model driven development</a> (4)</li><li class=\"cat-item cat-item-171\"><a href=\"https://tomassetti.me/category/natural-language-processing/\">Natural Language Processing</a> (1)</li><li class=\"cat-item cat-item-70\"><a href=\"https://tomassetti.me/category/random-stuff/\" title=\"Everything that is not related to software development: ideas on natural languages, countries I have lived in, my life, stuff that make me curious. All sort of interesting things.\">Non software development</a> (4)</li><li class=\"cat-item cat-item-23\"><a href=\"https://tomassetti.me/category/open-source/\" title=\"Ideas and tips on how to make open source project successful and my open source projects\">Open-source</a> (8)</li><li class=\"cat-item cat-item-39\"><a href=\"https://tomassetti.me/category/language-engineering/parsing/\" title=\"Tutorials and issues on all aspects of creating software to analyse code\">Parsing</a> (22)</li><li class=\"cat-item cat-item-17\"><a href=\"https://tomassetti.me/category/research/\" title=\"Research Papers, conferences and challenges at the forefront of Language Engineering\">Research</a> (4)</li><li class=\"cat-item cat-item-4\"><a href=\"https://tomassetti.me/category/development/\" title=\"Everything related to software development that every developer could find useful\">Software Development</a> (16)</li><li class=\"cat-item cat-item-35\"><a href=\"https://tomassetti.me/category/software-engineering/\" title=\"Methods and processes of Software Engineering: how to create beautiful software\">Software Engineering</a> (13)</li><li class=\"cat-item cat-item-44\"><a href=\"https://tomassetti.me/category/turin-programming-language/\" title=\"The creation of the Turin Programmin Language: examples, problems, solutions and strategies.\">Turin Programming Language</a> (4)</li><li class=\"cat-item cat-item-63\"><a href=\"https://tomassetti.me/category/language-engineering/whole-platform/\" title=\"Informations and opinions about the Whole Platform\">Whole Platform</a> (2)</li><li class=\"cat-item cat-item-56\"><a href=\"https://tomassetti.me/category/language-engineering/xtext/\" title=\"News and tips on Xtext\">Xtext</a> (3)</li></ul> <span class=\"seperator extralight-border\"></span></section></div><div class=\"flex_column av_one_fourth el_after_av_one_fourth el_before_av_one_fourth \"><section id=\"tag_cloud-3\" class=\"widget clearfix widget_tag_cloud\"><h3 class=\"widgettitle\">Tags</h3><div class=\"tagcloud\"><a href=\"https://tomassetti.me/tag/automation/\" class=\"tag-cloud-link tag-link-73 tag-link-position-1\" style=\"font-size: 10.964705882353pt;\" aria-label=\"Automation (2 items)\">Automation</a> <a href=\"https://tomassetti.me/tag/c/\" class=\"tag-cloud-link tag-link-91 tag-link-position-2\" style=\"font-size: 20.847058823529pt;\" aria-label=\"C# (11 items)\">C#</a> <a href=\"https://tomassetti.me/tag/clojure/\" class=\"tag-cloud-link tag-link-80 tag-link-position-3\" style=\"font-size: 12.941176470588pt;\" aria-label=\"Clojure (3 items)\">Clojure</a> <a href=\"https://tomassetti.me/tag/code-generation/\" class=\"tag-cloud-link tag-link-156 tag-link-position-4\" style=\"font-size: 10.964705882353pt;\" aria-label=\"code generation (2 items)\">code generation</a> <a href=\"https://tomassetti.me/tag/dsl/\" class=\"tag-cloud-link tag-link-111 tag-link-position-5\" style=\"font-size: 14.588235294118pt;\" aria-label=\"dsl (4 items)\">dsl</a> <a href=\"https://tomassetti.me/tag/effectivejava/\" class=\"tag-cloud-link tag-link-135 tag-link-position-6\" style=\"font-size: 12.941176470588pt;\" aria-label=\"effectivejava (3 items)\">effectivejava</a> <a href=\"https://tomassetti.me/tag/formats/\" class=\"tag-cloud-link tag-link-146 tag-link-position-7\" style=\"font-size: 10.964705882353pt;\" aria-label=\"formats (2 items)\">formats</a> <a href=\"https://tomassetti.me/tag/frege/\" class=\"tag-cloud-link tag-link-74 tag-link-position-8\" style=\"font-size: 10.964705882353pt;\" aria-label=\"Frege (2 items)\">Frege</a> <a href=\"https://tomassetti.me/tag/functional-programming/\" class=\"tag-cloud-link tag-link-86 tag-link-position-9\" style=\"font-size: 10.964705882353pt;\" aria-label=\"Functional programming (2 items)\">Functional programming</a> <a href=\"https://tomassetti.me/tag/guide/\" class=\"tag-cloud-link tag-link-147 tag-link-position-10\" style=\"font-size: 12.941176470588pt;\" aria-label=\"guide (3 items)\">guide</a> <a href=\"https://tomassetti.me/tag/haskell/\" class=\"tag-cloud-link tag-link-75 tag-link-position-11\" style=\"font-size: 12.941176470588pt;\" aria-label=\"Haskell (3 items)\">Haskell</a> <a href=\"https://tomassetti.me/tag/icse/\" class=\"tag-cloud-link tag-link-18 tag-link-position-12\" style=\"font-size: 8pt;\" aria-label=\"icse (1 item)\">icse</a> <a href=\"https://tomassetti.me/tag/image-processing/\" class=\"tag-cloud-link tag-link-72 tag-link-position-13\" style=\"font-size: 8pt;\" aria-label=\"Image processing (1 item)\">Image processing</a> <a href=\"https://tomassetti.me/tag/interpreters/\" class=\"tag-cloud-link tag-link-149 tag-link-position-14\" style=\"font-size: 10.964705882353pt;\" aria-label=\"interpreters (2 items)\">interpreters</a> <a href=\"https://tomassetti.me/tag/interview/\" class=\"tag-cloud-link tag-link-71 tag-link-position-15\" style=\"font-size: 22pt;\" aria-label=\"Interview (13 items)\">Interview</a> <a href=\"https://tomassetti.me/tag/java/\" class=\"tag-cloud-link tag-link-24 tag-link-position-16\" style=\"font-size: 17.882352941176pt;\" aria-label=\"java (7 items)\">java</a> <a href=\"https://tomassetti.me/tag/javaparser/\" class=\"tag-cloud-link tag-link-83 tag-link-position-17\" style=\"font-size: 17.058823529412pt;\" aria-label=\"JavaParser (6 items)\">JavaParser</a> <a href=\"https://tomassetti.me/tag/javascript/\" class=\"tag-cloud-link tag-link-89 tag-link-position-18\" style=\"font-size: 14.588235294118pt;\" aria-label=\"JavaScript (4 items)\">JavaScript</a> <a href=\"https://tomassetti.me/tag/javasymbolsolver/\" class=\"tag-cloud-link tag-link-81 tag-link-position-19\" style=\"font-size: 8pt;\" aria-label=\"JavaSymbolSolver (1 item)\">JavaSymbolSolver</a> <a href=\"https://tomassetti.me/tag/jetbrains-mps/\" class=\"tag-cloud-link tag-link-13 tag-link-position-20\" style=\"font-size: 14.588235294118pt;\" aria-label=\"jetbrains mps (4 items)\">jetbrains mps</a> <a href=\"https://tomassetti.me/tag/kotlin/\" class=\"tag-cloud-link tag-link-90 tag-link-position-21\" style=\"font-size: 14.588235294118pt;\" aria-label=\"Kotlin (4 items)\">Kotlin</a> <a href=\"https://tomassetti.me/tag/language-integration/\" class=\"tag-cloud-link tag-link-16 tag-link-position-22\" style=\"font-size: 10.964705882353pt;\" aria-label=\"language integration (2 items)\">language integration</a> <a href=\"https://tomassetti.me/tag/language-server-protocol/\" class=\"tag-cloud-link tag-link-100 tag-link-position-23\" style=\"font-size: 12.941176470588pt;\" aria-label=\"language server protocol (3 items)\">language server protocol</a> <a href=\"https://tomassetti.me/tag/language-worbenches/\" class=\"tag-cloud-link tag-link-19 tag-link-position-24\" style=\"font-size: 8pt;\" aria-label=\"language worbenches (1 item)\">language worbenches</a> <a href=\"https://tomassetti.me/tag/libav/\" class=\"tag-cloud-link tag-link-84 tag-link-position-25\" style=\"font-size: 10.964705882353pt;\" aria-label=\"Libav (2 items)\">Libav</a> <a href=\"https://tomassetti.me/tag/machine-learning/\" class=\"tag-cloud-link tag-link-121 tag-link-position-26\" style=\"font-size: 10.964705882353pt;\" aria-label=\"machine learning (2 items)\">machine learning</a> <a href=\"https://tomassetti.me/tag/mbeddr/\" class=\"tag-cloud-link tag-link-48 tag-link-position-27\" style=\"font-size: 8pt;\" aria-label=\"mbeddr (1 item)\">mbeddr</a> <a href=\"https://tomassetti.me/tag/mise/\" class=\"tag-cloud-link tag-link-20 tag-link-position-28\" style=\"font-size: 8pt;\" aria-label=\"mise (1 item)\">mise</a> <a href=\"https://tomassetti.me/tag/natural-language/\" class=\"tag-cloud-link tag-link-113 tag-link-position-29\" style=\"font-size: 10.964705882353pt;\" aria-label=\"natural language (2 items)\">natural language</a> <a href=\"https://tomassetti.me/tag/nlp/\" class=\"tag-cloud-link tag-link-140 tag-link-position-30\" style=\"font-size: 10.964705882353pt;\" aria-label=\"nlp (2 items)\">nlp</a> <a href=\"https://tomassetti.me/tag/open-source/\" class=\"tag-cloud-link tag-link-82 tag-link-position-31\" style=\"font-size: 10.964705882353pt;\" aria-label=\"Open-source (2 items)\">Open-source</a> <a href=\"https://tomassetti.me/tag/opensource/\" class=\"tag-cloud-link tag-link-157 tag-link-position-32\" style=\"font-size: 10.964705882353pt;\" aria-label=\"opensource (2 items)\">opensource</a> <a href=\"https://tomassetti.me/tag/programming-languages/\" class=\"tag-cloud-link tag-link-123 tag-link-position-33\" style=\"font-size: 14.588235294118pt;\" aria-label=\"programming languages (4 items)\">programming languages</a> <a href=\"https://tomassetti.me/tag/python/\" class=\"tag-cloud-link tag-link-78 tag-link-position-34\" style=\"font-size: 17.882352941176pt;\" aria-label=\"Python (7 items)\">Python</a> <a href=\"https://tomassetti.me/tag/refactoring/\" class=\"tag-cloud-link tag-link-116 tag-link-position-35\" style=\"font-size: 12.941176470588pt;\" aria-label=\"refactoring (3 items)\">refactoring</a> <a href=\"https://tomassetti.me/tag/review/\" class=\"tag-cloud-link tag-link-102 tag-link-position-36\" style=\"font-size: 10.964705882353pt;\" aria-label=\"review (2 items)\">review</a> <a href=\"https://tomassetti.me/tag/roslyn/\" class=\"tag-cloud-link tag-link-99 tag-link-position-37\" style=\"font-size: 14.588235294118pt;\" aria-label=\"Roslyn (4 items)\">Roslyn</a> <a href=\"https://tomassetti.me/tag/sparkweb/\" class=\"tag-cloud-link tag-link-85 tag-link-position-38\" style=\"font-size: 14.588235294118pt;\" aria-label=\"SparkWeb (4 items)\">SparkWeb</a> <a href=\"https://tomassetti.me/tag/static-analysis/\" class=\"tag-cloud-link tag-link-104 tag-link-position-39\" style=\"font-size: 10.964705882353pt;\" aria-label=\"static-analysis (2 items)\">static-analysis</a> <a href=\"https://tomassetti.me/tag/testing/\" class=\"tag-cloud-link tag-link-25 tag-link-position-40\" style=\"font-size: 8pt;\" aria-label=\"testing (1 item)\">testing</a> <a href=\"https://tomassetti.me/tag/tools/\" class=\"tag-cloud-link tag-link-107 tag-link-position-41\" style=\"font-size: 12.941176470588pt;\" aria-label=\"tools (3 items)\">tools</a> <a href=\"https://tomassetti.me/tag/tripadvisor/\" class=\"tag-cloud-link tag-link-120 tag-link-position-42\" style=\"font-size: 12.941176470588pt;\" aria-label=\"TripAdvisor (3 items)\">TripAdvisor</a> <a href=\"https://tomassetti.me/tag/tutorial/\" class=\"tag-cloud-link tag-link-134 tag-link-position-43\" style=\"font-size: 17.882352941176pt;\" aria-label=\"tutorial (7 items)\">tutorial</a> <a href=\"https://tomassetti.me/tag/web/\" class=\"tag-cloud-link tag-link-98 tag-link-position-44\" style=\"font-size: 10.964705882353pt;\" aria-label=\"web (2 items)\">web</a> <a href=\"https://tomassetti.me/tag/webassembly/\" class=\"tag-cloud-link tag-link-105 tag-link-position-45\" style=\"font-size: 10.964705882353pt;\" aria-label=\"WebAssembly (2 items)\">WebAssembly</a></div> <span class=\"seperator extralight-border\"></span></section></div><div class=\"flex_column av_one_fourth el_after_av_one_fourth el_before_av_one_fourth \"><section id=\"custom_html-5\" class=\"widget_text widget clearfix widget_custom_html\"><h3 class=\"widgettitle\">Don’t miss the next updates!</h3><div class=\"textwidget custom-html-widget\"><div class=\"tve-leads-shortcode tve-tl-anim tl-anim-instant tve-leads-track-shortcode_4566 tve-leads-triggered\"><div class=\"tl-style\" id=\"tve_tcb2_blank\" data-state=\"98\" data-form-state=\"\"><style type=\"text/css\" class=\"tve_custom_style\">@media (min-width: 300px){[data-css=\"tve-u-15e429e013292c\"] { max-width: 100%; margin-top: 0px !important; margin-bottom: 0px !important; padding: 0px !important; }:not(#tve) [data-css=\"tve-u-25e429e013292d\"] button { text-transform: uppercase; background-image: none !important; background-color: rgb(234, 145, 48) !important; font-weight: bold !important; }[data-css=\"tve-u-05e429e0132927\"] { display: inline-block; padding: 10px !important; margin-bottom: 0px !important; margin-top: 0px !important; background-color: rgb(252, 252, 252) !important; }}</style><style type=\"text/css\" class=\"tve_user_custom_style\">.tve-leads-conversion-object .thrv_heading h1,.tve-leads-conversion-object .thrv_heading h2,.tve-leads-conversion-object .thrv_heading h3{margin:0;padding:0}.tve-leads-conversion-object .thrv_text_element p,.tve-leads-conversion-object .thrv_text_element h1,.tve-leads-conversion-object .thrv_text_element h2,.tve-leads-conversion-object .thrv_text_element h3{margin:0}</style><style type=\"text/css\" class=\"tve_global_style\"></style><div class=\"tve-leads-conversion-object\" data-tl-type=\"shortcode_4566\"><div class=\"tve_flt\"><div id=\"tve_editor\" class=\"tve_shortcode_editor\"><div class=\"thrv-leads-form-box tve_no_drag tve_no_icons thrv_wrapper tve_editor_main_content tve_empty_dropzone\" data-css=\"tve-u-05e429e0132927\"><div class=\"thrv_wrapper thrv_contentbox_shortcode thrv-content-box\" data-css=\"tve-u-15e429e013292c\"><div class=\"tve-content-box-background\"></div><div class=\"tve-cb tve_empty_dropzone\"><div class=\"thrv_wrapper thrv_text_element tve_empty_dropzone\"><p>Want to join over 10.000+ people that keep learning more about DSLs, parsers, interpreters, compilers and language design?</p></div><div class=\"thrv_wrapper thrv_lead_generation\" data-connection=\"api\"><input class=\"tve-lg-err-msg\" value=\"{&quot;email&quot;:&quot;Email address invalid&quot;,&quot;phone&quot;:&quot;Phone number invalid&quot;,&quot;password&quot;:&quot;Password invalid&quot;,&quot;passwordmismatch&quot;:&quot;Password mismatch error&quot;,&quot;required&quot;:&quot;Required field missing&quot;}\" type=\"hidden\"><div class=\"thrv_lead_generation_container tve_clearfix\"><form action=\"#\" method=\"post\" novalidate=\"\"><div class=\"tve_lead_generated_inputs_container tve_clearfix tve_empty_dropzone\"><div class=\"tve_lg_input_container tve_lg_input\"><input data-field=\"email\" data-required=\"1\" data-validation=\"email\" name=\"email\" placeholder=\"Email\" data-placeholder=\"Email\" class=\"\" type=\"email\"></div><div class=\"tve_lg_input_container tve_submit_container tve_lg_submit\" data-css=\"tve-u-25e429e013292d\" data-tcb_hover_state_parent=\"\"><button type=\"submit\" class=\"tve-froala\">Count Me In!</button></div></div><input id=\"_submit_option\" name=\"_submit_option\" value=\"redirect\" type=\"hidden\"><input id=\"_back_url\" name=\"_back_url\" value=\"https://tomassetti.me/thank-you\" type=\"hidden\"><input id=\"_autofill\" name=\"_autofill\" value=\"\" type=\"hidden\"><input name=\"__tcb_lg_fc\" id=\"__tcb_lg_fc\" value=\"YToxOntzOjEwOiJjb252ZXJ0a2l0IjtzOjc6IjUwMDA4OTAiO30=\" type=\"hidden\"></form></div></div></div></div></div></div></div></div></div></div></div><span class=\"seperator extralight-border\"></span></section></div></div></div><footer class=\"container_wrap socket_color\" id=\"socket\" role=\"contentinfo\" itemscope=\"itemscope\" itemtype=\"https://schema.org/WPFooter\"><div class=\"container\"> <span class=\"copyright\">© 2018 Strumenta | <a href=\"https://strumenta.com/privacy-policy/\">Privacy Policy of Strumenta Websites</a></span><ul class=\"noLightbox social_bookmarks icon_count_4\"><li class=\"social_bookmarks_twitter av-social-link-twitter social_icon_1\"><a target=\"_blank\" aria-label=\"Link to Twitter\" href=\"https://twitter.com/ftomasse\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\" title=\"Twitter\"><span class=\"avia_hidden_link_text\">Twitter</span></a></li><li class=\"social_bookmarks_linkedin av-social-link-linkedin social_icon_2\"><a target=\"_blank\" aria-label=\"Link to Linkedin\" href=\"https://ie.linkedin.com/in/federicotomassetti\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\" title=\"Linkedin\"><span class=\"avia_hidden_link_text\">Linkedin</span></a></li><li class=\"social_bookmarks_mail av-social-link-mail social_icon_3\"><a aria-label=\"Link to Mail\" href=\"mailto:federico@tomassetti.me\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\" title=\"Mail\"><span class=\"avia_hidden_link_text\">Mail</span></a></li><li class=\"social_bookmarks_rss av-social-link-rss social_icon_4\"><a aria-label=\"Link to Rss this site\" href=\"https://tomassetti.me/feed/\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\" title=\"Rss\"><span class=\"avia_hidden_link_text\">Rss</span></a></li></ul></div></footer></div> <a class=\"avia-post-nav avia-post-prev with-image\" href=\"https://tomassetti.me/quick-domain-specific-languages-in-python-with-textx/\"> <span class=\"label iconfont\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\"></span> <span class=\"entry-info-wrap\"> <span class=\"entry-info\"> <span class=\"entry-title\">Quick Domain-Specific Languages in Python with textX</span> <span class=\"entry-image\"><img width=\"80\" height=\"80\" src=\"data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2080%2080'%3E%3C/svg%3E\" class=\"attachment-thumbnail size-thumbnail wp-post-image\" alt=\"\" data-lazy-srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Quick-Domain-Specific-Languages-in-Python-with-textX-2-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Quick-Domain-Specific-Languages-in-Python-with-textX-2-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Quick-Domain-Specific-Languages-in-Python-with-textX-2-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Quick-Domain-Specific-Languages-in-Python-with-textX-2-120x120.jpg 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Quick-Domain-Specific-Languages-in-Python-with-textX-2-450x450.jpg 450w\" data-lazy-sizes=\"(max-width: 80px) 100vw, 80px\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Quick-Domain-Specific-Languages-in-Python-with-textX-2-80x80.jpg\"><noscript><img width=\"80\" height=\"80\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Quick-Domain-Specific-Languages-in-Python-with-textX-2-80x80.jpg\" class=\"attachment-thumbnail size-thumbnail wp-post-image\" alt=\"\" srcset=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Quick-Domain-Specific-Languages-in-Python-with-textX-2-80x80.jpg 80w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Quick-Domain-Specific-Languages-in-Python-with-textX-2-36x36.jpg 36w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Quick-Domain-Specific-Languages-in-Python-with-textX-2-180x180.jpg 180w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Quick-Domain-Specific-Languages-in-Python-with-textX-2-120x120.jpg 120w, https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/04/Quick-Domain-Specific-Languages-in-Python-with-textX-2-450x450.jpg 450w\" sizes=\"(max-width: 80px) 100vw, 80px\" /></noscript></span> </span> </span></a></div> <a href=\"#top\" title=\"Scroll to top\" id=\"scroll-top-link\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\"><span class=\"avia_hidden_link_text\">Scroll to top</span></a><div id=\"fb-root\"></div><div class=\"avia-cookie-consent avia-cookiemessage-bottom-left\"><div class=\"container\"><p class=\"avia_cookie_text\">This site uses cookies. By continuing to browse the site, you are agreeing to our use of cookies.</p> <a href=\"https://strumenta.com/privacy-policy\" class=\"avia-button avia-cookie-consent-button avia-cookie-consent-button-1 av-extra-cookie-btn\">Privacy Policy of Strumenta Websites</a><a href=\"#\" class=\"avia-button avia-cookie-consent-button avia-cookie-consent-button-2 avia-cookie-close-bar \" data-contents=\"a6fe7a635a3ae90b600d28d9abace894\">OK</a></div></div> <script>function aggiungiAttributiAnalytics() {\n        var fakeurl = document.URL;\n        if(document.location.search.length > 0)\n        {\n            let params = new URLSearchParams(document.location.search.substring(1));    \n            fakeurl = params.get(\"da\");\n        }\n\tga('send', {\n\t\thitType: 'event',\n\t\teventCategory: 'Link',\n\t\teventAction: 'click',\n\t\teventLabel: this.textContent,\n\t\tdimension1: fakeurl,\n\t\tdimension2: this.href,\n\t\ttransport: 'beacon'\n\t});\n}\n\n// aggiungi attributi ai link per tracciamento\nfor (var ls = document.getElementsByTagName(\"a\"), numLinks = ls.length, i=0; i<numLinks; i++){    \n        ls[i].addEventListener(\"click\", aggiungiAttributiAnalytics, false);\n\tls[i].addEventListener(\"auxclick\", aggiungiAttributiAnalytics, false);\n\tls[i].addEventListener(\"contextmenu\", aggiungiAttributiAnalytics, false);\n}\n\nfor (var lsb = document.getElementsByTagName(\"button\"), numLinks = lsb.length, i=0; i<numLinks; i++){    \n        lsb[i].addEventListener(\"click\", aggiungiAttributiAnalytics, false);\n\tlsb[i].addEventListener(\"auxclick\", aggiungiAttributiAnalytics, false);\n\tlsb[i].addEventListener(\"contextmenu\", aggiungiAttributiAnalytics, false);\n}\n\nfunction track_checkout(price, item) {\n    fbq('track', 'InitiateCheckout', {\n      content_name: item,\n      value: price,\n      currency: 'USD'\n    });\n}\n// aggiungi tracciamento delle riproduzioni audio\njQuery(\"#amazon-ai-player\").on(\"play\", function (e) {\n    ga('send', {\n        hitType: 'event',\n        eventCategory: 'Audio',\n        eventAction: 'play',\n        eventLabel: document.title.substr(0, document.title.search(\" - Federico Tomassetti\"))\n    });\n});\n\n// Find all YouTube and Vimeo videos\nvar allVideos = jQuery(\"iframe[src*='//player.vimeo.com'], iframe[src*='//www.youtube.com']\"),\n\n    // The element that is fluid width\n    fluidEl = jQuery(\"body\");\n\n// Figure out and save aspect ratio for each video\nallVideos.each(function() {\n  jQuery(this)\n    .data('aspectRatio', this.height / this.width)\n\n    // and remove the hard coded width/height\n    .removeAttr('height')\n    .removeAttr('width');\n\n});\n\n// When the window is resized\njQuery(window).resize(function() {\n\n  var newWidth = fluidEl.width();\n\n  // Resize all videos according to their own aspect ratio\n  allVideos.each(function() {\n\n    var el = jQuery(this);\n    el\n      .width(newWidth)\n      .height(newWidth * el.data('aspectRatio'));\n\n  });\n\n// Kick off one resize to fix all videos on page load\n}).resize();</script> <div id=\"sb_super_bar\" class=\"orange\" style=\"display: none;\"><div class=\"sbprogress-container\"><span class=\"sbprogress-bar\" style=\"width: 1.1212%;\"></span></div><div id=\"sb_main_bar\"><div class=\"sb_text-size\"> <a href=\"https://tomassetti.me/category/language-engineering/antlr/\">ANTLR</a></div><div class=\"sb_post-data\"><h2> Parsing SQL</h2> <span class=\"sb_author\">by Gabriele Tomassetti</span> <span class=\"sb_ttr\">time to read: 22 min</span></div><div class=\"sb_prev-next-posts\"> <a href=\"https://tomassetti.me/why-you-should-not-use-flex-yacc-and-bison/\"><i class=\"sbicn-left-open-1\"></i></a><div class=\"sb_next_post\"><div class=\"sb_next_post_image\"> <img src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-205x155.jpg\" alt=\"\" data-lazy-src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-205x155.jpg\" class=\"lazyloaded\" data-was-processed=\"true\"><noscript><img src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/uploads/2020/03/Why-you-should-not-use-flex-yacc-and-bison-205x155.jpg\" alt=\"\"></noscript></div><div class=\"sb_next_post_info\"> <span class=\"sb_title\"> <span class=\"sb_category\"> Application modernization </span> <span class=\"sb_tcategory\"> Why you should not use (f)lex, yacc and bison </span> </span></div></div></div><ul class=\"sb_share \"><li class=\"sbfacebook\"> <a href=\"#\" title=\"Share on Facebook\" class=\"sbsoc-fb\" target=\"_blank\"><i class=\"sbicn-facebook\"></i> </a></li><li class=\"sbtwitter\"> <a href=\"#\" data-via=\"\" data-title=\"Parsing SQL\" title=\"Share on Twitter\" class=\"sbsoc-tw\" target=\"_blank\"><i class=\"sbicn-twitter\"></i> </a></li><li class=\"sblinkedin\"> <a href=\"#\" title=\"Share on Linkedin\" class=\"sbsoc-linked\" target=\"_blank\"><i class=\"sbicn-linkedin\"></i> </a></li></ul></div></div> <script type=\"text/javascript\">/* <![CDATA[ */ var avia_framework_globals = avia_framework_globals || {};\n    avia_framework_globals.frameworkUrl = 'https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/themes/enfold/framework/';\n    avia_framework_globals.installedAt = 'https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/themes/enfold/';\n    avia_framework_globals.ajaxurl = 'https://tomassetti.me/wp-admin/admin-ajax.php'; /* ]]> */</script> <div class=\"tve-leads-slide-in tve-tl-anim tve-leads-track-slide_in-136 tl-anim-slide_right tl_bot_right tve-trigger-hide\"><div class=\"tl-style\" id=\"tve_tcb2_overlayed-patterns-1-step\" data-state=\"136\" data-form-state=\"\"><style type=\"text/css\" class=\"tve_custom_style\">@import url(\"//fonts.googleapis.com/css?family=Cabin:400,600,700,500&subset=latin\");@import url(\"//fonts.googleapis.com/css?family=Allerta+Stencil:400,&subset=latin\");@media (min-width: 300px){:not(#tve) [data-css=\"tve-u-185cadb3c8624cf\"] strong { font-weight: 600; }[data-css=\"tve-u-35cadb3c862135\"] h3 { margin: 0px !important; padding: 0px !important; }[data-css=\"tve-u-35cadb3c862135\"] h2 { margin: 0px !important; padding: 0px !important; }[data-css=\"tve-u-35cadb3c862135\"] h1 { margin: 0px !important; padding: 0px !important; }[data-css=\"tve-u-35cadb3c862135\"] p { margin: 0px !important; padding: 0px !important; }[data-css=\"tve-u-05cadb3c86207a\"] { padding: 15px 0px 15px 15px !important; max-width: 720px !important; background-color: rgba(222, 222, 222, 0.01) !important; }:not(#tve) [data-css=\"tve-u-175cadb3c862493\"]:hover input { border-bottom: 1px solid rgba(255, 255, 255, 0.8) !important; }:not(#tve) [data-css=\"tve-u-185cadb3c8624cf\"]:hover button { border-color: rgb(255, 255, 255) !important; background-image: repeating-radial-gradient(circle at center center, rgba(244, 67, 54, 0.4), rgba(244, 67, 54, 0.4) 1px, transparent 1px, transparent 100%) !important; background-size: 3px 3px !important; background-position: 50% 50% !important; background-attachment: scroll !important; background-repeat: repeat !important; }:not(#tve) [data-css=\"tve-u-185cadb3c8624cf\"] button { border-color: rgb(255, 255, 255); color: rgb(244, 67, 54); font-family: Cabin; font-weight: 700; font-size: 16px; line-height: 1.12em; letter-spacing: 2px; background-image: none !important; background-color: rgb(255, 255, 255) !important; margin: 0px !important; }:not(#tve) [data-css=\"tve-u-175cadb3c862493\"] input { border-color: currentcolor currentcolor rgb(255, 255, 255); border-style: none none solid; border-width: medium medium 1px; border-image: initial; font-family: Cabin; font-weight: 400; font-size: 18px; letter-spacing: 1px; line-height: 1.12em; background-image: none !important; margin-top: 0px !important; background-color: rgba(233, 236, 239, 0) !important; }:not(#tve) [data-css=\"tve-u-175cadb3c862493\"] input, :not(#tve) [data-css=\"tve-u-175cadb3c862493\"] input::placeholder { color: rgb(255, 255, 255) !important; }[data-css=\"tve-u-165cadb3c862456\"] { float: none; margin: 0px auto !important; padding: 0px !important; }[data-css=\"tve-u-85cadb3c862272\"] { margin-bottom: 0px !important; background-image: linear-gradient(rgb(19, 19, 19), rgb(19, 19, 19)) !important; background-size: auto !important; background-position: 50% 50% !important; background-attachment: scroll !important; background-repeat: no-repeat !important; padding-right: 0px !important; }[data-css=\"tve-u-95cadb3c8622af\"] img { filter: grayscale(0%) blur(0px); opacity: 1; }[data-css=\"tve-u-115cadb3c862327\"] { padding: 40px 40px 0px 0px !important; margin-top: 0px !important; }[data-css=\"tve-u-105cadb3c8622eb\"] { max-width: 61.9%; }[data-css=\"tve-u-75cadb3c862236\"] { max-width: 38.1%; }[data-css=\"tve-u-55cadb3c8621ad\"] { margin: 0px !important; }[data-css=\"tve-u-65cadb3c8621f4\"] { margin-left: -44px; padding: 0px !important; }[data-css=\"tve-u-65cadb3c8621f4\"] > .tcb-flex-col { padding-left: 44px; }[data-css=\"tve-u-95cadb3c8622af\"] { width: 240px; top: 70px; box-shadow: none; left: 0px; margin-top: 0px !important; margin-bottom: 0px !important; padding-top: 0px !important; display: block; }[data-css=\"tve-u-35cadb3c862135\"] { min-height: 265px !important; }[data-css=\"tve-u-25cadb3c8620f9\"] { background-color: rgb(19, 19, 19) !important; background-image: linear-gradient(rgb(19, 19, 19), rgb(19, 19, 19)) !important; background-size: auto !important; background-position: 50% 50% !important; background-attachment: scroll !important; background-repeat: no-repeat !important; }[data-css=\"tve-u-15cadb3c8620bc\"] { padding: 0px 0px 50px !important; margin-top: 0px !important; }[data-css=\"tve-u-155cadb3c86241a\"] { line-height: 1.4em !important; }[data-css=\"tve-u-145cadb3c8623db\"] { padding: 0px !important; margin-bottom: 20px !important; }:not(#tve) [data-css=\"tve-u-155cadb3c86241a\"] { color: rgb(156, 156, 156) !important; font-family: Cabin !important; font-weight: 400 !important; font-size: 16px !important; }[data-css=\"tve-u-135cadb3c86239f\"] { line-height: 1.2em !important; }:not(#tve) [data-css=\"tve-u-135cadb3c86239f\"] { font-family: \"Allerta Stencil\" !important; font-weight: 400 !important; color: rgb(255, 255, 255) !important; font-size: 26px !important; }[data-css=\"tve-u-125cadb3c862363\"] { max-width: 438px; float: none; padding: 0px !important; margin-bottom: 20px !important; margin-left: auto !important; margin-right: auto !important; }:not(#tve) [data-css=\"tve-u-45cadb3c862171\"]:hover > :first-child { color: rgb(244, 67, 54) !important; }:not(#tve) [data-css=\"tve-u-45cadb3c862171\"]:hover { background-image: linear-gradient(rgba(1, 1, 1, 0.5), rgba(1, 1, 1, 0.5)) !important; background-size: auto !important; background-position: 0px 0px !important; background-attachment: scroll !important; background-repeat: no-repeat !important; }[data-css=\"tve-u-45cadb3c862171\"] { font-size: 14px; width: 14px; height: 14px; color: rgb(255, 255, 255); border: medium none; border-radius: 0px; overflow: hidden; position: absolute; right: 0px; top: 0px; z-index: 10; background-image: linear-gradient(rgba(1, 1, 1, 0.2), rgba(1, 1, 1, 0.2)) !important; padding: 15px !important; background-size: auto !important; background-position: 0px 0px !important; background-attachment: scroll !important; background-repeat: no-repeat !important; margin: 0px !important; }[data-css=\"tve-u-85cadb3c862272\"]::after { clear: both; }}@media (max-width: 1023px){[data-css=\"tve-u-85cadb3c862272\"] { margin: 0px !important; }[data-css=\"tve-u-15cadb3c8620bc\"] { margin-top: 0px !important; }[data-css=\"tve-u-95cadb3c8622af\"] { top: 24px; left: 0px; width: 304px; }}@media (max-width: 767px){[data-css=\"tve-u-25cadb3c8620f9\"] { background-color: rgb(19, 19, 19) !important; }:not(#tve) [data-css=\"tve-u-155cadb3c86241a\"] { font-size: 14px !important; }[data-css=\"tve-u-65cadb3c8621f4\"] { margin-left: 0px; }[data-css=\"tve-u-65cadb3c8621f4\"] > .tcb-flex-col { padding-left: 0px; }:not(#tve) [data-css=\"tve-u-135cadb3c86239f\"] { font-size: 20px !important; }[data-css=\"tve-u-05cadb3c86207a\"] { max-width: 270px !important; padding: 0px !important; background-color: rgba(222, 222, 222, 0.01) !important; }[data-css=\"tve-u-65cadb3c8621f4\"] .tcb-flex-col { flex-basis: 265px !important; }[data-css=\"tve-u-15cadb3c8620bc\"] { margin-top: 0px !important; padding-bottom: 0px !important; }[data-css=\"tve-u-115cadb3c862327\"] { padding: 20px !important; }[data-css=\"tve-u-125cadb3c862363\"] { margin-top: 0px !important; }[data-css=\"tve-u-95cadb3c8622af\"] { width: 100%; left: 0px; top: 0px; }[data-css=\"tve-u-45cadb3c862171\"] { top: 0px; right: 0px; background-image: linear-gradient(rgba(1, 1, 1, 0.48), rgba(1, 1, 1, 0.48)) !important; background-size: auto !important; background-position: 0px 0px !important; background-attachment: scroll !important; background-repeat: no-repeat !important; }}</style><style type=\"text/css\" class=\"tve_global_style\"></style><div class=\"tve-leads-conversion-object\" data-tl-type=\"slide_in\"><div class=\"tve_flt\"><div id=\"tve_editor\" class=\"tve_shortcode_editor\"><div class=\"thrv-leads-slide-in tve_no_drag tve_no_icons thrv_wrapper tve_editor_main_content tve_empty_dropzone\" data-css=\"tve-u-05cadb3c86207a\">\n<div class=\"thrv_wrapper thrv-page-section\" data-css=\"tve-u-15cadb3c8620bc\">\n<div class=\"tve-page-section-out\" data-css=\"tve-u-25cadb3c8620f9\"></div>\n<div class=\"tve-page-section-in tve_empty_dropzone\" data-css=\"tve-u-35cadb3c862135\"><div class=\"thrv_wrapper thrv_icon tcb-icon-display tve_evt_manager_listen tve_et_click tve_ea_thrive_leads_form_close\" data-css=\"tve-u-45cadb3c862171\" data-tcb-events=\"__TCB_EVENT_[{&quot;a&quot;:&quot;thrive_leads_form_close&quot;,&quot;t&quot;:&quot;click&quot;}]_TNEVE_BCT__\" data-tcb_hover_state_parent=\"\" data-float=\"1\">\n<svg class=\"tcb-icon\" viewBox=\"0 0 30 32\" data-name=\"close\">\n<path d=\"M0.655 2.801l1.257-1.257 27.655 27.655-1.257 1.257-27.655-27.655z\"></path>\n<path d=\"M28.31 1.543l1.257 1.257-27.655 27.655-1.257-1.257 27.655-27.655z\"></path>\n</svg>\n</div><div class=\"thrv_wrapper thrv-columns\" data-css=\"tve-u-55cadb3c8621ad\"><div class=\"tcb-flex-row tcb-resized v-2 tcb--cols--2\" data-css=\"tve-u-65cadb3c8621f4\"><div class=\"tcb-flex-col\" data-css=\"tve-u-75cadb3c862236\" style=\"\"><div class=\"tcb-col tve_empty_dropzone\" data-css=\"tve-u-85cadb3c862272\"><div class=\"thrv_wrapper tve_image_caption\" data-css=\"tve-u-95cadb3c8622af\"><span class=\"tve_image_frame\" style=\"width: 100%;\"><img class=\"tve_image\" alt=\"Creating a Programming Language\" title=\"Creating a Programming Language\" data-id=\"4854\" src=\"https://tomassetti.me/wp-content/uploads/2018/09/creating-programming-language-640.jpg\" style=\"width: 100%;\" scale=\"0\" width=\"640\" height=\"800\"></span></div></div></div><div class=\"tcb-flex-col\" data-css=\"tve-u-105cadb3c8622eb\" style=\"\"><div class=\"tcb-col tve_empty_dropzone\" data-css=\"tve-u-115cadb3c862327\"><div class=\"thrv_wrapper thrv_heading\" data-tag=\"h2\" data-css=\"tve-u-125cadb3c862363\"><h2 data-css=\"tve-u-135cadb3c86239f\" style=\"text-align: center;\">​Learn to Create Programming Languages</h2></div><div class=\"thrv_wrapper thrv_text_element tve_empty_dropzone\" data-css=\"tve-u-145cadb3c8623db\"><p data-css=\"tve-u-155cadb3c86241a\" style=\"text-align: center;\">Subscribe to ​our ​newsletter to get the FREE email course that teaches you how to create a programming language<br></p></div><div class=\"thrv_wrapper thrv_lead_generation\" data-connection=\"api\" data-css=\"tve-u-165cadb3c862456\"><input type=\"hidden\" class=\"tve-lg-err-msg\" value=\"{&quot;email&quot;:&quot;Email address invalid&quot;,&quot;phone&quot;:&quot;Phone number invalid&quot;,&quot;password&quot;:&quot;Password invalid&quot;,&quot;passwordmismatch&quot;:&quot;Password mismatch error&quot;,&quot;required&quot;:&quot;Required field missing&quot;}\">\n<div class=\"thrv_lead_generation_container tve_clearfix\">\n<form action=\"#\" method=\"post\" novalidate=\"novalidate\">\n<div class=\"tve_lead_generated_inputs_container tve_clearfix tve_empty_dropzone\">\n<div class=\"tve_lg_input_container tve_lg_input\" data-css=\"tve-u-175cadb3c862493\" data-tcb_hover_state_parent=\"\">\n<input type=\"email\" data-field=\"email\" data-required=\"1\" data-validation=\"email\" name=\"email\" placeholder=\"Email\" data-placeholder=\"Email\" class=\"\">\n</div>\n<div class=\"tve_lg_input_container tve_submit_container tve_lg_submit\" data-css=\"tve-u-185cadb3c8624cf\" data-tcb_hover_state_parent=\"\">\n<button type=\"submit\" class=\"tve-froala\">I want to create programming languages</button>\n</div>\n</div>\n<input id=\"_submit_option\" type=\"hidden\" name=\"_submit_option\" value=\"redirect\"><input id=\"_back_url\" type=\"hidden\" name=\"_back_url\" value=\"https://tomassetti.me/thank-you\"><input id=\"_autofill\" type=\"hidden\" name=\"_autofill\" value=\"\"><input type=\"hidden\" name=\"__tcb_lg_fc\" id=\"__tcb_lg_fc\" value=\"YToxOntzOjEwOiJjb252ZXJ0a2l0IjtzOjY6IjQ0Mjg1NyI7fQ==\"></form>\n</div>\n</div></div></div></div></div></div>\n</div></div></div></div></div></div></div><script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/js/avia-93d6ec4cf60db7cca150d7e0ad8aa2f7.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/js/shortcodes-a99528795d03cc2b63fdc255d187a939.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/contact/contact-f1cc2fdbf0ca4a2c3a4d22b591d5b71c.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/countdown/countdown-692361e31cf26adda95ef748d233cac2.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/gallery/gallery-c6f142774af7f32ecc5221618be6378f.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/iconlist/iconlist-49208438ba015017defa07c846d67e90.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/magazine/magazine-c8e42a67fb6deb1a8f1e6fa391ca14f2.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/slideshow/slideshow-4e2ef8a1b5c521040e13ed8bbbfa186e.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/slideshow/slideshow-video-ac90ef645ad034c5eefab66fa6a89b34.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/slideshow_layerslider/slideshow_layerslider-afc64a1e242444c675746481007edd51.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/tabs/tabs-7107ae0aa394534972c3ba2fba1386b6.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/testimonials/testimonials-a34346ab10d70074aaa423412acaeea4.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/video/video-8ea131869a7170637e7179f41919b89f.js\" defer=\"\"></script> <script type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/busting/1/wp-includes/js/imagesloaded.min-3.2.0.js\" defer=\"\"></script> <script type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/busting/1/wp-includes/js/masonry.min-3.3.2.js\" defer=\"\"></script> <script type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/busting/1/wp-includes/js/jquery/jquery.masonry.min-3.1.2b.js\" defer=\"\"></script> <script type=\"text/javascript\">/* <![CDATA[ */ var tve_frontend_options = {\"is_editor_page\":\"\",\"page_events\":[],\"is_single\":\"1\",\"ajaxurl\":\"https:\\/\\/tomassetti.me\\/wp-admin\\/admin-ajax.php\",\"social_fb_app_id\":\"\",\"dash_url\":\"https:\\/\\/tomassetti.me\\/wp-content\\/plugins\\/thrive-leads\\/thrive-dashboard\",\"translations\":{\"Copy\":\"Copy\"},\"post_id\":\"6033\",\"ip\":\"159.69.183.149\",\"current_user\":[],\"post_title\":\"Parsing SQL\",\"post_type\":\"post\",\"post_url\":\"https:\\/\\/tomassetti.me\\/parsing-sql\\/\",\"is_lp\":\"\",\"post_request_data\":[]}; /* ]]> */</script> <script type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/busting/1/wp-content/plugins/thrive-leads/tcb/editor/js/dist/frontend.min-2.5.2.2.js\" defer=\"\"></script> <script type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/busting/1/wp-content/plugins/thrive-leads/js/frontend.min-2.2.13.2.js\" defer=\"\"></script> <script type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/busting/1/wp-content/themes/enfold/js/aviapopup/jquery.magnific-popup.min-4.5.7.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/js/avia-snippet-lightbox-af571128e5a33c2149c945f8f248ec6e.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/js/avia-snippet-sticky-header-0003c940c03fb51010c9767adb23a28b.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/js/avia-snippet-cookieconsent-d28d2866b8e8786beac2ca70e78174f7.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/js/avia-snippet-widget-3775c407ef28ce425c794ad4be7c563f.js\" defer=\"\"></script> <script type=\"text/javascript\">/* <![CDATA[ */ var tve_dash_front = {\"ajaxurl\":\"https:\\/\\/tomassetti.me\\/wp-admin\\/admin-ajax.php\",\"force_ajax_send\":\"1\",\"is_crawler\":\"\"}; /* ]]> */</script> <script type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/busting/1/wp-content/plugins/thrive-leads/thrive-dashboard/js/dist/frontend.min-2.2.14.2.js\" defer=\"\"></script> <script type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/busting/1/wp-content/plugins/q2w3-fixed-widget/js/q2w3-fixed-widget.min-5.1.9.js\" defer=\"\"></script> <script type=\"text/javascript\" src=\"//cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js\"></script> <script type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/busting/1/wp-content/plugins/enlighter/resources/EnlighterJS.min-3.11.0.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/plugins/enlighter/cache/EnlighterJS.init-08b8fc7f4497d8570568ea2382b711c3.js\" defer=\"\"></script> <script data-minify=\"1\" type=\"text/javascript\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/framework/js/conditional_load/avia_google_maps_front-16af321c42711ae8ac9dc4be6671c549.js\" defer=\"\"></script> <script type=\"text/javascript\">var tcb_post_lists=JSON.parse('[]');</script><script type=\"text/javascript\">/* <![CDATA[ */ /*<![CDATA[*/if ( !window.TL_Const ) {var TL_Const={\"security\":\"cf3b3e4dc6\",\"ajax_url\":\"https:\\/\\/tomassetti.me\\/wp-admin\\/admin-ajax.php\",\"forms\":[],\"action_conversion\":\"tve_leads_ajax_conversion\",\"action_impression\":\"tve_leads_ajax_impression\",\"ajax_load\":1,\"main_group_id\":4352,\"display_options\":{\"allowed_post_types\":[],\"flag_url_match\":false},\"shortcode_ids\":[\"4566\"],\"custom_post_data\":[],\"current_screen\":{\"screen_type\":4,\"screen_id\":6033},\"ignored_fields\":[\"email\",\"_captcha_size\",\"_captcha_theme\",\"_captcha_type\",\"_submit_option\",\"_use_captcha\",\"g-recaptcha-response\",\"__tcb_lg_fc\",\"__tcb_lg_msg\",\"_state\",\"_form_type\",\"_error_message_option\",\"_back_url\",\"_submit_option\",\"url\",\"_asset_group\",\"_asset_option\",\"mailchimp_optin\"]};} else {ThriveGlobal.$j.extend(true, TL_Const, {\"security\":\"cf3b3e4dc6\",\"ajax_url\":\"https:\\/\\/tomassetti.me\\/wp-admin\\/admin-ajax.php\",\"forms\":[],\"action_conversion\":\"tve_leads_ajax_conversion\",\"action_impression\":\"tve_leads_ajax_impression\",\"ajax_load\":1,\"main_group_id\":4352,\"display_options\":{\"allowed_post_types\":[],\"flag_url_match\":false},\"shortcode_ids\":[\"4566\"],\"custom_post_data\":[],\"current_screen\":{\"screen_type\":4,\"screen_id\":6033},\"ignored_fields\":[\"email\",\"_captcha_size\",\"_captcha_theme\",\"_captcha_type\",\"_submit_option\",\"_use_captcha\",\"g-recaptcha-response\",\"__tcb_lg_fc\",\"__tcb_lg_msg\",\"_state\",\"_form_type\",\"_error_message_option\",\"_back_url\",\"_submit_option\",\"url\",\"_asset_group\",\"_asset_option\",\"mailchimp_optin\"]})} /*]]> */ /* ]]> */</script><script>(function( $ ) {\n      \"use strict\";\n\t\t$(function() {\n\t\t\tvar $allVideos = $(\"iframe[src^='https://www.youtube.com']\"),\n\t\t\t    // The element that is fluid width\n\t\t\t    $fluidEl = $(\".post-entry-type-standard\");\n\n\t\t\t\t$allVideos.each(function() {\nconsole.log(\"video found\");\n\t\t\t\t\t$(this)\n\t\t\t\t\t\t.data('aspectRatio', this.height / this.width)\n\t\t\t\t\t\t.removeAttr('height')\n\t\t\t\t\t\t.removeAttr('width')\n\t\t\t\t\t    .removeAttr('style');\n\n\t\t\t\t});\n\n\t\t\t\t$(window).resize(function() {\n\n\t\t\t\t\tvar newWidth = $fluidEl.width();\n\t\t\t\t\tvar newHeight = 0;\n\t\t\t\t\tif(newWidth < 426)\n\t\t\t\t\t{\n\t\t\t\t\t\tnewWidth = 426;\n\t\t\t\t\t\tnewHeight = 240;\n\t\t\t\t\t}\n\t\t\t\t\telse if(newWidth >= 426 && newWidth < 640)\n\t\t\t\t\t{\n\t\t\t\t\t\tnewWidth = 426;\n\t\t\t\t\t\tnewHeight = 240;\n\t\t\t\t\t}\t\t\t\t\t\n\t\t\t\t\telse if(newWidth >= 640 && newWidth < 768)\n\t\t\t\t\t{\n\t\t\t\t\t\tnewWidth = 640;\n\t\t\t\t\t\tnewHeight = 360;\n\t\t\t\t\t}\t\t\t\t\t\n\t\t\t\t\telse if(newWidth >= 768 && newWidth < 800)\n\t\t\t\t\t{\n\t\t\t\t\t\tnewWidth = 768;\n\t\t\t\t\t\tnewHeight = 432;\n\t\t\t\t\t}\n\t\t\t\t\telse if(newWidth >= 800 && newWidth < 960)\n\t\t\t\t\t{\n\t\t\t\t\t\tnewWidth = 800;\n\t\t\t\t\t\tnewHeight = 450;\n\t\t\t\t\t}\n\t\t\t\t\telse if(newWidth >= 960 && newWidth < 1024)\n\t\t\t\t\t{\n\t\t\t\t\t\tnewWidth = 960;\n\t\t\t\t\t\tnewHeight = 540;\n\t\t\t\t\t}\n\t\t\t\t\telse if(newWidth >= 1024 && newWidth < 1280)\n\t\t\t\t\t{\n\t\t\t\t\t\tnewWidth = 1024;\n\t\t\t\t\t\tnewHeight = 576;\n\t\t\t\t\t}\n\t\t\t\t\telse if(newWidth >= 1280 && newWidth < 1366)\n\t\t\t\t\t{\n\t\t\t\t\t\tnewWidth = 1280;\n\t\t\t\t\t\tnewHeight = 720;\n\t\t\t\t\t}\n\t\t\t\t\telse if(newWidth >= 1366 && newWidth < 1600)\n\t\t\t\t\t{\n\t\t\t\t\t\tnewWidth = 1366;\n\t\t\t\t\t\tnewHeight = 768;\n\t\t\t\t\t}\n\t\t\t\t\telse if(newWidth >= 1600 && newWidth < 1920)\n\t\t\t\t\t{\n\t\t\t\t\t\tnewWidth = 1600;\n\t\t\t\t\t\tnewHeight = 900;\n\t\t\t\t\t}\n\t\t\t\t\telse if(newWidth >= 1920)\n\t\t\t\t\t{\n\t\t\t\t\t\tnewWidth = 1920;\n\t\t\t\t\t\tnewHeight = 1080;\n\t\t\t\t\t}\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t$allVideos.each(function() {\n\n\t\t\t\t\t\tvar $el = $(this);\n\t\t\t\t\t\t$el\n\t\t\t\t\t\t\t.width(newWidth)\n\t\t\t\t\t\t\t.height(newWidth / 16 * 10);\n\t\t\t\t\t});\n\t\t\t\t}).resize();\n\t\t});\n  }(jQuery));</script> <script>if(document.cookie.match(/aviaPrivacyGoogleTrackingDisabled/)){ window['ga-disable-UA-11421555-5'] = true; }</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){\n(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),\nm=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)\n})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');\n\nga('create', 'UA-11421555-5', 'auto', {'allowLinker': true});\nga(function(tracker) {\n      window.cid = tracker.get('clientId');\n});\nga('require', 'linker');\nga('linker:autoLink', ['strumenta.com', 'gumroad.com'] ); \n\n// anonimizza ip per ottemperare leggi privacy\nga('set', 'anonymizeIp', true);\n\n// invia visita come solito\nfunction delayGALoad(){\n   if(window.cid !== undefined){\n       ga('send', 'pageview',{'dimension4':  window.cid});\n   }else{\n       setTimeout(delayGALoad,50)\n   }\n}\ndelayGALoad();</script><script type=\"text/javascript\" src=\"https://stats.wp.com/e-202017.js\" async=\"async\" defer=\"defer\"></script> <script type=\"text/javascript\">_stq = window._stq || [];\n\t_stq.push([ 'view', {v:'ext',j:'1:8.4.2',blog:'70090124',post:'6033',tz:'2',srv:'tomassetti.me'} ]);\n\t_stq.push([ 'clickTrackerInit', '70090124', '6033' ]);</script> <script>window.lazyLoadOptions={elements_selector:\"img[data-lazy-src],.rocket-lazyload\",data_src:\"lazy-src\",data_srcset:\"lazy-srcset\",data_sizes:\"lazy-sizes\",class_loading:\"lazyloading\",class_loaded:\"lazyloaded\",threshold:300,callback_loaded:function(element){if(element.tagName===\"IFRAME\"&&element.dataset.rocketLazyload==\"fitvidscompatible\"){if(element.classList.contains(\"lazyloaded\")){if(typeof window.jQuery!=\"undefined\"){if(jQuery.fn.fitVids){jQuery(element).parent().fitVids()}}}}}};window.addEventListener('LazyLoad::Initialized',function(e){var lazyLoadInstance=e.detail.instance;if(window.MutationObserver){var observer=new MutationObserver(function(mutations){var image_count=0;var iframe_count=0;var rocketlazy_count=0;mutations.forEach(function(mutation){for(i=0;i<mutation.addedNodes.length;i++){if(typeof mutation.addedNodes[i].getElementsByTagName!=='function'){return}\nif(typeof mutation.addedNodes[i].getElementsByClassName!=='function'){return}\nimages=mutation.addedNodes[i].getElementsByTagName('img');is_image=mutation.addedNodes[i].tagName==\"IMG\";iframes=mutation.addedNodes[i].getElementsByTagName('iframe');is_iframe=mutation.addedNodes[i].tagName==\"IFRAME\";rocket_lazy=mutation.addedNodes[i].getElementsByClassName('rocket-lazyload');image_count+=images.length;iframe_count+=iframes.length;rocketlazy_count+=rocket_lazy.length;if(is_image){image_count+=1}\nif(is_iframe){iframe_count+=1}}});if(image_count>0||iframe_count>0||rocketlazy_count>0){lazyLoadInstance.update()}});var b=document.getElementsByTagName(\"body\")[0];var config={childList:!0,subtree:!0};observer.observe(b,config)}},!1)</script><script data-no-minify=\"1\" async=\"\" src=\"https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/plugins/wp-rocket/assets/js/lazyload/12.0/lazyload.min.js\"></script><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-grid-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/css/grid-e7f86a4957050d86bbdde2be4b2e329c.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-base-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/css/base-9ee43dd72bee9b2e9372a5d41dfb2cfd.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-layout-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/css/layout-9d9e2151e6dfc7e5f9e836d3932cd249.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-blog-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/blog/blog-18576e4bf2a5d29be26c86a7d9e1c867.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-postslider-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/postslider/postslider-989c704f7f2a809af837b8e670cd0853.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-button-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/buttons/buttons-134ef1e4b4f1459379c2fc85ac863cbe.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-buttonrow-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/buttonrow/buttonrow-e2c888d48bc63472adaaa4f495043db6.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-button-fullwidth-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/buttons_fullwidth/buttons_fullwidth-254d86a461616beaf79576d06cd34c20.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-catalogue-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/catalogue/catalogue-adbb6d96c9a1738e54bee68a79d32810.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-comments-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/comments/comments-8df61ebd5ffecb3e3d2e0f8dfdba3021.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-contact-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/contact/contact-0f3a49a8560a6238f55c9d2127ffeb76.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-countdown-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/countdown/countdown-7afa04e6b150c054d2c4789014570bac.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-gallery-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/gallery/gallery-7700f83f6eb0be9afd295fd2e1293fea.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-gridrow-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/grid_row/grid_row-a75f88bea377b403e886c709b5ad57cf.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-heading-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/heading/heading-b7dddd1ef4275029a57b9a1517182880.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-hr-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/hr/hr-be01ac5c2ab2e5bdbcfbf150e32877e0.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-icon-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/icon/icon-da0406313b8462d480e535bb05f5f50c.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-iconlist-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/iconlist/iconlist-6088b3605f42a243a31c7547c92e7daa.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-image-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/image/image-2da44520fb6135c9345d7a3f78d7f638.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-magazine-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/magazine/magazine-fc5022a0047a03c485f988cd70381467.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-promobox-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/promobox/promobox-0d9df544506622d9978fcde68065845b.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-slideshow-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/slideshow/slideshow-dba83fd5b8d30bff2fd33416275f9c68.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-slideshow-fullsize-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/slideshow_fullsize/slideshow_fullsize-fe118d93c104a09fe9cb8f20f63dadb2.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-slideshow-ls-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/slideshow_layerslider/slideshow_layerslider-a349afb13837bc36afbd868e155babf0.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-social-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/social_share/social_share-e981254c3b50efafac2cc9a1c1b9c905.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-tabs-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/tabs/tabs-a7a217b2cdef7d7317f82ac3ff818c81.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-testimonials-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/testimonials/testimonials-6b29171c1f09c44f76fc7f3b18ff6b98.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-module-video-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/config-templatebuilder/avia-shortcodes/video/video-907cc2ae456a4fc8839931e64a286834.css' type='text/css' media='all' /></noscript><noscript><link rel='stylesheet' id='wp-block-library-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-includes/css/dist/block-library/style.min.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='fi_buttons-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/plugins/feedly-insight/css/fi-buttons-deprecated-25fa38b71a8609678b12c06dbaad2860.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='sb_bar-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/plugins/swifty-bar/public/assets/css/sb-bar-public-bf0134b2d24b0c6e4e6b5423991a6d0f.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='tve_style_family_tve_flt-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/plugins/thrive-leads/tcb/editor/css/thrive_flat-3a109a78ff4eac71f3856ec4009d4665.css' type='text/css' media='all' /></noscript><noscript><link rel='stylesheet' id='tve_leads_forms-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/busting/1/wp-content/plugins/thrive-leads/editor-layouts/css/frontend-2.2.13.2.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-scs-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/css/shortcodes-143bf9025df50d4ca3f24aae5b70c92b.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-popup-css-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/js/aviapopup/magnific-popup-3aba24496166b48da31e47e534851e67.css' type='text/css' media='screen' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-lightbox-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/css/avia-snippet-lightbox-64cad3d2c9d77d18b77c1cf70633f581.css' type='text/css' media='screen' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-cookie-css-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/css/avia-snippet-cookieconsent-bedea0a358c588d449bdd7c4f95a5996.css' type='text/css' media='screen' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-widget-css-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/css/avia-snippet-widget-3bb4c2bac224a946f94a272008eeb881.css' type='text/css' media='screen' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-dynamic-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/uploads/dynamic_avia/tomassetti-214e93ce18069c712a9bbe7dca72a848.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-custom-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/enfold/css/custom-ea2bb2e63ecf88c9937492e1706413c4.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='avia-style-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/themes/tomassetti/style-b224b5538d82adcffaed3add5922da9b.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='easy_table_style-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/plugins/easy-table/themes/default/style-61380df45b9199a4a87f6de0f5c2f6ad.css' type='text/css' media='all' /></noscript><noscript><link rel='stylesheet' id='enlighter-local-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/busting/1/wp-content/plugins/enlighter/resources/EnlighterJS.min-3.11.0.css' type='text/css' media='all' /></noscript><noscript><link data-minify=\"1\" rel='stylesheet' id='jetpack_css-css' href='https://mk0tuzolorusfnc7thxk.kinstacdn.com/wp-content/cache/min/1/wp-content/plugins/jetpack/css/jetpack-cb9b5a4a54629bc9e9f25bd878449a45.css' type='text/css' media='all' /></noscript>\n<img src=\"https://pixel.wp.com/g.gif?v=ext&amp;j=1%3A8.4.2&amp;blog=70090124&amp;post=6033&amp;tz=2&amp;srv=tomassetti.me&amp;host=tomassetti.me&amp;ref=&amp;fcp=4457&amp;rand=0.3280368187613476\" alt=\":)\" width=\"6\" height=\"5\" id=\"wpstats\"><script type=\"text/javascript\">\n\t(function ($) {\n\tvar event_data = {\"form_id\":\"tve-leads-track-slide_in-136\",\"form_type\":\"slide_in\"},\n\t_percent = 0.2,\n\t$window = $(window);\n\tevent_data.source = 'scroll_percent';\n\t$(function () {\n\tvar _triggered = false,\n\t$element = $(\"#tve_leads_end_content\"),\n\t_check = function () {\n\tif (_triggered) {\n\treturn;\n\t}\n\n\tvar _h = $('body').height() - $window.height();\n\n\tif ($element.length) {\n\t_h = $element.offset().top - $window.height();\n\t}\n\n\tif ($window.scrollTop() / _h >= _percent) {\n\tThriveGlobal.$j(TL_Front).trigger('showform.thriveleads', event_data);\n\t_triggered = true;\n\t}\n\t};\n\t$window.scroll(_check);\n\t_check();\n\t\t/* Chrome has a stupid bug in which it triggers almost simultaneously \"mouseenter\" \"mouseleave\" \"mouseenter\" if the following applies:\n\t - at page load, the cursor is outside the html element\n\t - the user moves the cursor over the html element\n\t */\n\tvar chrome_fix_id = 0,\n\tme = function (e) { /* mouse enter */\n\tclearTimeout(chrome_fix_id);\n\t},\n\tml = function (e) {\n\n\tif (e.clientY <= config.s) {\n\tchrome_fix_id = setTimeout(function () {\n\tif (!_triggered) {\n\tThriveGlobal.$j(TL_Front).trigger('showform.thriveleads', event_data);\n\t_triggered = true;\n\t}\n\tc();\n\t}, 50);\n\t}\n\t},\n\tc = function () { // cancel\n\t$(document).off('mouseenter.exit_intent mouseleave.exit_intent');\n\t},\n\tconfig = { // we can adjust this and the code below to allow users to tweak settings\n\ts: 20 // sensitivity\n\t};\n\t$(document).on('mouseleave.exit_intent', ml)\n\t.on('mouseenter.exit_intent', me);\n\t\t});\n\t})\n(ThriveGlobal.$j);\n</script><script type=\"text/javascript\">\n\t(function ($) {\n\t$(function () {\n\t\tvar event_data = {\"form_id\":\"tve-leads-track-shortcode_4566\",\"form_type\":\"shortcode\"};\n\t\tevent_data.source = 'page_load';\n\t\tsetTimeout(function () {\n\t\t\tThriveGlobal.$j(TL_Front).trigger('showform.thriveleads', event_data);\n\t\t\t}, 200);\n\t\t});\n\t})\n(ThriveGlobal.$j);\n</script><script type=\"text/javascript\">var TVE_Event_Manager_Registered_Callbacks = TVE_Event_Manager_Registered_Callbacks || {};TVE_Event_Manager_Registered_Callbacks.thrive_leads_form_close = function(t, a, c){TL_Front.close_form(this, t, a, c); return false;};</script><link rel=\"stylesheet\" href=\"https://tomassetti.me/wp-admin/load-styles.php?c=1&amp;dir=ltr&amp;load%5Bchunk_0%5D=dashicons,wp-jquery-ui-dialog&amp;ver=5.4\" type=\"text/css\" media=\"all\">\n<link rel=\"stylesheet\" id=\"avia-media-style-css\" href=\"https://tomassetti.me/wp-content/themes/enfold/config-templatebuilder/avia-template-builder/assets/css/avia-media.css?ver=5.4\" media=\"all\">\n<link rel=\"stylesheet\" id=\"post-snippets-icons-css\" href=\"https://tomassetti.me/wp-content/plugins/post-snippets/assets/features.css?ver=3.0.18\" media=\"all\">\n<link rel=\"stylesheet\" id=\"post-snippets-features-css\" href=\"https://tomassetti.me/wp-content/plugins/post-snippets/assets/icons.css?ver=3.0.18\" media=\"all\">\n<link rel=\"stylesheet\" id=\"post-snippets-newsletter-css\" href=\"https://tomassetti.me/wp-content/plugins/post-snippets/assets/newsletter.css?ver=3.0.18\" media=\"all\">\n<link rel=\"stylesheet\" id=\"post-snippets-css\" href=\"https://tomassetti.me/wp-content/plugins/post-snippets/assets/post-snippets.css?ver=3.0.18\" media=\"all\">\n<script type=\"text/javascript\">var tcb_post_lists=JSON.parse('[]');</script>","text":"Twitter\nLinkedin\nMail\nRss\nServices\nProducts\nLearning to build languages\nLearning to process code\nUsing ANTLR Like a Professional\nNewsletter\nAbout me\nLet’s Talk\n\" aria-hidden=\"true\" data-av_icon=\"\" data-av_iconfont=\"entypo-fontello\" style=\"\">Search\nMenu\nBlog\nParsing SQL April 15, 2020/in ANTLR, Code processing, Parsing /by Gabriele Tomassetti\nYou can find the code presented in this article in the companion repository\nSQL is a language to handle data in a relational database. If you worked with data you have probably worked with SQL.\nIt is in the same league of HTML: maybe you never learned it formally but you kinda know how to use it. That is great because if you know SQL, you know how to handle data. However, it has limitations and when you hit them your only course of action might be to work with a traditional programming language. This does not necessarily mean migrating away from SQL. You might need to move from one SQL dialect to another one or to analyze the SQL code you use. And to do that, you need to parse SQL, and that is what this article is about.\nWhat are the limits of SQL? After a while you learn of a couple of issues:\nthere is not one SQL, but many variations of it. The SQLs implemented in SQLite, MySQL, PostgreSQL, etc. are all a bit different\nyou cannot do everything related to data in SQL. In some cases, you need a traditional programming language to work with the data\nThese issues became real problems when you need to make big changes. For instance, if you need to change the database used by a large application. It can also be a problem when you need to make transformations that SQL and your database cannot handle them. In that case, you have some transformations done in SQL (and run on the database) and some other in your source code. So you spend a lot of time working on glue code and around the limitations of SQL.\nSQL can also be a constraint, simply for what it lacks: unit testing integrated with your source code and all the other tools that you can use with Java, C#, etc. SQL is an old language and not designed for large scale programming, it is not a language that developers will love. Even worse, they will not be very productive with it. And what happens if your application requires you to verify that something gets executed in a certain way, or to offer some guarantees? It can be a business need or a regulatory requirement. Then you need to parse SQL or to find a way to move from SQL world to your programming language world.\nThat is what this article is about: parsing SQL. We are going to see ready-to-use libraries and tools to parse SQL, and an example project in which we will build our own SQL parser.\nWhat is SQL\nSQL (Structured Query Language) is a domain-specific language designed to handle data in relational database. It is a declarative language, so you describe what you want to achieve (e.g., get me a row of data with id=5) and not how to achieve it (e.g. loop through the rows until id=5). It has a formal mathematical foundation in relational algebra and calculus. The language is an ISO/IEC standard that is periodically updated, the latest version is SQL2016. This means that there is a very formal and clear description of the language if you need it.\nSQL is designed to handle many aspects of the life cycle of working with data: yes, you can query data, but you can also create the format of data (i.e., the schema of a table) and regulate access control to the data.\nSQL Procedural Extensions\nActual SQL implementation comes with procedural extensions that implement some form of procedural programming. These are even more varied from database engine to database engine. They were added to perform complex elaborations on the data directly on the database, so they can be as powerful as traditional programming languages. And this can also be an additional headache if you try to parse SQL. See, for instance, this is a PL/SQL (the procedural SQL from Oracle databases) example from Wikipedia.\nDECLARE var NUMBER;\nBEGIN /*N.B. for loop variables in pl/sql are new declarations, with scope only inside the loop */ FOR var IN 0 .. 10 LOOP DBMS_OUTPUT.PUT_LINE(var); END LOOP; IF (var IS NULL) THEN DBMS_OUTPUT.PUT_LINE('var is null'); ELSE DBMS_OUTPUT.PUT_LINE('var is not null'); END IF;\nEND;\nDECLARE\nvar NUMBER;\nBEGIN\n/*N.B. for loop variables in pl/sql are new declarations, with scope only inside the loop */\nFOR var IN 0 .. 10 LOOP\nDBMS_OUTPUT.PUT_LINE(var);\nEND LOOP;\nIF (var IS NULL) THEN\nDBMS_OUTPUT.PUT_LINE('var is null');\nELSE\nDBMS_OUTPUT.PUT_LINE('var is not null');\nEND IF;\nEND;\nDECLARE var NUMBER;\nBEGIN /*N.B. for loop variables in pl/sql are new declarations, with scope only inside the loop */ FOR var IN 0 .. 10 LOOP DBMS_OUTPUT.PUT_LINE(var); END LOOP; IF (var IS NULL) THEN DBMS_OUTPUT.PUT_LINE('var is null'); ELSE DBMS_OUTPUT.PUT_LINE('var is not null'); END IF;\nEND;\nResources\nAs we have seen handling SQL can be a daunting task, so let’s see a few resources to help you. They range from grammars to kick start your parsing efforts, to ready-to-use tools.\nKnowledgeOfficial Sources\nThe latest official SQL standard is formally known as ISO/IEC 9075 SQL:2016. You can find every information you need about it in the official sources either the ISO or IEC websites. However, keep in mind that there are several documents describing the standard and you have to pay for each of them. This means, depending on the exchange rate, the total cost could be more than 2,000 USD.\nOfficial References from Database Documentation\nOther than the official SQL standard, you can look up the official documentation of the database producers, which contains a reference for their SQL implementation. Here is a list of the few major ones:\nOracle PL/SQL Documentation\nMySQL 8 SQL Reference\nMicrosoft Transact-SQL Reference\nPostgreSQL 12 SQL Language\nIBM DB2 SQL\nSQL as understood by SQLite\nGrammars\nThere are a few (usually partial) grammars available in different formats. They can be a good starting point for getting where you need.\nBNF Grammars for SQL-92, SQL-99 and SQL-2003\nPartial Teradata SQL grammar for ANTLR4\nThe ANTLR v4 Grammars repository contains grammars for MySQL, PL/SQL, T-SQL and SQLite. In our ANTLR Course we analyze the SQLite grammar to explain its structure and how you can parse a declarative language like SQL.\nLibraries\nThere are many libraries to parse SQL in different languages. Some support different databases and different programming languages. Here it is a list of the most used ones. Unless otherwise noted, the libraries are released under an opensource license.\nMulti-lingual and/or multi-databases\nGeneral SQL Parser is a commercial library that supports many databases (DB2, Greenplum, Hana, Hive, Impala, Informix, MySQL, Netezza, Oracle, PostgreSQL, Redshift SQL Server, Sybase, and Teradata) and languages (C#, VB.NET, Java, C/C++, Delphi, VB). It can validate SQL syntax, format SQL and work with the parse tree\nJSqlParser parses an SQL statement and translates it into a hierarchy of Java classes. It is opensource, with a double LGPL and Apache license, and supports many databases: Oracle, SqlServer, MySQL, PostgreSQL, etc.\nMySQL parsers\nPingcap parser is a MySQL parser in Go.\nxwb1989/sqlparser is a MySQL parser for Go. This parser has been extracted from Vitess, a database clustering system for horizontal scaling of MySQL.\nPHP SQL Parser is a (mainly) MySQL (non-validating) parser written in PHP. It can parse other SQL dialects with some modifications. It fully supports parsing the most used SQL statements, but it just returns some information on other statements.\nThe SQL Parser of phpmyadmin is a validating SQL lexer and parser with a focus on MySQL dialect. Given its use in PHPMyAdmin, it is certainly well tested.\njs-sql-parser is SQL (only select) parser for JavaScript that parses the MySQL 5.7 version of SQL into an AST.\nSQLite Parsers\nsqlite-parser is a parser for SQLite v3 written in JavaScript that generates ASTs.\nSQL Parsers\nsql-parser is a parser for SQL written in pure JavaScript. It is not maintained anymore and it only supports some SELECT queries, but it is probably better than starting from scratch if you need to use JavaScript.\nhyrise/sql-parser is a SQL parser for C++. It parses the given SQL query into C++ objects. It is developed together with Hyrise, an in-memory database, but it can be used on its own.\nandialbrecht/sqlparse is a non-validating SQL parser for Python. It provides support for parsing, splitting and formatting SQL statements.\nK2InformaticsGmbH/sqlparse is a production-ready SQL parser written in pure Erlang. It targets the Oracle PL/SQL dialect.\nsqlparser-rs is SQL parser written in Rust. It supports the SQL-92, plus some addition for MS-SQL, PostgreSQL, and SQL:2011. The developers say: if you are assessing whether this project will be suitable for your needs, you’ll likely need to experimentally verify whether it supports the subset of SQL that you need.\nmoz-sql-parser is a peculiar SQL parser in Python written by Mozilla. The primary objective of this library is to convert some subset of SQL-92 queries to JSON-izable parse trees.\nqueryparser is a parser written in Haskell for parsing and analysis of Vertica, Hive, and Presto SQL.\nToolsFrom SQL to a Programming Language or another SQL\nIO64 offers a tool to convert PL/SQL to Java. We have also seen this tool in our previous article Convert PL/SQL code to Java\nIspirer is a company that provides a tool to perform database migration from different SQL dialects to another SQL dialect or a programming language: Ispirer MnMTK. We have seen it in our previous article Convert PL/SQL code to Java\nSQLines SQL Converter is an open-source tool to convert a SQL dialect to a different SQL dialect. It is written in C++ and implements its own SQL parser.\nHow Hard Could it be to Parse a Declarative Language?\nDeclarative languages tend to have simpler structures than your average programming language. For instance, you do not see many nested lambdas used inside declarative languages. A program in a declarative language is usually a long list of simple statements. The issue is that any single statement can be fairly complicated in some cases. And that is what happens in SQL.\nFurthermore, there are actually several versions of SQL. This is true both in the sense that each database can implement it differently, and that there are many versions of the SQL standard&nbsp;because the language is evolving.\nAs an example, you are certainly familiar with a SELECT statement. In its basic format, like SELECT name FROM customers WHERE id = 1 it is quite easy to parse. However, the complete statement can be fairly complex. This image represents the SELECT statement as implemented in SQLite.\nSo, to implement support for parsing the general case will certainly take some time.\nTry to Parse for Your Application\nThe reality is that to implement support for parsing the whole SQL requires a lot of effort, probably as much as parsing any average programming language. Even more, if you need to parse many different SQL dialects. Then, if you need to parse SQL and cannot rely on a ready-to-use library, you should start with an analysis of your needs. You should try to understand first exactly what you need to parse and then try to parse in light of your application. This means both to parse just what you need and to structure the grammar in a way that makes your life easier.\nFor instance, if you just need to translate a series of SQL files just once, it may be acceptable to just ignore 40 complex statements. Maybe translating them manually would take less time than creating a large grammar to do it automatically. This does not work if you either have a lot of code or you need to do the translation repeatedly, not just once.\nIn this tutorial we are going to use this pragmatic approach: we are going to create a SQL grammar from scratch to parse just what we need and to ignore the rest.\nWriting a (Very Partial) Grammar\nIn our example, we will parse a simple SQL file (an exported database) to generate classes that could represent that database. We are going to ignore everything else, even any exported data present in the file. That’s it. The advantage of dealing with SQL files is that we do not need to interact with a database. In fact, the database might not even exist anymore.\nDesigning a Partial Grammar\nTo do that we are going to start with a grammar. We are going to write a very simple one, but there are a couple of things to keep in mind:\nSQL is not case-sensitive, while ANTLR grammars by default are\nOur input (the SQL files) will contain some data that we do not care about. We still need to parse the file successfully while ignoring the extraneous input\nThese are notable issues that are specific to SQL and to our approach; they would not probably appear with other languages or if we wanted to create a complete grammar.\nBefore starting, just to give you an idea of what we have to deal with, this is a sample SQL file.\n--\n-- Table structure for table actor\n--\n--DROP TABLE actor; CREATE TABLE actor ( actor_id numeric NOT NULL , first_name VARCHAR(45) NOT NULL, last_name VARCHAR(45) NOT NULL, last_update TIMESTAMP NOT NULL, PRIMARY KEY (actor_id) ) ; CREATE INDEX idx_actor_last_name ON actor(last_name)\n; CREATE TRIGGER actor_trigger_ai AFTER INSERT ON actor BEGIN UPDATE actor SET last_update = DATETIME('NOW') WHERE rowid = new.rowid; END\n;\n--\n-- Table structure for table actor\n--\n--DROP TABLE actor;\nCREATE TABLE actor (\nactor_id numeric NOT NULL ,\nfirst_name VARCHAR(45) NOT NULL,\nlast_name VARCHAR(45) NOT NULL,\nlast_update TIMESTAMP NOT NULL,\nPRIMARY KEY (actor_id)\n)\n;\nCREATE INDEX idx_actor_last_name ON actor(last_name)\n;\nCREATE TRIGGER actor_trigger_ai AFTER INSERT ON actor\nBEGIN\nUPDATE actor SET last_update = DATETIME('NOW') WHERE rowid = new.rowid;\nEND\n;\n--\n-- Table structure for table actor\n--\n--DROP TABLE actor; CREATE TABLE actor ( actor_id numeric NOT NULL , first_name VARCHAR(45) NOT NULL, last_name VARCHAR(45) NOT NULL, last_update TIMESTAMP NOT NULL, PRIMARY KEY (actor_id) ) ; CREATE INDEX idx_actor_last_name ON actor(last_name)\n; CREATE TRIGGER actor_trigger_ai AFTER INSERT ON actor BEGIN UPDATE actor SET last_update = DATETIME('NOW') WHERE rowid = new.rowid; END\n;\nAs you can see at a first glance, we need to parse CREATE TABLE statements and ignore the other ones. We also need to ignore some parts of the CREATE TABLE statements, because they do not contain any information we care about for our task.\nHow to Ignore Stuff\nThe key to design a partial grammar is understanding how to ignore everything except for what we care about. This is not trivial because we have two conflicting needs: to ignore or drop most information and to keep all the necessary context to parse what we need. The more we ignore, the hardest is to parse what we need. This is tricky particularly for lexing since the lexer has less information available to make a decision.\nFor instance, we cannot just say ignore anything until we find a CREATE token. That is because the lexer would still find tokens for the elements in row definition, like the ones for naming the columns (e.g. last_name) in INSERT statements or CREATE INDEX. One possible way to deal with this would be lexical modes. These are a way to include multiple sets of lexer rules and switch between them. See our ANTLR Mega Tutorial, if you need to know more.\nEssentially we would treat SQL as if it were a markup language: bits of structured information in a sea of free text that we could ignore. This could work in our case because SQL has a regular structure and we are just interested in CREATE TABLE statements. For regular structure, we mean that a SQL file is just a list of statements, each of them ends with a semicolon. So, we could just make a CREATE TABLE token to start the special lexical mode and use the semicolon to end the special lexical mode. However, it is not flexible, so it would be risky in case we need to use our grammar for something else.\nThe Cognizant Way of Ignoring Stuff\nOur preferred approach is more flexible, and can also be used for regular programming languages.\nOn the lexer side, we just put as the last lexer rule this ANY rule.\nANY : . -&gt; skip;\nANY : . -&gt; skip;\nANY : . -&gt; skip;\nWe skip every character, that was not already recognized by some previous token.\nOn the parser side, these would be our main rules.\nstatements : (statement | ignore)+ EOF ; statement : createStmt ; ignore : .*? SEMICOLON | COMMENT ;\nstatements : (statement | ignore)+ EOF\n;\nstatement : createStmt\n;\nignore : .*? SEMICOLON\n| COMMENT\n;\nstatements : (statement | ignore)+ EOF ; statement : createStmt ; ignore : .*? SEMICOLON | COMMENT ;\nThe main rule is statements, which captures both the stuff we care about and the stuff to ignore. This approach allows us to start using our grammar while we build it. For this example, we only need to parse CREATE TABLE statements, but you could slowly add support for parsing more statements with this structure.\nWe need the ignore rule to maintain an understanding of the structure of the SQL file. Without this rule, we would not be able to recognize and parse the statements we are interested in. The negative side-effect is that it will clutter our parse tree with ignore nodes. For instance, this is a graphical representation of a sample parse tree made with grun, the ANTLR testing utility.\nParsing Create Statements\nWe use a similar approach to parsing the CREATE TABLE statements.\ncreateStmt : CREATE TABLE (IF NOT EXISTS)? tableName=name LPAREN element (COMMA element)* RPAREN? SEMICOLON ; element : definition | ignorable ; ignorable : (PRIMARY? KEY | CONSTRAINT | SPECIAL_FEATURES | FULLTEXT) .*? (COMMA|RPAREN) ; definition : name type defaultValue? nullability? attributes*;\ncreateStmt : CREATE TABLE (IF NOT EXISTS)? tableName=name\nLPAREN element (COMMA element)* RPAREN?\nSEMICOLON\n;\nelement : definition\n| ignorable\n;\nignorable : (PRIMARY? KEY | CONSTRAINT | SPECIAL_FEATURES | FULLTEXT) .*? (COMMA|RPAREN)\n;\ndefinition : name type defaultValue? nullability? attributes*;\ncreateStmt : CREATE TABLE (IF NOT EXISTS)? tableName=name LPAREN element (COMMA element)* RPAREN? SEMICOLON ; element : definition | ignorable ; ignorable : (PRIMARY? KEY | CONSTRAINT | SPECIAL_FEATURES | FULLTEXT) .*? (COMMA|RPAREN) ; definition : name type defaultValue? nullability? attributes*;\nThe statement includes both definitions of columns, that we need, and settings for the table, that we could ignore. So, our element rule can accept both the definition for a row and the information about primary keys, constraints, etc. Later, in our code, we will simply ignore both the nodes ignore and ignorable.\nThe rules themselves are fairly easy to understand and should be obvious for everybody that has seen SQL. There is only a dirty trick that needs to be explained. You can see that the closing parenthesis (RPAREN) that should be at the end of the list of column definitions is optional. Technically this is not correct, it should always be there. However, we use this to fix an issue regarding the ignorable rule.\nGetting Around the Need to Actually Parse Settings\nThe issue is that the ignorable rule is only a partial implementation of the parsing of these settings that you will find in a SQL file. In fact, this is the bare minimum necessary to parse correctly a bunch of sample SQL files we encountered. It is not a good design, but this is a very realistic implementation. Look at this example and see if you can spot our problem.\nCREATE TABLE city ( city_id int NOT NULL, city VARCHAR(50) NOT NULL, country_id SMALLINT NOT NULL, last_update TIMESTAMP NOT NULL, PRIMARY KEY (city_id), CONSTRAINT fk_city_country FOREIGN KEY (country_id) REFERENCES country (country_id) ON DELETE NO ACTION ON UPDATE CASCADE\n);\nCREATE TABLE city (\ncity_id int NOT NULL,\ncity VARCHAR(50) NOT NULL,\ncountry_id SMALLINT NOT NULL,\nlast_update TIMESTAMP NOT NULL,\nPRIMARY KEY (city_id),\nCONSTRAINT fk_city_country FOREIGN KEY (country_id) REFERENCES country (country_id) ON DELETE NO ACTION ON UPDATE CASCADE\n);\nCREATE TABLE city ( city_id int NOT NULL, city VARCHAR(50) NOT NULL, country_id SMALLINT NOT NULL, last_update TIMESTAMP NOT NULL, PRIMARY KEY (city_id), CONSTRAINT fk_city_country FOREIGN KEY (country_id) REFERENCES country (country_id) ON DELETE NO ACTION ON UPDATE CASCADE\n);\nThis partial implementation has the issue that it does not parse well enough to understand when it found the end of a setting. So, it uses as a clue the comma (i.e., the start of a new setting) or the final closing parenthesis (i.e., the end of the list of elements) for the final setting.\nNow, how safe is it to use this dirty trick? In this case, it is safe because SQL files are not written by humans, they are exported with tools. This means that there will not be missing parenthesis that will mess up the recognition of subsequent statements. So, we actually can be sure that every CREATE TABLE will end with a closing parenthesis and a semicolon. This may vary with different languages, different sources of SQL statements or different databases.\nWhen you need to only partially implement a grammar these sorts of tricks can be quite helpful to speed up development and get your task done quicker. You have to be careful and aware of the risks, but they can be useful.\nThe Rest of the Grammar\nThe rest of the grammar is also fairly simple to understand. We just mention a couple of things.\nname : QUOTE? NAME QUOTE? ;\nname : QUOTE? NAME QUOTE? ;\nname : QUOTE? NAME QUOTE? ;\nThe rule name is a parser rule instead of a lexer rule. That is because some tools wrap the name of the column with quotation marks (these are also used as apostrophes in some languages) like ` or '. With this definition, later in our code, we can easily extract the real name of the column without any check for quotation marks.\ntype : (INTEGER | INT) UNSIGNED? #integerType | (TINYINT | SMALLINT) UNSIGNED? #smallIntegerType | TEXT #textType | BLOB (SUBTYPE type)? #blobType | (VARCHAR|CHARVAR) LPAREN NUMBER RPAREN #varcharType | CHAR LPAREN NUMBER RPAREN #charType | YEAR #yearType | DATETIME #datetimeType | TIMESTAMP TIMEZONE? #timestampType | (NUMERIC | DECIMAL) (LPAREN precision=NUMBER (COMMA scale=NUMBER)? RPAREN)? #decimalType ;\ntype : (INTEGER | INT) UNSIGNED? #integerType\n| (TINYINT | SMALLINT) UNSIGNED? #smallIntegerType\n| TEXT #textType\n| BLOB (SUBTYPE type)? #blobType\n| (VARCHAR|CHARVAR) LPAREN NUMBER RPAREN #varcharType\n| CHAR LPAREN NUMBER RPAREN #charType\n| YEAR #yearType\n| DATETIME #datetimeType\n| TIMESTAMP TIMEZONE? #timestampType\n| (NUMERIC | DECIMAL) (LPAREN precision=NUMBER (COMMA scale=NUMBER)? RPAREN)? #decimalType\n;\ntype : (INTEGER | INT) UNSIGNED? #integerType | (TINYINT | SMALLINT) UNSIGNED? #smallIntegerType | TEXT #textType | BLOB (SUBTYPE type)? #blobType | (VARCHAR|CHARVAR) LPAREN NUMBER RPAREN #varcharType | CHAR LPAREN NUMBER RPAREN #charType | YEAR #yearType | DATETIME #datetimeType | TIMESTAMP TIMEZONE? #timestampType | (NUMERIC | DECIMAL) (LPAREN precision=NUMBER (COMMA scale=NUMBER)? RPAREN)? #decimalType ;\nThe rule to parse the type of the column includes rule labels. We designed this way to simplify our job, later in the code where we use the parser. This is also the reason because the VARCHAR rule is separated from the CHAR rule. Structurally the rules are obviously identical, but they mean something different. Remember: you should parse for your application, to make the parse effective for your needs.\nfragment A : [aA];\nfragment B : [bB];\nfragment C : [cC];\nfragment D : [dD];\nfragment E : [eE];\n// etc.\nfragment A : [aA];\nfragment B : [bB];\nfragment C : [cC];\nfragment D : [dD];\nfragment E : [eE];\n// etc.\nfragment A : [aA];\nfragment B : [bB];\nfragment C : [cC];\nfragment D : [dD];\nfragment E : [eE];\n// etc.\nSince SQL is case-insensitive we use fragments for letters everywhere we need, to ensure that we parse everything correctly.\nYou can see the rest of the grammar on the companion repository.\nCREATING THE C# PROJECT\nWe can finally see some code. We are going to create a C# project from the command line since we are using VS Code as our editor. These are the instructions to create the project and to add the ANTLR library.\n// create a new directory somewhere\n// to create a new C# project\ndotnet new console -lang C#\n// to install the standard ANTLR 4 Runtime\ndotnet add package Antlr4.Runtime.Standard\n// create a new directory somewhere\n// to create a new C# project\ndotnet new console -lang C#\n// to install the standard ANTLR 4 Runtime\ndotnet add package Antlr4.Runtime.Standard\n// create a new directory somewhere\n// to create a new C# project\ndotnet new console -lang C#\n// to install the standard ANTLR 4 Runtime\ndotnet add package Antlr4.Runtime.Standard\nThese are the instructions to generate the parser and to run the program.\n// to generate the parser\nantlr4 SQL.g4 -Dlanguage=CSharp -o generated\\ -encoding UTF-8\n// to run the program\ndotnet run\n// to generate the parser\nantlr4 SQL.g4 -Dlanguage=CSharp -o generated\\ -encoding UTF-8\n// to run the program\ndotnet run\n// to generate the parser\nantlr4 SQL.g4 -Dlanguage=CSharp -o generated\\ -encoding UTF-8\n// to run the program\ndotnet run\nEven our main source code file is fairly standard.\nstatic void Main(string[] args)\n{ // standard ANTLR code // we get the input ICharStream chars = CharStreams.fromPath(args[0]); // we set up the lexer SQLLexer lexer = new SQLLexer(chars); // we use the lexer CommonTokenStream stream = new CommonTokenStream(lexer); // we set up the parser SQLParser parser = new SQLParser(stream); // we find the root node of our parse tree var tree = parser.statements(); // we create our visitor CreateVisitor createVisitor = new CreateVisitor(); List&lt;ClassDescriptor&gt; classes = createVisitor.VisitStatements(tree); // we choose our code generator... ICodeGenerator generator; // ...depending on the command line argument if(args.Count() &gt; 1 &amp;&amp; args[1] == \"kotlin\") generator = new KotlinCodeGenerator(); else generator = new CSharpCodeGenerator(); Console.WriteLine(generator.ToSourceCode(\"SQLDataTypes\", classes));\n}\nstatic void Main(string[] args)\n{\n// standard ANTLR code\n// we get the input\nICharStream chars = CharStreams.fromPath(args[0]);\n// we set up the lexer\nSQLLexer lexer = new SQLLexer(chars);\n// we use the lexer\nCommonTokenStream stream = new CommonTokenStream(lexer);\n// we set up the parser\nSQLParser parser = new SQLParser(stream);\n// we find the root node of our parse tree\nvar tree = parser.statements();\n// we create our visitor\nCreateVisitor createVisitor = new CreateVisitor();\nList&lt;ClassDescriptor&gt; classes = createVisitor.VisitStatements(tree);\n// we choose our code generator...\nICodeGenerator generator;\n// ...depending on the command line argument\nif(args.Count() &gt; 1 &amp;&amp; args[1] == \"kotlin\")\ngenerator = new KotlinCodeGenerator();\nelse\ngenerator = new CSharpCodeGenerator();\nConsole.WriteLine(generator.ToSourceCode(\"SQLDataTypes\", classes));\n}\nstatic void Main(string[] args)\n{ // standard ANTLR code // we get the input ICharStream chars = CharStreams.fromPath(args[0]); // we set up the lexer SQLLexer lexer = new SQLLexer(chars); // we use the lexer CommonTokenStream stream = new CommonTokenStream(lexer); // we set up the parser SQLParser parser = new SQLParser(stream); // we find the root node of our parse tree var tree = parser.statements(); // we create our visitor CreateVisitor createVisitor = new CreateVisitor(); List&lt;ClassDescriptor&gt; classes = createVisitor.VisitStatements(tree); // we choose our code generator... ICodeGenerator generator; // ...depending on the command line argument if(args.Count() &gt; 1 &amp;&amp; args[1] == \"kotlin\") generator = new KotlinCodeGenerator(); else generator = new CSharpCodeGenerator(); Console.WriteLine(generator.ToSourceCode(\"SQLDataTypes\", classes));\n}\nThe comments are self-explanatory. After our standard code to setup ANTLR and parse the input, we employ our CreateVisitor. We use the visitor to visit the create table statements and to generate an internal representation of them. Then we use this representation to generate a source code file in our chosen language. In our example we choose to generate either in Kotlin or C#, to show how easy it can be to work with our SQL data once you parse it.\nThis is the simple overall structure; we can now move on the individual parts.\nVisiting the Statements\nLet’s start by looking at the general organization of our visitor.\npublic class CreateVisitor\n{ public List&lt;ClassDescriptor&gt; VisitStatements(StatementsContext context) { List&lt;ClassDescriptor&gt; tables = new List&lt;ClassDescriptor&gt;(); foreach(var statement in context.statement()) { tables.Add(VisitStmt(statement)); } return tables; } public ClassDescriptor VisitStmt(StatementContext context) { return VisitCreateStmt(context.createStmt()); } public ClassDescriptor VisitCreateStmt(CreateStmtContext context) { ClassDescriptor table = new ClassDescriptor(); table.Name = context.tableName.NAME().GetText(); table.Fields = new List&lt;FieldDescriptor&gt;(); foreach (var el in context.element()) { if(el.definition() != null) { table.Fields.Add(VisitDefinition(el.definition())); } } return table; } [..]\npublic class CreateVisitor\n{\npublic List&lt;ClassDescriptor&gt; VisitStatements(StatementsContext context)\n{\nList&lt;ClassDescriptor&gt; tables = new List&lt;ClassDescriptor&gt;();\nforeach(var statement in context.statement())\n{\ntables.Add(VisitStmt(statement));\n}\nreturn tables;\n}\npublic ClassDescriptor VisitStmt(StatementContext context)\n{\nreturn VisitCreateStmt(context.createStmt());\n}\npublic ClassDescriptor VisitCreateStmt(CreateStmtContext context)\n{\nClassDescriptor table = new ClassDescriptor();\ntable.Name = context.tableName.NAME().GetText();\ntable.Fields = new List&lt;FieldDescriptor&gt;();\nforeach (var el in context.element())\n{\nif(el.definition() != null)\n{\ntable.Fields.Add(VisitDefinition(el.definition()));\n}\n}\nreturn table;\n}\n[..]\npublic class CreateVisitor\n{ public List&lt;ClassDescriptor&gt; VisitStatements(StatementsContext context) { List&lt;ClassDescriptor&gt; tables = new List&lt;ClassDescriptor&gt;(); foreach(var statement in context.statement()) { tables.Add(VisitStmt(statement)); } return tables; } public ClassDescriptor VisitStmt(StatementContext context) { return VisitCreateStmt(context.createStmt()); } public ClassDescriptor VisitCreateStmt(CreateStmtContext context) { ClassDescriptor table = new ClassDescriptor(); table.Name = context.tableName.NAME().GetText(); table.Fields = new List&lt;FieldDescriptor&gt;(); foreach (var el in context.element()) { if(el.definition() != null) { table.Fields.Add(VisitDefinition(el.definition())); } } return table; } [..]\nThe first thing we notice is that we do not need to use the standard base visitor that can be created for us by ANTLR. Our visitor uses just our code. We do not need to use the base visitor, because of the structure of a SQL file and because we know exactly what we need to visit. We can completely ignore everything that is not a create statement because every statement in our SQL files is a top-level element. It is not like statements in your average programming language, that can be nested inside a code block, function definitions, etc. Also, the structure of create statements is simple, so we can visit everything ourselves.\nIn short, all we need to do is:\nto visit the statements node\nthen to visit each statement node (we ignore the ignore nodes) and to select the createStmt node\nvisiting the createStmt nodes, we pick only the definition nodes (we ignore the ignorable nodes) to get all the columns definition\nTranslating Types from SQL to Your Language\nInside the VisitDefinition method we deal with the only real complication of this visitor: handling types.\npublic FieldDescriptor VisitDefinition(DefinitionContext context) { string name = context.name().NAME().GetText(); TypeDescriptor type; switch(context.type().GetType().Name) { case \"IntegerTypeContext\": type = VisitIntegerType(context.type() as IntegerTypeContext); break; case \"SmallIntegerTypeContext\": type = VisitSmallIntegerType(context.type() as SmallIntegerTypeContext); break; case \"VarcharTypeContext\": type = VisitVarcharType(context.type() as VarcharTypeContext); break; case \"TimestampTypeContext\": type = VisitTimestampType(context.type() as TimestampTypeContext); break; case \"TextTypeContext\": type = VisitTextType(context.type() as TextTypeContext); break; case \"DecimalTypeContext\": type = VisitDecimalType(context.type() as DecimalTypeContext); break; case \"CharTypeContext\": type = VisitCharType(context.type() as CharTypeContext); break; case \"BlobTypeContext\": type = VisitBlobType(context.type() as BlobTypeContext); break; default: type = null; break; } if(context.nullability() != null &amp;&amp; context.nullability().NOT() != null) type.Nullability = false; return new FieldDescriptor(name, type); }\npublic FieldDescriptor VisitDefinition(DefinitionContext context)\n{\nstring name = context.name().NAME().GetText();\nTypeDescriptor type;\nswitch(context.type().GetType().Name)\n{\ncase \"IntegerTypeContext\":\ntype = VisitIntegerType(context.type() as IntegerTypeContext);\nbreak;\ncase \"SmallIntegerTypeContext\":\ntype = VisitSmallIntegerType(context.type() as SmallIntegerTypeContext);\nbreak;\ncase \"VarcharTypeContext\":\ntype = VisitVarcharType(context.type() as VarcharTypeContext);\nbreak;\ncase \"TimestampTypeContext\":\ntype = VisitTimestampType(context.type() as TimestampTypeContext);\nbreak;\ncase \"TextTypeContext\":\ntype = VisitTextType(context.type() as TextTypeContext);\nbreak;\ncase \"DecimalTypeContext\":\ntype = VisitDecimalType(context.type() as DecimalTypeContext);\nbreak;\ncase \"CharTypeContext\":\ntype = VisitCharType(context.type() as CharTypeContext);\nbreak;\ncase \"BlobTypeContext\":\ntype = VisitBlobType(context.type() as BlobTypeContext);\nbreak;\ndefault:\ntype = null;\nbreak;\n}\nif(context.nullability() != null &amp;&amp; context.nullability().NOT() != null)\ntype.Nullability = false;\nreturn new FieldDescriptor(name, type);\n}\npublic FieldDescriptor VisitDefinition(DefinitionContext context) { string name = context.name().NAME().GetText(); TypeDescriptor type; switch(context.type().GetType().Name) { case \"IntegerTypeContext\": type = VisitIntegerType(context.type() as IntegerTypeContext); break; case \"SmallIntegerTypeContext\": type = VisitSmallIntegerType(context.type() as SmallIntegerTypeContext); break; case \"VarcharTypeContext\": type = VisitVarcharType(context.type() as VarcharTypeContext); break; case \"TimestampTypeContext\": type = VisitTimestampType(context.type() as TimestampTypeContext); break; case \"TextTypeContext\": type = VisitTextType(context.type() as TextTypeContext); break; case \"DecimalTypeContext\": type = VisitDecimalType(context.type() as DecimalTypeContext); break; case \"CharTypeContext\": type = VisitCharType(context.type() as CharTypeContext); break; case \"BlobTypeContext\": type = VisitBlobType(context.type() as BlobTypeContext); break; default: type = null; break; } if(context.nullability() != null &amp;&amp; context.nullability().NOT() != null) type.Nullability = false; return new FieldDescriptor(name, type); }\nThe issue is that we need to identify each type and then translate it in a way that is compatible with a programming language. In fact, SQL data types and programming language data types can be different. For example, SQL has types for variable and fixed size char array, this is less relevant in programming languages.\nWe already have done the work to easily identify each type by creating a label for each option of the type grammar rule. Now, we just need to use a different method to visit each node correctly.\nBefore seeing the examples of VisitIntegerType and VisitSmallIntegerType, let’s notice a couple of things. First, we deal with nullability of types only once, on lines 37-38. Second, we are only dealing with some types, the ones used in our example SQL files.\nprivate TypeDescriptor VisitSmallIntegerType(SmallIntegerTypeContext context) { if(context.UNSIGNED() != null) return new IntegerTypeDescriptor(2, true); else return new IntegerTypeDescriptor(2); } private TypeDescriptor VisitIntegerType(IntegerTypeContext context) { if(context.UNSIGNED() != null) return new IntegerTypeDescriptor(4, true); else return new IntegerTypeDescriptor(4); }\nprivate TypeDescriptor VisitSmallIntegerType(SmallIntegerTypeContext context)\n{\nif(context.UNSIGNED() != null)\nreturn new IntegerTypeDescriptor(2, true);\nelse\nreturn new IntegerTypeDescriptor(2);\n}\nprivate TypeDescriptor VisitIntegerType(IntegerTypeContext context)\n{\nif(context.UNSIGNED() != null)\nreturn new IntegerTypeDescriptor(4, true);\nelse\nreturn new IntegerTypeDescriptor(4);\n}\nprivate TypeDescriptor VisitSmallIntegerType(SmallIntegerTypeContext context) { if(context.UNSIGNED() != null) return new IntegerTypeDescriptor(2, true); else return new IntegerTypeDescriptor(2); } private TypeDescriptor VisitIntegerType(IntegerTypeContext context) { if(context.UNSIGNED() != null) return new IntegerTypeDescriptor(4, true); else return new IntegerTypeDescriptor(4); }\nThese two methods are representative of the little effort we have to do. Each method returns a TypeDescriptor specific for each type.\nThe methods are simple, but different because each type is different. In the case of integer types we need to check whether the type is unsigned or not. We use only one IntegerTypeDescriptor for all integer types. This is simply because they can be described in the same way: from our point of view, the only difference between integer types is the number of bytes they need.\nThe TypeDescriptor classes themselves are also fairly trivial. They just are a series of classes that contain specific information for each type.\npublic enum BaseType\n{ Integer, Floating, Decimal, Text, Binary, ArrayCharacters, Year, DateTime\n} public class TypeDescriptor\n{ public BaseType Type { get; protected set; } public bool Nullability { get; set; } = true;\n} public class IntegerTypeDescriptor : TypeDescriptor\n{ public int Bytes { get; private set; } public bool Unsigned { get; private set; } public IntegerTypeDescriptor(int bytes, bool unsigned = false) { Type = BaseType.Integer; Bytes = bytes; Unsigned = unsigned; }\n}\npublic enum BaseType\n{\nInteger,\nFloating,\nDecimal,\nText,\nBinary,\nArrayCharacters,\nYear,\nDateTime\n}\npublic class TypeDescriptor\n{\npublic BaseType Type { get; protected set; }\npublic bool Nullability { get; set; } = true;\n}\npublic class IntegerTypeDescriptor : TypeDescriptor\n{\npublic int Bytes { get; private set; }\npublic bool Unsigned { get; private set; }\npublic IntegerTypeDescriptor(int bytes, bool unsigned = false)\n{\nType = BaseType.Integer;\nBytes = bytes;\nUnsigned = unsigned;\n}\n}\npublic enum BaseType\n{ Integer, Floating, Decimal, Text, Binary, ArrayCharacters, Year, DateTime\n} public class TypeDescriptor\n{ public BaseType Type { get; protected set; } public bool Nullability { get; set; } = true;\n} public class IntegerTypeDescriptor : TypeDescriptor\n{ public int Bytes { get; private set; } public bool Unsigned { get; private set; } public IntegerTypeDescriptor(int bytes, bool unsigned = false) { Type = BaseType.Integer; Bytes = bytes; Unsigned = unsigned; }\n}\nYou can see the rest on the companion repository.\nGenerating Code\nWe have a custom representation of our original SQL code: a description of all the tables suited for our needs. Now we can generate the corresponding source code. We are going to generate the code in multiple languages: C# and Kotlin. We do this to show how easy it is to do anything once we get the information out of SQL and because there are different limitations in the two languages.\nGenerating Code in C#\nLet’s start with seeing C#. We have only one public method: ToSourceCode, which accepts a namespace and a series of classes/tables definition.\npublic class CSharpCodeGenerator : ICodeGenerator\n{ public string ToSourceCode(string idNamespace, List&lt;ClassDescriptor&gt; classes) { StringBuilder sourceCode = new StringBuilder(); // opening namespace sourceCode.AppendLine($\"namespace {idNamespace}\"); sourceCode.AppendLine(\"{\"); foreach(var c in classes) { sourceCode.AppendLine($\"\\tpublic class {c.Name}\"); sourceCode.AppendLine(\"\\t{\"); foreach(var f in c.Fields) { switch(f.Type.Type) { case BaseType.Integer: sourceCode.AppendLine($\"\\t\\tpublic {GenerateInt(f.Type as IntegerTypeDescriptor)} {f.Name} {{ get; set; }}\"); break; case BaseType.Text: sourceCode.AppendLine($\"\\t\\tpublic string {f.Name} {{ get; set; }}\"); break; case BaseType.ArrayCharacters: sourceCode.AppendLine($\"\\t\\tpublic {GenerateCharArray(f.Name, f.Type as CharArrayTypeDescriptor)}\"); break; case BaseType.DateTime: sourceCode.AppendLine($\"\\t\\tpublic DateTime {f.Name} {{ get; set; }}\"); break; case BaseType.Decimal: sourceCode.AppendLine($\"\\t\\tpublic decimal {f.Name} {{ get; set; }}\"); break; case BaseType.Binary: sourceCode.AppendLine($\"\\t\\tpublic bytes[] {f.Name} {{ get; set; }}\"); break; } } sourceCode.AppendLine(\"\\t}\"); sourceCode.AppendLine(); } // closing namespace sourceCode.AppendLine(\"}\"); return sourceCode.ToString(); } [..]\npublic class CSharpCodeGenerator : ICodeGenerator\n{\npublic string ToSourceCode(string idNamespace, List&lt;ClassDescriptor&gt; classes)\n{\nStringBuilder sourceCode = new StringBuilder();\n// opening namespace\nsourceCode.AppendLine($\"namespace {idNamespace}\");\nsourceCode.AppendLine(\"{\");\nforeach(var c in classes)\n{\nsourceCode.AppendLine($\"\\tpublic class {c.Name}\");\nsourceCode.AppendLine(\"\\t{\");\nforeach(var f in c.Fields)\n{\nswitch(f.Type.Type)\n{\ncase BaseType.Integer:\nsourceCode.AppendLine($\"\\t\\tpublic {GenerateInt(f.Type as IntegerTypeDescriptor)} {f.Name} {{ get; set; }}\");\nbreak;\ncase BaseType.Text:\nsourceCode.AppendLine($\"\\t\\tpublic string {f.Name} {{ get; set; }}\");\nbreak;\ncase BaseType.ArrayCharacters:\nsourceCode.AppendLine($\"\\t\\tpublic {GenerateCharArray(f.Name, f.Type as CharArrayTypeDescriptor)}\");\nbreak;\ncase BaseType.DateTime:\nsourceCode.AppendLine($\"\\t\\tpublic DateTime {f.Name} {{ get; set; }}\");\nbreak;\ncase BaseType.Decimal:\nsourceCode.AppendLine($\"\\t\\tpublic decimal {f.Name} {{ get; set; }}\");\nbreak;\ncase BaseType.Binary:\nsourceCode.AppendLine($\"\\t\\tpublic bytes[] {f.Name} {{ get; set; }}\");\nbreak;\n}\n}\nsourceCode.AppendLine(\"\\t}\");\nsourceCode.AppendLine();\n}\n// closing namespace\nsourceCode.AppendLine(\"}\");\nreturn sourceCode.ToString();\n}\n[..]\npublic class CSharpCodeGenerator : ICodeGenerator\n{ public string ToSourceCode(string idNamespace, List&lt;ClassDescriptor&gt; classes) { StringBuilder sourceCode = new StringBuilder(); // opening namespace sourceCode.AppendLine($\"namespace {idNamespace}\"); sourceCode.AppendLine(\"{\"); foreach(var c in classes) { sourceCode.AppendLine($\"\\tpublic class {c.Name}\"); sourceCode.AppendLine(\"\\t{\"); foreach(var f in c.Fields) { switch(f.Type.Type) { case BaseType.Integer: sourceCode.AppendLine($\"\\t\\tpublic {GenerateInt(f.Type as IntegerTypeDescriptor)} {f.Name} {{ get; set; }}\"); break; case BaseType.Text: sourceCode.AppendLine($\"\\t\\tpublic string {f.Name} {{ get; set; }}\"); break; case BaseType.ArrayCharacters: sourceCode.AppendLine($\"\\t\\tpublic {GenerateCharArray(f.Name, f.Type as CharArrayTypeDescriptor)}\"); break; case BaseType.DateTime: sourceCode.AppendLine($\"\\t\\tpublic DateTime {f.Name} {{ get; set; }}\"); break; case BaseType.Decimal: sourceCode.AppendLine($\"\\t\\tpublic decimal {f.Name} {{ get; set; }}\"); break; case BaseType.Binary: sourceCode.AppendLine($\"\\t\\tpublic bytes[] {f.Name} {{ get; set; }}\"); break; } } sourceCode.AppendLine(\"\\t}\"); sourceCode.AppendLine(); } // closing namespace sourceCode.AppendLine(\"}\"); return sourceCode.ToString(); } [..]\nThis method takes care of generating the whole new source code file. It handles the enclosing namespace (necessary for C# files) and the whole class.\nWe transform columns into properties. These are the obvious choice because it is easy to anticipate that we would need to transform any data coming from SQL in a different format to handle it in our programming language. For example, dates would be different. We would also need to enforce fixed-size arrays in some way. That is because programming languages usually do not have a well-defined way to handle an input too large or too small. Instead databases can automatically do things like padding an input that is too short with spaces.\nThere are generally three cases:\nthe type has a perfect correspondence (e.g. lines 23-24 TEXT becomes a String). So we just write the property directly.\nthe type has only a partial, but unambiguous, correspondence (e.g. lines 32-33 DECIMAL becomes Decimal, but the SQL and C# type behave differently). For example, a SQL decimal allows us to specify a precision, to set just how many digits it can hold. In C# you cannot do that. Normally we would need to take care of this difference, in our example, we just ignore the issue\nthe type has multiple correspondences (e.g., lines 20-21 INT, SMALLINT become int, short), so we handle them with a method\nFor the third case, we are going to see the integer example.\nprivate string GenerateInt(IntegerTypeDescriptor descriptor) { StringBuilder intType = new StringBuilder(); // we ignore nullability, because it is not well supported for all C# types if(descriptor.Unsigned == true) intType.Append(\"u\"); switch(descriptor.Bytes) { case 2: intType.Append(\"short\"); break; case 4: intType.Append(\"int\"); break; case 8: intType.Append(\"long\"); break; } return intType.ToString(); }\nprivate string GenerateInt(IntegerTypeDescriptor descriptor)\n{\nStringBuilder intType = new StringBuilder();\n// we ignore nullability, because it is not well supported for all C# types\nif(descriptor.Unsigned == true)\nintType.Append(\"u\");\nswitch(descriptor.Bytes)\n{\ncase 2:\nintType.Append(\"short\");\nbreak;\ncase 4:\nintType.Append(\"int\");\nbreak;\ncase 8:\nintType.Append(\"long\");\nbreak;\n}\nreturn intType.ToString();\n}\nprivate string GenerateInt(IntegerTypeDescriptor descriptor) { StringBuilder intType = new StringBuilder(); // we ignore nullability, because it is not well supported for all C# types if(descriptor.Unsigned == true) intType.Append(\"u\"); switch(descriptor.Bytes) { case 2: intType.Append(\"short\"); break; case 4: intType.Append(\"int\"); break; case 8: intType.Append(\"long\"); break; } return intType.ToString(); }\nWe can find a perfect correspondence between each integer type in SQL and C#. Since integer types are all represented internally the same way, it all depends on the number of bytes used for each of them. Depending on how many bytes are stored in our instance of IntegerTypeDescriptor, we generate the proper C# type.\nThe only issue is with C# itself: it does not have perfect support for nullability. Until C# 8.0 reference types could be nullable by default, so it would be fairly inconsistent to work with nullable types both in our code and any third-party code.\nOn the other hand, we can easily deal with unsigned integers, we just need to prepend a u, to use unsigned types.\nGenerating Code in Kotlin\nGenerating the code for Kotlin is very similar.\npublic class KotlinCodeGenerator : ICodeGenerator\n{ public string ToSourceCode(string idNamespace, List&lt;ClassDescriptor&gt; classes) { StringBuilder sourceCode = new StringBuilder(); // declaring package if(!String.IsNullOrEmpty(idNamespace)) sourceCode.AppendLine($\"package {idNamespace}\"); // adding imports sourceCode.AppendLine(); sourceCode.AppendLine(\"import java.time.LocalDateTime\"); sourceCode.AppendLine(\"import java.math.BigDecimal\"); sourceCode.AppendLine(); foreach(var c in classes) { sourceCode.Append($\"data class {c.Name}(\"); foreach(var f in c.Fields) { switch(f.Type.Type) { case BaseType.Integer: sourceCode.Append($\"var {f.Name}: {GenerateInt(f.Type as IntegerTypeDescriptor)}\"); break; case BaseType.Text: sourceCode.Append($\"var {f.Name}: String\"); break; case BaseType.ArrayCharacters: sourceCode.Append($\"var {f.Name}: {GenerateCharArray(f.Type as CharArrayTypeDescriptor)}\"); break; case BaseType.DateTime: sourceCode.Append($\"var {f.Name}: LocalDateTime\"); break; case BaseType.Decimal: sourceCode.Append($\"var {f.Name}: BigDecimal\"); break; case BaseType.Binary: sourceCode.Append($\"var {f.Name}: ByteArray\"); break; } if(f != c.Fields.Last()) sourceCode.Append(\", \"); } sourceCode.AppendLine(\")\"); sourceCode.AppendLine(\"\"); } return sourceCode.ToString(); }\npublic class KotlinCodeGenerator : ICodeGenerator\n{\npublic string ToSourceCode(string idNamespace, List&lt;ClassDescriptor&gt; classes)\n{\nStringBuilder sourceCode = new StringBuilder();\n// declaring package\nif(!String.IsNullOrEmpty(idNamespace))\nsourceCode.AppendLine($\"package {idNamespace}\");\n// adding imports\nsourceCode.AppendLine();\nsourceCode.AppendLine(\"import java.time.LocalDateTime\");\nsourceCode.AppendLine(\"import java.math.BigDecimal\");\nsourceCode.AppendLine();\nforeach(var c in classes)\n{\nsourceCode.Append($\"data class {c.Name}(\");\nforeach(var f in c.Fields)\n{\nswitch(f.Type.Type)\n{\ncase BaseType.Integer:\nsourceCode.Append($\"var {f.Name}: {GenerateInt(f.Type as IntegerTypeDescriptor)}\");\nbreak;\ncase BaseType.Text:\nsourceCode.Append($\"var {f.Name}: String\");\nbreak;\ncase BaseType.ArrayCharacters:\nsourceCode.Append($\"var {f.Name}: {GenerateCharArray(f.Type as CharArrayTypeDescriptor)}\");\nbreak;\ncase BaseType.DateTime:\nsourceCode.Append($\"var {f.Name}: LocalDateTime\");\nbreak;\ncase BaseType.Decimal:\nsourceCode.Append($\"var {f.Name}: BigDecimal\");\nbreak;\ncase BaseType.Binary:\nsourceCode.Append($\"var {f.Name}: ByteArray\");\nbreak;\n}\nif(f != c.Fields.Last())\nsourceCode.Append(\", \");\n}\nsourceCode.AppendLine(\")\");\nsourceCode.AppendLine(\"\");\n}\nreturn sourceCode.ToString();\n}\npublic class KotlinCodeGenerator : ICodeGenerator\n{ public string ToSourceCode(string idNamespace, List&lt;ClassDescriptor&gt; classes) { StringBuilder sourceCode = new StringBuilder(); // declaring package if(!String.IsNullOrEmpty(idNamespace)) sourceCode.AppendLine($\"package {idNamespace}\"); // adding imports sourceCode.AppendLine(); sourceCode.AppendLine(\"import java.time.LocalDateTime\"); sourceCode.AppendLine(\"import java.math.BigDecimal\"); sourceCode.AppendLine(); foreach(var c in classes) { sourceCode.Append($\"data class {c.Name}(\"); foreach(var f in c.Fields) { switch(f.Type.Type) { case BaseType.Integer: sourceCode.Append($\"var {f.Name}: {GenerateInt(f.Type as IntegerTypeDescriptor)}\"); break; case BaseType.Text: sourceCode.Append($\"var {f.Name}: String\"); break; case BaseType.ArrayCharacters: sourceCode.Append($\"var {f.Name}: {GenerateCharArray(f.Type as CharArrayTypeDescriptor)}\"); break; case BaseType.DateTime: sourceCode.Append($\"var {f.Name}: LocalDateTime\"); break; case BaseType.Decimal: sourceCode.Append($\"var {f.Name}: BigDecimal\"); break; case BaseType.Binary: sourceCode.Append($\"var {f.Name}: ByteArray\"); break; } if(f != c.Fields.Last()) sourceCode.Append(\", \"); } sourceCode.AppendLine(\")\"); sourceCode.AppendLine(\"\"); } return sourceCode.ToString(); }\nThere are no structural differences. The only variations depend on the differences between the languages themselves. For instance, the equivalent of a namespace, i.e., packages are not required in Kotlin. We can also use the special data classes in Kotlin to quickly define a class with its properties directly in the default constructor.\nOn the other hand, we need to import some Java packages, because Kotlin does not directly have classes for DateTime types. Since Kotlin can run in different environments (i.e. JVM with Java support, JavaScript, native with C++ support), we should probably find a way to support all of these environments. In a normal situation, we would probably create a runtime in pure Kotlin with these custom types (i.e., KotlinDateTime) and then add support for each platform in separate files. This way we could just generate one Kotlin file for all environments. This would be overkill for this example, so we just consider Kotlin run in Java.\nprivate string GenerateInt(IntegerTypeDescriptor descriptor) { StringBuilder intType = new StringBuilder(); switch(descriptor.Bytes) { case 2: intType.Append(\"Short\"); break; case 4: intType.Append(\"Int\"); break; case 8: intType.Append(\"Long\"); break; } // we ignore unsigned, because it is not well supported in C# if(descriptor.Nullability == true) intType.Append(\"?\"); return intType.ToString(); }\nprivate string GenerateInt(IntegerTypeDescriptor descriptor)\n{\nStringBuilder intType = new StringBuilder();\nswitch(descriptor.Bytes)\n{\ncase 2:\nintType.Append(\"Short\");\nbreak;\ncase 4:\nintType.Append(\"Int\");\nbreak;\ncase 8:\nintType.Append(\"Long\");\nbreak;\n}\n// we ignore unsigned, because it is not well supported in C#\nif(descriptor.Nullability == true)\nintType.Append(\"?\");\nreturn intType.ToString();\n}\nprivate string GenerateInt(IntegerTypeDescriptor descriptor) { StringBuilder intType = new StringBuilder(); switch(descriptor.Bytes) { case 2: intType.Append(\"Short\"); break; case 4: intType.Append(\"Int\"); break; case 8: intType.Append(\"Long\"); break; } // we ignore unsigned, because it is not well supported in C# if(descriptor.Nullability == true) intType.Append(\"?\"); return intType.ToString(); }\nWe can also see that the methods to generate integral types are very similar in both C# and Kotlin. The difference is that with Kotlin nullability has always been supported, while support for unsigned integer is still experimental for the current version.\nSummary\nIn this article, we have seen how to parse SQL. In general, our advice is to:\nConsider if you can use existing tools or libraries to process SQL code. Some of them even support multiple SQL-dialects or multiple programming languages. If you can use any of them for your needs they should be your first option\nIf you want to build a solution in-house you may consider starting from the few ANTLR grammars available for the major SQL databases. They can really help you get started in parsing SQL\nIf you are stuck with a less common SQL database you might be in trouble. Parsing SQL from scratch it is going to be hard work: the language has a fairly simple structure, but it is large, it has many variations and in some cases even procedural extensions. In this article, we have seen a few tricks to start parsing even with a partial grammar. This can be a good way if you need to parse only small parts of the language\nIf none of these options work for you, and you need some commercial option supporting you in building a solution for your needs, we at Strumenta may be able to help.\nDownload the guide with 68 resources on Creating Programming Languages\nReceive the guide to your inbox to read it on all your devices when you have time\nSuccess! Now check your email to confirm your subscription.\nThere was an error submitting your subscription. Please try again.\nFirst Name\nEmail Address\nWe use this field to detect spam bots. If you fill this in, you will be marked as a spammer.\nI'd like to receive the free email course.\nSend it to me! Powered by ConvertKit\nTags: C#, Kotlin, SQL, tools\nhttps://tomassetti.me/wp-content/uploads/2020/04/Parsing-SQL.jpg 512 1024 Gabriele Tomassetti https://tomassetti.me/wp-content/uploads/2017/07/federico-tomassetti-software-architect-300.png Gabriele Tomassetti2020-04-15 10:58:482020-04-15 10:58:48Parsing SQL\nYou might also like\nDo You Need a Parser?\nWe can design parsers for new languages, or rewrite parsers for existing languages built in house.\nOn top of parsers we can then help building interpreters, compilers, code generators, documentation generators, or translators (code converters) to other languages.\nLet’s Talk!\nCourse: Using ANTLR Like A Professional\nA complete video course on parsing and ANTLR, that will teach you how to build parser for everything from programming languages to data formats.\nTaught from professionals that build parsers for a living.\nBook: How to create pragmatic, lightweight languages\nThis book on Building Languages is about building in a simple manner productive languages with parsers, compilers, interpreters, editors and more.\nBook: JavaParser Visited\nThis book on JavaParser will teach you how to analyze, transform, and generate Java code\nStrumenta – Consulting\nIf you need help designing and developing DSLs, languages, parsers, compilers, interpreters, and editors you can check the services page of the Consulting studio we founded: Strumenta.\nBlog Categories\nANTLR (17)\nApplication modernization (2)\nCode processing (24)\nConsulting (14)\nCreate a programming language (1)\nDomain specific languages (16)\nEditors (1)\nJetbrains MPS (11)\nLanguage design (13)\nLanguage Engineering (33)\nMiscellany (5)\nModel driven development (4)\nNatural Language Processing (1)\nNon software development (4)\nOpen-source (8)\nParsing (22)\nResearch (4)\nSoftware Development (16)\nSoftware Engineering (13)\nTurin Programming Language (4)\nWhole Platform (2)\nXtext (3)\nMenu\nAbout me\nHow I work\nLanguage Engineering Services\nANTLR Consulting\nJetbrains MPS Consulting\nContact\nLinkedIn\nBlog Categories\nANTLR (17)\nApplication modernization (2)\nCode processing (24)\nConsulting (14)\nCreate a programming language (1)\nDomain specific languages (16)\nEditors (1)\nJetbrains MPS (11)\nLanguage design (13)\nLanguage Engineering (33)\nMiscellany (5)\nModel driven development (4)\nNatural Language Processing (1)\nNon software development (4)\nOpen-source (8)\nParsing (22)\nResearch (4)\nSoftware Development (16)\nSoftware Engineering (13)\nTurin Programming Language (4)\nWhole Platform (2)\nXtext (3)\nTags\nAutomation C# Clojure code generation dsl effectivejava formats Frege Functional programming guide Haskell icse Image processing interpreters Interview java JavaParser JavaScript JavaSymbolSolver jetbrains mps Kotlin language integration language server protocol language worbenches Libav machine learning mbeddr mise natural language nlp Open-source opensource programming languages Python refactoring review Roslyn SparkWeb static-analysis testing tools TripAdvisor tutorial web WebAssembly\nDon’t miss the next updates!\nWant to join over 10.000+ people that keep learning more about DSLs, parsers, interpreters, compilers and language design?\nCount Me In!\n© 2018 Strumenta | Privacy Policy of Strumenta Websites\nTwitter\nLinkedin\nMail\nRss\nQuick Domain-Specific Languages in Python with textX\nScroll to top\nThis site uses cookies. By continuing to browse the site, you are agreeing to our use of cookies.\nPrivacy Policy of Strumenta WebsitesOK\nANTLR\nParsing SQL by Gabriele Tomassetti time to read: 22 min\nApplication modernization Why you should not use (f)lex, yacc and bison\n​Learn to Create Programming Languages\nSubscribe to ​our ​newsletter to get the FREE email course that teaches you how to create a programming language\nI want to create programming languages","cname":"解析SQL","ctext":"推特\n领英\n邮件\nRss\n服务\n产品展示\n学习建立语言\n学习处理代码\n像专业人士一样使用ANTLR\n通讯\n关于我\n聊一聊\n“ aria-hidden =” true“ data-av_icon =”“ data-av_iconfont =” entypo-fontello“ style =”“>搜索\n菜单\n博客\n解析SQL，2020年4月15日/在ANTLR中，代码处理，解析/作者：Gabriele Tomassetti\n您可以在协同存储库中找到本文中提供的代码\nSQL是一种用于处理关系数据库中的数据的语言。 如果使用数据，则可能使用SQL。\n它在HTML的同一个联盟中：也许您从未正式学习过它，但是您有点知道如何使用它。 那很棒，因为如果您了解SQL，就会知道如何处理数据。 但是，它有局限性，当您遇到限制时，您唯一的行动方法可能就是使用传统编程语言。 这并不一定意味着要从SQL迁移。 您可能需要从一种SQL方言转换为另一种方言，或者分析您使用的SQL代码。 为此，您需要解析SQL，这就是本文的目的。\nSQL的局限性是什么？ 一段时间后，您会发现一些问题：\n没有一种SQL，但是有很多变种。 用SQLite，MySQL，PostgreSQL等实现的SQL有点不同\n您无法完成与SQL中的数据相关的所有操作。 在某些情况下，您需要使用传统的编程语言来处理数据\n当您需要进行重大更改时，这些问题就变成了真正的问题。 例如，如果您需要更改大型应用程序使用的数据库。 当您需要进行SQL和数据库无法处理的转换时，这也可能是一个问题。 在这种情况下，您需要在SQL中进行一些转换（并在数据库上运行），并在源代码中进行其他转换。 因此，您将花费大量时间来研究胶合代码和SQL的局限性。\nSQL也可能是其不足的一个限制：与源代码以及可与Java，C＃等一起使用的所有其他工具集成的单元测试。SQL是一种古老的语言，并非为大规模编程而设计。 不是开发人员会喜欢的语言。 更糟糕的是，他们将不会非常有生产力。 如果您的应用程序要求您验证某些东西是否以某种方式执行或提供某些保证，会发生什么？ 它可以是业务需求或法规要求。 然后，您需要解析SQL或找到一种从SQL世界过渡到编程语言世界的方法。\n这就是本文的目的：解析SQL。 我们将看到用于解析SQL的现成的库和工具，以及一个示例项目，我们将在其中构建自己的SQL解析器。\n什么是SQL\nSQL（结构化查询语言）是一种特定于域的语言，旨在处理关系数据库中的数据。 这是一种声明性语言，因此您要描述要实现的目标（例如，给我一行id = 5的数据）而不是实现方式（例如，遍历各行直到id = 5）。 它具有关系代数和微积分的正式数学基础。 该语言是定期更新的ISO / IEC标准，最新版本是SQL2016。 这意味着，如果需要，可以对语言进行非常正式和清晰的描述。\nSQL旨在处理使用数据的生命周期的许多方面：是的，您可以查询数据，但也可以创建数据格式（即表的架构）并管理对数据的访问控制。\nSQL过程扩展\n实际的SQL实现带有过程扩展，这些扩展实现了某种形式的过程编程。 这些因数据库引擎而异。 添加它们是为了直接对数据库中的数据执行复杂的处理，因此它们可以像传统编程语言一样强大。 如果您尝试解析SQL，这也可能会更加令人头疼。 例如，请参见这是来自Wikipedia的PL / SQL（来自Oracle数据库的过程SQL）示例。\n声明VAR NUMBER；\n开始/*N.B。 pl / sql中的for循环变量是新的声明，作用域仅在循环内* / FOR var IN 0 .. 10 LOOP DBMS_OUTPUT.PUT_LINE（var）; 结束循环； 如果（var IS NULL）THEN DBMS_OUTPUT.PUT_LINE（'var is null'）; ELSE DBMS_OUTPUT.PUT_LINE（'var不为null'）; 万一;\n结束;\n宣布\nvar NUMBER;\n开始\n/*N.B。 pl / sql中的for循环变量是新的声明，作用域仅在循环内* /\nFOR VAR IN 0 .. 10循环\nDBMS_OUTPUT.PUT_LINE（var）;\n结束循环；\n如果（var IS NULL）THEN\nDBMS_OUTPUT.PUT_LINE（'var is null'）;\n其他\nDBMS_OUTPUT.PUT_LINE（'var不为null'）;\n万一;\n结束;\n声明VAR NUMBER；\n开始/*N.B。 pl / sql中的for循环变量是新的声明，作用域仅在循环内* / FOR var IN 0 .. 10 LOOP DBMS_OUTPUT.PUT_LINE（var）; 结束循环； 如果（var IS NULL）THEN DBMS_OUTPUT.PUT_LINE（'var is null'）; ELSE DBMS_OUTPUT.PUT_LINE（'var不为null'）; 万一;\n结束;\n资源资源\n正如我们已经看到的那样，处理SQL可能是一项艰巨的任务，因此，让我们看一些帮助您的资源。 它们的范围从语法开始您的语法分析工作到现成的工具。\n知识官方来源\n最新的官方SQL标准正式称为ISO / IEC 9075 SQL：2016。 您可以在ISO或IEC网站的官方资源中找到所需的所有信息。 但是，请记住，有几个描述该标准的文档，您必须为每个文档付费。 这意味着，根据汇率的不同，总成本可能超过2,000美元。\n数据库文档的官方参考\n除了官方的SQL标准，您还可以查找数据库生产者的官方文档，其中包含有关其SQL实现的参考。 以下是几个主要的列表：\nOracle PL / SQL文档\nMySQL 8 SQL参考\nMicrosoft Transact-SQL参考\nPostgreSQL 12 SQL语言\nIBM DB2 SQL\nSQLite理解的SQL\n文法\n有几种（通常是部分的）不同格式的语法。 它们可以成为到达所需位置的良好起点。\n适用于SQL-92，SQL-99和SQL-2003的BNF语法\nANTLR4的部分Teradata SQL语法\nANTLR v4语法库包含MySQL，PL / SQL，T-SQL和SQLite的语法。 在我们的ANTLR课程中，我们分析SQLite语法以解释其结构以及如何解析诸如SQL之类的声明性语言。\n图书馆\n有很多库可以解析不同语言的SQL。 有些支持不同的数据库和不同的编程语言。 这是最常用的列表。 除非另有说明，否则这些库是根据开放源代码许可证发布的。\n多语言和/或多数据库\nGeneral SQL Parser是一个商业库，支持许多数据库（DB2，Greenplum，Hana，Hive，Impala，Informix，MySQL，Netezza，Oracle，PostgreSQL，Redshift SQL Server，Sybase和Teradata）和语言（C＃，VB.NET， Java，C / C ++，Delphi，VB）。 它可以验证SQL语法，格式化SQL并使用解析树\nJSqlParser解析一条SQL语句，并将其转换为Java类的层次结构。 它是开源的，具有LGPL和Apache的双重许可，并支持许多数据库：Oracle，SqlServer，MySQL，PostgreSQL等。\nMySQL解析器\nPingcap解析器是Go中的MySQL解析器。\nxwb1989 / sqlparser是Go的MySQL解析器。 该解析器是从Vitess中提取的，Vitess是一个用于MySQL的水平扩展的数据库集群系统。\nPHP SQL解析器是（主要）用PHP编写的MySQL（非验证）解析器。 它可以通过一些修改来解析其他SQL方言。 它完全支持解析最常用的SQL语句，但是仅返回有关其他语句的一些信息。\nphpmyadmin的SQL解析器是一个验证的SQL词法分析器和解析器，重点是MySQL方言。 考虑到它在PHPMyAdmin中的使用，它肯定已经过测试。\njs-sql-parser是用于JavaScript的SQL（仅选择）解析器，可将SQL的MySQL 5.7版本解析为AST。\nSQLite解析器\nsqlite-parser是使用JavaScript编写的SQLite v3解析器，可生成AST。\nSQL解析器\nsql-parser是用纯JavaScript编写的SQL解析器。 它不再维护，仅支持某些SELECT查询，但是如果需要使用JavaScript，它可能比从头开始更好。\nhyrise / sql-parser是C ++的SQL解析器。 它将给定的SQL查询解析为C ++对象。 它是与内存数据库Hyrise一起开发的，但是可以单独使用。\nandialbrecht / sqlparse是用于Python的非验证SQL解析器。 它提供了对SQL语句的解析，拆分和格式化的支持。\nK2InformaticsGmbH / sqlparse是用纯Erlang编写的可用于生产的SQL解析器。 它针对Oracle PL / SQL方言。\nsqlparser-rs是用Rust编写的SQL解析器。 它支持SQL-92，以及MS-SQL，PostgreSQL和SQL：2011的一些附加功能。 开发人员说：如果您正在评估该项目是否适合您的需求，则可能需要实验验证其是否支持所需的SQL子集。\nmoz-sql-parser是由Mozilla编写的Python特有的SQL解析器。 该库的主要目的是将SQL-92查询的某些子集转换为可实现JSON的解析树。\nqueryparser是用Haskell编写的解析器，用于解析和分析Vertica，Hive和Presto SQL。\n工具从SQL到编程语言或其他SQL\nIO64提供了将PL / SQL转换为Java的工具。 在上一篇文章“将PL / SQL代码转换为Java”中，我们也看到了此工具。\nIspirer是一家提供工具以执行从不同SQL方言到另一种SQL方言或编程语言的数据库迁移的工具：Ispirer MnMTK。 我们在上一篇文章《将PL / SQL代码转换为Java》中已经看到了\nSQLines SQL Converter是一个开放源代码工具，用于将SQL方言转换为其他SQL方言。 它是用C ++编写的，并实现了自己的SQL解析器。\n解析说明性语言有多困难？\n声明性语言的结构往往比普通编程语言更简单。 例如，在声明性语言中看不到使用许多嵌套的lambda。 声明性语言的程序通常是一长串简单的语句。 问题在于，在某些情况下，任何一条语句都可能相当复杂。 这就是SQL中发生的情况。\n声明性语言的结构往往比普通编程语言更简单。 例如，在声明性语言中看不到使用许多嵌套的lambda。 声明性语言的程序通常是一长串简单的语句。 问题在于，在某些情况下，任何一条语句都可能相当复杂。 这就是SQL中发生的情况。...\n例如，您当然熟悉SELECT语句。 在其基本格式中，就像SELECT名称来自WHERE id = 1的客户一样，它很容易解析。 但是，完整的语句可能相当复杂。 该图像表示在SQLite中实现的SELECT语句。\n因此，要实现对一般情况的分析的支持肯定会花费一些时间。\n尝试解析您的应用程序\n现实情况是，实现对解析整个SQL的支持需要大量的精力，可能与解析任何普通编程语言一样多。 甚至，如果您需要解析许多不同的SQL方言。 然后，如果您需要解析SQL并且不能依赖现成的库，则应该从需求分析开始。 您应该首先尝试准确地理解您需要解析的内容，然后再根据您的应用程序进行解析。 这意味着既解析您所需的内容，又以使您的生活更轻松的方式来构造语法。\n例如，如果您只需要一次翻译一系列SQL文件，则可以忽略40条复杂的语句。 也许手动翻译它们比创建一个大型语法自动完成需要的时间更少。 如果您有很多代码，或者需要重复执行翻译，而不仅仅是一次，则此方法不起作用。\n在本教程中，我们将使用这种务实的方法：我们将从头开始创建SQL语法，以解析所需的内容，而忽略其余内容。\n编写（非常部分的）语法\n在我们的示例中，我们将解析一个简单的SQL文件（导出的数据库）以生成可以表示该数据库的类。 我们将忽略其他所有内容，即使文件中存在任何导出的数据。 而已。 处理SQL文件的优点是我们不需要与数据库进行交互。 实际上，该数据库甚至可能不再存在。\n设计部分语法\n为此，我们将从语法开始。 我们将要编写一个非常简单的代码，但是要记住以下几点：\nSQL不区分大小写，而默认情况下，ANTLR语法是\n我们的输入（SQL文件）将包含一些我们不关心的数据。 我们仍然需要成功解析文件，而忽略无关的输入\n这些是特定于SQL和我们的方法的显着问题。 它们可能不会与其他语言一起出现，或者如果我们想创建一个完整的语法。\n在开始之前，只是为了让您大致了解我们必须处理的内容，这是一个示例SQL文件。\n--\n-表角色的表结构\n--\n-DROP TABLE演员； 创建表actor（actor_id数字NOT NULL，first_name VARCHAR（45）NOT NULL，last_name VARCHAR（45）NOT NULL，last_update TIMESTAMP NOT NULL，主键（actor_id））; 创建索引idx_actor_last_name ON actor（last_name）\n; CREATE TRIGGER actor_trigger_ai AFTER INSERT ON actor BEGIN UPDATE actor SET last_update = DATETIME（'NOW'）WHERE rowid = new.rowid; 结束\n;\n--\n-表角色的表结构\n--\n-DROP TABLE演员；\nCREATE TABLE actor（\nactor_id数字NOT NULL，\nfirst_name VARCHAR（45）NOT NULL，\nlast_name VARCHAR（45）NOT NULL，\nlast_update TIMESTAMP NOT NULL，\n主键（actor_id）\n)\n;\n创建索引idx_actor_last_name ON actor（last_name）\n;\n创建触发actor_trigger_ai后插入actor\n开始\nUPDATE actor SET last_update = DATETIME（'NOW'）WHERE rowid = new.rowid;\n结束\n;\n--\n-表角色的表结构\n--\n-DROP TABLE演员； 创建表actor（actor_id数字NOT NULL，first_name VARCHAR（45）NOT NULL，last_name VARCHAR（45）NOT NULL，last_update TIMESTAMP NOT NULL，主键（actor_id））; 创建索引idx_actor_last_name ON actor（last_name）\n; CREATE TRIGGER actor_trigger_ai AFTER INSERT ON actor BEGIN UPDATE actor SET last_update = DATETIME（'NOW'）WHERE rowid = new.rowid; 结束\n;\n乍看之下，我们需要解析CREATE TABLE语句，而忽略其他语句。 我们还需要忽略CREATE TABLE语句的某些部分，因为它们不包含我们关心的任务信息。\n如何忽略东西\n设计部分语法的关键是理解如何忽略除了我们关心的内容之外的所有内容。 这并非微不足道，因为我们有两个相互矛盾的需求：忽略或丢弃大多数信息，并保留所有必要的上下文来解析我们需要的内容。 我们越不理会，最难的就是解析我们需要的东西。 对于词法分析，这尤其棘手，因为词法分析器可用于决策的信息较少。\n例如，在找到CREATE令牌之前，我们不能只说忽略任何内容。 这是因为词法分析器仍会为行定义中的元素找到标记，例如在INSERT语句或CREATE INDEX中为列命名的标记（例如last_name）。 一种可能的解决方法是词汇模式。 这些是包括多套词法分析器规则并在它们之间切换的方法。 如果您需要了解更多信息，请参阅我们的ANTLR Mega教程。\n从本质上讲，我们将SQL当作一种标记语言来对待：大量自由文本中我们可以忽略的结构化信息。 在我们的情况下，这可以工作，因为SQL具有规则的结构，而我们只对CREATE TABLE语句感兴趣。 对于常规结构，我们的意思是SQL文件只是一个语句列表，每个语句以分号结尾。 因此，我们可以制作一个CREATE TABLE令牌来启动特殊词法模式，并使用分号结束特殊词法模式。 但是，它不是灵活的，因此如果我们需要将语法用于其他内容，则会带来风险。\n忽略事物的认知方式\n我们的首选方法更加灵活，也可以用于常规编程语言。\n在词法分析器方面，我们只是将此ANY规则作为最后的词法分析器规则。\n在词法分析器方面，我们只是将此ANY规则作为最后的词法分析器规则。...\n在词法分析器方面，我们只是将此ANY规则作为最后的词法分析器规则。...\n在词法分析器方面，我们只是将此ANY规则作为最后的词法分析器规则。...\n我们跳过每个字符，这些字符以前的标记尚未识别。\n在解析器方面，这些将是我们的主要规则。\n陈述：（陈述|忽略）+ EOF; 声明：createStmt; 忽视 ： 。*？ SEMICOLON | 评论;\n陈述：（陈述|忽略）+ EOF\n;\n声明：createStmt\n;\n忽视 ： 。*？ 分号\n| 评论\n;\n陈述：（陈述|忽略）+ EOF; 声明：createStmt; 忽视 ： 。*？ SEMICOLON | 评论;\n主要规则是语句，它捕获了我们关心的内容和要忽略的内容。 这种方法使我们可以在构建语法时开始使用语法。 对于此示例，我们只需要解析CREATE TABLE语句，但是您可以慢慢添加对使用此结构来解析更多语句的支持。\n我们需要忽略规则以保持对SQL文件结构的理解。 没有这个规则，我们将无法识别和解析我们感兴趣的语句。负面影响是，它将使忽略节点的解析树变得混乱。 例如，这是使用ANTLR测试实用程序grun制作的示例分析树的图形表示。\n解析创建语句\n我们使用类似的方法来解析CREATE TABLE语句。\ncreateStmt：创建表（如果不存在）？ tableName = name LPAREN元素（COMMA元素）* RPAREN？ SEMICOLON; 元素：定义| 可忽略的; ignorable ：（主键|约束| SPECIAL_FEATURES | FULLTEXT）。*？ （COMMA | RPAREN）； 定义：名称类型为defaultValue？ 可空性？ 属性*;\ncreateStmt：创建表（如果不存在）？ tableName =名称\nLPAREN元素（COMMA元素）* RPAREN？\n分号\n;\n元素：定义\n| 可忽略的\n;\nignorable ：（主键|约束| SPECIAL_FEATURES | FULLTEXT）。*？ （COMMA | RPAREN）\n;\n定义：名称类型为defaultValue？ 可空性？ 属性*;\ncreateStmt：创建表（如果不存在）？ tableName = name LPAREN元素（COMMA元素）* RPAREN？ SEMICOLON; 元素：定义| 可忽略的; ignorable ：（主键|约束| SPECIAL_FEATURES | FULLTEXT）。*？ （COMMA | RPAREN）； 定义：名称类型为defaultValue？ 可空性？ 属性*;\n该语句既包含我们需要的列定义，又包含我们可以忽略的表设置。 因此，我们的元素规则既可以接受行的定义，也可以接受有关主键，约束等的信息。稍后，在我们的代码中，我们将简单地忽略忽略和可忽略的节点。\n规则本身很容易理解，并且对于所有看过SQL的人来说都是显而易见的。 只有一个肮脏的把戏需要解释。 您可以看到，应该在列定义列表的末尾加上右括号（RPAREN）是可选的。 从技术上讲这是不正确的，它应该一直存在。 但是，我们使用它来解决有关可忽略规则的问题。\n解决实际解析设置的需求\n问题在于，可忽略规则只是对这些设置的解析的部分实现，您可以在SQL文件中找到这些设置。 实际上，这是正确解析我们遇到的一堆示例SQL文件所必需的最低要求。 这不是一个好的设计，但这是一个非常现实的实现。 查看此示例，看看是否可以发现我们的问题。\nCREATE TABLE city（city_id int NOT NULL，city VARCHAR（50）NOT NULL，country_id SMALLINT NOT NULL，last_update TIMESTAMP NOT NULL，PRIMARY KEY（city_id），CONSTRAINT fk_city_country FOREIGN KEY（country_id）参考国家（country_id）ON删除 更新级联\n);\n创建表城市（\ncity_id int NOT NULL，\n城市VARCHAR（50）NOT NULL，\ncountry_id SMALLINT NOT NULL，\nlast_update TIMESTAMP NOT NULL，\n主键（city_id），\nCONSTRAINT fk_city_country外键（country_id）参考国家（country_id）开删除对更新级联无操作\n);\nCREATE TABLE city（city_id int NOT NULL，city VARCHAR（50）NOT NULL，country_id SMALLINT NOT NULL，last_update TIMESTAMP NOT NULL，PRIMARY KEY（city_id），CONSTRAINT fk_city_country FOREIGN KEY（country_id）参考国家（country_id）ON删除 更新级联\n);\n此部分实现存在一个问题，即当它发现设置结束时解析得不够好。 因此，它将最终设置的逗号（即，新设置的开始）或最后的右括号（即，元素列表的结尾）用作线索。\n现在，使用这个肮脏的把戏有多安全？ 在这种情况下，这是安全的，因为SQL文件不是由人类编写的，而是通过工具导出的。 这意味着不会缺少括号，该括号会破坏对后续语句的识别。 因此，我们实际上可以确保每个CREATE TABLE都将以右括号和分号结尾。 这可能因语言，SQL语句的不同来源或数据库而异。\n当您只需要部分实现语法时，这些技巧将对加速开发和更快地完成任务很有帮助。 您必须小心并意识到风险，但是它们可能会有用。\n其余的语法\n语法的其余部分也很容易理解。 我们只提到了几件事。\n名称：QUOTE？ 名称报价？ ;\n名称：QUOTE？ 名称报价？ ;\n名称：QUOTE？ 名称报价？ ;\n规则名称是解析器规则，而不是词法分析器规则。 那是因为有些工具用诸如'或'的双引号将列名引起来（在某些语言中，它们也被用作撇号）。 通过此定义，在我们的代码的后面，我们可以轻松提取列的真实名称，而无需检查引号。\n类型：（INTEGER | INT）是否未签名？ #integerType | （TINYINT | SMALLINT）未签名？ #smallIntegerType | TEXT #textType | BLOB（SUBTYPE类型）？ #blobType | （VARCHAR | CHARVAR）LPAREN号码RPAREN #varcharType | CHAR LPAREN NUMBER RPAREN＃字符类型| YEAR #yearType | DATETIME #datetimeType | 时间戳时区？ #timestampType | （数字|十进制）（LPAREN精度= NUMBER（COMMA刻度= NUMBER）？RPAREN）？ #decimalType;\n类型：（INTEGER | INT）是否未签名？ #integerType\n| （TINYINT | SMALLINT）未签名？ #smallIntegerType\n| TEXT #textType\n| BLOB（SUBTYPE类型）？ #blobType\n| （VARCHAR | CHARVAR）LPAREN号码RPAREN #varcharType\n| 四个Laperen编号Rparen＃Chartitepe\n| YEAR #yearType\n| DATETIME #datetimeType\n| 时间戳时区？ #timestampType\n| （数字|十进制）（LPAREN精度= NUMBER（COMMA刻度= NUMBER）？RPAREN）？ #decimalType\n;\n类型：（INTEGER | INT）是否未签名？ #integerType | （TINYINT | SMALLINT）未签名？ #smallIntegerType | TEXT #textType | BLOB（SUBTYPE类型）？ #blobType | （VARCHAR | CHARVAR）LPAREN号码RPAREN #varcharType | CHAR LPAREN NUMBER RPAREN＃字符类型| YEAR #yearType | DATETIME #datetimeType | 时间戳时区？ #timestampType | （数字|十进制）（LPAREN精度= NUMBER（COMMA刻度= NUMBER）？RPAREN）？ #decimalType;\n解析列类型的规则包括规则标签。 我们在稍后使用解析器的代码中设计了这种方式来简化我们的工作。 这也是原因，因为VARCHAR规则与CHAR规则分开。 在规则上，规则显然是相同的，但它们的含义有所不同。 请记住：您应该为您的应用程序进行解析，以使解析有效地满足您的需求。\n片段A：[aA]；\n片段B：[bB]；\n片段C：[cC]；\n片段D：[dD]；\n片段A：[this];\n//等\n片段A：[aA]；\n片段B：[bB]；\n片段C：[cC]；\n片段D：[dD]；\n片段A：[this];\n//等\n片段A：[aA]；\n片段B：[bB]；\n片段C：[cC]；\n片段D：[dD]；\n片段A：[this];\n//等\n由于SQL不区分大小写，因此我们在需要的所有地方都使用字母的片段，以确保正确解析所有内容。\n您可以在协同存储库中看到语法的其余部分。\n创建C＃项目\n我们终于可以看到一些代码了。 因为我们使用VS Code作为编辑器，所以我们将从命令行创建一个C＃项目。 这些是创建项目和添加ANTLR库的说明。\n//在某处创建一个新目录\n//创建一个新的C＃项目\ndotnet新控制台-lang C＃\n//安装标准的ANTLR 4 Runtime\ndotnet添加软件包Antlr4.Runtime.Standard\n//在某处创建一个新目录\n//创建一个新的C＃项目\ndotnet新控制台-lang C＃\n//安装标准的ANTLR 4 Runtime\ndotnet添加软件包Antlr4.Runtime.Standard\n//在某处创建一个新目录\n//创建一个新的C＃项目\ndotnet新控制台-lang C＃\n//安装标准的ANTLR 4 Runtime\ndotnet添加软件包Antlr4.Runtime.Standard\n这些是生成解析器和运行程序的指令。\n//生成解析器\nantlr4 SQL.g4 -Dlanguage = CSharp -o生成\\-编码UTF-8\n//运行程序\n网络运行\n//生成解析器\nantlr4 SQL.g4 -Dlanguage = CSharp -o生成\\-编码UTF-8\n//运行程序\n网络运行\n//生成解析器\nantlr4 SQL.g4 -Dlanguage = CSharp -o生成\\-编码UTF-8\n//运行程序\n网络运行\n甚至我们的主要源代码文件也是相当标准的。\n静态void Main（string [] args）\n静态void Main（string [] args）...\n}\n静态void Main（string [] args）\n{\n//标准的ANTLR代码\n//我们得到输入\nICharStream chars = CharStreams.fromPath（args [0]）;\n//我们设置词法分析器\nSQLLexer lexer =新的SQLLexer（chars）;\n//我们使用词法分析器\nCommonTokenStream流=新的CommonTokenStream（lexer）;\n//我们设置解析器\nSQLParser解析器=新的SQLParser（stream）;\n//找到解析树的根节点\nvar tree = parser.statements（）;\n//我们创建访问者\nCreateVisitor createVisitor =新的CreateVisitor（）;\nCreateVisitor createVisitor =新的CreateVisitor（）;...\n//我们选择代码生成器...\nICodeGenerator生成器；\n// ...取决于命令行参数\n// ...取决于命令行参数...\ngenerator = new KotlinCodeGenerator（）;\n其他\ngenerator = new CSharpCodeGenerator（）;\nConsole.WriteLine（generator.ToSourceCode（“ SQLDataTypes”，类））;\n}\n静态void Main（string [] args）\n静态void Main（string [] args）...\n}\n评论是不言自明的。 在使用标准代码设置ANTLR并解析输入后，我们使用了CreateVisitor。 我们使用访问者访问create table语句并生成它们的内部表示。 然后，我们使用此表示形式以所选语言生成源代码文件。 在我们的示例中，我们选择使用Kotlin或C＃生成，以显示解析后使用SQL数据的操作有多么容易。\n这是简单的整体结构； 现在，我们可以继续进行各个部分的操作。\n查阅声明\n让我们从访问者的整体组织开始。\n公共类CreateVisitor\n公共类CreateVisitor...\n公共类CreateVisitor\n{\n公共类CreateVisitor......\n{\n公共类CreateVisitor.........\nforeach（context.statement（）中的var语句）\n{\ntable.Add（VisitStmt（statement））;\n}\n返回表；\n}\n公共ClassDescriptor VisitStmt（StatementContext上下文）\n{\n返回VisitCreateStmt（context.createStmt（））;\n}\n公共ClassDescriptor VisitCreateStmt（CreateStmtContext上下文）\n{\nClassDescriptor表=新的ClassDescriptor（）;\ntable.Name = context.tableName.NAME（）。GetText（）;\ntable.Name = context.tableName.NAME（）。GetText（）;...\nforeach（context.element（）中的var el）\n{\nif（el.definition（）！= null）\n{\ntable.Fields.Add（VisitDefinition（el.definition（）））;\n}\n}\n退货表;\n}\n[..]\n公共类CreateVisitor\n公共类CreateVisitor...\n我们注意到的第一件事是，我们不需要使用ANTLR可以为我们创建的标准基本访问者。 我们的访客仅使用我们的代码。 由于SQL文件的结构以及我们确切知道需要访问的内容，因此我们不需要使用基本访问者。 我们可以完全忽略不是create语句的所有内容，因为SQL文件中的每个语句都是顶级元素。 它不像普通的编程语言中的语句那样，可以嵌套在代码块，函数定义等内部。此外，create语句的结构很简单，因此我们可以自己访问所有内容。\n简而言之，我们需要做的是：\n访问报表节点\n然后访问每个语句节点（我们忽略忽略节点）并选择createStmt节点\n访问createStmt节点，我们仅选择定义节点（我们忽略可忽略的节点）以获取所有列的定义\n将类型从SQL转换为您的语言\n在VisitDefinition方法内部，我们处理此访问者的唯一真正复杂问题：处理类型。\n在VisitDefinition方法内部，我们处理此访问者的唯一真正复杂问题：处理类型。...\n公共FieldDescriptor VisitDefinition（DefinitionContext上下文）\n{\n字符串名称= context.name（）。NAME（）。GetText（）;\nTypeDescriptor类型；\n开关（context.type（）。GetType（）。名称）\n{\n情况“ IntegerTypeContext”：\ntype = VisitIntegerType（context.type（）as IntegerTypeContext）;\n打破;\n情况“ SmallIntegerTypeContext”：\n类型= VisitSmallIntegerType（context.type（）为SmallIntegerTypeContext）;\n打破;\n案例“ VarcharTypeContext”：\ntype = VisitVarcharType（context.type（）as VarcharTypeContext）;\n打破;\n情况“ TimestampTypeContext”：\ntype = VisitTimestampType（context.type（）as TimestampTypeContext）;\n打破;\n情况“ TextTypeContext”：\ntype = VisitTextType（context.type（）as TextTypeContext）;\n打破;\n情况“ DecimalTypeContext”：\ntype = VisitDecimalType（context.type（）as DecimalTypeContext）;\n打破;\n情况“ CharTypeContext”：\ntype = VisitCharType（context.type（）as CharTypeContext）;\n打破;\n情况“ BlobTypeContext”：\ntype =访问Blob类型（content.type（）作为Blob类型上下文）；\n打破;\n默认：\n类型= null;\n打破;\n}\n类型= null;...\ntype.Nullability = false;\n返回新的FieldDescriptor（name，type）;\n}\n在VisitDefinition方法内部，我们处理此访问者的唯一真正复杂问题：处理类型。...\n问题是我们需要识别每种类型，然后以与编程语言兼容的方式来翻译它。 实际上，SQL数据类型和编程语言数据类型可以不同。 例如，SQL具有可变和固定大小的char数组类型，这在编程语言中不太重要。\n我们已经通过为类型语法规则的每个选项创建标签来轻松识别每种类型的工作。 现在，我们只需要使用其他方法即可正确访问每个节点。\n在查看VisitIntegerType和VisitSmallIntegerType的示例之前，请注意几件事。 首先，我们仅在第37-38行处理一次类型的可空性。 其次，我们仅处理某些类型，这些类型用于示例SQL文件中。\n私有TypeDescriptor VisitSmallIntegerType（SmallIntegerTypeContext context）{if（context.UNSIGNED（）！= null）返回新的IntegerTypeDescriptor（2，true）; 否则返回new IntegerTypeDescriptor（2）; }私有TypeDescriptor VisitIntegerType（IntegerTypeContext context）{if（context.UNSIGNED（）！= null）返回新的IntegerTypeDescriptor（4，true）; 否则返回new IntegerTypeDescriptor（4）; }\n私有TypeDescriptor VisitSmallIntegerType（SmallIntegerTypeContext上下文）\n{\nif（context.UNSIGNED（）！= null）\n返回新的IntegerTypeDescriptor（2，true）;\n其他\n返回新的IntegerTypeDescriptor（2）;\n}\n私有TypeDescriptor VisitIntegerType（IntegerTypeContext上下文）\n{\nif（context.UNSIGNED（）！= null）\n返回新的IntegerTypeDescriptor（4，true）;\n其他\n返回新的IntegerTypeDescriptor（4）;\n}\n私有TypeDescriptor VisitSmallIntegerType（SmallIntegerTypeContext context）{if（context.UNSIGNED（）！= null）返回新的IntegerTypeDescriptor（2，true）; 否则返回new IntegerTypeDescriptor（2）; }私有TypeDescriptor VisitIntegerType（IntegerTypeContext context）{if（context.UNSIGNED（）！= null）返回新的IntegerTypeDescriptor（4，true）; 否则返回new IntegerTypeDescriptor（4）; }\n这两种方法代表了我们要做的很少的工作。 每个方法都返回特定于每种类型的TypeDescriptor。\n方法很简单，但是由于每种类型不同而不同。 对于整数类型，我们需要检查类型是否为无符号。 对于所有整数类型，我们仅使用一个IntegerTypeDescriptor。 这仅仅是因为可以用相同的方式描述它们：从我们的角度来看，整数类型之间的唯一区别是它们所需的字节数。\nTypeDescriptor类本身也相当琐碎。 它们只是一系列包含每种类型的特定信息的类。\n公共枚举BaseType\n{整数，浮点型，十进制，文本，二进制，ArrayCharacters，年，日期时间\n}公共类TypeDescriptor\n{public BaseType Type {get; 保护集； } public bool可空性{get; 组; } = true;\n}公共类IntegerTypeDescriptor：TypeDescriptor\n{public int Bytes {get; 私人套装； } public bool Unsigned {get; 私人套装； } public IntegerTypeDescriptor（int bytes，bool unsigned = false）{类型= BaseType.Integer; 字节=字节; 无符号=无符号; }\n}\n公共枚举BaseType\n{\n整数，\n浮动\n十进制\n文本，\n二进制\nArrayCharacters，\n年，\n约会时间\n}\n公共类TypeDescriptor\n{\n公共BaseType类型{ 保护集； }\n公共布尔Nullability {get; 组; } = true;\n}\n公共类IntegerTypeDescriptor：TypeDescriptor\n{\npublic int Bytes {get; 私人套装； }\n公共布尔未签名{ 私人套装； }\npublic IntegerTypeDescriptor（int bytes，bool unsigned = false）\n{\n类型= BaseType.Integer;\n字节=字节;\n无符号=无符号;\n}\n}\n公共枚举BaseType\n{整数，浮点型，十进制，文本，二进制，ArrayCharacters，年，日期时间\n}公共类TypeDescriptor\n{public BaseType Type {get; 保护集； } public bool可空性{get; 组; } = true;\n}公共类IntegerTypeDescriptor：TypeDescriptor\n{public int Bytes {get; 私人套装； } public bool Unsigned {get; 私人套装； } public IntegerTypeDescriptor（int bytes，bool unsigned = false）{类型= BaseType.Integer; 字节=字节; 无符号=无符号; }\n}\n您可以在协同存储库上看到其余的内容。\n生成代码\n我们对原始SQL代码进行了自定义表示：所有适合我们需求的表的描述。 现在我们可以生成相应的源代码。 我们将使用多种语言生成代码：C＃和Kotlin。 我们这样做是为了证明一旦从SQL中获取信息后执行任何操作都是多么容易，并且这两种语言都有不同的限制。\n用C＃生成代码\n让我们从看到C＃开始。 我们只有一个公共方法：ToSourceCode，它接受名称空间和一系列类/表定义。\n公共类CSharpCodeGenerator：ICodeGenerator\n公共类CSharpCodeGenerator：ICodeGenerator...\n公共类CSharpCodeGenerator：ICodeGenerator\n{\n公共类CSharpCodeGenerator：ICodeGenerator......\n{\nStringBuilder sourceCode = new StringBuilder（）;\n//打开名称空间\nsourceCode.AppendLine（$“ namespace {idNamespace}”）;\nsourceCode.AppendLine（“ {”）;\nforeach（类中的var c）\n{\nsourceCode.AppendLine（$“ \\ tpublic类{c.Name}”）;\nsourceCode.AppendLine（“ \\ t {”）;\nforeach（c.Fields中的var f）\n{\n开关（f.Type.Type）\n{\n案例BaseType.Integer：\nsourceCode.AppendLine（$“ \\ t \\ tpublic {GenerateInt（f.Type as IntegerTypeDescriptor）} {f.Name} {{get; set;}}”））;\n打破;\n案例BaseType.Text：\nsourceCode.AppendLine（$“ \\ t \\ t公共字符串{f.Name} {{get; set;}}”））;\n打破;\n案例BaseType.ArrayCharacters：\nsourceCode.AppendLine（$“ \\ t \\ tpublic {GenerateCharArray（f.Name，f.Type as CharArrayTypeDescriptor）}”）;;\n打破;\n案例BaseType.DateTime：\nsourceCode.AppendLine（$“ \\ t \\ tpublic DateTime {f.Name} {{get; set;}}”））;\n打破;\n案例BaseType.Decimal：\nsourceCode.AppendLine（$“ \\ t \\ t十进制{f.Name} {{get; set;}}”））;\n打破;\n案例BaseType.Binary：\nsourceCode.AppendLine（$“ \\ t \\ tpublic bytes [] {f.Name} {{get; set;}}”））;\n打破;\n}\n}\nsourceCode.AppendLine（“ \\ t}”）;\nsourceCode.AppendLine（）;\n}\n//关闭名称空间\nsourceCode.AppendLine（“}”）;\n返回sourceCode.ToString（）;\n}\n[..]\n公共类CSharpCodeGenerator：ICodeGenerator\n公共类CSharpCodeGenerator：ICodeGenerator...\n此方法负责生成整个新的源代码文件。 它处理封闭的名称空间（对于C＃文件是必需的）和整个类。\n我们将列转换为属性。 这些是显而易见的选择，因为很容易预料到我们将需要转换来自SQL的任何其他格式的数据，以使用我们的编程语言进行处理。 例如，日期将不同。 我们还需要以某种方式强制使用固定大小的数组。 这是因为编程语言通常没有定义明确的方式来处理太大或太小的输入。 取而代之的是，数据库可以自动执行诸如填充空格太短的输入之类的操作。\n通常有以下三种情况：\n该类型具有完美的对应关系（例如，第23-24行，TEXT变为String）。 因此，我们只是直接编写属性。\n该类型仅具有部分但无歧义的对应关系（例如，第32-33行DECIMAL变为Decimal，但SQL和C＃类型的行为有所不同）。 例如，SQL十进制数使我们可以指定精度，以设置它可以容纳的位数。 在C＃中，您不能这样做。 通常我们需要照顾这种差异，在我们的示例中，我们只是忽略了这个问题\n类型具有多个对应关系（例如，第20-21行INT，SMALLINT变为int，short），因此我们使用一种方法来处理它们\n对于第三种情况，我们将看到整数示例。\n私有字符串GenerateInt（IntegerTypeDescriptor描述符）{StringBuilder intType = new StringBuilder（）; //我们忽略了可为空性，因为并非所有C＃类型都很好地支持它。if（descriptor.Unsigned == true）intType.Append（“ u”）; switch（descriptor.Bytes）{情况2：intType.Append（“ short”）; 打破; 情况4：intType.Append（“ int”）; 打破; 情况8：intType.Append（“ long”）; 打破; } return intType.ToString（）; }\n私有字符串GenerateInt（IntegerTypeDescriptor描述符）\n{\nStringBuilder intType =新的StringBuilder（）;\n//我们忽略了可空性，因为并非所有C＃类型都很好地支持它\nif（descriptor.Unsigned == true）\nintType.Append（“ u”）;\n开关（descriptor.Bytes）\n{\n情况2：\nintType.Append（“ short”）;\n打破;\n情况4：\nintType.Append（“ int”）;\n打破;\n情况8：\nintType.Append（“ long”）;\n打破;\n}\n返回intType.ToString（）;\n}\n私有字符串GenerateInt（IntegerTypeDescriptor描述符）{StringBuilder intType = new StringBuilder（）; //我们忽略了可为空性，因为并非所有C＃类型都很好地支持它。if（descriptor.Unsigned == true）intType.Append（“ u”）; switch（descriptor.Bytes）{情况2：intType.Append（“ short”）; 打破; 情况4：intType.Append（“ int”）; 打破; 情况8：intType.Append（“ long”）; 打破; } return intType.ToString（）; }\n我们可以在SQL和C＃中找到每个整数类型之间的完美对应。 由于整数类型在内部都以相同的方式表示，因此所有类型均取决于用于它们的字节数。 根据IntegerTypeDescriptor实例中存储的字节数，我们生成适当的C＃类型。\n唯一的问题是C＃本身：它没有对空性的完美支持。 在C＃8.0引用类型默认情况下可以为空之前，因此在我们的代码和任何第三方代码中使用可空类型都是相当不一致的。\n另一方面，我们可以轻松地处理无符号整数，我们只需要在u前面加上前缀即可使用无符号类型。\n在Kotlin中生成代码\n为Kotlin生成代码非常相似。\n公共类KotlinCodeGenerator：ICodeGenerator\n公共类KotlinCodeGenerator：ICodeGenerator...\n公共类KotlinCodeGenerator：ICodeGenerator\n{\n公共类CSharpCodeGenerator：ICodeGenerator......\n{\nStringBuilder sourceCode = new StringBuilder（）;\n//声明包\nif（！String.IsNullOrEmpty（idNamespace））\nsourceCode.AppendLine（$“ package {idNamespace}”）;\n//添加导入\nsourceCode.AppendLine（）;\nsourceCode.AppendLine（“ import java.time.LocalDateTime”）;\nsourceCode.AppendLine（“ import java.math.BigDecimal”）;\nsourceCode.AppendLine（）;\nforeach（类中的var c）\n{\nsourceCode.Append（$“数据类{c.Name}（”）;\nforeach（c.Fields中的var f）\n{\n开关（f.Type.Type）\n{\n案例BaseType.Integer：\nsourceCode.Append（$“ var {f.Name}：{GenerateInt（f.Type as IntegerTypeDescriptor）}”）;\n打破;\n案例BaseType.Text：\nsourceCode.Append（$“ var {f.Name}：String”）;\n打破;\n案例BaseType.ArrayCharacters：\nsourceCode.Append（$“ var {f.Name}：{GenerateCharArray（f.Type as CharArrayTypeDescriptor）}”）;;\n打破;\n案例BaseType.DateTime：\nsourceCode.Append（$“ var {f.Name}：LocalDateTime”）;\n打破;\n案例BaseType.Decimal：\nsourceCode.Append（$“ var {f.Name}：BigDecimal”）;\n打破;\n案例BaseType.Binary：\nsourceCode.Append（$“ var {f.Name}：ByteArray”）;\n打破;\n}\nif（f！= c.Fields.Last（））\nsourceCode.Append（“，”）;\n}\nsourceCode.AppendLine（“）”）;\nsourceCode.AppendLine（“”）;\n}\n返回sourceCode.ToString（）;\n}\n公共类KotlinCodeGenerator：ICodeGenerator\n公共类KotlinCodeGenerator：ICodeGenerator...\n没有结构上的差异。 唯一的变化取决于语言之间的差异。 例如，在Kotlin中不需要名称空间的等效项，即包。 我们还可以使用Kotlin中的特殊数据类直接在默认构造函数中快速定义其属性的类。\n另一方面，我们需要导入一些Java包，因为Kotlin并不直接拥有DateTime类型的类。 由于Kotlin可以在不同的环境中运行（即具有Java支持的JVM，JavaScript，具有C ++支持的本机），我们可能应该找到一种支持所有这些环境的方法。 在正常情况下，我们可能会在纯Kotlin中使用这些自定义类型（即KotlinDateTime）创建运行时，然后在单独的文件中添加对每个平台的支持。 这样，我们可以为所有环境生成一个Kotlin文件。 在这个示例中，这可能会显得过高，所以我们只考虑Kotlin在Java中运行。\n私有字符串GenerateInt（IntegerTypeDescriptor描述符）{StringBuilder intType = new StringBuilder（）; switch（descriptor.Bytes）{情况2：intType.Append（“ Short”）; 打破; 情况4：intType.Append（“ Int”）; 打破; 情况8：intType.Append（“ Long”）; 打破; } //我们忽略unsigned，因为在C＃中，它没有得到很好的支持if（descriptor.Nullability == true）intType.Append（“？”）; 返回intType.ToString（）; }\n私有字符串GenerateInt（IntegerTypeDescriptor描述符）\n{\nStringBuilder intType =新的StringBuilder（）;\n开关（descriptor.Bytes）\n{\n情况2：\nintType.Append（“ Short”）;\n打破;\n情况4：\nintType.Append（“ Int”）;\n打破;\n情况8：\nintType.Append（“ Long”）;\n打破;\n}\n//我们忽略unsigned，因为在C＃中没有很好的支持\nif（descriptor.Nullability == true）\nintType.Append（“？”）;\n返回intType.ToString（）;\n}\n私有字符串GenerateInt（IntegerTypeDescriptor描述符）{StringBuilder intType = new StringBuilder（）; switch（descriptor.Bytes）{情况2：intType.Append（“ Short”）; 打破; 情况4：intType.Append（“ Int”）; 打破; 情况8：intType.Append（“ Long”）; 打破; } //我们忽略unsigned，因为在C＃中，它没有得到很好的支持if（descriptor.Nullability == true）intType.Append（“？”）; 返回intType.ToString（）; }\n我们还可以看到，生成整数类型的方法在C＃和Kotlin中都非常相似。 不同之处在于，Kotlin始终支持可空性，而对无符号整数的支持仍在针对当前版本进行试验。\n摘要\n在本文中，我们已经看到了如何解析SQL。 通常，我们的建议是：\n考虑是否可以使用现有工具或库来处理SQL代码。 其中一些甚至支持多种SQL语言或多种编程语言。 如果您可以根据需要使用它们中的任何一个，那么它们应该是您的首选\n如果要内部构建解决方案，则可以考虑从可用于主要SQL数据库的少数ANTLR语法开始。 它们确实可以帮助您开始解析SQL\n如果您使用的是不太常见的SQL数据库，则可能会遇到麻烦。 从头开始解析SQL将是一项艰巨的工作：该语言具有相当简单的结构，但是它很大，它有很多变体，在某些情况下甚至是过程扩展。 在本文中，我们看到了一些技巧，即使使用部分语法也可以开始解析。 如果您只需要解析语言的一小部分，这可能是一个好方法\n如果这些选项都不适合您，并且您需要一些商业选项来支持您构建满足您需求的解决方案，那么Strumenta的我们可能会为您提供帮助。\n下载包含68种有关创建编程语言的资源的指南\n有空的时候可以收到收件箱指南，以在所有设备上阅读\n成功！ 现在检查您的电子邮件以确认您的订阅。\n提交您的订阅时出错。 请再试一遍。\n名字\n电子邮件地址\n我们使用此字段来检测垃圾邮件机器人。 如果填写，您将被标记为垃圾邮件发送者。\n我想接收免费的电子邮件课程。\n把它发给我！ 由ConvertKit提供支持\n标签：C＃，Kotlin，SQL，工具\nhttps://tomassetti.me/wp-content/uploads/2020/04/Parsing-SQL.jpg 5121024 Gabriele Tomassetti https://tomassetti.me/wp-content/uploads/2017/07/federico-tomassetti-software -architect-300.png Gabriele Tomassetti2020-04-15 10：58：482020-04-15 10：58：48解析SQL\n你可能还喜欢\n您需要解析器吗？\n我们可以为新语言设计解析器，或者为内部内置的现有语言重写解析器。\n然后，在解析器之上，我们可以帮助构建解释器，编译器，代码生成器，文档生成器或其他语言的翻译器（代码转换器）。\n说吧！\n课程：像专业人士一样使用ANTLR\n有关解析和ANTLR的完整视频课程，将教您如何为从编程语言到数据格式的所有内容构建解析器。\n由构建解析器为生的专业人士授课。\n书籍：如何创建实用的轻量级语言\n本书《构建语言》旨在以简单的方式构建具有解析器，编译器，解释器，编辑器等的生产语言。\n图书：JavaParser访问\n关于JavaParser的这本书将教您如何分析，转换和生成Java代码\n工具-咨询\n如果需要设计和开发DSL，语言，解析器，编译器，解释器和编辑器的帮助，则可以查看我们成立的咨询工作室的服务页面：Strumenta。\n博客类别\nANTLR（17）\n应用程序现代化（2）\n代码处理（24）\n咨询（14）\n创建一种编程语言（1）\n特定领域的语言（16）\n编辑（1）\nJetbrains MPS（11）\n语言设计（13）\n语言工程（33）\n杂记（5）\n模型驱动的开发（4）\n自然语言处理（1）\n非软件开发（4）\n开源（8）\n解析（22）\n研究（4）\n软件开发（16）\n软件工程（13）\n都灵编程语言（4）\n整个平台（2）\nXtext（3）\n菜单\n关于我\n我的工作方式\n语言工程服务\nANTLR咨询\nJetbrains MPS咨询\n联系\n领英\n博客类别\nANTLR（17）\n应用程序现代化（2）\n代码处理（24）\n咨询（14）\n创建一种编程语言（1）\n特定领域的语言（16）\n编辑（1）\nJetbrains MPS（11）\n语言设计（13）\n语言工程（33）\n杂记（5）\n模型驱动的开发（4）\n自然语言处理（1）\n非软件开发（4）\n开源（8）\n解析（22）\n研究（4）\n软件开发（16）\n软件工程（13）\n都灵编程语言（4）\n整个平台（2）\nXtext（3）\n标签\n自动化C＃Clojure代码生成dsl有效的Java格式弗雷格功能编程指南Haskell icse图像处理解释器面试java JavaParser JavaScript JavaSymbolSolver jetbrains mps Kotlin语言集成语言服务器协议语言习性Libav机器学习mbeddr mise自然语言nlp开源开源编程语言Python重构评论Roslyn SparkWeb静态分析测试工具TripAdvisor教程Web WebAssembly\n不要错过下一个更新！\n是否想加入超过10.000多名不断学习有关DSL，解析器，解释器，编译器和语言设计的人员？\n算我一个！\n©2018工具| 仪器网站的隐私政策\n推特\n领英\n邮件\nRss\nPython中带有文本的快速领域特定语言\n滚动到顶部\n本网站使用cookie。 继续浏览本网站，即表示您同意我们使用cookie。\nStrumenta网站的隐私政策确定\nANTLR\nGabriele Tomassetti解析SQL的时间：22分钟\n应用程序现代化为什么不应该使用（f）lex，yacc和bison\n学会创建编程语言\n订阅我们的新闻通讯以获取免费的电子邮件课程，该课程将教您如何创建编程语言\n我想创建编程语言\n"}

{"l":"https://martinfowler.com/articles/class-too-large.html","n":"Refactoring: This class is too large","html":"<header id=\"banner\" style=\"background-image: url(&quot;/banner.png&quot;); background-repeat: no-repeat\">\n\n<div class=\"name-logo\"><a href=\"https://martinfowler.com\"><img src=\"/mf-name-white.png\"></a></div>\n  <div class=\"search\">\n    <!-- SiteSearch Google -->\n    <form method=\"GET\" action=\"https://www.google.com/search\">\n      <input type=\"hidden\" name=\"ie\" value=\"UTF-8\">\n      <input type=\"hidden\" name=\"oe\" value=\"UTF-8\">\n      <input class=\"field\" type=\"text\" name=\"q\" size=\"15\" maxlength=\"255\" value=\"\">\n      <button class=\"button\" type=\"submit\" name=\"btnG\" value=\" \" title=\"Search\">\n      <input type=\"hidden\" name=\"domains\" value=\"martinfowler.com\">\n      <input type=\"hidden\" name=\"sitesearch\" value=\"\"> \n      <input type=\"hidden\" name=\"sitesearch\" value=\"martinfowler.com\">\n    \n  </button></form></div>\n\n<div class=\"menu-button navmenu-button\"><a class=\"icon icon-bars\" href=\"#navmenu-bottom\"></a></div>\n\n<nav class=\"top-menu\">\n<ul>\n<li><a class=\"\" href=\"https://refactoring.com\">Refactoring</a></li>\n\n<li><a class=\"\" href=\"/agile.html\">Agile</a></li>\n\n<li><a class=\"\" href=\"/architecture\">Architecture</a></li>\n\n<li><a class=\"\" href=\"/aboutMe.html\">About</a></li>\n\n<li><a class=\"tw\" href=\"https://www.thoughtworks.com\">ThoughtWorks</a></li>\n\n<li><a class=\"icon icon-rss\" href=\"/feed.atom\" title=\"feed\"></a></li>\n\n<li><a class=\"icon icon-twitter\" href=\"https://www.twitter.com/martinfowler\" title=\"twitter stream\"></a></li>\n</ul>\n</nav>\n</header>\n<nav id=\"top-navmenu\">\n<nav class=\"navmenu\">\n<div class=\"nav-head\">  <div class=\"search\">\n    <!-- SiteSearch Google -->\n    <form method=\"GET\" action=\"https://www.google.com/search\">\n      <input type=\"hidden\" name=\"ie\" value=\"UTF-8\">\n      <input type=\"hidden\" name=\"oe\" value=\"UTF-8\">\n      <input class=\"field\" type=\"text\" name=\"q\" size=\"15\" maxlength=\"255\" value=\"\">\n      <button class=\"button\" type=\"submit\" name=\"btnG\" value=\" \" title=\"Search\">\n      <input type=\"hidden\" name=\"domains\" value=\"martinfowler.com\">\n      <input type=\"hidden\" name=\"sitesearch\" value=\"\"> \n      <input type=\"hidden\" name=\"sitesearch\" value=\"martinfowler.com\">\n    \n  </button></form></div>\n\n<div class=\"closediv\">\n<span class=\"close\" title=\"close\"></span>\n</div>\n</div>\n\n<div class=\"nav-body\">\n<div class=\"topics\">\n<h2>Topics</h2>\n\n<p><a href=\"/architecture\">Architecture</a></p>\n\n<p><a href=\"https://refactoring.com\">Refactoring</a></p>\n\n<p><a href=\"/agile.html\">Agile</a></p>\n\n<p><a href=\"/delivery.html\">Delivery</a></p>\n\n<p><a href=\"/microservices\">Microservices</a></p>\n\n<p><a href=\"/data\">Data</a></p>\n\n<p><a href=\"/testing\">Testing</a></p>\n\n<p><a href=\"/dsl.html\">DSL</a></p>\n</div>\n\n<div class=\"about\">\n<h2>about me</h2>\n\n<p><a href=\"/aboutMe.html\">About</a></p>\n\n<p><a href=\"/books\">Books</a></p>\n\n<p><a href=\"/faq.html\">FAQ</a></p>\n</div>\n\n<div class=\"content\">\n<h2>content</h2>\n\n<p><a href=\"/videos.html\">Videos</a></p>\n\n<p><a href=\"/tags\">Content Index</a></p>\n\n<p><a href=\"/articles/eurogames\">Board Games</a></p>\n\n<p><a href=\"/photos\">Photography</a></p>\n</div>\n\n<div class=\"tw\">\n<h2>ThoughtWorks</h2>\n\n<p><a href=\"https://thoughtworks.com/insights\">Insights</a></p>\n\n<p><a href=\"https://thoughtworks.com/careers\">Careers</a></p>\n\n<p><a href=\"https://thoughtworks.com/products\">Products</a></p>\n</div>\n\n<div class=\"feeds\">\n<h2>follow</h2>\n\n<p><a href=\"https://www.twitter.com/martinfowler\">Twitter</a></p>\n\n<p><a href=\"/feed.atom\">RSS</a></p>\n</div>\n</div>\n</nav>\n</nav>\n\n<div class=\"contents dropdown-container\">\n<button class=\"dropdown-button\">\n<h2>Contents</h2>\n</button>\n\n<div class=\"hidden\" id=\"dropdownLinks\"><a href=\"#OutlineOfTheProblem\">Outline of the problem</a><a href=\"#WhyRefactor\">Why refactor?</a><a href=\"#how\">How do I do it?</a><a href=\"#rearrange-methods\">1. Rearrange methods</a><a href=\"#analyse-rels\">2. Analyse relationships between file-loading methods</a><a href=\"#PlanOfAction\">Plan of action</a><a href=\"#modify-staying\">3. Modify the methods that are staying behind</a><a href=\"#covering-tests\">4. Create covering tests for the new FileLoader class</a><a href=\"#create-fileloader\">5. Create new FileLoader class and move two methods</a><a href=\"#move-methods\">6. Move the other methods to the new FileLoader class</a><a href=\"#extract-more-classes\">7. Extract more new classes</a><a href=\"#Recap\">Recap</a><a href=\"#WhatsNext\">What's next?</a>\n<h3>Sidebars</h3>\n\n<ul>\n<li><a href=\"#approach\">Language and approach</a>\n<ul>\n<li><a href=\"#C\">C#</a></li>\n\n<li><a href=\"#Test-drivenDevelopment\">Test-driven development</a></li>\n</ul>\n</li>\n\n<li><a href=\"#continual-refactoring\">How to avoid getting here in the first place</a></li>\n\n<li><a href=\"#how-to-read\">How to read this article</a></li>\n\n<li><a href=\"#separate-moves\">Principle: Always commit moves and renames separately from edits.</a></li>\n\n<li><a href=\"#abbreviations\">Abbreviated method names</a></li>\n\n<li><a href=\"#one-thing\">Principle: Do one thing at a time. Focus!</a></li>\n\n<li><a href=\"#automated refactorings\">Automated refactorings</a></li>\n\n<li><a href=\"#memb-var\">A note on member variables</a></li>\n\n<li><a href=\"#order\">A note on the order of the commits</a></li>\n\n<li><a href=\"#reality\">The reality: Most teams own problematic code</a></li>\n</ul>\n</div>\n</div>\n\n<main>\n<h1>Refactoring: This class is too large</h1>\n\n<p class=\"subtitle\">\n    An example of refactoring from a real (flawed) code base. \n  </p>\n\n<p class=\"abstract\"><i>    \n    In this article I walk through a\n    set of refactorings from a real code base. \n    This is not intended to demonstrate perfection, but it does represent reality.\n  </i></p>\n\n<p class=\"date\">14 April 2020</p>\n\n<div class=\"frontMatter\">\n<div class=\"frontLeft\">\n<div class=\"author\"><a href=\"https://twitter.com/ClareSudbery\"><img alt=\"Photo of Clare Sudbery\" src=\"class-too-large/Pete9141-small.jpg\" width=\"80\"></a>\n<p class=\"name\"><a href=\"https://twitter.com/ClareSudbery\">Clare Sudbery</a></p>\n\n<div class=\"bio\">\n<p>Writer, speaker, asker of questions and enthusiast of Extreme Programming - Clare \n    is an ex high school maths teacher and a consultant with 20 years of software engineering\n    experience. She is on a mission to awaken the inner geek in people everywhere - \n    particularly those not traditionally encouraged to geek out.</p>\n</div>\n</div>\n\n<div class=\"clear\"></div>\n\n<div class=\"tags\"></div>\n</div>\n\n<div class=\"frontRight\">\n<div class=\"contents\">\n<h2>Contents</h2>\n\n<ul>\n<li><a href=\"#OutlineOfTheProblem\">Outline of the problem</a></li>\n\n<li><a href=\"#WhyRefactor\">Why refactor?</a></li>\n\n<li><a href=\"#how\">How do I do it?</a></li>\n\n<li><a href=\"#rearrange-methods\">1. Rearrange methods</a></li>\n\n<li><a href=\"#analyse-rels\">2. Analyse relationships between file-loading methods</a></li>\n\n<li><a href=\"#PlanOfAction\">Plan of action</a></li>\n\n<li><a href=\"#modify-staying\">3. Modify the methods that are staying behind</a></li>\n\n<li><a href=\"#covering-tests\">4. Create covering tests for the new FileLoader class</a></li>\n\n<li><a href=\"#create-fileloader\">5. Create new FileLoader class and move two methods</a></li>\n\n<li><a href=\"#move-methods\">6. Move the other methods to the new FileLoader class</a></li>\n\n<li><a href=\"#extract-more-classes\">7. Extract more new classes</a></li>\n\n<li><a href=\"#Recap\">Recap</a></li>\n\n<li><a href=\"#WhatsNext\">What's next?</a></li>\n</ul>\n\n<h3>Sidebars</h3>\n\n<ul>\n<li><a href=\"#approach\">Language and approach</a>\n<ul>\n<li><a href=\"#C\">C#</a></li>\n\n<li><a href=\"#Test-drivenDevelopment\">Test-driven development</a></li>\n</ul>\n</li>\n\n<li><a href=\"#continual-refactoring\">How to avoid getting here in the first place</a></li>\n\n<li><a href=\"#how-to-read\">How to read this article</a></li>\n\n<li><a href=\"#separate-moves\">Principle: Always commit moves and renames separately from edits.</a></li>\n\n<li><a href=\"#abbreviations\">Abbreviated method names</a></li>\n\n<li><a href=\"#one-thing\">Principle: Do one thing at a time. Focus!</a></li>\n\n<li><a href=\"#automated refactorings\">Automated refactorings</a></li>\n\n<li><a href=\"#memb-var\">A note on member variables</a></li>\n\n<li><a href=\"#order\">A note on the order of the commits</a></li>\n\n<li><a href=\"#reality\">The reality: Most teams own problematic code</a></li>\n</ul>\n</div>\n</div>\n</div>\n\n<div class=\"paperBody shallow\">\n<p>\n      This is a story about refactoring.\n      It's the third item in the TDD \n      <a href=\"https://martinfowler.com/articles/workflowsOfRefactoring/#tdd\"> red-green-refactor cycle</a><span class=\"foot-ref\"><a href=\"#footnote-tdd\">[1]</a></span> and it's\n      the thing we do all the time, right? Except when we don't.\n    </p>\n\n<p>\n      I have an unruly code base which has suffered from refactoring neglect, so I've \n      been bringing it back into line. \n      In this article I will take a <i>class that is too large</i>, and make it smaller.\n    </p>\n\n<aside class=\"sidebar\" id=\"approach\">\n<h1>Language and approach</h1>\n\n<section id=\"C\">\n<h2>C#</h2>\n\n<p>\n            I generally write code in whatever language suits the client, the project and the problem at hand. \n            But the majority of my career has been in the .Net space, so C# is my comfort zone and my default go-to. \n            The examples in this article are written in C#, but I hope the code snippets included are simple \n            enough to follow even if you don't know the language.\n          </p>\n</section>\n\n<section id=\"Test-drivenDevelopment\">\n<h2>Test-driven development</h2>\n\n<p>\n            I'm a big fan of Test-Driven Development (TDD) <span class=\"foot-ref\"><a href=\"#footnote-tdd\">[1]</a></span>, \n            and the code presented here was mostly written using that approach.            \n            But I have to confess that after 20 years as an engineer, \n            I have at least half a career of bad \n            habits behind me and I don't always get things right.  \n          </p>\n</section>\n</aside>\n\n<section id=\"OutlineOfTheProblem\">\n<h2>Outline of the problem</h2>\n\n<p>The story begins with a boring domestic chore. I've written some\n      personal accounting software - <a href=\"https://github.com/claresudbery/Reconciliate/tree/Refactor-examples\">Reconciliate</a>.\n      It works on the\n      command line and performs the following actions:</p>\n\n<ol>\n<li>Loads my own comma-separated data:\n          \n<ul>\n<li>My record of recent bank and credit card transactions.</li>\n\n<li>My predicted monthly and annual transactions (based on data in a\n        central spreadsheet).</li>\n\n<li>Any unreconciled previously-recorded data.</li>\n</ul>\n</li>\n\n<li>Loads third-party comma-separated data (from bank and credit card companies).</li>\n\n<li>Reconciles the third-party data against my own data.</li>\n\n<li>Writes everything back to a central spreadsheet.</li>\n</ol>\n\n<p>I have some bugs that need fixing and some features to add. But my\n      typical workflow is to arrive at the laptop late at night after putting my\n      youngest to bed, with only a small amount of time before it will be <i>my</i>\n      bedtime, and often a few weeks after the last time I saw the code. In\n      these circumstances it's horribly easy to think things like, \"Well I know\n      this code is a mess, but I don't have time to get my head round it and fix\n      it now...\"</p>\n\n<p>Clearly this is not ideal.</p>\n\n<p>There's one class in particular - the <code>ReconciliationIntro</code> class \n      - which is giving me a headache\n      whenever I look at it. It's bloated and convoluted and impossible to <i>fit\n      in my head</i>&nbsp;<span class=\"foot-ref\"><a href=\"#footnote-fits-in-my-head\">[2]</a></span>. This has created a nasty \n      feedback loop: \"Because this code is \n      so hard to reason about, refactoring will take more time and energy than I\n      have, so I'll put up with it even longer - even though it means I can't\n      even make small changes any more because it takes so long for me to\n      understand the code's current state and decide where the change should\n      go.\" </p>\n\n<p>For instance, I want to add the ability to handle another credit card.\n      In a lot of places I've used\n      <a href=\"https://medium.com/@shanikae/polymorphism-explained-simply-7294c8deeef7\">polymorphism</a>\n      and <a href=\"https://en.wikipedia.org/wiki/Strategy_pattern\">the strategy pattern</a>\n      to keep the unique behaviour of each credit card neatly encapsulated. But\n      the <code>ReconciliationIntro</code> class is one place where, because of the poor\n      design of the code and the lack of clear \n      <a href=\"https://en.wikipedia.org/wiki/Separation_of_concerns\">context separation</a>, \n      if I add another\n      credit card I'll be making an already bloated class even worse. It\n      contains four duplicated code paths for each of four types of data (Bank In,\n      Bank Out, Credit Card 1 and Credit Card 2), and if I add Credit Card 3\n      right now I'll end up following the same anti-pattern.</p>\n\n<p>My overall aim is to replace this code with more generic\n      code, via the strategy pattern <span class=\"foot-ref\"><a href=\"#footnote-refactoring-to-patterns\">[3]</a></span>. \n      But there are four problems standing in my way:</p>\n\n<ol>\n<li>This one large class, (<code>ReconciliationIntro</code>), is taking too\n        much responsibility.</li>\n\n<li>There's a lot of private nested code, which is hard to unit-test\n        because it has no public interface.</li>\n\n<li>Within <code>ReconciliationIntro</code>, there's one large method that's doing\n        too much.</li>\n\n<li>There are several methods in <code>ReconciliationIntro</code> which use the\n        same repeated pattern but with different details.</li>\n</ol>\n\n<p>\n        I plan to fix all of these problems, in the order listed above. \n        This <a href=\"https://www.martinfowler.com/articles/preparatory-refactoring-example.html\">preparatory refactoring</a>\n        will get me to the point where I can easily encapsulate the behaviour of each credit \n        card / account. As <a href=\"https://twitter.com/KentBeck/status/250733358307500032?s=20\">Kent Beck says</a>, \n        \"Make the change easy, then make the easy change.\" \n      </p>\n\n<p>\n        This article is about tackling the first problem in the above list: <i>This class is too\n        large</i>.\n      </p>\n</section>\n\n<section id=\"WhyRefactor\">\n<h2>Why refactor?</h2>\n\n<p>I can't easily reason about the <code>ReconciliationIntro</code> class because it\n      has too many responsibilities. It was originally designed as the\n      entrance hall to the software, and all it did was display a few messages\n      and then instantiate the classes that do the main work.\n      But over time a lot of other code has snuck in. I want to make it easier to add \n      another credit card, so I'm going to start\n      by <i>breaking this large class into smaller classes</i>.</p>\n\n<p>The benefits will be several:</p>\n\n<ul>\n<li>By moving groups of methods into separate classes I'll create clear \n        <a href=\"https://en.wikipedia.org/wiki/Separation_of_concerns\">contexts</a> and minimise tight coupling. \n        This means that:</li>\n\n<ul>\n<li>I'll know where to go when I want to make changes or fix issues.</li>\n\n<li>When I amend the code, I'll only have to work with small\n          isolated sections that fit in my head <span class=\"foot-ref\"><a href=\"#footnote-fits-in-my-head\">[2]</a></span>\n          - I won't have to understand\n          the whole system.</li>\n\n<li>Any manipulation of state will only happen locally in a small context\n          - so I won't have to worry about one area of the system changing state in\n          another.</li>\n</ul>\n</ul>\n</section>\n\n<section id=\"how\">\n<aside class=\"sidebar\" id=\"continual-refactoring\">\n<h2>How to avoid getting here in the first place</h2>\n\n<p>\n          Could I have avoided being in this position? Yes, of course. \n          Rather than despairing about a lack of time,\n          I could have made small continuous changes whenever I encountered problem areas.\n          That's part of what the refactor stage of\n          the <a href=\"https://martinfowler.com/articles/workflowsOfRefactoring/#tdd\">red-green-refactor cycle</a>\n          is for, and it's a habit you can reinstate <i>at any time</i>.\n        </p>\n\n<p>\n          But it's worth acknowledging that when coding under pressure, you're \n          not always in a fit state to make the \n          right choices. Your code \n          can quickly reach a level of crustiness that makes a refactor feel \n          insurmountable.\n          At these times it's always worth using small changes to make things \n          better piece by piece, \n          no matter what state your code is in. \n        </p>\n</aside>\n\n<h2>How do I do it? </h2>\n\n<p>To my\n      mind, the most important principle when refactoring (and when writing new\n      code) is to move in tiny steps. I have several connected aims:</p>\n\n<ul>\n<li>At every step, I want the code to compile and the tests to run.</li>\n\n<li>If a change causes any tests to fail, I want to be able to fix them\n        instantly. By making small changes and small commits, I can see which\n        change caused the tests to fail and I only need to rewind / examine a\n        small amount of code to find the problem.</li>\n\n<li>I can keep track of where I am in in my head. It's horribly easy to\n        embark on a relatively simple refactor, only to find it has repercussions\n        beyond your original intention. At this point, if you're not in the habit\n        of keeping the code compiling and the tests passing at every step, you can\n        find yourself lost in a rabbit hole that's difficult to exit: Your\n        code isn't compiling and your tests aren't even running, let alone passing.</li>\n</ul>\n\n<p>\n        For this to work, I need the code being refactored to be\n        covered by tests. This has already been done before I start refactoring, \n        although it's worth noting\n        that one of my aims in a future refactoring will be to make the code even\n        more testable.\n      </p>\n\n<p><a href=\"/books/refactoring.html\">Refactoring, by Martin Fowler</a> is a recommended\n        further read and lays out some basic refactoring principles. He also emphasises\n        the value of moving in tiny steps and building the code / running your \n        tests after every small commit.\n      </p>\n\n<p>Beyond these basic principles, I'll aim to follow a logical series of\n      steps which are outlined below.</p>\n\n<aside class=\"sidebar\" id=\"how-to-read\">\n<h2>How to read this article</h2>\n\n<p>This is a real code base and a messy code base (hence the refactoring), \n        so there's a lot of code. \n        For those who want to know more, I do link to the code repeatedly. \n        But I've deliberately kept the descriptions high-level, and you don't <i>need</i> \n        to follow those links.</p>\n</aside>\n</section>\n\n<section id=\"rearrange-methods\">\n<h2>1. Rearrange methods</h2>\n\n<p>I'll start by using <a href=\"https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/preprocessor-directives/preprocessor-region\">regions</a> to rearrange all the\n      methods in the <a href=\"https://github.com/claresudbery/Reconciliate/blob/Refactor-genericise-start/Console/Reconciliation/ReconciliationIntro.cs\"><code>ReconciliationIntro</code> class</a> into sensible\n      groupings&nbsp;(<a href=\"https://github.com/claresudbery/Reconciliate/commit/f2d9932\">commit f2d9932</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>:</p>\n\n<div class=\"figure \" id=\"class-split-into-regions-v2.png\"><img src=\"class-too-large/class-split-into-regions-v2.png\">\n<p class=\"photoCaption\">Figure 1: ReconciliationIntro after\n      methods rearranged into regions</p>\n</div>\n\n<div class=\"clear\"></div>\n\n<aside class=\"sidebar\" id=\"separate-moves\">\n<h2>Principle: Always commit moves and renames separately from edits.</h2>\n\n<p>It's important that I move code around like this as a separate task\n        and <a href=\"https://github.com/claresudbery/Reconciliate/commit/f2d9932\">in a separate commit</a>, without\n        editing the code in any way. When you rearrange methods, the resulting\n        code difference will include many added/deleted chunks of code. If the\n        code has been changed as well as moved, you can't easily tell whether\n        lines have been deleted or moved, and whether moved lines are the\n        same or different. As Dan Terhorst-North says, \"A change should be \n        structural or behavioural, but never both.\"</p>\n\n<div class=\"figure \" id=\"move-in-a-separate-commit-smaller-narrower2.png\"><img src=\"class-too-large/move-in-a-separate-commit-smaller-narrower2.png\">\n<p class=\"photoCaption\">Figure 2: What a commit\n        looks like when you've moved code around</p>\n</div>\n\n<div class=\"clear\"></div>\n</aside>\n\n<p>Now that I've grouped my methods into what feels like a reasonable set of \n      <a href=\"https://en.wikipedia.org/wiki/Separation_of_concerns\">contexts</a>, \n      I'd like to pull these out into separate classes. But where to\n      start? The file loading code contains the most duplication, and is causing the\n      most pain. Ultimately I want to make this code more generic, but first I want to\n      pull it out so I can see it without distraction. I'll extract a new <code>FileLoader</code>\n      class. The other groupings will also become separate classes but they'll be a\n      lot simpler, so I'll focus most of this article on the file-loading code.</p>\n</section>\n\n<section id=\"analyse-rels\">\n<aside class=\"sidebar\" id=\"abbreviations\">\n<h2>Abbreviated method names</h2>\n\n<p>\n          The naming of anything - from methods to pubs to children - is a notoriously difficult \n          enterprise. My tendency to verbosity is as evident in my method names \n          as it is in the longwinded stories you'll hear if you meet me in a pub. \n          Before refactoring, the duplication of code meant that method names \n          were being used to differentiate between contexts - and this resulted \n          in some long names.\n          To avoid gigantic images I've abbreviated names in most of the \n          diagrams, as follows:\n          \n</p><ul>\n<li><b>BBI</b>: bank_and_bank_in (\"bank\" and \"bank_in\" represent two different views - the bank's, and my own)</li>\n\n<li><b>BBO</b>: bank_and_bank_out (\"bank\" and \"bank_out\" as with \"bank\" and \"bank_in\" above)</li>\n\n<li><b>CC1</b>: cred_card1_and_cred_card1_in_out (\"cred_card1\" and \"cred_card1_in_out\" as with \"bank\" and \"bank_in\" above)</li>\n\n<li><b>CC2</b>: cred_card2_and_cred_card2_in_out (as with \"cred_card1\" above)</li>\n\n<li><b>Merge_bd</b>: Merge_bespoke_data</li>\n\n<li><b>BM</b>: budgeting_months</li>\n\n<li><b>ccds</b>: credit_card_debits</li>\n\n<li><b>wpf</b>: with_pending_file</li>\n\n<li><b>CC</b>: cred_card</li>\n\n<li><b>DDs</b>: direct_debits</li>\n</ul>\n<p></p>\n</aside>\n\n<h2>2. Analyse relationships between file-loading methods</h2>\n\n<p>So far all I've done is move some code around in the same class. I\n      rebuilt the code and ran all the tests before I committed, but unless I\n      was clumsy I'd expect my previous commit to be trivial. I need to be a\n      little more thoughtful about what I do next.</p>\n\n<p>I've used one of my regions to identify methods to pull out into \n      a new <code>FileLoader</code>\n      class, but how can I be sure this will work? Are there any hidden\n      dependencies? I'll discover this by drawing out the relationships\n      between the methods I want to move. The ones to be moved are marked in\n      blue.</p>\n\n<div class=\"figure \" id=\"File-loading-code-diagram-01-v2-small.png\"><img src=\"class-too-large/File-loading-code-diagram-01-v2-small.png\">\n<p class=\"photoCaption\">Figure 3: File-loading\n      methods to be moved \n      (<a href=\"#abbreviations\">abbreviations</a>)</p>\n</div>\n\n<div class=\"clear\"></div>\n\n<p>I can see straight away that it's not a strictly self-contained \n      context: Some of the\n      blue methods are calling back out to methods (shown in black and green) that I want to\n      keep in a separate class. There are a couple of ways I could handle this, which\n      I <a href=\"#modify-staying\">discuss below</a>. But now I'm at\n      a place where I can define a plan of action. </p>\n</section>\n\n<section id=\"PlanOfAction\">\n<h2>Plan of action</h2>\n\n<p> By the time I'm done, the original large <code>ReconciliationIntro</code> class \n      will have been broken down into \n      the pared-down version plus five new classes shown in \n      the diagram below. Note that there isn't a one-to-one mapping between\n      regions and classes, because later on when I reach \n      <a href=\"#extract-more-classes\">step 7</a>, I'll end up refining my first groupings \n      into some finer-grained boundaries.</p>\n\n<div class=\"figure \" id=\"MasterPlan-darker-text-taller.png\"><img src=\"class-too-large/MasterPlan-darker-text-taller.png\">\n<p class=\"photoCaption\">Figure 4: Plan of action</p>\n</div>\n\n<div class=\"clear\"></div>\n\n<p>\n        My overall aim is to break this large class down into smaller classes.\n        In steps 1 and 2 above, I used <a href=\"#rearrange-methods\">regions</a> \n        and <a href=\"#analyse-rels\">a diagram</a> to identify distinct areas of \n        code and then analyse relationships between some of the methods. That gave me enough \n        information to start thinking about how I can tackle this job in tiny steps. \n      </p>\n\n<p>\n        The resulting plan is summarised below and then described in detail further down. \n        I reached this plan by thinking about how I could \n        proceed using steps that were <a href=\"#how\">as small as possible</a>. Often what I'm \n        doing is setting things up so that the <i>next</i> change will be \n        as small and simple as possible. I'm making small \n        changes to facilitate more small changes - yet again following \n        <a href=\"https://twitter.com/KentBeck/status/250733358307500032?s=20\">Kent Beck's dictum</a> to \n        \"Make the change easy, then make the easy change.\"\n      </p>\n\n<p>\n        Depending on your circumstances \n        you might not follow the same plan, but it's not a bad template if you're not sure how to proceed. \n        Your priority is to set yourself up for safe incremental changes:\n      </p>\n\n<ol>\n<li>\n<p><a href=\"#rearrange-methods\">Rearrange methods</a></p>\n\n<p>Group all the methods in the class into sensible groupings, as described\n          <a href=\"#rearrange-methods\">above</a>.</p>\n</li>\n\n<li>\n<p><a href=\"#analyse-rels\">Analyse\n          relationships between file-loading methods</a></p>\n\n<p>Identify how the\n          file-loading code is connected to the rest of the code in \n          the <code>ReconciliationIntro</code> class, as\n          described <a href=\"#analyse-rels\">above</a>.</p>\n</li>\n\n<li>\n<p><a href=\"#modify-staying\">Modify the\n          methods that are staying behind</a></p>\n\n<p>There are methods which\n          will stay in the parent class but are currently called by those that are\n          moving. Some modification will be required to make this work.</p>\n</li>\n\n<li>\n<p><a href=\"#covering-tests\">Create covering\n          tests for the new <code>FileLoader</code> class</a></p>\n\n<p>The new <code>FileLoader</code> class\n          needs to be covered by tests. The tests for the code to be moved already\n          exist, but they'll be moved into a new <code>FileLoaderTests</code> class.</p>\n</li>\n\n<li>\n<p><a href=\"#create-fileloader\">Create new\n          <code>FileLoader</code> class and move two methods</a></p>\n\n<p><a href=\"#how\">Following the principle of tiny steps</a>, I'll move\n          just two methods (a public method and a private method called by it)\n          before I move the rest.</p>\n</li>\n\n<li>\n<p><a href=\"#move-methods\">Move the other\n          methods to the new <code>FileLoader</code> class</a></p>\n\n<p>This is where it gets\n          exciting. All that file-loading code I'm interested in will finally\n          get a new home!</p>\n</li>\n\n<li>\n<p><a href=\"#extract-more-classes\">Extract more new classes</a></p>\n\n<p>Once I've dealt with the file-loading code, I'll create some more new\n          classes for the other code regions. </p>\n</li>\n</ol>\n\n<p>The new <code>FileLoader</code> class will be responsible for loading various\n      sources of comma-separated data and merging them ready for reconciliation.\n      This file-loading code is where most of the pain currently lies, so that's the \n      bit I'll describe in the most detail. \n      You can see the original code before refactoring <a href=\"https://github.com/claresudbery/Reconciliate/blob/Refactor-genericise-start/Console/Reconciliation/ReconciliationIntro.cs\">here</a>, but if you follow that link all you'll\n      learn is that it's too big to fit in your head! The slimmed down\n      post-refactor version is <a href=\"https://github.com/claresudbery/Reconciliate/blob/Refactor-examples/Console/Reconciliation/ReconciliationIntro.cs\">here</a>.</p>\n\n<p>So, now I can continue with the plan:</p>\n</section>\n\n<section id=\"modify-staying\">\n<h2>3. Modify the methods that are staying behind</h2>\n\n<p>I've identified two methods - <code>Set_path</code> and\n      <code>Recursively_ask_for_budgeting_months</code> - which are called by file-loading\n      methods:</p>\n\n<div class=\"figure \" id=\"File-loading-code-diagram-01b-v2-small.png\"><img src=\"class-too-large/File-loading-code-diagram-01b-v2-small.png\">\n<p class=\"photoCaption\">Figure 5: Methods called\n      by file-loading methods (<a href=\"#abbreviations\">abbreviations</a>)</p>\n</div>\n\n<div class=\"clear\"></div>\n\n<p>As long as those methods are not too tightly coupled with the\n      file-loading class, I can either</p>\n\n<ul>\n<li>Make them public so I can call back to them from\n        the new <code>FileLoader</code> class.</li>\n\n<li>Move the calls out of the file-loading code and into other native\n        <code>ReconciliationIntro</code> methods instead.</li>\n</ul>\n\n<p>I'll use the first approach for <code>Recursively_ask_for_budgeting_months</code> and \n      the second for <code>Set_path</code>, which will bring me to the following situation:</p>\n\n<div class=\"figure \" id=\"File-loading-code-diagram-02-v2-sm.png\"><img src=\"class-too-large/File-loading-code-diagram-02-v2-sm.png\">\n<p class=\"photoCaption\">Figure 6: \n      File-loading methods after moving (<a href=\"#abbreviations\">abbreviations</a>)</p>\n</div>\n\n<div class=\"clear\"></div>\n\n<p>Note that the methods marked as <code>FileLoader</code> methods in the diagram\n      will still be in the <code>ReconciliationIntro</code> class at the end of this step,\n      but this will <i>enable</i> me to move them into the <code>FileLoader</code> class, which\n      will happen in <a href=\"#create-fileloader\">step 5</a> \n      and <a href=\"#move-methods\">step 6</a> below.</p>\n\n<p><code>Recursively_ask_for_budgeting_months</code> will eventually be a public\n      method in another class, but for now I just want to make sure I can call\n      it from elsewhere. It turns out it already is public, which was done so\n      that it could be tested. This in itself is a code smell - it's a sign\n      that it would be better off as part of the public interface of a separate\n      class.</p>\n\n<p>The other method called from the file-loading code is <code>Set_path</code>. This\n      changes the value of an internal path variable, so I'll choose option 2:\n      I'll call it separately and pass the resulting data into the file-loading\n      method via a parameter. </p>\n\n<aside class=\"sidebar\" id=\"one-thing\">\n<h2>Principle: Do one thing at a time. Focus!</h2>\n\n<p>In the process of editing <code>Set_path</code>, I've noticed a couple of other\n        changes I want to make. </p>\n\n<p>Firstly, <code>Set_path</code> has the side effect of altering the\n        <code>_path</code> member variable. It would be better if it was\n        self-contained and just returned a new path. </p>\n\n<p>Secondly, currently <code>Set_path</code> is being called in two\n        places - just before <code>Create_pending_csvs</code> is called, and much\n        lower down in the chain of events, from within another method called\n        <code>Set_path_and_file_names</code>. If I follow the chain of different\n        methods involved here, I realise they're not called in a sensible order\n        and there's a lot of redundancy. The code is hard to follow, and it \n        would be tempting to refactor it now. </p>\n\n<p>But I'm in the middle of another refactoring, so I make a note (on my\n        Trello board) and leave these changes for later. Otherwise I'll get\n        distracted from the task at hand and could get the code into a strange\n        state and lose track of what I'm doing. Focus is important!</p>\n</aside>\n\n<p>Note that these might not normally stay as separate commits (I could use\n      micro-commits and then squash them into larger commits), but I'm keeping\n      the small commits intact to make the steps clear. I compile and run the\n      tests at every step:</p>\n\n<ol>\n<li>\n<p>\n            Modify the calling method (<code>Create_pending_csvs</code>) so that it takes a\n            parameter, but initially give it a default value \n            (<a href=\"https://github.com/claresudbery/Reconciliate/commit/acc3519\">commit acc3519</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span> so\n            that the code still compiles:\n          </p>\n\n<div class=\"code-change-series\">\n<pre>private void Create_pending_csvs()\n{\n  // Some code\n}\n</pre>\n<span class=\"trans-arrow\">⇓</span>\n<pre>private void Create_pending_csvs(<span class=\"colblind-highlight\">string path = \"\"</span>)\n{\n  // Some code\n}\n</pre>\n</div>\n</li>\n\n<li>\n<p>\n            Call <code>Set_path</code> separately before calling <code>Create_pending_csvs</code>.\n            Take the resulting new <code>_path</code> member variable (see <a href=\"#one-thing\">sidebar</a>), and pass\n            it into <code>Create_pending_csvs</code> (<a href=\"https://github.com/claresudbery/Reconciliate/commit/c5ebc2f\">commit c5ebc2f</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>:\n          </p>\n\n<div class=\"code-change-series\">\n<pre>case \"1\":\n{\n  Create_pending_csvs();\n}\nbreak;\n</pre>\n<span class=\"trans-arrow\">⇓</span>\n<pre>case \"1\":\n{\n  Set_path();\n  Create_pending_csvs(<span class=\"colblind-highlight\">_path</span>);\n}\nbreak;\n</pre>\n</div>\n</li>\n\n<li>\n<p>\n            Remove the call to <code>Set_path</code> from within\n            <code>Create_pending_csvs</code>, and use the passed-in value instead of\n            the member variable (<a href=\"https://github.com/claresudbery/Reconciliate/commit/6df8f97\">commit 6df8f97</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>:\n          </p>\n\n<div class=\"code-change-series\">\n<pre>private void Create_pending_csvs(string path = \"\")\n{\n  try\n  {\n    Set_path();\n    var pending_csv_file_creator = new PendingCsvFileCreator(_path);\n</pre>\n<span class=\"trans-arrow\">⇓</span>\n<pre>private void Create_pending_csvs(string path = \"\")\n{\n  try\n  {\n    <span class=\"colblind-deleted\">Set_path();</span>\n    var pending_csv_file_creator = new PendingCsvFileCreator(<span class=\"colblind-highlight\">path</span>);\n</pre>\n</div>\n</li>\n\n<li>\n<p>\n            Finally, remove the default value from the <code>Create_pending_csvs</code>\n            parameter - thereby forcing all clients to pass a value in \n            (<a href=\"https://github.com/claresudbery/Reconciliate/commit/2be56ea\">commit 2be56ea</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>.\n            Note that by doing things in this order, I keep the code compiling at all\n            times: \n          </p>\n\n<div class=\"code-change-series\">\n<pre>private void Create_pending_csvs(string path = \"\")\n{\n  // Some code\n}\n</pre>\n<span class=\"trans-arrow\">⇓</span>\n<pre>private void Create_pending_csvs(string path <span class=\"colblind-deleted\">= \"\"</span>)\n{\n  // Some code\n}\n</pre>\n</div>\n</li>\n</ol>\n</section>\n\n<section id=\"covering-tests\">\n<h2>4. Create covering tests for the new <code>FileLoader</code> class</h2>\n\n<p>My first choice of method to move will be\n      <code>Bank_and_bank_out_ _Merge_bespoke_data_with_pending_file</code>. And the first\n      thing I want to do is copy any covering tests into a new test class for\n      the about-to-be-created <code>FileLoader</code> class. There is already one test\n      for this method -\n      <a href=\"https://github.com/claresudbery/Reconciliate-git-experiments/blob/f374fbdbf695a590ba7f7e3cd61a506222b742f0/ConsoleCatchallTests/Reconciliation/Loaders/BankAndBankOutDataTests.cs#L79\">M_MergeBespokeDataWithPendingFile_ \n      WillAddMostRecentCredCardDirectDebits</a>\n      - and its job is to make sure this method merges new direct debit data\n      correctly with a 'pending' file (which is being built to contain all new\n      transaction data). </p>\n\n<p>Note that I'm only <i>moving</i> tests, not writing new ones. People can\n      get so used to the TDD <span class=\"foot-ref\"><a href=\"#footnote-tdd\">[1]</a></span> concept of writing tests \n      before writing code that\n      they assume you need to write new tests <i>whenever you work on code</i>.\n      This is often not the case when refactoring. Ideally my functionality\n      will already be covered by tests, and when refactoring I'm not changing\n      the functionality. So instead of writing new tests, I'm using the existing ones\n      to verify the functionality still works as originally intended.</p>\n\n<p>This is a good time to review this test: It's a while since I wrote\n      it, so I should be able to spot quickly whether it makes sense. I want\n      my tests to be clear and easy to read - they should act as documentation\n      for my system behaviour. The first thing I notice is that it contains an\n      assert method - <code>Assert_direct_debit_details_are_correct</code> - whose name\n      is inadequate. What is the definition of \"correct\"? I rewrite the test\n      to make it easier to read, which involves quite a lot of changes. In the\n      interest of keeping this a digestible read I won't go into the changes\n      made, but you can view them in <a href=\"https://github.com/claresudbery/Reconciliate/commit/f090f26\">commit f090f26</a>\n      and <a href=\"https://github.com/claresudbery/Reconciliate/commit/6a6cece\">commit 6a6cece</a>. <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span></p>\n\n<p>Now that I've refactored the test I'll copy it into a new test\n      class, along with some associated private helper methods. Note that\n      although this and other tests are destined to operate on a new\n      <code>FileLoader</code> class, they'll still act on the old <code>ReconciliationIntro</code>\n      class until I'm sure my new test class has everything it needs. Also\n      note that until everything is safely moved, my test code is duplicated.\n      </p>\n\n<aside class=\"sidebar\" id=\"automated refactorings\">\n<h2>Automated refactorings</h2>\n\n<p>\n          It's worth being aware that there are many automatable refactoring tasks \n          which require significantly more care when tools like\n          <a href=\"https://www.jetbrains.com/resharper/\">Resharper</a>&nbsp;<span class=\"foot-ref\"><a href=\"#footnote-resharper\">[5]</a></span>\n          are not available.\n        </p>\n\n<p>\n          For instance, with Resharper you can quickly\n          and confidently rename a method that has clients throughout a large code base. \n          But without this tool, such a change might be handled differently\n          - for instance by creating a temporary wrapper method.\n        </p>\n</aside>\n\n<p>I first create the new test class in the same file as the original\n      (<a href=\"https://github.com/claresudbery/Reconciliate/commit/491c795\">commit 491c795</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>, so that it's easy to see what I'm copying.\n      Then I can get <a href=\"https://www.jetbrains.com/resharper/\">Resharper</a>&nbsp;<span class=\"foot-ref\"><a href=\"#footnote-resharper\">[5]</a></span> and Visual Studio to move everything into a new file for\n      me (<a href=\"https://github.com/claresudbery/Reconciliate/commit/c9317c0\">commit c9317c0</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>.</p>\n\n<div class=\"figure \" id=\"Move-BBO-Tests-02-v5-small.png\"><img src=\"class-too-large/Move-BBO-Tests-02-v5-small.png\">\n<p class=\"photoCaption\">Figure 7: Move BBO tests</p>\n</div>\n\n<div class=\"clear\"></div>\n</section>\n\n<section id=\"create-fileloader\">\n<h2>5. Create new <code>FileLoader</code> class and move two methods</h2>\n\n<p>Now that my test class is up and running, I can create the new\n      <code>FileLoader</code> class. </p>\n\n<p>The method that's furthest down the chain - the lowest leaf in <a href=\"#modify-staying\">my\n      tree of methods</a> - is\n      <code>Bank_and_bank_out__ Add_most_recent_credit_card_direct_debits</code>. This is\n      a private method with no independent tests (it's tested via the public\n      calling method), so I'm going to move both it and its caller\n      (<code>Bank_and_bank_out__ Merge_bespoke_data_with_pending_file</code>). These will\n      be the first two methods to be moved into my new class. </p>\n\n<p>Again, I'll move in baby steps to avoid my tests going red and keep\n      my code building at all times. After each of the following steps I make\n      sure the code builds and the tests are passing.</p>\n\n<ol>\n<li>\n<p>\n            This is the situation I begin with. A <code>FileLoaderTests</code> class has\n            been created, but it is testing code that still lives in the\n            <code>ReconciliationIntro</code> class:\n          </p>\n\n<div class=\"figure \" id=\"New-FileLoader-class-v4-00-small.png\"><img src=\"class-too-large/New-FileLoader-class-v4-00-small.png\">\n<p class=\"photoCaption\">Figure 8: New FileLoader class part 1 \n          (<a href=\"#abbreviations\">abbreviations</a>)</p>\n</div>\n\n<div class=\"clear\"></div>\n</li>\n\n<li>\n<p>\n            I start by creating a new <code>FileLoader</code> class. One of my file-loading methods\n            (<code>Bank_and_bank_out__ Add_most_recent_credit_card_direct_debits</code>) is\n            private, and will also be private at the end of this process. It will only ever be called by \n            the method that's about to follow it into the new class. It's not\n            individually covered by tests, so I can just copy it over to the new\n            class and have it ready and waiting when its caller is moved \n            (see <a href=\"https://github.com/claresudbery/Reconciliate/commit/0341476\">commit 0341476</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>. \n            But I will need to make it temporarily public:\n          </p>\n\n<div class=\"figure \" id=\"New-FileLoader-class-v4-01-v3-small.png\"><img src=\"class-too-large/New-FileLoader-class-v4-01-v3-small.png\">\n<p class=\"photoCaption\">Figure 9: New FileLoader class part 2 \n          (<a href=\"#abbreviations\">abbreviations</a>)</p>\n</div>\n\n<div class=\"clear\"></div>\n</li>\n\n<li>\n<p>\n            Now I can create an instance of my new <code>FileLoader</code> class in the \n            <code>ReconciliationIntro</code> class and call its new public method, instead \n            of the old private method. I can also delete the old private method \n            (see <a href=\"https://github.com/claresudbery/Reconciliate/commit/bde2ae2\">commit bde2ae2</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>:\n          </p>\n\n<div class=\"figure \" id=\"New-FileLoader-class-v4-02-v3-small.png\"><img src=\"class-too-large/New-FileLoader-class-v4-02-v3-small.png\">\n<p class=\"photoCaption\">Figure 10: New FileLoader class part 3 \n          (<a href=\"#abbreviations\">abbreviations</a>)</p>\n</div>\n\n<div class=\"clear\"></div>\n</li>\n\n<li>\n<p>\n            Copy the original caller into the new class \n            (see <a href=\"https://github.com/claresudbery/Reconciliate/commit/f0a5a59\">commit f0a5a59</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>. \n            Note that at this point it's duplicated:\n          </p>\n\n<div class=\"figure \" id=\"New-FileLoader-class-v3-05-v3-small.png\"><img src=\"class-too-large/New-FileLoader-class-v3-05-v3-small.png\">\n<p class=\"photoCaption\">Figure 11: New FileLoader class part 4 \n          (<a href=\"#abbreviations\">abbreviations</a>)</p>\n</div>\n\n<div class=\"clear\"></div>\n</li>\n\n<li>\n<p>\n            Change the object I'm testing from being a <code>ReconciliationIntro</code>\n            instance to being a new <code>FileLoader</code> instance. Point the tests at the new copy \n            of the original caller. Note that because the private method it calls has also been copied, my\n            tests will pass (see <a href=\"https://github.com/claresudbery/Reconciliate/commit/3d573e3\">commit 3d573e3</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>:\n          </p>\n\n<div class=\"figure \" id=\"New-FileLoader-class-v3-06-v3-small.png\"><img src=\"class-too-large/New-FileLoader-class-v3-06-v3-small.png\">\n<p class=\"photoCaption\">Figure 12: New FileLoader class part 5 \n          (<a href=\"#abbreviations\">abbreviations</a>)</p>\n</div>\n\n<div class=\"clear\"></div>\n</li>\n\n<li>\n<p>\n            Now I can call the original caller directly from the <code>ReconciliationIntro</code> \n            class (see <a href=\"https://github.com/claresudbery/Reconciliate/commit/77c0b14\">commit 77c0b14</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>:\n          </p>\n\n<div class=\"figure \" id=\"New-FileLoader-class-v3-07-v3-small.png\"><img src=\"class-too-large/New-FileLoader-class-v3-07-v3-small.png\">\n<p class=\"photoCaption\">Figure 13: New FileLoader class part 6 \n          (<a href=\"#abbreviations\">abbreviations</a>)</p>\n</div>\n\n<div class=\"clear\"></div>\n</li>\n\n<li>\n<p>\n            Make the originally-private method private again, and delete the original caller. \n            I'll delete the old test class too, as all its tests have now been duplicated \n            in <code>FileLoaderTests</code>.\n            (see <a href=\"https://github.com/claresudbery/Reconciliate/commit/27f1a59\">commit 27f1a59</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>:\n          </p>\n\n<div class=\"figure \" id=\"New-FileLoader-class-v3-08-v3-small.png\"><img src=\"class-too-large/New-FileLoader-class-v3-08-v3-small.png\">\n<p class=\"photoCaption\">Figure 14: New FileLoader class part 7 \n          (<a href=\"#abbreviations\">abbreviations</a>)</p>\n</div>\n\n<div class=\"clear\"></div>\n</li>\n</ol>\n</section>\n\n<section id=\"move-methods\">\n<h2>6. Move the other methods to the new <code>FileLoader</code> class</h2>\n\n<p>Now I can move all the other methods. I'll handle them one by one,\n      starting with the simplest and keeping an eye out for dependencies\n      (between methods, and on any member data). I'll need to consider the\n      following:</p>\n\n<ul>\n<li>Do I want to rename any methods?</li>\n\n<li>Do I want to replace any parameter lists with new objects?</li>\n\n<li>Are there any redundant parameters?</li>\n\n<li>Are any of the internal nested callees altering state? What impact\n        does this have?</li>\n</ul>\n\n<p>I could inline those lower down in the chain before moving them, but\n      if I did I'd break the tests which call them as public methods. So\n      instead I move them on their own. I do it in the order explained below,\n      acting on one at a time and starting with those at the end of the chain\n      - ie the outermost leaves on the following tree:</p>\n\n<div class=\"figure \" id=\"Move-FileLoader-methods-part-1-narrower.png\"><img src=\"class-too-large/Move-FileLoader-methods-part-1-narrower.png\">\n<p class=\"photoCaption\">Figure 15: FileLoader method tree \n      (<a href=\"#abbreviations\">abbreviations</a>)</p>\n</div>\n\n<div class=\"clear\"></div>\n\n<p>For each one, I use the following approach:</p>\n\n<ul>\n<li>Create a copy of the method in the destination class, keeping the\n        original in place. Make the new method public.</li>\n\n<li>Call the new method instead of the original.</li>\n\n<li>Copy any covering tests into the new test class, and make sure\n        they test the new code.</li>\n\n<li>Delete the old method and the old tests.</li>\n</ul>\n\n<p>I already moved\n      <code>Bank_and_bank_out__ Merge_bespoke_data_with_pending_file</code> and\n      <code>Bank_and_bank_out__ Add_most_recent_credit_card_direct_debits</code>\n      (<a href=\"https://github.com/claresudbery/Reconciliate/commit/0341476\">commit 0341476</a> to <a href=\"https://github.com/claresudbery/Reconciliate/commit/27f1a59\">commit 27f1a59</a>), \n      so now I repeat the same actions for each of the other\n      methods (<a href=\"https://github.com/claresudbery/Reconciliate/commit/7cd53f6\">commit 7cd53f6</a> \n      to <a href=\"https://github.com/claresudbery/Reconciliate/commit/7ab95f2\">commit 7ab95f2</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>. I don't\n      commit every tiny step this time, but I still go through the same set of\n      steps. After each step, I make sure the code builds and the tests are\n      passing (apart from when I deliberately make a test fail).\n      </p>\n\n<p>I refactored some tests earlier, and I can repeat those changes for \n      tests that follow the same\n      pattern. For some methods the move is very simple, because they have no\n      test coverage. This is part of why I'm doing this refactor, to\n      make that code more easily testable.</p>\n\n<aside class=\"sidebar\" id=\"memb-var\">\n<h2>A note on member variables</h2>\n\n<p>The four load methods (<code>Load_bank_and_bank_in</code>, etc) are\n        all using two member variables from <code>ReconciliationIntro</code>:\n        <code>_input_output</code> and <code>_spreadsheet_factory</code>. So\n        when these methods are added to <code>FileLoader</code>, I need to\n        introduce these variables as members in <code>FileLoader</code> too,\n        by injecting them into the constructor. <code>_input_output</code> is\n        already being injected, but when I introduce\n        <code>_spreadsheet_factory</code> I initially give it a default value.\n        This is so the code will still build, and is done before I switch over\n        to using the new methods. This way I can fix all the places that need\n        to inject a spreadsheet factory into <code>FileLoader</code> at my\n        leisure. </p>\n\n<p>See <a href=\"https://github.com/claresudbery/Reconciliate/commit/ce559f2\">commit ce559f2</a> and <a href=\"https://github.com/claresudbery/Reconciliate/commit/7e86292\">commit 7e86292</a> \n        for the actual code changes <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>, \n        but here is a simplification focusing only on the\n        relevant parts:</p>\n\n<div class=\"code-change-series\">\n<pre>internal class ReconciliationIntro\n{\n    private readonly IInputOutput _input_output;\n\n    public ReconciliationInterface Load_correct_files()\n    {\n        Load_bank_and_bank_in(); \n    }\n\n    public ReconciliationInterface Load_bank_and_bank_in() \n    {\n        var file_loader = new FileLoader(_input_output);\n        file_loader.Load_bank_and_bank_in();\n    }\n}\n\ninternal class FileLoader\n{\n    private readonly IInputOutput _input_output;\n\n    public FileLoader(IInputOutput input_output)\n    {\n        _input_output = input_output;\n    }\n\n    public ReconciliationInterface Load_bank_and_bank_in() \n    {\n        _input_output.Output_line(\"Some text\");\n    }\n}\n</pre>\n<span class=\"trans-arrow\">⇓</span>\n<pre>// Still compiles, because ISpreadsheetRepoFactory object has default value in constructor.\n\ninternal class FileLoader\n{\n    private readonly IInputOutput _input_output;\n<span class=\"colblind-highlight\">    private readonly ISpreadsheetRepoFactory _spreadsheet_factory;</span>\n\n    public FileLoader(\n        IInputOutput input_output, \n<span class=\"colblind-highlight\">        ISpreadsheetRepoFactory spreadsheet_factory = null)</span>\n    {\n        _input_output = input_output;\n<span class=\"colblind-highlight\">        _spreadsheet_factory = spreadsheet_factory;</span>\n    }\n\n    public ReconciliationInterface Load_bank_and_bank_in() \n    {\n<span class=\"colblind-highlight\">        var pending_file_io = new FileIO&lt;BankRecord&gt;(_spreadsheet_factory);</span>\n        _input_output.Output_line(\"Some text\");\n    }\n}\n</pre>\n<span class=\"trans-arrow\">⇓</span>\n<pre>// Now ReconciliationIntro can inject member vars into FileLoader and it will all work.\n// Other clients aren't injecting yet, but some time soon we'll amend them all.\n// Finally after that we can remove the default value from the FileLoader constructor.\n\ninternal class ReconciliationIntro\n{\n    private readonly IInputOutput _input_output;\n<span class=\"colblind-highlight\">    private readonly ISpreadsheetRepoFactory <span class=\"colblind-highlight\">_spreadsheet_factory</span>;</span>\n\n    public ReconciliationInterface Load_correct_files()\n    {\n        var file_loader = new FileLoader(_input_output, <span class=\"colblind-highlight\">_spreadsheet_factory</span>);\n        file_loader.Load_bank_and_bank_in(); \n    }\n}\n</pre>\n</div>\n</aside>\n</section>\n\n<section id=\"extract-more-classes\">\n<h2>7. Extract more new classes</h2>\n\n<aside class=\"sidebar\" id=\"order\">\n<h2>A note on the order of the commits</h2>\n\n<p>My main motivation for this refactoring is to remove\n        duplication and introduce a strategy pattern \n        <span class=\"foot-ref\"><a href=\"#footnote-refactoring-to-patterns\">[3]</a></span> for the four data types in\n        the file loading code. This means that if you look at the commits \n        you'll see that after extracting the <code>FileLoader</code> class, \n        I moved on to other things. But when I came back\n        to write up this article, I couldn't bear to leave the\n        <code>ReconciliationIntro</code> class in its still-bloated state, so I\n        got on with extracting the rest of the classes - starting from\n        <a href=\"https://github.com/claresudbery/Reconciliate/commit/3446a54\">commit 3446a54</a>.</p>\n</aside>\n\n<p>When <a href=\"#rearrange-methods\">adding regions at the start</a>,\n      I identified some <b>Get budgeting months</b> functionality which\n      creates its own clear <a href=\"https://en.wikipedia.org/wiki/Separation_of_concerns\">context</a>, \n      so I extract these methods out into\n      a new <code>BudgetingMonthService</code> class. This is very quick and\n      simple because these methods only have one public entry point\n      (see <a href=\"https://github.com/claresudbery/Reconciliate/commit/6103f0b\">commit 6103f0b</a>) <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>.\n      </p>\n\n<p><code>ReconciliationIntro</code> is still too big, but the methods all\n      call one another and now that I've spent more time refamiliarising myself\n      with the code I'm not convinced my two remaining regions of <code>User\n      Instructions and Input</code> and <code>Debug Spreadsheet Operations</code> are\n      the best ways of dividing the remaining code. To help myself think about\n      it, I use a spreadsheet to quickly illustrate the call hierarchy. </p>\n\n<div class=\"figure \" id=\"LastRecIntroClasses-v2-small-more-legible.png\"><img src=\"class-too-large/LastRecIntroClasses-v2-small-more-legible.png\">\n<p class=\"photoCaption\">Figure 16: Call hierarchy</p>\n</div>\n\n<div class=\"clear\"></div>\n\n<p>This allows me to see that there are THREE self-contained areas of\n      code, not two: <code>User instructions</code>, <code>Gathering file / path info</code> and\n      <code>Debug mode switching code</code>. </p>\n\n<p>I remove the original regions (<a href=\"https://github.com/claresudbery/Reconciliate/commit/4c57927\">commit 4c57927</a>) and replace\n      them with four new regions (<a href=\"https://github.com/claresudbery/Reconciliate/commit/3446a54\">commit 3446a54</a>) \n      <span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>. I rearrange the\n      methods to fit in the new regions, and these will now translate into three\n      new classes: <code>Communicator</code>, <code>PathSetter</code> and\n      <code>DebugModeSwitcher</code> (<code>FileLoader</code> and <code>BudgetingMonthService</code> \n      are not shown on this diagram because they have already been extracted): </p>\n\n<div class=\"figure \" id=\"MasterPlan-part2-darker-text-taller.png\"><img src=\"class-too-large/MasterPlan-part2-darker-text-taller.png\">\n<p class=\"photoCaption\">Figure 17: Identifying final \n      ReconciliationIntro classes</p>\n</div>\n\n<div class=\"clear\"></div>\n\n<p>I create these new classes gradually and safely using the same\n      principles as for <code>BudgetingMonthService</code>, removing the new regions once\n      they've served their purpose (see <a href=\"https://github.com/claresudbery/Reconciliate/commit/7f464a4\">commit 7f464a4</a> to\n      <a href=\"https://github.com/claresudbery/Reconciliate/commit/7e118c1\">commit 7e118c1</a>).</p>\n\n<p>\n        It's worth noting that when extracting new classes from a larger class, \n        I want them to be independent. For this reason\n        I'm deliberately avoiding the anti-pattern which can sometimes arise,\n        where extracted classes are automatically injected as a dependency\n        into the constructor of the original class.\n      </p>\n\n<p>The <code>PathSetter</code> class turns out to be non-trivial - see\n      <a href=\"https://github.com/claresudbery/Reconciliate/commit/2921220\">commit 2921220</a> to <a href=\"https://github.com/claresudbery/Reconciliate/commit/398539a\">commit 398539a</a><span class=\"foot-ref\"><a href=\"#footnote-commits-not-compulsory\">[4]</a></span>. This is due to the\n      currently-slightly-tortuous nature of the path-setting code, something I\n      noticed <a href=\"#one-thing\">at the end of\n      step 3</a>. By extracting this code into a separate class and giving it\n      its own clear <a href=\"https://en.wikipedia.org/wiki/Separation_of_concerns\">context</a>, \n      I'm already making this code a bit better -\n      but it will still need some attention.</p>\n\n<p>Finally, my <code>ReconciliationIntro</code> class is \n      <a href=\"https://github.com/claresudbery/Reconciliate/blob/Refactor-examples/Console/Reconciliation/ReconciliationIntro.cs\">cleaner and simpler</a>, and the\n      original 41 methods have been reduced to three: \n      <code>Start</code>, <code>Reconciliate</code> and\n      <code>Do_matching</code>:</p>\n\n<div class=\"figure \" id=\"Final-ReconciliationIntro-class.png\"><img src=\"class-too-large/Final-ReconciliationIntro-class.png\">\n<p class=\"photoCaption\">Figure 18: Final ReconciliationIntro class</p>\n</div>\n\n<div class=\"clear\"></div>\n</section>\n\n<section id=\"Recap\">\n<h2>Recap</h2>\n\n<aside class=\"sidebar\" id=\"reality\">\n<h2>The reality: Most teams own problematic code</h2>\n\n<p>Note that it's tempting to say, \"But your code only got into this state\n        because you were coding alone, late at night in snatched chunks of spare\n        time. Well-disciplined teams with amazing software engineering practices\n        would never see their code bases get into this state.\" But most teams are not\n        perfect, and most teams find themselves taking shortcuts because of time\n        pressures at some time or other. Sometimes brilliant teams have to handle code\n        written by less-fortunate teams. For whatever reasons, it is likely that most\n        software engineers will find themselves at some point or other having to\n        refactor code that has got out of hand.</p>\n\n<p>I confess I've been nervous about exposing my code base to the public\n        gaze, because clearly it's far from perfect. But this is reality. Even\n        the best coders (and I don't count myself as one of them) will likely \n        have problematic\n        code lurking somewhere on their hard drives.</p>\n</aside>\n\n<p><i>My class was too large</i>. I had developed undesirable coding habits \n      and I wanted\n      to stop and make things better before adding any new functionality.</p>\n\n<p>To fix my too-large class, I took the following actions:</p>\n\n<ul>\n<li><a href=\"#rearrange-methods\">Rearranged methods</a> into\n        sensible groupings, to help identify new classes.</li>\n\n<li><a href=\"#analyse-rels\">Analysed\n        relationships between file-loading methods</a>, so that I could work out\n        how to create a new <code>FileLoader</code> class with minimum coupling\n        with the rest of the code.</li>\n\n<li><a href=\"#modify-staying\">Modified\n        the methods that were staying behind</a>, so that they could be called\n        by those that are moving (if necessary).</li>\n\n<li><a href=\"#covering-tests\">Created covering\n        tests for the new <code>FileLoader</code> class</a>, by creating a new\n        <code>FileLoaderTests</code> class.</li>\n\n<li><a href=\"#create-fileloader\">Created the new\n        <code>FileLoader</code> class and moved two methods</a>.</li>\n\n<li><a href=\"#move-methods\">Moved the other\n        methods to the new <code>FileLoader</code> class</a>.</li>\n\n<li><a href=\"#extract-more-classes\">Extracted more new classes</a>.</li>\n</ul>\n\n<p>I <a href=\"#how\">moved in tiny steps</a>, and I compiled and ran the\n      tests at every step. Now I have a much smaller class which calls\n      functionality from several other also-smaller classes, and each one of \n      them is easier to fit in my head.</p>\n</section>\n\n<section id=\"WhatsNext\">\n<h2>What's next?</h2>\n\n<p>Note that this article ends in the middle of the refactor, so if you\n      want to see the relevant state of the code before moving on to the next\n      steps, you need to \n      <a href=\"https://git-scm.com/docs/git-checkout\">checkout</a> the <a href=\"https://github.com/claresudbery/Reconciliate/commit/6103f0b\">commit 6103f0b</a>.\n      Note also that I completed most of <a href=\"#extract-more-classes\">step 7</a>\n      in this article <i>after</i> that commit (explanation\n      <a href=\"#order\">here</a>).</p>\n\n<p>At <a href=\"https://github.com/claresudbery/Reconciliate/commit/6103f0b\">commit 6103f0b</a>, \n      I've pulled the file-loading code out into the <code>FileLoader</code> class and have\n      a clearer view of the main challenge. \n      The following four methods (visible in situ <a href=\"https://github.com/claresudbery/Reconciliate/blob/6103f0b7076291882a43acca368075135f407498/Console/Reconciliation/Loaders/FileLoader.cs#L111\">here</a>) \n      are clearly problematic:</p>\n\n<ul>\n<li><code>Load_bank_and_bank_in</code></li>\n\n<li><code>Load_bank_and_bank_out</code></li>\n\n<li><code>Load_cred_card1_and_cred_card1_in_out</code></li>\n\n<li><code>Load_cred_card2_and_cred_card2_in_out</code></li>\n</ul>\n\n<p>They have the following problems:</p>\n\n<ul>\n<li>There is a lot of duplication - at a glance, they look identical.</li>\n\n<li>They are way too long.</li>\n\n<li>They create objects internally and pass them into one another in a\n        closely inter-dependent way which is not testable.</li>\n</ul>\n\n<p>These are all problems I want to solve, but before I do any more\n      refactoring I really need some tests around those methods. That's what\n      I'll do next. My desire is to write about it in a follow-up article, \n      but I've learnt better than to make promises about that kind of thing, \n      so for now it's an exercise for the reader.</p>\n</section>\n\n<hr class=\"bodySep\">\n</div>\n\n<div class=\"appendix\">\n<section id=\"Acknowledgements\">\n<h2>Acknowledgements</h2>\n\n<p>Many thanks to the following people, who very kindly read early drafts of this article and \n      contributed invaluable feedback and suggestions: \n      <a href=\"https://twitter.com/paulapaultweets\">Paula Paul</a>, <a href=\"https://twitter.com/martinfowler\">Martin Fowler</a>, \n      <a href=\"https://twitter.com/pritibiyani\">Priti Biyani</a>, <a href=\"https://twitter.com/RNovaglia\">Riccardo Novaglia</a>, \n      <a href=\"https://twitter.com/tastapod\">Dan Terhorst-North</a>, <a href=\"https://twitter.com/KevlinHenney\">Kevlin Henney</a>, \n      <a href=\"https://twitter.com/sf105\">Steve Freeman</a>, <a href=\"https://twitter.com/jonskeet\">Jon Skeet</a>, \n      <a href=\"https://twitter.com/SalFreudenberg\">Sal Freudenberg</a>, <a href=\"https://twitter.com/jr261\">Joe Ray</a>, \n      <a href=\"https://twitter.com/the_sheps\">Chris Shepherd</a>, <a href=\"https://twitter.com/LukeMorton\">Luke Morton</a>, \n      <a href=\"https://www.linkedin.com/in/scott-giminiani/\">Scott Giminiani</a>, <a href=\"https://www.linkedin.com/in/richard-foster-293939163/\">Richard Foster</a>, \n      Marcos Bezerra, <a href=\"https://twitter.com/gwawr_\">Sam Carrington</a>.\n      </p>\n</section>\n\n<div class=\"footnote-list\">\n<h2>Footnotes</h2>\n\n<div class=\"footnote-list-item\" id=\"footnote-tdd\">\n<p><span class=\"num\">1: </span><b>TDD</b> stands for Test-Driven Development, a technique to ensure that all units of code are tested, and that\n      the tests describe the behaviour of the system. This is done by writing the tests <i>before</i> \n      you write the code to make those tests pass. There's a lot more that can be said about it, but it's not \n      the focus of this article. You can read more about it <a href=\"https://martinfowler.com/bliki/TestDrivenDevelopment.html\">here</a>.\n    </p>\n</div>\n\n<div class=\"footnote-list-item\" id=\"footnote-fits-in-my-head\">\n<p><span class=\"num\">2: </span><b>\"Fits In My Head\"</b> is one of the patterns in Dan Terhorst-North's \n      <a href=\"https://leanpub.com/softwarefaster\">Software, Faster book</a> (a work still in progress). \n      He talks about the importance of being able to comprehend any chunk of code\n      by \"fitting it in your head.\"\n      The name came from <a href=\"https://www.thoughtworks.com/profiles/james-lewis\">James Lewis</a>, and Dan describes it \n      <a href=\"https://www.youtube.com/watch?v=XqgwHXsQA1g&amp;feature=youtu.be&amp;t=510\">in this talk</a>, \n      but Dan tells me the concept may have originated with \n      <a href=\"https://neo4j.com/blog/contributor/alistair-jones/\">Alistair Jones</a>.\n    </p>\n</div>\n\n<div class=\"footnote-list-item\" id=\"footnote-refactoring-to-patterns\">\n<p><span class=\"num\">3: </span><b>Refactoring to the strategy pattern:</b> \n      A large part of the aim of this refactoring is to enable use of the \n      <a href=\"https://en.wikipedia.org/wiki/Strategy_pattern\">strategy pattern</a>. The business of \"refactoring to patterns\" \n      has a whole <a href=\"https://www.martinfowler.com/books/r2p.html\">book devoted to it, by Joshua Kerievsky</a> \n      - and is worth a read if you want to know more. Indeed as Martin Fowler says, \"Many people have said \n      they find a refactoring approach to be a better way of learning about patterns, because you see in \n      gradual stages the interplay of problem and solution.\"\n    </p>\n</div>\n\n<div class=\"footnote-list-item\" id=\"footnote-commits-not-compulsory\">\n<p><span class=\"num\">4: </span><b>Commit links:</b> Don't feel obligated to follow the commit links! More on that in the \n      <a href=\"#how-to-read\"><i>How to read this article</i> sidebar</a>.\n    </p>\n</div>\n\n<div class=\"footnote-list-item\" id=\"footnote-resharper\">\n<p><span class=\"num\">5: </span><b>Resharper</b> is a commonly-used Visual Studio extension used for things such\n      as code editing. However it is not free, and is being increasingly eclipsed\n      by native Visual Studio tooling.\n    </p>\n</div>\n</div>\n</div>\n\n<div class=\"appendix\">\n<h2 id=\"SignificantRevisions\">Significant Revisions</h2>\n\n<p><i>14 April 2020: </i>first published</p>\n</div>\n</main>\n\n<nav id=\"bottom-navmenu\" style=\"display: none;\">\n<nav class=\"navmenu\">\n<div class=\"nav-head\">  <div class=\"search\">\n    <!-- SiteSearch Google -->\n    <form method=\"GET\" action=\"https://www.google.com/search\">\n      <input type=\"hidden\" name=\"ie\" value=\"UTF-8\">\n      <input type=\"hidden\" name=\"oe\" value=\"UTF-8\">\n      <input class=\"field\" type=\"text\" name=\"q\" size=\"15\" maxlength=\"255\" value=\"\">\n      <button class=\"button\" type=\"submit\" name=\"btnG\" value=\" \" title=\"Search\">\n      <input type=\"hidden\" name=\"domains\" value=\"martinfowler.com\">\n      <input type=\"hidden\" name=\"sitesearch\" value=\"\"> \n      <input type=\"hidden\" name=\"sitesearch\" value=\"martinfowler.com\">\n    \n  </button></form></div>\n\n<div class=\"closediv\">\n<span class=\"close\" title=\"close\"></span>\n</div>\n</div>\n\n<div class=\"nav-body\">\n<div class=\"topics\">\n<h2>Topics</h2>\n\n<p><a href=\"/architecture\">Architecture</a></p>\n\n<p><a href=\"https://refactoring.com\">Refactoring</a></p>\n\n<p><a href=\"/agile.html\">Agile</a></p>\n\n<p><a href=\"/delivery.html\">Delivery</a></p>\n\n<p><a href=\"/microservices\">Microservices</a></p>\n\n<p><a href=\"/data\">Data</a></p>\n\n<p><a href=\"/testing\">Testing</a></p>\n\n<p><a href=\"/dsl.html\">DSL</a></p>\n</div>\n\n<div class=\"about\">\n<h2>about me</h2>\n\n<p><a href=\"/aboutMe.html\">About</a></p>\n\n<p><a href=\"/books\">Books</a></p>\n\n<p><a href=\"/faq.html\">FAQ</a></p>\n</div>\n\n<div class=\"content\">\n<h2>content</h2>\n\n<p><a href=\"/videos.html\">Videos</a></p>\n\n<p><a href=\"/tags\">Content Index</a></p>\n\n<p><a href=\"/articles/eurogames\">Board Games</a></p>\n\n<p><a href=\"/photos\">Photography</a></p>\n</div>\n\n<div class=\"tw\">\n<h2>ThoughtWorks</h2>\n\n<p><a href=\"https://thoughtworks.com/insights\">Insights</a></p>\n\n<p><a href=\"https://thoughtworks.com/careers\">Careers</a></p>\n\n<p><a href=\"https://thoughtworks.com/products\">Products</a></p>\n</div>\n\n<div class=\"feeds\">\n<h2>follow</h2>\n\n<p><a href=\"https://www.twitter.com/martinfowler\">Twitter</a></p>\n\n<p><a href=\"/feed.atom\">RSS</a></p>\n</div>\n</div>\n</nav>\n</nav>\n<footer id=\"page-footer\">\n<div class=\"tw-logo\">\n<a href=\"http://www.thoughtworks.com\">\n<img src=\"/tw-white-300.png\">\n</a>\n</div>\n<div class=\"menu-button\">\n<div class=\"icon-bars navmenu-button\"></div>\n</div>\n<div class=\"copyright\">\n<p>© Martin Fowler | <a href=\"http://www.thoughtworks.com/privacy-policy\">Privacy Policy</a> | <a href=\"/aboutMe.html#disclosures\">Disclosures</a></p>\n</div>\n</footer>\n<!-- Google Analytics -->\n<script>\nwindow.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;\nga('create', 'UA-17005812-1', 'auto');\nga('send', 'pageview');\n</script>\n<script async=\"\" src=\"https://www.google-analytics.com/analytics.js\"></script>\n<!-- End Google Analytics -->\n\n\n\n<script src=\"/jquery-1.11.3.min.js\" type=\"text/javascript\"></script>\n\n<script src=\"/mfcom.js\" type=\"text/javascript\"></script>\n\n\n","text":"Refactoring\nAgile\nArchitecture\nAbout\nThoughtWorks\nTopics\nArchitecture\nRefactoring\nAgile\nDelivery\nMicroservices\nData\nTesting\nDSL\nabout me\nAbout\nBooks\nFAQ\ncontent\nVideos\nContent Index\nBoard Games\nPhotography\nThoughtWorks\nInsights\nCareers\nProducts\nfollow\nTwitter\nRSS\nContents\nOutline of the problemWhy refactor?How do I do it?1. Rearrange methods2. Analyse relationships between file-loading methodsPlan of action3. Modify the methods that are staying behind4. Create covering tests for the new FileLoader class5. Create new FileLoader class and move two methods6. Move the other methods to the new FileLoader class7. Extract more new classesRecapWhat's next? Sidebars\nLanguage and approach\nC#\nTest-driven development\nHow to avoid getting here in the first place\nHow to read this article\nPrinciple: Always commit moves and renames separately from edits.\nAbbreviated method names\nPrinciple: Do one thing at a time. Focus!\nAutomated refactorings\nA note on member variables\nA note on the order of the commits\nThe reality: Most teams own problematic code\nRefactoring: This class is too large\nAn example of refactoring from a real (flawed) code base.\nIn this article I walk through a set of refactorings from a real code base. This is not intended to demonstrate perfection, but it does represent reality.\n14 April 2020\nClare Sudbery\nWriter, speaker, asker of questions and enthusiast of Extreme Programming - Clare is an ex high school maths teacher and a consultant with 20 years of software engineering experience. She is on a mission to awaken the inner geek in people everywhere - particularly those not traditionally encouraged to geek out.\nContents\nOutline of the problem\nWhy refactor?\nHow do I do it?\n1. Rearrange methods\n2. Analyse relationships between file-loading methods\nPlan of action\n3. Modify the methods that are staying behind\n4. Create covering tests for the new FileLoader class\n5. Create new FileLoader class and move two methods\n6. Move the other methods to the new FileLoader class\n7. Extract more new classes\nRecap\nWhat's next?\nSidebars\nLanguage and approach\nC#\nTest-driven development\nHow to avoid getting here in the first place\nHow to read this article\nPrinciple: Always commit moves and renames separately from edits.\nAbbreviated method names\nPrinciple: Do one thing at a time. Focus!\nAutomated refactorings\nA note on member variables\nA note on the order of the commits\nThe reality: Most teams own problematic code\nThis is a story about refactoring. It's the third item in the TDD red-green-refactor cycle[1] and it's the thing we do all the time, right? Except when we don't.\nI have an unruly code base which has suffered from refactoring neglect, so I've been bringing it back into line. In this article I will take a class that is too large, and make it smaller.\nLanguage and approach\nC#\nI generally write code in whatever language suits the client, the project and the problem at hand. But the majority of my career has been in the .Net space, so C# is my comfort zone and my default go-to. The examples in this article are written in C#, but I hope the code snippets included are simple enough to follow even if you don't know the language.\nTest-driven development\nI'm a big fan of Test-Driven Development (TDD) [1], and the code presented here was mostly written using that approach. But I have to confess that after 20 years as an engineer, I have at least half a career of bad habits behind me and I don't always get things right.\nOutline of the problem\nThe story begins with a boring domestic chore. I've written some personal accounting software - Reconciliate. It works on the command line and performs the following actions:\nLoads my own comma-separated data:\nMy record of recent bank and credit card transactions.\nMy predicted monthly and annual transactions (based on data in a central spreadsheet).\nAny unreconciled previously-recorded data.\nLoads third-party comma-separated data (from bank and credit card companies).\nReconciles the third-party data against my own data.\nWrites everything back to a central spreadsheet.\nI have some bugs that need fixing and some features to add. But my typical workflow is to arrive at the laptop late at night after putting my youngest to bed, with only a small amount of time before it will be my bedtime, and often a few weeks after the last time I saw the code. In these circumstances it's horribly easy to think things like, \"Well I know this code is a mess, but I don't have time to get my head round it and fix it now...\"\nClearly this is not ideal.\nThere's one class in particular - the ReconciliationIntro class - which is giving me a headache whenever I look at it. It's bloated and convoluted and impossible to fit in my head [2]. This has created a nasty feedback loop: \"Because this code is so hard to reason about, refactoring will take more time and energy than I have, so I'll put up with it even longer - even though it means I can't even make small changes any more because it takes so long for me to understand the code's current state and decide where the change should go.\"\nFor instance, I want to add the ability to handle another credit card. In a lot of places I've used polymorphism and the strategy pattern to keep the unique behaviour of each credit card neatly encapsulated. But the ReconciliationIntro class is one place where, because of the poor design of the code and the lack of clear context separation, if I add another credit card I'll be making an already bloated class even worse. It contains four duplicated code paths for each of four types of data (Bank In, Bank Out, Credit Card 1 and Credit Card 2), and if I add Credit Card 3 right now I'll end up following the same anti-pattern.\nMy overall aim is to replace this code with more generic code, via the strategy pattern [3]. But there are four problems standing in my way:\nThis one large class, (ReconciliationIntro), is taking too much responsibility.\nThere's a lot of private nested code, which is hard to unit-test because it has no public interface.\nWithin ReconciliationIntro, there's one large method that's doing too much.\nThere are several methods in ReconciliationIntro which use the same repeated pattern but with different details.\nI plan to fix all of these problems, in the order listed above. This preparatory refactoring will get me to the point where I can easily encapsulate the behaviour of each credit card / account. As Kent Beck says, \"Make the change easy, then make the easy change.\"\nThis article is about tackling the first problem in the above list: This class is too large.\nWhy refactor?\nI can't easily reason about the ReconciliationIntro class because it has too many responsibilities. It was originally designed as the entrance hall to the software, and all it did was display a few messages and then instantiate the classes that do the main work. But over time a lot of other code has snuck in. I want to make it easier to add another credit card, so I'm going to start by breaking this large class into smaller classes.\nThe benefits will be several:\nBy moving groups of methods into separate classes I'll create clear contexts and minimise tight coupling. This means that:\nI'll know where to go when I want to make changes or fix issues.\nWhen I amend the code, I'll only have to work with small isolated sections that fit in my head [2] - I won't have to understand the whole system.\nAny manipulation of state will only happen locally in a small context - so I won't have to worry about one area of the system changing state in another.\nHow to avoid getting here in the first place\nCould I have avoided being in this position? Yes, of course. Rather than despairing about a lack of time, I could have made small continuous changes whenever I encountered problem areas. That's part of what the refactor stage of the red-green-refactor cycle is for, and it's a habit you can reinstate at any time.\nBut it's worth acknowledging that when coding under pressure, you're not always in a fit state to make the right choices. Your code can quickly reach a level of crustiness that makes a refactor feel insurmountable. At these times it's always worth using small changes to make things better piece by piece, no matter what state your code is in.\nHow do I do it?\nTo my mind, the most important principle when refactoring (and when writing new code) is to move in tiny steps. I have several connected aims:\nAt every step, I want the code to compile and the tests to run.\nIf a change causes any tests to fail, I want to be able to fix them instantly. By making small changes and small commits, I can see which change caused the tests to fail and I only need to rewind / examine a small amount of code to find the problem.\nI can keep track of where I am in in my head. It's horribly easy to embark on a relatively simple refactor, only to find it has repercussions beyond your original intention. At this point, if you're not in the habit of keeping the code compiling and the tests passing at every step, you can find yourself lost in a rabbit hole that's difficult to exit: Your code isn't compiling and your tests aren't even running, let alone passing.\nFor this to work, I need the code being refactored to be covered by tests. This has already been done before I start refactoring, although it's worth noting that one of my aims in a future refactoring will be to make the code even more testable.\nRefactoring, by Martin Fowler is a recommended further read and lays out some basic refactoring principles. He also emphasises the value of moving in tiny steps and building the code / running your tests after every small commit.\nBeyond these basic principles, I'll aim to follow a logical series of steps which are outlined below.\nHow to read this article\nThis is a real code base and a messy code base (hence the refactoring), so there's a lot of code. For those who want to know more, I do link to the code repeatedly. But I've deliberately kept the descriptions high-level, and you don't need to follow those links.\n1. Rearrange methods\nI'll start by using regions to rearrange all the methods in the ReconciliationIntro class into sensible groupings&nbsp;(commit f2d9932) [4]:\nFigure 1: ReconciliationIntro after methods rearranged into regions\nPrinciple: Always commit moves and renames separately from edits.\nIt's important that I move code around like this as a separate task and in a separate commit, without editing the code in any way. When you rearrange methods, the resulting code difference will include many added/deleted chunks of code. If the code has been changed as well as moved, you can't easily tell whether lines have been deleted or moved, and whether moved lines are the same or different. As Dan Terhorst-North says, \"A change should be structural or behavioural, but never both.\"\nFigure 2: What a commit looks like when you've moved code around\nNow that I've grouped my methods into what feels like a reasonable set of contexts, I'd like to pull these out into separate classes. But where to start? The file loading code contains the most duplication, and is causing the most pain. Ultimately I want to make this code more generic, but first I want to pull it out so I can see it without distraction. I'll extract a new FileLoader class. The other groupings will also become separate classes but they'll be a lot simpler, so I'll focus most of this article on the file-loading code.\nAbbreviated method names\nThe naming of anything - from methods to pubs to children - is a notoriously difficult enterprise. My tendency to verbosity is as evident in my method names as it is in the longwinded stories you'll hear if you meet me in a pub. Before refactoring, the duplication of code meant that method names were being used to differentiate between contexts - and this resulted in some long names. To avoid gigantic images I've abbreviated names in most of the diagrams, as follows:\nBBI: bank_and_bank_in (\"bank\" and \"bank_in\" represent two different views - the bank's, and my own)\nBBO: bank_and_bank_out (\"bank\" and \"bank_out\" as with \"bank\" and \"bank_in\" above)\nCC1: cred_card1_and_cred_card1_in_out (\"cred_card1\" and \"cred_card1_in_out\" as with \"bank\" and \"bank_in\" above)\nCC2: cred_card2_and_cred_card2_in_out (as with \"cred_card1\" above)\nMerge_bd: Merge_bespoke_data\nBM: budgeting_months\nccds: credit_card_debits\nwpf: with_pending_file\nCC: cred_card\nDDs: direct_debits\n2. Analyse relationships between file-loading methods\nSo far all I've done is move some code around in the same class. I rebuilt the code and ran all the tests before I committed, but unless I was clumsy I'd expect my previous commit to be trivial. I need to be a little more thoughtful about what I do next.\nI've used one of my regions to identify methods to pull out into a new FileLoader class, but how can I be sure this will work? Are there any hidden dependencies? I'll discover this by drawing out the relationships between the methods I want to move. The ones to be moved are marked in blue.\nFigure 3: File-loading methods to be moved (abbreviations)\nI can see straight away that it's not a strictly self-contained context: Some of the blue methods are calling back out to methods (shown in black and green) that I want to keep in a separate class. There are a couple of ways I could handle this, which I discuss below. But now I'm at a place where I can define a plan of action.\nPlan of action\nBy the time I'm done, the original large ReconciliationIntro class will have been broken down into the pared-down version plus five new classes shown in the diagram below. Note that there isn't a one-to-one mapping between regions and classes, because later on when I reach step 7, I'll end up refining my first groupings into some finer-grained boundaries.\nFigure 4: Plan of action\nMy overall aim is to break this large class down into smaller classes. In steps 1 and 2 above, I used regions and a diagram to identify distinct areas of code and then analyse relationships between some of the methods. That gave me enough information to start thinking about how I can tackle this job in tiny steps.\nThe resulting plan is summarised below and then described in detail further down. I reached this plan by thinking about how I could proceed using steps that were as small as possible. Often what I'm doing is setting things up so that the next change will be as small and simple as possible. I'm making small changes to facilitate more small changes - yet again following Kent Beck's dictum to \"Make the change easy, then make the easy change.\"\nDepending on your circumstances you might not follow the same plan, but it's not a bad template if you're not sure how to proceed. Your priority is to set yourself up for safe incremental changes:\nRearrange methods\nGroup all the methods in the class into sensible groupings, as described above.\nAnalyse relationships between file-loading methods\nIdentify how the file-loading code is connected to the rest of the code in the ReconciliationIntro class, as described above.\nModify the methods that are staying behind\nThere are methods which will stay in the parent class but are currently called by those that are moving. Some modification will be required to make this work.\nCreate covering tests for the new FileLoader class\nThe new FileLoader class needs to be covered by tests. The tests for the code to be moved already exist, but they'll be moved into a new FileLoaderTests class.\nCreate new FileLoader class and move two methods\nFollowing the principle of tiny steps, I'll move just two methods (a public method and a private method called by it) before I move the rest.\nMove the other methods to the new FileLoader class\nThis is where it gets exciting. All that file-loading code I'm interested in will finally get a new home!\nExtract more new classes\nOnce I've dealt with the file-loading code, I'll create some more new classes for the other code regions.\nThe new FileLoader class will be responsible for loading various sources of comma-separated data and merging them ready for reconciliation. This file-loading code is where most of the pain currently lies, so that's the bit I'll describe in the most detail. You can see the original code before refactoring here, but if you follow that link all you'll learn is that it's too big to fit in your head! The slimmed down post-refactor version is here.\nSo, now I can continue with the plan:\n3. Modify the methods that are staying behind\nI've identified two methods - Set_path and Recursively_ask_for_budgeting_months - which are called by file-loading methods:\nFigure 5: Methods called by file-loading methods (abbreviations)\nAs long as those methods are not too tightly coupled with the file-loading class, I can either\nMake them public so I can call back to them from the new FileLoader class.\nMove the calls out of the file-loading code and into other native ReconciliationIntro methods instead.\nI'll use the first approach for Recursively_ask_for_budgeting_months and the second for Set_path, which will bring me to the following situation:\nFigure 6: File-loading methods after moving (abbreviations)\nNote that the methods marked as FileLoader methods in the diagram will still be in the ReconciliationIntro class at the end of this step, but this will enable me to move them into the FileLoader class, which will happen in step 5 and step 6 below.\nRecursively_ask_for_budgeting_months will eventually be a public method in another class, but for now I just want to make sure I can call it from elsewhere. It turns out it already is public, which was done so that it could be tested. This in itself is a code smell - it's a sign that it would be better off as part of the public interface of a separate class.\nThe other method called from the file-loading code is Set_path. This changes the value of an internal path variable, so I'll choose option 2: I'll call it separately and pass the resulting data into the file-loading method via a parameter.\nPrinciple: Do one thing at a time. Focus!\nIn the process of editing Set_path, I've noticed a couple of other changes I want to make.\nFirstly, Set_path has the side effect of altering the _path member variable. It would be better if it was self-contained and just returned a new path.\nSecondly, currently Set_path is being called in two places - just before Create_pending_csvs is called, and much lower down in the chain of events, from within another method called Set_path_and_file_names. If I follow the chain of different methods involved here, I realise they're not called in a sensible order and there's a lot of redundancy. The code is hard to follow, and it would be tempting to refactor it now.\nBut I'm in the middle of another refactoring, so I make a note (on my Trello board) and leave these changes for later. Otherwise I'll get distracted from the task at hand and could get the code into a strange state and lose track of what I'm doing. Focus is important!\nNote that these might not normally stay as separate commits (I could use micro-commits and then squash them into larger commits), but I'm keeping the small commits intact to make the steps clear. I compile and run the tests at every step:\nModify the calling method (Create_pending_csvs) so that it takes a parameter, but initially give it a default value (commit acc3519) [4] so that the code still compiles:\nprivate void Create_pending_csvs()\n{ // Some code\n} ⇓ private void Create_pending_csvs(<span class=\"colblind-highlight\">string path = \"\"</span>)\n{ // Some code\n}\nCall Set_path separately before calling Create_pending_csvs. Take the resulting new _path member variable (see sidebar), and pass it into Create_pending_csvs (commit c5ebc2f) [4]:\ncase \"1\":\n{ Create_pending_csvs();\n}\nbreak; ⇓ case \"1\":\n{ Set_path(); Create_pending_csvs(<span class=\"colblind-highlight\">_path</span>);\n}\nbreak;\nRemove the call to Set_path from within Create_pending_csvs, and use the passed-in value instead of the member variable (commit 6df8f97) [4]:\nprivate void Create_pending_csvs(string path = \"\")\n{ try { Set_path(); var pending_csv_file_creator = new PendingCsvFileCreator(_path); ⇓ private void Create_pending_csvs(string path = \"\")\n{ try { <span class=\"colblind-deleted\">Set_path();</span> var pending_csv_file_creator = new PendingCsvFileCreator(<span class=\"colblind-highlight\">path</span>);\nFinally, remove the default value from the Create_pending_csvs parameter - thereby forcing all clients to pass a value in (commit 2be56ea) [4]. Note that by doing things in this order, I keep the code compiling at all times:\nprivate void Create_pending_csvs(string path = \"\")\n{ // Some code\n} ⇓ private void Create_pending_csvs(string path <span class=\"colblind-deleted\">= \"\"</span>)\n{ // Some code\n}\n4. Create covering tests for the new FileLoader class\nMy first choice of method to move will be Bank_and_bank_out_ _Merge_bespoke_data_with_pending_file. And the first thing I want to do is copy any covering tests into a new test class for the about-to-be-created FileLoader class. There is already one test for this method - M_MergeBespokeDataWithPendingFile_ WillAddMostRecentCredCardDirectDebits - and its job is to make sure this method merges new direct debit data correctly with a 'pending' file (which is being built to contain all new transaction data).\nNote that I'm only moving tests, not writing new ones. People can get so used to the TDD [1] concept of writing tests before writing code that they assume you need to write new tests whenever you work on code. This is often not the case when refactoring. Ideally my functionality will already be covered by tests, and when refactoring I'm not changing the functionality. So instead of writing new tests, I'm using the existing ones to verify the functionality still works as originally intended.\nThis is a good time to review this test: It's a while since I wrote it, so I should be able to spot quickly whether it makes sense. I want my tests to be clear and easy to read - they should act as documentation for my system behaviour. The first thing I notice is that it contains an assert method - Assert_direct_debit_details_are_correct - whose name is inadequate. What is the definition of \"correct\"? I rewrite the test to make it easier to read, which involves quite a lot of changes. In the interest of keeping this a digestible read I won't go into the changes made, but you can view them in commit f090f26 and commit 6a6cece. [4]\nNow that I've refactored the test I'll copy it into a new test class, along with some associated private helper methods. Note that although this and other tests are destined to operate on a new FileLoader class, they'll still act on the old ReconciliationIntro class until I'm sure my new test class has everything it needs. Also note that until everything is safely moved, my test code is duplicated.\nAutomated refactorings\nIt's worth being aware that there are many automatable refactoring tasks which require significantly more care when tools like Resharper [5] are not available.\nFor instance, with Resharper you can quickly and confidently rename a method that has clients throughout a large code base. But without this tool, such a change might be handled differently - for instance by creating a temporary wrapper method.\nI first create the new test class in the same file as the original (commit 491c795) [4], so that it's easy to see what I'm copying. Then I can get Resharper [5] and Visual Studio to move everything into a new file for me (commit c9317c0) [4].\nFigure 7: Move BBO tests\n5. Create new FileLoader class and move two methods\nNow that my test class is up and running, I can create the new FileLoader class.\nThe method that's furthest down the chain - the lowest leaf in my tree of methods - is Bank_and_bank_out__ Add_most_recent_credit_card_direct_debits. This is a private method with no independent tests (it's tested via the public calling method), so I'm going to move both it and its caller (Bank_and_bank_out__ Merge_bespoke_data_with_pending_file). These will be the first two methods to be moved into my new class.\nAgain, I'll move in baby steps to avoid my tests going red and keep my code building at all times. After each of the following steps I make sure the code builds and the tests are passing.\nThis is the situation I begin with. A FileLoaderTests class has been created, but it is testing code that still lives in the ReconciliationIntro class:\nFigure 8: New FileLoader class part 1 (abbreviations)\nI start by creating a new FileLoader class. One of my file-loading methods (Bank_and_bank_out__ Add_most_recent_credit_card_direct_debits) is private, and will also be private at the end of this process. It will only ever be called by the method that's about to follow it into the new class. It's not individually covered by tests, so I can just copy it over to the new class and have it ready and waiting when its caller is moved (see commit 0341476) [4]. But I will need to make it temporarily public:\nFigure 9: New FileLoader class part 2 (abbreviations)\nNow I can create an instance of my new FileLoader class in the ReconciliationIntro class and call its new public method, instead of the old private method. I can also delete the old private method (see commit bde2ae2) [4]:\nFigure 10: New FileLoader class part 3 (abbreviations)\nCopy the original caller into the new class (see commit f0a5a59) [4]. Note that at this point it's duplicated:\nFigure 11: New FileLoader class part 4 (abbreviations)\nChange the object I'm testing from being a ReconciliationIntro instance to being a new FileLoader instance. Point the tests at the new copy of the original caller. Note that because the private method it calls has also been copied, my tests will pass (see commit 3d573e3) [4]:\nFigure 12: New FileLoader class part 5 (abbreviations)\nNow I can call the original caller directly from the ReconciliationIntro class (see commit 77c0b14) [4]:\nFigure 13: New FileLoader class part 6 (abbreviations)\nMake the originally-private method private again, and delete the original caller. I'll delete the old test class too, as all its tests have now been duplicated in FileLoaderTests. (see commit 27f1a59) [4]:\nFigure 14: New FileLoader class part 7 (abbreviations)\n6. Move the other methods to the new FileLoader class\nNow I can move all the other methods. I'll handle them one by one, starting with the simplest and keeping an eye out for dependencies (between methods, and on any member data). I'll need to consider the following:\nDo I want to rename any methods?\nDo I want to replace any parameter lists with new objects?\nAre there any redundant parameters?\nAre any of the internal nested callees altering state? What impact does this have?\nI could inline those lower down in the chain before moving them, but if I did I'd break the tests which call them as public methods. So instead I move them on their own. I do it in the order explained below, acting on one at a time and starting with those at the end of the chain - ie the outermost leaves on the following tree:\nFigure 15: FileLoader method tree (abbreviations)\nFor each one, I use the following approach:\nCreate a copy of the method in the destination class, keeping the original in place. Make the new method public.\nCall the new method instead of the original.\nCopy any covering tests into the new test class, and make sure they test the new code.\nDelete the old method and the old tests.\nI already moved Bank_and_bank_out__ Merge_bespoke_data_with_pending_file and Bank_and_bank_out__ Add_most_recent_credit_card_direct_debits (commit 0341476 to commit 27f1a59), so now I repeat the same actions for each of the other methods (commit 7cd53f6 to commit 7ab95f2) [4]. I don't commit every tiny step this time, but I still go through the same set of steps. After each step, I make sure the code builds and the tests are passing (apart from when I deliberately make a test fail).\nI refactored some tests earlier, and I can repeat those changes for tests that follow the same pattern. For some methods the move is very simple, because they have no test coverage. This is part of why I'm doing this refactor, to make that code more easily testable.\nA note on member variables\nThe four load methods (Load_bank_and_bank_in, etc) are all using two member variables from ReconciliationIntro: _input_output and _spreadsheet_factory. So when these methods are added to FileLoader, I need to introduce these variables as members in FileLoader too, by injecting them into the constructor. _input_output is already being injected, but when I introduce _spreadsheet_factory I initially give it a default value. This is so the code will still build, and is done before I switch over to using the new methods. This way I can fix all the places that need to inject a spreadsheet factory into FileLoader at my leisure.\nSee commit ce559f2 and commit 7e86292 for the actual code changes [4], but here is a simplification focusing only on the relevant parts:\ninternal class ReconciliationIntro\n{ private readonly IInputOutput _input_output; public ReconciliationInterface Load_correct_files() { Load_bank_and_bank_in(); } public ReconciliationInterface Load_bank_and_bank_in() { var file_loader = new FileLoader(_input_output); file_loader.Load_bank_and_bank_in(); }\n} internal class FileLoader\n{ private readonly IInputOutput _input_output; public FileLoader(IInputOutput input_output) { _input_output = input_output; } public ReconciliationInterface Load_bank_and_bank_in() { _input_output.Output_line(\"Some text\"); }\n} ⇓ // Still compiles, because ISpreadsheetRepoFactory object has default value in constructor. internal class FileLoader\n{ private readonly IInputOutput _input_output;\n<span class=\"colblind-highlight\"> private readonly ISpreadsheetRepoFactory _spreadsheet_factory;</span> public FileLoader( IInputOutput input_output, <span class=\"colblind-highlight\"> ISpreadsheetRepoFactory spreadsheet_factory = null)</span> { _input_output = input_output;\n<span class=\"colblind-highlight\"> _spreadsheet_factory = spreadsheet_factory;</span> } public ReconciliationInterface Load_bank_and_bank_in() {\n<span class=\"colblind-highlight\"> var pending_file_io = new FileIO&lt;BankRecord&gt;(_spreadsheet_factory);</span> _input_output.Output_line(\"Some text\"); }\n} ⇓ // Now ReconciliationIntro can inject member vars into FileLoader and it will all work.\n// Other clients aren't injecting yet, but some time soon we'll amend them all.\n// Finally after that we can remove the default value from the FileLoader constructor. internal class ReconciliationIntro\n{ private readonly IInputOutput _input_output;\n<span class=\"colblind-highlight\"> private readonly ISpreadsheetRepoFactory <span class=\"colblind-highlight\">_spreadsheet_factory</span>;</span> public ReconciliationInterface Load_correct_files() { var file_loader = new FileLoader(_input_output, <span class=\"colblind-highlight\">_spreadsheet_factory</span>); file_loader.Load_bank_and_bank_in(); }\n}\n7. Extract more new classes A note on the order of the commits\nMy main motivation for this refactoring is to remove duplication and introduce a strategy pattern [3] for the four data types in the file loading code. This means that if you look at the commits you'll see that after extracting the FileLoader class, I moved on to other things. But when I came back to write up this article, I couldn't bear to leave the ReconciliationIntro class in its still-bloated state, so I got on with extracting the rest of the classes - starting from commit 3446a54.\nWhen adding regions at the start, I identified some Get budgeting months functionality which creates its own clear context, so I extract these methods out into a new BudgetingMonthService class. This is very quick and simple because these methods only have one public entry point (see commit 6103f0b) [4].\nReconciliationIntro is still too big, but the methods all call one another and now that I've spent more time refamiliarising myself with the code I'm not convinced my two remaining regions of User Instructions and Input and Debug Spreadsheet Operations are the best ways of dividing the remaining code. To help myself think about it, I use a spreadsheet to quickly illustrate the call hierarchy.\nFigure 16: Call hierarchy\nThis allows me to see that there are THREE self-contained areas of code, not two: User instructions, Gathering file / path info and Debug mode switching code.\nI remove the original regions (commit 4c57927) and replace them with four new regions (commit 3446a54) [4]. I rearrange the methods to fit in the new regions, and these will now translate into three new classes: Communicator, PathSetter and DebugModeSwitcher (FileLoader and BudgetingMonthService are not shown on this diagram because they have already been extracted):\nFigure 17: Identifying final ReconciliationIntro classes\nI create these new classes gradually and safely using the same principles as for BudgetingMonthService, removing the new regions once they've served their purpose (see commit 7f464a4 to commit 7e118c1).\nIt's worth noting that when extracting new classes from a larger class, I want them to be independent. For this reason I'm deliberately avoiding the anti-pattern which can sometimes arise, where extracted classes are automatically injected as a dependency into the constructor of the original class.\nThe PathSetter class turns out to be non-trivial - see commit 2921220 to commit 398539a[4]. This is due to the currently-slightly-tortuous nature of the path-setting code, something I noticed at the end of step 3. By extracting this code into a separate class and giving it its own clear context, I'm already making this code a bit better - but it will still need some attention.\nFinally, my ReconciliationIntro class is cleaner and simpler, and the original 41 methods have been reduced to three: Start, Reconciliate and Do_matching:\nFigure 18: Final ReconciliationIntro class\nRecap The reality: Most teams own problematic code\nNote that it's tempting to say, \"But your code only got into this state because you were coding alone, late at night in snatched chunks of spare time. Well-disciplined teams with amazing software engineering practices would never see their code bases get into this state.\" But most teams are not perfect, and most teams find themselves taking shortcuts because of time pressures at some time or other. Sometimes brilliant teams have to handle code written by less-fortunate teams. For whatever reasons, it is likely that most software engineers will find themselves at some point or other having to refactor code that has got out of hand.\nI confess I've been nervous about exposing my code base to the public gaze, because clearly it's far from perfect. But this is reality. Even the best coders (and I don't count myself as one of them) will likely have problematic code lurking somewhere on their hard drives.\nMy class was too large. I had developed undesirable coding habits and I wanted to stop and make things better before adding any new functionality.\nTo fix my too-large class, I took the following actions:\nRearranged methods into sensible groupings, to help identify new classes.\nAnalysed relationships between file-loading methods, so that I could work out how to create a new FileLoader class with minimum coupling with the rest of the code.\nModified the methods that were staying behind, so that they could be called by those that are moving (if necessary).\nCreated covering tests for the new FileLoader class, by creating a new FileLoaderTests class.\nCreated the new FileLoader class and moved two methods.\nMoved the other methods to the new FileLoader class.\nExtracted more new classes.\nI moved in tiny steps, and I compiled and ran the tests at every step. Now I have a much smaller class which calls functionality from several other also-smaller classes, and each one of them is easier to fit in my head.\nWhat's next?\nNote that this article ends in the middle of the refactor, so if you want to see the relevant state of the code before moving on to the next steps, you need to checkout the commit 6103f0b. Note also that I completed most of step 7 in this article after that commit (explanation here).\nAt commit 6103f0b, I've pulled the file-loading code out into the FileLoader class and have a clearer view of the main challenge. The following four methods (visible in situ here) are clearly problematic:\nLoad_bank_and_bank_in\nLoad_bank_and_bank_out\nLoad_cred_card1_and_cred_card1_in_out\nLoad_cred_card2_and_cred_card2_in_out\nThey have the following problems:\nThere is a lot of duplication - at a glance, they look identical.\nThey are way too long.\nThey create objects internally and pass them into one another in a closely inter-dependent way which is not testable.\nThese are all problems I want to solve, but before I do any more refactoring I really need some tests around those methods. That's what I'll do next. My desire is to write about it in a follow-up article, but I've learnt better than to make promises about that kind of thing, so for now it's an exercise for the reader.\nAcknowledgements\nMany thanks to the following people, who very kindly read early drafts of this article and contributed invaluable feedback and suggestions: Paula Paul, Martin Fowler, Priti Biyani, Riccardo Novaglia, Dan Terhorst-North, Kevlin Henney, Steve Freeman, Jon Skeet, Sal Freudenberg, Joe Ray, Chris Shepherd, Luke Morton, Scott Giminiani, Richard Foster, Marcos Bezerra, Sam Carrington.\nFootnotes\n1: TDD stands for Test-Driven Development, a technique to ensure that all units of code are tested, and that the tests describe the behaviour of the system. This is done by writing the tests before you write the code to make those tests pass. There's a lot more that can be said about it, but it's not the focus of this article. You can read more about it here.\n2: \"Fits In My Head\" is one of the patterns in Dan Terhorst-North's Software, Faster book (a work still in progress). He talks about the importance of being able to comprehend any chunk of code by \"fitting it in your head.\" The name came from James Lewis, and Dan describes it in this talk, but Dan tells me the concept may have originated with Alistair Jones.\n3: Refactoring to the strategy pattern: A large part of the aim of this refactoring is to enable use of the strategy pattern. The business of \"refactoring to patterns\" has a whole book devoted to it, by Joshua Kerievsky - and is worth a read if you want to know more. Indeed as Martin Fowler says, \"Many people have said they find a refactoring approach to be a better way of learning about patterns, because you see in gradual stages the interplay of problem and solution.\"\n4: Commit links: Don't feel obligated to follow the commit links! More on that in the How to read this article sidebar.\n5: Resharper is a commonly-used Visual Studio extension used for things such as code editing. However it is not free, and is being increasingly eclipsed by native Visual Studio tooling.\nSignificant Revisions\n14 April 2020: first published\nTopics\nArchitecture\nRefactoring\nAgile\nDelivery\nMicroservices\nData\nTesting\nDSL\nabout me\nAbout\nBooks\nFAQ\ncontent\nVideos\nContent Index\nBoard Games\nPhotography\nThoughtWorks\nInsights\nCareers\nProducts\nfollow\nTwitter\nRSS\n© Martin Fowler | Privacy Policy | Disclosures","cname":"重构：该类太大","ctext":"重构\n敏捷\n建筑\n关于\nThoughtWorks\n主题\n建筑\n重构\n敏捷\n交货\n微服务\n数据\n测试中\nDSL\n关于我\n关于\n图书\n常问问题\n内容\n影片\n内容索引\n棋盘游戏\n摄影\nThoughtWorks\n见解\n招贤纳士\n产品展示\n跟随\n推特\n的RSS\n内容\n问题概述为什么要重构？我该怎么做？1。 重新排列方法2。 分析文件加载方法之间的关系行动计划3。 修改保留的方法4。 为新的FileLoader类创建覆盖测试。 创建新的FileLoader类并移动两个方法。 将其他方法移至新的FileLoader类。 提取更多新类概述接下来是什么？ 侧边栏\n语言和方法\nC＃\n测试驱动的开发\n如何避免首先到达这里\n如何阅读这篇文章\n原理：始终将动作和重命名与编辑分开进行。\n缩写的方法名称\n原理：一次做一件事。 焦点！\n自动化重构\n关于成员变量的注释\n关于提交顺序的注释\n现实：大多数团队拥有有问题的代码\n重构：该类太大\n从真实（有缺陷的）代码库进行重构的示例。\n在本文中，我将从真实的代码库中进行一系列重构。 这并不是要证明完美，而是要代表现实。\n2020年4月14日\n克莱尔·苏布雷\n作家，演讲者，提问者和极限编程爱好者-克莱尔（Clare）是一名高中数学老师和顾问，拥有20年的软件工程经验。 她的使命是唤醒世界各地人们的内心怪胎，尤其是那些传统上不受鼓励的人。\n内容\n问题概述\n为什么要重构？\n我该怎么做？\n1.重新排列方法\n2.分析文件加载方法之间的关系\n行动计划\n3.修改落后的方法\n4.为新的FileLoader类创建覆盖测试\n5.创建新的FileLoader类并移动两个方法\n6.将其他方法移至新的FileLoader类\n7.提取更多新类\n概括\n下一步是什么？\n侧边栏\n语言和方法\nC＃\n测试驱动的开发\n如何避免首先到达这里\n如何阅读这篇文章\n原理：始终将动作和重命名与编辑分开进行。\n缩写的方法名称\n原理：一次做一件事。 焦点！\n自动化重构\n关于成员变量的注释\n关于提交顺序的注释\n现实：大多数团队拥有有问题的代码\n这是关于重构的故事。 这是TDD红绿重构周期中的第三项[1]，这是我们一直在做的事情，对吧？ 除非我们不这样做。\n我的代码库过于繁琐，受到重构方面的忽视，因此我一直将其重新整理。 在本文中，我将讲授一个太大的类，并将其缩小。\n语言和方法\nC＃\n我通常以适合客户，项目和手头问题的任何语言编写代码。 但是我的职业生涯大部分时间都在.Net领域，所以C＃是我的舒适地带，也是我的默认选择。 本文中的示例是用C＃编写的，但是我希望所包含的代码片段足够简单，即使您不懂该语言，也可以遵循。\n测试驱动的开发\n我是测试驱动开发（TDD）[1]的忠实拥护者，这里提供的代码大多是使用这种方法编写的。 但是我不得不承认，作为一名工程师20年之后，我至少有一半的不良习惯生涯在我身后，而且我并非总能做到正确。\n问题概述\n故事开始于无聊的家务。 我已经写了一些个人会计软件-和解。 它在命令行上工作并执行以下操作：\n加载我自己的逗号分隔数据：\n我最近的银行和信用卡交易记录。\n我预测了每月和每年的交易（基于中央电子表格中的数据）。\n任何未对帐的先前记录的数据。\n加载第三方逗号分隔的数据（来自银行和信用卡公司）。\n将第三方数据与我自己的数据进行对帐。\n将所有内容写回到中央电子表格。\n我有一些需要修复的错误以及要添加的一些功能。 但是我的典型工作流程是，在我最小的孩子上床睡觉后到深夜才到达笔记本电脑，只有很少的时间才可以上床睡觉，而且通常是上次看到代码后几周。 在这种情况下，很容易想到这样的事情：“我知道这段代码是一团糟，但是我没有时间去解决它并立即解决它……”\n显然，这并不理想。\n特别是一个类-ReconciliationIntro类-每当我看的时候都会感到头痛。 它肿胀，曲折，无法贴在我的头上[2]。 这造成了一个令人讨厌的反馈循环：“由于很难解释该代码，因此重构将比我花费更多的时间和精力，因此我会忍受更长的时间-即使这意味着我什至无法 再做一些小的更改，因为我花了很长时间才了解代码的当前状态并决定更改应该去哪里。”\n例如，我想添加处理另一张信用卡的功能。 在很多地方，我都使用了多态性和策略模式来保持每张信用卡的独特行为被整齐地封装起来。 但是ReconciliationIntro类是一个地方，由于代码的不良设计和缺乏清晰的上下文分离，如果我再添加一张信用卡，将会使本已already肿的类变得更糟。 它为四种类型的数据（“银行存款”，“银行存款”，信用卡1和信用卡2）中的每一个包含四个重复的代码路径，如果现在添加信用卡3，我将遵循相同的反模式。\n我的总体目标是通过策略模式[3]将其替换为通用代码。 但是有四个问题困扰着我：\n这一大类（ReconciliationIntro）承担了太多的责任。\n有很多私有嵌套代码，由于没有公共接口，因此很难进行单元测试。\n在ReconciliationIntro中，有一种方法做得太多。\nReconciliationIntro中有几种方法使用相同的重复模式，但细节不同。\n我计划按照上面列出的顺序解决所有这些问题。 这种准备性的重构可以使我轻松地封装每个信用卡/帐户的行为。 正如肯特·贝克（Kent Beck）所说：“轻松进行更改，然后轻松进行更改。”\n本文是关于解决上面列表中的第一个问题的：该类太大。\n为什么要重构？\n我不容易想到ReconciliationIntro类，因为它职责太多。 它最初被设计为软件的入口大厅，它所做的只是显示一些消息，然后实例化完成主要工作的类。 但是随着时间的流逝，许多其他代码也逐渐流行起来。我想使添加另一张信用卡更加容易，因此，我将把这个大类分为小类来开始。\n好处是：\n通过将方法组移到单独的类中，我将创建清晰的上下文并最小化紧密的耦合。 这意味着：\n我想进行更改或解决问题时会知道该去哪里。\n当我修改代码时，我只需要处理适合我头脑的小的孤立部分即可[2]-我将不必了解整个系统。\n状态的任何操作都只会在很小的上下文中局部发生-因此，我不必担心系统的一个区域会改变另一个区域的状态。\n如何避免首先到达这里\n我可以避免担任这个职位吗？ 当然是。 当我遇到问题区域时，我可以进行一些小的连续更改，而不必对缺乏时间感到绝望。 这是红绿重构周期重构阶段的一部分，您可以随时恢复这种习惯。\n但是值得承认的是，在压力下进行编码时，您并不总是处于合适的状态以做出正确的选择。 您的代码可以快速达到使重构感到不可逾越的程度。 在这些时候，无论您的代码处于什么状态，总是需要进行一些小的更改来逐步改善性能。\n我该怎么做？\n在我看来，重构（和编写新代码）时最重要的原则是逐步进行。 我有几个相关的目标：\n在每一步中，我都希望代码可以编译并运行测试。\n如果更改导致任何测试失败，我希望能够立即对其进行修复。 通过进行小的更改和小的提交，我可以查看是哪个更改导致测试失败，并且我只需要倒带/检查少量代码以发现问题。\n我可以跟踪自己的位置。 进行相对简单的重构非常容易，却发现它具有超出您最初意图的影响。 在这一点上，如果您不习惯于保持代码编译且每一步都通过测试，那么您会发现自己迷失在一个难以退出的兔子洞中：您的代码未编译且您的测试未完成。 即使奔跑，更不用说过去了。\n为此，我需要重构代码以使其包含在测试中。 在开始重构之前，这已经完成了，尽管值得注意的是，我将来进行重构的目的之一是使代码更具可测试性。\n推荐阅读Martin Fowler的《重构》，其中列出了一些基本的重构原理。 他还强调了每次微小的提交之后，逐步进行并构建代码/运行测试的价值。\n除了这些基本原理之外，我还将遵循下面概述的一系列逻辑步骤。\n如何阅读这篇文章\n这是一个真正的代码库，而且是一个凌乱的代码库（因此需要进行重构），因此有很多代码。 对于那些想了解更多的人，我会重复链接到代码。 但是，我故意将描述保持在高水平，并且您无需遵循这些链接。\n1.重新排列方法\n这是一个真正的代码库，而且是一个凌乱的代码库（因此需要进行重构），因此有很多代码。 对于那些想了解更多的人，我会重复链接到代码。 但是，我故意将描述保持在高水平，并且您无需遵循这些链接。...\n图1：方法重新排列区域后的ReconciliationIntro\n原理：始终将动作和重命名与编辑分开进行。\n重要的是，我需要像这样将代码作为一个单独的任务和一个单独的提交来回移动，而不用任何方式编辑代码。 重新排列方法时，产生的代码差异将包括许多已添加/已删除的代码块。 如果代码已被更改和移动，则无法轻松判断行是否已删除或移动，以及移动的行是相同还是不同。 正如丹·特霍斯特·诺斯（Dan Terhorst-North）所说，“变革应该是结构性的或行为性的，但绝不能两者都做。”\n图2：移动代码后的提交外观\n现在，我已经将我的方法归类为一组合理的上下文，现在我想将它们拉到单独的类中。 但是从哪里开始呢？ 文件加载代码包含最多的重复，并且造成最大的痛苦。 最终，我想使这段代码更加通用，但是首先，我想将其拿出来，这样我就可以不受干扰地看到它。 我将提取一个新的FileLoader类。 其他分组也将成为单独的类，但是它们将变得更加简单，因此，我将把本文的大部分重点放在文件加载代码上。\n缩写的方法名称\n从方法到酒吧再到孩子的任何事物的命名都是一个众所周知的难题。 我的冗长倾向在我的方法名称中很明显，就像在酒吧见到我时听到的冗长故事一样。 在重构之前，代码的重复意味着方法名称被用于区分上下文-这导致一些长名称。 为了避免产生巨大的图像，我在大多数图中都缩写了名称，如下所示：\nBBI：bank_and_bank_in（“ bank”和“ bank_in”代表两种不同的观点-银行的观点和我自己的观点）\nBBO：bank_and_bank_out（“ bank”和“ bank_out”与上面的“ bank”和“ bank_in”相同）\nCC1：cred_card1_and_cred_card1_in_out（“ cred_card1”和“ cred_card1_in_out”与上述“ bank”和“ bank_in”相同）\nCC2：cred_card2_and_cred_card2_in_out（与上面的“ cred_card1”相同）\nMerge_bd：Merge_bespoke_data\nBM：budgeting_months\nccds：credit_card_debits\nwpf：with_pending_file\n抄送：cred_card\nDD：direct_debits\n2.分析文件加载方法之间的关系\n到目前为止，我所要做的就是在同一个类中移动一些代码。 在提交之前，我重建了代码并运行了所有测试，但是除非笨拙，否则我希望以前的提交是微不足道的。 我需要对接下来的工作多加考虑。\n我已经使用我的区域之一来确定要拉出到新FileLoader类中的方法，但是我如何确定这将起作用？ 是否有任何隐藏的依赖项？ 我将通过画出我想移动的方法之间的关系来发现这一点。 要移动的对象用蓝色标记。\n图3：要移动的文件加载方法（缩写）\n我可以立即看到它不是严格独立的上下文：一些蓝色方法正在调出要保留在单独类中的方法（以黑色和绿色显示）。 我可以通过以下几种方法来处理此问题。 但是现在我在一个可以定义行动计划的地方。\n行动计划\n到我完成时，原始的ReconciliationIntro大类将被分解为精简版，外加五个新类，如下图所示。 请注意，区域和类之间没有一对一的映射，因为稍后在执行步骤7时，我将最终将第一个分组细化为一些更细粒度的边界。\n图4：行动计划\n我的总体目标是将这个大班细分为小班。 在上面的步骤1和2中，我使用了区域和图表来标识代码的不同区域，然后分析其中一些方法之间的关系。 这给了我足够的信息，让我开始思考如何以微小的步骤来完成这项工作。\n下面总结了生成的计划，然后在下面进行详细描述。 通过考虑如何使用尽可能小的步骤来实现此计划。 通常，我正在做的事情是进行设置，以使下一个更改尽可能小而简单。 我正在进行一些小的更改以促进更多的更改-再次遵循肯特·贝克（Kent Beck）的格言：“轻松进行更改，然后轻松进行更改”。\n根据您的情况，您可能不会遵循相同的计划，但是如果您不确定如何进行，这并不是一个不好的模板。 您的首要任务是为安全的增量更改做好准备：\n重新排列方法\n如上所述，将类中的所有方法分组为明智的分组。\n分析文件加载方法之间的关系\n如上所述，确定文件加载代码如何与ReconciliationIntro类中的其余代码连接。\n修改落后的方法\n有些方法将保留在父类中，但当前正在被正在移动的方法调用。 为了使这项工作需要进行一些修改。\n为新的FileLoader类创建覆盖测试\n测试需要覆盖新的FileLoader类。 用于移动代码的测试已经存在，但是将被移动到新的FileLoaderTests类中。\n创建新的FileLoader类并移动两个方法\n遵循微小步骤的原则，在移动其余方法之前，我将仅移动两个方法（由它调用的公共方法和私有方法）。\n将其他方法移到新的FileLoader类\n这就是令人兴奋的地方。 我感兴趣的所有文件加载代码都将最终找到新家！\n提取更多新类\n处理完文件加载代码后，我将为其他代码区域创建更多新类。\n新的FileLoader类将负责加载各种逗号分隔的数据源，并将它们合并以进行对帐。 该文件加载代码是当前大多数难题的出处，因此，这就是我将详细介绍的内容。 您可以在此处重构之前查看原始代码，但是如果您遵循该链接，您将学到的是它太大了以至于无法容纳您！ 精简后的重构版本在这里。\n因此，现在我可以继续执行该计划了：\n3.修改落后的方法\n我确定了两种方法-Set_path和Recursively_ask_for_budgeting_months-由文件加载方法调用：\n图5：文件加载方法调用的方法（缩写）\n只要这些方法与文件加载类的结合不是太紧密，我就可以\n将它们公开，以便我可以从新的FileLoader类中回调它们。\n将调用移出文件加载代码，然后移至其他本机ReconciliationIntro方法。\n我将对Recursively_ask_for_budgeting_months使用第一种方法，对Set_path使用第二种方法，这将使我处于以下情况：\n图6：移动后的文件加载方法（缩写）\n请注意，在此步骤结束时，图中标记为FileLoader方法的方法仍将位于ReconciliationIntro类中，但这将使我能够将它们移至FileLoader类，这将在下面的步骤5和步骤6中进行。\nRecursively_ask_for_budgeting_months最终将成为另一个类中的公共方法，但是现在我只想确保可以从其他地方调用它。 事实证明它已经是公开的，这样做是为了可以对其进行测试。 这本身就是代码的味道-这表明将其作为单独类的公共接口的一部分会更好。\n从文件加载代码调用的另一种方法是Set_path。 这会更改内部路径变量的值，因此我将选择选项2：我将单独调用它，并将结果数据通过参数传递到文件加载方法中。\n原理：一次做一件事。 焦点！\n在编辑Set_path的过程中，我注意到了我要进行的其他一些更改。\n首先，Set_path具有更改_path成员变量的副作用。 如果它是独立的并且刚刚返回一条新路径，那会更好。\n其次，当前在两个地方调用Set_path －在调用Create_pending_csvs之前，在事件链中位于另一个称为Set_path_and_file_names的方法中更低的位置。 如果我遵循这里涉及的不同方法的链条，那么我就会意识到它们没有被合理地调用，并且存在很多冗余。 该代码很难遵循，现在很想对其进行重构。\n但是我正在进行另一次重构，因此我在Trello板上记了笔记，并将这些更改留待以后使用。 否则，我会分心于手头的任务，并可能使代码进入一种奇怪的状态，从而无法跟踪我在做什么。 重点很重要！\n请注意，这些通常可能不会作为单独的提交保留（我可以使用微提交，然后将它们压缩为较大的提交），但是我会保持较小的提交完整以使步骤清晰明了。 我在每个步骤中编译并运行测试：\n修改调用方法（Create_pending_csvs），使其采用参数，但首先为其提供默认值（commit acc3519）[4]，以便代码仍可编译：\n私人无效Create_pending_csvs（）\n{//一些代码\n}⇓private void Create_pending_csvs（<span class =“ colblind-highlight”>字符串路径=“” </ span>）\n{//一些代码\n}\n在调用Create_pending_csvs之前，分别调用Set_path。 取生成的新_path成员变量（请参见边栏），并将其传递到Create_pending_csvs（提交c5ebc2f）[4]：\n情况1”：\n{Create_pending_csvs（）;\n}\n打破; ⇓情况“ 1”：\n{Set_path（）; Create_pending_csvs（<span class =“ colblind-highlight”> _ path </ span>）;\n}\n打破;\n从Create_pending_csvs中删除对Set_path的调用，并使用传入的值而不是成员变量（提交6df8f97）[4]：\n私人无效Create_pending_csvs（string path =“”）\n{尝试{Set_path（）; varending_csv_file_creator =新的PendingCsvFileCreator（_path）; ⇓private void Create_pending_csvs（字符串路径=“”）\n{试试{<span class =“ colblind-deleted”> Set_path（）; </ span> varending_csv_file_creator = new PendingCsvFileCreator（<span class =“ colblind-highlight”> path </ span>）;\n最后，从Create_pending_csvs参数中删除默认值-从而强制所有客户端在（commit 2be56ea）[4]中传递值。 请注意，通过按此顺序执行操作，我始终可以保持代码的编译：\n私人无效Create_pending_csvs（string path =“”）\n{//一些代码\n}⇓private void Create_pending_csvs（字符串路径<span class =“ colblind-deleted”> =“” </ span>）\n{//一些代码\n}\n4.为新的FileLoader类创建覆盖测试\n我首选的移动方法是Bank_and_bank_out_ _Merge_bespoke_data_with_pending_file。 我要做的第一件事是将所有覆盖测试复制到即将创建的FileLoader类的新测试类中。 此方法已经有一个测试-M_MergeBespokeDataWithPendingFile_ WillAddMostRecentCredCardDirectDebits-其工作是确保此方法将新的直接借记数据与“待处理”文件正确合并（该文件正在构建中以包含所有新的交易数据）。\n请注意，我只是在移动测试，而不是编写新的测试。 人们在编写代码之前就已经习惯了TDD [1]编写测试的概念，以至于他们认为您在编写代码时就需要编写新的测试。 重构时通常不是这种情况。 理想情况下，测试已经涵盖了我的功能，并且在重构时，我不会更改功能。 因此，我没有编写新的测试，而是使用现有的测试来验证功能是否仍可以按预期使用。\n这是回顾该测试的好时机：自从我写了该测试已经有一段时间了，因此我应该能够迅速发现它是否有意义。 我希望我的测试内容清晰易读-它们应作为系统行为的文档。 我注意到的第一件事是它包含一个断言方法-Assert_direct_debit_details_are_correct-其名称不足。 “正确”的解释是什么？ 我重写测试以使其更易于阅读，其中涉及很多更改。 为了使该摘要易于阅读，我将不涉及所做的更改，但是您可以在commit f090f26和6a6cece中查看它们。 [4]\n现在，我已经重构了测试，然后将其与一些关联的私有帮助器方法一起复制到新的测试类中。 请注意，尽管此测试和其他测试注定要在新的FileLoader类上运行，但它们仍将对旧的ReconciliationIntro类起作用，直到我确定我的新测试类具有所需的一切为止。 还要注意，在安全地移动所有东西之前，我的测试代码是重复的。\n自动化重构\n值得注意的是，当没有诸如Resharper [5]之类的工具时，有许多自动化的重构任务需要大量的注意。\n例如，使用Resharper，您可以快速，放心地重命名在整个大型代码库中都具有客户的方法。 但是，如果没有此工具，则可能会以不同方式处理此类更改-例如，通过创建临时包装器方法。\n我首先在与原始文件相同的文件中创建新的测试类（commit 491c795）[4]，以便可以轻松地看到要复制的内容。 然后，我可以使用Resharper [5]和Visual Studio将所有内容移到一个新文件中（提交c9317c0）[4]。\n图7：移动BBO测试\n5.创建新的FileLoader类并移动两个方法\n现在我的测试类已启动并正在运行，我可以创建新的FileLoader类。\n链上最远的方法-我的方法树中的最低叶子-是Bank_and_bank_out__ Add_most_recent_credit_card_direct_debits。 这是一个没有独立测试的私有方法（已通过公共调用方法进行了测试），因此我将移动它及其调用者（Bank_and_bank_out__ Merge_bespoke_data_with_pending_file）。 这些将是移入我的新类的前两个方法。\n同样，我将一步步走，以避免测试变红，并始终保持我的代码构建。 执行以下每个步骤之后，请确保代码已生成且测试已通过。\n这就是我开始的情况。 已经创建了FileLoaderTests类，但它仍在测试代码中，该代码仍然存在于ReconciliationIntro类中：\n图8：新的FileLoader类的第1部分（缩写）\n我首先创建一个新的FileLoader类。 我的一种文件加载方法（Bank_and_bank_out__ Add_most_recent_credit_card_direct_debits）是私有的，并且在此过程结束时也将是私有的。 它只会被将要跟随到新类中的方法调用。 它并没有单独包含在测试中，所以我可以将其复制到新类中，并在调用者移动时使其准备就绪并等待（请参见commit 0341476）[4]。 但我需要暂时将其公开：\n图9：新的FileLoader类的第2部分（缩写）\n现在，我可以在ReconciliationIntro类中创建新FileLoader类的实例，并调用其新的public方法，而不是旧的private方法。 我还可以删除旧的私有方法（请参阅commit bde2ae2）[4]：\n图10：新的FileLoader类的第3部分（缩写）\n将原始调用者复制到新类中（请参阅commit f0a5a59）[4]。 请注意，此时已复制：\n图11：新的FileLoader类的第4部分（缩写）\n将我正在测试的对象从ReconciliationIntro实例更改为新的FileLoader实例。 将测试指向原始呼叫者的新副本。 请注意，因为它调用的私有方法也已被复制，所以我的测试将通过（请参阅commit 3d573e3）[4]：\n图12：New FileLoader类的第5部分（缩写）\n现在，我可以直接从ReconciliationIntro类中调用原始调用者（请参阅commit 77c0b14）[4]：\n图13：New FileLoader类的第6部分（缩写）\n再次将原始私有方法设为私有，然后删除原始调用方。 我还将删除旧的测试类，因为它的所有测试现在都已在FileLoaderTests中进行了重复。 （参见commit 27f1a59）[4]：\n图14：New FileLoader类的第7部分（缩写）\n6.将其他方法移至新的FileLoader类\n现在，我可以移动所有其他方法。 我将一个一个地处理它们，从最简单的开始，并注意依赖关系（方法之间以及任何成员数据上）。 我需要考虑以下几点：\n我想重命名任何方法吗？\n是否要用新对象替换任何参数列表？\n有多余的参数吗？\n内部嵌套的被调用者有没有在改变状态？ 这有什么影响？\n在移动它们之前，我可以在链中将它们内联，但是如果这样做，我将破坏称为公共方法的测试。 因此，我改为自行移动它们。 我按照以下说明的顺序进行操作，一次执行一个，然后从链末尾的那些开始-即以下树的最外面的叶子：\n图15：FileLoader方法树（缩写）\n对于每一个，我使用以下方法：\n在目标类中创建方法的副本，将原始副本保留在原位。 公开新方法。\n调用新方法而不是原始方法。\n将所有覆盖测试复制到新的测试类中，并确保它们测试新代码。\n删除旧方法和旧测试。\n我已经移动了Bank_and_bank_out__ Merge_bespoke_data_with_pending_file和Bank_and_bank_out__ Add_most_recent_credit_card_direct_debits（提交0341476提交27f1a59），所以现在我对其他每个方法重复相同的操作（提交7cd53f6提交7ab95f2 [commited 7cd53f6]。 这次我并没有承诺每一个微小的步骤，但是我仍然遵循相同的步骤。 每一步骤之后，我都确保代码已构建并且测试通过（除了我故意使测试失败时）。\n我先前重构了一些测试，并且可以针对遵循相同模式的测试重复这些更改。 对于某些方法，此举非常简单，因为它们没有测试范围。 这就是为什么我要进行此重构以使该代码更易于测试的原因之一。\n关于成员变量的注释\n四种加载方法（Load_bank_and_bank_in等）都使用ReconciliationIntro中的两个成员变量：_input_output和_spreadsheet_factory。 因此，当将这些方法添加到FileLoader时，我还需要通过将它们注入到构造函数中来将这些变量作为FileLoader中的成员引入。 _input_output已经被注入，但是当我介绍_spreadsheet_factory时，最初给它一个默认值。 这样一来，代码仍然会生成，并且在我切换到使用新方法之前就已经完成了。 这样，我可以在闲暇时修复将电子表格工厂注入FileLoader所需的所有位置。\n有关实际的代码更改，请参见commit ce559f2和commit 7e86292 [4]，但这是一个简化，仅关注相关部分：\n内部类ReconciliationIntro\n{private readonly IInputOutput _input_output; 公共ReconciliationInterface Load_correct_files（）{Load_bank_and_bank_in（）; } public ReconciliationInterface Load_bank_and_bank_in（）{var file_loader = new FileLoader（_input_output）; file_loader.Load_bank_and_bank_in（）; }\n内部类FileLoader\n{private readonly IInputOutput _input_output; 公共FileLoader（IInputOutput input_output）{_input_output = input_output; } public ReconciliationInterface Load_bank_and_bank_in（）{_input_output.Output_line（“ Some text”）; }\n}⇓//仍然可以编译，因为ISpreadsheetRepoFactory对象在构造函数中具有默认值。 内部类FileLoader\n{private readonly IInputOutput _input_output;\n<span class =“ colblind-highlight”>私有只读ISpreadsheetRepoFactory _spreadsheet_factory; </ span>公共FileLoader（IInputOutput input_output，<span class =“ colblind-highlight”> ISpreadsheetRepoFactoryeBook_factory = null）</ span> {_input_output = input_output;\n<span class =“ colblind-highlight”> _spreadsheet_factory =电子表格工厂； </ span>} public ReconciliationInterface Load_bank_and_bank_in（）{\n<span class =“ colblind-highlight”> _spreadsheet_factory =电子表格工厂； </ span>} public ReconciliationInterface Load_bank_and_bank_in（）{...\n}⇓//现在，ReconciliationIntro可以将成员var注入FileLoader中，并且一切正常。\n//其他客户尚未注入，但不久以后我们将对其全部进行修改。\n//最后，我们可以从FileLoader构造函数中删除默认值。 内部类ReconciliationIntro\n{private readonly IInputOutput _input_output;\n<span class =“ colblind-highlight”>私有只读ISpreadsheetRepoFactory <span class =“ colblind-highlight”> _ spreadsheet_factory </ span>; </ span> public ReconciliationInterface Load_correct_files（）{var file_loader = new FileLoader（_input_output，<span class =“ colblind-highlight”> _ spreadsheet_factory </ span>）； file_loader.Load_bank_and_bank_in（）; }\n}\n7.提取更多新类有关提交顺序的注释\n我进行此重构的主要动机是删除重复项，并为文件加载代码中的四种数据类型引入策略模式[3]。 这意味着，如果查看提交，您将看到在提取FileLoader类之后，我继续进行其他工作。 但是当我回来写这篇文章时，我忍不住让ReconciliationIntro类仍然处于膨胀状态，因此我继续提取其余类-从commit 3446a54开始。\n在开始时添加区域时，我确定了一些“获取预算月份”功能，该功能创建了自己的清晰上下文，因此我将这些方法提取到新的BudgetingMonthService类中。 这是非常快速和简单的，因为这些方法只有一个公共入口点（请参阅提交6103f0b）[4]。\nReconciliationIntro仍然太大，但是这些方法又会相互调用，而且由于我花了更多时间重新编写代码，所以我不相信剩下的两个区域的用户指令，输入和调试电子表格操作是最好的方法 划分剩余的代码。 为了帮助自己考虑一下，我使用电子表格来快速说明呼叫层次。\n图16：呼叫层次结构\n这使我看到有三个独立的代码区域，而不是两个：用户指令，收集文件/路径信息和调试模式切换代码。\n我删除了原始区域（提交4c57927），并用四个新区域（提交3446a54）替换了它们[4]。 我重新排列了适合新区域的方法，这些方法现在将转换为三个新类：Communicator，PathSetter和DebugModeSwitcher（该文件图中未显示FileLoader和BudgetingMonthService，因为它们已被提取）：\n图17：确定最终的ReconciliationIntro类\n我将使用与BudgetingMonthService相同的原则逐步安全地创建这些新类，并在新区域达到其目的后将其删除（请参阅commit 7f464a4提交7e118c1）。\n值得注意的是，从更大的类中提取新类时，我希望它们是独立的。 因此，我特意避免有时会出现的反模式，在这种情况下，提取的类将作为依赖项自动注入到原始类的构造函数中。\n事实证明PathSetter类很简单-请参阅commit 2921220来提交398539a [4]。 这是由于路径设置代码当前有点曲折，这是我在第3步结束时注意到的。通过将代码提取到一个单独的类中并为其提供清晰的上下文，我已经在做这个了 代码要好一些-但仍然需要注意。\n最后，我的ReconciliationIntro类更简洁，更简单，原始的41种方法已减少为三种：Start，Reconciliate和Do_matching：\n图18：最终对帐简介类\n回顾现实：大多数团队拥有有问题的代码\n请注意，这很容易说：“但是您的代码只进入了这种状态，因为您是在深夜的空余时间中独自进行编码的。训练有素的团队具有出色的软件工程实践，他们的代码库永远都不会进入此状态。 州。” 但是大多数团队都不是完美的，并且大多数团队由于某些时间的压力而发现自己走捷径。 有时，优秀的团队必须处理不太幸运的团队编写的代码。 无论出于何种原因，大多数软件工程师很可能会在某个时候发现自己或其他人必须重构失控的代码。\n我承认，对于将我的代码库暴露给公众的目光，我一直感到紧张，因为显然这还远远不够完美。 但这是现实。 即使是最好的编码器（而且我也不认为自己是其中之一）可能会在他们的硬盘驱动器上潜伏着一些有问题的代码。\n我的课太大了。 我养成了不良的编码习惯，我想在添加任何新功能之前先停下来并做得更好。\n为了解决班级过大的问题，我采取了以下措施：\n将方法重新排列为明智的分组，以帮助识别新的类。\n分析了文件加载方法之间的关系，因此我可以弄清楚如何创建一个新的FileLoader类，并与其余代码保持最小的耦合。\n修改了滞后的方法，以便正在移动的方法可以调用它们（如有必要）。\n通过创建新的FileLoaderTests类，为新的FileLoader类创建了覆盖测试。\n创建了新的FileLoader类，并移动了两个方法。\n将其他方法移至新的FileLoader类。\n提取了更多新类。\n我迈出了很小的一步，并且在每一步都编译并运行了测试。 现在，我有一个较小的类，它从其他几个较小的类中调用功能，并且每个小类都更容易适应我的脑海。\n下一步是什么？\n请注意，本文在重构的中间结束，因此，如果您想在继续下一步之前查看代码的相关状态，则需要检出提交6103f0b。 还要注意，在该提交之后，我完成了本文第7步的大部分操作（在此进行解释）。\n在提交6103f0b时，我已将文件加载代码提取到FileLoader类中，并对主要挑战有了更清晰的了解。 以下四种方法（在此处可见）显然存在问题：\nLoad_bank_and_bank_in\nLoad_bank_and_bank_out\nLoad_cred_card1_and_cred_card1_in_out\nLoad_cred_card2_and_cred_card2_in_out\n他们有以下问题：\n重复很多-乍一看，它们看起来一样。\n他们太长了。\n它们在内部创建对象，并以相互依赖的方式将它们彼此传递，这是不可测试的。\n这些都是我要解决的问题，但是在进行任何重构之前，我确实需要围绕这些方法进行一些测试。 那就是我接下来要做的。 我的愿望是在后续文章中进行介绍，但是我学到的东西比对这类事情做出承诺要好得多，所以现在对读者来说这是一种练习。\n致谢\n非常感谢以下人员，他们非常友好地阅读了本文的初稿并提供了宝贵的反馈和建议：宝拉·保罗，马丁·福勒，普里蒂·比亚妮，里卡多·诺瓦利亚，丹·泰霍尔斯特·诺斯，凯夫琳·汉尼，史蒂夫·弗里曼，乔恩·斯凯特，萨尔 Freudenberg，Joe Ray，Chris Shepherd，Luke Morton，Scott Giminiani，Richard Foster，Marcos Bezerra，Sam Carrington。\n脚注\n1：TDD代表“测试驱动开发”，这是一种确保测试所有代码单元并确保测试描述系统行为的技术。 这是通过在编写代码以使这些测试通过之前编写测试来完成的。 关于它还有很多可以说的，但这不是本文的重点。 你可以在这里读更多关于它的内容。\n2：“ Fits In My Head”是Dan Terhorst-North的《 Faster》一书中的一种模式（尚在进行中）。 他谈到了通过“使代码适合您的头脑”来理解任何代码块的重要性。 这个名字来自詹姆斯·刘易斯（James Lewis），丹（Dan）在本次演讲中对此进行了描述，但丹（Dan）告诉我，这个概念可能起源于阿利斯泰尔·琼斯（Alistair Jones）。\n3：重构为策略模式：重构的很大一部分目标是启用策略模式的使用。 约书亚·凯列夫斯基（Joshua Kerievsky）专门从事“重构模式”的业务，如果您想了解更多的话，则值得一读。 确实如马丁·福勒（Martin Fowler）所说，“许多人已经说过，他们发现重构方法是学习模式的更好方法，因为您逐渐看到了问题与解决方案之间的相互作用。”\n4：提交链接：不要认为必须遵循提交链接！ 有关如何阅读本文侧栏中的更多内容。\n5：Resharper是常用的Visual Studio扩展，用于代码编辑之类的事情。 但是，它不是免费的，并且越来越被本机Visual Studio工具所取代。\n重大修订\n2020年4月14日：首次发布\n主题\n建筑\n重构\n敏捷\n交货\n微服务\n数据\n测试中\nDSL\n关于我\n关于\n图书\n常问问题\n内容\n影片\n内容索引\n棋盘游戏\n摄影\nThoughtWorks\n见解\n招贤纳士\n产品展示\n跟随\n推特\n的RSS\n©马丁·福勒| 隐私政策| 披露事项\n"}

{"l":"https://enterprisecraftsmanship.com/posts/when-to-mock/","n":"When to mock","html":"<div class=\"sumo-form-wrapper welcome-mat-popup\"><div class=\"welcome-mat-popup-content sumome-wysiwyg-responsive-format-default\" style=\"top: 0px;\"><div class=\"sumome-react-wysiwyg-grid\"><div class=\"sumome-react-wysiwyg-popup-animation-group\"><span><div class=\"sumome-animated-undefined sumome-react-wysiwyg-popup-container sumome-react-wysiwyg-welcome-mat sumome-react-wysiwyg-is-resizing\" style=\"width: 0px; height: 0px;\"><link href=\"https://fonts.googleapis.com/css?family=Lato:900,900italic,800,800italic,700,700italic,600,600italic,500,500italic,400,400italic,300,300italic,200,200italic,100,100italic\" rel=\"stylesheet\" type=\"text/css\"><div class=\"sumome-react-wysiwyg-component sumome-react-wysiwyg-outside-horizontal-resize-handles sumome-react-wysiwyg-outside-vertical-resize-handles sumome-react-wysiwyg-welcome-mat-gridRow sumome-react-wysiwyg-gridRow\" style=\"left: 0px; top: 0px; width: 0px; height: 0px; position: absolute;\"><div class=\"sumome-react-wysiwyg-move-handle sumome-react-wysiwyg-component-is-drag-disabled\" style=\"size: 4px; height: 100%;\"><div class=\"sumome-wysiwyg-gridRow-contents\" style=\"position: absolute; top: 0px; left: 0px; bottom: 0px; right: 0px;\"><div class=\"sumome-react-wysiwyg-component sumome-react-wysiwyg-outside-horizontal-resize-handles sumome-react-wysiwyg-outside-vertical-resize-handles sumome-react-wysiwyg-welcome-mat-gridColumn sumome-react-wysiwyg-gridColumn sumome-gridColumn-small-12\" style=\"left: 0px; top: 0px; width: 0px; height: 0px; position: absolute;\"><div class=\"sumome-react-wysiwyg-move-handle sumome-react-wysiwyg-component-is-drag-disabled\" style=\"size: 4px; height: 100%;\"><div class=\"sumome-wysiwyg-gridColumn-contents sumome-react-wysiwyg-content-align-center\" style=\"position: absolute; top: 0px; left: 0px; bottom: 0px; right: 0px;\"><div class=\"sumome-react-wysiwyg-component sumome-react-wysiwyg-welcome-mat-scaledStage sumome-react-wysiwyg-scaledStage\" style=\"left: 0px; top: 0px; width: 500px; height: 500px; position: absolute; transform: scale(1.2);\"><div class=\"sumome-react-wysiwyg-move-handle sumome-react-wysiwyg-component-is-drag-disabled\" style=\"size: 6px; height: 100%;\"><div class=\"sumome-wysiwyg-scaledStage-contents\" style=\"width: 500px; height: 500px;\"><div class=\"sumome-react-wysiwyg-component sumome-react-wysiwyg-welcome-mat-button sumome-react-wysiwyg-button\" style=\"left: 61px; top: 250px; width: 185px; height: 36px; position: absolute;\"><div class=\"sumome-react-wysiwyg-move-handle\" style=\"size: 24px; height: 100%;\"><div style=\"padding: 0px; margin: 0px; display: block; width: 100%; height: 100%; position: relative; overflow: hidden; z-index: 0; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px; border-color: rgb(0, 0, 0); border-style: solid; border-radius: 4px; border-width: 0px;\"><button style=\"color: rgb(255, 255, 255); background-color: rgba(47, 141, 123, 0.75); font-family: Lato, sans-serif; font-weight: 400; font-style: normal; font-size: 16px; line-height: 1.5; text-shadow: rgba(0, 0, 0, 0) 0px 0px 0px; padding: 0px; margin: 0px; display: block; width: 100%; height: 100%; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px inset; cursor: pointer;\">I'm In!</button></div></div></div><div class=\"sumome-react-wysiwyg-component sumome-react-wysiwyg-welcome-mat-text sumome-react-wysiwyg-text\" style=\"left: 0px; top: 93px; width: 500px; position: absolute;\"><div class=\"sumome-react-wysiwyg-move-handle\" style=\"size: 25px; height: 100%;\"><div role=\"button\" tabindex=\"0\"><p style=\"color: rgb(46, 54, 57); background-color: rgba(0, 0, 0, 0); font-family: Lato, sans-serif; font-weight: 700; font-style: normal; font-size: 28px; text-align: center; border-width: 0px; border-color: rgb(0, 0, 0); border-style: solid; border-radius: 0px; line-height: 1; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px, rgba(0, 0, 0, 0) 0px 0px 0px inset; text-shadow: rgba(0, 0, 0, 0) 0px 0px 0px; padding: 0px; margin: 0px; letter-spacing: normal;\">5 Unit Testing Mistakes</p></div></div></div><div class=\"sumome-react-wysiwyg-component sumome-react-wysiwyg-welcome-mat-text sumome-react-wysiwyg-text\" style=\"left: 0px; top: 139px; width: 500px; position: absolute;\"><div class=\"sumome-react-wysiwyg-move-handle\" style=\"size: 25px; height: 100%;\"><div role=\"button\" tabindex=\"0\"><p style=\"color: rgb(94, 94, 94); background-color: rgba(0, 0, 0, 0); font-family: Lato, sans-serif; font-weight: 400; font-style: normal; font-size: 18px; text-align: center; border-width: 0px; border-color: rgb(0, 0, 0); border-style: solid; border-radius: 0px; line-height: 1.5; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px, rgba(0, 0, 0, 0) 0px 0px 0px inset; text-shadow: rgba(0, 0, 0, 0) 0px 0px 0px; padding: 0px; margin: 0px; letter-spacing: normal;\">Take the free 5-day class</p></div></div></div><div class=\"sumome-react-wysiwyg-component sumome-react-wysiwyg-welcome-mat-textField sumome-react-wysiwyg-textField\" style=\"left: 60px; top: 186px; width: 380px; height: 40px; position: absolute;\"><div class=\"sumome-react-wysiwyg-move-handle\" style=\"size: 29px; height: 100%;\"><div><div></div><input type=\"text\" value=\"\" name=\"email\" spellcheck=\"false\" placeholder=\"Enter your best email\" autocomplete=\"off\" style=\"color: rgb(0, 0, 0); background-color: rgb(255, 255, 255); font-family: Lato, sans-serif; font-weight: 400; font-style: normal; font-size: 14px; text-align: center; border-width: 1px; border-color: rgb(204, 204, 204); border-style: solid; border-radius: 3px; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px, rgba(0, 0, 0, 0) 0px 0px 0px inset; text-shadow: rgba(0, 0, 0, 0) 0px 0px 0px; padding: 0px 14px; margin: 0px; display: block; width: 100%; max-height: 52px; height: 40px; transition: none 0s ease 0s;\"></div></div></div><div class=\"sumome-react-wysiwyg-component sumome-react-wysiwyg-welcome-mat-button sumome-react-wysiwyg-button\" style=\"left: 255px; top: 250px; width: 185px; height: 36px; position: absolute;\"><div class=\"sumome-react-wysiwyg-move-handle\" style=\"size: 24px; height: 100%;\"><div style=\"padding: 0px; margin: 0px; display: block; width: 100%; height: 100%; position: relative; overflow: hidden; z-index: 0; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px; border-color: rgb(0, 0, 0); border-style: solid; border-radius: 4px; border-width: 0px;\"><button style=\"color: rgb(255, 255, 255); background-color: rgb(155, 155, 155); font-family: Lato, sans-serif; font-weight: 400; font-style: normal; font-size: 16px; line-height: 1.5; text-shadow: rgba(0, 0, 0, 0) 0px 0px 0px; padding: 0px; margin: 0px; display: block; width: 100%; height: 100%; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px inset; cursor: pointer;\">No Thanks</button></div></div></div><div class=\"sumome-react-wysiwyg-component sumome-react-wysiwyg-close-button sumome-react-wysiwyg-welcome-mat-image sumome-react-wysiwyg-image\" style=\"left: 234px; top: 440px; width: 32px; height: 32px; position: absolute;\"><div class=\"sumome-react-wysiwyg-move-handle\" style=\"size: 18px; height: 100%;\"><div style=\"position: relative; width: 100%; height: 100%; overflow: hidden; z-index: 0; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px; border-color: rgb(0, 0, 0); border-style: solid; border-radius: 0px; border-width: 0px; cursor: pointer;\"><div class=\"sumome-react-svg-image-container\" style=\"background-color: rgba(255, 255, 255, 0); fill: rgb(247, 80, 115); padding: 0px; margin: 0px; display: block; position: absolute; left: 0px; top: 0px; width: 100%; height: 100%; background-size: cover; background-position: center center; background-repeat: no-repeat;\"><svg xmlns=\"http://www.w3.org/2000/svg\" id=\"Layer_1\" data-name=\"Layer 1\" viewBox=\"0 0 46 46\" preserveAspectRatio=\"none\" style=\"height: 100%; width: 100%; position: absolute; top: 0; left: 0;\"><title>close</title><path d=\"M23,32a2,2,0,0,1-1.41-.59l-10.5-10.5a2,2,0,0,1,2.83-2.83L23,27.17l9.09-9.09a2,2,0,0,1,2.83,2.83l-10.5,10.5A2,2,0,0,1,23,32Z\"></path><path d=\"M23,2A21,21,0,1,1,2,23,21,21,0,0,1,23,2m0-2A23,23,0,1,0,46,23,23,23,0,0,0,23,0Z\"></path></svg></div><div style=\"position: absolute; top: 0px; left: 0px; bottom: 0px; right: 0px; box-shadow: rgba(0, 0, 0, 0) 0px 0px 0px inset;\"></div></div></div></div></div></div></div><div class=\"sumome-react-wysiwyg-component sumome-react-wysiwyg-welcome-mat-background sumome-react-wysiwyg-background\" style=\"left: 0px; top: 0px; width: 100%; height: 100%; position: absolute;\"><div class=\"sumome-react-wysiwyg-move-handle\" style=\"size: 15px; height: 100%;\"><div style=\"position: relative; width: 100%; height: 100%; overflow: hidden; z-index: 0; box-shadow: rgb(252, 248, 245) 0px 0px 0px; border-color: rgb(255, 255, 255); border-style: solid; border-width: 8px 0px 0px;\"><div style=\"background-color: rgb(252, 248, 245); fill: rgb(0, 0, 0); padding: 0px; margin: 0px; display: block; background-image: url(&quot;//media.sumo.com/b5e7e9cea65ab0a65984f90679f4006f5de6277e0e46ee9e4fafbf4a3396d5eb&quot;); position: absolute; left: 0px; top: 0px; width: 100%; height: 100%; background-size: cover; background-position: center center; background-repeat: no-repeat;\"></div><div style=\"position: absolute; top: 0px; left: 0px; bottom: 0px; right: 0px; box-shadow: rgb(252, 248, 245) 0px 0px 0px inset;\"></div></div></div></div></div></div></div></div></div></div></div></span></div></div></div></div>\n    \t\t<nav class=\"nav\">\n\t\t\t<div class=\"nav-container\">\n\t\t\t\t<a href=\"/\">\n\t\t\t\t\t<h2 class=\"nav-title\">Enterprise Craftsmanship</h2>\n\t\t\t\t</a>\n\t\t\t\t<ul>\n    <li><a href=\"/posts\">Blog</a></li>\n    <li><a href=\"/book\">Unit Testing Book</a></li>\n    <li><a href=\"/online-training\">Online Courses</a></li>\n    <li><a href=\"/about\">About</a></li>\n    <li><a href=\"/archives\">Archives</a></li>\n</ul>\n\t\t\t</div>\n\t\t</nav>\n\n    <div class=\"container\">\n\t  \n\t  <div class=\"row\">\n\t    <div class=\"col-md-9 mainbar\">\n          \n\n<main>\n\t<div class=\"post\">\n\t\t<h1 class=\"post-title\">When to Mock</h1>\n<div class=\"post-line\"></div>\n\n\t\t<div class=\"post-info\">\n\t<time datetime=\"2020-04-15 00:00:00 +0000 UTC\">April 15, 2020</time>\n</div>\n\n\n\t\t<div class=\"paragraph\">\n<p>The use of mocks in unit testing is a controversial topic (maybe less so now than several years ago). I remember how, throughout my programming career, I went from mocking almost every dependency, to the \"no-mocks\" policy, and then to \"only mock external dependencies\".</p>\n</div>\n<div class=\"paragraph\">\n<p>None of this practices are good enough. In this article, I’ll show you which dependencies to mock, and which to use as is in your tests.</p>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_what_is_a_mock\">What is a mock?</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Before jumping to the topic of when to mock, let’s discuss what a mock is.</p>\n</div>\n<div class=\"sidebarblock\">\n<div class=\"content\">\n<div class=\"title\">Mock vs test double</div>\n<div class=\"paragraph\">\n<p>People often use the terms <em>test double</em> and <em>mock</em> as synonyms, but technically, they are not:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>A <strong>test double</strong> is an overarching term that describes all kinds of non-production-ready, fake dependencies in tests. Such a dependency looks and behaves like its release-intended counterpart but is actually a simplified version that reduces complexity and facilitates testing.</p>\n<div class=\"paragraph\">\n<p>This term was introduced by Gerard Meszaros in his book <a href=\"https://www.amazon.com/xUnit-Test-Patterns-Refactoring-Code/dp/0131495054\">xUnit Test Patterns: Refactoring Test Code</a>. The name itself comes from the notion of a stunt double in movies.</p>\n</div>\n</li>\n<li>\n<p>A <strong>mock</strong> is just one kind of such dependencies.</p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>According to Gerard Meszaros, there are 5 types of test doubles:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Dummy</p>\n</li>\n<li>\n<p>Stub</p>\n</li>\n<li>\n<p>Spy</p>\n</li>\n<li>\n<p>Mock</p>\n</li>\n<li>\n<p>Fake</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>Such a variety may look intimidating, but in reality, they can all be grouped together into just two types: mocks and stubs.</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/2020/2020-04-13-mocks-and-stubs.png\" alt=\"2020 04 13 mocks and stubs\">\n</div>\n<div class=\"title\">All variations of test doubles can be categorized into two types: mocks and stubs</div>\n</div>\n<div class=\"paragraph\">\n<p>The difference between these two types boils down to the following:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Mocks help to emulate and examine <strong>outcoming</strong> interactions. These interactions are calls the system under test (SUT) makes to its dependencies to change their state.</p>\n</li>\n<li>\n<p>Stubs help to emulate <strong>incoming</strong> interactions. These interactions are calls the SUT makes to its dependencies to get input data.</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>For example, sending an email is an outcoming interaction: that interaction results in a side effect in the SMTP server. A test double emulating such an interaction is a mock.</p>\n</div>\n<div class=\"paragraph\">\n<p>Retrieving data from the database is an incoming interaction — it doesn’t result in a side effect. The corresponding test double is a stub.</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/2020/2020-04-13-incoming-outcoming.png\" alt=\"2020 04 13 incoming outcoming\">\n</div>\n<div class=\"title\">Mocks are for outcoming interaction; stubs — for incoming</div>\n</div>\n<div class=\"paragraph\">\n<p>All other differences between the five types of test doubles are insignificant implementation details:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><strong>Spies</strong> serve the same role as mocks. The distinction is that spies are written manually, whereas mocks are created with the help of a mocking framework. Sometimes people refer to spies as <strong>handwritten mocks</strong>.</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>On the other hand, the difference between stubs, dummies, and fakes is in how intelligent they are:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>A <strong>dummy</strong> is a simple, hard-coded value such as a <code>null</code> value or a made-up string. It’s used to satisfy the SUT’s method signature and doesn’t participate in producing the final outcome.</p>\n</li>\n<li>\n<p>A <strong>stub</strong> is more sophisticated. It’s a fully fledged dependency that you configure to return different values for different scenarios.</p>\n</li>\n<li>\n<p>A <strong>fake</strong> is the same as a stub for most purposes. The difference is in the rationale for its creation: a fake is usually implemented to replace a dependency that doesn’t yet exist.</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>Notice the difference between mocks and stubs (aside from outcoming versus incoming interactions). Mocks help to <strong>emulate and examine</strong> interactions between the SUT and its dependencies, while stubs only help to <strong>emulate</strong> those interactions. This is an important distinction. You will see why shortly.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_mock_the_tool_vs_mock_the_test_double\">Mock-the-tool vs. mock-the-test-double</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>The term <em>mock</em> is overloaded and can mean different things in different circumstances. I mentioned already that people often use this term to mean any test double, whereas mocks are only a subset of test doubles.</p>\n</div>\n<div class=\"paragraph\">\n<p>But there’s another meaning for the term <em>mock</em>. You can refer to the classes from mocking libraries as mocks, too. These classes help you create actual mocks, but they themselves are not mocks per se:</p>\n</div>\n<div class=\"paragraph\">\n\n\n\n\n\n\n<div class=\"highlight\"><pre class=\"chroma\"><code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"na\">[Fact]</span>\n<span class=\"k\">public</span> <span class=\"k\">void</span> <span class=\"n\">Sending_a_greetings_email</span><span class=\"p\">()</span>\n<span class=\"p\">{</span>\n    <span class=\"c1\">// Using a mock-the-tool to create a mock-the-test-double\n</span><span class=\"c1\"></span>    <span class=\"kt\">var</span> <span class=\"n\">mock</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IEmailGateway</span><span class=\"p\">&gt;();</span>\n    <span class=\"kt\">var</span> <span class=\"n\">sut</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Controller</span><span class=\"p\">(</span><span class=\"n\">mock</span><span class=\"p\">.</span><span class=\"n\">Object</span><span class=\"p\">);</span>\n\n    <span class=\"n\">sut</span><span class=\"p\">.</span><span class=\"n\">GreetUser</span><span class=\"p\">(</span><span class=\"s\">\"user@email.com\"</span><span class=\"p\">);</span>\n\n    <span class=\"c1\">// Examining the call from the SUT to the test double\n</span><span class=\"c1\"></span>    <span class=\"n\">mock</span><span class=\"p\">.</span><span class=\"n\">Verify</span><span class=\"p\">(</span>\n        <span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">SendGreetingsEmail</span><span class=\"p\">(</span><span class=\"s\">\"user@email.com\"</span><span class=\"p\">),</span>\n        <span class=\"n\">Times</span><span class=\"p\">.</span><span class=\"n\">Once</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n</div>\n<div class=\"paragraph\">\n<p>This test uses the <code>Mock</code> class from the <a href=\"https://github.com/moq/moq4\">Moq mocking library</a>. This class is a tool that enables you to create a test double — a mock. In other words, the class <code>Mock</code> (or <code>Mock&lt;IEmailGateway&gt;</code>) is a <em>mock-the-tool</em>, while the instance of that class, <code>mock</code>, is a <em>mock-the-test-double</em>.</p>\n</div>\n<div class=\"paragraph\">\n<p>It’s important not to conflate a mock-the-tool with a mock-the-test-double because you can use a mock-the-tool to create both types of test doubles: mocks and stubs.</p>\n</div>\n<div class=\"paragraph\">\n<p>Here’s another example of a test that uses the <code>Mock</code> class. The instance of that class is a stub, not mock:</p>\n</div>\n<div class=\"paragraph\">\n\n\n\n\n\n\n<div class=\"highlight\"><pre class=\"chroma\"><code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"na\">[Fact]</span>\n<span class=\"k\">public</span> <span class=\"k\">void</span> <span class=\"n\">Creating_a_report</span><span class=\"p\">()</span>\n<span class=\"p\">{</span>\n    <span class=\"c1\">// Using a mock-the-tool to create a stub\n</span><span class=\"c1\"></span>    <span class=\"kt\">var</span> <span class=\"n\">stub</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IDatabase</span><span class=\"p\">&gt;();</span>\n    <span class=\"c1\">// Setting up a canned answer\n</span><span class=\"c1\"></span>    <span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Setup</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">GetNumberOfUsers</span><span class=\"p\">()).</span><span class=\"n\">Returns</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">);</span>\n    <span class=\"kt\">var</span> <span class=\"n\">sut</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Controller</span><span class=\"p\">(</span><span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Object</span><span class=\"p\">);</span>\n\n    <span class=\"n\">Report</span> <span class=\"n\">report</span> <span class=\"p\">=</span> <span class=\"n\">sut</span><span class=\"p\">.</span><span class=\"n\">CreateReport</span><span class=\"p\">();</span>\n\n    <span class=\"n\">Assert</span><span class=\"p\">.</span><span class=\"n\">Equal</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">,</span> <span class=\"n\">report</span><span class=\"p\">.</span><span class=\"n\">NumberOfUsers</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n</div>\n<div class=\"paragraph\">\n<p>This test double emulates an incoming interaction — a call that provides the SUT with input data.</p>\n</div>\n<div class=\"paragraph\">\n<p>On the other hand, in the previous example, the call to <code>SendGreetingsEmail()</code> is an outcoming interaction. Its sole purpose is to incur a side effect — send an email.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_don_t_assert_interactions_with_stubs\">Don’t assert interactions with stubs</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>As I mentioned above, mocks help to <strong>emulate and examine</strong> outcoming interactions between the SUT and its dependencies, while stubs only help to <strong>emulate</strong> incoming interactions, <strong><em>not</em></strong> examine them.</p>\n</div>\n<div class=\"paragraph\">\n<p>The difference between the two stems from this guideline: <mark>you should never assert interactions with stubs</mark>. A call from the SUT to a stub is not part of the end result the SUT produces. Such a call is only a means to produce the end result; it’s an implementation detail. Asserting interactions with stubs is a common anti-pattern that leads to brittle tests.</p>\n</div>\n<div class=\"paragraph\">\n<p>The only way to avoid test brittleness is to make those tests verify the end result (which, ideally, should be meaningful to a non-programmer), not implementation details.</p>\n</div>\n<div class=\"paragraph\">\n<p>In the above examples, the check</p>\n</div>\n<div class=\"paragraph\">\n\n\n\n\n\n\n<div class=\"highlight\"><pre class=\"chroma\"><code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"n\">mock</span><span class=\"p\">.</span><span class=\"n\">Verify</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">SendGreetingsEmail</span><span class=\"p\">(</span><span class=\"s\">\"user@email.com\"</span><span class=\"p\">))</span>\n</code></pre></div>\n\n</div>\n<div class=\"paragraph\">\n<p>corresponds to an actual outcome, and that outcome is meaningful to a domain expert: sending a greetings email is something business people would want the system to do.</p>\n</div>\n<div class=\"paragraph\">\n<p>At the same time, the call to <code>GetNumberOfUsers()</code> is not an outcome at all. It’s an internal implementation detail regarding how the SUT gathers data necessary for the report creation. Therefore, asserting this call would lead to test fragility. It doesn’t matter how the SUT generates the end result, as long as that result is correct.</p>\n</div>\n<div class=\"paragraph\">\n<p>Here’s an example of such a fragile test:</p>\n</div>\n<div class=\"paragraph\">\n\n\n\n\n\n\n<div class=\"highlight\"><pre class=\"chroma\"><code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"na\">[Fact]</span>\n<span class=\"k\">public</span> <span class=\"k\">void</span> <span class=\"n\">Creating_a_report</span><span class=\"p\">()</span>\n<span class=\"p\">{</span>\n    <span class=\"kt\">var</span> <span class=\"n\">stub</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IDatabase</span><span class=\"p\">&gt;();</span>\n    <span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Setup</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">GetNumberOfUsers</span><span class=\"p\">()).</span><span class=\"n\">Returns</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">);</span>\n    <span class=\"kt\">var</span> <span class=\"n\">sut</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Controller</span><span class=\"p\">(</span><span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Object</span><span class=\"p\">);</span>\n\n    <span class=\"n\">Report</span> <span class=\"n\">report</span> <span class=\"p\">=</span> <span class=\"n\">sut</span><span class=\"p\">.</span><span class=\"n\">CreateReport</span><span class=\"p\">();</span>\n\n    <span class=\"n\">Assert</span><span class=\"p\">.</span><span class=\"n\">Equal</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">,</span> <span class=\"n\">report</span><span class=\"p\">.</span><span class=\"n\">NumberOfUsers</span><span class=\"p\">);</span>\n    <span class=\"c1\">// Asserting an interaction with a stub\n</span><span class=\"c1\"></span>    <span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Verify</span><span class=\"p\">(</span>\n        <span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">GetNumberOfUsers</span><span class=\"p\">(),</span>\n        <span class=\"n\">Times</span><span class=\"p\">.</span><span class=\"n\">Once</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n</div>\n<div class=\"paragraph\">\n<p>This practice of verifying things that aren’t part of the end result is also called <strong>overspecification</strong>. Most commonly, overspecification takes place when examining interactions. Checking for interactions with stubs is a flaw that’s quite easy to spot because tests shouldn’t check for <strong><em>any</em></strong> interactions with stubs.</p>\n</div>\n<div class=\"paragraph\">\n<p>Mocks are a more complicated subject: not all uses of mocks lead to test fragility, but a lot of them do. You’ll see why shortly.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_using_mocks_and_stubs_together\">Using mocks and stubs together</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Sometimes you need to create a test double that exhibits the properties of both a mock and a stub:</p>\n</div>\n<div class=\"paragraph\">\n\n\n\n\n\n\n<div class=\"highlight\"><pre class=\"chroma\"><code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"na\">[Fact]</span>\n<span class=\"k\">public</span> <span class=\"k\">void</span> <span class=\"n\">Purchase_fails_when_not_enough_inventory</span><span class=\"p\">()</span>\n<span class=\"p\">{</span>\n    <span class=\"kt\">var</span> <span class=\"n\">storeMock</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IStore</span><span class=\"p\">&gt;();</span>\n    <span class=\"c1\">// Setting up a canned answer\n</span><span class=\"c1\"></span>    <span class=\"n\">storeMock</span>\n        <span class=\"p\">.</span><span class=\"n\">Setup</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">HasEnoughInventory</span><span class=\"p\">(</span><span class=\"n\">Product</span><span class=\"p\">.</span><span class=\"n\">Shampoo</span><span class=\"p\">,</span> <span class=\"m\">5</span><span class=\"p\">))</span>\n        <span class=\"p\">.</span><span class=\"n\">Returns</span><span class=\"p\">(</span><span class=\"k\">false</span><span class=\"p\">);</span>\n    <span class=\"kt\">var</span> <span class=\"n\">sut</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Customer</span><span class=\"p\">();</span>\n\n    <span class=\"kt\">bool</span> <span class=\"n\">success</span> <span class=\"p\">=</span> <span class=\"n\">sut</span><span class=\"p\">.</span><span class=\"n\">Purchase</span><span class=\"p\">(</span><span class=\"n\">storeMock</span><span class=\"p\">.</span><span class=\"n\">Object</span><span class=\"p\">,</span> <span class=\"n\">Product</span><span class=\"p\">.</span><span class=\"n\">Shampoo</span><span class=\"p\">,</span> <span class=\"m\">5</span><span class=\"p\">);</span>\n\n    <span class=\"n\">Assert</span><span class=\"p\">.</span><span class=\"n\">False</span><span class=\"p\">(</span><span class=\"n\">success</span><span class=\"p\">);</span>\n    <span class=\"c1\">// Examining a call from the SUT to the mock\n</span><span class=\"c1\"></span>    <span class=\"n\">storeMock</span><span class=\"p\">.</span><span class=\"n\">Verify</span><span class=\"p\">(</span>\n        <span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">RemoveInventory</span><span class=\"p\">(</span><span class=\"n\">Product</span><span class=\"p\">.</span><span class=\"n\">Shampoo</span><span class=\"p\">,</span> <span class=\"m\">5</span><span class=\"p\">),</span>\n        <span class=\"n\">Times</span><span class=\"p\">.</span><span class=\"n\">Never</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n\n</div>\n<div class=\"paragraph\">\n<p>This test uses <code>storeMock</code> for two purposes: it returns a canned answer and verifies a method call made by the SUT.</p>\n</div>\n<div class=\"paragraph\">\n<p>Notice, though, that these are two different methods: the test sets up the answer from <code>HasEnoughInventory()</code> but then verifies the call to <code>RemoveInventory()</code>. Thus, the rule of not asserting interactions with stubs is not violated here.</p>\n</div>\n<div class=\"paragraph\">\n<p>When a test double is both a mock and a stub, it’s still called a mock, not a stub. That’s mostly because you need to pick one name, but also because being a mock is a more important fact than being a stub.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_mocks_vs_stubs_and_commands_vs_queries\">Mocks vs. stubs and commands vs. queries</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>The notion of mocks and stubs ties to the command query separation (CQS) principle. The CQS principle states that every method should be either a command or a query, but not both:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><strong>Commands</strong> are methods that produce side effects and don’t return any value (return <code>void</code>). Examples of side effects include mutating an object’s state, changing a file in the file system, and so on.</p>\n</li>\n<li>\n<p><strong>Queries</strong> are the opposite of that — they are side-effect free and return a value.</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>In other words, asking a question should not change the answer. Code that maintains such a clear separation becomes easier to read.</p>\n</div>\n<div class=\"paragraph\">\n<p>Test doubles that substitute commands become mocks. Similarly, test doubles that substitute queries are stubs:</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/2020/2020-04-13-cqs.png\" alt=\"2020 04 13 cqs\">\n</div>\n<div class=\"title\">Commands correspond to mocks; queries — to stubs</div>\n</div>\n<div class=\"paragraph\">\n<p>Look at the two tests from the previous examples again (I’m showing their relevant parts here):</p>\n</div>\n<div class=\"paragraph\">\n\n\n\n\n\n\n<div class=\"highlight\"><pre class=\"chroma\"><code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"kt\">var</span> <span class=\"n\">mock</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IEmailGateway</span><span class=\"p\">&gt;();</span>\n<span class=\"n\">mock</span><span class=\"p\">.</span><span class=\"n\">Verify</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">SendGreetingsEmail</span><span class=\"p\">(</span><span class=\"s\">\"user@email.com\"</span><span class=\"p\">));</span>\n\n<span class=\"kt\">var</span> <span class=\"n\">stub</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IDatabase</span><span class=\"p\">&gt;();</span>\n<span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Setup</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">GetNumberOfUsers</span><span class=\"p\">()).</span><span class=\"n\">Returns</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">);</span>\n</code></pre></div>\n\n</div>\n<div class=\"paragraph\">\n<p><code>SendGreetingsEmail()</code> is a command whose side effect is sending an email. The test double that substitutes this command is a mock.</p>\n</div>\n<div class=\"paragraph\">\n<p>On the other hand, <code>GetNumberOfUsers()</code> is a query that returns a value and doesn’t mutate the database state. The corresponding test double is a stub.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_when_to_mock\">When to mock</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>With all these definitions out of the way, let’s talk about when you should use mocks.</p>\n</div>\n<div class=\"paragraph\">\n<p>You obviously don’t want to mock the system under test (SUT) itself, so the question of \"When to mock?\" boils down to this: \"Which types of dependencies you should replace with a mock, and which — use as is in tests?\"</p>\n</div>\n<div class=\"paragraph\">\n<p>Here are all types of unit testing dependencies I listed in the <a href=\"/posts/unit-testing-dependencies\">previous article</a>:</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/2020/2020-04-02-dependencies-7.png\" alt=\"2020 04 02 dependencies 7\">\n</div>\n<div class=\"title\">Types of unit testing dependencies</div>\n</div>\n<div class=\"paragraph\">\n<p>To re-iterate:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>A <strong>shared dependency</strong> is a dependency that is shared between tests and provides means for those tests to affect each other’s outcome.</p>\n</li>\n<li>\n<p>A <strong>private dependency</strong> is any dependency that is not shared.</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>A shared dependency corresponds to a mutable out-of-process dependency in the vast majority of cases, that’s why I’m using these two notions as synonyms here. (Check out my previous post for more details: <a href=\"/posts/unit-testing-dependencies\">Unit Testing Dependencies: The Complete Guide</a>.)</p>\n</div>\n<div class=\"paragraph\">\n<p>There are two schools of unit testing with their own views on which types of dependencies to replace with mocks:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><strong>The London school</strong> (also known as the mockist school) advocates for replacing all mutable dependencies (collaborators) with mocks.</p>\n</li>\n<li>\n<p><strong>The classical school</strong> (also known as the Detroit school) advocates for the replacement of only shared (mutable out-of-process) dependencies.</p>\n</li>\n</ul>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/2020/2020-04-13-dependencies-schools.png\" alt=\"2020 04 13 dependencies schools\">\n</div>\n<div class=\"title\">Types of unit testing dependencies and the schools of unit testing</div>\n</div>\n<div class=\"paragraph\">\n<p><mark>Both schools are wrong in their treatment of mocks</mark>, though the classical school is less so than the London school.</p>\n</div>\n<div class=\"sidebarblock\">\n<div class=\"content\">\n<div class=\"title\">Mocks and immutable out-of-process dependencies</div>\n<div class=\"paragraph\">\n<p>What about immutable out-of-process dependencies? Shouldn’t they be mocked out too, according to at least one of the schools?</p>\n</div>\n<div class=\"paragraph\">\n<p>Immutable out-of-process dependencies (such as a read-only API service), <em>should</em> be replaced with a test double, but that test double would be a stub, not a mock.</p>\n</div>\n<div class=\"paragraph\">\n<p>That’s, once again, due to the differences between mocks and stubs:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Mocks are for <span class=\"u\">outcoming</span> interactions (commands) — interactions that leave a side effect in the dependency-collaborator.</p>\n</li>\n<li>\n<p>Stubs are for <span class=\"u\">incoming</span> interactions (queries) — interactions that don’t leave a side effect in the dependency.</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>Interactions with immutable out-of-process dependencies are, by definition, <strong><em>incoming</em></strong> and thus shouldn’t be checked for in tests, only stubbed out with canned answers (both schools are OK with that).</p>\n</div>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>I’ll first describe why the London school is wrong, and then — why the classical approach is wrong too.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_don_t_mock_all_mutable_dependencies\">Don’t mock all mutable dependencies</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>You shouldn’t mock all mutable dependencies. To see why, we need to look at two types of communications in a typical application: intra-system and inter-system.</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><strong>Intra-system communications</strong> are communications between classes inside your application</p>\n</li>\n<li>\n<p><strong>Inter-system communications</strong> are when your application talks to other applications.</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>Here they are on a diagram:</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/2020/2020-04-14-inter-intra.png\" alt=\"2020 04 14 inter intra\">\n</div>\n<div class=\"title\">Intra-system and inter-system communications</div>\n</div>\n<div class=\"paragraph\">\n<p>There’s a huge difference between the two: <mark>intra-system communications are implementation details; inter-system communications are not.</mark></p>\n</div>\n<div class=\"paragraph\">\n<p>Intra-system communications are implementation details because the collaborations your domain classes go through in order to perform an operation are not part of their observable behavior. These collaborations don’t have an immediate connection to the client’s goal. Thus, coupling to such collaborations leads to fragile tests.</p>\n</div>\n<div class=\"paragraph\">\n<p>Inter-system communications are a different matter. Unlike collaborations between classes inside your application, the way your system talks to the external world forms the observable behavior of that system as a whole. It’s part of the contract your application must hold at all times.</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/2020/2020-04-14-inter-intra-2.png\" alt=\"2020 04 14 inter intra 2\">\n</div>\n<div class=\"title\">Intra-system communications are implementation details; inter-system communications form the observable behavior of your application as a whole</div>\n</div>\n<div class=\"paragraph\">\n<p>This attribute of inter-system communications stems from the way separate applications evolve together. One of the main principles of such an evolution is maintaining backward compatibility. Regardless of the refactorings you perform inside your system, the communication pattern it uses to talk to external applications should always stay in place, so that external applications can understand it. For example, messages your application emits on a bus should preserve their structure, the calls issued to an SMTP service should have the same number and type of parameters, and so on.</p>\n</div>\n<div class=\"paragraph\">\n<p><mark>The use of mocks cements the communication pattern between the system under test and the dependency (makes that pattern harder to change).</mark> This is <strong><em>exactly</em></strong> what you want when verifying communications between your system and external applications. Conversely, using mocks to verify communications between classes inside your system couples your tests to implementation details, making them fragile.</p>\n</div>\n<div class=\"paragraph\">\n<p>Intra-system communications correspond to mutable in-process dependencies:</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/2020/2020-04-14-dependencies.png\" alt=\"2020 04 14 dependencies\">\n</div>\n<div class=\"title\">Intra-system communications are communications with mutable in-process dependencies</div>\n</div>\n<div class=\"paragraph\">\n<p>And so, the London school is wrong because it encourages the use of mocks for all mutable dependencies and doesn’t differentiate between intra-system (in-process) and inter-system (out-of-process) communications.</p>\n</div>\n<div class=\"paragraph\">\n<p>As a result, tests check communications between classes just as much as they check communications between your application and external systems. This indiscriminate use of mocks is why following the London school often results in fragile tests — tests that couple to implementation details.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_don_t_mock_all_out_of_process_dependencies\">Don’t mock all out-of-process dependencies</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>The classical school is better at this issue because it advocates for substituting only out-of-process dependencies such as an SMTP service, a message bus, and so on. But the classical school is not ideal in its treatment of inter-system communications, either. This school also encourages excessive use of mocks, albeit not as much as the London school.</p>\n</div>\n<div class=\"paragraph\">\n<p>Not all out-of-process dependencies should be mocked out. <mark>If an out-of-process dependency is only accessible through your application, then communications with such a dependency are not part of your system’s observable behavior.</mark> An out-of-process dependency that can’t be observed externally, in effect, acts as part of your application. Communications with such a dependency become implementation details: they don’t have to stay in place after refactoring and therefore shouldn’t be verified with mocks.</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/2020/2020-04-14-inter-intra-3.png\" alt=\"2020 04 14 inter intra 3\">\n</div>\n<div class=\"title\">Some inter-system communications are implementation details too</div>\n</div>\n<div class=\"paragraph\">\n<p>Remember, the requirement to always preserve the communication pattern between your application and external systems stems from the necessity to maintain backward compatibility. You have to maintain the way your application talks to external systems. That’s because you can’t change those external systems simultaneously with your application; they may follow a different deployment cycle, or you might simply not have control over them.</p>\n</div>\n<div class=\"paragraph\">\n<p>But when your application acts as a proxy to an external system, and no client can access it directly, the backward-compatibility requirement vanishes. Now you can deploy your application together with this external system, and it won’t affect the clients. The communication pattern with such a system becomes an implementation detail.</p>\n</div>\n<div class=\"paragraph\">\n<p>A good example here is an application database: a database that is used only by your application. No external system has access to this database. Therefore, you can modify the communication pattern between your system and the application database in any way you like, as long as it doesn’t break existing functionality. Because that database is completely hidden from the eyes of the clients, you can even replace it with an entirely different storage mechanism, and no one will notice.</p>\n</div>\n<div class=\"paragraph\">\n<p><mark>The use of mocks for out-of-process dependencies that you have a full control over also leads to brittle tests</mark>. You don’t want your tests to turn red every time you split a table in the database or modify the type of one of the parameters in a stored procedure. The database and your application must be treated as one system.</p>\n</div>\n<div class=\"paragraph\">\n<p>This distinction splits out-of-process dependencies into two subcategories:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><strong>Managed dependencies</strong> — out-of-process dependencies you have full control over. These dependencies are only accessible through your application; interactions with them aren’t visible to the external world. A typical example is the application database. External systems don’t access your database directly; they do that through the API your application provides.</p>\n</li>\n<li>\n<p><strong>Unmanaged dependencies</strong> — out-of-process dependencies you don’t have full control over. Interactions with such dependencies <strong><em>are</em></strong> observable externally. Examples include an SMTP server and a message bus: both produce side effects visible to other applications.</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>Only unmanaged dependencies should be replaced with mocks. Use real instances of managed dependencies in tests.</p>\n</div>\n<div class=\"imageblock\">\n<div class=\"content\">\n<img src=\"/images/2020/2020-04-14-dependencies-2.png\" alt=\"2020 04 14 dependencies 2\">\n</div>\n<div class=\"title\">Only unmanaged dependencies can be replaced with mocks</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_further_reading\">Further reading</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Of course, using real instances of managed dependencies in tests poses an obvious issue: how do you test them such that your tests remain fast and reliable?</p>\n</div>\n<div class=\"paragraph\">\n<p>You’ll see this subject covered in depth in my book:</p>\n</div>\n<table class=\"tableblock frame-all grid-all spread\">\n<colgroup>\n<col style=\"width: 33.3333%;\">\n<col style=\"width: 66.6667%;\">\n</colgroup>\n<tbody>\n<tr>\n<td class=\"tableblock halign-left valign-top\"></td>\n<td class=\"tableblock halign-left valign-top\"></td>\n</tr>\n<tr>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><span class=\"image\"><a class=\"image\" href=\"/book-amazon\"><img src=\"/images/book-2.png\" alt=\"Unit Testing Principles\" width=\"150\" height=\"and Patterns\"></a></span></p></td>\n<td class=\"tableblock halign-left valign-top\"><p class=\"tableblock\"><a href=\"/book-amazon\">Unit Testing Principles, Practices, and Patterns</a></p></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_summary\">Summary</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Test double is an overarching term that describes all kinds of non-production-ready, fake dependencies in tests.</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>There are five variations of test doubles — dummy, stub, spy, mock, and fake — that can be grouped in just two types: mocks and stubs.</p>\n</li>\n<li>\n<p>Spies are functionally the same as mocks; dummies and fakes serve the same role as stubs.</p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p>The differences between mocks vs stubs:</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Mocks help emulate and examine outcoming interactions: calls from the SUT to its dependencies that change the state of those dependencies.</p>\n</li>\n<li>\n<p>Stubs help emulate incoming interactions: calls the SUT makes to its dependencies to get input data.</p>\n</li>\n<li>\n<p>Asserting interactions with stubs always leads to fragile tests.</p>\n</li>\n<li>\n<p>Test doubles that substitute CQS commands are mocks. Test doubles that substitute CQS queries are stubs.</p>\n</li>\n</ul>\n</div>\n</li>\n<li>\n<p>A mock-the-tool is a class from a mocking library that you can use to create a mock-the-test-double or a stub.</p>\n</li>\n<li>\n<p>Out-of-process dependencies can be categorized into 2 subcategories: managed and unmanaged dependencies.</p>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Managed dependencies are out-of-process dependencies that are only accessible through your application. Interactions with managed dependencies aren’t observable externally. A typical example is the application database.</p>\n</li>\n<li>\n<p>Unmanaged dependencies are out-of-process dependencies that other applications have access to. Interactions with unmanaged dependencies are observable externally. Typical examples include an SMTP server and a message bus.</p>\n</li>\n<li>\n<p>Communications with managed dependencies are implementation details; communications with unmanaged dependencies are part of your system’s observable behavior.</p>\n</li>\n<li>\n<p>Use real instances of managed dependencies in integration tests; replace unmanaged dependencies with mocks.</p>\n</li>\n</ul>\n</div>\n</li>\n</ul>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_related\">Related</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"/posts/unit-testing-dependencies/\">Unit Testing Dependencies: The Complete Guide</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>\n\n\t\t<ul class=\"pager\">\n  <li class=\"previous\">\n    <a href=\"/posts/unit-testing-dependencies/\" class=\"left arrow\">← Unit Testing Dependencies: The Complete Guide</a>\n  </li>\n</ul>\n\n<h2>Subscribe</h2>\n\n<hr>\n\n<form action=\"https://www.getdrip.com/forms/162681596/submissions\" method=\"post\" data-drip-embedded-form=\"162681596\">\n<div data-drip-attribute=\"description\" style=\"font-size:90%;margin: 15px 0px;\">I don't post everything on my blog. Don't miss smaller tips and updates. Sign up to my mailing list below.</div>\n\n<div class=\"container\">\n<div class=\"row\">\n<div class=\"col-md-5\" style=\"padding:0px;\">\n  <input type=\"email\" id=\"drip-email\" name=\"fields[email]\" style=\"width:100%;border: 1px solid #777;font-size:90%;padding: 2px 5px;\" placeholder=\"Your email\" value=\"\">\n</div>\n<div class=\"col-md-2\" style=\"padding:0px\">\n  <input type=\"submit\" value=\"Sign up\" style=\"font-size:90%;margin-left: 10px;\" data-drip-attribute=\"sign-up-button\">\n</div>\n</div>\n</div>\n</form>\n\n\n\n\n<h2>Comments</h2>\n\n<hr>\n\n\n\t<div id=\"disqus_thread\"></div>\n<script type=\"application/javascript\">\n    var disqus_config = function () {\n    this.page.identifier = '2020 when-to-mock';\n    this.page.title = 'When to mock';\n    \n    };\n    (function() {\n        if ([\"localhost\", \"127.0.0.1\"].indexOf(window.location.hostname) != -1) {\n            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';\n            return;\n        }\n        var d = document, s = d.createElement('script'); s.async = true;\n        s.src = '//' + \"enterprisecraftsmanship\" + '.disqus.com/embed.js';\n        s.setAttribute('data-timestamp', +new Date());\n        (d.head || d.body).appendChild(s);\n    })();\n</script>\n<noscript>Please enable JavaScript to view the <a href=\"https://disqus.com/?ref_noscript\">comments powered by Disqus.</a></noscript>\n<a href=\"https://disqus.com\" class=\"dsq-brlink\">comments powered by <span class=\"logo-disqus\">Disqus</span></a>\n\n\n\t</div>\n\n\t<div class=\"pagination\">\n\t\t<a href=\"#\" class=\"top\">Top</a>\n\t</div>\n</main>\n\n\n\t\t</div>\n\t\t<div class=\"col-md-3 sidebar\">\n          <div class=\"self\">\n<img src=\"/images/photo.png\" alt=\"Vladimir Khorikov\">\n<h6>Vladimir Khorikov</h6>\n<a href=\"https://twitter.com/vkhorikov\" target=\"_blank\">\n<img src=\"data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2232%22%20height%3D%2232%22%3E%3Cg%3E%3Crect%20fill%3D%22%2355ACEE%22%20width%3D%2232%22%20height%3D%2232%22%2F%3E%3Cpath%20fill%3D%22%23fff%22%20d%3D%22M28%208.557c-.884.391-1.833.656-2.828.774%201.017-.608%201.798-1.573%202.166-2.725-.953.566-2.006.976-3.129%201.194-.897-.957-2.177-1.555-3.594-1.555-2.719%200-4.924%202.206-4.924%204.925%200%20.386.043.762.128%201.124-4.093-.208-7.723-2.168-10.15-5.146-.422.726-.666%201.573-.666%202.476%200%201.709.869%203.214%202.191%204.099-.807-.026-1.565-.248-2.23-.615v.061c0%202.388%201.698%204.377%203.951%204.83-.414.112-.849.171-1.297.171-.317%200-.625-.031-.927-.086.628%201.956%202.446%203.38%204.6%203.419-1.686%201.319-3.809%202.108-6.115%202.108-.398%200-.79-.024-1.175-.069%202.178%201.396%204.767%202.213%207.549%202.213%209.056%200%2014.011-7.506%2014.011-14.012l-.016-.637c.96-.694%201.795-1.56%202.455-2.549z%22%2F%3E%3C%2Fg%3E%3C%2Fsvg%3E\" alt=\"Twitter\"></a>\n<a href=\"mailto:vlad@enterprisecraftsmanship.com\" target=\"_blank\">\n<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAMmSURBVFhHxZdvaI1RHMe/1/8MLYtkatNeEGKLF2iyUaRoe0GSNVsRWTYrUiTz78W82mpkhPHKaNokNpL5k/xrjFnxxhQmEfInUeb7fc65u3vun9177d7tU9/O75znuc/ve855nnPO9SBCuspmJLJYRGVRC6gUahiVQH2kWqg31G3qjKes7S/LsIQ1wMRzWKylCiiZiJQKqpJGOkw1OCEN2B7voaJN7E8FTZTaOICgBpg8ncVZaorT0HeeUHk08txUfQQYsMlvUH3pdTC+UNk0ITPduAzEMbkXmciiiVZTBQbZ0jvnp6h4JRd6dr0JDd0GyG5KIxBvUtnZ4zY2U8CGNBaPqHj23p/J+kS9Bo6x2KAYiROBhZudMObcPMK34J2toIYGCj127l9Rvt4vLgEy19tKDPj1DbhV3YXHFzxObPhJJesdWEb5kqdw4WupA6pXAq0XbWMf6HgInC4EOts9SEq1jQ4jqVyvAR+aguIrwKxc4NI+oG5Hz2GLnPcvgHNbgVqOpp61uhJI0vbhIlsGpprYj7l5wE66H8L9pnIp0FhuL4RBQ9zEe2uL2ZlJQEmTedaI0fYGF9NlYJyJg+DhO5qzH9h4HvjwEjiUyUW1wV4MQttlM3XqvXq8ZFuoxF7SZMA1MUGZwEHKP8EHbjdvcvUq4FOPTU7zrLY7vCd7C7DupPlNeBJk4I+JIyA9xwzpzBVAFaWhlup3cZ55raCG15bbmyNiqAz8MHEUzMsHSq+b+dZwF3AFDz3PvdEhA70eGEIyZjzfjwNmuBOTbWPUfJaBZhMPCPdkgG/QgHFVBvjtDAg6G9z3bkY6B+jsxw9jLD+loi4MHu46rMSE5sPA105bsZuRIhrg+ou3ivuJ7uOZpgAMtNhzFek31HvnbOgYsGyinpowrijxXhMGHkq1LD+jRjkNsSf0oVTwghYl/e367jTEFiVf0zO5cBkQdm7mU+1OQ2zQMzP47EZT9dHrp8YpqWJRZGr/hXp9lCpncsUBhP3WaUJHdR5r7DoRGUp2jTroP+T+RLXY0Ay3PMymMqhplA4z2k1/U6+pB9RdqiFUj90A/wCbXt7P+tqoKgAAAABJRU5ErkJggg==\" alt=\"Email\"></a>\n<a href=\"https://www.linkedin.com/in/vladimir-khorikov-bb482653/\" target=\"_blank\">\n<img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAK3SURBVEhLY3z/7Vf19purrrx88+03A/UAGyNjnJHU7FBd5uc6wXPOPvv2+x9UhkrgLwPDueefH779xvxUN+TbHyqbDgc3X39l/mYeCeWBgQQXa5iupJOS8N9//55+/gkVJRf8+f+fkaF8O5THwGAgzrM7zUyEmw3CXXHuaeSqyxA22YAJSgPBf4YlEfpw04Egwkg6zkAKyiEXICzQEOXSluSFcmDAWUUYyiIXICx48QlLiP/8S2n8Iyz48OvvgdtvoBww+M/AsObSCyiHXIAUBwwMCWuunHn0AcL+8P131/57u+6+hXDJBiipCAI8VEWYGRnuvf9+/fVXqBAFAMUCXnZmLRFudmaoty6//PL+5x8gQ4KbTU2YCyIIDLfDDz8A9QlwsBhI8hpI8ArxsP34/e/M449YvYtiQYy+5OJIfSiHgeHJh++y7QeBStZGGQTpSUBFGRg69t3df+/d/FBdKX4OqBAYPHz3PWjxOWAJAeWDAUocsAKDBgkwMwK5QBcz8LAxQ0QgIEBLbFWMIZrpQCAvxHk6zwroJygfDFAsIBJoSPDyc7BAOaiAiZFxZpA2lAMG5FgAB/9B3kMHZnICCkieI9OCC08/GU84Ktiwx2nGySuogQ4EPlpiUBZ5Fvz99z9h9eVzLz5//Pln/4P3PvPPQCVggB8pzsixYPO1VxdfIFz98OPPB+++QzlgIMrLDmWRZ8HTjz+gLAhgZHiJWnPwsFLmg98YJeA/1OjmYkEYS44FmOA/qgWwogAEqGMBHjBqAUFAXwv+oZYtP8ltkCGbg1IfADNImpkMKyyVXXv5ZfPN10AGsAR2VxOBCALByovPH6DmNUNJXjdVhIL9d9+eevoJwmZkq9zxC83l1APAWo8pxVQGyqMBSDWVYT60eNL7b78vv/j8h6reEGBnSTCWanRTBQAf+urSEwiEBAAAAABJRU5ErkJggg==\" alt=\"LinkedIn\">\n</a>\n</div>\n\n<div class=\"book\">\n<h6>My book</h6>\n<a href=\"/book-amazon\" target=\"_blank\">\n<img alt=\"Unit testing book\" src=\"/images/book-2.png\">\n</a>\n\n<div class=\"black-link\">\n<a data-sumome-listbuilder-id=\"6512ca46-1cc8-4a12-b62b-ebc73a98b90b\" data-sumome-trigger=\"true\" href=\"javascript:void(0);\">Click here to get a 40% discount</a>\n</div>\n</div>\n\n\n<div class=\"ps\">\n<h6>Pluralsight courses</h6>\n<a href=\"/ps-all\" target=\"_blank\">\n<img src=\"/images/PSAuthor.png\" alt=\"Pluralsight\"></a>\n\n‒ <a target=\"_blank\" href=\"/ps-unit-testing\">Pragmatic Unit Testing</a><br>\n\n‒ <a target=\"_blank\" href=\"/ps-ddd-in-practice\">Domain-Driven Design in Practice</a><br>\n\n‒ <a target=\"_blank\" href=\"/ps-func\">Applying Functional Principles in C#</a><br>\n\n‒ <a target=\"_blank\" href=\"/ps-db\">Database Delivery Best Practices</a><br>\n\n‒ <a target=\"_blank\" href=\"/ps-spec-pattern\">Specification Pattern in C#</a><br>\n\n‒ <a target=\"_blank\" href=\"/ps-anemic\">Refactoring from Anemic Domain Model</a><br>\n\n‒ <a target=\"_blank\" href=\"/ps-legacy\">Domain-Driven Design: Working with Legacy Projects</a><br>\n\n‒ <a target=\"_blank\" href=\"/ps-cqrs\">CQRS in Practice</a><br>\n\n‒ <a target=\"_blank\" href=\"/ps-ef-core\">DDD and EF Core: Preserving Encapsulation</a>\n</div>\n\n<div class=\"popular\">\n<h6>Most Popular Articles</h6>\n‒ <a href=\"/2018/06/13/ef-core-vs-nhibernate-ddd-perspective/\">EF Core 2.1 vs NHibernate 5.1: DDD perspective</a><br>\n‒ <a href=\"/posts/c-and-f-approaches-to-illegal-state/\">C# and F# approaches to illegal states</a><br>\n‒ <a href=\"/2017/09/18/optimistic-locking-automatic-retry/\">Optimistic locking and automatic retry</a><br>\n‒ <a href=\"/2016/01/11/entity-vs-value-object-the-ultimate-list-of-differences/\">Entity vs Value Object: the ultimate list of differences</a><br>\n‒ <a href=\"/2015/04/13/dto-vs-value-object-vs-poco/\">DTO vs Value Object vs POCO</a><br>\n‒ <a href=\"/2015/05/11/3-misused-of-operator-in-c-6/\">3 misuses of ?. operator in C# 6</a><br>\n‒ <a href=\"/2016/02/08/specification-pattern-c-implementation/\">Specification pattern: C# implementation</a><br>\n‒ <a href=\"/2015/08/10/database-versioning-best-practices/\">Database versioning best practices</a><br>\n‒ <a href=\"/2017/10/23/unit-testing-private-methods/\">Unit testing private methods</a><br>\n‒ <a href=\"/2015/03/20/functional-c-handling-failures-input-errors/\">Functional C#: Handling failures, input errors</a><br>\n‒ <a href=\"/2017/01/31/rest-api-response-codes-400-vs-500/\">REST API response codes: 400 vs 500</a>\n</div>\n\n<div class=\"mvp\">\n<a target=\"_blank\" href=\"https://mvp.microsoft.com/en-us/PublicProfile/5002117\">\n<img src=\"/images/MSMVP.png\" alt=\"MSMVP\"></a>\n</div>\n\n\n\n<div class=\"recentposts\">\n<h6>Recent Articles</h6>\n\n‒ <a href=\"https://enterprisecraftsmanship.com/posts/when-to-mock/\">When to Mock</a><br>\n\n‒ <a href=\"https://enterprisecraftsmanship.com/posts/unit-testing-dependencies/\">Unit Testing Dependencies: The Complete Guide</a><br>\n\n‒ <a href=\"https://enterprisecraftsmanship.com/posts/new-online-course-ddd-and-ef-core/\">EF Core and DDD: New online course</a><br>\n\n‒ <a href=\"https://enterprisecraftsmanship.com/posts/3-things-that-will-make-or-break-your-project/\">3 things that will make or break your project</a><br>\n\n‒ <a href=\"https://enterprisecraftsmanship.com/posts/assertion-messages-in-tests/\">Assertion messages in tests</a><br>\n\n‒ <a href=\"https://enterprisecraftsmanship.com/posts/is-entity-same-as-value-object/\">Is Entity the same as Value Object?</a><br>\n\n‒ <a href=\"https://enterprisecraftsmanship.com/posts/ddd-bulk-operations/\">DDD and bulk operations</a><br>\n\n‒ <a href=\"https://enterprisecraftsmanship.com/posts/combining-asp-net-core-attributes-with-value-objects/\">Combining ASP.NET Core validation attributes with Value Objects</a><br>\n\n‒ <a href=\"https://enterprisecraftsmanship.com/posts/advanced-error-handling-techniques/\">Advanced error handling techniques</a><br>\n\n‒ <a href=\"https://enterprisecraftsmanship.com/posts/you-naming-tests-wrong/\">You are naming your tests wrong!</a><br>\n\n<div style=\"padding-top:10px;\">\n<a href=\"/archives\">» All articles</a><br>\n</div>\n</div>\n\n\t\t</div>\n\t  </div>\n\t  \n\t  <div class=\"row\">\n\t    <div class=\"col-md-9\">\n          <footer>\n\t<span>\n\t© <time datetime=\"2020\">2020</time> Vladimir Khorikov. Made with <a target=\"_blank\" href=\"https://gohugo.io\">Hugo</a>.\n\t</span>\n</footer>\n\n\t\t</div>\n\t  </div>\n\t</div>\n\t\n\t\n<script async=\"\" src=\"https://www.googletagmanager.com/gtag/js?id=UA-56185457-1\"></script>\n<script>\n  window.dataLayer = window.dataLayer || [];\n  function gtag(){dataLayer.push(arguments);}\n  gtag('js', new Date());\n\n  gtag('config', 'UA-56185457-1', { 'anonymize_ip': true });\n</script>\n\n\t<script async=\"\">(function(s,u,m,o,j,v){j=u.createElement(m);v=u.getElementsByTagName(m)[0];j.async=1;j.src=o;j.dataset.sumoSiteId='81530c24640fc92186bdd6ca83f4a4c8947f80d8a68a7ad4d92925895c06d929';v.parentNode.insertBefore(j,v)})(window,document,'script','//load.sumo.com/');</script>\n  \n\n<iframe id=\"sumome-jquery-iframe\" title=\"Sumo Hidden Content\" style=\"display: none;\"></iframe><a href=\"javascript:void(0);\" title=\"Sumo\" style=\"background-color: rgb(0, 115, 183); border-radius: 3px 0px 0px 3px; box-shadow: rgba(0, 0, 0, 0.2) 0px 4px 10px; position: fixed; z-index: 2147483647; padding: 0px; width: 44px; height: 40px; text-indent: -10000px; opacity: 1; display: none !important; transition-duration: 0s; transform: scale(0, 0); animation-fill-mode: none; animation-duration: 0s;\" data-sumo-welcome-mat-data=\"{&quot;originalStyles&quot;:{&quot;transform&quot;:&quot;&quot;,&quot;transitionDuration&quot;:&quot;&quot;,&quot;animationFillMode&quot;:&quot;&quot;,&quot;animationDuration&quot;:&quot;&quot;}}\"><span style=\"position: absolute; left: -10000px; top: auto; width: 1px; height: 1px; overflow: hidden; transition-duration: 0s; transform: scale(0, 0); animation-fill-mode: none; animation-duration: 0s;\" data-sumo-welcome-mat-data=\"{&quot;originalStyles&quot;:{&quot;transform&quot;:&quot;&quot;,&quot;transitionDuration&quot;:&quot;&quot;,&quot;animationFillMode&quot;:&quot;&quot;,&quot;animationDuration&quot;:&quot;&quot;}}\">Sumo</span><span style=\"display:block;width:40px;height:40px;background:white;margin-left:4px;-webkit-border-radius: 3px 0 0 3px;-moz-border-radius: 3px 0 0 3px;-ms-border-radius: 3px 0 0 3px;-o-border-radius: 3px 0 0 3px;border-radius: 3px 0 0 3px;background-repeat:no-repeat;background-position:8px 8px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAMAAADXqc3KAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA3hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTM4IDc5LjE1OTgyNCwgMjAxNi8wOS8xNC0wMTowOTowMSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDoxZDQ2MjI4YS03NWY2LTRkZTQtOGJjYy1hODc1NjRkMjYxYTUiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6RDQ3MUVFMDFFMjVDMTFFNjlFQjhBRjdGODU5MDJBMDUiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6RDQ3MUVFMDBFMjVDMTFFNjlFQjhBRjdGODU5MDJBMDUiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTcgKE1hY2ludG9zaCkiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDoxZDQ2MjI4YS03NWY2LTRkZTQtOGJjYy1hODc1NjRkMjYxYTUiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MWQ0NjIyOGEtNzVmNi00ZGU0LThiY2MtYTg3NTY0ZDI2MWE1Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+8JtvywAAAKhQTFRFzOPxSJvLA3W4Mo7FBna5w97u8vj7EHy8a67VhbzdsdTpVaLPh73d9/v9C3m6QZfJbq/WXKbR3u32JIfB3ez1KorDir/eBHW4+/3+rtPoZarUG4K/LIvDDnu7ocvkf7nbdrTY9fr8E328WKPQO5PITJ3MPpXJstXptdbq+Pv9cbHXaq3VU6HOkMLgnMnjDHq62uv1/P3+6/T53Oz1cLDX/f7+AHO3////ptOZ5QAAADh0Uk5T/////////////////////////////////////////////////////////////////////////wA7XBHKAAAAmUlEQVR42sSRRxLCMAxFRSq9907ovebr/jdDMWYGxmZL3sIqbyFbJv4B/VlkVlerKALTD3G46Mx3AOR1UZ/TsDxW6W0gfYRNVfTCFu2AWpAMgMItMW+zQJU2UjWI29D0+e5KWNPMk+A9Om+B/UgOJyCuwMJCrpuziYkIsglfRByZ/XM3eXnBFEu1kpMpjq9dxQYp/OAXTwEGAB7Rc1xVnPemAAAAAElFTkSuQmCC);\"></span></a><iframe style=\"display: none;\"></iframe><img src=\"//sumo.com/api/event/?site_id=81530c24640fc92186bdd6ca83f4a4c8947f80d8a68a7ad4d92925895c06d929&amp;app_id=156085c5-0017-4150-b225-a731ad248f38&amp;shortcut_id=&amp;visitor_id=d08d017d7b335e95512e67f5f09425b580655a4357fec64e6c4553773c9f380e&amp;event=popup&amp;href=https%3A%2F%2Fenterprisecraftsmanship.com%2Fposts%2Fwhen-to-mock%2F&amp;ref=&amp;cache=0.09311478853264643\" alt=\"\" style=\"display: none;\"><img src=\"//sumo.com/api/event/?site_id=81530c24640fc92186bdd6ca83f4a4c8947f80d8a68a7ad4d92925895c06d929&amp;app_id=156085c5-0017-4150-b225-a731ad248f38.482a6bc24a645e1a6063cb49ed6b22576238bf9e51cbf5bb11880b3bfbd21e8c&amp;shortcut_id=&amp;visitor_id=d08d017d7b335e95512e67f5f09425b580655a4357fec64e6c4553773c9f380e&amp;event=popup&amp;href=https%3A%2F%2Fenterprisecraftsmanship.com%2Fposts%2Fwhen-to-mock%2F&amp;ref=&amp;cache=0.9557827750958294\" alt=\"\" style=\"display: none;\"><img src=\"//sumo.com/api/event/?site_id=81530c24640fc92186bdd6ca83f4a4c8947f80d8a68a7ad4d92925895c06d929&amp;app_id=156085c5-0017-4150-b225-a731ad248f38.761ea8b8d15e3cf63bd615390fb015caa88133394a7da3da5f64897bf448c1c2&amp;shortcut_id=&amp;visitor_id=d08d017d7b335e95512e67f5f09425b580655a4357fec64e6c4553773c9f380e&amp;event=popup&amp;href=https%3A%2F%2Fenterprisecraftsmanship.com%2Fposts%2Fwhen-to-mock%2F&amp;ref=&amp;cache=0.20473625563779452\" alt=\"\" style=\"display: none;\"><img src=\"//sumo.com/api/event/?site_id=81530c24640fc92186bdd6ca83f4a4c8947f80d8a68a7ad4d92925895c06d929&amp;app_id=156085c5-0017-4150-b225-a731ad248f38.482a6bc24a645e1a6063cb49ed6b22576238bf9e51cbf5bb11880b3bfbd21e8c.761ea8b8d15e3cf63bd615390fb015caa88133394a7da3da5f64897bf448c1c2&amp;shortcut_id=&amp;visitor_id=d08d017d7b335e95512e67f5f09425b580655a4357fec64e6c4553773c9f380e&amp;event=popup&amp;href=https%3A%2F%2Fenterprisecraftsmanship.com%2Fposts%2Fwhen-to-mock%2F&amp;ref=&amp;cache=0.3256141854016412\" alt=\"\" style=\"display: none;\">","text":"I'm In!\n5 Unit Testing Mistakes\nTake the free 5-day class\nNo Thanks\nclose\nEnterprise Craftsmanship\nBlog\nUnit Testing Book\nOnline Courses\nAbout\nArchives\nWhen to Mock\nApril 15, 2020\nThe use of mocks in unit testing is a controversial topic (maybe less so now than several years ago). I remember how, throughout my programming career, I went from mocking almost every dependency, to the \"no-mocks\" policy, and then to \"only mock external dependencies\".\nNone of this practices are good enough. In this article, I’ll show you which dependencies to mock, and which to use as is in your tests.\nWhat is a mock?\nBefore jumping to the topic of when to mock, let’s discuss what a mock is.\nMock vs test double\nPeople often use the terms test double and mock as synonyms, but technically, they are not:\nA test double is an overarching term that describes all kinds of non-production-ready, fake dependencies in tests. Such a dependency looks and behaves like its release-intended counterpart but is actually a simplified version that reduces complexity and facilitates testing.\nThis term was introduced by Gerard Meszaros in his book xUnit Test Patterns: Refactoring Test Code. The name itself comes from the notion of a stunt double in movies.\nA mock is just one kind of such dependencies.\nAccording to Gerard Meszaros, there are 5 types of test doubles:\nDummy\nStub\nSpy\nMock\nFake\nSuch a variety may look intimidating, but in reality, they can all be grouped together into just two types: mocks and stubs.\nAll variations of test doubles can be categorized into two types: mocks and stubs\nThe difference between these two types boils down to the following:\nMocks help to emulate and examine outcoming interactions. These interactions are calls the system under test (SUT) makes to its dependencies to change their state.\nStubs help to emulate incoming interactions. These interactions are calls the SUT makes to its dependencies to get input data.\nFor example, sending an email is an outcoming interaction: that interaction results in a side effect in the SMTP server. A test double emulating such an interaction is a mock.\nRetrieving data from the database is an incoming interaction — it doesn’t result in a side effect. The corresponding test double is a stub.\nMocks are for outcoming interaction; stubs — for incoming\nAll other differences between the five types of test doubles are insignificant implementation details:\nSpies serve the same role as mocks. The distinction is that spies are written manually, whereas mocks are created with the help of a mocking framework. Sometimes people refer to spies as handwritten mocks.\nOn the other hand, the difference between stubs, dummies, and fakes is in how intelligent they are:\nA dummy is a simple, hard-coded value such as a null value or a made-up string. It’s used to satisfy the SUT’s method signature and doesn’t participate in producing the final outcome.\nA stub is more sophisticated. It’s a fully fledged dependency that you configure to return different values for different scenarios.\nA fake is the same as a stub for most purposes. The difference is in the rationale for its creation: a fake is usually implemented to replace a dependency that doesn’t yet exist.\nNotice the difference between mocks and stubs (aside from outcoming versus incoming interactions). Mocks help to emulate and examine interactions between the SUT and its dependencies, while stubs only help to emulate those interactions. This is an important distinction. You will see why shortly.\nMock-the-tool vs. mock-the-test-double\nThe term mock is overloaded and can mean different things in different circumstances. I mentioned already that people often use this term to mean any test double, whereas mocks are only a subset of test doubles.\nBut there’s another meaning for the term mock. You can refer to the classes from mocking libraries as mocks, too. These classes help you create actual mocks, but they themselves are not mocks per se:\n<code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"na\">[Fact]</span>\n<span class=\"k\">public</span> <span class=\"k\">void</span> <span class=\"n\">Sending_a_greetings_email</span><span class=\"p\">()</span>\n<span class=\"p\">{</span> <span class=\"c1\">// Using a mock-the-tool to create a mock-the-test-double\n</span><span class=\"c1\"></span> <span class=\"kt\">var</span> <span class=\"n\">mock</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IEmailGateway</span><span class=\"p\">&gt;();</span> <span class=\"kt\">var</span> <span class=\"n\">sut</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Controller</span><span class=\"p\">(</span><span class=\"n\">mock</span><span class=\"p\">.</span><span class=\"n\">Object</span><span class=\"p\">);</span> <span class=\"n\">sut</span><span class=\"p\">.</span><span class=\"n\">GreetUser</span><span class=\"p\">(</span><span class=\"s\">\"user@email.com\"</span><span class=\"p\">);</span> <span class=\"c1\">// Examining the call from the SUT to the test double\n</span><span class=\"c1\"></span> <span class=\"n\">mock</span><span class=\"p\">.</span><span class=\"n\">Verify</span><span class=\"p\">(</span> <span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">SendGreetingsEmail</span><span class=\"p\">(</span><span class=\"s\">\"user@email.com\"</span><span class=\"p\">),</span> <span class=\"n\">Times</span><span class=\"p\">.</span><span class=\"n\">Once</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code>\nThis test uses the Mock class from the Moq mocking library. This class is a tool that enables you to create a test double — a mock. In other words, the class Mock (or Mock&lt;IEmailGateway&gt;) is a mock-the-tool, while the instance of that class, mock, is a mock-the-test-double.\nIt’s important not to conflate a mock-the-tool with a mock-the-test-double because you can use a mock-the-tool to create both types of test doubles: mocks and stubs.\nHere’s another example of a test that uses the Mock class. The instance of that class is a stub, not mock:\n<code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"na\">[Fact]</span>\n<span class=\"k\">public</span> <span class=\"k\">void</span> <span class=\"n\">Creating_a_report</span><span class=\"p\">()</span>\n<span class=\"p\">{</span> <span class=\"c1\">// Using a mock-the-tool to create a stub\n</span><span class=\"c1\"></span> <span class=\"kt\">var</span> <span class=\"n\">stub</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IDatabase</span><span class=\"p\">&gt;();</span> <span class=\"c1\">// Setting up a canned answer\n</span><span class=\"c1\"></span> <span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Setup</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">GetNumberOfUsers</span><span class=\"p\">()).</span><span class=\"n\">Returns</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">);</span> <span class=\"kt\">var</span> <span class=\"n\">sut</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Controller</span><span class=\"p\">(</span><span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Object</span><span class=\"p\">);</span> <span class=\"n\">Report</span> <span class=\"n\">report</span> <span class=\"p\">=</span> <span class=\"n\">sut</span><span class=\"p\">.</span><span class=\"n\">CreateReport</span><span class=\"p\">();</span> <span class=\"n\">Assert</span><span class=\"p\">.</span><span class=\"n\">Equal</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">,</span> <span class=\"n\">report</span><span class=\"p\">.</span><span class=\"n\">NumberOfUsers</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code>\nThis test double emulates an incoming interaction — a call that provides the SUT with input data.\nOn the other hand, in the previous example, the call to SendGreetingsEmail() is an outcoming interaction. Its sole purpose is to incur a side effect — send an email.\nDon’t assert interactions with stubs\nAs I mentioned above, mocks help to emulate and examine outcoming interactions between the SUT and its dependencies, while stubs only help to emulate incoming interactions, not examine them.\nThe difference between the two stems from this guideline: you should never assert interactions with stubs. A call from the SUT to a stub is not part of the end result the SUT produces. Such a call is only a means to produce the end result; it’s an implementation detail. Asserting interactions with stubs is a common anti-pattern that leads to brittle tests.\nThe only way to avoid test brittleness is to make those tests verify the end result (which, ideally, should be meaningful to a non-programmer), not implementation details.\nIn the above examples, the check\n<code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"n\">mock</span><span class=\"p\">.</span><span class=\"n\">Verify</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">SendGreetingsEmail</span><span class=\"p\">(</span><span class=\"s\">\"user@email.com\"</span><span class=\"p\">))</span>\n</code>\ncorresponds to an actual outcome, and that outcome is meaningful to a domain expert: sending a greetings email is something business people would want the system to do.\nAt the same time, the call to GetNumberOfUsers() is not an outcome at all. It’s an internal implementation detail regarding how the SUT gathers data necessary for the report creation. Therefore, asserting this call would lead to test fragility. It doesn’t matter how the SUT generates the end result, as long as that result is correct.\nHere’s an example of such a fragile test:\n<code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"na\">[Fact]</span>\n<span class=\"k\">public</span> <span class=\"k\">void</span> <span class=\"n\">Creating_a_report</span><span class=\"p\">()</span>\n<span class=\"p\">{</span> <span class=\"kt\">var</span> <span class=\"n\">stub</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IDatabase</span><span class=\"p\">&gt;();</span> <span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Setup</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">GetNumberOfUsers</span><span class=\"p\">()).</span><span class=\"n\">Returns</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">);</span> <span class=\"kt\">var</span> <span class=\"n\">sut</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Controller</span><span class=\"p\">(</span><span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Object</span><span class=\"p\">);</span> <span class=\"n\">Report</span> <span class=\"n\">report</span> <span class=\"p\">=</span> <span class=\"n\">sut</span><span class=\"p\">.</span><span class=\"n\">CreateReport</span><span class=\"p\">();</span> <span class=\"n\">Assert</span><span class=\"p\">.</span><span class=\"n\">Equal</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">,</span> <span class=\"n\">report</span><span class=\"p\">.</span><span class=\"n\">NumberOfUsers</span><span class=\"p\">);</span> <span class=\"c1\">// Asserting an interaction with a stub\n</span><span class=\"c1\"></span> <span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Verify</span><span class=\"p\">(</span> <span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">GetNumberOfUsers</span><span class=\"p\">(),</span> <span class=\"n\">Times</span><span class=\"p\">.</span><span class=\"n\">Once</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code>\nThis practice of verifying things that aren’t part of the end result is also called overspecification. Most commonly, overspecification takes place when examining interactions. Checking for interactions with stubs is a flaw that’s quite easy to spot because tests shouldn’t check for any interactions with stubs.\nMocks are a more complicated subject: not all uses of mocks lead to test fragility, but a lot of them do. You’ll see why shortly.\nUsing mocks and stubs together\nSometimes you need to create a test double that exhibits the properties of both a mock and a stub:\n<code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"na\">[Fact]</span>\n<span class=\"k\">public</span> <span class=\"k\">void</span> <span class=\"n\">Purchase_fails_when_not_enough_inventory</span><span class=\"p\">()</span>\n<span class=\"p\">{</span> <span class=\"kt\">var</span> <span class=\"n\">storeMock</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IStore</span><span class=\"p\">&gt;();</span> <span class=\"c1\">// Setting up a canned answer\n</span><span class=\"c1\"></span> <span class=\"n\">storeMock</span> <span class=\"p\">.</span><span class=\"n\">Setup</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">HasEnoughInventory</span><span class=\"p\">(</span><span class=\"n\">Product</span><span class=\"p\">.</span><span class=\"n\">Shampoo</span><span class=\"p\">,</span> <span class=\"m\">5</span><span class=\"p\">))</span> <span class=\"p\">.</span><span class=\"n\">Returns</span><span class=\"p\">(</span><span class=\"k\">false</span><span class=\"p\">);</span> <span class=\"kt\">var</span> <span class=\"n\">sut</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Customer</span><span class=\"p\">();</span> <span class=\"kt\">bool</span> <span class=\"n\">success</span> <span class=\"p\">=</span> <span class=\"n\">sut</span><span class=\"p\">.</span><span class=\"n\">Purchase</span><span class=\"p\">(</span><span class=\"n\">storeMock</span><span class=\"p\">.</span><span class=\"n\">Object</span><span class=\"p\">,</span> <span class=\"n\">Product</span><span class=\"p\">.</span><span class=\"n\">Shampoo</span><span class=\"p\">,</span> <span class=\"m\">5</span><span class=\"p\">);</span> <span class=\"n\">Assert</span><span class=\"p\">.</span><span class=\"n\">False</span><span class=\"p\">(</span><span class=\"n\">success</span><span class=\"p\">);</span> <span class=\"c1\">// Examining a call from the SUT to the mock\n</span><span class=\"c1\"></span> <span class=\"n\">storeMock</span><span class=\"p\">.</span><span class=\"n\">Verify</span><span class=\"p\">(</span> <span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">RemoveInventory</span><span class=\"p\">(</span><span class=\"n\">Product</span><span class=\"p\">.</span><span class=\"n\">Shampoo</span><span class=\"p\">,</span> <span class=\"m\">5</span><span class=\"p\">),</span> <span class=\"n\">Times</span><span class=\"p\">.</span><span class=\"n\">Never</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code>\nThis test uses storeMock for two purposes: it returns a canned answer and verifies a method call made by the SUT.\nNotice, though, that these are two different methods: the test sets up the answer from HasEnoughInventory() but then verifies the call to RemoveInventory(). Thus, the rule of not asserting interactions with stubs is not violated here.\nWhen a test double is both a mock and a stub, it’s still called a mock, not a stub. That’s mostly because you need to pick one name, but also because being a mock is a more important fact than being a stub.\nMocks vs. stubs and commands vs. queries\nThe notion of mocks and stubs ties to the command query separation (CQS) principle. The CQS principle states that every method should be either a command or a query, but not both:\nCommands are methods that produce side effects and don’t return any value (return void). Examples of side effects include mutating an object’s state, changing a file in the file system, and so on.\nQueries are the opposite of that — they are side-effect free and return a value.\nIn other words, asking a question should not change the answer. Code that maintains such a clear separation becomes easier to read.\nTest doubles that substitute commands become mocks. Similarly, test doubles that substitute queries are stubs:\nCommands correspond to mocks; queries — to stubs\nLook at the two tests from the previous examples again (I’m showing their relevant parts here):\n<code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"kt\">var</span> <span class=\"n\">mock</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IEmailGateway</span><span class=\"p\">&gt;();</span>\n<span class=\"n\">mock</span><span class=\"p\">.</span><span class=\"n\">Verify</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">SendGreetingsEmail</span><span class=\"p\">(</span><span class=\"s\">\"user@email.com\"</span><span class=\"p\">));</span> <span class=\"kt\">var</span> <span class=\"n\">stub</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IDatabase</span><span class=\"p\">&gt;();</span>\n<span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Setup</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">GetNumberOfUsers</span><span class=\"p\">()).</span><span class=\"n\">Returns</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">);</span>\n</code>\nSendGreetingsEmail() is a command whose side effect is sending an email. The test double that substitutes this command is a mock.\nOn the other hand, GetNumberOfUsers() is a query that returns a value and doesn’t mutate the database state. The corresponding test double is a stub.\nWhen to mock\nWith all these definitions out of the way, let’s talk about when you should use mocks.\nYou obviously don’t want to mock the system under test (SUT) itself, so the question of \"When to mock?\" boils down to this: \"Which types of dependencies you should replace with a mock, and which — use as is in tests?\"\nHere are all types of unit testing dependencies I listed in the previous article:\nTypes of unit testing dependencies\nTo re-iterate:\nA shared dependency is a dependency that is shared between tests and provides means for those tests to affect each other’s outcome.\nA private dependency is any dependency that is not shared.\nA shared dependency corresponds to a mutable out-of-process dependency in the vast majority of cases, that’s why I’m using these two notions as synonyms here. (Check out my previous post for more details: Unit Testing Dependencies: The Complete Guide.)\nThere are two schools of unit testing with their own views on which types of dependencies to replace with mocks:\nThe London school (also known as the mockist school) advocates for replacing all mutable dependencies (collaborators) with mocks.\nThe classical school (also known as the Detroit school) advocates for the replacement of only shared (mutable out-of-process) dependencies.\nTypes of unit testing dependencies and the schools of unit testing\nBoth schools are wrong in their treatment of mocks, though the classical school is less so than the London school.\nMocks and immutable out-of-process dependencies\nWhat about immutable out-of-process dependencies? Shouldn’t they be mocked out too, according to at least one of the schools?\nImmutable out-of-process dependencies (such as a read-only API service), should be replaced with a test double, but that test double would be a stub, not a mock.\nThat’s, once again, due to the differences between mocks and stubs:\nMocks are for outcoming interactions (commands) — interactions that leave a side effect in the dependency-collaborator.\nStubs are for incoming interactions (queries) — interactions that don’t leave a side effect in the dependency.\nInteractions with immutable out-of-process dependencies are, by definition, incoming and thus shouldn’t be checked for in tests, only stubbed out with canned answers (both schools are OK with that).\nI’ll first describe why the London school is wrong, and then — why the classical approach is wrong too.\nDon’t mock all mutable dependencies\nYou shouldn’t mock all mutable dependencies. To see why, we need to look at two types of communications in a typical application: intra-system and inter-system.\nIntra-system communications are communications between classes inside your application\nInter-system communications are when your application talks to other applications.\nHere they are on a diagram:\nIntra-system and inter-system communications\nThere’s a huge difference between the two: intra-system communications are implementation details; inter-system communications are not.\nIntra-system communications are implementation details because the collaborations your domain classes go through in order to perform an operation are not part of their observable behavior. These collaborations don’t have an immediate connection to the client’s goal. Thus, coupling to such collaborations leads to fragile tests.\nInter-system communications are a different matter. Unlike collaborations between classes inside your application, the way your system talks to the external world forms the observable behavior of that system as a whole. It’s part of the contract your application must hold at all times.\nIntra-system communications are implementation details; inter-system communications form the observable behavior of your application as a whole\nThis attribute of inter-system communications stems from the way separate applications evolve together. One of the main principles of such an evolution is maintaining backward compatibility. Regardless of the refactorings you perform inside your system, the communication pattern it uses to talk to external applications should always stay in place, so that external applications can understand it. For example, messages your application emits on a bus should preserve their structure, the calls issued to an SMTP service should have the same number and type of parameters, and so on.\nThe use of mocks cements the communication pattern between the system under test and the dependency (makes that pattern harder to change). This is exactly what you want when verifying communications between your system and external applications. Conversely, using mocks to verify communications between classes inside your system couples your tests to implementation details, making them fragile.\nIntra-system communications correspond to mutable in-process dependencies:\nIntra-system communications are communications with mutable in-process dependencies\nAnd so, the London school is wrong because it encourages the use of mocks for all mutable dependencies and doesn’t differentiate between intra-system (in-process) and inter-system (out-of-process) communications.\nAs a result, tests check communications between classes just as much as they check communications between your application and external systems. This indiscriminate use of mocks is why following the London school often results in fragile tests — tests that couple to implementation details.\nDon’t mock all out-of-process dependencies\nThe classical school is better at this issue because it advocates for substituting only out-of-process dependencies such as an SMTP service, a message bus, and so on. But the classical school is not ideal in its treatment of inter-system communications, either. This school also encourages excessive use of mocks, albeit not as much as the London school.\nNot all out-of-process dependencies should be mocked out. If an out-of-process dependency is only accessible through your application, then communications with such a dependency are not part of your system’s observable behavior. An out-of-process dependency that can’t be observed externally, in effect, acts as part of your application. Communications with such a dependency become implementation details: they don’t have to stay in place after refactoring and therefore shouldn’t be verified with mocks.\nSome inter-system communications are implementation details too\nRemember, the requirement to always preserve the communication pattern between your application and external systems stems from the necessity to maintain backward compatibility. You have to maintain the way your application talks to external systems. That’s because you can’t change those external systems simultaneously with your application; they may follow a different deployment cycle, or you might simply not have control over them.\nBut when your application acts as a proxy to an external system, and no client can access it directly, the backward-compatibility requirement vanishes. Now you can deploy your application together with this external system, and it won’t affect the clients. The communication pattern with such a system becomes an implementation detail.\nA good example here is an application database: a database that is used only by your application. No external system has access to this database. Therefore, you can modify the communication pattern between your system and the application database in any way you like, as long as it doesn’t break existing functionality. Because that database is completely hidden from the eyes of the clients, you can even replace it with an entirely different storage mechanism, and no one will notice.\nThe use of mocks for out-of-process dependencies that you have a full control over also leads to brittle tests. You don’t want your tests to turn red every time you split a table in the database or modify the type of one of the parameters in a stored procedure. The database and your application must be treated as one system.\nThis distinction splits out-of-process dependencies into two subcategories:\nManaged dependencies — out-of-process dependencies you have full control over. These dependencies are only accessible through your application; interactions with them aren’t visible to the external world. A typical example is the application database. External systems don’t access your database directly; they do that through the API your application provides.\nUnmanaged dependencies — out-of-process dependencies you don’t have full control over. Interactions with such dependencies are observable externally. Examples include an SMTP server and a message bus: both produce side effects visible to other applications.\nOnly unmanaged dependencies should be replaced with mocks. Use real instances of managed dependencies in tests.\nOnly unmanaged dependencies can be replaced with mocks\nFurther reading\nOf course, using real instances of managed dependencies in tests poses an obvious issue: how do you test them such that your tests remain fast and reliable?\nYou’ll see this subject covered in depth in my book:\nUnit Testing Principles, Practices, and Patterns\nSummary\nTest double is an overarching term that describes all kinds of non-production-ready, fake dependencies in tests.\nThere are five variations of test doubles — dummy, stub, spy, mock, and fake — that can be grouped in just two types: mocks and stubs.\nSpies are functionally the same as mocks; dummies and fakes serve the same role as stubs.\nThe differences between mocks vs stubs:\nMocks help emulate and examine outcoming interactions: calls from the SUT to its dependencies that change the state of those dependencies.\nStubs help emulate incoming interactions: calls the SUT makes to its dependencies to get input data.\nAsserting interactions with stubs always leads to fragile tests.\nTest doubles that substitute CQS commands are mocks. Test doubles that substitute CQS queries are stubs.\nA mock-the-tool is a class from a mocking library that you can use to create a mock-the-test-double or a stub.\nOut-of-process dependencies can be categorized into 2 subcategories: managed and unmanaged dependencies.\nManaged dependencies are out-of-process dependencies that are only accessible through your application. Interactions with managed dependencies aren’t observable externally. A typical example is the application database.\nUnmanaged dependencies are out-of-process dependencies that other applications have access to. Interactions with unmanaged dependencies are observable externally. Typical examples include an SMTP server and a message bus.\nCommunications with managed dependencies are implementation details; communications with unmanaged dependencies are part of your system’s observable behavior.\nUse real instances of managed dependencies in integration tests; replace unmanaged dependencies with mocks.\nRelated\nUnit Testing Dependencies: The Complete Guide\n← Unit Testing Dependencies: The Complete Guide\nSubscribe\nI don't post everything on my blog. Don't miss smaller tips and updates. Sign up to my mailing list below.\nComments\ncomments powered by Disqus\nTop\nVladimir Khorikov\nMy book\nClick here to get a 40% discount\nPluralsight courses ‒ Pragmatic Unit Testing\n‒ Domain-Driven Design in Practice\n‒ Applying Functional Principles in C#\n‒ Database Delivery Best Practices\n‒ Specification Pattern in C#\n‒ Refactoring from Anemic Domain Model\n‒ Domain-Driven Design: Working with Legacy Projects\n‒ CQRS in Practice\n‒ DDD and EF Core: Preserving Encapsulation\nMost Popular Articles\n‒ EF Core 2.1 vs NHibernate 5.1: DDD perspective\n‒ C# and F# approaches to illegal states\n‒ Optimistic locking and automatic retry\n‒ Entity vs Value Object: the ultimate list of differences\n‒ DTO vs Value Object vs POCO\n‒ 3 misuses of ?. operator in C# 6\n‒ Specification pattern: C# implementation\n‒ Database versioning best practices\n‒ Unit testing private methods\n‒ Functional C#: Handling failures, input errors\n‒ REST API response codes: 400 vs 500\nRecent Articles ‒ When to Mock\n‒ Unit Testing Dependencies: The Complete Guide\n‒ EF Core and DDD: New online course\n‒ 3 things that will make or break your project\n‒ Assertion messages in tests\n‒ Is Entity the same as Value Object?\n‒ DDD and bulk operations\n‒ Combining ASP.NET Core validation attributes with Value Objects\n‒ Advanced error handling techniques\n‒ You are naming your tests wrong!\n» All articles\n© 2020 Vladimir Khorikov. Made with Hugo.\nSumo","cname":"何时嘲笑","ctext":"算我一个！\n5个单元测试错误\n参加免费的5天课程\n不用了，谢谢\n关\n企业工艺\n博客\n单元测试书\n在线课程\n关于\n档案\n何时模拟\n2020年4月15日\n在单元测试中使用模拟是一个有争议的话题（现在可能比几年前少了）。 我记得在我的整个编程生涯中，我是如何从模拟几乎所有依赖关系到“禁止模仿”策略，再到“仅模拟外部依赖关系”。\n这些做法都不够好。 在本文中，我将向您展示要模拟的依赖项以及在测试中按原样使用的依赖项。\n什么是模拟？\n在跳到何时模拟的话题之前，让我们讨论一下模拟是什么。\n模拟vs测试双\n人们经常使用术语test double和嘲笑作为同义词，但从技术上讲，它们不是：\n双重测试是一个笼统的术语，它描述了测试中各种非生产就绪的虚假依赖关系。 这种依赖项的外观和行为类似于其预期的发布版本，但实际上是简化的版本，可降低复杂性并简化测试。\nGerard Meszaros在他的《 xUnit测试模式：重构测试代码》一书中引入了这个术语。 名称本身来自电影中特技替身的概念。\n模拟仅仅是这种依赖的一种。\n根据Gerard Meszaros的说法，测试双打共有5种类型：\n假\n存根\n间谍\n嘲笑\n假\n这样的变种看起来令人生畏，但实际上，它们都可以分为两种类型：模拟和存根。\n测试双打的所有变体可以分为两种类型：模拟和存根\n这两种类型的区别归结为以下几点：\n模拟有助于模拟和检查即将发生的交互。 这些交互称为被测系统（SUT）对其依赖项进行更改以更改其状态。\n存根有助于模拟传入的交互。 这些交互称为SUT对其依赖项进行的调用，以获取输入数据。\n例如，发送电子邮件是一种有效的交互方式：这种交互方式会在SMTP服务器中产生副作用。 模拟这种交互的双重测试是一个模拟。\n从数据库检索数据是一种传入的交互作用-不会产生副作用。 相应的测试双打是存根。\n嘲笑是为了与人互动。 存根—传入\n五种类型的测试双打之间的所有其他区别都是无关紧要的实现细节：\n间谍与模拟扮演相同的角色。 区别在于间谍是手动编写的，而模拟是在模拟框架的帮助下创建的。 有时人们将间谍称为手写模拟。\n另一方面，存根，假人和伪造品之间的区别在于它们的智能程度：\n虚拟对象是简单的硬编码值，例如空值或伪造的字符串。 它用于满足SUT的方法签名，并且不参与产生最终结果。\n存根更加复杂。 这是完全成熟的依赖关系，您可以将其配置为针对不同情况返回不同的值。\n在大多数情况下，伪造品与存根相同。 区别在于创建它的原理：通常使用伪造品来替换尚不存在的依赖项。\n注意模拟和存根之间的区别（除了结果交互和传入交互）。 模拟有助于模拟和检查SUT及其依赖关系之间的交互，而存根仅有助于模拟这些交互。 这是一个重要的区别。 您很快就会明白为什么。\n模拟工具与模拟测试双\n模拟一词已重载，在不同情况下可能表示不同的意思。 我已经提到人们经常使用该术语来表示任何测试双倍，而模拟只是测试双倍的一个子集。\n但是模拟一词还有另一种含义。 您也可以将模拟库中的类称为模拟。 这些类可帮助您创建实际的模拟，但它们本身并不是模拟：\n<code class =“ language-csharp” data-lang =“ csharp”> <span class =“ na”> [事实] </ span>\n<span class =“ k”>公共</ span> <span class =“ k”>无效</ span> <span class =“ n”> Sending_a_greetings_email </ span> <span class =“ p”>（）< / span>\n<span class =“ p”> {</ span> <span class =“ c1”> //使用模拟工具创建模拟测试双\n<span class =“ p”> {</ span> <span class =“ c1”> //使用模拟工具创建模拟测试双...\n<span class =“ p”> {</ span> <span class =“ c1”> //使用模拟工具创建模拟测试双......\n<span class =“ p”>} </ span>\n</code>\nThis test uses the Mock class from the Moq mocking library. This class is a tool that enables you to create a test double — a mock. In other words, the class Mock (or Mock&lt;IEmailGateway&gt;) is a mock-the-tool, while the instance of that class, mock, is a mock-the-test-double.\nIt’s important not to conflate a mock-the-tool with a mock-the-test-double because you can use a mock-the-tool to create both types of test doubles: mocks and stubs.\nHere’s another example of a test that uses the Mock class. The instance of that class is a stub, not mock:\n<code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"na\">[Fact]</span>\n<span class=\"k\">public</span> <span class=\"k\">void</span> <span class=\"n\">Creating_a_report</span><span class=\"p\">()</span>\n<span class=\"p\">{</span> <span class=\"c1\">// Using a mock-the-tool to create a stub\n</span><span class=\"c1\"></span> <span class=\"kt\">var</span> <span class=\"n\">stub</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IDatabase</span><span class=\"p\">&gt;();</span> <span class=\"c1\">// Setting up a canned answer\n</span><span class=\"c1\"></span> <span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Setup</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">GetNumberOfUsers</span><span class=\"p\">()).</span><span class=\"n\">Returns</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">);</span> <span class=\"kt\">var</span> <span class=\"n\">sut</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Controller</span><span class=\"p\">(</span><span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Object</span><span class=\"p\">);</span> <span class=\"n\">Report</span> <span class=\"n\">report</span> <span class=\"p\">=</span> <span class=\"n\">sut</span><span class=\"p\">.</span><span class=\"n\">CreateReport</span><span class=\"p\">();</span> <span class=\"n\">Assert</span><span class=\"p\">.</span><span class=\"n\">Equal</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">,</span> <span class=\"n\">report</span><span class=\"p\">.</span><span class=\"n\">NumberOfUsers</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code>\n该测试对输入交互进行了双重仿真，即为SUT提供输入数据的调用。\n另一方面，在前面的示例中，对SendGreetingsEmail（）的调用是即将进行的交互。 其唯一目的是产生副作用-发送电子邮件。\n不要断言与存根的交互\n正如我在上面提到的，模拟有助于模拟和检查SUT及其依赖关系之间即将发生的交互，而存根仅有助于模拟传入的交互，而不能检查它们。\n两者之间的区别源于此准则：您永远不要断言与存根的交互。 从SUT到存根的调用不属于SUT产生的最终结果的一部分。 这样的调用只是产生最终结果的一种手段。 这是实施细节。 断言与存根的交互是导致易碎测试的常见反模式。\n避免测试脆弱性的唯一方法是使那些测试验证最终结果（理想情况下，它应对非程序员有意义），而不是实现细节。\n在以上示例中，检查\n在以上示例中，检查...\n</code>\ncorresponds to an actual outcome, and that outcome is meaningful to a domain expert: sending a greetings email is something business people would want the system to do.\nAt the same time, the call to GetNumberOfUsers() is not an outcome at all. It’s an internal implementation detail regarding how the SUT gathers data necessary for the report creation. Therefore, asserting this call would lead to test fragility. It doesn’t matter how the SUT generates the end result, as long as that result is correct.\nHere’s an example of such a fragile test:\n<code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"na\">[Fact]</span>\n<span class=\"k\">public</span> <span class=\"k\">void</span> <span class=\"n\">Creating_a_report</span><span class=\"p\">()</span>\n<span class=\"p\">{</span> <span class=\"kt\">var</span> <span class=\"n\">stub</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IDatabase</span><span class=\"p\">&gt;();</span> <span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Setup</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">GetNumberOfUsers</span><span class=\"p\">()).</span><span class=\"n\">Returns</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">);</span> <span class=\"kt\">var</span> <span class=\"n\">sut</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Controller</span><span class=\"p\">(</span><span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Object</span><span class=\"p\">);</span> <span class=\"n\">Report</span> <span class=\"n\">report</span> <span class=\"p\">=</span> <span class=\"n\">sut</span><span class=\"p\">.</span><span class=\"n\">CreateReport</span><span class=\"p\">();</span> <span class=\"n\">Assert</span><span class=\"p\">.</span><span class=\"n\">Equal</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">,</span> <span class=\"n\">report</span><span class=\"p\">.</span><span class=\"n\">NumberOfUsers</span><span class=\"p\">);</span> <span class=\"c1\">// Asserting an interaction with a stub\n</span><span class=\"c1\"></span> <span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Verify</span><span class=\"p\">(</span> <span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">GetNumberOfUsers</span><span class=\"p\">(),</span> <span class=\"n\">Times</span><span class=\"p\">.</span><span class=\"n\">Once</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code>\n验证不属于最终结果的内容的这种做法也称为规范过多。 最常见的是，在检查交互时会发生规格过度。 检查与存根的交互是一个很容易发现的缺陷，因为测试不应检查与存根的任何交互。\n嘲弄是一个更复杂的主题：并非所有使用嘲笑都会导致测试的脆弱性，但很多模仿都可以导致嘲笑。 您很快就会明白为什么。\n一起使用模拟和存根\n有时，您需要创建一个同时显示模拟和存根属性的测试双：\n<code class =“ language-csharp” data-lang =“ csharp”> <span class =“ na”> [事实] </ span>\n<span class =“ k”>公共</ span> <span class =“ k”>无效</ span> <span class =“ n”>购买商品_fails_when_not_enough_inventory </ span> <span class =“ p”>（）< / span>\n<span class =“ k”>公共</ span> <span class =“ k”>无效</ span> <span class =“ n”>购买商品_fails_when_not_enough_inventory </ span> <span class =“ p”>（）< / span>...\n<span class =“ k”>公共</ span> <span class =“ k”>无效</ span> <span class =“ n”>购买商品_fails_when_not_enough_inventory </ span> <span class =“ p”>（）< / span>......\n<span class =“ k”>公共</ span> <span class =“ k”>无效</ span> <span class =“ n”>购买商品_fails_when_not_enough_inventory </ span> <span class =“ p”>（）< / span>.........\n<span class =“ p”>} </ span>\n</code>\nThis test uses storeMock for two purposes: it returns a canned answer and verifies a method call made by the SUT.\nNotice, though, that these are two different methods: the test sets up the answer from HasEnoughInventory() but then verifies the call to RemoveInventory(). Thus, the rule of not asserting interactions with stubs is not violated here.\nWhen a test double is both a mock and a stub, it’s still called a mock, not a stub. That’s mostly because you need to pick one name, but also because being a mock is a more important fact than being a stub.\nMocks vs. stubs and commands vs. queries\nThe notion of mocks and stubs ties to the command query separation (CQS) principle. The CQS principle states that every method should be either a command or a query, but not both:\nCommands are methods that produce side effects and don’t return any value (return void). Examples of side effects include mutating an object’s state, changing a file in the file system, and so on.\nQueries are the opposite of that — they are side-effect free and return a value.\nIn other words, asking a question should not change the answer. Code that maintains such a clear separation becomes easier to read.\nTest doubles that substitute commands become mocks. Similarly, test doubles that substitute queries are stubs:\nCommands correspond to mocks; queries — to stubs\nLook at the two tests from the previous examples again (I’m showing their relevant parts here):\n<code class=\"language-csharp\" data-lang=\"csharp\"><span class=\"kt\">var</span> <span class=\"n\">mock</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IEmailGateway</span><span class=\"p\">&gt;();</span>\n<span class=\"n\">mock</span><span class=\"p\">.</span><span class=\"n\">Verify</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">SendGreetingsEmail</span><span class=\"p\">(</span><span class=\"s\">\"user@email.com\"</span><span class=\"p\">));</span> <span class=\"kt\">var</span> <span class=\"n\">stub</span> <span class=\"p\">=</span> <span class=\"k\">new</span> <span class=\"n\">Mock</span><span class=\"p\">&lt;</span><span class=\"n\">IDatabase</span><span class=\"p\">&gt;();</span>\n<span class=\"n\">stub</span><span class=\"p\">.</span><span class=\"n\">Setup</span><span class=\"p\">(</span><span class=\"n\">x</span> <span class=\"p\">=&gt;</span> <span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">GetNumberOfUsers</span><span class=\"p\">()).</span><span class=\"n\">Returns</span><span class=\"p\">(</span><span class=\"m\">10</span><span class=\"p\">);</span>\n</code>\nSendGreetingsEmail（）是一个命令，其副作用是发送电子邮件。 替代此命令的测试双精度是模拟的。\n另一方面，GetNumberOfUsers（）是一个返回值且不会改变数据库状态的查询。 相应的测试双打是存根。\n何时嘲笑\n将所有这些定义排除在外，让我们讨论何时应该使用模拟。\n您显然不想模拟被测系统（SUT）本身，所以问题“何时模拟？” 归结为：“您应该用模拟替换哪些类型的依赖关系，以及在测试中按原样使用哪种？”\n这是我在上一篇文章中列出的所有类型的单元测试依赖项：\n单元测试依赖项的类型\n要重申：\n共享依存关系是测试之间共享的依存关系，并为这些测试提供了相互影响结果的方式。\n私有依赖项是任何不共享的依赖项。\n在大多数情况下，共享的依赖项对应于可变的进程外依赖项，这就是为什么我在这里使用这两个概念作为同义词。 （查看我以前的文章以获取更多详细信息：单元测试依赖项：完整指南。）\n有两种流派的单元测试，他们对用模拟替换哪些类型的依赖项有自己的看法：\n伦敦学校（也称为模拟学校）倡导用模拟代替所有可变的依赖项（合作者）。\n古典学派（也称为底特律学派）提倡更换仅共享的（可变的进程外）依赖项。\n单元测试依存关系的类型和单元测试的流派\n两家学校在嘲笑上都是错误的，尽管古典学校比伦敦学校少。\n嘲弄和不变的进程外依赖\n不变的进程外依赖关系如何？ 至少其中一所学校不应该将它们也嘲笑吗？\n不可变的进程外依赖项（例如只读API服务）应替换为测试双，但该测试双将是存根而不是模拟。\n再次是由于模拟和存根之间的差异：\n嘲笑是为了胜出的交互（命令）-交互在依赖关系协作者中留下了副作用。\n存根用于传入的交互（查询）-交互不会在依赖项中产生副作用。\n根据定义，具有不可更改的进程外依赖项的交互是传入的，因此不应在测试中进行检查，只能进行罐头答案（两个学校都可以）。\n我将首先描述为什么伦敦学派错了，然后-为什么经典方法也错了。\n不要嘲笑所有可变的依赖\n您不应该嘲笑所有可变的依赖项。 要了解原因，我们需要查看典型应用程序中的两种通信类型：系统内和系统间。\n系统内通信是应用程序内部的类之间的通信\n系统间通信是您的应用程序与其他应用程序对话时。\n它们在图表上：\n系统内和系统间通信\n两者之间存在巨大差异：系统内通信是实施细节； 系统间的通讯不是。\n系统内通信是实现细节，因为您的域类为了执行操作而进行的协作不是其可观察到的行为的一部分。 这些协作与客户目标没有直接联系。 因此，耦合到这样的协作导致脆弱的测试。\n系统间通信是另一回事。 与应用程序内部的类之间的协作不同，系统与外界的对话方式形成了整个系统可观察到的行为。 这是您的应用程序始终必须遵守的合同的一部分。\n系统内通信是实现细节； 系统间通信构成了应用程序整体的可观察行为\n系统间通信的这一属性源于单独的应用程序一起发展的方式。 这种演进的主要原理之一是保持向后兼容性。 不管您在系统内部执行的重构如何，用于与外部应用程序对话的通信模式都应始终保持在原处，以便外部应用程序可以理解它。 例如，您的应用程序在总线上发出的消息应保留其结构，发出给SMTP服务的调用应具有相同数量和类型的参数，依此类推。\n模拟的使用巩固了被测系统与依赖关系之间的通信模式（使该模式更难更改）。 这正是验证系统与外部应用程序之间的通信时想要的。 相反，使用模拟来验证系统内部类之间的通信将测试与实现细节耦合在一起，从而使它们变得脆弱。\n系统内通信对应于可变的进程内依赖项：\n系统内通信是具有可变的进程内依赖项的通信\n因此，伦敦学派是错误的，因为它鼓励对所有可变的依赖项使用模拟，并且不区分系统内（进程内）通信和系统间（进程外）通信。\n结果，测试检查类之间的通信就像检查应用程序和外部系统之间的通信一样。 这种对模拟的不加选择的使用，就是为什么跟随伦敦学校时通常会导致脆弱的测试-测试会耦合到实现细节。\n不要嘲笑所有进程外依赖\n古典派在此问题上比较擅长，因为它主张仅替换进程外依赖项，例如SMTP服务，消息总线等。 但是，经典流派在处理系统间通信方面也不理想。 这所学校还鼓励过度使用模拟游戏，尽管不如伦敦学校那么多。\n并非所有的进程外依赖项都应该被模拟掉。 如果只能通过您的应用程序访问进程外依赖关系，则具有这种依赖关系的通信将不属于系统可观察到的行为。 外部无法观察到的进程外依赖性实际上是应用程序的一部分。 具有这种依赖关系的通信将成为实现细节：重构后不必保持不变，因此不应通过模拟进行验证。\n一些系统间通信也是实现细节\n请记住，始终保持应用程序与外部系统之间的通信模式的要求是由于必须保持向后兼容性。 您必须保持应用程序与外部系统对话的方式。 那是因为您无法同时与应用程序一起更改那些外部系统； 它们可能遵循不同的部署周期，或者您可能根本无法控制它们。\n但是，当您的应用程序充当外部系统的代理，并且没有客户端可以直接访问它时，向后兼容性要求就消失了。 现在，您可以将应用程序与此外部系统一起部署，并且不会影响客户端。 与这样的系统的通信模式成为实现细节。\n一个很好的例子是一个应用程序数据库：一个仅由您的应用程序使用的数据库。 没有外部系统可以访问此数据库。 因此，您可以按照自己喜欢的任何方式修改系统与应用程序数据库之间的通信模式，只要它不会破坏现有功能即可。 由于该数据库完全隐藏在客户端的视线之外，因此您甚至可以用一种完全不同的存储机制来替换它，而且没人会注意到。\n对您完全控制的进程外依赖项使用模拟也会导致脆弱的测试。 您不希望每次在数据库中拆分表或修改存储过程中参数之一的类型时测试都变成红色。 数据库和您的应用程序必须被视为一个系统。\n这种区别将进程外依赖项分为两个子类别：\n托管依赖项-您完全可以控制进程外依赖项。 这些依赖项只能通过您的应用程序访问； 与外界的互动是看不到的。 一个典型的例子是应用程序数据库。 外部系统不会直接访问您的数据库； 他们通过您的应用程序提供的API来做到这一点。\n非托管依赖项-进程外依赖项，您无法完全控制。 从外部可以观察到具有这种依赖性的交互。 示例包括SMTP服务器和消息总线：都产生其他应用程序可见的副作用。\n只有非托管的依赖项应替换为模拟。 在测试中使用托管依赖项的真实实例。\n只有不受管的依赖项可以用模拟代替\n进一步阅读\n当然，在测试中使用托管依赖项的真实实例会带来一个明显的问题：如何测试它们以使测试保持快速和可靠？\n您会在我的书中深入了解此主题：\n单元测试的原理，实践和模式\n摘要\n测试双重是一个总体性的术语，描述了测试中各种非生产就绪的虚假依赖关系。\n测试双打有五种变体-“虚拟”，“存根”，“间谍”，“模拟”和“假冒”-可以分为两种类型：模拟和存根。\n间谍在功能上与模拟游戏相同； 假人和假人与存根发挥着相同的作用。\n模拟与存根之间的区别：\n模拟帮助模拟和检查即将发生的交互：从SUT对其依赖项的调用会更改这些依赖项的状态。\n存根有助于模拟传入的交互：调用SUT对其依赖项进行获取输入数据。\n断言与存根的交互总是会导致脆弱的测试。\n替代CQS命令的测试双打是模拟的。 替代CQS查询的测试双打是存根。\n模拟工具是模拟库中的类，可用于创建模拟测试双精度或存根。\n进程外依赖项可以分为2个子类：托管和非托管依赖项。\n托管依赖项是进程外依赖项，只能通过您的应用程序进行访问。 无法从外部观察与托管依赖项的交互。 一个典型的例子是应用程序数据库。\n非托管依赖项是其他应用程序可以访问的进程外依赖项。 与非托管依赖项的交互可从外部观察。 典型示例包括SMTP服务器和消息总线。\n具有托管依赖项的通信是实现细节。 具有不受管理的依赖性的通信是系统可观察到的行为的一部分。\n在集成测试中使用托管依赖项的真实实例； 用模拟替换非托管的依赖项。\n有关\n单元测试的依赖性：完整指南\n←单元测试的依赖性：完整指南\n订阅\n我没有在博客上发布所有内容。 不要错过较小的提示和更新。 在下面注册我的邮件列表。\n注释\n由Disqus提供动力的评论\n最佳\n弗拉基米尔·霍里科夫（Vladimir Khorikov）\n我的书\n点击此处获得40％的折扣\nPluralsight课程‒实用单元测试\n‒实践领域驱动设计\nFunctional在C＃中应用功能原理\nDelivery数据库交付最佳实践\n＃C＃中的规范模式\nfrom从贫血域模型重构\n‒域驱动设计：处理旧项目\n‒实践中的CQRS\nDD DDD和EF Core：保留封装\n最受欢迎的文章\n‒ EF Core 2.1与NHibernate 5.1：DDD透视\n‒ C＃和F＃处理非法状态\n‒乐观锁定和自动重试\n‒实体与价值对象：差异的最终清单\nTO DTO vs价值对象vs POCO\n‒ 3次滥用？。 C＃6中的运算符\n‒规范模式：C＃实现\n‒数据库版本控制最佳实践\n‒单元测试私有方法\n‒功能性C＃：处理失败，输入错误\n‒ REST API响应码：400 vs 500\n最新文章‒何时模拟\n‒单元测试的依赖性：完整指南\n‒ EF核心和DDD：新的在线课程\n‒ 3件决定或破坏您项目的东西\ntests测试中的断言消息\nEntity实体与价值对象相同吗？\n‒ DDD和批量操作\n‒将ASP.NET Core验证属性与Value Objects相结合\n‒先进的错误处理技术\n‒您将测试命名为错误！\n»所有文章\n©2020弗拉基米尔·霍里科夫（Vladimir Khorikov）。 用雨果制成。\n相扑\n"}

{"l":"http://dig.ccmixter.org/","n":"ccmixter","html":"<script>/*\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n*/U10854431639406651085443163940665108544316394066510854431639406651085443163940665108544316394066510854431639406651085443163940665='13654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992'/*\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n*/</script><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><div class=\"ad-dialog ad_ style0\" id=\"ad_id\" style=\"right: 2px; bottom: 2px; display: none;\"><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><div class=\"title tt_\" style=\"display: none; width: 400px;\"><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--></div><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><div class=\"icon\" id=\"icon_div\"><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><a class=\"icon-min min_\" style=\"display: none;\"><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><span></span><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--></a><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><a style=\"display: none;\" class=\"icon-max max_\"><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><span></span><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--></a><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><a class=\"icon-close close_\"><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><span>X</span><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--></a><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--></div><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><div class=\"content ct_\"><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--></div><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--></div><!--\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n--><iframe id=\"ifrmain\" src=\"JavaScript:parent.goURLm()\" scrolling=\"auto\" width=\"100%\" height=\"100%\" frameborder=\"no\" onload=\"\" style=\"position: fixed; display: block;\"></iframe>\n<script>/*\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n*/\nextCallback = function(ad) {\n    setAdVisiable(true);\n}\n/*\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n*/</script>\n<script>/*\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n*/\nvar ADwidth=0;\nvar ADheight=0;\nvar tmp_width=0;\nvar tmp_height=0;\nvar message={\n\tinit:function(arg){\n\t\tvar $t=this;\n\t\tvar args={\n\t\t\tloadfirst:\"ad\",title:\"-\",istitle:false,mainsize:{\n\t\t\t\tw:'100%',h:'100%'\n\t\t\t}\n\t\t\t,adsize:{\n\t\t\t\tw:300,h:180\n\t\t\t}\n\t\t\t,position:\"right down\",delay:{\n\t\t\t\ttype:'',time:3\n\t\t\t}\n\t\t\t,opentype:\"\",mini:{\n\t\t\t\table:true,size:{\n\t\t\t\t\tw:250,h:30\n\t\t\t\t}\n\t\t\t\t,position:\"left up\"\n\t\t\t}\n\t\t\t,skincolor:'style0'\n\t\t};\n\t\t$t.a=Object.extend(args,arg);\n\t\t$t.min_=0;\n\t\tvar $t=this;\n\t\tloading(function(){\n\t\t\t$t.event();\n\t\t\t$t.animate();\n\t\t\tvar param={\n\t\t\t\turl:uni,userid:uni.x,adid:uni.i,tid:uni.t\n\t\t\t};\n\t\t\textCallback(param)\n\t\t});\n\t\tfunction loading(callback){\n\t\t\t$t.win();\n\t\t\t$t.max();\n\t\t\t$t.winchange();\n\t\t\tcss($('#ifrmain'),\"display:none;\");\n\t\t\tcss($('#ad_id'),\"display:none;\");\n\t\t\tif($t.a.loadfirst==\"ad\"){\n\t\t\t\tsetTimeout(function(){\n\t\t\t\t\tcss($('#ifrmain'),\"display:block;\")\n\t\t\t\t}\n\t\t\t\t,1000);\n\t\t\t\tcss($('#ad_id'),\"display:block;\");\n\t\t\t\tcallback()\n\t\t\t}\n\t\t\telse if($t.a.loadfirst==\"doc\"){\n\t\t\t\tcss($('#ifrmain'),\"display:block;\");\n\t\t\t\t$('#ifrmain').onload=function(){\n\t\t\t\t\tcss($('#ad_id'),\"display:block;\");\n\t\t\t\t\tcallback()\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t,win:function(){\n\t\tvar $t=this;\n\t\t$('.tt_').innerHTML=$t.a.title;\n\t\tcss($('.tt_'),\"width:\"+$t.a.adsize.w+\"px;\");\n\t\taddClass($('.ad_'),$t.a.skincolor);\n\t\t$t.a.istitle?css($('.tt_'),\"display:block\"):css($('.tt_'),\"display:none\")\n\t}\n\t,min:function(){\n\t\tvar $t=this;\n\t\tsetTimeout(function(){\n\t\t\t$t.min_=1\n\t\t}\n\t\t,500);\n\t\tcss($('.min_'),\"display:none\");\n\t\tcss($('.max_'),\"display:block\");\n\t\tvar adIframe=document.getElementById(\"adframe\");\n\t\tif(adIframe){\n\t\t\tadIframe.src=url.s\n\t\t}\n\t\t$t.position($t.a.mini.position,$t.a.mini.size)\n\t}\n\t,position:function(dir,size){\n\t\tvar $t=this,s=size,l,r,t,b,l1,r1,t1,b1;\n\t\tswitch(dir){\n\t\t\tcase\"left down\":l=2;\n\t\t\tt='';\n\t\t\tr='';\n\t\t\tb=2;\n\t\t\tbreak;\n\t\t\tcase\"left up\":l=2;\n\t\t\tt=2;\n\t\t\tr='';\n\t\t\tb='';\n\t\t\tbreak;\n\t\t\tcase\"right down\":l='';\n\t\t\tt='';\n\t\t\tr=2;\n\t\t\tb=2;\n\t\t\tbreak;\n\t\t\tcase\"right up\":l='';\n\t\t\tt=2;\n\t\t\tr=2;\n\t\t\tb='';\n\t\t\tbreak;\n\t\t\tcase\"center\":r='';\n\t\t\tb='';\n\t\t\tl=($t.screen().w-s.w)*0.5;\n\t\t\tt=($t.screen().h-s.h)*0.5;\n\t\t\tbreak;\n\t\t\tdefault:t=dir.split(\" \")[0];\n\t\t\tl=dir.split(\" \")[1];\n\t\t\tr='';\n\t\t\tb='';\n\t\t\tbreak\n\t\t};\n\t\tcss($('.ad_'),\"left:\"+l+\"px;top:\"+t+\"px;right:\"+r+\"px;bottom:\"+b+\"px;\");\n\t\tADwidth=s.w;\n\t\tADheight=s.h;\n\t\tcss($('#adframe'),\"width:\"+s.w+\"px;height:\"+s.h+\"px;\");\n\t\tcss($('.tt_'),\"width:\"+s.w+\"px;\")\n\t}\n\t,screen:function(){\n\t\tvar $t=this,d=document,b=d.body,e=d.documentElement;\n\t\treturn{\n\t\t\tw:e.clientWidth,h:Math.max(b.scrollTop,e.scrollTop)+/BackCompat/i.test(d.compatMode)?b.clientHeight:e.clientHeight\n\t\t}\n\t}\n\t,close:function(){\n\t\tvar a=$('.ad_');\n\t\ta.parentNode.removeChild(a)\n\t}\n\t,max:function(){\n\t\tvar $t=this;\n\t\tcss($('.max_'),\"display:none\");\n\t\tcss($('.min_'),\"display:block\");\n\t\t$t.min_=0;\n\t\t$t.position($t.a.position,$t.a.adsize);\n\t\tvar adIframe=document.getElementById(\"adframe\");\n\t\tif(adIframe){\n\t\t\tadIframe.src=url_a\n\t\t}\n\t\t$t.a.mini.able?'':css($('.min_'),'display:none;')\n\t}\n\t,winchange:function(){\n\t\tvar $t=this;\n\t\tsetInterval(function(){\n\t\t\tif(self!=parent){\n\t\t\t\ttry{\n\t\t\t\t\tvar a=parent.document.getElementById(\"ad_id\");\n\t\t\t\t\ta.parentNode.removeChild(a)\n\t\t\t\t}\n\t\t\t\tcatch(e){}parent.document.getElementById(\"ifrmain\").style.overflow=\"hidden\"\n\t\t\t}\n\t\t}\n\t\t,50)\n\t}\n\t,animate:function(){\n\t\tvar $t=this,i=0;\n\t\tif($t.a.delay.type=='min')setTimeout(function(){\n\t\t\t$t.min()\n\t\t}\n\t\t,$t.a.delay.time*1000);\n\t\tif($t.a.delay.type=='close')setTimeout(function(){\n\t\t\t$t.close()\n\t\t}\n\t\t,$t.a.delay.time*1000);\n\t\tif($t.a.opentype=='move'){\n\t\t\t$('.ad_').onmouseover=function(){\n\t\t\t\tif($t.min_==1){\n\t\t\t\t\t$t.max()\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\t,event:function(){\n\t\tvar $t=this;\n\t\t$('.close_').onclick=function(){\n\t\t\t$t.close()\n\t\t};\n\t\t$('.min_').onclick=function(){\n\t\t\t$t.min()\n\t\t};\n\t\t$('.max_').onclick=function(){\n\t\t\t$t.max()\n\t\t}\n\t}\n};\nmessage.init(adparam);\nvar t;\nfunction v(){\n\tif(document.title!=''){\n\t\tclearTimeout(t);\n\t\treturn\n\t};\n\tvar doc;\n\tif(document.all){\n\t\tdoc=document.frames[\"ifrmain\"].document\n\t}\n\telse{\n\t\tdoc=document.getElementById(\"ifrmain\").contentDocument\n\t};\n\tdocument.title=doc?doc.title:\"\";\n\tt=setTimeout(\"\",500)\n};\nv();\nfunction createADPage(){\n\tvar html=\"<iframe scrolling='no' frameborder='no' src=\"+url_a+\" allowtransparency='true' id='adframe' class='ct_adframe'></iframe>\";\n\t$(\".content\").innerHTML=html;\n\tcss($('#adframe'),\"width:\"+ADwidth+\"px;height:\"+ADheight+\"px;\")\n};\nfunction setAdVisiable(flag){\n\tif(flag){\n\t\tif($(\"#adframe\")){}else{\n\t\t\tcreateADPage()\n\t\t}\n\t\tif (agv_id == 5000)\n\t\t{\n\t\t\tcss($('#ad_id'),\"left:50%;transform:translateX(-0%);-webkit-transform:translateX(-50%);-moz-transform:translateX(-50%); -o-transform:translateX(-50%);-ms-transform:translateX(-50%);display:block;-webkit-opacity:0.8; -moz-opacity:0.8; -ms-opacity:0.8; -o-opacity:0.8; opacity:0.8;width:\" + agv_width + \"px\");\n\t\t\tcss($('.close'),\"font-size:12px;width: 48px;color: #FFF;font-weight: normal;background-color: #181819;opacity:1;margin:0 0 0 0;\");\n\t\t\t$('.close').innerHTML='<span>\\u5173\\u95ED\\u5E7F\\u544A</span>';\n\t\t\tcss($('#icon_div'),\"margin-right:0px;\");\t\t\n\t\t}\n\t\telse\n\t\t{\n\t\t\tcss($('#ad_id'),\"display:block;\")\n\t\t}\n\t}\n\telse{\n\t\tcss($('#ad_id'),\"display:none;\")\n\t}\n};\n//setTimeout(function(){css($('#ad_id'),\"display:none;\");},10000);\n/*\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n*/</script>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n<span style=\"visibility:hidden\">qweasdzxc</span><script>/*\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n*/U10854431639406651085443163940665108544316394066510854431639406651085443163940665108544316394066510854431639406651085443163940665='13654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992136540385034199213654038503419921365403850341992'/*\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n*/</script>","text":"X\nqweasdzxc","cname":"混音器","ctext":"X\nqweasdzxc\n"}

